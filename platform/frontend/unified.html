<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∞¥Á≥ªÁªüÊéßÂà∂ÁêÜËÆ∫ÊïôÁ®ã - Áªü‰∏ÄÊô∫ËÉΩÂπ≥Âè∞</title>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <!-- D3.js for Knowledge Graph Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Ê∑±Ëâ≤‰∏ªÈ¢òÔºàÈªòËÆ§Ôºâ */
        body[data-theme="dark"] {
            background: #1e1e1e;
            color: #d4d4d4;
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --border-color: #3e3e42;
            --text-primary: #d4d4d4;
            --text-secondary: #cccccc;
            --text-tertiary: #888;
            --accent-color: #007acc;
            --accent-hover: #1177bb;
            
            /* ‰ª£Á†ÅÊ†∑ÂºèÂèòÈáè */
            --code-bg: rgba(52, 152, 219, 0.1);
            --code-hover-bg: rgba(52, 152, 219, 0.15);
            --code-color: #e06c75;
            --code-border: rgba(52, 152, 219, 0.25);
            --pre-bg: linear-gradient(135deg, #1a1f2e 0%, #1e2533 100%);
            --pre-border: rgba(52, 152, 219, 0.2);
            --pre-code-color: #e6edf3;
            --pre-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.03);
            --pre-hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        /* ÊµÖËâ≤‰∏ªÈ¢ò */
        body[data-theme="light"] {
            background: #ffffff;
            color: #1e1e1e;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --border-color: #d0d0d0;
            --text-primary: #1e1e1e;
            --text-secondary: #333333;
            --text-tertiary: #666666;
            --accent-color: #0066cc;
            --accent-hover: #0052a3;
            
            /* ‰ª£Á†ÅÊ†∑ÂºèÂèòÈáè */
            --code-bg: rgba(0, 102, 204, 0.08);
            --code-hover-bg: rgba(0, 102, 204, 0.12);
            --code-color: #c7254e;
            --code-border: rgba(0, 102, 204, 0.2);
            --pre-bg: linear-gradient(135deg, #f8f9fa 0%, #f5f7f9 100%);
            --pre-border: rgba(0, 102, 204, 0.15);
            --pre-code-color: #24292e;
            --pre-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            --pre-hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        /* Ëá™Âä®Ê®°ÂºèÔºàË∑üÈöèÁ≥ªÁªüÔºâ */
        body[data-theme="auto"] {
            background: #1e1e1e;
            color: #d4d4d4;
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --border-color: #3e3e42;
            --text-primary: #d4d4d4;
            --text-secondary: #cccccc;
            --text-tertiary: #888;
            --accent-color: #007acc;
            --accent-hover: #1177bb;
        }

        @media (prefers-color-scheme: light) {
            body[data-theme="auto"] {
                background: #ffffff;
                color: #1e1e1e;
                --bg-primary: #ffffff;
                --bg-secondary: #f5f5f5;
                --bg-tertiary: #e8e8e8;
                --border-color: #d0d0d0;
                --text-primary: #1e1e1e;
                --text-secondary: #333333;
                --text-tertiary: #666666;
                --accent-color: #0066cc;
                --accent-hover: #0052a3;
            }
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-nav {
            height: 50px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: #37373d;
        }

        .nav-tab.active {
            background: #007acc;
            color: white;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #37373d;
            border-color: #007acc;
        }

        .nav-btn.active {
            background: #007acc;
            border-color: #007acc;
            color: white;
        }

        /* ‰∏ªÂÆπÂô® */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
            position: relative;
        }

        /* ÂèØ‰º∏Áº©‰æßËæπÊ†è */
        .resizable-panel {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, margin-left 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .resizable-panel.collapsed {
            width: 0 !important;
            margin-left: -1px;
            border-right: none;
        }

        /* Â∑¶‰æßÈù¢Êùø - Êñá‰ª∂Ê†ë */
        .left-panel {
            width: 300px;
            min-width: 200px;
            max-width: 600px;
        }

        /* Âè≥‰æßÈù¢Êùø - AIÂä©Êâã */
        .right-panel {
            width: 350px;
            min-width: 250px;
            max-width: 600px;
            border-right: none;
            border-left: 1px solid #3e3e42;
            order: 3;
        }

        /* Â∫ïÈÉ®Èù¢Êùø - ËæìÂá∫/ÁªàÁ´Ø */
        .bottom-panel {
            width: 100%;
            height: 250px;
            min-height: 100px;
            max-height: 600px;
            border-right: none;
            border-top: 1px solid #3e3e42;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: height 0.3s ease, margin-bottom 0.3s ease;
            z-index: 10;
        }

        /* Èù¢ÊùøÊäòÂè†Áä∂ÊÄÅ */
        .left-panel.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            border-right: none;
            overflow: hidden;
        }

        .right-panel.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            border-left: none;
            overflow: hidden;
        }

        .bottom-panel.collapsed {
            height: 0 !important;
            min-height: 0 !important;
            margin-bottom: -1px;
            border-top: none;
            overflow: hidden;
        }

        /* Èù¢ÊùøÂ§¥ÈÉ® */
        .panel-header {
            height: 35px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ÂÜÖÂÆπÊ†áÁ≠æÊåâÈíÆ */
        .content-tab-btn {
            padding: 4px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .content-tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .content-tab-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .panel-actions {
            display: flex;
            gap: 5px;
        }

        .panel-action-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 3px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-action-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Èù¢ÊùøÂÜÖÂÆπ */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* ÊãñÊãΩÊâãÊüÑ */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 100;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: #007acc;
        }

        .resize-handle.vertical {
            width: 4px;
            height: 100%;
            right: -2px;
            top: 0;
            cursor: ew-resize;
        }

        .resize-handle.horizontal {
            width: 100%;
            height: 4px;
            top: -2px;
            left: 0;
            cursor: ns-resize;
        }

        /* ‰∏≠Â§ÆÂÜÖÂÆπÂå∫ */
        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ÂÜÖÂÆπËßÜÂõæÂÆπÂô® */
        .content-view {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ÊñáÊ°£ËßÜÂõæ */
        .doc-view {
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            background: var(--bg-primary);
            display: none;
        }

        .doc-view.active {
            display: block;
        }

        /* IDEËßÜÂõæ */
        .ide-view {
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .ide-view.active {
            display: flex;
        }

        /* Áü•ËØÜÂ∫ìËßÜÂõæ */
        .knowledge-view {
            height: 100%;
            display: none;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .knowledge-view.active {
            display: flex;
        }

        .knowledge-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .knowledge-search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #knowledgeSearchInput {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .knowledge-content {
            flex: 1;
            overflow-y: auto;
        }

        .knowledge-welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .knowledge-welcome h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .knowledge-welcome p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .knowledge-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .knowledge-quick-links {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-link-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-link-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }

        .knowledge-results {
            display: grid;
            gap: 15px;
            padding: 20px;
        }

        .knowledge-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .knowledge-card:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.15);
            transform: translateY(-2px);
        }

        .knowledge-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .knowledge-card-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 10px;
        }

        .knowledge-card-content {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .knowledge-card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .knowledge-tag {
            padding: 3px 8px;
            background: rgba(0, 122, 204, 0.1);
            border-radius: 3px;
            font-size: 11px;
            color: var(--accent-color);
        }

        .rag-chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .rag-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .rag-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }

        .rag-message.user {
            background: var(--accent-color);
            color: white;
            margin-left: auto;
        }

        .rag-message.assistant {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .rag-input-area {
            display: flex;
            gap: 10px;
        }

        #ragInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Áü•ËØÜÂõæË∞±Ê†∑Âºè */
        .knowledge-graph-container {
            width: 100%;
            height: 600px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .graph-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .graph-control-btn {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .graph-control-btn:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .graph-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .graph-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .graph-tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-primary);
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        /* Ê†ëËäÇÁÇπÊ†∑Âºè */
        .tree-node {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .tree-node:hover {
            background: #2a2d2e;
        }

        .tree-node.active {
            background: #37373d;
            color: #fff;
        }

        .tree-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .tree-label {
            flex: 1;
            font-size: 13px;
        }

        .tree-badge {
            padding: 2px 6px;
            background: #007acc;
            border-radius: 10px;
            font-size: 10px;
            color: white;
        }

        .tree-group {
            margin-bottom: 15px;
        }

        .tree-group-header {
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* READMEÂÜÖÂÆπÊ†∑Âºè - ÂÖ®Èù¢‰ºòÂåñ */
        .readme-content {
            background: var(--bg-primary);
            padding: 25px 35px;
            max-width: 1400px;
            margin: 0 auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        /* Ê†áÈ¢òÊ†∑Âºè‰ºòÂåñ */
        .readme-content h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 25px 0 15px 0;
            color: var(--text-primary);
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .readme-content h2 {
            font-size: 26px;
            font-weight: 600;
            margin: 20px 0 12px 0;
            color: var(--accent-color);
            padding-left: 12px;
            border-left: 4px solid var(--accent-color);
            letter-spacing: -0.3px;
        }

        .readme-content h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 18px 0 10px 0;
            color: var(--text-secondary);
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        /* ÊÆµËêΩÊ†∑Âºè */
        .readme-content p {
            line-height: 1.7;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 15px;
        }

        /* Á≤ó‰ΩìÊñáÊú¨ */
        .readme-content strong {
            font-weight: 600;
            color: var(--accent-color);
        }

        /* Ë°®Ê†ºÊ†∑Âºè‰ºòÂåñ */
        .readme-content table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .readme-content table td {
            padding: 20px 25px;
            vertical-align: top;
            border: none;
            background: var(--bg-secondary);
            line-height: 1.6;
        }

        .readme-content table td:first-child {
            border-right: 1px solid var(--border-color);
        }

        .readme-content table tr:hover td {
            background: var(--bg-tertiary);
            transition: background 0.3s ease;
        }

        /* Ë°®Ê†ºÂÜÖÁöÑÊñáÊú¨Ê†∑Âºè‰ºòÂåñ */
        .readme-content table td strong {
            color: var(--accent-color);
            font-weight: 700;
            font-size: 1.05em;
        }

        .readme-content table td ul,
        .readme-content table td ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .readme-content table td li {
            margin: 5px 0;
            line-height: 1.6;
        }

        /* Ë°®Ê†º‰∏≠ÁöÑÂõæÁâá */
        .readme-content table img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .readme-content table img:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* ÊôÆÈÄöÂõæÁâáÔºà‰∏çÂú®Ë°®Ê†º‰∏≠Ôºâ */
        .readme-content img:not(table img) {
            max-width: 90%;
            height: auto;
            display: block;
            margin: 25px auto;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        /* ==================== ‰ª£Á†ÅÊ†∑Âºè‰ºòÂåñÔºàÊîØÊåÅ‰∏ªÈ¢òÔºâ ==================== */
        
        /* Ë°åÂÜÖ‰ª£Á†Å */
        .readme-content code {
            background: var(--code-bg);
            color: var(--code-color);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid var(--code-border);
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .readme-content code:hover {
            background: var(--code-hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ‰ª£Á†ÅÂùóÂÆπÂô® */
        .readme-content pre {
            background: var(--pre-bg);
            padding: 20px 24px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 24px 0;
            border: 1px solid var(--pre-border);
            box-shadow: var(--pre-shadow);
            position: relative;
            transition: all 0.3s ease;
        }

        .readme-content pre:hover {
            box-shadow: var(--pre-hover-shadow);
        }

        .readme-content pre::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-color);
            border-radius: 8px 0 0 8px;
        }

        .readme-content pre code {
            background: transparent !important;
            padding: 0 !important;
            border: none !important;
            color: var(--pre-code-color) !important;
            font-size: 0.95em;
            line-height: 1.7;
            font-weight: 400;
            white-space: pre;
            display: block;
            letter-spacing: 0.2px;
        }

        .readme-content pre code:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* ÂàóË°®Ê†∑Âºè‰ºòÂåñ */
        .readme-content ul,
        .readme-content ol {
            margin: 15px 0;
            padding-left: 30px;
            line-height: 1.9;
        }

        .readme-content li {
            margin: 8px 0;
            color: var(--text-primary);
        }

        .readme-content ul li {
            list-style-type: none;
            position: relative;
            padding-left: 25px;
        }

        .readme-content ul li::before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: var(--accent-color);
            font-weight: bold;
        }

        /* ÂºïÁî®Ê†∑Âºè */
        .readme-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding: 15px 20px;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* ÂàÜÈöîÁ∫øÊ†∑Âºè */
        .readme-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 30px 0;
        }

        /* ÈìæÊé•Ê†∑Âºè */
        .readme-content a {
            color: var(--accent-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .readme-content a:hover {
            border-bottom-color: var(--accent-color);
            filter: brightness(1.2);
        }

        /* ==================== Áî®Êà∑‰ΩìÈ™å‰ºòÂåñÊ†∑Âºè ==================== */
        
        /* LoadingÂä®Áîª */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 30, 30, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-text {
            color: #fff;
            margin-top: 20px;
            font-size: 16px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ÂèãÂ•ΩÈîôËØØÊèêÁ§∫ */
        .friendly-error {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-secondary);
            border-left: 4px solid #f44336;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .error-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .error-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .error-close {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .error-close:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        /* ÂõæÁâáÈ¢ÑËßà */
        .image-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
        }

        .preview-container {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            cursor: default;
        }

        .preview-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        .preview-caption {
            text-align: center;
            color: #fff;
            margin-top: 15px;
            font-size: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .preview-close {
            position: absolute;
            top: -50px;
            right: -10px;
            background: var(--accent-color);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .preview-close:hover {
            background: var(--accent-hover);
            transform: rotate(90deg);
        }

        /* ÊàêÂäüÊèêÁ§∫ */
        .success-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-secondary);
            border-left: 4px solid #4caf50;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success-icon {
            font-size: 20px;
        }

        .success-message {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* ÁºñËæëÂô®Â∑•ÂÖ∑Ê†è */
        .editor-toolbar {
            height: 40px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            flex-shrink: 0;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: #0e639c;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar-btn:hover {
            background: #1177bb;
        }

        .toolbar-btn.secondary {
            background: #3e3e42;
        }

        .toolbar-btn.secondary:hover {
            background: #505050;
        }

        /* ÁºñËæëÂô®ÂÆπÂô® */
        #editor {
            flex: 1;
            overflow: hidden;
        }

        /* AIËÅäÂ§© */
        .ai-chat {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 90%;
            line-height: 1.5;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            margin-left: auto;
            color: white;
        }

        .chat-message.assistant {
            background: #2d2d30;
            margin-right: auto;
            border: 1px solid #3e3e42;
        }

        .chat-input-area {
            position: sticky;
            bottom: 0;
            display: flex;
            gap: 8px;
            padding: 12px;
            background: #252526;
            border-top: 1px solid #3e3e42;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #d4d4d4;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .send-btn {
            padding: 10px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .send-btn:hover {
            background: #1177bb;
        }

        .send-btn:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }

        /* ËæìÂá∫Èù¢Êùø */
        .output-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .output-line {
            padding: 2px 0;
        }

        .output-line.info {
            color: #4fc1ff;
        }

        .output-line.success {
            color: #4ec9b0;
        }

        .output-line.error {
            color: #f48771;
        }

        .output-line.warning {
            color: #dcdcaa;
        }

        /* Ê¨¢ËøéÈ°µ */
        .welcome-page {
            max-width: 900px;
            margin: 50px auto;
            text-align: center;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #007acc 0%, #4ec9b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #888;
            margin-bottom: 40px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: #252526;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: #007acc;
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .feature-desc {
            font-size: 13px;
            color: #888;
            line-height: 1.5;
        }

        /* ÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* Âø´Êç∑ÈîÆÊèêÁ§∫ */
        .shortcut-hint {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
        }

        /* ‰∏ªÈ¢òÈÄâÊã©Âô® */
        .theme-selector {
            position: relative;
        }

        .theme-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .theme-menu.show {
            display: block;
            animation: menuSlideIn 0.2s ease-out;
        }

        @keyframes menuSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .theme-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-option:hover {
            background: var(--bg-tertiary);
        }

        .theme-option.active {
            background: var(--accent-color);
            color: white;
        }

        .theme-option.active::after {
            content: '‚úì';
            margin-left: auto;
            font-weight: bold;
        }

        /* ==================== ÊïôÊùêÂÜÖÂÆπÊ†∑Âºè ==================== */
        
        .textbook-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
        }

        .textbook-header h1 {
            font-size: 32px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .textbook-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .textbook-chapters h3 {
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .chapter-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chapter-item:hover {
            background: var(--bg-hover);
            border-color: var(--accent-color);
            transform: translateX(5px);
        }

        .chapter-number {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-title {
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .chapter-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chapter-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
        }

        .chapter-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .chapter-header h2 {
            font-size: 28px;
            color: var(--text-primary);
            margin-top: 15px;
        }

        .back-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-color);
        }

        .chapter-body {
            line-height: 1.8;
            color: var(--text-primary);
        }

        .chapter-body h1, .chapter-body h2, .chapter-body h3 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .chapter-body p {
            margin-bottom: 15px;
        }

        .chapter-body code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .chapter-body pre {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .chapter-body pre code {
            background: none;
            padding: 0;
        }

        .chapter-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .chapter-body table th,
        .chapter-body table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .chapter-body table th {
            background: var(--bg-secondary);
            font-weight: bold;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== ÂìçÂ∫îÂºèËÆæËÆ° ==================== */
        
        /* Âπ≥ÊùøËÆæÂ§á (1024px‰ª•‰∏ã) */
        @media (max-width: 1024px) {
            .left-panel {
                width: 250px;
            }
            
            .right-panel {
                width: 300px;
            }
            
            .bottom-panel {
                height: 200px;
            }
        }
        
        /* Â∞èÂ±èËÆæÂ§á (768px‰ª•‰∏ã) */
        @media (max-width: 768px) {
            /* Èù¢ÊùøÂèò‰∏∫ÊµÆÂä®Â±ÇÔºåË¶ÜÁõñÂú®ÂÜÖÂÆπ‰∏äÊñπ */
            .left-panel,
            .right-panel {
                position: fixed;
                height: calc(100vh - 50px);
                top: 50px;
                z-index: 1000;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            }
            
            .left-panel {
                left: 0;
                width: 280px;
            }
            
            .left-panel.collapsed {
                left: -280px;
            }
            
            .right-panel {
                right: 0;
                width: 280px;
            }
            
            .right-panel.collapsed {
                right: -280px;
            }
            
            .bottom-panel {
                height: 180px;
            }
            
            /* Ê∑ªÂä†ÈÅÆÁΩ©Â±ÇÊïàÊûú */
            .left-panel:not(.collapsed)::before,
            .right-panel:not(.collapsed)::before {
                content: '';
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
            
            /* ÊåâÈíÆÊñáÂ≠óÁÆÄÂåñ */
            .nav-btn .shortcut-hint {
                display: none;
            }
        }
        
        /* Ë∂ÖÂ∞èÂ±èËÆæÂ§á (480px‰ª•‰∏ã) */
        @media (max-width: 480px) {
            .top-nav {
                padding: 0 10px;
            }
            
            .nav-title {
                font-size: 14px;
            }
            
            .nav-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .left-panel,
            .right-panel {
                width: 100%;
                max-width: 320px;
            }
            
            .bottom-panel {
                height: 150px;
            }
            
            /* Ê¨¢ËøéÈ°µÈù¢Ë∞ÉÊï¥ */
            .welcome-title {
                font-size: 28px;
            }
            
            .feature-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="top-nav">
        <div class="nav-left">
            <div class="nav-title">
                üéì Ê∞¥Á≥ªÁªüÊéßÂà∂ÁêÜËÆ∫ÊïôÁ®ã
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="doc" onclick="switchView('doc')">
                    üìö ÊñáÊ°£
                </button>
                <button class="nav-tab" data-view="knowledge" onclick="switchView('knowledge')">
                    üß† Áü•ËØÜÂ∫ì
                </button>
                <button class="nav-tab" data-view="ide" onclick="switchView('ide')">
                    üíª ÁºñÁ®ãIDE
                </button>
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="togglePanel('left')">
                üìÅ Êñá‰ª∂Ê†ë <span class="shortcut-hint">Ctrl+B</span>
            </button>
            <button class="nav-btn" onclick="togglePanel('right')">
                ü§ñ AIÂä©Êâã <span class="shortcut-hint">Ctrl+J</span>
            </button>
            <button class="nav-btn" onclick="togglePanel('bottom')">
                üìü ÁªàÁ´Ø <span class="shortcut-hint">Ctrl+`</span>
            </button>
            <div class="theme-selector">
                <button class="nav-btn theme-btn" onclick="toggleThemeMenu()">
                    üé® ‰∏ªÈ¢ò
                </button>
                <div class="theme-menu" id="themeMenu">
                    <div class="theme-option" onclick="setTheme('light')">
                        ‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè
                    </div>
                    <div class="theme-option" onclick="setTheme('dark')">
                        üåô Ê∑±Ëâ≤Ê®°Âºè
                    </div>
                    <div class="theme-option" onclick="setTheme('auto')">
                        üîÑ Ë∑üÈöèÁ≥ªÁªü
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂÆπÂô® -->
    <div class="main-container">
        <!-- Â∑¶‰æßÈù¢Êùø - Êñá‰ª∂Ê†ë -->
        <div class="resizable-panel left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">
                    <button class="content-tab-btn active" id="caseTabBtn" onclick="switchLeftContent('case')" title="ÂàáÊç¢Âà∞Ê°à‰æã">üìÅ Ê°à‰æã</button>
                    <button class="content-tab-btn" id="textbookTabBtn" onclick="switchLeftContent('textbook')" title="ÂàáÊç¢Âà∞ÊïôÊùê">üìö ÊïôÊùê</button>
                </div>
                <div class="panel-actions">
                    <button class="panel-action-btn" onclick="togglePanel('left')" title="ÈöêËóè">‚úï</button>
                </div>
            </div>
            <div class="panel-content" id="treeContainer">
                <!-- Ê†ëËäÇÁÇπÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="resize-handle vertical" data-panel="left"></div>
        </div>

        <!-- ‰∏≠Â§ÆÂÜÖÂÆπÂå∫ -->
        <div class="center-area">
            <!-- ÊñáÊ°£ËßÜÂõæ -->
            <div class="content-view doc-view active" id="docView">
                <div id="docContent">
                    <!-- ÊñáÊ°£ÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÂä†ËΩΩ -->
                </div>
            </div>

            <!-- IDEËßÜÂõæ -->
            <div class="content-view ide-view" id="ideView">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="runCode()">‚ñ∂Ô∏è ËøêË°å</button>
                    <button class="toolbar-btn secondary" onclick="saveCode()">üíæ ‰øùÂ≠ò</button>
                    <button class="toolbar-btn secondary" onclick="compareCode()">üîç ÂØπÊØî</button>
                    <button class="toolbar-btn secondary" onclick="showHistory()">üìö ÂéÜÂè≤</button>
                </div>
                <div id="editor"></div>
            </div>

            <!-- Áü•ËØÜÂ∫ìËßÜÂõæ -->
            <div class="content-view knowledge-view" id="knowledgeView">
                <div class="knowledge-container">
                    <!-- ÊêúÁ¥¢Âå∫Âüü -->
                    <div class="knowledge-search-bar">
                        <input type="text" id="knowledgeSearchInput" placeholder="ÊêúÁ¥¢Áü•ËØÜÂ∫ì..." 
                               onkeypress="if(event.key==='Enter') searchKnowledge()">
                        <button class="toolbar-btn" onclick="searchKnowledge()">üîç ÊêúÁ¥¢</button>
                        <button class="toolbar-btn secondary" onclick="showCategories()">üìö ÂàÜÁ±ª</button>
                        <button class="toolbar-btn secondary" onclick="showRecommendations()">‚≠ê Êé®Ëçê</button>
                        <button class="toolbar-btn secondary" onclick="showRAGChat()">üí¨ Êô∫ËÉΩÈóÆÁ≠î</button>
                        <button class="toolbar-btn secondary" onclick="showKnowledgeGraph()">üï∏Ô∏è Áü•ËØÜÂõæË∞±</button>
                    </div>
                    
                    <!-- Áü•ËØÜÂÜÖÂÆπÂå∫ -->
                    <div class="knowledge-content" id="knowledgeContent">
                        <div class="knowledge-welcome">
                            <h2>üß† Ê∞¥Âà©Ê∞¥ÁîµÊ∞¥Âä°Áü•ËØÜÂ∫ì</h2>
                            <p>Êô∫ËÉΩÁü•ËØÜÊ£ÄÁ¥¢Á≥ªÁªüÔºåÊîØÊåÅÂêëÈáèÊêúÁ¥¢ÂíåÊô∫ËÉΩÈóÆÁ≠î</p>
                            <div class="knowledge-stats" id="knowledgeStats">
                                <div class="stat-item">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Áü•ËØÜÊù°ÁõÆ</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">ÂàÜÁ±ªÊï∞Èáè</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Ê°à‰æãÂÖ≥ËÅî</div>
                                </div>
                            </div>
                            <div class="knowledge-quick-links">
                                <button class="quick-link-btn" onclick="searchKnowledge('Ê∞¥Â°îÊéßÂà∂')">üíß Ê∞¥Â°îÊéßÂà∂</button>
                                <button class="quick-link-btn" onclick="searchKnowledge('PIDÊéßÂà∂')">‚öôÔ∏è PIDÊéßÂà∂</button>
                                <button class="quick-link-btn" onclick="searchKnowledge('Ê∞¥ÂäõÂ≠¶')">üåä Ê∞¥ÂäõÂ≠¶</button>
                                <button class="quick-link-btn" onclick="searchKnowledge('‰æõÊ∞¥Á≥ªÁªü')">üö∞ ‰æõÊ∞¥Á≥ªÁªü</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Â∫ïÈÉ®Èù¢Êùø - ËæìÂá∫/ÁªàÁ´Ø -->
            <div class="resizable-panel bottom-panel collapsed" id="bottomPanel">
                <div class="resize-handle horizontal" data-panel="bottom"></div>
                <div class="panel-header">
                    <div class="panel-title">üìü ËæìÂá∫</div>
                    <div class="panel-actions">
                        <button class="panel-action-btn" onclick="clearOutput()" title="Ê∏ÖÁ©∫">üóëÔ∏è</button>
                        <button class="panel-action-btn" onclick="togglePanel('bottom')" title="ÈöêËóè">‚úï</button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="output-content" id="outputContent">
                        <div class="output-line info">ÂáÜÂ§áÂ∞±Áª™...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÈù¢Êùø - AIÂä©Êâã -->
        <div class="resizable-panel right-panel collapsed" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">ü§ñ AIÁºñÁ®ãÂä©Êâã</div>
                <div class="panel-actions">
                    <button class="panel-action-btn" onclick="togglePanel('right')" title="ÈöêËóè">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="ai-chat">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant">
                            üëã ‰Ω†Â•ΩÔºÅÊàëÊòØAIÁºñÁ®ãÂä©Êâã„ÄÇÊàëÂèØ‰ª•Â∏Æ‰Ω†Ôºö<br>
                            ‚Ä¢ ÂàÜÊûê‰ª£Á†ÅÂíåÂèÇÊï∞<br>
                            ‚Ä¢ Êèê‰æõ‰ºòÂåñÂª∫ËÆÆ<br>
                            ‚Ä¢ Ëß£Á≠îÊéßÂà∂ÁêÜËÆ∫ÈóÆÈ¢ò
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <textarea class="chat-input" id="chatInput" placeholder="ËæìÂÖ•ÈóÆÈ¢ò..." rows="2"></textarea>
                        <button class="send-btn" id="sendChatBtn" onclick="sendChat()">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle vertical" data-panel="right"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let allCases = [];
        let currentCase = null;
        let currentView = 'doc';
        let editor = null;
        let originalCode = '';
        let currentLeftContent = 'case'; // 'case' | 'textbook' | 'knowledge'
        let currentTextbook = null;
        let textbooksData = [];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();  // ÂàùÂßãÂåñ‰∏ªÈ¢ò
            loadCases();
            showWelcomePage();
            initResizeHandles();
            initKeyboardShortcuts();
            initImagePreview();  // ÂêØÁî®ÂõæÁâáÈ¢ÑËßàÂäüËÉΩ
            initPanelStates();  // ÂàùÂßãÂåñÈù¢ÊùøÁä∂ÊÄÅ
            
            // ËÅäÂ§©ËæìÂÖ•ÂõûËΩ¶ÂèëÈÄÅ
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChat();
                }
            });
            
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ªÈ¢òËèúÂçï
            document.addEventListener('click', (e) => {
                const themeMenu = document.getElementById('themeMenu');
                const themeBtn = document.querySelector('.theme-btn');
                if (themeMenu && !themeMenu.contains(e.target) && e.target !== themeBtn) {
                    themeMenu.classList.remove('show');
                }
            });
        });

        // Âä†ËΩΩÊ°à‰æãÂàóË°®
        async function loadCases() {
            try {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases`);
                const data = await response.json();
                
                if (data.success && data.cases) {
                    allCases = data.cases.map((c, index) => ({
                        ...c,
                        category: c.category || getCategoryByIndex(index + 1),
                        displayName: c.title || c.name
                    }));
                    renderTree(allCases);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊ°à‰æãÂ§±Ë¥•:', error);
            }
        }

        // Ê∏≤ÊüìÊ†ë
        function renderTree(cases) {
            const container = document.getElementById('treeContainer');
            
            const groups = {
                'Âü∫Á°ÄÊéßÂà∂': cases.filter(c => c.category === 'Âü∫Á°ÄÊéßÂà∂'),
                'È´òÁ∫ßÊéßÂà∂': cases.filter(c => c.category === 'È´òÁ∫ßÊéßÂà∂'),
                'Êô∫ËÉΩÊéßÂà∂': cases.filter(c => c.category === 'Êô∫ËÉΩÊéßÂà∂')
            };
            
            let html = '';
            for (const [groupName, groupCases] of Object.entries(groups)) {
                if (groupCases.length > 0) {
                    html += `<div class="tree-group">`;
                    html += `<div class="tree-group-header">${groupName}</div>`;
                    groupCases.forEach(c => {
                        const icon = getIconForCase(c.id);
                        html += `
                            <div class="tree-node" data-case-id="${c.id}">
                                <span class="tree-icon">${icon}</span>
                                <span class="tree-label">${c.displayName}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            }
            container.innerHTML = html;
            
            // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
            container.querySelectorAll('.tree-node').forEach(node => {
                node.addEventListener('click', function(e) {
                    const caseId = this.dataset.caseId;
                    
                    // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
                    container.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Âä†ËΩΩÊ°à‰æã
                    loadCase(caseId);
                });
            });
        }

        function getCategoryByIndex(index) {
            if (index <= 4) return 'Âü∫Á°ÄÊéßÂà∂';
            if (index <= 10) return 'È´òÁ∫ßÊéßÂà∂';
            return 'Êô∫ËÉΩÊéßÂà∂';
        }

        function getIconForCase(caseId) {
            const icons = {
                'case_01': 'üíß', 'case_02': 'üè≠', 'case_03': 'üö∞', 'case_04': '‚öôÔ∏è',
                'case_05': 'üîç', 'case_06': 'üìä', 'case_07': 'üîó', 'case_08': '‚û°Ô∏è',
                'case_09': 'üéì', 'case_10': 'üìà', 'case_11': 'üéØ', 'case_12': 'üëÅÔ∏è',
                'case_13': 'üîÑ', 'case_14': 'üéÆ', 'case_15': 'üõ°Ô∏è', 'case_16': 'üß†',
                'case_17': 'ü§ñ', 'case_18': 'üé≤', 'case_19': 'üìã', 'case_20': 'üöÄ'
            };
            for (const key in icons) {
                if (caseId.includes(key)) return icons[key];
            }
            return 'üìÑ';
        }

        // ==================== Â∑¶‰æßÂÜÖÂÆπÂàáÊç¢ÂäüËÉΩ ====================
        
        // ÂàáÊç¢Â∑¶‰æßÈù¢ÊùøÂÜÖÂÆπÔºàÊ°à‰æã/ÊïôÊùê/Áü•ËØÜÂ∫ìÔºâ
        function switchLeftContent(type) {
            currentLeftContent = type;
            
            // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.content-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (type === 'case') {
                document.getElementById('caseTabBtn').classList.add('active');
                renderTree(allCases);
            } else if (type === 'textbook') {
                document.getElementById('textbookTabBtn').classList.add('active');
                if (textbooksData.length === 0) {
                    loadTextbooks();
                } else {
                    renderTextbookTree(textbooksData);
                }
            }
            
            console.log(`[UI] ÂàáÊç¢Âà∞${type === 'case' ? 'Ê°à‰æã' : 'ÊïôÊùê'}ËßÜÂõæ`);
        }

        // Âä†ËΩΩÊïôÊùêÂàóË°®
        async function loadTextbooks() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Ê≠£Âú®Âä†ËΩΩÊïôÊùêÂàóË°®...</div>';
            
            try {
                const response = await fetch('/api/textbooks/');
                const data = await response.json();
                
                if (data.success && data.textbooks) {
                    textbooksData = data.textbooks;
                    renderTextbookTree(textbooksData);
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊïôÊùêÂ§±Ë¥•:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•: ' + error.message + '</div>';
            }
        }

        // Ê∏≤ÊüìÊïôÊùêÊ†ë
        function renderTextbookTree(textbooks) {
            const container = document.getElementById('treeContainer');
            
            if (!textbooks || textbooks.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">ÊöÇÊó†ÊïôÊùê</div>';
                return;
            }
            
            let html = '<div class="tree-group">';
            html += '<div class="tree-group-header">üìö ÊïôÊùêÂàóË°® (' + textbooks.length + 'Êú¨)</div>';
            
            textbooks.forEach(book => {
                const chapterCount = book.chapter_count || 0;
                const wordCount = book.word_count || 0;
                const icon = 'üìñ';
                
                html += `
                    <div class="tree-node textbook-node" data-book-id="${book.id}">
                        <span class="tree-icon">${icon}</span>
                        <div style="flex: 1;">
                            <div class="tree-label">${book.title || book.name}</div>
                            <div style="font-size: 10px; color: #888; margin-top: 2px;">
                                ${chapterCount}Á´† ¬∑ ${(wordCount / 10000).toFixed(1)}‰∏áÂ≠ó
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
            container.querySelectorAll('.textbook-node').forEach(node => {
                node.addEventListener('click', function(e) {
                    const bookId = this.dataset.bookId;
                    loadTextbookContent(bookId);
                    
                    // È´ò‰∫ÆÂΩìÂâçÈÄâ‰∏≠
                    container.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Âä†ËΩΩÊïôÊùêÂÜÖÂÆπ
        async function loadTextbookContent(bookId) {
            currentTextbook = bookId;
            
            // ÂàáÊç¢Âà∞ÊñáÊ°£ËßÜÂõæ
            switchView('doc');
            
            const docContent = document.getElementById('docContent');
            docContent.innerHTML = '<div style="padding: 50px; text-align: center;"><div class="spinner"></div><p style="margin-top: 20px; color: #888;">Ê≠£Âú®Âä†ËΩΩÊïôÊùêÂÜÖÂÆπ...</p></div>';
            
            try {
                const response = await fetch(`/api/textbooks/${bookId}`);
                const data = await response.json();
                
                if (data.success && data.textbook) {
                    renderTextbookContent(data.textbook);
                } else {
                    docContent.innerHTML = '<div style="padding: 50px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊïôÊùêÂÜÖÂÆπÂ§±Ë¥•:', error);
                docContent.innerHTML = '<div style="padding: 50px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•: ' + error.message + '</div>';
            }
        }

        // Ê∏≤ÊüìÊïôÊùêÂÜÖÂÆπ
        function renderTextbookContent(textbook) {
            const docContent = document.getElementById('docContent');
            
            let html = `
                <div class="textbook-content">
                    <div class="textbook-header">
                        <h1>${textbook.title || textbook.name}</h1>
                        <div class="textbook-meta">
                            <span>üìñ ${textbook.chapter_count || 0} Á´†ËäÇ</span>
                            <span>üìù ${(textbook.word_count / 10000 || 0).toFixed(1)} ‰∏áÂ≠ó</span>
                        </div>
                    </div>
                    
                    <div class="textbook-chapters">
                        <h3>üìë Á´†ËäÇÁõÆÂΩï</h3>
                        <div class="chapter-list">
            `;
            
            if (textbook.chapters && textbook.chapters.length > 0) {
                textbook.chapters.forEach((chapter, index) => {
                    html += `
                        <div class="chapter-item" onclick="loadChapterContent('${textbook.id}', '${chapter.id}')">
                            <div class="chapter-number">${index + 1}</div>
                            <div class="chapter-info">
                                <div class="chapter-title">${chapter.title}</div>
                                <div class="chapter-meta">${chapter.word_count || 0} Â≠ó</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="padding: 20px; text-align: center; color: #888;">ÊöÇÊó†Á´†ËäÇ</div>';
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            docContent.innerHTML = html;
        }

        // Âä†ËΩΩÁ´†ËäÇÂÜÖÂÆπ
        async function loadChapterContent(bookId, chapterId) {
            const docContent = document.getElementById('docContent');
            docContent.innerHTML = '<div style="padding: 50px; text-align: center;"><div class="spinner"></div><p style="margin-top: 20px; color: #888;">Ê≠£Âú®Âä†ËΩΩÁ´†ËäÇÂÜÖÂÆπ...</p></div>';
            
            try {
                const response = await fetch(`/api/textbooks/${bookId}/chapters/${chapterId}`);
                const data = await response.json();
                
                if (data.success && data.chapter) {
                    renderChapterContent(data.chapter, bookId);
                } else {
                    docContent.innerHTML = '<div style="padding: 50px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ´†ËäÇÂÜÖÂÆπÂ§±Ë¥•:', error);
                docContent.innerHTML = '<div style="padding: 50px; text-align: center; color: #f00;">Âä†ËΩΩÂ§±Ë¥•: ' + error.message + '</div>';
            }
        }

        // Ê∏≤ÊüìÁ´†ËäÇÂÜÖÂÆπ
        function renderChapterContent(chapter, bookId) {
            const docContent = document.getElementById('docContent');
            
            let html = `
                <div class="chapter-content">
                    <div class="chapter-header">
                        <button class="back-btn" onclick="loadTextbookContent('${bookId}')">
                            ‚Üê ËøîÂõûÁõÆÂΩï
                        </button>
                        <h2>${chapter.title}</h2>
                    </div>
                    <div class="chapter-body">
            `;
            
            if (chapter.content) {
                // ‰ΩøÁî®markedÊ∏≤ÊüìMarkdown
                if (typeof marked !== 'undefined') {
                    html += marked.parse(chapter.content);
                } else {
                    html += '<pre>' + chapter.content + '</pre>';
                }
            } else {
                html += '<div style="padding: 50px; text-align: center; color: #888;">ÊöÇÊó†ÂÜÖÂÆπ</div>';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            docContent.innerHTML = html;
        }

        // Âä†ËΩΩÊ°à‰æã
        async function loadCase(caseId) {
            currentCase = caseId;
            
            // ÊòæÁ§∫loadingÂä®Áîª
            const contentArea = document.getElementById('docContent') || document.querySelector('.center-area');
            const loadingOverlay = showLoading(contentArea, 'Ê≠£Âú®Âä†ËΩΩÊ°à‰æã...');
            
            try {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${caseId}`);
                const data = await response.json();
                
                if (data.success && data.case) {
                    if (currentView === 'doc') {
                        showDocumentation(data.case);
                    } else {
                        await loadCodeIntoEditor(data.case);
                    }
                    hideLoading(loadingOverlay);
                } else {
                    console.error('Ê°à‰æãÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', data);
                    hideLoading(loadingOverlay);
                    showFriendlyError(
                        'Ê°à‰æãÂä†ËΩΩÂ§±Ë¥•',
                        data.error || 'Êó†Ê≥ïÂä†ËΩΩÊ°à‰æãÊï∞ÊçÆÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ'
                    );
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊ°à‰æãÂ§±Ë¥•:', error);
                hideLoading(loadingOverlay);
                showFriendlyError(
                    'ÁΩëÁªúËøûÊé•ÈîôËØØ',
                    'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï„ÄÇ'
                );
            }
        }

        // ÊòæÁ§∫ÊñáÊ°£
        function showDocumentation(caseData) {
            const docContent = document.getElementById('docContent');
            
            if (caseData.readme) {
                let html = '';
                
                // Ê£ÄÊü•markedÊòØÂê¶Â∑≤Âä†ËΩΩ
                if (typeof marked !== 'undefined') {
                    // ÈÖçÁΩÆmarked‰ª•ÊîØÊåÅHTMLÂÜÖÁöÑMarkdown
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        pedantic: false
                    });
                    html = marked.parse(caseData.readme);
                } else {
                    // ÈôçÁ∫ßÔºöÁÆÄÂçïÁöÑMarkdownËΩ¨Êç¢
                    html = convertMarkdownSimple(caseData.readme);
                }
                
                // ÂàõÂª∫‰∏¥Êó∂DOMÊù•Â§ÑÁêÜHTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Â§ÑÁêÜË°®Ê†ºÂÜÖÁöÑMarkdownÂõæÁâáËØ≠Ê≥ï
                const tableCells = tempDiv.querySelectorAll('td');
                tableCells.forEach(cell => {
                    // Êü•Êâæ ![xxx](yyy.png) Ê†ºÂºèÁöÑÂõæÁâá
                    const mdImagePattern = /!\[([^\]]*)\]\(([^)]+\.png[^)]*)\)/g;
                    cell.innerHTML = cell.innerHTML.replace(mdImagePattern, (match, alt, src) => {
                        // ÊèêÂèñÊñá‰ª∂Âêç
                        const fname = src.split('/').pop();
                        const fullSrc = `${API_BASE}/books/water-system-control/cases/${currentCase}/images/${fname}`;
                        return `<img src="${fullSrc}" alt="${alt}" />`;
                    });
                });
                
                // ÊõøÊç¢ÊâÄÊúâimgÊ†áÁ≠æÁöÑsrc - Â§ÑÁêÜÂ∑≤ÁªèÊòØ<img>Ê†áÁ≠æÁöÑÂõæÁâá
                const images = tempDiv.querySelectorAll('img');
                images.forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && !src.startsWith('http') && !src.startsWith('/api/')) {
                        const fname = src.split('/').pop();
                        img.setAttribute('src', `${API_BASE}/books/water-system-control/cases/${currentCase}/images/${fname}`);
                    }
                });
                
                docContent.innerHTML = `<div class="readme-content">${tempDiv.innerHTML}</div>`;
            } else {
                docContent.innerHTML = '<div class="readme-content"><p>ÊöÇÊó†ÊñáÊ°£ÂÜÖÂÆπ</p></div>';
            }
        }
        
        // ÁÆÄÂçïÁöÑMarkdownËΩ¨Êç¢ÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
        function convertMarkdownSimple(markdown) {
            if (!markdown) return '';
            
            return markdown
                // Ê†áÈ¢ò
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Á≤ó‰Ωì
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // ‰ª£Á†Å
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Êç¢Ë°å
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // ÂåÖË£πÊÆµËêΩ
                .replace(/^(.+)$/gim, '<p>$1</p>');
        }

        // Âä†ËΩΩ‰ª£Á†ÅÂà∞ÁºñËæëÂô®
        async function loadCodeIntoEditor(caseData) {
            if (!editor) {
                await initMonacoEditor();
            }
            
            if (caseData.code) {
                originalCode = caseData.code;
                editor.setValue(originalCode);
            }
        }

        // ÂàùÂßãÂåñMonacoÁºñËæëÂô®
        async function initMonacoEditor() {
            return new Promise((resolve) => {
                require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
                require(['vs/editor/editor.main'], function () {
                    editor = monaco.editor.create(document.getElementById('editor'), {
                        value: '# ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©Ê°à‰æã',
                        language: 'python',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: true },
                        scrollBeyondLastLine: false
                    });
                    resolve();
                });
            });
        }

        // ÂàáÊç¢ËßÜÂõæ
        async function switchView(view) {
            currentView = view;
            
            // Êõ¥Êñ∞Ê†áÁ≠æ
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            // ÂàáÊç¢ËßÜÂõæ
            document.querySelectorAll('.content-view').forEach(v => {
                v.classList.toggle('active', v.id === view + 'View');
            });
            
            // IDEËßÜÂõæÈúÄË¶ÅÂàùÂßãÂåñÁºñËæëÂô®
            if (view === 'ide' && !editor && currentCase) {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${currentCase}`);
                const data = await response.json();
                if (data.success) {
                    await loadCodeIntoEditor(data.case);
                }
            }
            
            // Áü•ËØÜÂ∫ìËßÜÂõæÈúÄË¶ÅÂä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
            if (view === 'knowledge') {
                loadKnowledgeStats();
            }
        }

        // ==================== Áü•ËØÜÂ∫ìÂäüËÉΩ ====================
        
        let knowledgeStats = null;
        
        // Âä†ËΩΩÁü•ËØÜÂ∫ìÁªüËÆ°‰ø°ÊÅØ
        async function loadKnowledgeStats() {
            try {
                const response = await fetch('/api/knowledge/stats');
                const data = await response.json();
                
                if (data.success) {
                    knowledgeStats = data.stats;
                    const stats = data.stats;
                    
                    // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
                    const statItems = document.querySelectorAll('#knowledgeStats .stat-value');
                    if (statItems.length >= 3) {
                        statItems[0].textContent = stats.total_knowledge || 0;
                        statItems[1].textContent = stats.total_categories || 0;
                        statItems[2].textContent = '20';  // Ê°à‰æãÂÖ≥ËÅîÊï∞
                    }
                }
            } catch (error) {
                console.error('Failed to load knowledge stats:', error);
            }
        }
        
        // ÊêúÁ¥¢Áü•ËØÜ
        async function searchKnowledge(query) {
            const input = document.getElementById('knowledgeSearchInput');
            const searchQuery = query || input.value.trim();
            
            if (!searchQuery) {
                alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç');
                return;
            }
            
            // Êõ¥Êñ∞ËæìÂÖ•Ê°Ü
            input.value = searchQuery;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®ÊêúÁ¥¢...</p></div>';
            
            try {
                const response = await fetch('/api/knowledge/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: searchQuery, limit: 10})
                });
                
                const data = await response.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    displayKnowledgeResults(data.results, searchQuery);
                } else {
                    content.innerHTML = `
                        <div class="knowledge-welcome">
                            <h3>Êú™ÊâæÂà∞Áõ∏ÂÖ≥Áü•ËØÜ</h3>
                            <p>ÂÖ≥ÈîÆËØçÔºö"${searchQuery}"</p>
                            <button class="quick-link-btn" onclick="searchKnowledge('Ê∞¥Â°îÊéßÂà∂')">Â∞ùËØïÂÖ∂‰ªñÊêúÁ¥¢</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search failed:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï</p></div>';
            }
        }
        
        // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
        function displayKnowledgeResults(results, query) {
            const content = document.getElementById('knowledgeContent');
            
            let html = `
                <div class="knowledge-results">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">
                        ÊêúÁ¥¢ÁªìÊûúÔºö${results.length} Êù°
                        <span style="color: var(--text-secondary); font-size: 14px; font-weight: normal;">
                            ÔºàÂÖ≥ÈîÆËØçÔºö${query}Ôºâ
                        </span>
                    </h3>
            `;
            
            results.forEach(item => {
                html += `
                    <div class="knowledge-card" onclick="showKnowledgeDetail('${item.id}')">
                        <div class="knowledge-card-title">${item.title}</div>
                        <div class="knowledge-card-meta">
                            <span>üìö ${item.category}</span>
                            <span>üéì ${item.level}</span>
                            <span>üìñ ${item.source}</span>
                            ${item.score ? `<span>‚≠ê ${(item.score * 100).toFixed(0)}%</span>` : ''}
                        </div>
                        <div class="knowledge-card-content">${item.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // ÊòæÁ§∫ÂàÜÁ±ª
        async function showCategories() {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩÂàÜÁ±ª...</p></div>';
            
            try {
                const response = await fetch('/api/knowledge/categories');
                const data = await response.json();
                
                if (data.success && data.categories) {
                    displayCategories(data.categories);
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        // ÊòæÁ§∫ÂàÜÁ±ªÂàóË°®
        function displayCategories(categories) {
            const content = document.getElementById('knowledgeContent');
            
            let html = '<div class="knowledge-results"><h3 style="margin-bottom: 20px; color: var(--text-primary);">Áü•ËØÜÂàÜÁ±ª</h3>';
            
            categories.forEach(cat => {
                html += `
                    <div class="knowledge-card">
                        <div class="knowledge-card-title">${cat.name}</div>
                        <div class="knowledge-card-content">${cat.description || 'ÊöÇÊó†ÊèèËø∞'}</div>
                `;
                
                if (cat.children && cat.children.length > 0) {
                    html += '<div class="knowledge-card-tags">';
                    cat.children.forEach(child => {
                        html += `<span class="knowledge-tag" onclick="searchKnowledge('${child.name}')" style="cursor:pointer">${child.name}</span>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // ÊòæÁ§∫Áü•ËØÜËØ¶ÊÉÖ
        async function showKnowledgeDetail(knowledgeId) {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩ...</p></div>';
            
            try {
                const response = await fetch(`/api/knowledge/knowledge/${knowledgeId}`);
                const data = await response.json();
                
                if (data.success && data.knowledge) {
                    const k = data.knowledge;
                    content.innerHTML = `
                        <div class="knowledge-results">
                            <button class="toolbar-btn secondary" onclick="searchKnowledge()">‚Üê ËøîÂõûÊêúÁ¥¢</button>
                            <div class="knowledge-card" style="margin-top: 20px;">
                                <div class="knowledge-card-title">${k.title}</div>
                                <div class="knowledge-card-meta">
                                    <span>üìö ${k.category}</span>
                                    <span>üéì ${k.level}</span>
                                    <span>üìñ ${k.source_type}: ${k.source_name}</span>
                                    ${k.author ? `<span>‚úçÔ∏è ${k.author}</span>` : ''}
                                    <span>üëÅÔ∏è ${k.view_count} ÊµèËßà</span>
                                </div>
                                <div class="knowledge-card-content" style="white-space: pre-wrap; max-width: none;">
                                    ${k.content}
                                </div>
                                ${k.keywords && k.keywords.length > 0 ? `
                                    <div class="knowledge-card-tags" style="margin-top: 15px;">
                                        ${k.keywords.map(kw => `<span class="knowledge-tag">${kw}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load knowledge detail:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        // ÊòæÁ§∫RAGÊô∫ËÉΩÈóÆÁ≠î
        function showRAGChat() {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = `
                <div class="rag-chat-container">
                    <div class="rag-messages" id="ragMessages">
                        <div class="rag-message assistant">
                            ÊÇ®Â•ΩÔºÅÊàëÊòØÊ∞¥Âà©Ê∞¥ÁîµÊô∫ËÉΩÂä©Êâã„ÄÇÊÇ®ÂèØ‰ª•ÈóÆÊàëÂÖ≥‰∫éÊ∞¥Âà©Â∑•Á®ã„ÄÅÊ∞¥ÁîµÁ´ô„ÄÅÊ∞¥Âä°ÁÆ°ÁêÜÁ≠âÊñπÈù¢ÁöÑÈóÆÈ¢ò„ÄÇ
                        </div>
                    </div>
                    <div class="rag-input-area">
                        <input type="text" id="ragInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." 
                               onkeypress="if(event.key==='Enter') askRAG()">
                        <button class="toolbar-btn" onclick="askRAG()">ÂèëÈÄÅ</button>
                    </div>
                </div>
            `;
        }
        
        // ÊòæÁ§∫Êé®ËçêÁü•ËØÜ
        async function showRecommendations(knowledgeId = null) {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩÊé®Ëçê...</p></div>';
            
            try {
                const url = knowledgeId 
                    ? `/api/knowledge/recommend?knowledge_id=${knowledgeId}&limit=5`
                    : '/api/knowledge/recommend?limit=10';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    displayRecommendations(data.recommendations, data.based_on);
                } else {
                    content.innerHTML = `
                        <div class="knowledge-welcome">
                            <h3>ÊöÇÊó†Êé®Ëçê</h3>
                            <p>Áü•ËØÜÂ∫ìÂÜÖÂÆπËæÉÂ∞ëÔºåËØ∑Â∞ùËØïÊêúÁ¥¢ÊàñÊµèËßàÂàÜÁ±ª</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        // ÊòæÁ§∫Êé®ËçêÁªìÊûú
        function displayRecommendations(recommendations, basedOn) {
            const content = document.getElementById('knowledgeContent');
            
            let title = basedOn === 'popularity' ? 'üî• ÁÉ≠Èó®Êé®Ëçê' : 'üìå Áõ∏ÂÖ≥Êé®Ëçê';
            
            let html = `
                <div class="knowledge-results">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin: 0;">${title}</h3>
                        <div>
                            <button class="toolbar-btn secondary" onclick="showPopularKnowledge()">üî• ÁÉ≠Èó®</button>
                            <button class="toolbar-btn secondary" onclick="showRecentKnowledge()">üÜï ÊúÄÊñ∞</button>
                        </div>
                    </div>
            `;
            
            recommendations.forEach(item => {
                html += `
                    <div class="knowledge-card" onclick="showKnowledgeDetail('${item.id}')">
                        <div class="knowledge-card-title">${item.title}</div>
                        <div class="knowledge-card-meta">
                            <span>üìö ${item.category}</span>
                            <span>üéì ${item.level}</span>
                            <span>üëÅÔ∏è ${item.view_count} ÊµèËßà</span>
                        </div>
                        <div class="knowledge-card-content">${item.content}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // ÊòæÁ§∫ÁÉ≠Èó®Áü•ËØÜ
        async function showPopularKnowledge() {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩÁÉ≠Èó®Áü•ËØÜ...</p></div>';
            
            try {
                const response = await fetch('/api/knowledge/popular?limit=10');
                const data = await response.json();
                
                if (data.success && data.popular && data.popular.length > 0) {
                    displayPopularKnowledge(data.popular);
                }
            } catch (error) {
                console.error('Failed to load popular knowledge:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        // ÊòæÁ§∫ÁÉ≠Èó®Áü•ËØÜÂàóË°®
        function displayPopularKnowledge(popular) {
            const content = document.getElementById('knowledgeContent');
            
            let html = `
                <div class="knowledge-results">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üî• ÁÉ≠Èó®Áü•ËØÜÊéíË°å</h3>
            `;
            
            popular.forEach((item, index) => {
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                html += `
                    <div class="knowledge-card" onclick="showKnowledgeDetail('${item.id}')">
                        <div class="knowledge-card-title">
                            <span style="font-size: 20px; margin-right: 10px;">${rankIcon}</span>
                            ${item.title}
                        </div>
                        <div class="knowledge-card-meta">
                            <span>üìö ${item.category}</span>
                            <span>üéì ${item.level}</span>
                            <span>üëÅÔ∏è ${item.view_count} ÊµèËßà</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // ÊòæÁ§∫ÊúÄÊñ∞Áü•ËØÜ
        async function showRecentKnowledge() {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩÊúÄÊñ∞Áü•ËØÜ...</p></div>';
            
            try {
                const response = await fetch('/api/knowledge/recent?limit=10');
                const data = await response.json();
                
                if (data.success && data.recent && data.recent.length > 0) {
                    displayRecentKnowledge(data.recent);
                }
            } catch (error) {
                console.error('Failed to load recent knowledge:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        // ÊòæÁ§∫ÊúÄÊñ∞Áü•ËØÜÂàóË°®
        function displayRecentKnowledge(recent) {
            const content = document.getElementById('knowledgeContent');
            
            let html = `
                <div class="knowledge-results">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üÜï ÊúÄÊñ∞Áü•ËØÜ</h3>
            `;
            
            recent.forEach(item => {
                const date = new Date(item.created_at);
                const dateStr = date.toLocaleDateString('zh-CN');
                
                html += `
                    <div class="knowledge-card" onclick="showKnowledgeDetail('${item.id}')">
                        <div class="knowledge-card-title">${item.title}</div>
                        <div class="knowledge-card-meta">
                            <span>üìö ${item.category}</span>
                            <span>üéì ${item.level}</span>
                            <span>üìÖ ${dateStr}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // RAGÈóÆÁ≠î
        async function askRAG() {
            const input = document.getElementById('ragInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const messages = document.getElementById('ragMessages');
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            messages.innerHTML += `
                <div class="rag-message user">${question}</div>
            `;
            
            // Ê∏ÖÁ©∫ËæìÂÖ•
            input.value = '';
            
            // Ê∑ªÂä†Âä†ËΩΩÊèêÁ§∫
            messages.innerHTML += `
                <div class="rag-message assistant" id="ragLoading">
                    Ê≠£Âú®ÊÄùËÄÉ...
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
            
            try {
                // ÂÖàÊêúÁ¥¢Áõ∏ÂÖ≥Áü•ËØÜ
                const searchResponse = await fetch('/api/knowledge/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: question, limit: 3})
                });
                
                const searchData = await searchResponse.json();
                
                // ÁßªÈô§Âä†ËΩΩÊèêÁ§∫
                document.getElementById('ragLoading').remove();
                
                if (searchData.success && searchData.results && searchData.results.length > 0) {
                    // Âü∫‰∫éÊ£ÄÁ¥¢ÁªìÊûúÁîüÊàêÂõûÁ≠î
                    const results = searchData.results;
                    let answer = `Ê†πÊçÆÁü•ËØÜÂ∫ìÊ£ÄÁ¥¢ÔºåÊàë‰∏∫ÊÇ®ÊâæÂà∞‰ª•‰∏ãÁõ∏ÂÖ≥‰ø°ÊÅØÔºö\n\n`;
                    
                    results.forEach((item, index) => {
                        answer += `${index + 1}. **${item.title}** (${item.category})\n`;
                        answer += `   ${item.content.substring(0, 150)}...\n\n`;
                    });
                    
                    answer += `\nüí° ÊèêÁ§∫ÔºöÁÇπÂáªÊêúÁ¥¢Ê°ÜÊóÅÁöÑ"ÊêúÁ¥¢"ÊåâÈíÆÂèØ‰ª•Êü•ÁúãÂÆåÊï¥ÂÜÖÂÆπ„ÄÇ`;
                    
                    messages.innerHTML += `
                        <div class="rag-message assistant">${answer.replace(/\n/g, '<br>')}</div>
                    `;
                } else {
                    messages.innerHTML += `
                        <div class="rag-message assistant">
                            Êä±Ê≠âÔºåÊàëÊ≤°ÊúâÊâæÂà∞‰∏é"${question}"Áõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØ„ÄÇÊÇ®ÂèØ‰ª•Â∞ùËØïÔºö<br>
                            ‚Ä¢ ‰ΩøÁî®‰∏çÂêåÁöÑÂÖ≥ÈîÆËØç<br>
                            ‚Ä¢ Êü•ÁúãÂàÜÁ±ªÊµèËßà<br>
                            ‚Ä¢ Êü•ÁúãÂø´Êç∑ÈìæÊé•‰∏≠ÁöÑÁÉ≠Èó®‰∏ªÈ¢ò
                        </div>
                    `;
                }
            } catch (error) {
                console.error('RAG failed:', error);
                document.getElementById('ragLoading').remove();
                messages.innerHTML += `
                    <div class="rag-message assistant">Êä±Ê≠âÔºåÂ§ÑÁêÜÊÇ®ÁöÑÈóÆÈ¢òÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ</div>
                `;
            }
            
            messages.scrollTop = messages.scrollHeight;
        }

        // Áü•ËØÜÂõæË∞±ÂèØËßÜÂåñ
        let graphSimulation = null;
        
        async function showKnowledgeGraph() {
            const content = document.getElementById('knowledgeContent');
            content.innerHTML = '<div class="knowledge-welcome"><p>Ê≠£Âú®Âä†ËΩΩÁü•ËØÜÂõæË∞±...</p></div>';
            
            try {
                const response = await fetch('/api/knowledge/graph');
                const data = await response.json();
                
                if (data.success && data.nodes && data.nodes.length > 0) {
                    renderKnowledgeGraph(data);
                } else {
                    content.innerHTML = '<div class="knowledge-welcome"><p>ÊöÇÊó†Áü•ËØÜÂõæË∞±Êï∞ÊçÆ</p></div>';
                }
            } catch (error) {
                console.error('Failed to load knowledge graph:', error);
                content.innerHTML = '<div class="knowledge-welcome"><p>Âä†ËΩΩÂ§±Ë¥•</p></div>';
            }
        }
        
        function renderKnowledgeGraph(graphData) {
            const content = document.getElementById('knowledgeContent');
            
            // ÂàõÂª∫ÂÆπÂô®
            content.innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);">üï∏Ô∏è Áü•ËØÜÂõæË∞±</h3>
                    <div class="knowledge-graph-container" id="graphContainer">
                        <svg id="graphSvg"></svg>
                        <div class="graph-controls">
                            <button class="graph-control-btn" onclick="resetGraphZoom()">üîÑ ÈáçÁΩÆ</button>
                            <button class="graph-control-btn" onclick="centerGraph()">üìç Â±Ö‰∏≠</button>
                        </div>
                        <div class="graph-info">
                            <div>üìä ËäÇÁÇπ: ${graphData.stats.node_count}</div>
                            <div>üîó ËøûÊé•: ${graphData.stats.edge_count}</div>
                            <div>üìö ÂàÜÁ±ª: ${graphData.stats.categories.length}</div>
                        </div>
                        <div class="graph-legend">
                            <div style="font-weight: bold; margin-bottom: 8px;">Âõæ‰æã</div>
                            ${generateLegend(graphData.stats.categories)}
                        </div>
                        <div class="graph-tooltip" id="graphTooltip"></div>
                    </div>
                </div>
            `;
            
            // ‰ΩøÁî®D3.jsÊ∏≤ÊüìÂõæË∞±
            renderD3Graph(graphData);
        }
        
        function generateLegend(categories) {
            const colors = d3.schemeCategory10;
            return categories.slice(0, 10).map((cat, i) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors[i]}"></div>
                    <span>${cat}</span>
                </div>
            `).join('');
        }
        
        function renderD3Graph(graphData) {
            const container = document.getElementById('graphContainer');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select('#graphSvg')
                .attr('width', width)
                .attr('height', height);
            
            // Ê∏ÖÁ©∫Â∑≤ÊúâÂÜÖÂÆπ
            svg.selectAll('*').remove();
            
            // ÂàõÂª∫‰∏ªÁîªÂ∏ÉÁªÑ
            const g = svg.append('g');
            
            // Ê∑ªÂä†Áº©ÊîæË°å‰∏∫
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // ÂàõÂª∫ÂäõÂØºÂêëÊ®°Êãü
            graphSimulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links)
                    .id(d => d.id)
                    .distance(80)
                    .strength(0.5))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
            
            // È¢úËâ≤Êò†Â∞Ñ
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            
            // ÁªòÂà∂ËøûÁ∫ø
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('stroke', '#666')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => d.value * 2);
            
            // ÁªòÂà∂ËäÇÁÇπ
            const node = g.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));
            
            // ËäÇÁÇπÂúÜÂúà
            node.append('circle')
                .attr('r', d => Math.sqrt(d.view_count || 1) * 3 + 8)
                .attr('fill', d => colorScale(d.group))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => {
                    event.stopPropagation();
                    showKnowledgeDetail(d.id);
                });
            
            // ËäÇÁÇπÊ†áÁ≠æ
            node.append('text')
                .text(d => d.name.length > 10 ? d.name.substring(0, 10) + '...' : d.name)
                .attr('x', 0)
                .attr('y', 25)
                .attr('text-anchor', 'middle')
                .attr('fill', 'var(--text-secondary)')
                .attr('font-size', '11px')
                .style('pointer-events', 'none');
            
            // Ê®°ÊãüÊõ¥Êñ∞
            graphSimulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            // ÊãñÊãΩÂáΩÊï∞
            function dragStarted(event, d) {
                if (!event.active) graphSimulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragEnded(event, d) {
                if (!event.active) graphSimulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // ÊèêÁ§∫Ê°Ü
            function showTooltip(event, d) {
                const tooltip = document.getElementById('graphTooltip');
                tooltip.style.display = 'block';
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY + 10) + 'px';
                tooltip.innerHTML = `
                    <strong>${d.name}</strong><br>
                    ÂàÜÁ±ª: ${d.group}<br>
                    Á≠âÁ∫ß: ${d.level}<br>
                    ÊµèËßà: ${d.view_count || 0}Ê¨°
                `;
            }
            
            function hideTooltip() {
                const tooltip = document.getElementById('graphTooltip');
                tooltip.style.display = 'none';
            }
            
            // ‰øùÂ≠òÁº©ÊîæÂíåÊ®°ÊãüÂØπË±°‰ª•‰æõÊéßÂà∂ÊåâÈíÆ‰ΩøÁî®
            window.graphZoom = zoom;
            window.graphSvg = svg;
        }
        
        function resetGraphZoom() {
            if (window.graphSvg && window.graphZoom) {
                window.graphSvg.transition()
                    .duration(750)
                    .call(window.graphZoom.transform, d3.zoomIdentity);
            }
        }
        
        function centerGraph() {
            if (graphSimulation) {
                const container = document.getElementById('graphContainer');
                graphSimulation.force('center', 
                    d3.forceCenter(container.clientWidth / 2, container.clientHeight / 2));
                graphSimulation.alpha(0.3).restart();
            }
        }

        // ÂàáÊç¢Èù¢Êùø
        function togglePanel(panel) {
            const panels = {
                'left': document.getElementById('leftPanel'),
                'right': document.getElementById('rightPanel'),
                'bottom': document.getElementById('bottomPanel')
            };
            
            const targetPanel = panels[panel];
            if (targetPanel) {
                // ÂàáÊç¢Èù¢ÊùøcollapsedÁä∂ÊÄÅ
                targetPanel.classList.toggle('collapsed');
                
                // ÂàáÊç¢ÂêéÁöÑÁä∂ÊÄÅ
                const isNowCollapsed = targetPanel.classList.contains('collapsed');
                
                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºöÈù¢ÊùøÊòæÁ§∫Êó∂ÊåâÈíÆactiveÔºåÈù¢ÊùøÈöêËóèÊó∂ÊåâÈíÆ‰∏çactive
                const buttons = document.querySelectorAll('.nav-btn');
                buttons.forEach(btn => {
                    const btnText = btn.textContent.toLowerCase();
                    if ((panel === 'left' && btnText.includes('Êñá‰ª∂Ê†ë')) ||
                        (panel === 'right' && btnText.includes('Âä©Êâã')) ||
                        (panel === 'bottom' && btnText.includes('ÁªàÁ´Ø'))) {
                        if (isNowCollapsed) {
                            btn.classList.remove('active');
                        } else {
                            btn.classList.add('active');
                        }
                    }
                });
                
                console.log(`[UI] ${panel}Èù¢Êùø${isNowCollapsed ? 'Â∑≤ÈöêËóè' : 'Â∑≤ÊòæÁ§∫'}`);
            }
        }

        // ËøêË°å‰ª£Á†Å
        async function runCode() {
            if (!currentCase) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê°à‰æã');
                return;
            }
            
            togglePanel('bottom');  // ÊòæÁ§∫ËæìÂá∫Èù¢Êùø
            document.getElementById('bottomPanel').classList.remove('collapsed');
            
            addOutput('‚ñ∂Ô∏è Ê≠£Âú®ËøêË°å...', 'info');
            
            try {
                const code = editor ? editor.getValue() : null;
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${currentCase}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput('‚úÖ ËøêË°åÊàêÂäüÔºÅ', 'success');
                    if (data.output) {
                        addOutput(data.output, 'info');
                    }
                } else {
                    addOutput('‚ùå ËøêË°åÂ§±Ë¥•', 'error');
                    if (data.stderr) {
                        addOutput(data.stderr, 'error');
                    }
                }
            } catch (error) {
                addOutput(`‚ùå ÈîôËØØ: ${error.message}`, 'error');
            }
        }

        // Ê∑ªÂä†ËæìÂá∫
        function addOutput(text, type = 'info') {
            const output = document.getElementById('outputContent');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        // Ê∏ÖÁ©∫ËæìÂá∫
        function clearOutput() {
            document.getElementById('outputContent').innerHTML = '';
        }

        // ‰øùÂ≠ò‰ª£Á†Å
        function saveCode() {
            alert('üíæ ‰ª£Á†ÅÂ∑≤‰øùÂ≠òÔºàÊ®°ÊãüÔºâ');
        }

        // ÂØπÊØî‰ª£Á†Å
        function compareCode() {
            if (!editor) return;
            const current = editor.getValue();
            if (current === originalCode) {
                alert('‰ª£Á†ÅÊú™‰øÆÊîπ');
                return;
            }
            
            clearOutput();
            document.getElementById('bottomPanel').classList.remove('collapsed');
            addOutput('üîç ‰ª£Á†ÅÂØπÊØî', 'info');
            
            const originalLines = originalCode.split('\n');
            const currentLines = current.split('\n');
            const maxLines = Math.max(originalLines.length, currentLines.length);
            
            let changes = 0;
            for (let i = 0; i < maxLines; i++) {
                const orig = originalLines[i] || '';
                const curr = currentLines[i] || '';
                if (orig !== curr) {
                    changes++;
                    if (orig) addOutput(`- ${orig}`, 'error');
                    if (curr) addOutput(`+ ${curr}`, 'success');
                }
            }
            addOutput(`ÂÖ±ÂèëÁé∞ ${changes} Â§Ñ‰øÆÊîπ`, 'info');
        }

        // ÊòæÁ§∫ÂéÜÂè≤
        function showHistory() {
            alert('üìö ÂéÜÂè≤ËÆ∞ÂΩïÂäüËÉΩÂºÄÂèë‰∏≠');
        }

        // AIËÅäÂ§©
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            sendBtn.disabled = true;
            input.disabled = true;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            const thinkingMsg = addChatMessage('ü§î ÊÄùËÄÉ‰∏≠...', 'assistant');
            
            setTimeout(() => {
                thinkingMsg.remove();
                const response = generateAIResponse(message);
                addChatMessage(response, 'assistant');
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }, 800);
        }

        function addChatMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messagesDiv.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return messageDiv;
        }

        function generateAIResponse(message) {
            const responses = {
                'ÂèÇÊï∞': 'ÊéßÂà∂ÂèÇÊï∞ÁöÑÈÄâÊã©ÈúÄË¶ÅÂπ≥Ë°°ÂìçÂ∫îÈÄüÂ∫¶„ÄÅÁ®≥ÂÆöÊÄßÂíåË∂ÖË∞ÉÈáè„ÄÇÂª∫ËÆÆ‰ªéÂ∞èÂà∞Â§ßÈÄêÊ≠•Ë∞ÉÊï¥„ÄÇ',
                'ÊïàÊûú': 'ËØÑ‰º∞ÊéßÂà∂ÊïàÊûúÈúÄÂÖ≥Ê≥®ÔºöË∂ÖË∞ÉÈáè„ÄÅË∞ÉËäÇÊó∂Èó¥„ÄÅÁ®≥ÊÄÅËØØÂ∑ÆÂíåÊåØËç°Ê¨°Êï∞„ÄÇ',
                '‰ºòÂåñ': 'ÂèÇÊï∞‰ºòÂåñÊµÅÁ®ãÔºö1. Á°ÆÂÆöÊ®°ÂûãÂèÇÊï∞ 2. Ëé∑ÂæóÂàùÂÄº 3. ËßÇÂØüÂìçÂ∫î 4. ÂæÆË∞ÉÂèÇÊï∞ 5. ÈáçÂ§çÁõ¥Âà∞Êª°ÊÑè„ÄÇ'
            };
            
            for (const [key, value] of Object.entries(responses)) {
                if (message.includes(key)) return value;
            }
            
            return 'ÊàëÂèØ‰ª•Â∏Æ‰Ω†ÂàÜÊûê‰ª£Á†ÅÂíå‰ºòÂåñÂèÇÊï∞„ÄÇËØïËØïÈóÆÊàëÂÖ≥‰∫é"ÂèÇÊï∞"„ÄÅ"ÊïàÊûú"Êàñ"‰ºòÂåñ"ÁöÑÈóÆÈ¢òÔºÅ';
        }

        // ÊòæÁ§∫Ê¨¢ËøéÈ°µ
        function showWelcomePage() {
            const docContent = document.getElementById('docContent');
            docContent.innerHTML = `
                <div class="welcome-page">
                    <div class="welcome-icon">üéì</div>
                    <div class="welcome-title">Ê∞¥Á≥ªÁªüÊéßÂà∂ÁêÜËÆ∫ÊïôÁ®ã</div>
                    <div class="welcome-subtitle">Áªü‰∏ÄÊô∫ËÉΩÂ≠¶‰π†Âπ≥Âè∞ - ÊñáÊ°£ÊµèËßà‰∏éAIÁºñÁ®ãIDE</div>
                    
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">üìÅ</div>
                            <div class="feature-title">Ê†ëÁä∂Êñá‰ª∂ÁÆ°ÁêÜ</div>
                            <div class="feature-desc">Â∑¶‰æßÂèØÂ±ïÂºÄ/Êî∂Ëµ∑ÁöÑÊ°à‰æãÊµèËßàÂô®</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üìö</div>
                            <div class="feature-title">ÊñáÊ°£ËßÜÂõæ</div>
                            <div class="feature-desc">Êü•ÁúãÊ°à‰æãËØ¥ÊòéÂíåÁªìÊûúÂõæË°®</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üíª</div>
                            <div class="feature-title">IDEËßÜÂõæ</div>
                            <div class="feature-desc">Âú®Á∫øÁºñËæëÂíåËøêË°åPython‰ª£Á†Å</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ü§ñ</div>
                            <div class="feature-title">AIÂä©Êâã</div>
                            <div class="feature-desc">Êô∫ËÉΩÂàÜÊûêÂíåÂèÇÊï∞‰ºòÂåñÂª∫ËÆÆ</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #252526; border-radius: 8px; border: 1px solid #3e3e42;">
                        <div style="font-size: 14px; color: #888; margin-bottom: 10px;">üí° Âø´Êç∑ÈîÆÊèêÁ§∫</div>
                        <div style="font-size: 13px; color: #aaa; line-height: 2;">
                            <strong>Ctrl+B</strong> - ÂàáÊç¢Êñá‰ª∂Ê†ë &nbsp;|&nbsp;
                            <strong>Ctrl+J</strong> - ÂàáÊç¢AIÂä©Êâã &nbsp;|&nbsp;
                            <strong>Ctrl+\`</strong> - ÂàáÊç¢ÁªàÁ´Ø &nbsp;|&nbsp;
                            <strong>Ctrl+Enter</strong> - ËøêË°å‰ª£Á†Å
                        </div>
                    </div>
                </div>
            `;
        }

        // ÂàùÂßãÂåñÊãñÊãΩË∞ÉÊï¥Â§ßÂ∞è
        function initResizeHandles() {
            let isResizing = false;
            let currentHandle = null;
            let startX = 0;
            let startY = 0;
            let startWidth = 0;
            let startHeight = 0;

            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    currentHandle = handle;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    const panel = handle.closest('.resizable-panel');
                    if (handle.classList.contains('vertical')) {
                        startWidth = panel.offsetWidth;
                    } else {
                        startHeight = panel.offsetHeight;
                    }
                    
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const panel = currentHandle.closest('.resizable-panel');
                
                if (currentHandle.classList.contains('vertical')) {
                    const delta = e.clientX - startX;
                    const isRightPanel = panel.classList.contains('right-panel');
                    const newWidth = isRightPanel ? startWidth - delta : startWidth + delta;
                    panel.style.width = Math.max(200, Math.min(600, newWidth)) + 'px';
                } else {
                    const delta = e.clientY - startY;
                    const newHeight = startHeight - delta;
                    panel.style.height = Math.max(100, Math.min(600, newHeight)) + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                currentHandle = null;
            });
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    togglePanel('left');
                } else if (e.ctrlKey && e.key === 'j') {
                    e.preventDefault();
                    togglePanel('right');
                } else if (e.ctrlKey && e.key === '`') {
                    e.preventDefault();
                    togglePanel('bottom');
                } else if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    if (currentView === 'ide') runCode();
                }
            });
        }

        // ÂàùÂßãÂåñÈù¢ÊùøÁä∂ÊÄÅ
        function initPanelStates() {
            // Ê†πÊçÆÈù¢ÊùøÁöÑÂàùÂßãcollapsedÁä∂ÊÄÅËÆæÁΩÆÊåâÈíÆÁöÑactiveÁä∂ÊÄÅ
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const bottomPanel = document.getElementById('bottomPanel');
            
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                
                // Êñá‰ª∂Ê†ëÊåâÈíÆ - Â∑¶‰æßÈù¢ÊùøÈªòËÆ§ÊòæÁ§∫
                if (btnText.includes('Êñá‰ª∂Ê†ë')) {
                    if (!leftPanel.classList.contains('collapsed')) {
                        btn.classList.add('active');
                    }
                }
                
                // AIÂä©ÊâãÊåâÈíÆ - Âè≥‰æßÈù¢ÊùøÈªòËÆ§ÈöêËóè
                if (btnText.includes('Âä©Êâã')) {
                    if (!rightPanel.classList.contains('collapsed')) {
                        btn.classList.add('active');
                    }
                }
                
                // ÁªàÁ´ØÊåâÈíÆ - Â∫ïÈÉ®Èù¢ÊùøÈªòËÆ§ÈöêËóè
                if (btnText.includes('ÁªàÁ´Ø')) {
                    if (!bottomPanel.classList.contains('collapsed')) {
                        btn.classList.add('active');
                    }
                }
            });
            
            console.log('[UI] Èù¢ÊùøÂàùÂßãÁä∂ÊÄÅÂ∑≤ËÆæÁΩÆ');
        }

        // ==================== Áî®Êà∑‰ΩìÈ™å‰ºòÂåñÂäüËÉΩ ====================
        
        // LoadingÂä®Áîª
        function showLoading(container, message = 'Âä†ËΩΩ‰∏≠...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">${message}</div>
                </div>
            `;
            container.appendChild(overlay);
            return overlay;
        }

        function hideLoading(overlay) {
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // ÂèãÂ•ΩÈîôËØØÊèêÁ§∫
        function showFriendlyError(message, details) {
            const errorBox = document.createElement('div');
            errorBox.className = 'friendly-error';
            errorBox.innerHTML = `
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-title">${message}</div>
                <div class="error-details">${details}</div>
                <button class="error-close">Áü•ÈÅì‰∫Ü</button>
            `;
            
            errorBox.querySelector('.error-close').addEventListener('click', () => {
                errorBox.remove();
            });
            
            document.body.appendChild(errorBox);
            
            // 5ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                if (errorBox.parentElement) {
                    errorBox.remove();
                }
            }, 5000);
        }

        // ÊàêÂäüÊèêÁ§∫
        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <div class="success-icon">‚úÖ</div>
                <div class="success-message">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // ÂõæÁâáÈ¢ÑËßà
        function showImagePreview(src, alt) {
            const preview = document.createElement('div');
            preview.className = 'image-preview-overlay';
            preview.innerHTML = `
                <div class="preview-container">
                    <button class="preview-close">‚úï</button>
                    <img src="${src}" alt="${alt}" class="preview-image">
                    <div class="preview-caption">${alt || 'ÂõæÁâáÈ¢ÑËßà'}</div>
                </div>
            `;
            
            // ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            preview.querySelector('.preview-close').addEventListener('click', (e) => {
                e.stopPropagation();
                preview.remove();
            });
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            preview.addEventListener('click', (e) => {
                if (e.target === preview) {
                    preview.remove();
                }
            });
            
            // ESCÈîÆÂÖ≥Èó≠
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    preview.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            document.body.appendChild(preview);
        }

        // ‰∏∫ÊñáÊ°£‰∏≠ÁöÑÂõæÁâáÊ∑ªÂä†ÁÇπÂáªÈ¢ÑËßà
        function initImagePreview() {
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG' && e.target.closest('.readme-content')) {
                    const src = e.target.src;
                    const alt = e.target.alt;
                    showImagePreview(src, alt);
                }
            });
        }

        // ==================== ‰∏ªÈ¢òÁ≥ªÁªü ====================
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme, false);
        }

        // ÂàáÊç¢‰∏ªÈ¢òËèúÂçï
        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            menu.classList.toggle('show');
        }

        // ËÆæÁΩÆ‰∏ªÈ¢ò
        function setTheme(theme, save = true) {
            document.body.setAttribute('data-theme', theme);
            
            // ‰øùÂ≠òÂà∞localStorage
            if (save) {
                localStorage.setItem('theme', theme);
            }
            
            // Êõ¥Êñ∞ËèúÂçïÈÄâ‰∏≠Áä∂ÊÄÅ
            updateThemeMenu(theme);
            
            // Êõ¥Êñ∞MonacoÁºñËæëÂô®‰∏ªÈ¢ò
            if (editor) {
                const monacoTheme = theme === 'light' ? 'vs' : 'vs-dark';
                monaco.editor.setTheme(monacoTheme);
            }
            
            // ÂÖ≥Èó≠ËèúÂçï
            const menu = document.getElementById('themeMenu');
            if (menu) {
                menu.classList.remove('show');
            }
        }

        // Êõ¥Êñ∞‰∏ªÈ¢òËèúÂçïÈÄâ‰∏≠Áä∂ÊÄÅ
        function updateThemeMenu(theme) {
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const themeMap = {
                'light': 0,
                'dark': 1,
                'auto': 2
            };
            
            const options = document.querySelectorAll('.theme-option');
            const index = themeMap[theme];
            if (options[index]) {
                options[index].classList.add('active');
            }
        }

        // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñÔºàautoÊ®°ÂºèÔºâ
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'auto') {
                    // Ëß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
                    document.body.setAttribute('data-theme', 'auto');
                }
            });
        }
    </script>
    
    <!-- MarkdownÊ∏≤ÊüìÂ∫ì - ÊîæÂú®ÊúÄÂêéÁ°Æ‰øùDOMÂä†ËΩΩÂÆåÊàê -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js">        // ========== ÊïôÊùêÈòÖËØªÂô®ÂäüËÉΩ ==========
        
        let currentTextbookId = null;
        let currentChapterId = null;
        let allTextbooks = [];
        let currentChapters = [];
        
        async function loadTextbooks() {
            try {
                const response = await fetch('/api/textbooks/');
                const data = await response.json();
                
                if (data.success) {
                    allTextbooks = data.textbooks;
                    displayTextbooksList(allTextbooks);
                    updateTextbookStats();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊïôÊùêÂ§±Ë¥•:', error);
            }
        }
        
        function displayTextbooksList(textbooks) {
            const list = document.getElementById('textbooks-list');
            if (!textbooks || textbooks.length === 0) {
                list.innerHTML = '<p style="padding: 20px; text-align: center;">ÊöÇÊó†ÊïôÊùê</p>';
                return;
            }
            
            list.innerHTML = textbooks.map(book => `
                <div class="textbook-card" onclick="selectTextbook('${book.id}')">
                    <h4>${book.title}</h4>
                    ${book.subtitle ? `<p class="textbook-subtitle">${book.subtitle}</p>` : ''}
                    <div class="textbook-meta">
                        <span>üìñ ${book.total_chapters} Á´†</span>
                        <span>üìù ${book.total_words.toLocaleString()} Â≠ó</span>
                    </div>
                    ${book.target_audience ? `<div class="textbook-audience">üë• ${book.target_audience}</div>` : ''}
                </div>
            `).join('');
        }
        
        async function selectTextbook(textbookId) {
            currentTextbookId = textbookId;
            
            try {
                // Âä†ËΩΩÊïôÊùêËØ¶ÊÉÖ
                const response = await fetch(`/api/textbooks/${textbookId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('current-textbook-title').textContent = data.textbook.title;
                    
                    // Âä†ËΩΩÁ´†ËäÇÊ†ë
                    await loadChapterTree(textbookId);
                    
                    // ÂàáÊç¢ËßÜÂõæ
                    document.getElementById('textbooks-list').style.display = 'none';
                    document.getElementById('chapter-tree').style.display = 'block';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊïôÊùêÂ§±Ë¥•:', error);
            }
        }
        
        async function loadChapterTree(textbookId) {
            try {
                const response = await fetch(`/api/textbooks/${textbookId}/chapters/tree`);
                const data = await response.json();
                
                if (data.success) {
                    currentChapters = data.chapters_tree;
                    displayChapterTree(data.chapters_tree);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ´†ËäÇÊ†ëÂ§±Ë¥•:', error);
            }
        }
        
        function displayChapterTree(chapters) {
            const container = document.getElementById('chapter-tree-content');
            container.innerHTML = renderChapterTreeNodes(chapters);
        }
        
        function renderChapterTreeNodes(chapters, level = 0) {
            return chapters.map(chapter => `
                <div class="tree-node" style="padding-left: ${level * 20 + 10}px;" onclick="selectChapter('${chapter.id}', event)">
                    <span class="tree-icon">${chapter.children && chapter.children.length > 0 ? 'üìÅ' : 'üìÑ'}</span>
                    <span class="tree-label">[${chapter.chapter_number}] ${chapter.title}</span>
                </div>
                ${chapter.children && chapter.children.length > 0 ? renderChapterTreeNodes(chapter.children, level + 1) : ''}
            `).join('');
        }
        
        async function selectChapter(chapterId, event) {
            event.stopPropagation();
            currentChapterId = chapterId;
            
            // È´ò‰∫ÆÂΩìÂâçÁ´†ËäÇ
            document.querySelectorAll('.tree-node').forEach(node => node.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            try {
                const response = await fetch(`/api/textbooks/chapter/${chapterId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayChapterContent(data.chapter);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ´†ËäÇÂ§±Ë¥•:', error);
            }
        }
        
        function displayChapterContent(chapter) {
            // ÈöêËóèÊ¨¢ËøéÈ°µÔºåÊòæÁ§∫ÂÜÖÂÆπ
            document.getElementById('textbook-welcome').style.display = 'none';
            document.getElementById('chapter-content').style.display = 'block';
            
            // Èù¢ÂåÖÂ±ë
            document.getElementById('chapter-breadcrumb').innerHTML = `
                ${chapter.textbook_title || ''} / [${chapter.chapter_number}] ${chapter.title}
            `;
            
            // Ê∏≤ÊüìMarkdownÂÜÖÂÆπ
            const body = document.getElementById('chapter-body');
            body.innerHTML = marked.parse(chapter.content || '');
            
            // ÊòæÁ§∫Áõ∏ÂÖ≥Ê°à‰æã
            if (chapter.associated_cases && chapter.associated_cases.length > 0) {
                document.getElementById('related-cases').innerHTML = chapter.associated_cases.map(c => `
                    <div class="related-item" onclick="loadCase('${c.case_id}')">
                        <span>${c.title}</span>
                        <span class="relevance-badge">${(c.relevance_score * 100).toFixed(0)}%</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('related-cases').innerHTML = '<p style="color: #888;">ÊöÇÊó†Áõ∏ÂÖ≥Ê°à‰æã</p>';
            }
            
            // ÊòæÁ§∫Áõ∏ÂÖ≥Áü•ËØÜÁÇπ
            if (chapter.linked_knowledge && chapter.linked_knowledge.length > 0) {
                document.getElementById('related-knowledge').innerHTML = chapter.linked_knowledge.map(k => `
                    <div class="related-item" onclick="showKnowledgeDetail('${k.knowledge_id}')">
                        <span>${k.title}</span>
                        <span class="category-badge">${k.category}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('related-knowledge').innerHTML = '<p style="color: #888;">ÊöÇÊó†Áõ∏ÂÖ≥Áü•ËØÜÁÇπ</p>';
            }
        }
        
        function backToTextbooksList() {
            document.getElementById('textbooks-list').style.display = 'block';
            document.getElementById('chapter-tree').style.display = 'none';
            document.getElementById('textbook-welcome').style.display = 'block';
            document.getElementById('chapter-content').style.display = 'none';
        }
        
        function searchTextbooks(event) {
            const query = event.target.value.toLowerCase();
            if (!query) {
                displayTextbooksList(allTextbooks);
                return;
            }
            
            const filtered = allTextbooks.filter(book => 
                book.title.toLowerCase().includes(query) ||
                (book.description && book.description.toLowerCase().includes(query))
            );
            displayTextbooksList(filtered);
        }
        
        async function updateTextbookStats() {
            try {
                const response = await fetch('/api/search/stats');
                const data = await response.json();
                
                document.getElementById('total-textbooks').textContent = data.textbooks.total;
                document.getElementById('total-chapters').textContent = data.textbooks.chapters;
                document.getElementById('total-words').textContent = (data.textbooks.total_words || 0).toLocaleString();
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°Â§±Ë¥•:', error);
            }
        }
        
        // ========== Áªü‰∏ÄÊêúÁ¥¢ÂäüËÉΩ ==========
        
        async function unifiedSearch(event) {
            if (event.key === 'Enter') {
                doUnifiedSearch();
            }
        }
        
        async function doUnifiedSearch() {
            const query = document.getElementById('unified-search-input').value.trim();
            if (!query) return;
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÁ±ªÂûã
            const types = [];
            if (document.getElementById('filter-textbook').checked) types.push('textbook');
            if (document.getElementById('filter-case').checked) types.push('case');
            if (document.getElementById('filter-knowledge').checked) types.push('knowledge');
            
            if (types.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçÊêúÁ¥¢Á±ªÂûã');
                return;
            }
            
            try {
                const response = await fetch(`/api/search/?query=${encodeURIComponent(query)}&types=${types.join(',')}&limit=20`);
                const data = await response.json();
                
                displayUnifiedSearchResults(data);
            } catch (error) {
                console.error('ÊêúÁ¥¢Â§±Ë¥•:', error);
                document.getElementById('search-results').innerHTML = '<p style="color: red;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï</p>';
            }
        }
        
        function displayUnifiedSearchResults(data) {
            const container = document.getElementById('search-results');
            
            if (!data.results || data.results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú</h3>
                        <p>Â∞ùËØïÔºö</p>
                        <ul>
                            ${data.suggestions && data.suggestions.length > 0 ? data.suggestions.map(s => `<li>${s}</li>`).join('') : '<li>‰ΩøÁî®Êõ¥ÈÄöÁî®ÁöÑÂÖ≥ÈîÆËØç</li>'}
                        </ul>
                    </div>
                `;
                return;
            }
            
            // ÊåâÁ±ªÂûãÂàÜÁªÑÊòæÁ§∫
            const byType = {
                textbook: data.results.filter(r => r.type === 'textbook'),
                case: data.results.filter(r => r.type === 'case'),
                knowledge: data.results.filter(r => r.type === 'knowledge')
            };
            
            container.innerHTML = `
                <div class="search-summary">
                    ÊâæÂà∞ <strong>${data.total_results}</strong> ‰∏™ÁªìÊûú
                    ${data.results_by_type.textbook ? ` | üìñ ÊïôÊùê: ${data.results_by_type.textbook}` : ''}
                    ${data.results_by_type.case ? ` | üíª Ê°à‰æã: ${data.results_by_type.case}` : ''}
                    ${data.results_by_type.knowledge ? ` | üß† Áü•ËØÜÂ∫ì: ${data.results_by_type.knowledge}` : ''}
                </div>
                
                ${byType.textbook.length > 0 ? `
                    <div class="search-section">
                        <h3>üìñ ÊïôÊùê (${byType.textbook.length})</h3>
                        ${byType.textbook.map(r => renderSearchResult(r)).join('')}
                    </div>
                ` : ''}
                
                ${byType.case.length > 0 ? `
                    <div class="search-section">
                        <h3>üíª Ê°à‰æã (${byType.case.length})</h3>
                        ${byType.case.map(r => renderSearchResult(r)).join('')}
                    </div>
                ` : ''}
                
                ${byType.knowledge.length > 0 ? `
                    <div class="search-section">
                        <h3>üß† Áü•ËØÜÂ∫ì (${byType.knowledge.length})</h3>
                        ${byType.knowledge.map(r => renderSearchResult(r)).join('')}
                    </div>
                ` : ''}
            `;
        }
        
        function renderSearchResult(result) {
            const typeIcon = {
                'textbook': 'üìñ',
                'case': 'üíª',
                'knowledge': 'üß†'
            };
            
            return `
                <div class="search-result-card" onclick="openSearchResult('${result.type}', '${result.id}')">
                    <div class="result-header">
                        <span class="result-type">${typeIcon[result.type]}</span>
                        <h4>${result.title}</h4>
                        <span class="relevance-score">${(result.relevance_score * 100).toFixed(0)}%</span>
                    </div>
                    <p class="result-description">${result.description}</p>
                    ${result.preview ? `<p class="result-preview">${result.preview}</p>` : ''}
                    <div class="result-meta">
                        <span>Êù•Ê∫ê: ${result.source}</span>
                    </div>
                </div>
            `;
        }
        
        function openSearchResult(type, id) {
            if (type === 'textbook') {
                // ÂàáÊç¢Âà∞ÊïôÊùêËßÜÂõæÂπ∂ÊâìÂºÄÁ´†ËäÇ
                showView('textbooks');
                selectChapter(id, {stopPropagation: () => {}, currentTarget: document.createElement('div')});
            } else if (type === 'case') {
                // ÂàáÊç¢Âà∞Ê°à‰æãËßÜÂõæ
                showView('cases');
                loadCase(id);
            } else if (type === 'knowledge') {
                // ÂàáÊç¢Âà∞Áü•ËØÜÂ∫ìËßÜÂõæ
                showView('knowledge');
                showKnowledgeDetail(id);
            }
        }
        
        // ÂàùÂßãÂåñÊó∂Âä†ËΩΩÊïôÊùê
        if (document.getElementById('textbooks-view')) {
            loadTextbooks();
        }

    </script>
</body>
</html>

