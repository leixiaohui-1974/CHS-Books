<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´ç³»ç»Ÿæ§åˆ¶ç†è®ºæ•™ç¨‹ - ç»Ÿä¸€æ™ºèƒ½å¹³å°</title>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    
    <!-- Markdownæ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            height: 50px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: #37373d;
        }

        .nav-tab.active {
            background: #007acc;
            color: white;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #37373d;
            border-color: #007acc;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
            position: relative;
        }

        /* å¯ä¼¸ç¼©ä¾§è¾¹æ  */
        .resizable-panel {
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, margin-left 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .resizable-panel.collapsed {
            width: 0 !important;
            margin-left: -1px;
            border-right: none;
        }

        /* å·¦ä¾§é¢æ¿ - æ–‡ä»¶æ ‘ */
        .left-panel {
            width: 300px;
            min-width: 200px;
            max-width: 600px;
        }

        /* å³ä¾§é¢æ¿ - AIåŠ©æ‰‹ */
        .right-panel {
            width: 350px;
            min-width: 250px;
            max-width: 600px;
            border-right: none;
            border-left: 1px solid #3e3e42;
            order: 3;
        }

        /* åº•éƒ¨é¢æ¿ - è¾“å‡º/ç»ˆç«¯ */
        .bottom-panel {
            width: 100%;
            height: 250px;
            min-height: 100px;
            max-height: 600px;
            border-right: none;
            border-top: 1px solid #3e3e42;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: height 0.3s ease, margin-bottom 0.3s ease;
            z-index: 10;
        }

        .bottom-panel.collapsed {
            height: 0 !important;
            margin-bottom: -1px;
            border-top: none;
        }

        /* é¢æ¿å¤´éƒ¨ */
        .panel-header {
            height: 35px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: #cccccc;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-actions {
            display: flex;
            gap: 5px;
        }

        .panel-action-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            border-radius: 3px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-action-btn:hover {
            background: #37373d;
        }

        /* é¢æ¿å†…å®¹ */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* æ‹–æ‹½æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 100;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: #007acc;
        }

        .resize-handle.vertical {
            width: 4px;
            height: 100%;
            right: -2px;
            top: 0;
            cursor: ew-resize;
        }

        .resize-handle.horizontal {
            width: 100%;
            height: 4px;
            top: -2px;
            left: 0;
            cursor: ns-resize;
        }

        /* ä¸­å¤®å†…å®¹åŒº */
        .center-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å†…å®¹è§†å›¾å®¹å™¨ */
        .content-view {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* æ–‡æ¡£è§†å›¾ */
        .doc-view {
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            background: #1e1e1e;
            display: none;
        }

        .doc-view.active {
            display: block;
        }

        /* IDEè§†å›¾ */
        .ide-view {
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .ide-view.active {
            display: flex;
        }

        /* æ ‘èŠ‚ç‚¹æ ·å¼ */
        .tree-node {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .tree-node:hover {
            background: #2a2d2e;
        }

        .tree-node.active {
            background: #37373d;
            color: #fff;
        }

        .tree-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .tree-label {
            flex: 1;
            font-size: 13px;
        }

        .tree-badge {
            padding: 2px 6px;
            background: #007acc;
            border-radius: 10px;
            font-size: 10px;
            color: white;
        }

        .tree-group {
            margin-bottom: 15px;
        }

        .tree-group-header {
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* READMEå†…å®¹æ ·å¼ */
        .readme-content {
            background: #252526;
            padding: 30px;
            border-radius: 8px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .readme-content h1 {
            font-size: 28px;
            margin: 25px 0 15px 0;
            color: #fff;
            border-bottom: 2px solid #007acc;
            padding-bottom: 8px;
        }

        .readme-content h2 {
            font-size: 22px;
            margin: 20px 0 12px 0;
            color: #4ec9b0;
        }

        .readme-content h3 {
            font-size: 18px;
            margin: 18px 0 10px 0;
            color: #dcdcaa;
        }

        .readme-content p {
            line-height: 1.8;
            margin-bottom: 15px;
            color: #d4d4d4;
        }

        .readme-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .readme-content table td {
            padding: 15px;
            vertical-align: top;
            border: 1px solid #3e3e42;
        }

        .readme-content table img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 6px;
        }

        .readme-content code {
            background: #1e1e1e;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #ce9178;
        }

        .readme-content pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #3e3e42;
        }

        .readme-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .readme-content ul, .readme-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        .readme-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        /* ç¼–è¾‘å™¨å·¥å…·æ  */
        .editor-toolbar {
            height: 40px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            flex-shrink: 0;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: #0e639c;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar-btn:hover {
            background: #1177bb;
        }

        .toolbar-btn.secondary {
            background: #3e3e42;
        }

        .toolbar-btn.secondary:hover {
            background: #505050;
        }

        /* ç¼–è¾‘å™¨å®¹å™¨ */
        #editor {
            flex: 1;
            overflow: hidden;
        }

        /* AIèŠå¤© */
        .ai-chat {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 90%;
            line-height: 1.5;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            margin-left: auto;
            color: white;
        }

        .chat-message.assistant {
            background: #2d2d30;
            margin-right: auto;
            border: 1px solid #3e3e42;
        }

        .chat-input-area {
            position: sticky;
            bottom: 0;
            display: flex;
            gap: 8px;
            padding: 12px;
            background: #252526;
            border-top: 1px solid #3e3e42;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #d4d4d4;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .send-btn {
            padding: 10px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .send-btn:hover {
            background: #1177bb;
        }

        .send-btn:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }

        /* è¾“å‡ºé¢æ¿ */
        .output-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .output-line {
            padding: 2px 0;
        }

        .output-line.info {
            color: #4fc1ff;
        }

        .output-line.success {
            color: #4ec9b0;
        }

        .output-line.error {
            color: #f48771;
        }

        .output-line.warning {
            color: #dcdcaa;
        }

        /* æ¬¢è¿é¡µ */
        .welcome-page {
            max-width: 900px;
            margin: 50px auto;
            text-align: center;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #007acc 0%, #4ec9b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #888;
            margin-bottom: 40px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: #252526;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: #007acc;
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .feature-desc {
            font-size: 13px;
            color: #888;
            line-height: 1.5;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* å¿«æ·é”®æç¤º */
        .shortcut-hint {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-nav">
        <div class="nav-left">
            <div class="nav-title">
                ğŸ“ æ°´ç³»ç»Ÿæ§åˆ¶ç†è®ºæ•™ç¨‹
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="doc" onclick="switchView('doc')">
                    ğŸ“š æ–‡æ¡£
                </button>
                <button class="nav-tab" data-view="ide" onclick="switchView('ide')">
                    ğŸ’» ç¼–ç¨‹IDE
                </button>
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="togglePanel('left')">
                ğŸ“ æ–‡ä»¶æ ‘ <span class="shortcut-hint">Ctrl+B</span>
            </button>
            <button class="nav-btn" onclick="togglePanel('right')">
                ğŸ¤– AIåŠ©æ‰‹ <span class="shortcut-hint">Ctrl+J</span>
            </button>
            <button class="nav-btn" onclick="togglePanel('bottom')">
                ğŸ“Ÿ ç»ˆç«¯ <span class="shortcut-hint">Ctrl+`</span>
            </button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ - æ–‡ä»¶æ ‘ -->
        <div class="resizable-panel left-panel" id="leftPanel">
            <div class="panel-header">
                <div class="panel-title">ğŸ“ æ¡ˆä¾‹æµè§ˆå™¨</div>
                <div class="panel-actions">
                    <button class="panel-action-btn" onclick="togglePanel('left')" title="éšè—">âœ•</button>
                </div>
            </div>
            <div class="panel-content" id="treeContainer">
                <!-- æ ‘èŠ‚ç‚¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="resize-handle vertical" data-panel="left"></div>
        </div>

        <!-- ä¸­å¤®å†…å®¹åŒº -->
        <div class="center-area">
            <!-- æ–‡æ¡£è§†å›¾ -->
            <div class="content-view doc-view active" id="docView">
                <div id="docContent">
                    <!-- æ–‡æ¡£å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- IDEè§†å›¾ -->
            <div class="content-view ide-view" id="ideView">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="runCode()">â–¶ï¸ è¿è¡Œ</button>
                    <button class="toolbar-btn secondary" onclick="saveCode()">ğŸ’¾ ä¿å­˜</button>
                    <button class="toolbar-btn secondary" onclick="compareCode()">ğŸ” å¯¹æ¯”</button>
                    <button class="toolbar-btn secondary" onclick="showHistory()">ğŸ“š å†å²</button>
                </div>
                <div id="editor"></div>
            </div>

            <!-- åº•éƒ¨é¢æ¿ - è¾“å‡º/ç»ˆç«¯ -->
            <div class="resizable-panel bottom-panel collapsed" id="bottomPanel">
                <div class="resize-handle horizontal" data-panel="bottom"></div>
                <div class="panel-header">
                    <div class="panel-title">ğŸ“Ÿ è¾“å‡º</div>
                    <div class="panel-actions">
                        <button class="panel-action-btn" onclick="clearOutput()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
                        <button class="panel-action-btn" onclick="togglePanel('bottom')" title="éšè—">âœ•</button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="output-content" id="outputContent">
                        <div class="output-line info">å‡†å¤‡å°±ç»ª...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ - AIåŠ©æ‰‹ -->
        <div class="resizable-panel right-panel collapsed" id="rightPanel">
            <div class="panel-header">
                <div class="panel-title">ğŸ¤– AIç¼–ç¨‹åŠ©æ‰‹</div>
                <div class="panel-actions">
                    <button class="panel-action-btn" onclick="togglePanel('right')" title="éšè—">âœ•</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="ai-chat">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant">
                            ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯AIç¼–ç¨‹åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ ï¼š<br>
                            â€¢ åˆ†æä»£ç å’Œå‚æ•°<br>
                            â€¢ æä¾›ä¼˜åŒ–å»ºè®®<br>
                            â€¢ è§£ç­”æ§åˆ¶ç†è®ºé—®é¢˜
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥é—®é¢˜..." rows="2"></textarea>
                        <button class="send-btn" id="sendChatBtn" onclick="sendChat()">å‘é€</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle vertical" data-panel="right"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let allCases = [];
        let currentCase = null;
        let currentView = 'doc';
        let editor = null;
        let originalCode = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadCases();
            showWelcomePage();
            initResizeHandles();
            initKeyboardShortcuts();
            
            // èŠå¤©è¾“å…¥å›è½¦å‘é€
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChat();
                }
            });
        });

        // åŠ è½½æ¡ˆä¾‹åˆ—è¡¨
        async function loadCases() {
            try {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases`);
                const data = await response.json();
                
                if (data.success && data.cases) {
                    allCases = data.cases.map((c, index) => ({
                        ...c,
                        category: c.category || getCategoryByIndex(index + 1),
                        displayName: c.title || c.name
                    }));
                    renderTree(allCases);
                }
            } catch (error) {
                console.error('åŠ è½½æ¡ˆä¾‹å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æ ‘
        function renderTree(cases) {
            const container = document.getElementById('treeContainer');
            
            const groups = {
                'åŸºç¡€æ§åˆ¶': cases.filter(c => c.category === 'åŸºç¡€æ§åˆ¶'),
                'é«˜çº§æ§åˆ¶': cases.filter(c => c.category === 'é«˜çº§æ§åˆ¶'),
                'æ™ºèƒ½æ§åˆ¶': cases.filter(c => c.category === 'æ™ºèƒ½æ§åˆ¶')
            };
            
            let html = '';
            for (const [groupName, groupCases] of Object.entries(groups)) {
                if (groupCases.length > 0) {
                    html += `<div class="tree-group">`;
                    html += `<div class="tree-group-header">${groupName}</div>`;
                    groupCases.forEach(c => {
                        const icon = getIconForCase(c.id);
                        html += `
                            <div class="tree-node" data-case-id="${c.id}">
                                <span class="tree-icon">${icon}</span>
                                <span class="tree-label">${c.displayName}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            }
            container.innerHTML = html;
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.tree-node').forEach(node => {
                node.addEventListener('click', () => {
                    const caseId = node.dataset.caseId;
                    loadCase(caseId, node);
                });
            });
        }

        function getCategoryByIndex(index) {
            if (index <= 4) return 'åŸºç¡€æ§åˆ¶';
            if (index <= 10) return 'é«˜çº§æ§åˆ¶';
            return 'æ™ºèƒ½æ§åˆ¶';
        }

        function getIconForCase(caseId) {
            const icons = {
                'case_01': 'ğŸ’§', 'case_02': 'ğŸ­', 'case_03': 'ğŸš°', 'case_04': 'âš™ï¸',
                'case_05': 'ğŸ”', 'case_06': 'ğŸ“Š', 'case_07': 'ğŸ”—', 'case_08': 'â¡ï¸',
                'case_09': 'ğŸ“', 'case_10': 'ğŸ“ˆ', 'case_11': 'ğŸ¯', 'case_12': 'ğŸ‘ï¸',
                'case_13': 'ğŸ”„', 'case_14': 'ğŸ®', 'case_15': 'ğŸ›¡ï¸', 'case_16': 'ğŸ§ ',
                'case_17': 'ğŸ¤–', 'case_18': 'ğŸ²', 'case_19': 'ğŸ“‹', 'case_20': 'ğŸš€'
            };
            for (const key in icons) {
                if (caseId.includes(key)) return icons[key];
            }
            return 'ğŸ“„';
        }

        // åŠ è½½æ¡ˆä¾‹
        async function loadCase(caseId, treeNode) {
            currentCase = caseId;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
            if (treeNode) treeNode.classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${caseId}`);
                const data = await response.json();
                
                if (data.success && data.case) {
                    if (currentView === 'doc') {
                        showDocumentation(data.case);
                    } else {
                        await loadCodeIntoEditor(data.case);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¡ˆä¾‹å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ–‡æ¡£
        function showDocumentation(caseData) {
            const docContent = document.getElementById('docContent');
            
            if (caseData.readme) {
                let html = '';
                
                // æ£€æŸ¥markedæ˜¯å¦å·²åŠ è½½
                if (typeof marked !== 'undefined') {
                    html = marked.parse(caseData.readme, {
                        breaks: true,
                        gfm: true,
                        sanitize: false
                    });
                } else {
                    // é™çº§ï¼šç®€å•çš„Markdownè½¬æ¢
                    html = convertMarkdownSimple(caseData.readme);
                }
                
                // æ›¿æ¢å›¾ç‰‡è·¯å¾„
                html = html.replace(/src="([^"]+\.png)"/g, (match, filename) => {
                    return `src="${API_BASE}/books/water-system-control/cases/${currentCase}/images/${filename}"`;
                });
                
                docContent.innerHTML = `<div class="readme-content">${html}</div>`;
            } else {
                docContent.innerHTML = '<div class="readme-content"><p>æš‚æ— æ–‡æ¡£å†…å®¹</p></div>';
            }
        }
        
        // ç®€å•çš„Markdownè½¬æ¢ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        function convertMarkdownSimple(markdown) {
            if (!markdown) return '';
            
            return markdown
                // æ ‡é¢˜
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // ç²—ä½“
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // ä»£ç 
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // æ¢è¡Œ
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // åŒ…è£¹æ®µè½
                .replace(/^(.+)$/gim, '<p>$1</p>');
        }

        // åŠ è½½ä»£ç åˆ°ç¼–è¾‘å™¨
        async function loadCodeIntoEditor(caseData) {
            if (!editor) {
                await initMonacoEditor();
            }
            
            if (caseData.code) {
                originalCode = caseData.code;
                editor.setValue(originalCode);
            }
        }

        // åˆå§‹åŒ–Monacoç¼–è¾‘å™¨
        async function initMonacoEditor() {
            return new Promise((resolve) => {
                require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
                require(['vs/editor/editor.main'], function () {
                    editor = monaco.editor.create(document.getElementById('editor'), {
                        value: '# è¯·ä»å·¦ä¾§é€‰æ‹©æ¡ˆä¾‹',
                        language: 'python',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: true },
                        scrollBeyondLastLine: false
                    });
                    resolve();
                });
            });
        }

        // åˆ‡æ¢è§†å›¾
        async function switchView(view) {
            currentView = view;
            
            // æ›´æ–°æ ‡ç­¾
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            // åˆ‡æ¢è§†å›¾
            document.querySelectorAll('.content-view').forEach(v => {
                v.classList.toggle('active', v.id === view + 'View');
            });
            
            // IDEè§†å›¾éœ€è¦åˆå§‹åŒ–ç¼–è¾‘å™¨
            if (view === 'ide' && !editor && currentCase) {
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${currentCase}`);
                const data = await response.json();
                if (data.success) {
                    await loadCodeIntoEditor(data.case);
                }
            }
        }

        // åˆ‡æ¢é¢æ¿
        function togglePanel(panel) {
            const panels = {
                'left': document.getElementById('leftPanel'),
                'right': document.getElementById('rightPanel'),
                'bottom': document.getElementById('bottomPanel')
            };
            
            const targetPanel = panels[panel];
            if (targetPanel) {
                targetPanel.classList.toggle('collapsed');
            }
        }

        // è¿è¡Œä»£ç 
        async function runCode() {
            if (!currentCase) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆä¾‹');
                return;
            }
            
            togglePanel('bottom');  // æ˜¾ç¤ºè¾“å‡ºé¢æ¿
            document.getElementById('bottomPanel').classList.remove('collapsed');
            
            addOutput('â–¶ï¸ æ­£åœ¨è¿è¡Œ...', 'info');
            
            try {
                const code = editor ? editor.getValue() : null;
                const response = await fetch(`${API_BASE}/books/water-system-control/cases/${currentCase}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addOutput('âœ… è¿è¡ŒæˆåŠŸï¼', 'success');
                    if (data.output) {
                        addOutput(data.output, 'info');
                    }
                } else {
                    addOutput('âŒ è¿è¡Œå¤±è´¥', 'error');
                    if (data.stderr) {
                        addOutput(data.stderr, 'error');
                    }
                }
            } catch (error) {
                addOutput(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ è¾“å‡º
        function addOutput(text, type = 'info') {
            const output = document.getElementById('outputContent');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        // æ¸…ç©ºè¾“å‡º
        function clearOutput() {
            document.getElementById('outputContent').innerHTML = '';
        }

        // ä¿å­˜ä»£ç 
        function saveCode() {
            alert('ğŸ’¾ ä»£ç å·²ä¿å­˜ï¼ˆæ¨¡æ‹Ÿï¼‰');
        }

        // å¯¹æ¯”ä»£ç 
        function compareCode() {
            if (!editor) return;
            const current = editor.getValue();
            if (current === originalCode) {
                alert('ä»£ç æœªä¿®æ”¹');
                return;
            }
            
            clearOutput();
            document.getElementById('bottomPanel').classList.remove('collapsed');
            addOutput('ğŸ” ä»£ç å¯¹æ¯”', 'info');
            
            const originalLines = originalCode.split('\n');
            const currentLines = current.split('\n');
            const maxLines = Math.max(originalLines.length, currentLines.length);
            
            let changes = 0;
            for (let i = 0; i < maxLines; i++) {
                const orig = originalLines[i] || '';
                const curr = currentLines[i] || '';
                if (orig !== curr) {
                    changes++;
                    if (orig) addOutput(`- ${orig}`, 'error');
                    if (curr) addOutput(`+ ${curr}`, 'success');
                }
            }
            addOutput(`å…±å‘ç° ${changes} å¤„ä¿®æ”¹`, 'info');
        }

        // æ˜¾ç¤ºå†å²
        function showHistory() {
            alert('ğŸ“š å†å²è®°å½•åŠŸèƒ½å¼€å‘ä¸­');
        }

        // AIèŠå¤©
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendChatBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            sendBtn.disabled = true;
            input.disabled = true;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            const thinkingMsg = addChatMessage('ğŸ¤” æ€è€ƒä¸­...', 'assistant');
            
            setTimeout(() => {
                thinkingMsg.remove();
                const response = generateAIResponse(message);
                addChatMessage(response, 'assistant');
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }, 800);
        }

        function addChatMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messagesDiv.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return messageDiv;
        }

        function generateAIResponse(message) {
            const responses = {
                'å‚æ•°': 'æ§åˆ¶å‚æ•°çš„é€‰æ‹©éœ€è¦å¹³è¡¡å“åº”é€Ÿåº¦ã€ç¨³å®šæ€§å’Œè¶…è°ƒé‡ã€‚å»ºè®®ä»å°åˆ°å¤§é€æ­¥è°ƒæ•´ã€‚',
                'æ•ˆæœ': 'è¯„ä¼°æ§åˆ¶æ•ˆæœéœ€å…³æ³¨ï¼šè¶…è°ƒé‡ã€è°ƒèŠ‚æ—¶é—´ã€ç¨³æ€è¯¯å·®å’ŒæŒ¯è¡æ¬¡æ•°ã€‚',
                'ä¼˜åŒ–': 'å‚æ•°ä¼˜åŒ–æµç¨‹ï¼š1. ç¡®å®šæ¨¡å‹å‚æ•° 2. è·å¾—åˆå€¼ 3. è§‚å¯Ÿå“åº” 4. å¾®è°ƒå‚æ•° 5. é‡å¤ç›´åˆ°æ»¡æ„ã€‚'
            };
            
            for (const [key, value] of Object.entries(responses)) {
                if (message.includes(key)) return value;
            }
            
            return 'æˆ‘å¯ä»¥å¸®ä½ åˆ†æä»£ç å’Œä¼˜åŒ–å‚æ•°ã€‚è¯•è¯•é—®æˆ‘å…³äº"å‚æ•°"ã€"æ•ˆæœ"æˆ–"ä¼˜åŒ–"çš„é—®é¢˜ï¼';
        }

        // æ˜¾ç¤ºæ¬¢è¿é¡µ
        function showWelcomePage() {
            const docContent = document.getElementById('docContent');
            docContent.innerHTML = `
                <div class="welcome-page">
                    <div class="welcome-icon">ğŸ“</div>
                    <div class="welcome-title">æ°´ç³»ç»Ÿæ§åˆ¶ç†è®ºæ•™ç¨‹</div>
                    <div class="welcome-subtitle">ç»Ÿä¸€æ™ºèƒ½å­¦ä¹ å¹³å° - æ–‡æ¡£æµè§ˆä¸AIç¼–ç¨‹IDE</div>
                    
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“</div>
                            <div class="feature-title">æ ‘çŠ¶æ–‡ä»¶ç®¡ç†</div>
                            <div class="feature-desc">å·¦ä¾§å¯å±•å¼€/æ”¶èµ·çš„æ¡ˆä¾‹æµè§ˆå™¨</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“š</div>
                            <div class="feature-title">æ–‡æ¡£è§†å›¾</div>
                            <div class="feature-desc">æŸ¥çœ‹æ¡ˆä¾‹è¯´æ˜å’Œç»“æœå›¾è¡¨</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ’»</div>
                            <div class="feature-title">IDEè§†å›¾</div>
                            <div class="feature-desc">åœ¨çº¿ç¼–è¾‘å’Œè¿è¡ŒPythonä»£ç </div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ¤–</div>
                            <div class="feature-title">AIåŠ©æ‰‹</div>
                            <div class="feature-desc">æ™ºèƒ½åˆ†æå’Œå‚æ•°ä¼˜åŒ–å»ºè®®</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #252526; border-radius: 8px; border: 1px solid #3e3e42;">
                        <div style="font-size: 14px; color: #888; margin-bottom: 10px;">ğŸ’¡ å¿«æ·é”®æç¤º</div>
                        <div style="font-size: 13px; color: #aaa; line-height: 2;">
                            <strong>Ctrl+B</strong> - åˆ‡æ¢æ–‡ä»¶æ ‘ &nbsp;|&nbsp;
                            <strong>Ctrl+J</strong> - åˆ‡æ¢AIåŠ©æ‰‹ &nbsp;|&nbsp;
                            <strong>Ctrl+\`</strong> - åˆ‡æ¢ç»ˆç«¯ &nbsp;|&nbsp;
                            <strong>Ctrl+Enter</strong> - è¿è¡Œä»£ç 
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆå§‹åŒ–æ‹–æ‹½è°ƒæ•´å¤§å°
        function initResizeHandles() {
            let isResizing = false;
            let currentHandle = null;
            let startX = 0;
            let startY = 0;
            let startWidth = 0;
            let startHeight = 0;

            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    currentHandle = handle;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    const panel = handle.closest('.resizable-panel');
                    if (handle.classList.contains('vertical')) {
                        startWidth = panel.offsetWidth;
                    } else {
                        startHeight = panel.offsetHeight;
                    }
                    
                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const panel = currentHandle.closest('.resizable-panel');
                
                if (currentHandle.classList.contains('vertical')) {
                    const delta = e.clientX - startX;
                    const isRightPanel = panel.classList.contains('right-panel');
                    const newWidth = isRightPanel ? startWidth - delta : startWidth + delta;
                    panel.style.width = Math.max(200, Math.min(600, newWidth)) + 'px';
                } else {
                    const delta = e.clientY - startY;
                    const newHeight = startHeight - delta;
                    panel.style.height = Math.max(100, Math.min(600, newHeight)) + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                currentHandle = null;
            });
        }

        // é”®ç›˜å¿«æ·é”®
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    togglePanel('left');
                } else if (e.ctrlKey && e.key === 'j') {
                    e.preventDefault();
                    togglePanel('right');
                } else if (e.ctrlKey && e.key === '`') {
                    e.preventDefault();
                    togglePanel('bottom');
                } else if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    if (currentView === 'ide') runCode();
                }
            });
        }
    </script>
</body>
</html>

