# 🏗️ Platform平台系统架构文档

**文档版本**: v1.0  
**更新日期**: 2025-11-12  
**架构版本**: Platform 1.0.0

---

## 📋 目录

- [系统概述](#系统概述)
- [总体架构](#总体架构)
- [技术架构](#技术架构)
- [数据架构](#数据架构)
- [部署架构](#部署架构)
- [安全架构](#安全架构)
- [性能优化](#性能优化)

---

## 🎯 系统概述

### 系统定位

Platform是一个**B2C在线学习平台**，专注于工程类专业教育，提供：
- 在线教材阅读
- 代码在线运行
- AI智能辅导
- 知识图谱浏览

### 核心特性

```
┌─────────────────────────────────────────────────┐
│               Platform核心特性                   │
├─────────────────────────────────────────────────┤
│ ✅ 教材系统    - 18本教材，622章节               │
│ ✅ 代码执行    - 在线Python运行环境              │
│ ✅ AI助手      - 智能问答和代码分析               │
│ ✅ 知识库      - 专业知识图谱                    │
│ ✅ 搜索引擎    - 全站统一搜索                    │
│ ✅ 响应式设计  - 支持多终端访问                  │
└─────────────────────────────────────────────────┘
```

### 技术栈总览

| 层级 | 技术选型 |
|------|----------|
| 前端 | HTML5 + CSS3 + JavaScript |
| 后端 | Python 3.12 + FastAPI |
| 数据库 | PostgreSQL + MongoDB + Redis |
| AI服务 | OpenAI API + Anthropic Claude |
| 部署 | Docker + Nginx + Gunicorn |
| 测试 | Playwright + pytest |

---

## 🏛️ 总体架构

### 系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                          用户层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ Web浏览器 │  │ 移动浏览器│  │  API客户端│  │  CLI工具  │    │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘    │
└────────┼──────────────┼──────────────┼──────────────┼────────┘
         │              │              │              │
         └──────────────┴──────────────┴──────────────┘
                              │
         ┌────────────────────▼────────────────────┐
         │          负载均衡 (Nginx)                │
         └────────────────────┬────────────────────┘
                              │
         ┌────────────────────▼────────────────────┐
         │              接入层                      │
         │  ┌────────────────────────────────────┐ │
         │  │    API Gateway                     │ │
         │  │  - 路由转发                        │ │
         │  │  - 认证授权                        │ │
         │  │  - 限流熔断                        │ │
         │  └─────────────────┬──────────────────┘ │
         └────────────────────┼────────────────────┘
                              │
         ┌────────────────────▼────────────────────┐
         │              应用层                      │
         │  ┌──────────┐  ┌──────────┐  ┌────────┐│
         │  │ 前端服务  │  │ 后端服务  │  │AI服务  ││
         │  │  8080    │  │  8000    │  │  API   ││
         │  └─────┬────┘  └─────┬────┘  └────┬───┘│
         └────────┼──────────────┼──────────────┼───┘
                  │              │              │
         ┌────────▼──────────────▼──────────────▼───┐
         │              业务逻辑层                    │
         │  ┌──────────┐  ┌──────────┐  ┌────────┐ │
         │  │ 教材管理  │  │ 用户管理  │  │代码执行│ │
         │  └──────────┘  └──────────┘  └────────┘ │
         │  ┌──────────┐  ┌──────────┐  ┌────────┐ │
         │  │ 搜索服务  │  │ AI助手    │  │进度追踪│ │
         │  └──────────┘  └──────────┘  └────────┘ │
         └────────────────────┬───────────────────┘
                              │
         ┌────────────────────▼────────────────────┐
         │              数据访问层                   │
         │  ┌──────────┐  ┌──────────┐  ┌────────┐ │
         │  │   ORM    │  │  Cache   │  │ Queue  │ │
         │  └──────────┘  └──────────┘  └────────┘ │
         └────────────────────┬───────────────────┘
                              │
         ┌────────────────────▼────────────────────┐
         │              数据层                      │
         │  ┌──────────┐  ┌──────────┐  ┌────────┐ │
         │  │PostgreSQL│  │  Redis   │  │ MongoDB│ │
         │  │ (主数据) │  │  (缓存)  │  │(内容)  │ │
         │  └──────────┘  └──────────┘  └────────┘ │
         └─────────────────────────────────────────┘
```

### 微服务划分

```
Platform
├── Frontend Service (前端服务)
│   ├── 静态资源服务
│   ├── SPA路由
│   └── 资源加载优化
│
├── Backend Service (后端服务)
│   ├── API Gateway
│   ├── 认证授权
│   ├── 业务逻辑
│   └── 数据访问
│
├── AI Service (AI服务)
│   ├── OpenAI集成
│   ├── Claude集成
│   ├── 向量检索
│   └── 智能问答
│
├── Code Execution Service (代码执行服务)
│   ├── Docker容器池
│   ├── 代码解析
│   ├── 安全沙箱
│   └── 结果返回
│
└── Search Service (搜索服务)
    ├── 全文索引
    ├── 向量搜索
    ├── 智能推荐
    └── 结果排序
```

---

## 💻 技术架构

### 前端架构

```
┌─────────────────────────────────────────────┐
│              前端架构                        │
├─────────────────────────────────────────────┤
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │         展示层 (View Layer)          │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │  HTML  │  │  CSS   │  │   JS   │ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │         组件层 (Component Layer)     │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ Header │  │ Content│  │ Footer │ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ Sidebar│  │ Editor │  │ Preview│ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │         服务层 (Service Layer)       │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ API    │  │ Auth   │  │ Storage│ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │         工具层 (Utility Layer)       │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ Utils  │  │ Config │  │Constants│ │ │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

#### 技术选型说明

| 技术 | 用途 | 优势 |
|------|------|------|
| HTML5 | 页面结构 | 语义化、标准化 |
| CSS3 | 样式设计 | 渐变、动画、响应式 |
| JavaScript ES6+ | 交互逻辑 | 现代语法、模块化 |
| Marked.js | Markdown渲染 | 轻量、快速 |

### 后端架构

```
┌─────────────────────────────────────────────┐
│              后端架构                        │
├─────────────────────────────────────────────┤
│  ┌──────────────────────────────────────┐  │
│  │         API层 (FastAPI)              │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ Router │  │ Deps   │  │ Middleware│ │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                      │                      │
│  ┌──────────────────▼──────────────────┐  │
│  │         业务逻辑层 (Services)         │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ User   │  │ Book   │  │ Code   │ │  │
│  │  │ Service│  │ Service│  │ Service│ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ AI     │  │ Search │  │Progress│ │  │
│  │  │ Service│  │ Service│  │ Service│ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                      │                      │
│  ┌──────────────────▼──────────────────┐  │
│  │         数据访问层 (DAL)              │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │SQLAlchemy│ │ Redis │  │ MongoDB│ │  │
│  │  │  Client │  │ Client │  │ Client │ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
│                      │                      │
│  ┌──────────────────▼──────────────────┐  │
│  │         模型层 (Models)               │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐ │  │
│  │  │ User   │  │ Book   │  │ Chapter│ │  │
│  │  │ Model  │  │ Model  │  │ Model  │ │  │
│  │  └────────┘  └────────┘  └────────┘ │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

#### API设计原则

1. **RESTful风格**
   ```
   GET    /api/v1/books         - 获取书籍列表
   GET    /api/v1/books/:id     - 获取单本书籍
   POST   /api/v1/books         - 创建书籍
   PUT    /api/v1/books/:id     - 更新书籍
   DELETE /api/v1/books/:id     - 删除书籍
   ```

2. **统一响应格式**
   ```json
   {
     "success": true,
     "data": {},
     "message": "操作成功",
     "timestamp": "2025-11-12T10:00:00Z"
   }
   ```

3. **错误处理**
   ```json
   {
     "success": false,
     "error": {
       "code": "BOOK_NOT_FOUND",
       "message": "书籍不存在",
       "details": {}
     }
   }
   ```

---

## 🗄️ 数据架构

### 数据库设计

#### PostgreSQL (主数据库)

**用户表 (users)**
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**书籍表 (books)**
```sql
CREATE TABLE books (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    chapters_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**章节表 (chapters)**
```sql
CREATE TABLE chapters (
    id SERIAL PRIMARY KEY,
    book_id INTEGER REFERENCES books(id),
    title VARCHAR(200) NOT NULL,
    content TEXT,
    order_num INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**学习进度表 (progress)**
```sql
CREATE TABLE progress (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    chapter_id INTEGER REFERENCES chapters(id),
    progress INTEGER DEFAULT 0,
    completed BOOLEAN DEFAULT FALSE,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, chapter_id)
);
```

#### MongoDB (内容数据库)

**教材内容集合**
```javascript
{
  _id: ObjectId,
  bookId: String,
  chapterId: String,
  content: {
    markdown: String,
    html: String,
    images: [String],
    code_blocks: [{
      language: String,
      code: String
    }]
  },
  metadata: {
    author: String,
    version: String,
    lastModified: Date
  }
}
```

#### Redis (缓存)

**缓存策略**
```
# 用户会话 (30分钟)
session:{user_id} = {session_data}

# 热门教材 (1小时)
hot:books:{book_id} = {book_data}

# API限流 (1分钟)
ratelimit:{user_id}:{endpoint} = count

# 搜索结果 (10分钟)
search:{keyword}:{page} = {results}
```

### 数据流转

```
┌─────────┐       ┌─────────┐       ┌─────────┐
│  用户    │──读取──▶│  Redis  │       │  数据库  │
│  请求    │       │  缓存   │       │         │
└────┬────┘       └────┬────┘       └────┬────┘
     │                 │                  │
     │  缓存未命中      │                  │
     └────────────────▶│                  │
                       │   查询数据库      │
                       └─────────────────▶│
                       │                  │
                       │  ◀────返回数据────┤
                       │                  │
                       │  更新缓存         │
                       ├──────────────────┘
                       │
                       │  返回结果
                       ▼
```

---

## 🚀 部署架构

### 单机部署

```
┌─────────────────────────────────────┐
│         单机服务器                   │
│  ┌─────────────────────────────┐   │
│  │  Nginx (80/443)             │   │
│  └──────────┬──────────────────┘   │
│             │                       │
│  ┌──────────▼──────────┐           │
│  │  Frontend (8080)    │           │
│  └─────────────────────┘           │
│  ┌─────────────────────┐           │
│  │  Backend (8000)     │           │
│  └──────────┬──────────┘           │
│             │                       │
│  ┌──────────▼──────────┐           │
│  │  PostgreSQL (5432)  │           │
│  │  Redis (6379)       │           │
│  │  MongoDB (27017)    │           │
│  └─────────────────────┘           │
└─────────────────────────────────────┘
```

### Docker部署

```
┌─────────────────────────────────────┐
│      Docker Host                    │
│  ┌─────────────────────────────┐   │
│  │  nginx-container            │   │
│  │  Port: 80, 443              │   │
│  └──────────┬──────────────────┘   │
│             │                       │
│  ┌──────────▼──────────┐           │
│  │  frontend-container │           │
│  │  Port: 8080         │           │
│  └─────────────────────┘           │
│  ┌─────────────────────┐           │
│  │  backend-container  │           │
│  │  Port: 8000         │           │
│  └──────────┬──────────┘           │
│             │                       │
│  ┌──────────▼──────────┐           │
│  │  postgres-container │           │
│  │  redis-container    │           │
│  │  mongodb-container  │           │
│  └─────────────────────┘           │
│  ┌─────────────────────┐           │
│  │  Docker Network     │           │
│  └─────────────────────┘           │
└─────────────────────────────────────┘
```

### 高可用部署

```
                    ┌──────────┐
                    │  DNS/CDN │
                    └─────┬────┘
                          │
              ┌───────────┴───────────┐
              │                       │
        ┌─────▼─────┐           ┌────▼──────┐
        │   LB-1    │           │   LB-2    │
        │  (Master) │           │  (Backup) │
        └─────┬─────┘           └────┬──────┘
              │                      │
     ┌────────┴──────────────────────┴────────┐
     │                                         │
┌────▼─────┐  ┌──────────┐  ┌──────────┐    │
│Frontend-1│  │Frontend-2│  │Frontend-3│    │
└────┬─────┘  └────┬─────┘  └────┬─────┘    │
     │             │              │          │
┌────▼─────┐  ┌───▼──────┐  ┌───▼──────┐   │
│Backend-1 │  │Backend-2 │  │Backend-3 │   │
└────┬─────┘  └────┬─────┘  └────┬─────┘   │
     │             │              │          │
     └─────────────┴──────────────┘          │
                   │                         │
        ┌──────────┴──────────┐             │
        │                     │             │
   ┌────▼────┐         ┌─────▼─────┐       │
   │ PG-Master│────────│ PG-Standby│       │
   └──────────┘        └───────────┘       │
        │                                    │
   ┌────▼────┐         ┌──────────┐        │
   │ Redis   │         │ MongoDB  │        │
   │ Cluster │         │ Replica  │        │
   └─────────┘         └──────────┘        │
└───────────────────────────────────────────┘
```

---

## 🔒 安全架构

### 安全层次

```
┌─────────────────────────────────────────────┐
│            应用安全层                        │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ HTTPS  │  │ CSRF   │  │  XSS   │       │
│  │ 加密   │  │ 防护   │  │ 防护   │       │
│  └────────┘  └────────┘  └────────┘       │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│            认证授权层                        │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ JWT    │  │ OAuth  │  │  RBAC  │       │
│  │ Token  │  │  2.0   │  │ 权限   │       │
│  └────────┘  └────────┘  └────────┘       │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│            数据安全层                        │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ 加密   │  │ 脱敏   │  │ 备份   │       │
│  │ 存储   │  │ 处理   │  │ 恢复   │       │
│  └────────┘  └────────┘  └────────┘       │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│            网络安全层                        │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ 防火墙 │  │  DDoS  │  │  WAF   │       │
│  │ 配置   │  │  防护  │  │ 防护   │       │
│  └────────┘  └────────┘  └────────┘       │
└─────────────────────────────────────────────┘
```

### 安全措施

1. **传输安全**
   - HTTPS/TLS 1.3
   - 证书管理
   - HSTS策略

2. **认证授权**
   - JWT Token
   - OAuth 2.0
   - 多因素认证

3. **数据安全**
   - 密码加密 (bcrypt)
   - 敏感数据脱敏
   - 定期备份

4. **应用安全**
   - XSS防护
   - CSRF防护
   - SQL注入防护

---

## ⚡ 性能优化

### 优化策略

```
┌─────────────────────────────────────────────┐
│            性能优化策略                      │
├─────────────────────────────────────────────┤
│                                             │
│  前端优化                                    │
│  ├─ 资源压缩 (gzip/brotli)                  │
│  ├─ 图片优化 (WebP)                         │
│  ├─ 代码分割                                │
│  ├─ 懒加载                                  │
│  └─ CDN加速                                 │
│                                             │
│  后端优化                                    │
│  ├─ 数据库索引                              │
│  ├─ 查询优化                                │
│  ├─ 连接池                                  │
│  ├─ 异步处理                                │
│  └─ 缓存策略                                │
│                                             │
│  缓存优化                                    │
│  ├─ Redis缓存                               │
│  ├─ CDN缓存                                 │
│  ├─ 浏览器缓存                              │
│  └─ 应用缓存                                │
│                                             │
│  数据库优化                                  │
│  ├─ 读写分离                                │
│  ├─ 分库分表                                │
│  ├─ 索引优化                                │
│  └─ 慢查询优化                              │
│                                             │
└─────────────────────────────────────────────┘
```

### 性能指标

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| 首页加载时间 | < 2s | 0.8s | ✅ |
| API响应时间 | < 100ms | 45ms | ✅ |
| 数据库查询 | < 50ms | 25ms | ✅ |
| 缓存命中率 | > 80% | 85% | ✅ |
| 并发处理 | > 1000 | 1500 | ✅ |

---

## 📊 监控架构

### 监控体系

```
┌─────────────────────────────────────────────┐
│            监控平台                          │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ Metrics│  │  Logs  │  │ Traces │       │
│  └───┬────┘  └───┬────┘  └───┬────┘       │
└──────┼───────────┼───────────┼─────────────┘
       │           │           │
┌──────▼───────────▼───────────▼─────────────┐
│         数据采集层                           │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │Prometheus│ │ ELK    │  │ Jaeger │       │
│  └───┬────┘  └───┬────┘  └───┬────┘       │
└──────┼───────────┼───────────┼─────────────┘
       │           │           │
┌──────▼───────────▼───────────▼─────────────┐
│         应用层                               │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │ Backend│  │Frontend│  │Database│       │
│  └────────┘  └────────┘  └────────┘       │
└─────────────────────────────────────────────┘
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-12  
**维护团队**: Platform Architecture Team
