# 第9章：非参数统计

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、非参数统计概述

### 1.1 参数统计 vs 非参数统计

**参数统计**：
- 假设总体分布（如正态分布）
- 推断参数（如均值、方差）
- 例：t检验、F检验

**非参数统计**：
- 不假设总体分布
- 对分布形状鲁棒
- 适用于小样本、顺序数据
- 例：符号检验、秩和检验

### 1.2 适用场景

**使用非参数方法的情况**：
1. 总体分布未知或不满足正态性
2. 样本量较小
3. 数据是顺序（ordinal）数据
4. 存在异常值
5. 违反方差齐性假设

---

## 二、单样本非参数检验

### 2.1 符号检验（Sign Test）

**目的**：检验中位数$M = M_0$

**方法**：
记录每个观测值与$M_0$的符号（+或-）

**检验统计量**：
$$S = \#\{X_i > M_0\}$$

**原假设下**：$S \sim B(n, 0.5)$（二项分布）

**例题1**：某药品声称中位数疗效时间为5天。
观测10名患者：4, 6, 7, 3, 5, 8, 4, 6, 5, 7天。
在$\alpha=0.05$水平检验。

**解**：
$H_0: M = 5$，$H_1: M \neq 5$

比较与5的大小：
- 大于5：6, 7, 8, 6, 7 → 5个
- 小于5：4, 3, 4 → 3个
- 等于5：2个（舍去）

有效样本$n=8$，正号数$S=5$

双侧检验，$p$值：
$$p = 2P(S \geq 5 | n=8, p=0.5) = 2 \times \sum_{k=5}^8 \binom{8}{k}(0.5)^8$$
$$= 2 \times (0.219 + 0.109 + 0.031 + 0.004) = 0.726$$

$p > 0.05$，不拒绝$H_0$，中位数无显著差异

---

### 2.2 Wilcoxon符号秩检验

**改进**：考虑差值的大小（不仅是符号）

**步骤**：
1. 计算差值$D_i = X_i - M_0$
2. 按$|D_i|$排序（去除0）
3. 恢复符号，记录秩
4. 计算正秩和$W^+$或负秩和$W^-$

**检验统计量**：
$$W = \min(W^+, W^-)$$

小样本查表，大样本正态近似

**例题2**：对上例使用Wilcoxon检验

**解**：
差值：-1, 1, 2, -2, 0, 3, -1, 1, 0, 2

去除0后：-1, 1, 2, -2, 3, -1, 1, 2

绝对值排序：

| $|D_i|$ | 1 | 1 | 1 | 2 | 2 | 3 |
|---------|---|---|---|---|---|---|
| 秩 | 2 | 2 | 2 | 5 | 5 | 7 |
| 符号 | - | + | - | - | + | + |

（相同秩取平均：1,2,3的秩→2，4,5的秩→5）

$$W^+ = 2 + 5 + 7 = 14$$
$$W^- = 2 + 2 + 5 = 9$$

$$W = \min(14, 9) = 9$$

查Wilcoxon表（$n=8, \alpha=0.05$双侧），临界值$W_{crit}=3$

$W=9 > 3$，不拒绝$H_0$

---

## 三、两样本非参数检验

### 3.1 Mann-Whitney U检验（秩和检验）

**目的**：比较两个独立样本的位置参数

**步骤**：
1. 合并两组数据排序
2. 记录各组的秩
3. 计算秩和$R_1, R_2$
4. 计算U统计量

**U统计量**：
$$U_1 = n_1 n_2 + \frac{n_1(n_1+1)}{2} - R_1$$
$$U_2 = n_1 n_2 + \frac{n_2(n_2+1)}{2} - R_2$$

检验统计量：$U = \min(U_1, U_2)$

**大样本正态近似**：
$$Z = \frac{U - \frac{n_1n_2}{2}}{\sqrt{\frac{n_1n_2(n_1+n_2+1)}{12}}}$$

**例题3**：比较两种教学方法的效果

方法A成绩：85, 78, 92, 88, 76
方法B成绩：82, 90, 95, 86, 89

在$\alpha=0.05$检验差异。

**解**：
合并排序：76, 78, 82, 85, 86, 88, 89, 90, 92, 95

| 值 | 76 | 78 | 82 | 85 | 86 | 88 | 89 | 90 | 92 | 95 |
|----|----|----|----|----|----|----|----|----|----|----|
| 秩 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |
| 组 | A | A | B | A | B | A | B | B | A | B |

$$R_A = 1+2+4+6+9 = 22$$
$$R_B = 3+5+7+8+10 = 33$$

验证：$22+33 = 55 = \frac{10 \times 11}{2}$ ✓

$$U_A = 5 \times 5 + \frac{5 \times 6}{2} - 22 = 25 + 15 - 22 = 18$$
$$U_B = 5 \times 5 + \frac{5 \times 6}{2} - 33 = 25 + 15 - 33 = 7$$

$U = \min(18, 7) = 7$

查表（$n_1=n_2=5, \alpha=0.05$双侧），临界值$U_{crit}=2$

$U=7 > 2$，不拒绝$H_0$，两种方法无显著差异

---

### 3.2 Wilcoxon符号秩检验（配对样本）

**适用**：配对数据，如治疗前后

**步骤**：
1. 计算差值$D_i = X_i - Y_i$
2. 对$|D_i|$排秩
3. 计算$W^+$和$W^-$

---

## 四、多样本非参数检验

### 4.1 Kruskal-Wallis H检验

**目的**：非参数版的单因素方差分析

**假设**：
- $H_0$：$k$个总体分布相同
- $H_1$：至少一个总体分布不同

**检验统计量**：
$$H = \frac{12}{n(n+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(n+1)$$

其中：
- $n = \sum n_i$：总样本量
- $R_i$：第$i$组的秩和

**分布**：$H \sim \chi^2(k-1)$（近似）

**例题4**：比较三种肥料对作物产量的影响

| 肥料A | 肥料B | 肥料C |
|-------|-------|-------|
| 45 | 52 | 48 |
| 48 | 55 | 50 |
| 42 | 58 | 46 |
| 46 | 54 | 49 |

**解**：
合并排序：42, 45, 46, 46, 48, 48, 49, 50, 52, 54, 55, 58

秩（相同值取平均秩）：
- 42(1), 45(2), 46(3.5), 46(3.5), 48(5.5), 48(5.5), 49(7), 50(8), 52(9), 54(10), 55(11), 58(12)

各组秩和：
- $R_A = 2 + 5.5 + 1 + 3.5 = 12$
- $R_B = 9 + 11 + 12 + 10 = 42$
- $R_C = 5.5 + 8 + 3.5 + 7 = 24$

$$H = \frac{12}{12 \times 13}\left(\frac{12^2}{4} + \frac{42^2}{4} + \frac{24^2}{4}\right) - 3 \times 13$$
$$= \frac{12}{156}(36 + 441 + 144) - 39$$
$$= \frac{12 \times 621}{156} - 39 = 47.77 - 39 = 8.77$$

$\chi^2_{0.05}(2) = 5.99$

$H = 8.77 > 5.99$，拒绝$H_0$，三种肥料效果有显著差异

---

## 五、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from scipy.stats import binom, mannwhitneyu, wilcoxon, kruskal

class NonParametricTests:
    """非参数统计检验工具"""
    
    @staticmethod
    def sign_test(data, M0, alternative='two-sided'):
        """
        符号检验
        
        参数:
            data: 样本数据
            M0: 假设中位数
            alternative: 'two-sided', 'greater', 'less'
        
        返回:
            statistic: 检验统计量（正号数）
            p_value: p值
        """
        # 计算差值
        diff = data - M0
        
        # 去除等于0的
        diff = diff[diff != 0]
        n = len(diff)
        
        # 计算正号数
        n_plus = np.sum(diff > 0)
        
        # 计算p值
        if alternative == 'two-sided':
            p_value = 2 * min(binom.cdf(n_plus, n, 0.5),
                             1 - binom.cdf(n_plus-1, n, 0.5))
        elif alternative == 'greater':
            p_value = 1 - binom.cdf(n_plus-1, n, 0.5)
        else:  # less
            p_value = binom.cdf(n_plus, n, 0.5)
        
        return n_plus, p_value
    
    @staticmethod
    def mann_whitney_test(x, y, alternative='two-sided'):
        """
        Mann-Whitney U检验
        
        参数:
            x, y: 两个独立样本
            alternative: 'two-sided', 'greater', 'less'
        
        返回:
            U: U统计量
            p_value: p值
        """
        statistic, p_value = mannwhitneyu(x, y, alternative=alternative)
        
        return statistic, p_value
    
    @staticmethod
    def wilcoxon_signed_rank_test(data, M0=0, alternative='two-sided'):
        """
        Wilcoxon符号秩检验
        
        参数:
            data: 样本数据或配对差值
            M0: 假设中位数（单样本）或0（配对样本）
            alternative: 'two-sided', 'greater', 'less'
        """
        statistic, p_value = wilcoxon(data - M0, alternative=alternative)
        
        return statistic, p_value
    
    @staticmethod
    def kruskal_wallis_test(*groups):
        """
        Kruskal-Wallis H检验
        
        参数:
            *groups: 多个样本组
        
        返回:
            H: H统计量
            p_value: p值
        """
        statistic, p_value = kruskal(*groups)
        
        return statistic, p_value
    
    @staticmethod
    def plot_nonparametric_comparison():
        """可视化非参数检验"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))
        
        # 1. 正态 vs 偏态分布
        ax1 = axes[0, 0]
        
        np.random.seed(42)
        normal_data = np.random.normal(10, 2, 100)
        skewed_data = np.random.gamma(2, 2, 100)
        
        ax1.hist(normal_data, bins=15, alpha=0.5, label='正态分布', 
                edgecolor='black')
        ax1.hist(skewed_data, bins=15, alpha=0.5, label='偏态分布',
                edgecolor='black')
        ax1.set_xlabel('值', fontsize=11)
        ax1.set_ylabel('频数', fontsize=11)
        ax1.set_title('参数检验 vs 非参数检验的适用性', fontsize=12,
                     fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        
        # 2. 符号检验可视化
        ax2 = axes[0, 1]
        
        data = np.array([4, 6, 7, 3, 5, 8, 4, 6, 5, 7])
        M0 = 5
        
        colors = ['red' if x < M0 else 'blue' if x > M0 else 'gray'
                 for x in data]
        
        ax2.scatter(range(len(data)), data, c=colors, s=100, alpha=0.7)
        ax2.axhline(M0, color='green', linestyle='--', linewidth=2,
                   label=f'中位数M₀={M0}')
        
        for i, (x, c) in enumerate(zip(data, colors)):
            ax2.plot([i, i], [M0, x], color=c, linestyle=':', linewidth=1.5)
        
        ax2.set_xlabel('观测序号', fontsize=11)
        ax2.set_ylabel('观测值', fontsize=11)
        ax2.set_title('符号检验示意图', fontsize=12, fontweight='bold')
        ax2.legend(['中位数', '< M₀', '> M₀', '= M₀'])
        ax2.grid(True, alpha=0.3)
        
        # 3. Mann-Whitney检验
        ax3 = axes[1, 0]
        
        groupA = np.array([85, 78, 92, 88, 76])
        groupB = np.array([82, 90, 95, 86, 89])
        
        positions = [1, 2]
        bp = ax3.boxplot([groupA, groupB], positions=positions,
                         widths=0.6, patch_artist=True)
        
        bp['boxes'][0].set_facecolor('lightblue')
        bp['boxes'][1].set_facecolor('lightcoral')
        
        ax3.set_xticklabels(['方法A', '方法B'])
        ax3.set_ylabel('成绩', fontsize=11)
        ax3.set_title('Mann-Whitney U检验', fontsize=12, fontweight='bold')
        ax3.grid(True, alpha=0.3, axis='y')
        
        # 执行检验
        U, p = NonParametricTests.mann_whitney_test(groupA, groupB)
        ax3.text(1.5, 95, f'U={U:.0f}\np={p:.3f}',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5),
                fontsize=10)
        
        # 4. Kruskal-Wallis检验
        ax4 = axes[1, 1]
        
        g1 = np.array([45, 48, 42, 46])
        g2 = np.array([52, 55, 58, 54])
        g3 = np.array([48, 50, 46, 49])
        
        bp2 = ax4.boxplot([g1, g2, g3], positions=[1,2,3],
                          widths=0.6, patch_artist=True)
        
        for patch, color in zip(bp2['boxes'], ['lightblue', 'lightgreen', 'lightyellow']):
            patch.set_facecolor(color)
        
        ax4.set_xticklabels(['肥料A', '肥料B', '肥料C'])
        ax4.set_ylabel('产量', fontsize=11)
        ax4.set_title('Kruskal-Wallis H检验', fontsize=12, fontweight='bold')
        ax4.grid(True, alpha=0.3, axis='y')
        
        # 执行检验
        H, p = NonParametricTests.kruskal_wallis_test(g1, g2, g3)
        ax4.text(2, 58, f'H={H:.2f}\np={p:.3f}',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5),
                fontsize=10)
        
        plt.tight_layout()
        plt.savefig('nonparametric_tests.png', dpi=300)
        plt.show()

# 示例使用
print("="*60)
print("非参数统计检验")
print("="*60)

npt = NonParametricTests()

# 1. 符号检验
print("\n1. 符号检验")
data = np.array([4, 6, 7, 3, 5, 8, 4, 6, 5, 7])
M0 = 5

n_plus, p_value = npt.sign_test(data, M0)
print(f"  数据: {data}")
print(f"  假设中位数M₀ = {M0}")
print(f"  正号数 = {n_plus}")
print(f"  p值 = {p_value:.4f}")
print(f"  结论: {'拒绝H₀' if p_value < 0.05 else '不拒绝H₀'}")

# 2. Mann-Whitney检验
print("\n" + "="*60)
print("2. Mann-Whitney U检验")

groupA = np.array([85, 78, 92, 88, 76])
groupB = np.array([82, 90, 95, 86, 89])

U, p = npt.mann_whitney_test(groupA, groupB)
print(f"  方法A: {groupA}")
print(f"  方法B: {groupB}")
print(f"  U统计量 = {U:.0f}")
print(f"  p值 = {p:.4f}")
print(f"  结论: {'拒绝H₀' if p < 0.05 else '不拒绝H₀'}")

# 3. Wilcoxon符号秩检验
print("\n" + "="*60)
print("3. Wilcoxon符号秩检验")

W, p_wilcoxon = npt.wilcoxon_signed_rank_test(data, M0)
print(f"  W统计量 = {W:.0f}")
print(f"  p值 = {p_wilcoxon:.4f}")
print(f"  结论: {'拒绝H₀' if p_wilcoxon < 0.05 else '不拒绝H₀'}")

# 4. Kruskal-Wallis检验
print("\n" + "="*60)
print("4. Kruskal-Wallis H检验")

g1 = np.array([45, 48, 42, 46])
g2 = np.array([52, 55, 58, 54])
g3 = np.array([48, 50, 46, 49])

H, p_kw = npt.kruskal_wallis_test(g1, g2, g3)
print(f"  肥料A: {g1}")
print(f"  肥料B: {g2}")
print(f"  肥料C: {g3}")
print(f"  H统计量 = {H:.2f}")
print(f"  p值 = {p_kw:.4f}")
print(f"  结论: {'拒绝H₀' if p_kw < 0.05 else '不拒绝H₀'}")

# 可视化
print("\n绘制非参数检验可视化...")
npt.plot_nonparametric_comparison()
```

---

## 六、非参数方法对比

| 参数方法 | 非参数方法 | 适用场景 |
|----------|------------|----------|
| 单样本t检验 | 符号检验/Wilcoxon | 中位数检验 |
| 配对t检验 | Wilcoxon符号秩 | 配对数据 |
| 独立t检验 | Mann-Whitney U | 两独立样本 |
| 单因素方差分析 | Kruskal-Wallis H | 多独立样本 |
| Pearson相关 | Spearman秩相关 | 相关性 |

---

**本章重点**：
- 非参数统计的特点与适用场景
- 符号检验与Wilcoxon符号秩检验
- Mann-Whitney U检验（秩和检验）
- Kruskal-Wallis H检验
- Python scipy.stats实现

**下一章**：贝叶斯统计初步
