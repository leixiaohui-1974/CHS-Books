# 第6章：假设检验

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、假设检验基本概念

### 1.1 基本思想

**核心逻辑**：小概率事件原理

- 小概率事件（$p < 0.05$）在一次试验中几乎不可能发生
- 若发生，则怀疑原假设

**基本步骤**：
1. 提出假设（$H_0$与$H_1$）
2. 选择检验统计量
3. 确定拒绝域
4. 计算统计量值
5. 做出判断

### 1.2 两类错误

**(1) 第一类错误（弃真错误）**：

$$\alpha = P(\text{拒绝}H_0 | H_0\text{为真})$$

显著性水平，通常取$\alpha = 0.05$或$0.01$

**(2) 第二类错误（取伪错误）**：

$$\beta = P(\text{接受}H_0 | H_0\text{为假})$$

功效：$1 - \beta$

**关系**：
- 样本量固定时，$\alpha \downarrow \Rightarrow \beta \uparrow$
- 增大样本量可同时减小$\alpha$和$\beta$

---

## 二、单个正态总体参数检验

### 2.1 均值检验（$\sigma^2$已知）

**Z检验**：

$$H_0: \mu = \mu_0 \quad vs \quad H_1: \mu \neq \mu_0$$

**检验统计量**：

$$Z = \frac{\bar{X} - \mu_0}{\sigma / \sqrt{n}} \sim N(0,1)$$

**拒绝域**（$\alpha = 0.05$）：

$$|Z| > z_{\alpha/2} = 1.96$$

### 2.2 均值检验（$\sigma^2$未知）

**t检验**：

$$T = \frac{\bar{X} - \mu_0}{S / \sqrt{n}} \sim t(n-1)$$

**拒绝域**：

$$|T| > t_{\alpha/2}(n-1)$$

**单侧检验**：
- $H_1: \mu > \mu_0$，拒绝域$T > t_\alpha(n-1)$
- $H_1: \mu < \mu_0$，拒绝域$T < -t_\alpha(n-1)$

### 2.3 方差检验

**$\chi^2$检验**：

$$H_0: \sigma^2 = \sigma_0^2 \quad vs \quad H_1: \sigma^2 \neq \sigma_0^2$$

**检验统计量**：

$$\chi^2 = \frac{(n-1)S^2}{\sigma_0^2} \sim \chi^2(n-1)$$

**拒绝域**：

$$\chi^2 < \chi^2_{1-\alpha/2}(n-1) \quad \text{或} \quad \chi^2 > \chi^2_{\alpha/2}(n-1)$$

---

## 三、两个正态总体参数检验

### 3.1 均值差检验（方差已知）

$$H_0: \mu_1 = \mu_2 \quad vs \quad H_1: \mu_1 \neq \mu_2$$

**检验统计量**：

$$Z = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{\sigma_1^2}{n_1} + \frac{\sigma_2^2}{n_2}}} \sim N(0,1)$$

### 3.2 均值差检验（方差未知但相等）

**合并样本方差**：

$$S_w^2 = \frac{(n_1-1)S_1^2 + (n_2-1)S_2^2}{n_1+n_2-2}$$

**t检验**：

$$T = \frac{\bar{X}_1 - \bar{X}_2}{S_w\sqrt{\frac{1}{n_1}+\frac{1}{n_2}}} \sim t(n_1+n_2-2)$$

### 3.3 方差比检验（F检验）

$$H_0: \sigma_1^2 = \sigma_2^2 \quad vs \quad H_1: \sigma_1^2 \neq \sigma_2^2$$

**检验统计量**：

$$F = \frac{S_1^2}{S_2^2} \sim F(n_1-1, n_2-1)$$

**拒绝域**（取$S_1^2 > S_2^2$）：

$$F > F_{\alpha/2}(n_1-1, n_2-1)$$

---

## 四、配对样本t检验

**适用**：配对设计（前后对比、双胞胎）

**差值**：$D_i = X_i - Y_i$

**检验统计量**：

$$T = \frac{\bar{D} - 0}{S_D / \sqrt{n}} \sim t(n-1)$$

其中$\bar{D} = \frac{1}{n}\sum D_i$，$S_D^2 = \frac{1}{n-1}\sum(D_i - \bar{D})^2$

---

## 五、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats

class HypothesisTest:
    """假设检验"""
    
    def __init__(self, alpha=0.05):
        self.alpha = alpha
    
    def z_test_one_sample(self, X, mu0, sigma, alternative='two-sided'):
        """
        单样本Z检验（总体方差已知）
        
        参数:
            X: 样本数据
            mu0: 原假设均值
            sigma: 总体标准差
            alternative: 'two-sided', 'greater', 'less'
        """
        n = len(X)
        x_bar = np.mean(X)
        
        # 检验统计量
        Z = (x_bar - mu0) / (sigma / np.sqrt(n))
        
        # p值
        if alternative == 'two-sided':
            p_value = 2 * (1 - stats.norm.cdf(abs(Z)))
            critical = stats.norm.ppf(1 - self.alpha/2)
            reject = abs(Z) > critical
        elif alternative == 'greater':
            p_value = 1 - stats.norm.cdf(Z)
            critical = stats.norm.ppf(1 - self.alpha)
            reject = Z > critical
        else:  # less
            p_value = stats.norm.cdf(Z)
            critical = -stats.norm.ppf(1 - self.alpha)
            reject = Z < critical
        
        return {
            'statistic': Z,
            'p_value': p_value,
            'critical_value': critical,
            'reject_H0': reject,
            'mean': x_bar
        }
    
    def t_test_one_sample(self, X, mu0, alternative='two-sided'):
        """
        单样本t检验（总体方差未知）
        
        参数:
            X: 样本数据
            mu0: 原假设均值
            alternative: 'two-sided', 'greater', 'less'
        """
        n = len(X)
        x_bar = np.mean(X)
        s = np.std(X, ddof=1)
        
        # 检验统计量
        T = (x_bar - mu0) / (s / np.sqrt(n))
        
        # 自由度
        df = n - 1
        
        # p值
        if alternative == 'two-sided':
            p_value = 2 * (1 - stats.t.cdf(abs(T), df))
            critical = stats.t.ppf(1 - self.alpha/2, df)
            reject = abs(T) > critical
        elif alternative == 'greater':
            p_value = 1 - stats.t.cdf(T, df)
            critical = stats.t.ppf(1 - self.alpha, df)
            reject = T > critical
        else:  # less
            p_value = stats.t.cdf(T, df)
            critical = -stats.t.ppf(1 - self.alpha, df)
            reject = T < critical
        
        return {
            'statistic': T,
            'p_value': p_value,
            'critical_value': critical,
            'reject_H0': reject,
            'mean': x_bar,
            'std': s,
            'df': df
        }
    
    def chi2_test_variance(self, X, sigma0_sq):
        """
        方差检验（卡方检验）
        
        H0: σ² = σ0²
        """
        n = len(X)
        s_sq = np.var(X, ddof=1)
        
        # 检验统计量
        chi2 = (n - 1) * s_sq / sigma0_sq
        
        # 自由度
        df = n - 1
        
        # 临界值（双侧）
        chi2_lower = stats.chi2.ppf(self.alpha/2, df)
        chi2_upper = stats.chi2.ppf(1 - self.alpha/2, df)
        
        # p值（双侧）
        p_lower = stats.chi2.cdf(chi2, df)
        p_upper = 1 - stats.chi2.cdf(chi2, df)
        p_value = 2 * min(p_lower, p_upper)
        
        reject = (chi2 < chi2_lower) or (chi2 > chi2_upper)
        
        return {
            'statistic': chi2,
            'p_value': p_value,
            'critical_lower': chi2_lower,
            'critical_upper': chi2_upper,
            'reject_H0': reject,
            'variance': s_sq,
            'df': df
        }
    
    def t_test_two_sample(self, X, Y, equal_var=True):
        """
        两独立样本t检验
        
        参数:
            X, Y: 两组样本
            equal_var: 是否假设方差相等
        """
        n1, n2 = len(X), len(Y)
        x_bar, y_bar = np.mean(X), np.mean(Y)
        s1, s2 = np.std(X, ddof=1), np.std(Y, ddof=1)
        
        if equal_var:
            # 合并方差
            s_w_sq = ((n1-1)*s1**2 + (n2-1)*s2**2) / (n1 + n2 - 2)
            T = (x_bar - y_bar) / np.sqrt(s_w_sq * (1/n1 + 1/n2))
            df = n1 + n2 - 2
        else:
            # Welch t检验
            T = (x_bar - y_bar) / np.sqrt(s1**2/n1 + s2**2/n2)
            df = (s1**2/n1 + s2**2/n2)**2 / ((s1**2/n1)**2/(n1-1) + (s2**2/n2)**2/(n2-1))
        
        # p值（双侧）
        p_value = 2 * (1 - stats.t.cdf(abs(T), df))
        critical = stats.t.ppf(1 - self.alpha/2, df)
        reject = abs(T) > critical
        
        return {
            'statistic': T,
            'p_value': p_value,
            'critical_value': critical,
            'reject_H0': reject,
            'mean_diff': x_bar - y_bar,
            'df': df
        }
    
    def f_test_variance(self, X, Y):
        """
        方差齐性检验（F检验）
        
        H0: σ1² = σ2²
        """
        n1, n2 = len(X), len(Y)
        s1_sq, s2_sq = np.var(X, ddof=1), np.var(Y, ddof=1)
        
        # 保证F > 1
        if s1_sq > s2_sq:
            F = s1_sq / s2_sq
            df1, df2 = n1 - 1, n2 - 1
        else:
            F = s2_sq / s1_sq
            df1, df2 = n2 - 1, n1 - 1
        
        # 临界值
        F_critical = stats.f.ppf(1 - self.alpha/2, df1, df2)
        
        # p值（双侧）
        p_value = 2 * (1 - stats.f.cdf(F, df1, df2))
        
        reject = F > F_critical
        
        return {
            'statistic': F,
            'p_value': p_value,
            'critical_value': F_critical,
            'reject_H0': reject,
            'df': (df1, df2)
        }
    
    def paired_t_test(self, X, Y):
        """
        配对样本t检验
        
        参数:
            X, Y: 配对样本（长度相同）
        """
        D = np.array(X) - np.array(Y)
        
        # 相当于单样本t检验（检验差值均值是否为0）
        return self.t_test_one_sample(D, mu0=0)
    
    def plot_hypothesis_test_visualization(self):
        """绘制假设检验可视化"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. Z检验拒绝域
        ax1 = axes[0, 0]
        
        x = np.linspace(-4, 4, 1000)
        y = stats.norm.pdf(x)
        
        ax1.plot(x, y, 'b-', linewidth=2.5, label='N(0,1)分布')
        
        # 拒绝域（α=0.05）
        z_critical = stats.norm.ppf(1 - 0.05/2)
        
        # 左侧拒绝域
        x_left = x[x < -z_critical]
        ax1.fill_between(x_left, 0, stats.norm.pdf(x_left),
                        alpha=0.3, color='red', label=f'拒绝域（α/2={0.025}）')
        
        # 右侧拒绝域
        x_right = x[x > z_critical]
        ax1.fill_between(x_right, 0, stats.norm.pdf(x_right),
                        alpha=0.3, color='red')
        
        # 标注
        ax1.axvline(-z_critical, color='r', linestyle='--', linewidth=2)
        ax1.axvline(z_critical, color='r', linestyle='--', linewidth=2)
        ax1.text(-z_critical, 0.15, f'-{z_critical:.2f}', ha='center', fontsize=10)
        ax1.text(z_critical, 0.15, f'{z_critical:.2f}', ha='center', fontsize=10)
        
        ax1.set_xlabel('Z值', fontsize=11)
        ax1.set_ylabel('概率密度', fontsize=11)
        ax1.set_title('双侧Z检验拒绝域（α=0.05）', fontsize=13, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        
        # 2. 两类错误示意
        ax2 = axes[0, 1]
        
        mu0 = 0
        mu1 = 2
        sigma = 1
        
        x_range = np.linspace(-3, 5, 1000)
        
        # H0分布
        y_H0 = stats.norm.pdf(x_range, mu0, sigma)
        ax2.plot(x_range, y_H0, 'b-', linewidth=2.5, label='H₀: μ=0')
        
        # H1分布
        y_H1 = stats.norm.pdf(x_range, mu1, sigma)
        ax2.plot(x_range, y_H1, 'r-', linewidth=2.5, label='H₁: μ=2')
        
        # 临界值
        c = stats.norm.ppf(1 - 0.05, mu0, sigma)
        ax2.axvline(c, color='g', linestyle='--', linewidth=2, label=f'临界值c={c:.2f}')
        
        # α区域（第一类错误）
        x_alpha = x_range[x_range > c]
        ax2.fill_between(x_alpha, 0, stats.norm.pdf(x_alpha, mu0, sigma),
                        alpha=0.3, color='orange', label='α（弃真）')
        
        # β区域（第二类错误）
        x_beta = x_range[x_range < c]
        y_beta = stats.norm.pdf(x_beta, mu1, sigma)
        ax2.fill_between(x_beta, 0, y_beta,
                        alpha=0.3, color='purple', label='β（取伪）')
        
        ax2.set_xlabel('样本均值', fontsize=11)
        ax2.set_ylabel('概率密度', fontsize=11)
        ax2.set_title('两类错误示意图', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. t分布族
        ax3 = axes[1, 0]
        
        x_t = np.linspace(-4, 4, 1000)
        
        df_values = [1, 3, 10, 30]
        colors_t = ['red', 'orange', 'green', 'blue']
        
        for df, color in zip(df_values, colors_t):
            y_t = stats.t.pdf(x_t, df)
            ax3.plot(x_t, y_t, color=color, linewidth=2, label=f'df={df}')
        
        # 标准正态
        y_norm = stats.norm.pdf(x_t)
        ax3.plot(x_t, y_norm, 'k--', linewidth=2.5, label='N(0,1)')
        
        ax3.set_xlabel('t值', fontsize=11)
        ax3.set_ylabel('概率密度', fontsize=11)
        ax3.set_title('t分布族（不同自由度）', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. p值解释
        ax4 = axes[1, 1]
        
        # 示例：计算的Z值
        Z_obs = 2.5
        
        x_p = np.linspace(-4, 4, 1000)
        y_p = stats.norm.pdf(x_p)
        
        ax4.plot(x_p, y_p, 'b-', linewidth=2.5)
        
        # 观测统计量
        ax4.axvline(Z_obs, color='r', linewidth=3, label=f'观测值Z={Z_obs}')
        ax4.axvline(-Z_obs, color='r', linewidth=3)
        
        # p值区域
        x_p_left = x_p[x_p < -Z_obs]
        ax4.fill_between(x_p_left, 0, stats.norm.pdf(x_p_left),
                        alpha=0.4, color='yellow', label='p值区域')
        
        x_p_right = x_p[x_p > Z_obs]
        ax4.fill_between(x_p_right, 0, stats.norm.pdf(x_p_right),
                        alpha=0.4, color='yellow')
        
        # 计算p值
        p_val = 2 * (1 - stats.norm.cdf(Z_obs))
        
        ax4.text(0, 0.2, f'p值 = {p_val:.4f}\n< α=0.05\n拒绝H₀',
                ha='center', fontsize=12,
                bbox=dict(boxstyle='round', facecolor='lightyellow', alpha=0.8))
        
        ax4.set_xlabel('Z值', fontsize=11)
        ax4.set_ylabel('概率密度', fontsize=11)
        ax4.set_title('p值的含义', fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('hypothesis_test_visualization.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("假设检验")
print("="*60)

ht = HypothesisTest(alpha=0.05)

# 1. 单样本t检验
print("1. 单样本t检验:")
print("  某机器生产零件，要求长度μ=50mm")
print("  抽样10个零件测量长度（mm）:")

X = np.array([50.2, 49.8, 50.5, 50.1, 49.9, 50.3, 50.0, 49.7, 50.4, 50.2])
print(f"  样本: {X}")

mu0 = 50
result_t = ht.t_test_one_sample(X, mu0)

print(f"\n  H₀: μ = {mu0}")
print(f"  H₁: μ ≠ {mu0}")
print(f"  样本均值 x̄ = {result_t['mean']:.3f} mm")
print(f"  样本标准差 s = {result_t['std']:.3f} mm")
print(f"  检验统计量 T = {result_t['statistic']:.3f}")
print(f"  自由度 df = {result_t['df']}")
print(f"  临界值 t₀.₀₂₅({result_t['df']}) = {result_t['critical_value']:.3f}")
print(f"  p值 = {result_t['p_value']:.4f}")
print(f"  结论: {'拒绝H₀' if result_t['reject_H0'] else '接受H₀'}")

if result_t['reject_H0']:
    print(f"  → 零件长度显著偏离标准值")
else:
    print(f"  → 零件长度符合要求")

# 2. 两独立样本t检验
print("\n" + "="*60)
print("2. 两独立样本t检验:")
print("  比较两种教学方法的效果")

method_A = np.array([85, 88, 90, 87, 92, 89, 91, 86])
method_B = np.array([78, 82, 80, 85, 81, 79, 83, 84])

print(f"  方法A成绩: {method_A}")
print(f"  方法B成绩: {method_B}")

result_2t = ht.t_test_two_sample(method_A, method_B)

print(f"\n  H₀: μ₁ = μ₂")
print(f"  H₁: μ₁ ≠ μ₂")
print(f"  均值差 x̄₁-x̄₂ = {result_2t['mean_diff']:.3f}")
print(f"  检验统计量 T = {result_2t['statistic']:.3f}")
print(f"  p值 = {result_2t['p_value']:.4f}")
print(f"  结论: {'拒绝H₀' if result_2t['reject_H0'] else '接受H₀'}")

if result_2t['reject_H0']:
    print(f"  → 两种方法效果有显著差异")
else:
    print(f"  → 两种方法效果无显著差异")

# 3. 配对样本t检验
print("\n" + "="*60)
print("3. 配对样本t检验:")
print("  减肥方法前后体重对比（kg）")

before = np.array([75, 80, 68, 90, 85, 78, 82, 88])
after = np.array([72, 77, 66, 87, 82, 75, 80, 85])

print(f"  减肥前: {before}")
print(f"  减肥后: {after}")

result_paired = ht.paired_t_test(before, after)

print(f"\n  H₀: μ_d = 0（无效果）")
print(f"  H₁: μ_d ≠ 0（有效果）")
print(f"  平均减重 = {result_paired['mean']:.3f} kg")
print(f"  检验统计量 T = {result_paired['statistic']:.3f}")
print(f"  p值 = {result_paired['p_value']:.4f}")
print(f"  结论: {'拒绝H₀' if result_paired['reject_H0'] else '接受H₀'}")

if result_paired['reject_H0']:
    print(f"  → 减肥方法有显著效果")
else:
    print(f"  → 减肥方法无显著效果")

# 4. F检验
print("\n" + "="*60)
print("4. 方差齐性检验（F检验）:")

sample1 = np.array([12, 15, 14, 13, 16, 14, 15])
sample2 = np.array([18, 22, 20, 25, 19, 21, 23, 24])

result_f = ht.f_test_variance(sample1, sample2)

print(f"  样本1方差: {np.var(sample1, ddof=1):.3f}")
print(f"  样本2方差: {np.var(sample2, ddof=1):.3f}")
print(f"  F统计量 = {result_f['statistic']:.3f}")
print(f"  p值 = {result_f['p_value']:.4f}")
print(f"  结论: {'拒绝H₀' if result_f['reject_H0'] else '接受H₀'}")

if result_f['reject_H0']:
    print(f"  → 两样本方差有显著差异")
else:
    print(f"  → 两样本方差无显著差异（方差齐性）")

# 绘图
print("\n绘制假设检验可视化图...")
ht.plot_hypothesis_test_visualization()
```

---

## 六、典型考题

### 【例题1】单样本t检验（12分）

**题目**：某品牌电池标称寿命$\mu_0=500$h。抽检9个电池，寿命（h）：
$$485, 510, 495, 505, 490, 500, 515, 492, 503$$

$\alpha=0.05$，检验是否符合标称。

**【解答】**

$$\bar{x} = \frac{485+510+\cdots+503}{9} = 499.44$$

$$s = \sqrt{\frac{\sum(x_i-\bar{x})^2}{9-1}} = 10.23$$

$$T = \frac{\bar{x} - \mu_0}{s/\sqrt{n}} = \frac{499.44-500}{10.23/3} = -0.164$$

$t_{0.025}(8) = 2.306$

$|T| = 0.164 < 2.306$，接受$H_0$

**结论**：符合标称寿命

---

**本章重点**：
- 假设检验五步骤
- t检验、Z检验、F检验
- 两类错误
- p值判断

**下一章**：方差分析
