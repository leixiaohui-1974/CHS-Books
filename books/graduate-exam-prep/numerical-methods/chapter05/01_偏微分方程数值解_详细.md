# 第5章：偏微分方程数值解

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、偏微分方程分类

### 1.1 三大类型

**抛物型**（扩散方程、热传导方程）：

$$\frac{\partial u}{\partial t} = a^2 \frac{\partial^2 u}{\partial x^2}$$

**双曲型**（波动方程）：

$$\frac{\partial^2 u}{\partial t^2} = a^2 \frac{\partial^2 u}{\partial x^2}$$

**椭圆型**（Laplace方程、Poisson方程）：

$$\frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2} = f(x, y)$$

---

### 1.2 定解条件

**初始条件**（$t=0$时）：$u(x, 0) = \phi(x)$

**边界条件**：
- **第一类**（Dirichlet）：$u|_{\partial \Omega} = g$
- **第二类**（Neumann）：$\frac{\partial u}{\partial n}\Big|_{\partial \Omega} = g$
- **第三类**（Robin）：$\alpha u + \beta \frac{\partial u}{\partial n}\Big|_{\partial \Omega} = g$

---

## 二、抛物型方程（一维热传导）

### 2.1 显式差分格式（向前Euler）

**标准方程**：
$$\frac{\partial u}{\partial t} = a^2 \frac{\partial^2 u}{\partial x^2}$$

**差分格式**：

$$\frac{u_i^{n+1} - u_i^n}{\Delta t} = a^2 \frac{u_{i+1}^n - 2u_i^n + u_{i-1}^n}{\Delta x^2}$$

**显式迭代公式**：

$$u_i^{n+1} = u_i^n + r(u_{i+1}^n - 2u_i^n + u_{i-1}^n)$$

**参数**：$r = \frac{a^2 \Delta t}{\Delta x^2}$（网格比）

**稳定性条件（CFL条件）**：

$$r \leq \frac{1}{2}$$

即：$\Delta t \leq \frac{\Delta x^2}{2a^2}$

---

### 2.2 隐式差分格式（向后Euler）

**差分格式**：

$$\frac{u_i^{n+1} - u_i^n}{\Delta t} = a^2 \frac{u_{i+1}^{n+1} - 2u_i^{n+1} + u_{i-1}^{n+1}}{\Delta x^2}$$

**整理**：

$$-r u_{i-1}^{n+1} + (1 + 2r)u_i^{n+1} - r u_{i+1}^{n+1} = u_i^n$$

**矩阵形式**：$Au^{n+1} = u^n$

**稳定性**：无条件稳定（$r$任意）

**优点**：稳定性好  
**缺点**：每步需解线性方程组

---

### 2.3 Crank-Nicolson格式（隐式中心）

**差分格式**（时间中心、空间中心）：

$$\frac{u_i^{n+1} - u_i^n}{\Delta t} = \frac{a^2}{2}\left(\frac{\partial^2 u}{\partial x^2}\Big|^{n+1} + \frac{\partial^2 u}{\partial x^2}\Big|^{n}\right)$$

**展开**：

$$-\frac{r}{2}u_{i-1}^{n+1} + (1 + r)u_i^{n+1} - \frac{r}{2}u_{i+1}^{n+1} = \frac{r}{2}u_{i-1}^{n} + (1 - r)u_i^{n} + \frac{r}{2}u_{i+1}^{n}$$

**稳定性**：无条件稳定  
**精度**：$O(\Delta t^2 + \Delta x^2)$

---

## 三、双曲型方程（一维波动）

### 3.1 显式中心差分

**标准方程**：
$$\frac{\partial^2 u}{\partial t^2} = a^2 \frac{\partial^2 u}{\partial x^2}$$

**差分格式**：

$$\frac{u_i^{n+1} - 2u_i^n + u_i^{n-1}}{\Delta t^2} = a^2 \frac{u_{i+1}^n - 2u_i^n + u_{i-1}^n}{\Delta x^2}$$

**显式公式**：

$$u_i^{n+1} = 2u_i^n - u_i^{n-1} + r^2(u_{i+1}^n - 2u_i^n + u_{i-1}^n)$$

其中$r = \frac{a\Delta t}{\Delta x}$

**稳定性条件（CFL条件）**：

$$r \leq 1 \quad \Rightarrow \quad \Delta t \leq \frac{\Delta x}{a}$$

**物理意义**：数值波速 ≥ 物理波速

---

### 3.2 初始条件处理

**第一层**（$n=0$）：$u_i^0 = \phi(x_i)$

**第二层**（$n=1$）：需特殊处理

$$\frac{\partial u}{\partial t}\Big|_{t=0} = \psi(x)$$

**中心差分**：

$$\frac{u_i^1 - u_i^{-1}}{2\Delta t} = \psi(x_i)$$

结合波动方程，得：

$$u_i^1 = u_i^0 + \Delta t \psi(x_i) + \frac{r^2}{2}(u_{i+1}^0 - 2u_i^0 + u_{i-1}^0)$$

---

## 四、椭圆型方程（二维Poisson方程）

### 4.1 五点差分格式

**Poisson方程**：

$$\frac{\partial^2 u}{\partial x^2} + \frac{\partial^2 u}{\partial y^2} = f(x, y)$$

**差分格式**（$h = \Delta x = \Delta y$）：

$$\frac{u_{i+1,j} - 2u_{i,j} + u_{i-1,j}}{h^2} + \frac{u_{i,j+1} - 2u_{i,j} + u_{i,j-1}}{h^2} = f_{i,j}$$

**整理**：

$$u_{i+1,j} + u_{i-1,j} + u_{i,j+1} + u_{i,j-1} - 4u_{i,j} = h^2 f_{i,j}$$

**Laplace方程**（$f=0$）：

$$u_{i,j} = \frac{1}{4}(u_{i+1,j} + u_{i-1,j} + u_{i,j+1} + u_{i,j-1})$$

**物理意义**：中心点的值是四个相邻点的平均

---

### 4.2 迭代求解

**Jacobi迭代**：

$$u_{i,j}^{(k+1)} = \frac{1}{4}(u_{i+1,j}^{(k)} + u_{i-1,j}^{(k)} + u_{i,j+1}^{(k)} + u_{i,j-1}^{(k)} - h^2 f_{i,j})$$

**Gauss-Seidel迭代**（利用最新值）：

$$u_{i,j}^{(k+1)} = \frac{1}{4}(u_{i+1,j}^{(k)} + u_{i-1,j}^{(k+1)} + u_{i,j+1}^{(k)} + u_{i,j-1}^{(k+1)} - h^2 f_{i,j})$$

**SOR迭代**（超松弛）：

$$u_{i,j}^{(k+1)} = (1-\omega)u_{i,j}^{(k)} + \frac{\omega}{4}(u_{i+1,j}^{(k)} + u_{i-1,j}^{(k+1)} + u_{i,j+1}^{(k)} + u_{i,j-1}^{(k+1)} - h^2 f_{i,j})$$

**松弛因子**：$\omega \in (1, 2)$，最优$\omega \approx \frac{2}{1 + \sin(\pi h)}$

---

## 五、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D

class PDESolver:
    """偏微分方程数值解"""
    
    @staticmethod
    def heat_equation_explicit(u0, a, L, T, nx, nt, bc_type='dirichlet'):
        """
        一维热传导方程（显式格式）
        
        ∂u/∂t = a²·∂²u/∂x²
        
        参数:
            u0: 初始条件函数
            a: 热扩散系数
            L: 空间长度
            T: 时间长度
            nx: 空间网格数
            nt: 时间网格数
            bc_type: 边界条件类型
        """
        dx = L / (nx - 1)
        dt = T / (nt - 1)
        
        r = a**2 * dt / dx**2
        
        # 稳定性检查
        if r > 0.5:
            print(f"警告：r={r:.4f} > 0.5，显式格式可能不稳定！")
        
        x = np.linspace(0, L, nx)
        u = np.zeros((nt, nx))
        
        # 初始条件
        u[0, :] = u0(x)
        
        # 时间推进
        for n in range(nt - 1):
            for i in range(1, nx - 1):
                u[n+1, i] = u[n, i] + r * (u[n, i+1] - 2*u[n, i] + u[n, i-1])
            
            # 边界条件
            if bc_type == 'dirichlet':
                u[n+1, 0] = 0
                u[n+1, -1] = 0
            elif bc_type == 'neumann':
                u[n+1, 0] = u[n+1, 1]
                u[n+1, -1] = u[n+1, -2]
        
        return x, np.linspace(0, T, nt), u
    
    @staticmethod
    def heat_equation_implicit(u0, a, L, T, nx, nt):
        """
        一维热传导方程（隐式格式）
        
        无条件稳定
        """
        dx = L / (nx - 1)
        dt = T / (nt - 1)
        
        r = a**2 * dt / dx**2
        
        x = np.linspace(0, L, nx)
        u = np.zeros((nt, nx))
        
        # 初始条件
        u[0, :] = u0(x)
        
        # 构造系数矩阵A
        A = np.zeros((nx, nx))
        A[0, 0] = 1
        A[-1, -1] = 1
        
        for i in range(1, nx - 1):
            A[i, i-1] = -r
            A[i, i] = 1 + 2*r
            A[i, i+1] = -r
        
        # 时间推进
        for n in range(nt - 1):
            b = u[n, :].copy()
            b[0] = 0  # 左边界
            b[-1] = 0  # 右边界
            
            u[n+1, :] = np.linalg.solve(A, b)
        
        return x, np.linspace(0, T, nt), u
    
    @staticmethod
    def heat_equation_crank_nicolson(u0, a, L, T, nx, nt):
        """
        一维热传导方程（Crank-Nicolson格式）
        
        无条件稳定，二阶精度
        """
        dx = L / (nx - 1)
        dt = T / (nt - 1)
        
        r = a**2 * dt / dx**2
        
        x = np.linspace(0, L, nx)
        u = np.zeros((nt, nx))
        
        # 初始条件
        u[0, :] = u0(x)
        
        # 左侧系数矩阵A
        A = np.zeros((nx, nx))
        A[0, 0] = 1
        A[-1, -1] = 1
        
        for i in range(1, nx - 1):
            A[i, i-1] = -r / 2
            A[i, i] = 1 + r
            A[i, i+1] = -r / 2
        
        # 右侧系数矩阵B
        B = np.zeros((nx, nx))
        B[0, 0] = 1
        B[-1, -1] = 1
        
        for i in range(1, nx - 1):
            B[i, i-1] = r / 2
            B[i, i] = 1 - r
            B[i, i+1] = r / 2
        
        # 时间推进
        for n in range(nt - 1):
            b_vec = B @ u[n, :]
            b_vec[0] = 0
            b_vec[-1] = 0
            
            u[n+1, :] = np.linalg.solve(A, b_vec)
        
        return x, np.linspace(0, T, nt), u
    
    @staticmethod
    def wave_equation_explicit(u0, du0_dt, a, L, T, nx, nt):
        """
        一维波动方程（显式格式）
        
        ∂²u/∂t² = a²·∂²u/∂x²
        
        参数:
            u0: 初始位移
            du0_dt: 初始速度
            a: 波速
        """
        dx = L / (nx - 1)
        dt = T / (nt - 1)
        
        r = a * dt / dx
        
        # 稳定性检查
        if r > 1:
            print(f"警告：r={r:.4f} > 1，显式格式不稳定！")
        
        x = np.linspace(0, L, nx)
        u = np.zeros((nt, nx))
        
        # 第一层
        u[0, :] = u0(x)
        
        # 第二层（特殊处理）
        for i in range(1, nx - 1):
            u[1, i] = u[0, i] + dt * du0_dt(x[i]) + \
                      0.5 * r**2 * (u[0, i+1] - 2*u[0, i] + u[0, i-1])
        
        u[1, 0] = 0
        u[1, -1] = 0
        
        # 时间推进
        for n in range(1, nt - 1):
            for i in range(1, nx - 1):
                u[n+1, i] = 2*u[n, i] - u[n-1, i] + \
                           r**2 * (u[n, i+1] - 2*u[n, i] + u[n, i-1])
            
            u[n+1, 0] = 0
            u[n+1, -1] = 0
        
        return x, np.linspace(0, T, nt), u
    
    @staticmethod
    def poisson_equation_jacobi(f, L_x, L_y, nx, ny, tol=1e-6, max_iter=10000):
        """
        二维Poisson方程（Jacobi迭代）
        
        ∂²u/∂x² + ∂²u/∂y² = f(x,y)
        
        边界条件：u=0（Dirichlet）
        """
        hx = L_x / (nx - 1)
        hy = L_y / (ny - 1)
        
        x = np.linspace(0, L_x, nx)
        y = np.linspace(0, L_y, ny)
        X, Y = np.meshgrid(x, y)
        
        u = np.zeros((ny, nx))
        u_new = u.copy()
        
        # 右端项
        F = f(X, Y) * hx**2  # 假设hx=hy
        
        # Jacobi迭代
        for iter_count in range(max_iter):
            for i in range(1, ny - 1):
                for j in range(1, nx - 1):
                    u_new[i, j] = 0.25 * (u[i+1, j] + u[i-1, j] + u[i, j+1] + u[i, j-1] - F[i, j])
            
            # 检查收敛
            error = np.max(np.abs(u_new - u))
            
            if error < tol:
                print(f"Jacobi迭代收敛，迭代次数={iter_count}")
                return X, Y, u_new
            
            u = u_new.copy()
        
        print(f"警告：达到最大迭代次数{max_iter}")
        return X, Y, u_new
    
    @staticmethod
    def plot_pde_solutions():
        """绘制PDE解的对比"""
        fig = plt.figure(figsize=(18, 12))
        
        # 1. 热传导方程（不同格式对比）
        ax1 = fig.add_subplot(2, 3, 1)
        
        def u0_heat(x):
            return np.sin(np.pi * x)
        
        a = 0.1
        L = 1.0
        T = 0.5
        nx = 21
        nt = 501
        
        x, t, u_explicit = PDESolver.heat_equation_explicit(u0_heat, a, L, T, nx, nt)
        
        t_snapshots = [0, int(nt*0.25), int(nt*0.5), int(nt*0.75), nt-1]
        colors = plt.cm.coolwarm(np.linspace(0, 1, len(t_snapshots)))
        
        for idx, color in zip(t_snapshots, colors):
            ax1.plot(x, u_explicit[idx, :], color=color, linewidth=2, label=f't={t[idx]:.2f}')
        
        ax1.set_xlabel('x', fontsize=11)
        ax1.set_ylabel('u(x,t)', fontsize=11)
        ax1.set_title('热传导方程（显式格式）', fontsize=13, fontweight='bold')
        ax1.legend(fontsize=9)
        ax1.grid(True, alpha=0.3)
        
        # 2. 热传导方程时空图
        ax2 = fig.add_subplot(2, 3, 2, projection='3d')
        
        X_heat, T_heat = np.meshgrid(x, t)
        surf = ax2.plot_surface(X_heat, T_heat, u_explicit, cmap='viridis', alpha=0.8)
        
        ax2.set_xlabel('x', fontsize=10)
        ax2.set_ylabel('t', fontsize=10)
        ax2.set_zlabel('u', fontsize=10)
        ax2.set_title('热传导方程3D视图', fontsize=12, fontweight='bold')
        
        # 3. 波动方程
        ax3 = fig.add_subplot(2, 3, 3)
        
        def u0_wave(x):
            return np.exp(-100 * (x - 0.5)**2)
        
        def du0_dt_wave(x):
            return np.zeros_like(x)
        
        a_wave = 1.0
        L_wave = 1.0
        T_wave = 1.0
        nx_wave = 101
        nt_wave = 101
        
        x_wave, t_wave, u_wave = PDESolver.wave_equation_explicit(
            u0_wave, du0_dt_wave, a_wave, L_wave, T_wave, nx_wave, nt_wave)
        
        t_snapshots_wave = [0, 25, 50, 75, 100]
        colors_wave = plt.cm.plasma(np.linspace(0, 1, len(t_snapshots_wave)))
        
        for idx, color in zip(t_snapshots_wave, colors_wave):
            ax3.plot(x_wave, u_wave[idx, :], color=color, linewidth=2, label=f't={t_wave[idx]:.2f}')
        
        ax3.set_xlabel('x', fontsize=11)
        ax3.set_ylabel('u(x,t)', fontsize=11)
        ax3.set_title('波动方程（显式格式）', fontsize=13, fontweight='bold')
        ax3.legend(fontsize=9)
        ax3.grid(True, alpha=0.3)
        
        # 4. 波动方程时空图
        ax4 = fig.add_subplot(2, 3, 4, projection='3d')
        
        X_wave, T_wave_mesh = np.meshgrid(x_wave, t_wave)
        surf_wave = ax4.plot_surface(X_wave, T_wave_mesh, u_wave, cmap='plasma', alpha=0.8)
        
        ax4.set_xlabel('x', fontsize=10)
        ax4.set_ylabel('t', fontsize=10)
        ax4.set_zlabel('u', fontsize=10)
        ax4.set_title('波动方程3D视图', fontsize=12, fontweight='bold')
        
        # 5. Poisson方程
        ax5 = fig.add_subplot(2, 3, 5)
        
        def f_poisson(X, Y):
            return -2 * np.pi**2 * np.sin(np.pi * X) * np.sin(np.pi * Y)
        
        L_x = 1.0
        L_y = 1.0
        nx_p = 31
        ny_p = 31
        
        X_p, Y_p, u_p = PDESolver.poisson_equation_jacobi(f_poisson, L_x, L_y, nx_p, ny_p, tol=1e-4)
        
        contour = ax5.contourf(X_p, Y_p, u_p, levels=20, cmap='RdBu_r')
        plt.colorbar(contour, ax=ax5)
        
        ax5.set_xlabel('x', fontsize=11)
        ax5.set_ylabel('y', fontsize=11)
        ax5.set_title('Poisson方程（Jacobi迭代）', fontsize=13, fontweight='bold')
        
        # 6. Poisson方程3D
        ax6 = fig.add_subplot(2, 3, 6, projection='3d')
        
        surf_p = ax6.plot_surface(X_p, Y_p, u_p, cmap='RdBu_r', alpha=0.9)
        
        ax6.set_xlabel('x', fontsize=10)
        ax6.set_ylabel('y', fontsize=10)
        ax6.set_zlabel('u', fontsize=10)
        ax6.set_title('Poisson方程3D视图', fontsize=12, fontweight='bold')
        
        plt.tight_layout()
        plt.savefig('pde_numerical_solutions.png', dpi=300, bbox_inches='tight')
        plt.show()

# 示例1：热传导方程（显式vs隐式vs CN）
print("="*60)
print("示例1：热传导方程 - 不同格式对比")
print("="*60)

def u0(x):
    return np.sin(np.pi * x)

a = 0.1
L = 1.0
T = 0.1
nx = 21
nt = 101

dx = L / (nx - 1)
dt = T / (nt - 1)
r = a**2 * dt / dx**2

print(f"参数设置:")
print(f"  热扩散系数 a = {a}")
print(f"  空间长度 L = {L}")
print(f"  时间长度 T = {T}")
print(f"  空间网格数 nx = {nx}")
print(f"  时间网格数 nt = {nt}")
print(f"  dx = {dx:.4f}, dt = {dt:.4f}")
print(f"  网格比 r = a²Δt/Δx² = {r:.4f}")

print(f"\n稳定性分析:")
if r <= 0.5:
    print(f"  ✓ r ≤ 0.5，显式格式稳定")
else:
    print(f"  ✗ r > 0.5，显式格式不稳定")

x_ex, t_ex, u_ex = PDESolver.heat_equation_explicit(u0, a, L, T, nx, nt)
x_im, t_im, u_im = PDESolver.heat_equation_implicit(u0, a, L, T, nx, nt)
x_cn, t_cn, u_cn = PDESolver.heat_equation_crank_nicolson(u0, a, L, T, nx, nt)

print(f"\n最终时刻（t={T}）最大值:")
print(f"  显式格式: {np.max(u_ex[-1, :]):.6f}")
print(f"  隐式格式: {np.max(u_im[-1, :]):.6f}")
print(f"  CN格式: {np.max(u_cn[-1, :]):.6f}")

# 示例2：波动方程
print("\n" + "="*60)
print("示例2：波动方程")
print("="*60)

def u0_wave(x):
    return np.sin(2 * np.pi * x)

def du0_dt_wave(x):
    return np.zeros_like(x)

a_wave = 1.0
L_wave = 1.0
T_wave = 0.5
nx_wave = 51
nt_wave = 51

dx_wave = L_wave / (nx_wave - 1)
dt_wave = T_wave / (nt_wave - 1)
r_wave = a_wave * dt_wave / dx_wave

print(f"参数设置:")
print(f"  波速 a = {a_wave}")
print(f"  dx = {dx_wave:.4f}, dt = {dt_wave:.4f}")
print(f"  CFL数 r = aΔt/Δx = {r_wave:.4f}")

print(f"\n稳定性分析:")
if r_wave <= 1:
    print(f"  ✓ r ≤ 1，显式格式稳定")
else:
    print(f"  ✗ r > 1，显式格式不稳定")

x_wave, t_wave, u_wave = PDESolver.wave_equation_explicit(
    u0_wave, du0_dt_wave, a_wave, L_wave, T_wave, nx_wave, nt_wave)

print(f"\n波形传播:")
print(f"  初始最大值: {np.max(u_wave[0, :]):.6f}")
print(f"  中间时刻最大值: {np.max(u_wave[nt_wave//2, :]):.6f}")
print(f"  最终时刻最大值: {np.max(u_wave[-1, :]):.6f}")

# 示例3：Poisson方程
print("\n" + "="*60)
print("示例3：Poisson方程（Jacobi迭代）")
print("="*60)

def f_poisson(X, Y):
    return -2 * np.pi**2 * np.sin(np.pi * X) * np.sin(np.pi * Y)

L_x = 1.0
L_y = 1.0
nx_p = 21
ny_p = 21

print(f"参数设置:")
print(f"  区域: [0, {L_x}] × [0, {L_y}]")
print(f"  网格: {nx_p} × {ny_p}")

X_p, Y_p, u_p = PDESolver.poisson_equation_jacobi(f_poisson, L_x, L_y, nx_p, ny_p, tol=1e-4, max_iter=5000)

print(f"\n解的特征:")
print(f"  最大值: {np.max(u_p):.6f}")
print(f"  最小值: {np.min(u_p):.6f}")
print(f"  中心点: u({L_x/2:.2f}, {L_y/2:.2f}) = {u_p[ny_p//2, nx_p//2]:.6f}")

# 绘制PDE解
print("\n绘制偏微分方程数值解...")
PDESolver.plot_pde_solutions()
```

---

## 六、典型考题

### 【例题1】稳定性判断（10分）

**题目**：热传导方程，$a=0.1$，$\Delta x=0.1$，用显式格式。求稳定的最大时间步长。

**【解答】**

稳定性条件：$r = \frac{a^2 \Delta t}{\Delta x^2} \leq 0.5$

$$\Delta t \leq \frac{0.5 \Delta x^2}{a^2} = \frac{0.5 \times 0.01}{0.01} = 0.5 \text{ s}$$

---

### 【例题2】波动方程CFL条件（12分）

**题目**：波速$a=2$m/s，$\Delta x=0.05$m。求稳定的最大时间步长。

**【解答】**

CFL条件：$r = \frac{a\Delta t}{\Delta x} \leq 1$

$$\Delta t \leq \frac{\Delta x}{a} = \frac{0.05}{2} = 0.025 \text{ s}$$

---

**本章重点**：
- 抛物型方程（显式/隐式/CN格式）
- 双曲型方程（CFL条件）
- 椭圆型方程（迭代法）
- 稳定性分析

**全书完成！**
