# 第2章：插值与拟合

**应用**: 数据处理、曲线重构  
**工具**: NumPy, SciPy

---

## 一、插值方法

### 1.1 拉格朗日插值

**n次多项式通过n+1个点**

$$L_n(x) = \sum_{i=0}^{n} y_i \prod_{j=0, j\neq i}^{n} \frac{x - x_j}{x_i - x_j}$$

**优点**：简单直观  
**缺点**：增加节点需重算

### 1.2 牛顿插值

**差商递推**：

$$f[x_0, x_1, \ldots, x_k] = \frac{f[x_1, \ldots, x_k] - f[x_0, \ldots, x_{k-1}]}{x_k - x_0}$$

**牛顿插值多项式**：
$$N_n(x) = f(x_0) + \sum_{k=1}^{n} f[x_0, \ldots, x_k] \prod_{i=0}^{k-1}(x - x_i)$$

**优点**：增加节点方便

### 1.3 三次样条插值

**每段三次多项式**，满足：
1. 通过所有节点
2. 一阶导数连续
3. 二阶导数连续

**边界条件**：
- 自然边界：$S''(x_0) = S''(x_n) = 0$
- 固定边界：给定$S'(x_0), S'(x_n)$

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import lagrange, CubicSpline, interp1d
from scipy.optimize import curve_fit

class InterpolationFitting:
    """插值与拟合"""
    
    @staticmethod
    def lagrange_interp(x_data, y_data, x_interp):
        """
        拉格朗日插值
        
        参数:
            x_data: 已知点x坐标
            y_data: 已知点y坐标
            x_interp: 插值点
        """
        poly = lagrange(x_data, y_data)
        y_interp = poly(x_interp)
        
        return y_interp, poly
    
    @staticmethod
    def newton_divided_diff(x_data, y_data):
        """
        牛顿差商表
        
        返回:
            差商表（上三角矩阵）
        """
        n = len(x_data)
        table = np.zeros((n, n))
        table[:, 0] = y_data
        
        for j in range(1, n):
            for i in range(n - j):
                table[i, j] = (table[i+1, j-1] - table[i, j-1]) / \
                             (x_data[i+j] - x_data[i])
        
        return table
    
    @staticmethod
    def newton_interp(x_data, y_data, x_interp):
        """牛顿插值"""
        table = InterpolationFitting.newton_divided_diff(x_data, y_data)
        
        n = len(x_data)
        y_interp = np.zeros_like(x_interp)
        
        for i, x in enumerate(x_interp):
            result = table[0, 0]
            prod = 1.0
            
            for j in range(1, n):
                prod *= (x - x_data[j-1])
                result += table[0, j] * prod
            
            y_interp[i] = result
        
        return y_interp
    
    @staticmethod
    def cubic_spline_interp(x_data, y_data, x_interp, bc_type='natural'):
        """
        三次样条插值
        
        bc_type: 'natural', 'clamped', 'not-a-knot'
        """
        cs = CubicSpline(x_data, y_data, bc_type=bc_type)
        y_interp = cs(x_interp)
        
        return y_interp, cs
    
    @staticmethod
    def least_squares_fit(x_data, y_data, degree=1):
        """
        最小二乘法拟合多项式
        
        参数:
            degree: 多项式次数
        """
        coeffs = np.polyfit(x_data, y_data, degree)
        poly = np.poly1d(coeffs)
        
        # 残差
        y_fit = poly(x_data)
        residuals = y_data - y_fit
        sse = np.sum(residuals**2)
        
        # R²
        ss_tot = np.sum((y_data - np.mean(y_data))**2)
        r_squared = 1 - (sse / ss_tot)
        
        return poly, coeffs, r_squared
    
    @staticmethod
    def plot_interpolation_comparison(x_data, y_data):
        """对比不同插值方法"""
        x_interp = np.linspace(x_data[0], x_data[-1], 200)
        
        # 拉格朗日
        y_lagrange, _ = InterpolationFitting.lagrange_interp(
            x_data, y_data, x_interp
        )
        
        # 三次样条
        y_spline, _ = InterpolationFitting.cubic_spline_interp(
            x_data, y_data, x_interp
        )
        
        # 线性
        f_linear = interp1d(x_data, y_data, kind='linear')
        y_linear = f_linear(x_interp)
        
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))
        
        # 拉格朗日
        axes[0, 0].plot(x_interp, y_lagrange, 'b-', linewidth=2,
                       label='拉格朗日插值')
        axes[0, 0].plot(x_data, y_data, 'ro', markersize=8,
                       label='数据点')
        axes[0, 0].set_xlabel('x', fontsize=12)
        axes[0, 0].set_ylabel('y', fontsize=12)
        axes[0, 0].set_title('拉格朗日插值', fontsize=14)
        axes[0, 0].legend()
        axes[0, 0].grid(True, alpha=0.3)
        
        # 三次样条
        axes[0, 1].plot(x_interp, y_spline, 'g-', linewidth=2,
                       label='三次样条')
        axes[0, 1].plot(x_data, y_data, 'ro', markersize=8,
                       label='数据点')
        axes[0, 1].set_xlabel('x', fontsize=12)
        axes[0, 1].set_ylabel('y', fontsize=12)
        axes[0, 1].set_title('三次样条插值', fontsize=14)
        axes[0, 1].legend()
        axes[0, 1].grid(True, alpha=0.3)
        
        # 线性
        axes[1, 0].plot(x_interp, y_linear, 'm-', linewidth=2,
                       label='线性插值')
        axes[1, 0].plot(x_data, y_data, 'ro', markersize=8,
                       label='数据点')
        axes[1, 0].set_xlabel('x', fontsize=12)
        axes[1, 0].set_ylabel('y', fontsize=12)
        axes[1, 0].set_title('线性插值', fontsize=14)
        axes[1, 0].legend()
        axes[1, 0].grid(True, alpha=0.3)
        
        # 对比
        axes[1, 1].plot(x_interp, y_lagrange, 'b-', linewidth=1.5,
                       label='拉格朗日', alpha=0.7)
        axes[1, 1].plot(x_interp, y_spline, 'g-', linewidth=1.5,
                       label='三次样条', alpha=0.7)
        axes[1, 1].plot(x_interp, y_linear, 'm-', linewidth=1.5,
                       label='线性', alpha=0.7)
        axes[1, 1].plot(x_data, y_data, 'ro', markersize=8,
                       label='数据点')
        axes[1, 1].set_xlabel('x', fontsize=12)
        axes[1, 1].set_ylabel('y', fontsize=12)
        axes[1, 1].set_title('方法对比', fontsize=14)
        axes[1, 1].legend()
        axes[1, 1].grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('interpolation_comparison.png', dpi=300)
        plt.show()

# 示例1：插值对比
print("="*60)
print("示例1：插值方法对比")
print("="*60)

# 数据点（Runge现象的例子）
x_data = np.array([-5, -3, -1, 0, 1, 3, 5])
y_data = 1 / (1 + x_data**2)

print(f"数据点:")
for x, y in zip(x_data, y_data):
    print(f"  ({x:6.2f}, {y:6.4f})")

# 可视化对比
InterpolationFitting.plot_interpolation_comparison(x_data, y_data)

# 示例2：最小二乘拟合
print("\n" + "="*60)
print("示例2：最小二乘法拟合")
print("="*60)

# 生成带噪声的数据
x_fit = np.linspace(0, 10, 20)
y_true = 2 * x_fit + 1
y_fit = y_true + np.random.normal(0, 1, len(x_fit))

# 不同次数拟合
degrees = [1, 2, 3]

fig, axes = plt.subplots(1, 3, figsize=(15, 5))

for idx, deg in enumerate(degrees):
    poly, coeffs, r2 = InterpolationFitting.least_squares_fit(
        x_fit, y_fit, degree=deg
    )
    
    x_plot = np.linspace(0, 10, 200)
    y_plot = poly(x_plot)
    
    axes[idx].plot(x_fit, y_fit, 'ro', markersize=6,
                  label='数据点')
    axes[idx].plot(x_plot, y_plot, 'b-', linewidth=2,
                  label=f'{deg}次拟合 (R²={r2:.4f})')
    axes[idx].set_xlabel('x', fontsize=12)
    axes[idx].set_ylabel('y', fontsize=12)
    axes[idx].set_title(f'{deg}次多项式拟合', fontsize=14)
    axes[idx].legend()
    axes[idx].grid(True, alpha=0.3)
    
    print(f"\n{deg}次拟合:")
    print(f"  系数: {coeffs}")
    print(f"  R² = {r2:.6f}")

plt.tight_layout()
plt.savefig('least_squares_fitting.png', dpi=300)
plt.show()
```

---

## 二、最小二乘法

### 2.1 线性拟合

拟合$y = ax + b$，最小化：
$$\min \sum_{i=1}^{n}(y_i - ax_i - b)^2$$

**正规方程**：
$$\begin{bmatrix} n & \sum x_i \\ \sum x_i & \sum x_i^2 \end{bmatrix} \begin{bmatrix} b \\ a \end{bmatrix} = \begin{bmatrix} \sum y_i \\ \sum x_i y_i \end{bmatrix}$$

### 2.2 多项式拟合

拟合$y = a_0 + a_1 x + \cdots + a_m x^m$

### 2.3 评价指标

**决定系数**$R^2$：
$$R^2 = 1 - \frac{SS_{res}}{SS_{tot}}$$

$R^2 \to 1$：拟合好

---

## 三、典型考题

### 【例题】插值计算

**题目**：已知$(0,0), (1,1), (2,0)$，用二次插值求$f(0.5)$

**解**：拉格朗日插值

$$L_2(0.5) = 0 \cdot \frac{(0.5-1)(0.5-2)}{(0-1)(0-2)} + 1 \cdot \frac{(0.5-0)(0.5-2)}{(1-0)(1-2)} + 0$$

$$= \frac{(0.5)(-1.5)}{2} = -0.375$$

---

**本章重点**：
- 拉格朗日插值
- 三次样条
- 最小二乘法
- Runge现象
