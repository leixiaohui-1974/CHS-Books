# 第1章：水资源系统工程

**交叉学科**: 水文学 + 系统工程 + 优化理论  
**重要性**: ⭐⭐⭐⭐⭐

---

## 一、水资源系统概念

### 1.1 系统组成

```
自然水循环
    ↓
水资源供给 → 需求 → 配置 → 调度
    ↓         ↓       ↓       ↓
 地表水    农业    优化    实时
 地下水    工业    模型    调整
 非常规    生活
    ↓
系统反馈与调控
```

### 1.2 特征

1. **多目标性**：防洪、供水、发电、生态
2. **不确定性**：径流随机性
3. **多层次性**：流域-区域-单元
4. **复杂性**：自然+社会+经济

---

## 二、水资源配置

### 2.1 配置原则

1. **总量控制**：不超过可用量
2. **优先顺序**：生活>生态>生产
3. **效益最大**：经济+社会+生态
4. **可持续**：代际公平

### 2.2 配置模型

**目标函数**（最大化效益）：
$$\max Z = \sum_{i=1}^n \sum_{j=1}^m b_{ij} x_{ij}$$

**约束条件**：

*水量约束*：
$$\sum_{j=1}^m x_{ij} \leq W_i \quad \forall i$$

*需求约束*：
$$\sum_{i=1}^n x_{ij} \geq D_j \quad \forall j$$

*非负约束*：
$$x_{ij} \geq 0$$

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import linprog

class WaterResourcesAllocation:
    """水资源配置优化"""
    
    def __init__(self):
        pass
    
    def linear_programming(self, benefits, water_supply, water_demand):
        """
        线性规划求解水资源配置
        
        参数:
            benefits: 效益系数矩阵 (n_sources × n_users)
            water_supply: 各水源可供水量 (n_sources,)
            water_demand: 各用户需水量 (n_users,)
        
        返回:
            最优配置方案
        """
        n_sources, n_users = benefits.shape
        
        # 目标函数（最大化，所以取负）
        c = -benefits.flatten()
        
        # 约束条件
        # 1. 水源供水约束: Σx_ij ≤ W_i
        A_supply = np.zeros((n_sources, n_sources * n_users))
        for i in range(n_sources):
            for j in range(n_users):
                A_supply[i, i*n_users + j] = 1
        b_supply = water_supply
        
        # 2. 用户需水约束: Σx_ij ≥ D_j (转化为 -Σx_ij ≤ -D_j)
        A_demand = np.zeros((n_users, n_sources * n_users))
        for j in range(n_users):
            for i in range(n_sources):
                A_demand[j, i*n_users + j] = -1
        b_demand = -water_demand
        
        # 合并约束
        A_ub = np.vstack([A_supply, A_demand])
        b_ub = np.hstack([b_supply, b_demand])
        
        # 求解
        result = linprog(c, A_ub=A_ub, b_ub=b_ub, 
                        bounds=(0, None), method='highs')
        
        if result.success:
            allocation = result.x.reshape(n_sources, n_users)
            return allocation, -result.fun
        else:
            return None, None
    
    def plot_allocation(self, allocation, sources, users):
        """绘制配置方案"""
        fig, axes = plt.subplots(1, 2, figsize=(14, 6))
        
        # 热力图
        im = axes[0].imshow(allocation, cmap='Blues', aspect='auto')
        axes[0].set_xticks(range(len(users)))
        axes[0].set_yticks(range(len(sources)))
        axes[0].set_xticklabels(users)
        axes[0].set_yticklabels(sources)
        axes[0].set_xlabel('用户', fontsize=12)
        axes[0].set_ylabel('水源', fontsize=12)
        axes[0].set_title('水资源配置方案（万m³）', fontsize=14)
        
        # 标注数值
        for i in range(len(sources)):
            for j in range(len(users)):
                text = axes[0].text(j, i, f'{allocation[i,j]:.1f}',
                                   ha="center", va="center", color="black")
        
        plt.colorbar(im, ax=axes[0])
        
        # 供需对比
        x = np.arange(len(users))
        width = 0.35
        
        allocated = allocation.sum(axis=0)
        
        axes[1].bar(x - width/2, allocated, width, 
                   label='实际配水', alpha=0.8)
        axes[1].set_xlabel('用户', fontsize=12)
        axes[1].set_ylabel('水量（万m³）', fontsize=12)
        axes[1].set_title('各用户配水量', fontsize=14)
        axes[1].set_xticks(x)
        axes[1].set_xticklabels(users)
        axes[1].legend()
        axes[1].grid(True, alpha=0.3, axis='y')
        
        plt.tight_layout()
        plt.savefig('water_allocation.png', dpi=300)
        plt.show()

# 示例
print("="*60)
print("水资源配置优化")
print("="*60)

# 问题设置
sources = ['地表水', '地下水', '再生水']
users = ['农业', '工业', '生活', '生态']

# 效益系数（元/m³）
benefits = np.array([
    [1.5, 5.0, 8.0, 2.0],  # 地表水
    [1.2, 4.5, 7.0, 1.8],  # 地下水
    [0.8, 3.0, 3.5, 2.5]   # 再生水
])

# 可供水量（万m³）
water_supply = np.array([5000, 2000, 1000])

# 需水量（万m³）
water_demand = np.array([4000, 1500, 800, 500])

print("问题参数:")
print(f"  水源: {sources}")
print(f"  用户: {users}")
print(f"\n可供水量（万m³）:")
for i, source in enumerate(sources):
    print(f"  {source}: {water_supply[i]}")

print(f"\n需水量（万m³）:")
for j, user in enumerate(users):
    print(f"  {user}: {water_demand[j]}")

# 求解
allocator = WaterResourcesAllocation()
allocation, max_benefit = allocator.linear_programming(
    benefits, water_supply, water_demand
)

if allocation is not None:
    print(f"\n" + "="*60)
    print("优化结果")
    print("="*60)
    
    print(f"\n最大总效益: {max_benefit:.2f} 万元")
    
    print(f"\n配置方案（万m³）:")
    print(f"{'':12s}", end='')
    for user in users:
        print(f"{user:>10s}", end='')
    print()
    
    for i, source in enumerate(sources):
        print(f"{source:12s}", end='')
        for j in range(len(users)):
            print(f"{allocation[i,j]:10.1f}", end='')
        print(f"  合计: {allocation[i,:].sum():.1f}")
    
    print(f"{'总计':12s}", end='')
    for j in range(len(users)):
        print(f"{allocation[:,j].sum():10.1f}", end='')
    print()
    
    # 检查约束
    print(f"\n约束检查:")
    print(f"  水源供给:")
    for i, source in enumerate(sources):
        used = allocation[i,:].sum()
        available = water_supply[i]
        print(f"    {source}: {used:.1f}/{available:.1f} " + 
              f"({used/available*100:.1f}%)")
    
    print(f"  用户需求:")
    for j, user in enumerate(users):
        supplied = allocation[:,j].sum()
        demand = water_demand[j]
        print(f"    {user}: {supplied:.1f}/{demand:.1f} " +
              f"({supplied/demand*100:.1f}%)")
    
    # 可视化
    allocator.plot_allocation(allocation, sources, users)
else:
    print("无可行解")
```

---

## 三、水库优化调度

### 3.1 调度目标

1. **防洪**：满足防洪要求
2. **兴利**：最大化发电/供水效益
3. **生态**：保证生态流量

### 3.2 动态规划

**状态方程**：
$$V_{t+1} = V_t + I_t - R_t - E_t$$

**目标函数**：
$$\max \sum_{t=1}^T B(R_t, H_t)$$

**约束**：
- $V_{min} \leq V_t \leq V_{max}$
- $R_{min} \leq R_t \leq R_{max}$
- $H_t = f(V_t)$（水位-库容关系）

---

## 四、区域水资源承载力

### 4.1 定义

一定时期内，区域水资源能够支撑的人口规模、经济规模和生态需求

### 4.2 评价指标

| 指标 | 阈值 | 状态 |
|------|------|------|
| 水资源开发利用率 | <40% | 可承载 |
|  | 40-60% | 临界 |
|  | >60% | 超载 |
| 人均水资源量 | >1700m³ | 充足 |
|  | 1000-1700 | 中等 |
|  | <1000 | 缺水 |

---

## 五、典型考题

### 【例题】水资源配置

**题目**：(20分)

某地区有地表水3000万m³，地下水1000万m³。农业需水2000万m³，工业需水1500万m³，生活需水800万m³。已知：
- 地表水供农业效益2元/m³，供工业5元/m³，供生活8元/m³
- 地下水供农业1元/m³，供工业4元/m³，供生活7元/m³

求最优配置方案。

**【解答】**

建立线性规划模型：

设$x_{ij}$为水源$i$供给用户$j$的水量

**目标函数**：
$$\max Z = 2x_{11} + 5x_{12} + 8x_{13} + 1x_{21} + 4x_{22} + 7x_{23}$$

**约束**：
$$x_{11} + x_{12} + x_{13} \leq 3000$$
$$x_{21} + x_{22} + x_{23} \leq 1000$$
$$x_{11} + x_{21} \geq 2000$$
$$x_{12} + x_{22} \geq 1500$$
$$x_{13} + x_{23} \geq 800$$
$$x_{ij} \geq 0$$

用单纯形法或软件求解得：
- 地表水：农业700，工业1500，生活800
- 地下水：农业1000，工业0，生活0

**总效益**：19900万元

---

**本章重点**：
- 水资源配置模型
- 线性规划
- 动态规划
- 承载力评价
