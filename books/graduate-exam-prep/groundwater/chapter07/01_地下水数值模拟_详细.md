# 第7章：地下水数值模拟

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、数值模拟基础

### 1.1 控制方程

**三维非稳定流**：

$$\frac{\partial}{\partial x}\left(K_x \frac{\partial h}{\partial x}\right) + \frac{\partial}{\partial y}\left(K_y \frac{\partial h}{\partial y}\right) + \frac{\partial}{\partial z}\left(K_z \frac{\partial h}{\partial z}\right) + W = S_s \frac{\partial h}{\partial t}$$

**二维承压-潜水**：

$$\frac{\partial}{\partial x}\left(T \frac{\partial h}{\partial x}\right) + \frac{\partial}{\partial y}\left(T \frac{\partial h}{\partial y}\right) + W = S \frac{\partial h}{\partial t}$$

**参数**：
- $K$：渗透系数（m/d）
- $T = Kb$：导水系数（m²/d）
- $S_s$：贮水系数（1/m）
- $S$：释水系数/贮水系数
- $W$：源汇项（1/d）

### 1.2 边界条件

**(1) 第一类边界**（Dirichlet）：

$$h|_{\Gamma_1} = h_0(x,y,t)$$

**(2) 第二类边界**（Neumann）：

$$-K\frac{\partial h}{\partial n}\bigg|_{\Gamma_2} = q_n$$

**(3) 第三类边界**（Cauchy）：

$$-K\frac{\partial h}{\partial n}\bigg|_{\Gamma_3} = \alpha(h - h_e)$$

---

## 二、有限差分法（FDM）

### 2.1 网格剖分

**空间步长**：$\Delta x$, $\Delta y$

**时间步长**：$\Delta t$

**网格节点**：$(i,j,k)$

### 2.2 差分格式

**二阶中心差分**：

$$\frac{\partial^2 h}{\partial x^2} \approx \frac{h_{i+1,j} - 2h_{i,j} + h_{i-1,j}}{(\Delta x)^2}$$

**前向差分**（时间）：

$$\frac{\partial h}{\partial t} \approx \frac{h_{i,j}^{n+1} - h_{i,j}^n}{\Delta t}$$

### 2.3 二维稳态方程离散

**拉普拉斯方程**：

$$\frac{\partial^2 h}{\partial x^2} + \frac{\partial^2 h}{\partial y^2} = 0$$

**五点差分格式**：

$$\frac{h_{i+1,j} - 2h_{i,j} + h_{i-1,j}}{(\Delta x)^2} + \frac{h_{i,j+1} - 2h_{i,j} + h_{i,j-1}}{(\Delta y)^2} = 0$$

**代数方程**（$\Delta x = \Delta y = h$）：

$$h_{i+1,j} + h_{i-1,j} + h_{i,j+1} + h_{i,j-1} - 4h_{i,j} = 0$$

### 2.4 非稳定流离散

**显式格式**：

$$S\frac{h_{i,j}^{n+1} - h_{i,j}^n}{\Delta t} = T\left[\frac{h_{i+1,j}^n - 2h_{i,j}^n + h_{i-1,j}^n}{(\Delta x)^2} + \frac{h_{i,j+1}^n - 2h_{i,j}^n + h_{i,j-1}^n}{(\Delta y)^2}\right]$$

**稳定性条件**：

$$\Delta t \leq \frac{S(\Delta x)^2(\Delta y)^2}{4T[(\Delta x)^2 + (\Delta y)^2]}$$

**隐式格式**：

$$S\frac{h_{i,j}^{n+1} - h_{i,j}^n}{\Delta t} = T\left[\frac{h_{i+1,j}^{n+1} - 2h_{i,j}^{n+1} + h_{i-1,j}^{n+1}}{(\Delta x)^2} + \frac{h_{i,j+1}^{n+1} - 2h_{i,j}^{n+1} + h_{i,j-1}^{n+1}}{(\Delta y)^2}\right]$$

无条件稳定

---

## 三、有限元法（FEM）

### 3.1 变分原理

**最小位能原理**：

$$\min I[h] = \iint_\Omega \left[\frac{1}{2}K\left(\frac{\partial h}{\partial x}\right)^2 + \frac{1}{2}K\left(\frac{\partial h}{\partial y}\right)^2 - Wh\right]dxdy$$

### 3.2 单元类型

**三角形单元**：
- 线性：3节点
- 二次：6节点

**四边形单元**：
- 双线性：4节点
- 二次：8/9节点

### 3.3 形函数

**三角形线性单元**：

$$h(x,y) = N_1(x,y)h_1 + N_2(x,y)h_2 + N_3(x,y)h_3$$

**面积坐标**：

$$N_i = \frac{A_i}{A}, \quad i=1,2,3$$

### 3.4 刚度矩阵

**单元刚度矩阵**：

$$K_{ij}^e = \iint_{\Omega^e} K\left(\frac{\partial N_i}{\partial x}\frac{\partial N_j}{\partial x} + \frac{\partial N_i}{\partial y}\frac{\partial N_j}{\partial y}\right)dxdy$$

**总体方程**：

$$\mathbf{K}\mathbf{h} = \mathbf{F}$$

---

## 四、求解方法

### 4.1 迭代法

**(1) Jacobi迭代**：

$$h_{i,j}^{k+1} = \frac{1}{4}(h_{i+1,j}^k + h_{i-1,j}^k + h_{i,j+1}^k + h_{i,j-1}^k)$$

**(2) Gauss-Seidel迭代**：

$$h_{i,j}^{k+1} = \frac{1}{4}(h_{i+1,j}^k + h_{i-1,j}^{k+1} + h_{i,j+1}^k + h_{i,j-1}^{k+1})$$

**(3) SOR（超松弛）**：

$$h_{i,j}^{k+1} = (1-\omega)h_{i,j}^k + \frac{\omega}{4}(h_{i+1,j}^k + h_{i-1,j}^{k+1} + h_{i,j+1}^k + h_{i,j-1}^{k+1})$$

最优松弛因子：$\omega_{opt} = \frac{2}{1 + \sqrt{1-\rho}}$

### 4.2 收敛判据

**绝对误差**：

$$\max|h_{i,j}^{k+1} - h_{i,j}^k| < \epsilon$$

**相对误差**：

$$\frac{\max|h_{i,j}^{k+1} - h_{i,j}^k|}{\max|h_{i,j}^{k+1}|} < \epsilon$$

---

## 五、模型校正与验证

### 5.1 参数识别

**试错法**：
1. 初始参数估计
2. 模拟计算
3. 与实测对比
4. 调整参数
5. 重复迭代

**优化法**：

$$\min J(\mathbf{p}) = \sum_{i=1}^n [h_i^{obs} - h_i^{sim}(\mathbf{p})]^2$$

### 5.2 评价指标

**平均绝对误差（MAE）**：

$$MAE = \frac{1}{n}\sum_{i=1}^n |h_i^{obs} - h_i^{sim}|$$

**均方根误差（RMSE）**：

$$RMSE = \sqrt{\frac{1}{n}\sum_{i=1}^n (h_i^{obs} - h_i^{sim})^2}$$

**Nash效率系数**：

$$NSE = 1 - \frac{\sum(h_i^{obs} - h_i^{sim})^2}{\sum(h_i^{obs} - \bar{h}^{obs})^2}$$

---

## 六、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.sparse import diags
from scipy.sparse.linalg import spsolve
from matplotlib import cm

class GroundwaterNumericalModel:
    """地下水数值模拟"""
    
    def __init__(self):
        pass
    
    def laplace_2d_fdm(self, nx, ny, dx, dy, h_boundary, tol=1e-6, max_iter=10000):
        """
        二维稳态地下水流（拉普拉斯方程）
        有限差分法求解
        
        ∂²h/∂x² + ∂²h/∂y² = 0
        
        参数:
            nx, ny: x和y方向网格数
            dx, dy: 网格步长 (m)
            h_boundary: 边界条件字典
            tol: 收敛容差
            max_iter: 最大迭代次数
        """
        # 初始化
        h = np.zeros((ny, nx))
        
        # 设置边界条件
        if 'west' in h_boundary:
            h[:, 0] = h_boundary['west']
        if 'east' in h_boundary:
            h[:, -1] = h_boundary['east']
        if 'south' in h_boundary:
            h[0, :] = h_boundary['south']
        if 'north' in h_boundary:
            h[-1, :] = h_boundary['north']
        
        # Gauss-Seidel迭代
        for iteration in range(max_iter):
            h_old = h.copy()
            
            for i in range(1, ny - 1):
                for j in range(1, nx - 1):
                    # 五点差分
                    h[i, j] = 0.25 * (h[i+1, j] + h[i-1, j] + 
                                     h[i, j+1] + h[i, j-1])
            
            # 检查收敛
            error = np.max(np.abs(h - h_old))
            
            if error < tol:
                print(f"  收敛于第{iteration+1}次迭代，误差={error:.2e}")
                break
        
        return h, iteration + 1
    
    def transient_2d_implicit(self, nx, ny, nt, dx, dy, dt, 
                              T, S, h0, h_boundary, source=None):
        """
        二维非稳定地下水流
        隐式有限差分法
        
        S·∂h/∂t = T·(∂²h/∂x² + ∂²h/∂y²) + W
        
        参数:
            nx, ny: 空间网格数
            nt: 时间步数
            dx, dy: 空间步长 (m)
            dt: 时间步长 (d)
            T: 导水系数 (m²/d)
            S: 贮水系数
            h0: 初始水位 (m)
            h_boundary: 边界条件
            source: 源汇项 (1/d)
        """
        # 初始化
        h = np.zeros((nt, ny, nx))
        h[0] = h0
        
        # 系数
        rx = T * dt / (S * dx**2)
        ry = T * dt / (S * dy**2)
        
        for n in range(nt - 1):
            # 隐式求解（简化：逐点迭代）
            h_new = h[n].copy()
            
            for _ in range(100):  # 内迭代
                h_old = h_new.copy()
                
                for i in range(1, ny - 1):
                    for j in range(1, nx - 1):
                        # 隐式格式
                        h_new[i, j] = (h[n, i, j] + 
                                      rx * (h_new[i+1, j] + h_new[i-1, j]) +
                                      ry * (h_new[i, j+1] + h_new[i, j-1])) / \
                                     (1 + 2*rx + 2*ry)
                        
                        # 源汇项
                        if source is not None:
                            h_new[i, j] += dt * source[i, j] / S
                
                # 边界条件
                if 'west' in h_boundary:
                    h_new[:, 0] = h_boundary['west']
                if 'east' in h_boundary:
                    h_new[:, -1] = h_boundary['east']
                
                # 检查内迭代收敛
                if np.max(np.abs(h_new - h_old)) < 1e-4:
                    break
            
            h[n+1] = h_new
        
        return h
    
    def pumping_well_drawdown(self, r, t, Q, T, S):
        """
        抽水井降深计算（Theis解）
        
        s = (Q/(4πT))·W(u)
        u = r²S/(4Tt)
        
        参数:
            r: 距离 (m)
            t: 时间 (d)
            Q: 抽水量 (m³/d)
            T: 导水系数 (m²/d)
            S: 贮水系数
        """
        from scipy.special import exp1
        
        u = r**2 * S / (4 * T * t)
        
        # 井函数 W(u) ≈ -0.5772 - ln(u) (u<0.01)
        if u < 0.01:
            W_u = -0.5772 - np.log(u)
        else:
            W_u = exp1(u)
        
        s = Q / (4 * np.pi * T) * W_u
        
        return s
    
    def model_performance(self, h_obs, h_sim):
        """
        模型性能评价
        
        返回: MAE, RMSE, NSE
        """
        # 平均绝对误差
        MAE = np.mean(np.abs(h_obs - h_sim))
        
        # 均方根误差
        RMSE = np.sqrt(np.mean((h_obs - h_sim)**2))
        
        # Nash效率系数
        h_mean = np.mean(h_obs)
        NSE = 1 - np.sum((h_obs - h_sim)**2) / np.sum((h_obs - h_mean)**2)
        
        return {
            'MAE': MAE,
            'RMSE': RMSE,
            'NSE': NSE
        }
    
    def plot_numerical_simulation(self):
        """绘制数值模拟图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. 二维稳态流场
        ax1 = axes[0, 0]
        
        nx, ny = 50, 30
        dx, dy = 10, 10
        
        # 边界条件：西高东低
        h_boundary = {
            'west': 50,
            'east': 40,
            'south': np.linspace(50, 40, nx),
            'north': np.linspace(50, 40, nx)
        }
        
        h_steady, iters = self.laplace_2d_fdm(nx, ny, dx, dy, h_boundary)
        
        # 绘制等水位线
        x = np.arange(nx) * dx
        y = np.arange(ny) * dy
        X, Y = np.meshgrid(x, y)
        
        levels = np.linspace(40, 50, 11)
        contour = ax1.contourf(X, Y, h_steady, levels=levels,
                              cmap='Blues', alpha=0.8)
        
        contour_lines = ax1.contour(X, Y, h_steady, levels=levels,
                                    colors='black', linewidths=1)
        ax1.clabel(contour_lines, inline=True, fontsize=9)
        
        # 流向（梯度）
        gy, gx = np.gradient(h_steady, dy, dx)
        skip = 3
        ax1.quiver(X[::skip, ::skip], Y[::skip, ::skip],
                  -gx[::skip, ::skip], -gy[::skip, ::skip],
                  alpha=0.6, scale=50)
        
        cbar = plt.colorbar(contour, ax=ax1)
        cbar.set_label('水位 h (m)', fontsize=11)
        
        ax1.set_xlabel('x (m)', fontsize=11)
        ax1.set_ylabel('y (m)', fontsize=11)
        ax1.set_title(f'二维稳态流场（有限差分法）\n迭代{iters}次收敛',
                     fontsize=13, fontweight='bold')
        ax1.axis('equal')
        
        # 2. 抽水井降深锥
        ax2 = axes[0, 1]
        
        Q_well = 500  # m³/d
        T_aquifer = 100  # m²/d
        S_aquifer = 0.001
        
        r_range = np.linspace(1, 500, 100)
        t_values = [0.1, 1, 10, 100]
        colors_t = plt.cm.viridis(np.linspace(0, 1, len(t_values)))
        
        for t, color in zip(t_values, colors_t):
            s_values = [self.pumping_well_drawdown(r, t, Q_well, 
                                                   T_aquifer, S_aquifer)
                       for r in r_range]
            
            ax2.plot(r_range, s_values, color=color, linewidth=2.5,
                    label=f't={t}d')
        
        ax2.set_xlabel('距离 r (m)', fontsize=11)
        ax2.set_ylabel('降深 s (m)', fontsize=11)
        ax2.set_title(f'抽水井降深锥（Theis解）\nQ={Q_well}m³/d, T={T_aquifer}m²/d',
                     fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        ax2.invert_yaxis()
        
        # 3. 非稳定流演化
        ax3 = axes[1, 0]
        
        # 简化演示：一维非稳定流
        nx_trans = 50
        nt_trans = 100
        dx_trans = 5
        dt_trans = 0.1
        
        x_trans = np.arange(nx_trans) * dx_trans
        t_trans = np.arange(nt_trans) * dt_trans
        
        # 初始条件：均匀水位
        h0_trans = 10 * np.ones(nx_trans)
        
        # 边界：左侧升高到15m
        h_trans = np.zeros((nt_trans, nx_trans))
        h_trans[0] = h0_trans
        
        T_trans = 50
        S_trans = 0.1
        r_trans = T_trans * dt_trans / (S_trans * dx_trans**2)
        
        for n in range(nt_trans - 1):
            for i in range(1, nx_trans - 1):
                h_trans[n+1, i] = h_trans[n, i] + \
                                 r_trans * (h_trans[n, i+1] - 2*h_trans[n, i] + h_trans[n, i-1])
            
            # 边界条件
            h_trans[n+1, 0] = 15  # 左侧升高
            h_trans[n+1, -1] = h_trans[n+1, -2]  # 右侧无流边界
        
        # 绘制不同时刻的水位
        t_plot = [0, 25, 50, 75, 99]
        colors_tp = plt.cm.coolwarm(np.linspace(0, 1, len(t_plot)))
        
        for idx, color in zip(t_plot, colors_tp):
            ax3.plot(x_trans, h_trans[idx], color=color, linewidth=2.5,
                    label=f't={t_trans[idx]:.1f}d')
        
        ax3.set_xlabel('距离 x (m)', fontsize=11)
        ax3.set_ylabel('水位 h (m)', fontsize=11)
        ax3.set_title('非稳定流演化（显式差分）', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 模型校正评价
        ax4 = axes[1, 1]
        
        # 模拟vs实测对比
        np.random.seed(42)
        h_obs = np.linspace(45, 40, 20) + np.random.normal(0, 0.5, 20)
        h_sim = np.linspace(45.2, 39.8, 20)
        
        ax4.scatter(h_obs, h_sim, s=100, alpha=0.7, color='blue',
                   edgecolors='black', linewidth=1.5, label='模拟vs实测')
        
        # 1:1线
        h_range = [38, 47]
        ax4.plot(h_range, h_range, 'r--', linewidth=2.5, label='1:1线')
        
        # 计算评价指标
        metrics = self.model_performance(h_obs, h_sim)
        
        # 标注
        text_str = f"MAE = {metrics['MAE']:.2f} m\n" \
                  f"RMSE = {metrics['RMSE']:.2f} m\n" \
                  f"NSE = {metrics['NSE']:.3f}"
        
        ax4.text(0.05, 0.95, text_str, transform=ax4.transAxes,
                fontsize=11, verticalalignment='top',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8))
        
        ax4.set_xlabel('实测水位 h_obs (m)', fontsize=11)
        ax4.set_ylabel('模拟水位 h_sim (m)', fontsize=11)
        ax4.set_title('模型校正评价', fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        ax4.axis('equal')
        
        plt.tight_layout()
        plt.savefig('groundwater_numerical_model.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("地下水数值模拟")
print("="*60)

gnm = GroundwaterNumericalModel()

# 1. 二维稳态模拟
print("1. 二维稳态地下水流模拟:")

nx, ny = 30, 20
dx, dy = 10, 10

h_bc = {
    'west': 50,
    'east': 40,
    'south': np.linspace(50, 40, nx),
    'north': np.linspace(50, 40, nx)
}

print(f"  网格: {nx}×{ny}")
print(f"  步长: dx={dx}m, dy={dy}m")
print(f"  边界: 西边h=50m, 东边h=40m")

h_result, iterations = gnm.laplace_2d_fdm(nx, ny, dx, dy, h_bc, tol=1e-6)

print(f"\n  中心点水位: h({nx//2}, {ny//2}) = {h_result[ny//2, nx//2]:.2f} m")
print(f"  最大水力坡度: i_max = {(50-40)/(nx*dx):.4f}")

# 2. 抽水井降深
print("\n" + "="*60)
print("2. 抽水井降深计算（Theis解）:")

Q = 500    # m³/d
T = 100    # m²/d
S = 0.001

r_test = [10, 50, 100, 200]
t_test = 10  # d

print(f"  抽水量 Q = {Q} m³/d")
print(f"  导水系数 T = {T} m²/d")
print(f"  贮水系数 S = {S}")
print(f"  时间 t = {t_test} d")

for r in r_test:
    s = gnm.pumping_well_drawdown(r, t_test, Q, T, S)
    print(f"\n  距离 r = {r:3d} m: 降深 s = {s:.3f} m")

# 3. 模型性能评价
print("\n" + "="*60)
print("3. 模型校正评价:")

np.random.seed(42)
h_observed = np.array([45.2, 44.8, 44.1, 43.5, 42.9, 42.3, 41.7, 41.2, 40.8, 40.3])
h_simulated = np.array([45.0, 44.6, 44.0, 43.4, 42.8, 42.2, 41.6, 41.1, 40.7, 40.5])

metrics = gnm.model_performance(h_observed, h_simulated)

print(f"  观测点数: {len(h_observed)}")
print(f"\n  评价指标:")
print(f"    MAE = {metrics['MAE']:.3f} m")
print(f"    RMSE = {metrics['RMSE']:.3f} m")
print(f"    NSE = {metrics['NSE']:.3f}")

if metrics['NSE'] > 0.75:
    print(f"  评价: 优秀（NSE > 0.75）✓")
elif metrics['NSE'] > 0.5:
    print(f"  评价: 良好（0.5 < NSE < 0.75）")
else:
    print(f"  评价: 需改进（NSE < 0.5）")

# 4. 稳定性条件
print("\n" + "="*60)
print("4. 显式格式稳定性条件:")

dx_stab = 10  # m
dy_stab = 10  # m
T_stab = 100  # m²/d
S_stab = 0.1

dt_max = S_stab * dx_stab**2 * dy_stab**2 / \
         (4 * T_stab * (dx_stab**2 + dy_stab**2))

print(f"  空间步长: Δx = Δy = {dx_stab} m")
print(f"  T = {T_stab} m²/d, S = {S_stab}")
print(f"\n  最大时间步长: Δt_max = {dt_max:.3f} d")
print(f"  推荐使用: Δt ≤ {dt_max*0.8:.3f} d（安全系数0.8）")

# 5. 网格独立性
print("\n" + "="*60)
print("5. 网格独立性分析:")

grid_sizes = [(20, 10), (40, 20), (60, 30), (80, 40)]

for nx_g, ny_g in grid_sizes:
    total_nodes = nx_g * ny_g
    
    # 估算计算量（迭代次数∝网格数）
    est_iters = int(100 * np.sqrt(total_nodes / 200))
    
    print(f"\n  网格{nx_g}×{ny_g} (总节点{total_nodes}):")
    print(f"    估算迭代次数: ~{est_iters}")
    print(f"    计算时间比: {total_nodes/200:.1f}x")

# 绘图
print("\n绘制地下水数值模拟图...")
gnm.plot_numerical_simulation()
```

---

## 七、典型考题

### 【例题1】差分格式（12分）

**题目**：二维稳态，$\Delta x = \Delta y = 10$m。中心节点$(i,j)$周围四点水位分别为50, 48, 46, 44m。求$h_{i,j}$。

**【解答】**

五点差分格式：

$$h_{i,j} = \frac{1}{4}(h_{i+1,j} + h_{i-1,j} + h_{i,j+1} + h_{i,j-1})$$

$$= \frac{1}{4}(50 + 48 + 46 + 44) = \frac{188}{4} = 47 \text{ m}$$

---

**本章重点**：
- 有限差分法
- 有限元法
- 稳定性条件
- 模型校正与验证

**下一章**：地下水管理与保护
