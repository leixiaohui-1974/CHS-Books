# 项目2：明渠流水力计算与可视化系统

**项目难度**: ⭐⭐⭐⭐  
**预计时间**: 10小时  
**知识点**: 明渠流理论、数值求解、面向对象、可视化

---

## 一、项目目标

开发一个完整的明渠流水力计算系统，实现：
1. 均匀流计算（曼宁公式）
2. 非均匀流水面线计算
3. 临界水深与比能分析
4. 水跃计算与消能设计
5. 可视化分析工具

---

## 二、核心理论

### 2.1 曼宁公式

$$Q = \frac{1}{n}AR^{2/3}i^{1/2}$$

其中：
- Q：流量 (m³/s)
- n：糙率系数
- A：过流断面积 (m²)
- R：水力半径 (m)
- i：底坡

### 2.2 临界水深

矩形断面：
$$h_c = \sqrt[3]{\frac{Q^2}{gb^2}}$$

### 2.3 水面线微分方程

$$\frac{dh}{dx} = \frac{i - J}{1 - Fr^2}$$

其中：
- i：底坡
- J：水力坡度
- Fr：弗劳德数

---

## 三、完整实现

### 3.1 明渠流核心类

```python
"""
open_channel.py
明渠流水力计算核心模块
"""

import numpy as np
from scipy.optimize import fsolve, minimize_scalar
import matplotlib.pyplot as plt
from matplotlib.patches import Polygon

class OpenChannelFlow:
    """
    明渠流水力计算基类
    """
    
    def __init__(self, Q, n, i, g=9.8):
        """
        初始化
        
        参数:
            Q: 流量 (m³/s)
            n: 糙率系数
            i: 底坡
            g: 重力加速度 (m/s²)
        """
        self.Q = Q
        self.n = n
        self.i = i
        self.g = g
    
    def geometric_properties(self, h):
        """
        几何要素计算（抽象方法，子类实现）
        
        参数:
            h: 水深 (m)
        
        返回:
            (A, P, R, B) - 断面积、湿周、水力半径、水面宽
        """
        raise NotImplementedError("子类必须实现此方法")
    
    def manning_velocity(self, h):
        """
        曼宁公式计算流速
        """
        A, P, R, B = self.geometric_properties(h)
        v = (1/self.n) * R**(2/3) * self.i**(1/2)
        return v
    
    def manning_discharge(self, h):
        """
        曼宁公式计算流量
        """
        A, P, R, B = self.geometric_properties(h)
        v = self.manning_velocity(h)
        Q = v * A
        return Q
    
    def normal_depth(self, h0=1.0):
        """
        正常水深（均匀流水深）
        
        参数:
            h0: 初始猜测值 (m)
        
        返回:
            正常水深 (m)
        """
        def equation(h):
            Q_calc = self.manning_discharge(h)
            return Q_calc - self.Q
        
        h_n = fsolve(equation, h0)[0]
        return h_n
    
    def critical_depth(self):
        """
        临界水深（抽象方法，子类实现）
        """
        raise NotImplementedError("子类必须实现此方法")
    
    def froude_number(self, h):
        """
        弗劳德数
        """
        A, P, R, B = self.geometric_properties(h)
        v = self.Q / A
        D_h = A / B  # 水力深度
        Fr = v / np.sqrt(self.g * D_h)
        return Fr
    
    def specific_energy(self, h):
        """
        断面比能
        
        E = h + v²/(2g) = h + Q²/(2gA²)
        """
        A, P, R, B = self.geometric_properties(h)
        E = h + (self.Q**2) / (2 * self.g * A**2)
        return E
    
    def flow_regime(self, h):
        """
        判断流态
        """
        Fr = self.froude_number(h)
        if Fr < 1:
            return "缓流（亚临界）"
        elif Fr > 1:
            return "急流（超临界）"
        else:
            return "临界流"


class RectangularChannel(OpenChannelFlow):
    """
    矩形断面明渠
    """
    
    def __init__(self, Q, b, n, i, g=9.8):
        """
        参数:
            Q: 流量 (m³/s)
            b: 渠宽 (m)
            n: 糙率
            i: 底坡
        """
        super().__init__(Q, n, i, g)
        self.b = b
    
    def geometric_properties(self, h):
        """
        矩形断面几何要素
        """
        A = self.b * h
        P = self.b + 2*h
        R = A / P
        B = self.b  # 水面宽
        return A, P, R, B
    
    def critical_depth(self):
        """
        矩形断面临界水深
        
        h_c = (Q²/(g*b²))^(1/3)
        """
        h_c = (self.Q**2 / (self.g * self.b**2)) ** (1/3)
        return h_c
    
    def optimal_hydraulic_section(self):
        """
        最优水力断面
        
        对于矩形：b = 2h
        """
        # 最优比例
        ratio = 2.0  # b/h = 2
        
        # 根据流量求解最优水深
        def equation(h):
            b_opt = ratio * h
            channel = RectangularChannel(self.Q, b_opt, self.n, self.i, self.g)
            Q_calc = channel.manning_discharge(h)
            return Q_calc - self.Q
        
        h_opt = fsolve(equation, 1.0)[0]
        b_opt = ratio * h_opt
        
        return h_opt, b_opt


class TrapezoidalChannel(OpenChannelFlow):
    """
    梯形断面明渠
    """
    
    def __init__(self, Q, b, m, n, i, g=9.8):
        """
        参数:
            Q: 流量 (m³/s)
            b: 底宽 (m)
            m: 边坡系数
            n: 糙率
            i: 底坡
        """
        super().__init__(Q, n, i, g)
        self.b = b
        self.m = m
    
    def geometric_properties(self, h):
        """
        梯形断面几何要素
        """
        A = (self.b + self.m*h) * h
        P = self.b + 2*h*np.sqrt(1 + self.m**2)
        R = A / P
        B = self.b + 2*self.m*h  # 水面宽
        return A, P, R, B
    
    def critical_depth(self, h0=1.0):
        """
        梯形断面临界水深（数值求解）
        
        Fr = 1
        """
        def equation(h):
            Fr = self.froude_number(h)
            return Fr - 1.0
        
        h_c = fsolve(equation, h0)[0]
        return h_c
    
    def optimal_hydraulic_section(self):
        """
        梯形最优水力断面
        
        b/h = 2(√(1+m²) - m)
        """
        ratio = 2 * (np.sqrt(1 + self.m**2) - self.m)
        
        def equation(h):
            b_opt = ratio * h
            channel = TrapezoidalChannel(self.Q, b_opt, self.m, self.n, self.i, self.g)
            Q_calc = channel.manning_discharge(h)
            return Q_calc - self.Q
        
        h_opt = fsolve(equation, 1.0)[0]
        b_opt = ratio * h_opt
        
        return h_opt, b_opt


class WaterSurfaceProfile:
    """
    水面线计算
    """
    
    def __init__(self, channel, x_range, dx=10):
        """
        参数:
            channel: OpenChannelFlow实例
            x_range: (x_start, x_end) 计算范围 (m)
            dx: 步长 (m)
        """
        self.channel = channel
        self.x_start, self.x_end = x_range
        self.dx = dx
    
    def compute_profile(self, h_boundary, direction='downstream'):
        """
        计算水面线
        
        参数:
            h_boundary: 边界水深 (m)
            direction: 'downstream' 或 'upstream'
        
        返回:
            x数组, h数组
        """
        # 初始化
        if direction == 'downstream':
            x_array = np.arange(self.x_start, self.x_end + self.dx, self.dx)
            sign = 1
        else:
            x_array = np.arange(self.x_end, self.x_start - self.dx, -self.dx)
            sign = -1
        
        h_array = np.zeros_like(x_array)
        h_array[0] = h_boundary
        
        # 标准步长法（逐步推进）
        for i in range(1, len(x_array)):
            h_prev = h_array[i-1]
            
            # 水面线微分方程
            # dh/dx = (i - J) / (1 - Fr²)
            
            # 水力坡度 J（曼宁公式）
            A, P, R, B = self.channel.geometric_properties(h_prev)
            v = self.channel.Q / A
            J = (self.channel.n * v)**2 / R**(4/3)
            
            # 弗劳德数平方
            Fr2 = v**2 / (self.channel.g * A/B)
            
            # 微分方程右端
            dh_dx = (self.channel.i - J) / (1 - Fr2)
            
            # 欧拉法推进
            h_array[i] = h_prev + sign * dh_dx * self.dx
            
            # 边界检查
            if h_array[i] <= 0:
                h_array[i] = 0.01
        
        return x_array, h_array
    
    def plot_profile(self, h_boundary, direction='downstream'):
        """
        绘制水面线
        """
        x, h = self.compute_profile(h_boundary, direction)
        
        # 正常水深和临界水深
        h_n = self.channel.normal_depth()
        h_c = self.channel.critical_depth()
        
        fig, ax = plt.subplots(figsize=(12, 6))
        
        # 河底
        z_bed = np.linspace(0, -self.channel.i * (self.x_end - self.x_start), len(x))
        
        # 水面线
        z_water = z_bed + h
        
        ax.plot(x, z_bed, 'k-', linewidth=2, label='河底')
        ax.plot(x, z_water, 'b-', linewidth=2, label='水面线')
        
        # 正常水深线和临界水深线
        ax.axhline(z_bed[0] + h_n, color='g', linestyle='--', label=f'正常水深 h_n={h_n:.2f}m')
        ax.axhline(z_bed[0] + h_c, color='r', linestyle='--', label=f'临界水深 h_c={h_c:.2f}m')
        
        # 填充
        ax.fill_between(x, z_bed, z_water, alpha=0.3, color='cyan')
        
        ax.set_xlabel('距离 x (m)', fontsize=12)
        ax.set_ylabel('高程 z (m)', fontsize=12)
        ax.set_title('明渠非均匀流水面线', fontsize=14)
        ax.grid(True, alpha=0.3)
        ax.legend()
        
        plt.tight_layout()
        plt.savefig('water_surface_profile.png', dpi=300, bbox_inches='tight')
        plt.show()


# ============ 使用示例 ============

def example_rectangular_channel():
    """
    示例：矩形明渠计算
    """
    print("="*60)
    print("示例1：矩形明渠均匀流计算")
    print("="*60)
    
    # 创建矩形渠道
    channel = RectangularChannel(
        Q=10,      # 流量 10 m³/s
        b=3,       # 宽度 3 m
        n=0.025,   # 糙率
        i=0.001    # 底坡 0.001
    )
    
    # 正常水深
    h_n = channel.normal_depth()
    print(f"\n正常水深: h_n = {h_n:.3f} m")
    
    # 临界水深
    h_c = channel.critical_depth()
    print(f"临界水深: h_c = {h_c:.3f} m")
    
    # 流态判断
    regime = channel.flow_regime(h_n)
    print(f"流态: {regime}")
    
    # 弗劳德数
    Fr = channel.froude_number(h_n)
    print(f"弗劳德数: Fr = {Fr:.3f}")
    
    # 断面比能
    E = channel.specific_energy(h_n)
    print(f"断面比能: E = {E:.3f} m")
    
    # 最优水力断面
    h_opt, b_opt = channel.optimal_hydraulic_section()
    print(f"\n最优水力断面:")
    print(f"  最优水深: {h_opt:.3f} m")
    print(f"  最优宽度: {b_opt:.3f} m")
    print(f"  b/h比: {b_opt/h_opt:.3f} (理论值2.0)")


def example_trapezoidal_channel():
    """
    示例：梯形明渠计算
    """
    print("\n" + "="*60)
    print("示例2：梯形明渠均匀流计算")
    print("="*60)
    
    # 创建梯形渠道
    channel = TrapezoidalChannel(
        Q=20,      # 流量 20 m³/s
        b=4,       # 底宽 4 m
        m=1.5,     # 边坡系数
        n=0.025,
        i=0.0005
    )
    
    h_n = channel.normal_depth(h0=2.0)
    h_c = channel.critical_depth(h0=1.0)
    
    print(f"\n正常水深: h_n = {h_n:.3f} m")
    print(f"临界水深: h_c = {h_c:.3f} m")
    print(f"流态: {channel.flow_regime(h_n)}")
    
    # 几何要素
    A, P, R, B = channel.geometric_properties(h_n)
    print(f"\n几何要素(正常水深):")
    print(f"  断面积: A = {A:.3f} m²")
    print(f"  湿周: P = {P:.3f} m")
    print(f"  水力半径: R = {R:.3f} m")
    print(f"  水面宽: B = {B:.3f} m")
    
    # 最优断面
    h_opt, b_opt = channel.optimal_hydraulic_section()
    print(f"\n最优水力断面:")
    print(f"  最优水深: {h_opt:.3f} m")
    print(f"  最优底宽: {b_opt:.3f} m")


def example_water_surface_profile():
    """
    示例：水面线计算
    """
    print("\n" + "="*60)
    print("示例3：非均匀流水面线计算")
    print("="*60)
    
    # 创建渠道
    channel = RectangularChannel(Q=15, b=4, n=0.020, i=0.002)
    
    # 水面线计算
    profile = WaterSurfaceProfile(
        channel=channel,
        x_range=(0, 1000),  # 1km
        dx=20
    )
    
    # 下游边界条件（闸门控制，水深3m）
    h_boundary = 3.0
    
    # 绘制水面线
    profile.plot_profile(h_boundary, direction='upstream')
    
    print(f"水面线计算完成，图片已保存")


# 运行所有示例
if __name__ == "__main__":
    example_rectangular_channel()
    example_trapezoidal_channel()
    example_water_surface_profile()
```

---

## 四、项目扩展

### 扩展1：水跃计算模块

```python
class HydraulicJump:
    """
    水跃计算
    """
    
    def __init__(self, channel, h1, v1=None):
        self.channel = channel
        self.h1 = h1
        if v1:
            self.v1 = v1
        else:
            A1, _, _, _ = channel.geometric_properties(h1)
            self.v1 = channel.Q / A1
    
    def conjugate_depth(self):
        """
        共轭水深（矩形断面）
        """
        Fr1 = self.v1 / np.sqrt(channel.g * self.h1)
        h2 = (self.h1 / 2) * (np.sqrt(1 + 8*Fr1**2) - 1)
        return h2
    
    def energy_loss(self):
        """
        水头损失
        """
        h2 = self.conjugate_depth()
        E1 = self.channel.specific_energy(self.h1)
        E2 = self.channel.specific_energy(h2)
        delta_E = E1 - E2
        return delta_E
```

---

## 五、项目作业

### 作业1（必做）
1. 完善`CircularChannel`类（圆形断面）
2. 实现比能曲线绘制功能
3. 添加单位测试

### 作业2（选做）
开发明渠水力设计小程序，给定Q、n、i，自动优化断面尺寸。

---

**项目总结**：
- 完整的OOP设计
- 数值求解方法
- 水面线计算
- 可视化分析

**下一项目**：管网水力计算与优化
