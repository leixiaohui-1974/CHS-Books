# 第7章：水生生境模拟

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、水生生境基本概念

### 1.1 生境要素

**物理生境因子**：
- 水深（h）
- 流速（v）
- 底质类型（substrate）
- 遮蔽度（cover）

**化学生境因子**：
- 溶解氧（DO）
- 水温（T）
- pH值
- 营养盐浓度

**生物生境因子**：
- 食物可得性
- 竞争者密度
- 捕食者压力

### 1.2 生境评价指标

**(1) 栖息地适宜指数（HSI）**：

$$HSI = \prod_{i=1}^n SI_i^{w_i}$$

其中$SI_i$为第$i$个因子的适宜指数，$w_i$为权重

**(2) 加权可用面积（WUA）**：

$$WUA = \sum_{j=1}^m A_j \cdot HSI_j$$

**(3) 栖息地质量指数（HQI）**：

$$HQI = \frac{WUA}{A_{total}}$$

---

## 二、生境适宜曲线

### 2.1 单因子适宜曲线

**流速适宜曲线**（鱼类）：

$$SI_v(v) = \begin{cases}
0 & v < v_{min} \\
\frac{v - v_{min}}{v_{opt} - v_{min}} & v_{min} \leq v < v_{opt} \\
\frac{v_{max} - v}{v_{max} - v_{opt}} & v_{opt} \leq v < v_{max} \\
0 & v \geq v_{max}
\end{cases}$$

**水深适宜曲线**：

$$SI_h(h) = \begin{cases}
0 & h < h_{min} \\
1 - e^{-k(h-h_{min})} & h \geq h_{min}
\end{cases}$$

### 2.2 底质偏好

**底质分类**：
- 基岩（bedrock）
- 巨石（boulder）> 256mm
- 卵石（cobble）64~256mm
- 砾石（gravel）2~64mm
- 沙（sand）0.062~2mm
- 淤泥（silt/clay）< 0.062mm

**偏好指数**（鲑鱼产卵）：

| 底质类型 | SI值 |
|----------|------|
| 砾石 | 1.0 |
| 卵石 | 0.8 |
| 沙 | 0.3 |
| 淤泥 | 0.0 |

---

## 三、物理栖息地模拟（PHABSIM）

### 3.1 模型框架

**步骤**：
1. 水力学模拟（h, v分布）
2. 生境适宜度评价（HSI）
3. 加权可用面积计算（WUA）
4. 流量-栖息地关系（Q-WUA）

### 3.2 水力学模拟

**1D模型**（横断面法）：

能量方程：

$$h_1 + \frac{\alpha_1 v_1^2}{2g} = h_2 + \frac{\alpha_2 v_2^2}{2g} + h_f$$

连续方程：

$$Q = A_1 v_1 = A_2 v_2$$

**2D模型**（深度平均）：

连续方程：

$$\frac{\partial h}{\partial t} + \frac{\partial(uh)}{\partial x} + \frac{\partial(vh)}{\partial y} = 0$$

动量方程：

$$\frac{\partial u}{\partial t} + u\frac{\partial u}{\partial x} + v\frac{\partial u}{\partial y} = -g\frac{\partial h}{\partial x} - \frac{\tau_b}{\rho h}$$

### 3.3 WUA计算

**网格法**：

$$WUA = \sum_{i=1}^{N_{cells}} A_i \cdot HSI(v_i, h_i, S_i)$$

**横断面法**：

$$WUA = \sum_{j=1}^{N_{sections}} L_j \sum_{k=1}^{N_{cells,j}} \Delta w_k \cdot HSI_{jk}$$

---

## 四、鱼类生境模拟

### 4.1 生活史阶段

**(1) 产卵（spawning）**：
- 流速：0.3~1.0 m/s
- 水深：0.2~0.8 m
- 底质：砾石

**(2) 仔鱼（fry）**：
- 流速：0~0.2 m/s
- 水深：0.1~0.5 m
- 遮蔽：需要

**(3) 幼鱼（juvenile）**：
- 流速：0.2~0.6 m/s
- 水深：0.3~1.0 m
- 食物：丰富

**(4) 成鱼（adult）**：
- 流速：0.3~1.2 m/s
- 水深：0.5~2.0 m
- 深潭：洄游通道

### 4.2 鲑鱼模型

**产卵生境**：

$$HSI_{spawn} = SI_v \times SI_h \times SI_{substrate}$$

**适宜流速**：$v_{opt} = 0.6$m/s

**适宜水深**：$h_{opt} = 0.4$m

**适宜底质**：砾石（2~64mm）

---

## 五、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d

class HabitatSimulation:
    """水生生境模拟"""
    
    def __init__(self):
        pass
    
    def velocity_suitability(self, v, v_opt=0.6, v_min=0.1, v_max=1.5):
        """
        流速适宜曲线
        
        参数:
            v: 流速 (m/s)
            v_opt: 最适流速
            v_min, v_max: 可接受范围
        """
        v = np.atleast_1d(v)
        SI = np.zeros_like(v)
        
        # 上升段
        mask1 = (v >= v_min) & (v < v_opt)
        SI[mask1] = (v[mask1] - v_min) / (v_opt - v_min)
        
        # 下降段
        mask2 = (v >= v_opt) & (v < v_max)
        SI[mask2] = (v_max - v[mask2]) / (v_max - v_opt)
        
        # 最优区
        mask3 = v == v_opt
        SI[mask3] = 1.0
        
        return SI
    
    def depth_suitability(self, h, h_min=0.2, k=3):
        """
        水深适宜曲线（指数饱和型）
        
        SI_h = 1 - exp(-k(h - h_min))
        """
        h = np.atleast_1d(h)
        SI = np.zeros_like(h)
        
        mask = h >= h_min
        SI[mask] = 1 - np.exp(-k * (h[mask] - h_min))
        
        return SI
    
    def substrate_suitability(self, d50):
        """
        底质适宜指数
        
        参数:
            d50: 中值粒径 (mm)
        """
        # 分段线性
        if d50 < 2:  # 沙/淤泥
            return 0.1
        elif d50 < 8:  # 细砾石
            return 0.6
        elif d50 < 32:  # 中砾石（最优）
            return 1.0
        elif d50 < 64:  # 粗砾石
            return 0.8
        elif d50 < 256:  # 卵石
            return 0.5
        else:  # 巨石/基岩
            return 0.2
    
    def composite_suitability(self, v, h, d50, method='geometric'):
        """
        复合适宜指数
        
        参数:
            method: 'geometric'几何平均, 'arithmetic'算术平均, 'minimum'最小值
        """
        SI_v = self.velocity_suitability(v)
        SI_h = self.depth_suitability(h)
        SI_s = self.substrate_suitability(d50)
        
        if method == 'geometric':
            HSI = (SI_v * SI_h * SI_s)**(1/3)
        elif method == 'arithmetic':
            HSI = (SI_v + SI_h + SI_s) / 3
        elif method == 'minimum':
            HSI = min(SI_v, SI_h, SI_s)
        else:
            HSI = (SI_v * SI_h * SI_s)**(1/3)
        
        return HSI
    
    def calculate_WUA(self, Q, b, slope, n=0.03, d50=16):
        """
        计算加权可用面积
        
        假设：矩形断面，均匀流
        """
        g = 9.81
        
        # 水力计算
        def get_hydraulics(Q):
            from scipy.optimize import fsolve
            
            def equation(h):
                A = b * h
                P = b + 2 * h
                R = A / P
                Q_calc = (1/n) * A * R**(2/3) * np.sqrt(slope)
                return Q_calc - Q
            
            h = fsolve(equation, 0.5)[0]
            
            if h > 0:
                A = b * h
                v = Q / A
            else:
                h = 0
                v = 0
            
            return h, v
        
        h, v = get_hydraulics(Q)
        
        # 生境适宜度
        SI_v = self.velocity_suitability(v)
        SI_h = self.depth_suitability(h)
        SI_s = self.substrate_suitability(d50)
        
        HSI = (SI_v * SI_h * SI_s)**(1/3)
        
        # WUA
        A_wetted = b * h
        WUA = A_wetted * HSI
        
        return {
            'WUA': WUA,
            'h': h,
            'v': v,
            'HSI': HSI,
            'SI_v': SI_v,
            'SI_h': SI_h,
            'SI_s': SI_s
        }
    
    def Q_WUA_curve(self, Q_range, b, slope, n=0.03, d50=16):
        """
        流量-栖息地关系曲线
        """
        WUA_values = []
        HSI_values = []
        
        for Q in Q_range:
            result = self.calculate_WUA(Q, b, slope, n, d50)
            WUA_values.append(result['WUA'])
            HSI_values.append(result['HSI'])
        
        return np.array(WUA_values), np.array(HSI_values)
    
    def optimal_flow(self, Q_range, b, slope, n=0.03, d50=16):
        """
        最优流量（最大WUA）
        """
        WUA_values, _ = self.Q_WUA_curve(Q_range, b, slope, n, d50)
        
        idx_max = np.argmax(WUA_values)
        Q_opt = Q_range[idx_max]
        WUA_max = WUA_values[idx_max]
        
        return Q_opt, WUA_max
    
    def plot_habitat_simulation(self):
        """绘制生境模拟图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. 单因子适宜曲线
        ax1 = axes[0, 0]
        
        # 流速
        v_range = np.linspace(0, 2, 200)
        SI_v = self.velocity_suitability(v_range, v_opt=0.6, v_min=0.1, v_max=1.5)
        
        ax1.plot(v_range, SI_v, 'b-', linewidth=2.5, label='流速适宜度')
        ax1.axvline(0.6, color='r', linestyle='--', linewidth=1.5, alpha=0.7,
                   label='最适流速=0.6m/s')
        
        # 标注区域
        ax1.axvspan(0.1, 1.5, alpha=0.2, color='green', label='可接受范围')
        
        ax1.set_xlabel('流速 v (m/s)', fontsize=11)
        ax1.set_ylabel('适宜指数 SI', fontsize=11)
        ax1.set_title('流速适宜曲线（鲑鱼产卵）', fontsize=13, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        ax1.set_ylim([0, 1.1])
        
        # 2. 水深适宜曲线
        ax2 = axes[0, 1]
        
        h_range = np.linspace(0, 2, 200)
        
        k_values = [2, 3, 5]
        colors_k = ['blue', 'green', 'red']
        
        for k, color in zip(k_values, colors_k):
            SI_h = self.depth_suitability(h_range, h_min=0.2, k=k)
            ax2.plot(h_range, SI_h, color=color, linewidth=2.5,
                    label=f'k={k}')
        
        ax2.axvline(0.2, color='gray', linestyle='--', linewidth=1.5,
                   alpha=0.7, label='最小水深=0.2m')
        
        ax2.set_xlabel('水深 h (m)', fontsize=11)
        ax2.set_ylabel('适宜指数 SI', fontsize=11)
        ax2.set_title('水深适宜曲线（指数饱和型）', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        ax2.set_ylim([0, 1.1])
        
        # 3. 流量-栖息地关系（Q-WUA）
        ax3 = axes[1, 0]
        
        Q_range = np.linspace(5, 80, 100)
        b = 20  # m
        slope = 0.001
        
        # 不同底质
        d50_values = [8, 16, 32, 64]
        colors_d = ['orange', 'green', 'blue', 'red']
        labels_d = ['细砾石(8mm)', '中砾石(16mm)', '粗砾石(32mm)', '卵石(64mm)']
        
        for d50, color, label in zip(d50_values, colors_d, labels_d):
            WUA_values, _ = self.Q_WUA_curve(Q_range, b, slope, d50=d50)
            ax3.plot(Q_range, WUA_values, color=color, linewidth=2.5,
                    label=label)
        
        ax3.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_ylabel('加权可用面积 WUA (m²)', fontsize=11)
        ax3.set_title(f'流量-栖息地关系（b={b}m）', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 生境因子联合分布
        ax4 = axes[1, 1]
        
        # 固定d50=16mm，展示v-h联合适宜度
        v_grid = np.linspace(0.1, 1.5, 50)
        h_grid = np.linspace(0.1, 1.5, 50)
        V_mesh, H_mesh = np.meshgrid(v_grid, h_grid)
        
        HSI_mesh = np.zeros_like(V_mesh)
        
        for i in range(len(h_grid)):
            for j in range(len(v_grid)):
                SI_v = self.velocity_suitability(V_mesh[i, j])
                SI_h = self.depth_suitability(H_mesh[i, j])
                SI_s = self.substrate_suitability(16)
                HSI_mesh[i, j] = (SI_v * SI_h * SI_s)**(1/3)
        
        # 等值线图
        levels = np.linspace(0, 1, 11)
        contour = ax4.contourf(V_mesh, H_mesh, HSI_mesh, levels=levels,
                               cmap='RdYlGn', alpha=0.8)
        
        # 等值线
        contour_lines = ax4.contour(V_mesh, H_mesh, HSI_mesh,
                                    levels=[0.3, 0.5, 0.7, 0.9],
                                    colors='black', linewidths=1.5)
        ax4.clabel(contour_lines, inline=True, fontsize=10)
        
        # 色标
        cbar = plt.colorbar(contour, ax=ax4)
        cbar.set_label('HSI', fontsize=11)
        
        # 最优点标注
        ax4.plot(0.6, 0.4, 'r*', markersize=20, label='最优点(v=0.6, h=0.4)')
        
        ax4.set_xlabel('流速 v (m/s)', fontsize=11)
        ax4.set_ylabel('水深 h (m)', fontsize=11)
        ax4.set_title('流速-水深联合适宜度（d50=16mm）',
                     fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('habitat_simulation.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("水生生境模拟")
print("="*60)

hs = HabitatSimulation()

# 1. 单因子适宜度计算
print("1. 单因子适宜度计算:")

v_test = 0.8  # m/s
h_test = 0.5  # m
d50_test = 20  # mm

SI_v = hs.velocity_suitability(v_test, v_opt=0.6)
SI_h = hs.depth_suitability(h_test, h_min=0.2)
SI_s = hs.substrate_suitability(d50_test)

print(f"  流速 v = {v_test} m/s")
print(f"    适宜指数 SI_v = {SI_v:.3f}")
print(f"\n  水深 h = {h_test} m")
print(f"    适宜指数 SI_h = {SI_h:.3f}")
print(f"\n  底质 d50 = {d50_test} mm")
print(f"    适宜指数 SI_s = {SI_s:.3f}")

# 2. 复合适宜指数
print("\n" + "="*60)
print("2. 复合适宜指数（HSI）:")

HSI_geo = (SI_v * SI_h * SI_s)**(1/3)
HSI_arith = (SI_v + SI_h + SI_s) / 3
HSI_min = min(SI_v, SI_h, SI_s)

print(f"  几何平均: HSI = {HSI_geo:.3f}")
print(f"  算术平均: HSI = {HSI_arith:.3f}")
print(f"  最小值法: HSI = {HSI_min:.3f}")

# 3. 流量-栖息地关系
print("\n" + "="*60)
print("3. 流量-栖息地关系（Q-WUA）:")

Q_test = 30  # m³/s
b = 18  # m
slope = 0.0008
d50 = 16  # mm

result_wua = hs.calculate_WUA(Q_test, b, slope, d50=d50)

print(f"  流量 Q = {Q_test} m³/s")
print(f"  河宽 b = {b} m")
print(f"  坡度 i = {slope}")
print(f"  底质 d50 = {d50} mm")
print(f"\n  水力计算:")
print(f"    水深 h = {result_wua['h']:.3f} m")
print(f"    流速 v = {result_wua['v']:.3f} m/s")
print(f"\n  生境评价:")
print(f"    SI_v = {result_wua['SI_v']:.3f}")
print(f"    SI_h = {result_wua['SI_h']:.3f}")
print(f"    SI_s = {result_wua['SI_s']:.3f}")
print(f"    HSI = {result_wua['HSI']:.3f}")
print(f"    WUA = {result_wua['WUA']:.2f} m²")

# 4. 最优流量
print("\n" + "="*60)
print("4. 最优生态流量（最大WUA）:")

Q_range = np.linspace(10, 60, 100)
Q_opt, WUA_max = hs.optimal_flow(Q_range, b, slope, d50=d50)

print(f"  最优流量 Q_opt = {Q_opt:.1f} m³/s")
print(f"  最大WUA = {WUA_max:.2f} m²")

# 5. 不同生活史阶段
print("\n" + "="*60)
print("5. 不同生活史阶段最优流量:")

stages = {
    'spawning': {'v_opt': 0.6, 'v_min': 0.3, 'v_max': 1.0, 'h_min': 0.2},
    'fry': {'v_opt': 0.1, 'v_min': 0.0, 'v_max': 0.2, 'h_min': 0.1},
    'juvenile': {'v_opt': 0.4, 'v_min': 0.2, 'v_max': 0.6, 'h_min': 0.2},
    'adult': {'v_opt': 0.7, 'v_min': 0.3, 'v_max': 1.2, 'h_min': 0.4}
}

for stage, params in stages.items():
    # 简化：假设最优流量对应最适流速
    # Q = A·v = b·h·v，取典型水深
    h_typical = params['h_min'] * 2
    v_opt = params['v_opt']
    Q_stage = b * h_typical * v_opt
    
    stage_names = {
        'spawning': '产卵期',
        'fry': '仔鱼期',
        'juvenile': '幼鱼期',
        'adult': '成鱼期'
    }
    
    print(f"  {stage_names[stage]:8s}: Q_opt ≈ {Q_stage:.1f} m³/s  (v_opt={v_opt}m/s)")

# 6. 底质影响
print("\n" + "="*60)
print("6. 底质类型对栖息地的影响:")

d50_types = [(4, '沙'), (8, '细砾石'), (16, '中砾石'), (32, '粗砾石'),
             (64, '卵石'), (128, '巨石')]

Q_fixed = 35  # m³/s

for d50, name in d50_types:
    result = hs.calculate_WUA(Q_fixed, b, slope, d50=d50)
    
    print(f"  {name:8s} (d50={d50:3d}mm): SI_s={result['SI_s']:.2f}, "
          f"HSI={result['HSI']:.3f}, WUA={result['WUA']:.1f}m²")

# 绘图
print("\n绘制生境模拟图...")
hs.plot_habitat_simulation()
```

---

## 六、典型考题

### 【例题1】WUA计算（15分）

**题目**：矩形河道，$b=15$m，某流量下$h=0.6$m，$v=0.5$m/s，$d_{50}=20$mm。

已知适宜曲线：
- $SI_v(0.5) = 0.8$
- $SI_h(0.6) = 0.9$
- $SI_s(20) = 1.0$

求WUA（几何平均法）。

**【解答】**

$$HSI = (SI_v \times SI_h \times SI_s)^{1/3} = (0.8 \times 0.9 \times 1.0)^{1/3}$$

$$= (0.72)^{1/3} = 0.896$$

$$A_{wetted} = b \times h = 15 \times 0.6 = 9 \text{ m}^2$$

$$WUA = A_{wetted} \times HSI = 9 \times 0.896 = 8.06 \text{ m}^2$$

---

**本章重点**：
- 生境适宜曲线
- HSI与WUA计算
- Q-WUA关系
- PHABSIM框架

**下一章**：生态修复技术
