# 第9章：生态流量计算与保障

**学习时间**: 5小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、生态流量概述

### 1.1 定义与内涵

**生态流量（Ecological Flow）**：
维持河流生态系统健康和功能所需的最小流量、适宜流量及其动态变化过程。

**核心要素**：
1. **流量大小（Magnitude）**：最小、适宜、洪峰流量
2. **时间（Timing）**：季节性变化、洪水时机
3. **历时（Duration）**：持续时间
4. **频率（Frequency）**：年内出现次数
5. **变化率（Rate of change）**：涨落速度

### 1.2 生态功能

**河流生态流量的作用**：
1. 维持水生生物栖息地
2. 保障水质自净能力
3. 维持河流廊道连通性
4. 支持河岸带植被
5. 维持生物多样性
6. 保障河流地貌稳定

---

## 二、生态流量计算方法

### 2.1 水文学方法

#### (1) Tennant法（Montana法）

**原理**：基于多年平均流量的百分比

**推荐值**：

| 流量条件 | 占多年平均流量% | 河流状态 |
|----------|----------------|----------|
| 洪水 | 200% | 最优河道清理 |
| 最优生境 | 60-100% | 优良 |
| 良好生境 | 30-60% | 良好 |
| 最小生境 | 10-30% | 可接受 |
| 严重退化 | <10% | 差 |

**计算公式**：
$$Q_{eco} = \alpha \cdot \bar{Q}$$

其中：
- $\bar{Q}$：多年平均流量
- $\alpha$：推荐系数（0.1~1.0）

**例题1**：某河流多年平均流量$\bar{Q} = 50$ m³/s。
用Tennant法计算最小生态流量和适宜生态流量。

**解**：
- 最小生态流量（下限）：$Q_{eco,min} = 0.10 \times 50 = 5$ m³/s
- 良好生境（推荐）：$Q_{eco,good} = 0.30 \times 50 = 15$ m³/s
- 适宜生态流量（理想）：$Q_{eco,opt} = 0.60 \times 50 = 30$ m³/s

---

#### (2) 90%保证率法（Q90法）

**定义**：年内90%时间保证的流量

**计算步骤**：
1. 收集多年日流量数据
2. 对每年数据排序
3. 取90%保证率流量
4. 多年平均

**公式**：
$$Q_{90} = \frac{1}{n}\sum_{i=1}^n Q_{90,i}$$

**例题2**：某河流10年日流量数据，第5年365天流量已排序。
求当年$Q_{90}$（取$p=90\%$）。

**解**：
排位：$m = (1-p) \times n = (1-0.9) \times 365 = 36.5 \approx 37$

$Q_{90,5}$为第37小的流量值

重复10年，取平均：$Q_{90} = \frac{1}{10}\sum_{i=1}^{10} Q_{90,i}$

---

#### (3) 7Q10法

**定义**：10年重现期的7日最小流量

**适用**：低流量保护（如污染物稀释）

**计算**：
1. 提取每年最小连续7日平均流量
2. 频率分析（Pearson III或对数正态分布）
3. 求10年重现期流量

**公式**（P-III分布）：
$$\frac{Q_{7,T}}{\bar{Q}_7} = 1 + C_v \cdot \Phi_T$$

其中：
- $\bar{Q}_7$：历年7日最小流量均值
- $C_v$：变差系数
- $\Phi_T$：频率模比系数（查表）

---

### 2.2 水力学方法

#### (1) 湿周法（Wetted Perimeter Method）

**原理**：河床湿周与流量关系，拐点对应临界生态流量

**步骤**：
1. 测量河道横断面
2. 计算不同水位下的湿周$P$
3. 绘制$P-Q$曲线
4. 确定曲率最大点（拐点）

**湿周计算**：
矩形渠道：$P = b + 2h$
梯形渠道：$P = b + 2h\sqrt{1+m^2}$

**例题3**：矩形河道，宽$b=10$ m，曼宁系数$n=0.03$，坡度$i=0.001$。
计算水深$h=0.5, 1.0, 1.5, 2.0$ m时的湿周和流量。

**解**：

| $h$ (m) | $A = b \cdot h$ (m²) | $P = b + 2h$ (m) | $R = A/P$ (m) | $Q = \frac{1}{n}AR^{2/3}i^{1/2}$ (m³/s) |
|---------|---------------------|------------------|---------------|------------------------------------------|
| 0.5 | 5.0 | 11.0 | 0.455 | 2.73 |
| 1.0 | 10.0 | 12.0 | 0.833 | 8.45 |
| 1.5 | 15.0 | 13.0 | 1.154 | 17.70 |
| 2.0 | 20.0 | 14.0 | 1.429 | 30.47 |

绘制$P-Q$曲线，拐点对应生态流量（需进一步分析曲率）

---

#### (2) 水深-流速法

**原理**：保证河道内特定百分比面积满足水生生物的水深和流速要求

**判别标准**（鱼类）：
- 最小水深：$h_{min} = 0.3$ m（成鱼），$0.1$ m（幼鱼）
- 最小流速：$v_{min} = 0.2$ m/s
- 最大流速：$v_{max} = 1.5$ m/s

**面积比要求**：
$$\frac{A_{suitable}}{A_{total}} \geq 30\%$$

---

### 2.3 栖息地模拟法

#### PHABSIM（Physical HABitat SIMulation）

**框架**：
1. **水力模型**：计算不同流量下的水深、流速分布
2. **栖息地适宜性曲线（HSI）**：水深、流速、底质的适宜度
3. **加权可利用面积（WUA）**：
   $$WUA = \sum_{i=1}^n A_i \cdot HSI_i$$
   其中$HSI_i = HSI_d \times HSI_v \times HSI_s$

4. **最优流量**：WUA-Q曲线峰值对应流量

**例题4**：某河段划分为5个单元，流量$Q=10$ m³/s时：

| 单元 | 面积$A_i$ (m²) | 水深$h_i$ (m) | 流速$v_i$ (m/s) | $HSI_d$ | $HSI_v$ | $HSI_i$ |
|------|---------------|--------------|----------------|---------|---------|---------|
| 1 | 50 | 0.8 | 0.4 | 0.9 | 0.8 | 0.72 |
| 2 | 80 | 1.2 | 0.6 | 1.0 | 0.9 | 0.90 |
| 3 | 60 | 0.5 | 0.3 | 0.7 | 0.6 | 0.42 |
| 4 | 100 | 1.5 | 0.8 | 1.0 | 1.0 | 1.00 |
| 5 | 70 | 0.6 | 0.5 | 0.8 | 0.85 | 0.68 |

求WUA。

**解**：
$$WUA = 50 \times 0.72 + 80 \times 0.90 + 60 \times 0.42 + 100 \times 1.00 + 70 \times 0.68$$
$$= 36 + 72 + 25.2 + 100 + 47.6 = 280.8 \text{ m}^2$$

---

## 三、生态流量保障措施

### 3.1 水库生态调度

**原则**：
1. 保证下游最小生态流量
2. 模拟天然径流过程
3. 满足关键生态需求（如鱼类产卵期加大流量）

**调度规则**：
$$Q_{release}(t) = \max\{Q_{eco}(t), Q_{demand}(t)\}$$

**分层取水**：
- 夏季：从表层取水（避免冷水下泄）
- 冬季：从深层取水（保持适宜水温）

**例题5**：某水库，入库流量$Q_{in} = 30$ m³/s，
下游生态流量$Q_{eco} = 5$ m³/s，供水需求$Q_{supply} = 8$ m³/s。
求泄流量和蓄水量变化。

**解**：
泄流量：$Q_{release} = \max\{5, 8\} = 8$ m³/s

蓄水量变化率（不考虑损失）：
$$\frac{dV}{dt} = Q_{in} - Q_{release} = 30 - 8 = 22 \text{ m}^3/\text{s}$$

日蓄水增量：$\Delta V = 22 \times 86400 = 1.9 \times 10^6$ m³ = 190万m³

---

### 3.2 生态补偿机制

**补偿类型**：
1. **水量补偿**：上游向下游补偿生态流量
2. **经济补偿**：生态效益受损地区获得经济补偿
3. **工程补偿**：建设鱼道、湿地等生态设施

**补偿计算**：
$$C = P_{water} \cdot Q_{eco} \cdot T + C_{ecological}$$

其中：
- $P_{water}$：水价（元/m³）
- $Q_{eco}$：生态流量（m³/s）
- $T$：时间（s）
- $C_{ecological}$：生态效益损失

---

### 3.3 监测与管理

**监测指标**：
1. **水文指标**：流量、水位、流速
2. **水质指标**：DO、COD、氨氮、TP
3. **生物指标**：鱼类种群、底栖动物、浮游生物
4. **栖息地指标**：湿周、WUA、连通性

**监测频率**：
- 流量：连续自动监测
- 水质：枯水期每周，丰水期每月
- 生物：春秋季各1次

**预警阈值**：
$$\begin{cases}
Q < 0.5 Q_{eco} & \text{红色预警（严重不足）} \\
0.5 Q_{eco} \leq Q < Q_{eco} & \text{黄色预警（偏低）} \\
Q \geq Q_{eco} & \text{正常}
\end{cases}$$

---

## 四、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d
from scipy.optimize import minimize_scalar

class EcologicalFlow:
    """生态流量计算与评估工具"""
    
    def __init__(self, g=9.81):
        self.g = g
    
    @staticmethod
    def tennant_method(Q_avg, level='minimum'):
        """
        Tennant法计算生态流量
        
        参数:
            Q_avg: 多年平均流量 (m³/s)
            level: 'minimum' (10%), 'fair' (30%), 'good' (60%)
        
        返回:
            Q_eco: 生态流量 (m³/s)
        """
        levels = {
            'minimum': 0.10,
            'degraded': 0.20,
            'fair': 0.30,
            'good': 0.60,
            'excellent': 1.00
        }
        
        alpha = levels.get(level, 0.30)
        Q_eco = alpha * Q_avg
        
        return Q_eco
    
    @staticmethod
    def Q90_method(daily_flows):
        """
        90%保证率法
        
        参数:
            daily_flows: 多年日流量数据 (二维数组，每行一年)
        
        返回:
            Q90: 90%保证率流量 (m³/s)
        """
        Q90_annual = []
        
        for year_data in daily_flows:
            # 排序
            sorted_Q = np.sort(year_data)
            # 90%保证率位置（10%分位数）
            idx = int(0.10 * len(sorted_Q))
            Q90_annual.append(sorted_Q[idx])
        
        Q90 = np.mean(Q90_annual)
        
        return Q90
    
    @staticmethod
    def wetted_perimeter_method(b, n, i, h_range):
        """
        湿周法
        
        参数:
            b: 河宽 (m)
            n: 曼宁系数
            i: 河床坡度
            h_range: 水深范围 (m)
        
        返回:
            h, Q, P: 水深、流量、湿周数组
            h_eco: 拐点对应的生态流量水深
        """
        h = np.array(h_range)
        
        # 矩形断面
        A = b * h
        P = b + 2 * h
        R = A / P
        
        # 曼宁公式
        Q = (1 / n) * A * R**(2/3) * i**0.5
        
        # 计算曲率（二阶差分近似）
        dP_dQ = np.gradient(P, Q)
        d2P_dQ2 = np.gradient(dP_dQ, Q)
        
        # 曲率最大点
        idx_max_curvature = np.argmax(np.abs(d2P_dQ2))
        h_eco = h[idx_max_curvature]
        
        return h, Q, P, h_eco
    
    @staticmethod
    def PHABSIM_WUA(cells, HSI_curves):
        """
        PHABSIM加权可利用面积计算
        
        参数:
            cells: 单元数据，字典列表
                   [{'A': 面积, 'h': 水深, 'v': 流速, 's': 底质}, ...]
            HSI_curves: HSI曲线字典
                        {'depth': func, 'velocity': func, 'substrate': func}
        
        返回:
            WUA: 加权可利用面积 (m²)
        """
        WUA = 0
        
        for cell in cells:
            # 计算各因子HSI
            HSI_d = HSI_curves['depth'](cell['h'])
            HSI_v = HSI_curves['velocity'](cell['v'])
            HSI_s = HSI_curves['substrate'](cell['s'])
            
            # 综合HSI（几何平均或乘积）
            HSI_total = HSI_d * HSI_v * HSI_s
            
            # 累加WUA
            WUA += cell['A'] * HSI_total
        
        return WUA
    
    @staticmethod
    def reservoir_eco_dispatch(Q_in, Q_eco, Q_demand, V_current, V_max):
        """
        水库生态调度
        
        参数:
            Q_in: 入库流量 (m³/s)
            Q_eco: 生态流量需求 (m³/s)
            Q_demand: 其他需水（供水、发电等） (m³/s)
            V_current: 当前库容 (m³)
            V_max: 最大库容 (m³)
        
        返回:
            Q_release: 泄流量 (m³/s)
            dV: 蓄水量变化 (m³/s)
        """
        # 最小泄流：生态流量和需水的最大值
        Q_min = max(Q_eco, Q_demand)
        
        # 考虑库容约束
        if V_current >= V_max:
            # 库满，弃水
            Q_release = Q_in
        elif V_current <= 0:
            # 库空，泄流不超过入流
            Q_release = min(Q_in, Q_min)
        else:
            # 正常调度
            Q_release = Q_min
        
        # 蓄水变化
        dV = Q_in - Q_release
        
        return Q_release, dV
    
    @staticmethod
    def plot_eco_flow_analysis():
        """可视化生态流量分析"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))
        
        # 1. Tennant法
        ax1 = axes[0, 0]
        
        Q_avg = 50  # m³/s
        levels = ['minimum', 'degraded', 'fair', 'good', 'excellent']
        Q_eco_values = [EcologicalFlow.tennant_method(Q_avg, lv) for lv in levels]
        
        colors = ['red', 'orange', 'yellow', 'lightgreen', 'green']
        bars = ax1.barh(levels, Q_eco_values, color=colors, edgecolor='black')
        
        ax1.axvline(Q_avg, color='blue', linestyle='--', linewidth=2,
                   label=f'多年平均流量 {Q_avg} m³/s')
        
        for i, (lv, q) in enumerate(zip(levels, Q_eco_values)):
            ax1.text(q + 1, i, f'{q:.1f} m³/s', va='center', fontsize=10)
        
        ax1.set_xlabel('流量 (m³/s)', fontsize=11)
        ax1.set_title('Tennant法生态流量分级', fontsize=12, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3, axis='x')
        
        # 2. 湿周法
        ax2 = axes[0, 1]
        
        b, n, i = 10, 0.03, 0.001
        h_range = np.linspace(0.2, 3.0, 50)
        
        h, Q, P, h_eco = EcologicalFlow.wetted_perimeter_method(b, n, i, h_range)
        
        ax2.plot(Q, P, linewidth=2, color='darkblue')
        
        # 拐点
        P_eco = np.interp(h_eco, h, P)
        Q_eco_wp = np.interp(h_eco, h, Q)
        ax2.plot(Q_eco_wp, P_eco, 'ro', markersize=12, 
                label=f'拐点: Q={Q_eco_wp:.2f} m³/s')
        
        ax2.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax2.set_ylabel('湿周 P (m)', fontsize=11)
        ax2.set_title('湿周法生态流量确定', fontsize=12, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. PHABSIM-WUA曲线
        ax3 = axes[1, 0]
        
        # 模拟WUA-Q关系
        Q_range = np.linspace(5, 100, 20)
        WUA_values = []
        
        # 简化HSI曲线（三角形）
        HSI_depth = lambda h: min(1.0, max(0, h - 0.2) / 1.0) if h < 1.2 else max(0, 2.0 - h)
        HSI_velocity = lambda v: min(1.0, max(0, v - 0.1) / 0.5) if v < 0.6 else max(0, (1.5 - v) / 0.9)
        
        for Q in Q_range:
            # 假设水深-流量关系：h = 0.05*Q^0.4
            h_avg = 0.05 * Q**0.4
            v_avg = Q / (b * h_avg)
            
            cells = [
                {'A': 100, 'h': h_avg, 'v': v_avg, 's': 0.8},
                {'A': 150, 'h': h_avg * 1.2, 'v': v_avg * 0.8, 's': 0.9},
                {'A': 120, 'h': h_avg * 0.9, 'v': v_avg * 1.1, 's': 0.7}
            ]
            
            HSI_curves = {
                'depth': HSI_depth,
                'velocity': HSI_velocity,
                'substrate': lambda s: s
            }
            
            WUA = EcologicalFlow.PHABSIM_WUA(cells, HSI_curves)
            WUA_values.append(WUA)
        
        ax3.plot(Q_range, WUA_values, linewidth=2, color='darkgreen', marker='o')
        
        # 最大WUA
        idx_max = np.argmax(WUA_values)
        Q_opt = Q_range[idx_max]
        WUA_max = WUA_values[idx_max]
        
        ax3.plot(Q_opt, WUA_max, 'r*', markersize=20,
                label=f'最优流量: {Q_opt:.1f} m³/s')
        
        ax3.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_ylabel('WUA (m²)', fontsize=11)
        ax3.set_title('PHABSIM栖息地模拟（WUA-Q曲线）', fontsize=12, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 水库生态调度
        ax4 = axes[1, 1]
        
        # 模拟30天调度
        np.random.seed(42)
        days = 30
        Q_in_series = 30 + 20 * np.sin(np.linspace(0, 2*np.pi, days)) + np.random.randn(days) * 5
        Q_in_series = np.maximum(Q_in_series, 5)  # 不低于5
        
        Q_eco = 10  # m³/s
        Q_demand = 8
        V_max = 1e8  # m³
        V_current = 5e7
        
        Q_release_series = []
        V_series = [V_current]
        
        dt = 86400  # 1天秒数
        
        for Q_in in Q_in_series:
            Q_release, dV = EcologicalFlow.reservoir_eco_dispatch(
                Q_in, Q_eco, Q_demand, V_series[-1], V_max
            )
            
            Q_release_series.append(Q_release)
            V_new = V_series[-1] + dV * dt
            V_new = np.clip(V_new, 0, V_max)
            V_series.append(V_new)
        
        V_series = np.array(V_series[:-1]) / 1e8  # 转为亿m³
        
        ax4_twin = ax4.twinx()
        
        t = np.arange(days)
        line1 = ax4.plot(t, Q_in_series, 'b-', linewidth=2, label='入库流量')
        line2 = ax4.plot(t, Q_release_series, 'r--', linewidth=2, label='泄流量')
        ax4.axhline(Q_eco, color='green', linestyle=':', linewidth=2, label='生态流量')
        
        line3 = ax4_twin.plot(t, V_series, 'orange', linewidth=2, label='库容')
        
        ax4.set_xlabel('时间 (天)', fontsize=11)
        ax4.set_ylabel('流量 (m³/s)', fontsize=11, color='black')
        ax4_twin.set_ylabel('库容 (亿m³)', fontsize=11, color='orange')
        ax4.set_title('水库生态调度过程', fontsize=12, fontweight='bold')
        
        # 合并图例
        lines = line1 + line2 + [ax4.lines[2]] + line3
        labels = [l.get_label() for l in lines]
        ax4.legend(lines, labels, loc='upper left')
        
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('ecological_flow_analysis.png', dpi=300)
        plt.show()

# 示例使用
print("="*60)
print("生态流量计算与保障")
print("="*60)

ef = EcologicalFlow()

# 1. Tennant法
print("\n1. Tennant法")
Q_avg = 50  # m³/s

for level in ['minimum', 'fair', 'good']:
    Q_eco = ef.tennant_method(Q_avg, level)
    print(f"  {level:12s}: Q_eco = {Q_eco:5.1f} m³/s ({Q_eco/Q_avg*100:.0f}% of 平均流量)")

# 2. Q90法
print("\n" + "="*60)
print("2. 90%保证率法")

# 模拟10年日流量数据
np.random.seed(42)
daily_flows = []
for year in range(10):
    # 模拟年内变化（正弦+随机）
    t = np.linspace(0, 2*np.pi, 365)
    Q_year = 50 + 30*np.sin(t) + np.random.randn(365)*10
    Q_year = np.maximum(Q_year, 5)  # 不低于5
    daily_flows.append(Q_year)

daily_flows = np.array(daily_flows)

Q90 = ef.Q90_method(daily_flows)
print(f"  10年数据计算的Q90 = {Q90:.2f} m³/s")

# 3. 湿周法
print("\n" + "="*60)
print("3. 湿周法")

b, n, i = 10, 0.03, 0.001
h_range = np.linspace(0.2, 2.0, 20)

h, Q, P, h_eco = ef.wetted_perimeter_method(b, n, i, h_range)

Q_eco_wp = np.interp(h_eco, h, Q)
print(f"  河宽b = {b} m, n = {n}, i = {i}")
print(f"  拐点水深h = {h_eco:.2f} m")
print(f"  对应生态流量Q_eco = {Q_eco_wp:.2f} m³/s")

# 4. PHABSIM
print("\n" + "="*60)
print("4. PHABSIM栖息地模拟")

cells = [
    {'A': 50, 'h': 0.8, 'v': 0.4, 's': 0.8},
    {'A': 80, 'h': 1.2, 'v': 0.6, 's': 0.9},
    {'A': 60, 'h': 0.5, 'v': 0.3, 's': 0.7},
    {'A': 100, 'h': 1.5, 'v': 0.8, 's': 1.0},
    {'A': 70, 'h': 0.6, 'v': 0.5, 's': 0.85}
]

# 简化HSI曲线（线性）
HSI_curves = {
    'depth': lambda h: min(1.0, h / 1.5),
    'velocity': lambda v: min(1.0, v / 1.0),
    'substrate': lambda s: s
}

WUA = ef.PHABSIM_WUA(cells, HSI_curves)
print(f"  单元数: {len(cells)}")
print(f"  WUA = {WUA:.2f} m²")

# 5. 水库生态调度
print("\n" + "="*60)
print("5. 水库生态调度")

Q_in, Q_eco, Q_demand = 30, 10, 8
V_current = 5e7  # 5000万m³
V_max = 1e8      # 1亿m³

Q_release, dV = ef.reservoir_eco_dispatch(Q_in, Q_eco, Q_demand, V_current, V_max)

print(f"  入库流量: {Q_in} m³/s")
print(f"  生态流量需求: {Q_eco} m³/s")
print(f"  供水需求: {Q_demand} m³/s")
print(f"  泄流量: {Q_release} m³/s")
print(f"  蓄水变化率: {dV:+.2f} m³/s = {dV*86400/1e4:+.2f}万m³/天")

# 可视化
print("\n绘制生态流量分析可视化...")
ef.plot_eco_flow_analysis()
```

---

## 五、本章要点

### 核心公式

1. **Tennant法**：$Q_{eco} = \alpha \cdot \bar{Q}$（$\alpha=0.1\sim1.0$）

2. **曼宁公式**：$Q = \frac{1}{n}AR^{2/3}i^{1/2}$

3. **湿周**：矩形$P = b + 2h$，梯形$P = b + 2h\sqrt{1+m^2}$

4. **WUA**：$WUA = \sum A_i \cdot HSI_i$，$HSI_i = HSI_d \times HSI_v \times HSI_s$

5. **调度规则**：$Q_{release} = \max\{Q_{eco}, Q_{demand}\}$

### 方法对比

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| Tennant法 | 简单快速 | 忽略河流特性 | 初步评估 |
| Q90法 | 基于实测数据 | 需长序列 | 水文资料充足 |
| 湿周法 | 考虑河道几何 | 需实测断面 | 中小河流 |
| PHABSIM | 综合生物需求 | 数据需求大 | 精细化评估 |

---

**本章重点**：
- 生态流量的定义与五要素
- 水文学方法（Tennant, Q90, 7Q10）
- 水力学方法（湿周法、水深流速法）
- 栖息地模拟法（PHABSIM, WUA）
- 水库生态调度与补偿机制
- Python实现与可视化

**下一章**：河流生态修复综合案例
