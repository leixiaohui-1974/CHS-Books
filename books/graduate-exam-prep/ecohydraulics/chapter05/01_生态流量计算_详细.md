# 第5章：生态流量计算与实践

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、生态流量的定义与意义

### 1.1 基本概念

**生态流量（Ecological Flow）**：维持河流生态系统健康和生物多样性所需的最小流量。

**核心目标**：
- 维持水生生物栖息地
- 保障河流自净能力
- 维持河道形态稳定
- 支持生态系统服务功能

### 1.2 生态流量分类

1. **最小生态流量**：维持生态系统基本功能的绝对下限
2. **适宜生态流量**：满足生态系统健康需求的理想流量范围
3. **洪水脉冲流量**：维持河漫滩生态系统和鱼类繁殖的周期性高流量

---

## 二、Tennant法（蒙大拿法）

### 2.1 基本原理

根据多年平均流量的百分比确定生态流量：

$$Q_{eco} = \alpha \cdot Q_{avg}$$

**参数说明**：
- $Q_{eco}$：生态流量（m³/s）
- $Q_{avg}$：多年平均流量（m³/s）
- $\alpha$：推荐系数

### 2.2 推荐标准

| 河流状态 | 推荐流量（占多年平均） | 生态效果 |
|---------|---------------------|---------|
| 极佳 | 60-100% | 最佳栖息地条件 |
| 优秀 | 40-60% | 良好栖息地，支持繁殖 |
| 良好 | 30-40% | 栖息地质量下降，但可接受 |
| 一般 | 20-30% | 勉强维持，栖息地退化 |
| 较差 | 10-20% | 严重退化，生存困难 |
| 极差 | <10% | 生态系统濒临崩溃 |

**我国常用标准**：
- 一般河流：$Q_{eco} = 10\% \sim 20\% \times Q_{avg}$
- 重要河流：$Q_{eco} = 30\% \sim 40\% \times Q_{avg}$

---

## 三、湿周法（Wetted Perimeter Method）

### 3.1 基本原理

通过分析流量与湿周关系，确定湿周急剧减小的拐点对应的流量作为生态流量。

**湿周定义**：过水断面中，水与河床接触的边界长度。

$$P = b + 2h\sqrt{1 + m^2}$$

（梯形断面，$b$为底宽，$h$为水深，$m$为边坡系数）

### 3.2 拐点判定

绘制$P \sim Q$曲线，找到曲率最大点（拐点）：

$$\frac{d^2P}{dQ^2} = 0$$

该点对应的流量即为**最小生态流量**。

### 3.3 物理意义

- 流量减小→水深下降→湿周快速减少
- 拐点处：水生生物可利用栖息地面积显著下降
- 低于拐点流量：生态功能严重受损

---

## 四、栖息地模拟法（PHABSIM）

### 4.1 加权可利用面积（WUA）

$$WUA = \sum_{i=1}^{n} A_i \cdot SI_i$$

**参数说明**：
- $WUA$：加权可利用面积（m²）
- $A_i$：第$i$个单元面积（m²）
- $SI_i$：第$i$个单元的综合适宜度指数（0-1）

### 4.2 综合适宜度指数

$$SI_i = SI_{depth}(h_i) \times SI_{velocity}(v_i) \times SI_{substrate}(d_{50,i})$$

**影响因子**：
- $SI_{depth}$：水深适宜度（目标鱼种偏好）
- $SI_{velocity}$：流速适宜度
- $SI_{substrate}$：底质适宜度

### 4.3 生态流量确定

绘制$WUA \sim Q$曲线：
- **推荐生态流量**：WUA达到最大值的90%对应的最小流量
- **最小生态流量**：WUA达到最大值的50%对应的最小流量

---

## 五、7Q10法（美国EPA方法）

### 5.1 定义

**7Q10**：10年一遇的连续7天最小流量。

$$Q_{7,10} = \min\{Q_{7,T=10}\}$$

**物理意义**：在10年回归期内，连续7天流量的最小平均值。

### 5.2 计算步骤

1. 统计历年连续7天最小流量序列$\{Q_{7,i}\}$
2. 频率分析（如Pearson-III型分布）
3. 推求频率$P=10\%$（10年一遇）对应的$Q_{7,10}$

**适用范围**：主要用于美国，我国较少采用。

---

## 六、逐月最小流量法

### 6.1 基本原理

考虑季节变化，分别确定每月生态流量：

$$Q_{eco,m} = \alpha_m \cdot Q_{avg,m}$$

**参数说明**：
- $Q_{eco,m}$：第$m$月生态流量
- $Q_{avg,m}$：第$m$月多年平均流量
- $\alpha_m$：第$m$月推荐系数（丰水期可取较大值，枯水期取较小值）

### 6.2 推荐标准

| 季节 | 推荐系数$\alpha$ | 说明 |
|------|----------------|------|
| 丰水期（6-9月） | 20-30% | 维持较好栖息地 |
| 平水期（4-5,10-11月） | 15-25% | 基本需求 |
| 枯水期（12-3月） | 10-15% | 最小需求 |
| 鱼类繁殖期 | 40-60% | 短期高流量脉冲 |

---

## 七、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d
from scipy.signal import argrelextrema

class EcologicalFlow:
    """生态流量计算"""
    
    @staticmethod
    def tennant_method(Q_avg, level='good'):
        """
        Tennant法（蒙大拿法）
        
        参数:
            Q_avg: 多年平均流量 (m³/s)
            level: 'excellent', 'outstanding', 'good', 'fair', 'poor', 'minimum'
        
        返回:
            Q_eco: 生态流量 (m³/s)
            alpha: 推荐系数
        """
        standards = {
            'excellent': (0.6, 1.0),     # 60-100%
            'outstanding': (0.4, 0.6),   # 40-60%
            'good': (0.3, 0.4),          # 30-40%
            'fair': (0.2, 0.3),          # 20-30%
            'poor': (0.1, 0.2),          # 10-20%
            'minimum': (0.1, 0.1)        # 10%
        }
        
        alpha_min, alpha_max = standards.get(level, (0.2, 0.3))
        alpha = (alpha_min + alpha_max) / 2
        
        Q_eco = alpha * Q_avg
        
        return Q_eco, alpha
    
    @staticmethod
    def wetted_perimeter_method(Q_series, geometry_params, plot=False):
        """
        湿周法
        
        参数:
            Q_series: 流量序列 (m³/s)
            geometry_params: {'type': 'trapezoidal', 'b': 底宽, 'n': 糙率, 
                            'm': 边坡, 'S': 坡度}
        
        返回:
            Q_eco: 生态流量 (m³/s)
            P_series: 湿周序列 (m)
        """
        # 梯形断面参数
        b = geometry_params['b']
        m = geometry_params['m']
        n = geometry_params['n']
        S = geometry_params['S']
        
        P_series = []
        
        for Q in Q_series:
            # 曼宁公式求水深（迭代）
            def equation(h):
                A = (b + m * h) * h
                P = b + 2 * h * np.sqrt(1 + m**2)
                R = A / P
                Q_calc = (1/n) * A * R**(2/3) * np.sqrt(S)
                return Q_calc - Q
            
            from scipy.optimize import fsolve
            h = fsolve(equation, 1.0)[0]
            
            # 计算湿周
            P = b + 2 * h * np.sqrt(1 + m**2)
            P_series.append(P)
        
        P_series = np.array(P_series)
        
        # 寻找拐点（湿周变化率最大）
        dP_dQ = np.gradient(P_series, Q_series)
        d2P_dQ2 = np.gradient(dP_dQ, Q_series)
        
        # 找到二阶导数接近0的点（拐点）
        inflection_idx = np.argmin(np.abs(d2P_dQ2))
        Q_eco = Q_series[inflection_idx]
        
        if plot:
            fig, axes = plt.subplots(1, 2, figsize=(14, 5))
            
            # P-Q曲线
            ax1 = axes[0]
            ax1.plot(Q_series, P_series, 'b-', linewidth=2, label='P-Q曲线')
            ax1.axvline(Q_eco, color='r', linestyle='--', linewidth=2,
                       label=f'拐点：Q_eco={Q_eco:.2f} m³/s')
            ax1.scatter([Q_eco], [P_series[inflection_idx]], color='r', s=100, zorder=5)
            ax1.set_xlabel('流量 Q (m³/s)', fontsize=11)
            ax1.set_ylabel('湿周 P (m)', fontsize=11)
            ax1.set_title('湿周法：P-Q关系', fontsize=13, fontweight='bold')
            ax1.legend()
            ax1.grid(True, alpha=0.3)
            
            # 二阶导数
            ax2 = axes[1]
            ax2.plot(Q_series, d2P_dQ2, 'g-', linewidth=2)
            ax2.axhline(0, color='k', linestyle='-', linewidth=0.5)
            ax2.axvline(Q_eco, color='r', linestyle='--', linewidth=2)
            ax2.set_xlabel('流量 Q (m³/s)', fontsize=11)
            ax2.set_ylabel('d²P/dQ² (m·s²/m⁶)', fontsize=11)
            ax2.set_title('二阶导数（拐点判定）', fontsize=13, fontweight='bold')
            ax2.grid(True, alpha=0.3)
            
            plt.tight_layout()
            plt.savefig('wetted_perimeter_method.png', dpi=300)
            plt.show()
        
        return Q_eco, P_series
    
    @staticmethod
    def phabsim_method(Q_series, habitat_data):
        """
        栖息地模拟法（PHABSIM）
        
        参数:
            Q_series: 流量序列 (m³/s)
            habitat_data: 栖息地数据函数 (Q -> WUA)
        
        返回:
            Q_eco_min: 最小生态流量 (m³/s)
            Q_eco_rec: 推荐生态流量 (m³/s)
            WUA_series: WUA序列
        """
        WUA_series = np.array([habitat_data(Q) for Q in Q_series])
        
        WUA_max = np.max(WUA_series)
        
        # 最小生态流量：WUA达到最大值50%
        target_WUA_min = 0.5 * WUA_max
        idx_min = np.argmin(np.abs(WUA_series - target_WUA_min))
        Q_eco_min = Q_series[idx_min]
        
        # 推荐生态流量：WUA达到最大值90%
        target_WUA_rec = 0.9 * WUA_max
        idx_rec = np.argmin(np.abs(WUA_series - target_WUA_rec))
        Q_eco_rec = Q_series[idx_rec]
        
        return Q_eco_min, Q_eco_rec, WUA_series
    
    @staticmethod
    def monthly_minimum_flow(Q_monthly_avg, alpha_monthly=None):
        """
        逐月最小流量法
        
        参数:
            Q_monthly_avg: 各月多年平均流量 (12个值)
            alpha_monthly: 各月推荐系数（默认按季节）
        
        返回:
            Q_eco_monthly: 各月生态流量
        """
        if alpha_monthly is None:
            # 默认系数（我国北方河流）
            alpha_monthly = np.array([
                0.12, 0.12, 0.12,  # 1-3月（枯水期）
                0.20, 0.25,        # 4-5月（平水期）
                0.30, 0.30, 0.30, 0.25,  # 6-9月（丰水期）
                0.20,              # 10月（平水期）
                0.15, 0.12         # 11-12月（枯水期）
            ])
        
        Q_eco_monthly = alpha_monthly * Q_monthly_avg
        
        return Q_eco_monthly
    
    @staticmethod
    def plot_comparison(Q_avg, Q_monthly_avg):
        """绘制多种方法对比"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. Tennant法对比
        ax1 = axes[0, 0]
        levels = ['minimum', 'poor', 'fair', 'good', 'outstanding', 'excellent']
        Q_tennant = []
        alphas = []
        
        for level in levels:
            Q_eco, alpha = EcologicalFlow.tennant_method(Q_avg, level)
            Q_tennant.append(Q_eco)
            alphas.append(alpha * 100)
        
        colors = plt.cm.RdYlGn(np.linspace(0.2, 0.9, len(levels)))
        bars = ax1.barh(levels, Q_tennant, color=colors, alpha=0.8)
        
        for bar, alpha in zip(bars, alphas):
            width = bar.get_width()
            ax1.text(width + 0.5, bar.get_y() + bar.get_height()/2,
                    f'{alpha:.0f}%', va='center', fontsize=10)
        
        ax1.axvline(Q_avg, color='blue', linestyle='--', linewidth=2,
                   label=f'多年平均流量={Q_avg:.1f}m³/s')
        ax1.set_xlabel('生态流量 (m³/s)', fontsize=11)
        ax1.set_title('Tennant法：不同等级生态流量', fontsize=13, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3, axis='x')
        
        # 2. 湿周法演示
        ax2 = axes[0, 1]
        Q_series = np.linspace(0.1, 50, 100)
        geometry = {'b': 20, 'm': 2, 'n': 0.03, 'S': 0.001}
        
        Q_eco_wp, P_series = EcologicalFlow.wetted_perimeter_method(
            Q_series, geometry, plot=False)
        
        ax2.plot(Q_series, P_series, 'b-', linewidth=2.5)
        ax2.axvline(Q_eco_wp, color='r', linestyle='--', linewidth=2,
                   label=f'拐点：Q_eco={Q_eco_wp:.2f}m³/s')
        ax2.scatter([Q_eco_wp], [P_series[np.argmin(np.abs(Q_series-Q_eco_wp))]],
                   color='r', s=150, zorder=5, marker='*')
        ax2.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax2.set_ylabel('湿周 P (m)', fontsize=11)
        ax2.set_title('湿周法：拐点识别', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. PHABSIM法演示
        ax3 = axes[1, 0]
        
        # 模拟WUA曲线（逻辑斯蒂增长模型）
        def habitat_model(Q):
            K = 1000  # 最大WUA
            r = 0.2
            Q0 = 10
            return K / (1 + np.exp(-r * (Q - Q0)))
        
        Q_series_hab = np.linspace(0, 50, 200)
        Q_eco_min, Q_eco_rec, WUA_series = EcologicalFlow.phabsim_method(
            Q_series_hab, habitat_model)
        
        ax3.plot(Q_series_hab, WUA_series, 'g-', linewidth=2.5, label='WUA曲线')
        ax3.axvline(Q_eco_min, color='orange', linestyle='--', linewidth=2,
                   label=f'最小生态流量={Q_eco_min:.1f}m³/s')
        ax3.axvline(Q_eco_rec, color='red', linestyle='--', linewidth=2,
                   label=f'推荐生态流量={Q_eco_rec:.1f}m³/s')
        ax3.axhline(np.max(WUA_series)*0.5, color='orange', linestyle=':', alpha=0.5)
        ax3.axhline(np.max(WUA_series)*0.9, color='red', linestyle=':', alpha=0.5)
        ax3.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_ylabel('加权可利用面积 WUA (m²)', fontsize=11)
        ax3.set_title('PHABSIM法：WUA-Q关系', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 逐月生态流量
        ax4 = axes[1, 1]
        
        Q_eco_monthly = EcologicalFlow.monthly_minimum_flow(Q_monthly_avg)
        months = np.arange(1, 13)
        
        ax4.bar(months, Q_monthly_avg, alpha=0.5, label='多年平均流量', color='skyblue')
        ax4.plot(months, Q_eco_monthly, 'ro-', linewidth=2.5, markersize=8,
                label='生态流量', markerfacecolor='red')
        
        # 季节标注
        ax4.axvspan(6, 9, alpha=0.1, color='green', label='丰水期')
        ax4.axvspan(12, 13, alpha=0.1, color='yellow')
        ax4.axvspan(0, 3, alpha=0.1, color='yellow', label='枯水期')
        
        ax4.set_xlabel('月份', fontsize=11)
        ax4.set_ylabel('流量 (m³/s)', fontsize=11)
        ax4.set_title('逐月生态流量', fontsize=13, fontweight='bold')
        ax4.set_xticks(months)
        ax4.legend()
        ax4.grid(True, alpha=0.3, axis='y')
        
        plt.tight_layout()
        plt.savefig('ecological_flow_comparison.png', dpi=300)
        plt.show()

# 示例1：Tennant法
print("="*60)
print("示例1：Tennant法计算生态流量")
print("="*60)

Q_avg = 30.0  # m³/s

print(f"河流多年平均流量: Q_avg = {Q_avg} m³/s\n")

levels = ['minimum', 'poor', 'fair', 'good', 'outstanding', 'excellent']
level_names = ['最小', '较差', '一般', '良好', '优秀', '极佳']

print(f"{'等级':<10s} {'生态流量(m³/s)':<18s} {'占比':<10s}")
print("-" * 45)

for level, name in zip(levels, level_names):
    Q_eco, alpha = EcologicalFlow.tennant_method(Q_avg, level)
    print(f"{name:<10s} {Q_eco:<18.2f} {alpha*100:.0f}%")

print(f"\n推荐标准（我国一般河流）：{0.15*Q_avg:.2f} - {0.25*Q_avg:.2f} m³/s")

# 示例2：湿周法
print("\n" + "="*60)
print("示例2：湿周法计算生态流量")
print("="*60)

Q_series = np.linspace(0.5, 50, 100)
geometry = {
    'type': 'trapezoidal',
    'b': 20,    # 底宽 (m)
    'm': 2,     # 边坡系数
    'n': 0.03,  # 糙率
    'S': 0.001  # 坡度
}

print(f"断面参数:")
print(f"  底宽 b = {geometry['b']} m")
print(f"  边坡 m = {geometry['m']}")
print(f"  糙率 n = {geometry['n']}")
print(f"  坡度 S = {geometry['S']}")

Q_eco_wp, P_series = EcologicalFlow.wetted_perimeter_method(
    Q_series, geometry, plot=True)

print(f"\n计算结果:")
print(f"  生态流量（拐点法）：Q_eco = {Q_eco_wp:.2f} m³/s")

# 示例3：PHABSIM法
print("\n" + "="*60)
print("示例3：栖息地模拟法（PHABSIM）")
print("="*60)

# 简化的WUA模型
def habitat_model(Q):
    """简化的鱼类栖息地模型"""
    K = 800    # 最大WUA (m²)
    r = 0.25   # 增长率
    Q0 = 8     # 半饱和流量 (m³/s)
    return K / (1 + np.exp(-r * (Q - Q0)))

Q_series_hab = np.linspace(0, 40, 200)

Q_eco_min, Q_eco_rec, WUA_series = EcologicalFlow.phabsim_method(
    Q_series_hab, habitat_model)

print(f"计算结果:")
print(f"  最大WUA = {np.max(WUA_series):.1f} m²")
print(f"  最小生态流量（50% WUA_max）：Q_eco_min = {Q_eco_min:.2f} m³/s")
print(f"  推荐生态流量（90% WUA_max）：Q_eco_rec = {Q_eco_rec:.2f} m³/s")

# 示例4：逐月生态流量
print("\n" + "="*60)
print("示例4：逐月最小流量法")
print("="*60)

# 某河流各月多年平均流量
Q_monthly_avg = np.array([
    8.5, 9.2, 12.5, 18.3, 25.6,   # 1-5月
    45.2, 52.8, 48.3, 38.7,       # 6-9月（丰水期）
    22.4, 14.8, 10.2              # 10-12月
])

Q_eco_monthly = EcologicalFlow.monthly_minimum_flow(Q_monthly_avg)

print(f"{'月份':<6s} {'平均流量(m³/s)':<18s} {'生态流量(m³/s)':<18s} {'占比':<8s}")
print("-" * 55)

for month in range(12):
    ratio = Q_eco_monthly[month] / Q_monthly_avg[month] * 100
    print(f"{month+1:>2d}月   {Q_monthly_avg[month]:>15.2f}   "
          f"{Q_eco_monthly[month]:>15.2f}   {ratio:>6.1f}%")

print(f"\n年均生态流量: {np.mean(Q_eco_monthly):.2f} m³/s")

# 绘制对比图
print("\n绘制多种方法对比图...")
EcologicalFlow.plot_comparison(Q_avg, Q_monthly_avg)
```

---

## 八、典型考题

### 【例题1】Tennant法（10分）

**题目**：某河流多年平均流量$Q_{avg}=50$m³/s，求"良好"等级生态流量。

**【解答】**

"良好"等级：$\alpha = 30\% \sim 40\%$，取中间值$\alpha = 35\%$

$$Q_{eco} = 0.35 \times 50 = 17.5 \text{ m}^3\text{/s}$$

---

### 【例题2】湿周法（15分）

**题目**：矩形断面，$b=15$m，通过流量-湿周关系曲线，确定拐点流量$Q_{eco}$。

**【解答】**

矩形断面湿周：$P = b + 2h$

绘制$P \sim Q$曲线，计算二阶导数，找到$\frac{d^2P}{dQ^2} \approx 0$的点，对应流量即为生态流量。

---

**本章重点**：
- Tennant法：简便，基于百分比
- 湿周法：基于栖息地面积突变
- PHABSIM法：精细化模拟
- 逐月法：考虑季节变化

**下一章**：河流生态修复案例分析
