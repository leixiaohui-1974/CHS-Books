# 第6章：河流生态流量

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、生态流量基本概念

### 1.1 定义与内涵

**生态流量（Environmental Flow）**：维持河流生态系统健康所需的最小流量

**别名**：
- 生态基流（Ecological Base Flow）
- 最小生态需水量
- 环境流量

**核心要素**：
- 流量大小（Magnitude）
- 持续时间（Duration）
- 发生频率（Frequency）
- 变化速率（Rate of change）
- 时间分布（Timing）

### 1.2 生态功能

**(1) 维持生境**：
- 水深、流速适宜范围
- 河床稳定性
- 水质稀释容量

**(2) 物种保护**：
- 鱼类洄游通道
- 产卵场保护
- 生物多样性维持

**(3) 河流自净**：
- 污染物稀释
- 溶解氧补给
- 营养循环

---

## 二、生态流量计算方法

### 2.1 水文学法

**(1) Tennant法（蒙大拿法）**：

| 流量等级 | 占年均流量比例 | 生态状况 |
|----------|----------------|----------|
| 极佳 | 60~100% | 最优生境 |
| 优秀 | 40~60% | 优良生境 |
| 良好 | 30~40% | 满意生境 |
| 一般 | 20~30% | 中等生境 |
| 较差 | 10~20% | 较差生境 |
| 极差 | 0~10% | 严重退化 |

**推荐值**：$Q_e = 0.1 \sim 0.3 \bar{Q}$

**(2) Q90法**：

$$Q_e = Q_{90\%}$$

90%保证率日流量（枯水期流量）

**(3) 7Q10法**：

$$Q_e = \min\{\overline{Q_{7d}}\}_{10年一遇}$$

连续7日最小流量（10年重现期）

### 2.2 水力学法

**湿周法**（Wetted Perimeter）：

$$Q_e = Q(P_{max})$$

其中$P_{max}$为湿周突变点对应流量

**湿周计算**（矩形断面）：

$$P = b + 2h$$

**水深-湿周关系**：

$$\frac{dP}{dQ} \to \max$$

### 2.3 栖息地法

**PHABSIM法**（Physical Habitat Simulation）：

**加权可用面积（WUA）**：

$$WUA = \sum_{i=1}^n A_i \cdot HSI_i$$

**栖息地适宜指数（HSI）**：

$$HSI = f(v, h, substrate)$$

函数值范围0~1

**最优流量**：

$$Q_e = Q(WUA_{max})$$

---

## 三、生态流量保障

### 3.1 水库调度

**生态调度目标**：

$$\max Z = \sum_{t=1}^T [W_1 E_t + W_2 P_t - W_3 D_t]$$

约束：

$$Q_{min,t} \leq Q_t \leq Q_{max,t}$$

$$V_{dead} \leq V_t \leq V_{normal}$$

$$Q_t \geq Q_e$$（生态流量约束）

### 3.2 生态补水

**补水时机**：
- 枯水期补水
- 鱼类产卵期
- 关键生态事件

**补水量计算**：

$$V_{comp} = (Q_e - Q_{natural}) \times \Delta t$$

---

## 四、生态流量监测

### 4.1 水文监测

**指标**：
- 瞬时流量
- 日均流量
- 月均流量
- 年径流量

**方法**：
- 流量计
- 水位-流量关系
- 声学多普勒流速剖面仪（ADCP）

### 4.2 生态监测

**生物指标**：
- 鱼类种群密度
- 着生藻类生物量
- 底栖动物群落结构

**物理指标**：
- 栖息地面积
- 河床形态
- 水质参数

---

## 五、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import minimize
from scipy.interpolate import interp1d

class EcologicalFlow:
    """河流生态流量计算"""
    
    def __init__(self):
        pass
    
    def tennant_method(self, Q_mean, quality='good'):
        """
        Tennant法（蒙大拿法）
        
        参数:
            Q_mean: 多年平均流量 (m³/s)
            quality: 'excellent', 'good', 'fair', 'poor'
        
        返回: 生态流量
        """
        ratios = {
            'excellent': (0.4, 0.6),
            'good': (0.3, 0.4),
            'fair': (0.2, 0.3),
            'poor': (0.1, 0.2)
        }
        
        ratio_range = ratios.get(quality, (0.1, 0.3))
        Q_e_min = Q_mean * ratio_range[0]
        Q_e_max = Q_mean * ratio_range[1]
        Q_e = Q_mean * np.mean(ratio_range)
        
        return {
            'Q_e': Q_e,
            'Q_e_min': Q_e_min,
            'Q_e_max': Q_e_max,
            'ratio': np.mean(ratio_range)
        }
    
    def Q90_method(self, daily_flow):
        """
        Q90法（90%保证率流量）
        
        参数:
            daily_flow: 日流量序列 (m³/s)
        """
        Q_sorted = np.sort(daily_flow)
        n = len(Q_sorted)
        
        # 90%保证率位置
        index_90 = int(n * 0.9)
        Q_e = Q_sorted[index_90]
        
        return {
            'Q_e': Q_e,
            'Q_50': np.median(daily_flow),
            'Q_mean': np.mean(daily_flow),
            'ratio': Q_e / np.mean(daily_flow)
        }
    
    def Q7_10_method(self, daily_flow, window=7):
        """
        7Q10法（7日最小流量10年重现期）
        
        参数:
            daily_flow: 日流量序列（多年）
            window: 窗口天数
        """
        # 计算滑动平均
        n = len(daily_flow)
        Q_7d = []
        
        for i in range(n - window + 1):
            Q_7d.append(np.mean(daily_flow[i:i+window]))
        
        Q_7d = np.array(Q_7d)
        
        # 取最小值作为生态流量（简化）
        Q_e = np.min(Q_7d)
        
        return {
            'Q_e': Q_e,
            'Q_7d_mean': np.mean(Q_7d),
            'Q_7d_min': Q_e
        }
    
    def wetted_perimeter_method(self, Q_range, b, slope):
        """
        湿周法
        
        参数:
            Q_range: 流量范围 (m³/s)
            b: 河宽 (m)
            slope: 河床坡度
        
        假设：矩形断面，Manning公式
        """
        n = 0.03  # 糙率
        g = 9.81
        
        P_values = []
        h_values = []
        
        for Q in Q_range:
            # 迭代求水深
            def equation(h):
                A = b * h
                P = b + 2 * h
                R = A / P
                Q_calc = (1/n) * A * R**(2/3) * np.sqrt(slope)
                return Q_calc - Q
            
            from scipy.optimize import fsolve
            h = fsolve(equation, 1.0)[0]
            
            if h > 0:
                P = b + 2 * h
                P_values.append(P)
                h_values.append(h)
            else:
                P_values.append(0)
                h_values.append(0)
        
        # 找湿周突变点（最大斜率）
        dP_dQ = np.gradient(P_values, Q_range)
        
        # 生态流量：湿周变化率最大点
        idx_max = np.argmax(dP_dQ)
        Q_e = Q_range[idx_max]
        
        return {
            'Q_e': Q_e,
            'P_values': P_values,
            'h_values': h_values,
            'dP_dQ': dP_dQ
        }
    
    def habitat_suitability(self, v, h, v_opt=0.5, h_opt=0.8,
                           v_range=(0.2, 1.5), h_range=(0.3, 2.0)):
        """
        栖息地适宜指数（HSI）
        
        参数:
            v: 流速 (m/s)
            h: 水深 (m)
            v_opt, h_opt: 最适流速和水深
            v_range, h_range: 可接受范围
        """
        # 流速适宜度（高斯函数）
        SI_v = np.exp(-((v - v_opt) / 0.5)**2)
        
        # 水深适宜度
        SI_h = np.exp(-((h - h_opt) / 0.6)**2)
        
        # 范围约束
        if v < v_range[0] or v > v_range[1]:
            SI_v *= 0.1
        
        if h < h_range[0] or h > h_range[1]:
            SI_h *= 0.1
        
        # 综合适宜指数（几何平均）
        HSI = np.sqrt(SI_v * SI_h)
        
        return HSI
    
    def calculate_WUA(self, Q, b, slope, n=0.03):
        """
        计算加权可用面积（WUA）
        
        WUA = Σ A_i · HSI_i
        """
        # 计算水深和流速
        g = 9.81
        
        def get_hydraulics(Q):
            # 简化：假设矩形断面
            def equation(h):
                A = b * h
                P = b + 2 * h
                R = A / P
                Q_calc = (1/n) * A * R**(2/3) * np.sqrt(slope)
                return Q_calc - Q
            
            from scipy.optimize import fsolve
            h = fsolve(equation, 0.5)[0]
            
            if h > 0:
                A = b * h
                v = Q / A
            else:
                h = 0
                v = 0
            
            return h, v
        
        h, v = get_hydraulics(Q)
        
        # 计算HSI
        HSI = self.habitat_suitability(v, h)
        
        # WUA
        WUA = b * h * HSI  # 简化：横断面面积×HSI
        
        return WUA, h, v, HSI
    
    def optimal_ecological_flow(self, Q_range, b, slope):
        """
        基于栖息地的最优生态流量
        
        目标：最大化WUA
        """
        WUA_values = []
        
        for Q in Q_range:
            WUA, _, _, _ = self.calculate_WUA(Q, b, slope)
            WUA_values.append(WUA)
        
        WUA_values = np.array(WUA_values)
        
        # 找最大WUA对应流量
        idx_max = np.argmax(WUA_values)
        Q_e = Q_range[idx_max]
        WUA_max = WUA_values[idx_max]
        
        return {
            'Q_e': Q_e,
            'WUA_max': WUA_max,
            'WUA_values': WUA_values
        }
    
    def plot_ecological_flow_analysis(self, daily_flow, Q_mean):
        """绘制生态流量分析图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. Tennant法对比
        ax1 = axes[0, 0]
        
        qualities = ['excellent', 'good', 'fair', 'poor']
        Q_e_values = []
        Q_e_ranges = []
        
        for quality in qualities:
            result = self.tennant_method(Q_mean, quality)
            Q_e_values.append(result['Q_e'])
            Q_e_ranges.append((result['Q_e_min'], result['Q_e_max']))
        
        x_pos = np.arange(len(qualities))
        colors_q = ['green', 'lightgreen', 'yellow', 'orange']
        
        bars = ax1.bar(x_pos, Q_e_values, color=colors_q, alpha=0.7,
                      edgecolor='black', linewidth=2)
        
        # 误差棒（表示范围）
        yerr = np.array([(Q_e - q_min, q_max - Q_e) 
                        for Q_e, (q_min, q_max) in zip(Q_e_values, Q_e_ranges)]).T
        ax1.errorbar(x_pos, Q_e_values, yerr=yerr,
                    fmt='none', ecolor='black', capsize=5, linewidth=2)
        
        # 参考线
        ax1.axhline(Q_mean, color='blue', linestyle='--', linewidth=2,
                   label=f'年均流量={Q_mean:.0f}m³/s')
        
        ax1.set_xticks(x_pos)
        ax1.set_xticklabels(['极佳', '良好', '一般', '较差'])
        ax1.set_xlabel('生态状况等级', fontsize=11)
        ax1.set_ylabel('生态流量 Q_e (m³/s)', fontsize=11)
        ax1.set_title('Tennant法（蒙大拿法）', fontsize=13, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3, axis='y')
        
        # 2. 流量历时曲线
        ax2 = axes[0, 1]
        
        Q_sorted = np.sort(daily_flow)[::-1]
        n = len(Q_sorted)
        P = np.arange(1, n + 1) / (n + 1) * 100  # 超过概率
        
        ax2.plot(P, Q_sorted, 'b-', linewidth=2.5, label='流量历时曲线')
        
        # Q90
        result_Q90 = self.Q90_method(daily_flow)
        ax2.axhline(result_Q90['Q_e'], color='r', linestyle='--',
                   linewidth=2, label=f"Q90={result_Q90['Q_e']:.0f}m³/s")
        ax2.axvline(90, color='r', linestyle=':', linewidth=1.5, alpha=0.7)
        
        # Q50（中位数）
        ax2.axhline(result_Q90['Q_50'], color='g', linestyle='--',
                   linewidth=2, label=f"Q50={result_Q90['Q_50']:.0f}m³/s")
        
        ax2.set_xlabel('超过概率 P (%)', fontsize=11)
        ax2.set_ylabel('流量 Q (m³/s)', fontsize=11)
        ax2.set_title('流量历时曲线与Q90法', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. 湿周法
        ax3 = axes[1, 0]
        
        Q_range_wp = np.linspace(5, 100, 100)
        b = 20  # m
        slope = 0.001
        
        result_wp = self.wetted_perimeter_method(Q_range_wp, b, slope)
        
        ax3_twin = ax3.twinx()
        
        # 湿周曲线
        ax3.plot(Q_range_wp, result_wp['P_values'], 'b-',
                linewidth=2.5, label='湿周P')
        
        # 湿周变化率
        ax3_twin.plot(Q_range_wp, result_wp['dP_dQ'], 'r--',
                     linewidth=2, label='dP/dQ')
        
        # 生态流量
        ax3.axvline(result_wp['Q_e'], color='g', linestyle='--',
                   linewidth=2.5, label=f"Q_e={result_wp['Q_e']:.1f}m³/s")
        
        ax3.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_ylabel('湿周 P (m)', fontsize=11, color='blue')
        ax3_twin.set_ylabel('湿周变化率 dP/dQ', fontsize=11, color='red')
        ax3.set_title(f'湿周法（b={b}m）', fontsize=13, fontweight='bold')
        
        # 合并图例
        lines1, labels1 = ax3.get_legend_handles_labels()
        lines2, labels2 = ax3_twin.get_legend_handles_labels()
        ax3.legend(lines1 + lines2, labels1 + labels2, loc='best')
        ax3.grid(True, alpha=0.3)
        
        # 4. 栖息地法（WUA）
        ax4 = axes[1, 1]
        
        Q_range_wua = np.linspace(10, 80, 100)
        
        result_wua = self.optimal_ecological_flow(Q_range_wua, b, slope)
        
        ax4.plot(Q_range_wua, result_wua['WUA_values'], 'b-',
                linewidth=2.5, label='WUA曲线')
        
        # 最优流量
        ax4.axvline(result_wua['Q_e'], color='r', linestyle='--',
                   linewidth=2.5,
                   label=f"最优Q_e={result_wua['Q_e']:.1f}m³/s\nWUA_max={result_wua['WUA_max']:.1f}m²")
        
        # 标注峰值
        ax4.plot(result_wua['Q_e'], result_wua['WUA_max'],
                'ro', markersize=12, zorder=5)
        
        ax4.set_xlabel('流量 Q (m³/s)', fontsize=11)
        ax4.set_ylabel('加权可用面积 WUA (m²)', fontsize=11)
        ax4.set_title('栖息地法（PHABSIM）', fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('ecological_flow_analysis.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("河流生态流量计算")
print("="*60)

ef = EcologicalFlow()

# 1. Tennant法
print("1. Tennant法（蒙大拿法）:")

Q_mean_annual = 45  # m³/s

for quality in ['excellent', 'good', 'fair', 'poor']:
    result = ef.tennant_method(Q_mean_annual, quality)
    
    print(f"\n  生态状况: {quality}")
    print(f"    推荐生态流量: {result['Q_e']:.1f} m³/s")
    print(f"    范围: [{result['Q_e_min']:.1f}, {result['Q_e_max']:.1f}] m³/s")
    print(f"    占年均流量: {result['ratio']*100:.0f}%")

# 2. Q90法
print("\n" + "="*60)
print("2. Q90法:")

# 模拟日流量数据（365天）
np.random.seed(42)
daily_flow = np.random.lognormal(mean=np.log(Q_mean_annual), sigma=0.5, size=365)

result_Q90 = ef.Q90_method(daily_flow)

print(f"  90%保证率流量 Q90 = {result_Q90['Q_e']:.1f} m³/s")
print(f"  中位流量 Q50 = {result_Q90['Q_50']:.1f} m³/s")
print(f"  平均流量 Q_mean = {result_Q90['Q_mean']:.1f} m³/s")
print(f"  Q90/Q_mean = {result_Q90['ratio']:.2f}")

# 3. 7Q10法
print("\n" + "="*60)
print("3. 7Q10法:")

result_7Q10 = ef.Q7_10_method(daily_flow, window=7)

print(f"  7日最小流量 = {result_7Q10['Q_e']:.1f} m³/s")
print(f"  7日平均流量 = {result_7Q10['Q_7d_mean']:.1f} m³/s")

# 4. 湿周法
print("\n" + "="*60)
print("4. 湿周法:")

Q_test = np.linspace(10, 60, 50)
b_channel = 18  # m
slope_channel = 0.0008

result_wp = ef.wetted_perimeter_method(Q_test, b_channel, slope_channel)

print(f"  河宽 b = {b_channel} m")
print(f"  坡度 i = {slope_channel}")
print(f"  生态流量 Q_e = {result_wp['Q_e']:.1f} m³/s")

# 5. 栖息地法
print("\n" + "="*60)
print("5. 栖息地法（PHABSIM）:")

Q_habitat = np.linspace(15, 70, 50)

result_habitat = ef.optimal_ecological_flow(Q_habitat, b_channel, slope_channel)

print(f"  最优生态流量 Q_e = {result_habitat['Q_e']:.1f} m³/s")
print(f"  最大WUA = {result_habitat['WUA_max']:.1f} m²")

# 6. 方法对比
print("\n" + "="*60)
print("6. 不同方法对比:")

methods = [
    ('Tennant法(良好)', ef.tennant_method(Q_mean_annual, 'good')['Q_e']),
    ('Q90法', result_Q90['Q_e']),
    ('7Q10法', result_7Q10['Q_e']),
    ('湿周法', result_wp['Q_e']),
    ('栖息地法', result_habitat['Q_e'])
]

for method, Q_e in methods:
    ratio = Q_e / Q_mean_annual * 100
    print(f"  {method:15s}: {Q_e:6.1f} m³/s  ({ratio:5.1f}%年均流量)")

# 推荐值
Q_e_recommended = np.mean([q for _, q in methods])
print(f"\n  综合推荐: {Q_e_recommended:.1f} m³/s ({Q_e_recommended/Q_mean_annual*100:.1f}%年均流量)")

# 绘图
print("\n绘制生态流量分析图...")
ef.plot_ecological_flow_analysis(daily_flow, Q_mean_annual)
```

---

## 六、典型考题

### 【例题1】Tennant法计算（10分）

**题目**：某河流多年平均流量$\bar{Q}=50$m³/s。采用Tennant法，要求达到"良好"生态状况，求生态流量。

**【解答】**

"良好"状况对应比例：30~40%

$$Q_e = 0.3 \sim 0.4 \times 50 = 15 \sim 20 \text{ m}^3\text{/s}$$

推荐取中值：$Q_e = 17.5$m³/s

---

**本章重点**：
- 生态流量概念
- Tennant法、Q90法
- 湿周法、栖息地法
- 生态调度

**下一章**：水生生境模拟
