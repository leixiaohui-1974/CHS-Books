# Day 5：有压管流

**学习时间**: 3小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐

---

## 一、沿程水头损失

### 1.1 达西-魏斯巴赫公式

$$h_f = \lambda \frac{L}{d} \frac{v^2}{2g}$$

**参数说明**：
- $h_f$：沿程水头损失（m）
- $\lambda$：沿程阻力系数（无量纲）
- $L$：管道长度（m）
- $d$：管道直径（m）
- $v$：平均流速（m/s）
- $g$：重力加速度（m/s²）

### 1.2 雷诺数与流态判别

$$Re = \frac{vd}{\nu}$$

**流态判别**：
- $Re < 2000$：层流
- $2000 \leq Re < 4000$：过渡区
- $Re \geq 4000$：湍流

### 1.3 沿程阻力系数$\lambda$

#### (1) 层流（$Re < 2000$）

$$\lambda = \frac{64}{Re}$$

#### (2) 湍流光滑管（$Re \geq 4000$）

**布拉修斯公式**（$Re < 10^5$）：
$$\lambda = \frac{0.3164}{Re^{0.25}}$$

**尼古拉兹公式**（$Re > 10^5$）：
$$\frac{1}{\sqrt{\lambda}} = 2\lg(Re\sqrt{\lambda}) - 0.8$$

#### (3) 湍流粗糙管

**柯列布洛克-怀特公式**（综合公式）：
$$\frac{1}{\sqrt{\lambda}} = -2\lg\left(\frac{\Delta/d}{3.7} + \frac{2.51}{Re\sqrt{\lambda}}\right)$$

**参数说明**：
- $\Delta$：管壁绝对粗糙度（mm）
- $\Delta/d$：相对粗糙度

**经验值**：
- 光滑管（玻璃、塑料）：$\lambda = 0.015 \sim 0.020$
- 旧铸铁管：$\lambda = 0.025 \sim 0.035$
- 旧钢管：$\lambda = 0.030 \sim 0.040$

---

## 二、局部水头损失

### 2.1 基本公式

$$h_j = \zeta \frac{v^2}{2g}$$

**参数说明**：
- $h_j$：局部水头损失（m）
- $\zeta$：局部阻力系数（无量纲）
- $v$：特征断面流速（m/s）

### 2.2 常见局部损失系数

| 管件类型 | 局部阻力系数$\zeta$ |
|---------|-------------------|
| 管道进口（直角进口） | 0.5 |
| 管道进口（圆角进口） | 0.2 |
| 管道出口 | 1.0 |
| 90°弯头 | 0.3 ~ 1.0 |
| 45°弯头 | 0.2 ~ 0.4 |
| 闸阀（全开） | 0.2 |
| 闸阀（半开） | 2.0 ~ 5.0 |
| 截止阀（全开） | 6.0 ~ 10.0 |
| 突扩（断面比$d_1^2/d_2^2$） | $(1 - d_1^2/d_2^2)^2$ |
| 突缩（断面比$d_1^2/d_2^2$） | $0.5(1 - d_1^2/d_2^2)$ |

### 2.3 博尔达出口公式（突扩）

管道断面从$A_1$突然扩大到$A_2$：

$$h_j = \frac{(v_1 - v_2)^2}{2g} = \left(1 - \frac{A_1}{A_2}\right)^2 \frac{v_1^2}{2g}$$

---

## 三、管道总水头损失

$$h_w = h_f + \sum h_j = \lambda \frac{L}{d} \frac{v^2}{2g} + \sum \zeta \frac{v^2}{2g}$$

**合并形式**：
$$h_w = \left(\lambda \frac{L}{d} + \sum \zeta\right) \frac{v^2}{2g}$$

---

## 四、管道水力计算

### 4.1 简单管道能量方程

$$\frac{p_1}{\gamma} + z_1 + \frac{v_1^2}{2g} = \frac{p_2}{\gamma} + z_2 + \frac{v_2^2}{2g} + h_w$$

### 4.2 三类问题

#### 第一类问题：已知$Q$，$d$，$L$，求$h_w$
- 直接计算$v = Q/A$
- 计算$Re$，确定$\lambda$
- 代入公式求$h_w$

#### 第二类问题：已知$h_w$，$d$，$L$，求$Q$
- 假设$\lambda_0$（通常取0.02~0.03）
- 计算$v_0 = \sqrt{\frac{2gh_w}{\lambda_0 L/d + \sum\zeta}}$
- 计算$Re_0$，修正$\lambda_1$
- 迭代至收敛

#### 第三类问题：已知$Q$，$h_w$，$L$，求$d$
- 假设$\lambda_0$（通常取0.02~0.03）
- 计算$d_0 = \left(\frac{\lambda_0 L Q^2}{2gh_w \cdot \pi^2/4}\right)^{1/5}$
- 计算$v_0$，$Re_0$，修正$\lambda_1$
- 迭代至收敛

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import fsolve

class PipeFlow:
    """有压管流计算"""
    
    def __init__(self, nu=1e-6):
        """
        参数:
            nu: 运动粘度 (m²/s)，默认清水20°C
        """
        self.nu = nu
        self.g = 9.81
    
    def reynolds_number(self, v, d):
        """雷诺数"""
        return v * d / self.nu
    
    def flow_regime(self, Re):
        """流态判别"""
        if Re < 2000:
            return "层流"
        elif Re < 4000:
            return "过渡流"
        else:
            return "湍流"
    
    def lambda_laminar(self, Re):
        """层流沿程阻力系数"""
        return 64 / Re
    
    def lambda_turbulent_smooth(self, Re):
        """湍流光滑管"""
        if Re < 1e5:
            # 布拉修斯公式
            return 0.3164 / Re**0.25
        else:
            # 尼古拉兹公式（迭代求解）
            def equation(lam):
                return 1/np.sqrt(lam) - (2*np.log10(Re*np.sqrt(lam)) - 0.8)
            
            lam0 = 0.02
            lam = fsolve(equation, lam0)[0]
            return lam
    
    def lambda_turbulent_rough(self, Re, d, Delta):
        """
        湍流粗糙管（柯列布洛克-怀特公式）
        
        参数:
            Re: 雷诺数
            d: 管径 (m)
            Delta: 绝对粗糙度 (mm)
        """
        def equation(lam):
            relative_roughness = Delta / (d * 1000)  # 转为无量纲
            return 1/np.sqrt(lam) + 2*np.log10(
                relative_roughness/3.7 + 2.51/(Re*np.sqrt(lam)))
        
        lam0 = 0.02
        lam = fsolve(equation, lam0)[0]
        return lam
    
    def head_loss_along_path(self, lam, L, d, v):
        """沿程水头损失"""
        return lam * (L / d) * (v**2 / (2 * self.g))
    
    def head_loss_local(self, zeta, v):
        """局部水头损失"""
        return zeta * (v**2 / (2 * self.g))
    
    def head_loss_total(self, lam, L, d, v, zeta_sum):
        """总水头损失"""
        hf = self.head_loss_along_path(lam, L, d, v)
        hj = self.head_loss_local(zeta_sum, v)
        return hf + hj
    
    def local_coeff_sudden_expansion(self, d1, d2):
        """突扩局部阻力系数"""
        return (1 - (d1/d2)**2)**2
    
    def local_coeff_sudden_contraction(self, d1, d2):
        """突缩局部阻力系数"""
        return 0.5 * (1 - (d1/d2)**2)
    
    def solve_type1(self, Q, d, L, zeta_sum, Delta=0):
        """
        第一类问题：已知Q, d, L，求hw
        
        参数:
            Q: 流量 (m³/s)
            d: 管径 (m)
            L: 管长 (m)
            zeta_sum: 局部阻力系数之和
            Delta: 绝对粗糙度 (mm)
        """
        A = np.pi * d**2 / 4
        v = Q / A
        Re = self.reynolds_number(v, d)
        
        # 确定lambda
        if Re < 2000:
            lam = self.lambda_laminar(Re)
        elif Delta == 0:
            lam = self.lambda_turbulent_smooth(Re)
        else:
            lam = self.lambda_turbulent_rough(Re, d, Delta)
        
        hw = self.head_loss_total(lam, L, d, v, zeta_sum)
        
        return {
            'v': v,
            'Re': Re,
            'regime': self.flow_regime(Re),
            'lambda': lam,
            'hf': self.head_loss_along_path(lam, L, d, v),
            'hj': self.head_loss_local(zeta_sum, v),
            'hw': hw
        }
    
    def solve_type2(self, hw, d, L, zeta_sum, Delta=0, max_iter=20, tol=1e-6):
        """
        第二类问题：已知hw, d, L，求Q
        
        参数:
            hw: 水头损失 (m)
            d: 管径 (m)
            L: 管长 (m)
            zeta_sum: 局部阻力系数之和
            Delta: 绝对粗糙度 (mm)
        """
        # 初始假设
        lam = 0.025
        
        for i in range(max_iter):
            # 计算流速
            v = np.sqrt(2 * self.g * hw / (lam * L/d + zeta_sum))
            
            # 计算雷诺数
            Re = self.reynolds_number(v, d)
            
            # 更新lambda
            if Re < 2000:
                lam_new = self.lambda_laminar(Re)
            elif Delta == 0:
                lam_new = self.lambda_turbulent_smooth(Re)
            else:
                lam_new = self.lambda_turbulent_rough(Re, d, Delta)
            
            # 检查收敛
            if abs(lam_new - lam) < tol:
                break
            
            lam = lam_new
        
        A = np.pi * d**2 / 4
        Q = v * A
        
        return {
            'Q': Q,
            'v': v,
            'Re': Re,
            'regime': self.flow_regime(Re),
            'lambda': lam,
            'iterations': i + 1
        }
    
    def solve_type3(self, Q, hw, L, zeta_sum, Delta=0, max_iter=20, tol=1e-4):
        """
        第三类问题：已知Q, hw, L，求d
        
        参数:
            Q: 流量 (m³/s)
            hw: 水头损失 (m)
            L: 管长 (m)
            zeta_sum: 局部阻力系数之和
            Delta: 绝对粗糙度 (mm)
        """
        # 初始假设
        lam = 0.025
        
        for i in range(max_iter):
            # 计算管径
            d = ((lam * L * Q**2) / (2 * self.g * hw * (np.pi**2 / 4)))**(1/5)
            
            # 计算流速和雷诺数
            A = np.pi * d**2 / 4
            v = Q / A
            Re = self.reynolds_number(v, d)
            
            # 更新lambda
            if Re < 2000:
                lam_new = self.lambda_laminar(Re)
            elif Delta == 0:
                lam_new = self.lambda_turbulent_smooth(Re)
            else:
                lam_new = self.lambda_turbulent_rough(Re, d, Delta)
            
            # 检查收敛
            if abs(lam_new - lam) / lam < tol:
                break
            
            lam = lam_new
        
        return {
            'd': d,
            'v': v,
            'Re': Re,
            'regime': self.flow_regime(Re),
            'lambda': lam,
            'iterations': i + 1
        }
    
    def plot_moody_diagram(self):
        """绘制穆迪图（Re-λ关系）"""
        fig, ax = plt.subplots(figsize=(14, 9))
        
        # 雷诺数范围
        Re_laminar = np.logspace(2, 3.3, 50)
        Re_turbulent = np.logspace(3.6, 7, 200)
        
        # 层流区
        lam_laminar = 64 / Re_laminar
        ax.loglog(Re_laminar, lam_laminar, 'b-', linewidth=2.5, label='层流：λ=64/Re')
        
        # 光滑管
        lam_smooth = np.array([self.lambda_turbulent_smooth(Re) for Re in Re_turbulent])
        ax.loglog(Re_turbulent, lam_smooth, 'r-', linewidth=2.5, label='光滑管')
        
        # 粗糙管（不同相对粗糙度）
        relative_roughness = [0.00001, 0.0001, 0.001, 0.01, 0.05]
        colors = plt.cm.viridis(np.linspace(0.2, 0.9, len(relative_roughness)))
        
        for rr, color in zip(relative_roughness, colors):
            # 计算该粗糙度下的lambda
            lam_rough = []
            for Re in Re_turbulent:
                try:
                    # 使用相对粗糙度计算
                    d = 1.0  # 假设管径1m
                    Delta = rr * d * 1000  # 转为mm
                    lam = self.lambda_turbulent_rough(Re, d, Delta)
                    lam_rough.append(lam)
                except:
                    lam_rough.append(np.nan)
            
            ax.loglog(Re_turbulent, lam_rough, color=color, linewidth=1.5,
                     label=f'Δ/d={rr:.5f}')
        
        ax.set_xlabel('雷诺数 Re', fontsize=12, fontweight='bold')
        ax.set_ylabel('沿程阻力系数 λ', fontsize=12, fontweight='bold')
        ax.set_title('穆迪图（Moody Diagram）', fontsize=15, fontweight='bold')
        ax.legend(loc='upper right', fontsize=9)
        ax.grid(True, which='both', linestyle='--', alpha=0.4)
        ax.set_xlim([100, 1e7])
        ax.set_ylim([0.008, 0.10])
        
        plt.tight_layout()
        plt.savefig('moody_diagram.png', dpi=300)
        plt.show()

# 示例1：第一类问题
print("="*60)
print("示例1：已知Q, d, L，求水头损失hw")
print("="*60)

pipe = PipeFlow(nu=1e-6)

Q = 0.05  # m³/s
d = 0.2   # m
L = 100   # m
zeta_sum = 1.5  # 进口0.5 + 出口1.0

result = pipe.solve_type1(Q, d, L, zeta_sum)

print(f"输入条件:")
print(f"  流量 Q = {Q:.3f} m³/s")
print(f"  管径 d = {d:.3f} m")
print(f"  管长 L = {L:.1f} m")
print(f"  局部阻力系数和 Σζ = {zeta_sum:.2f}")

print(f"\n计算结果:")
print(f"  流速 v = {result['v']:.3f} m/s")
print(f"  雷诺数 Re = {result['Re']:.0f} ({result['regime']})")
print(f"  沿程阻力系数 λ = {result['lambda']:.4f}")
print(f"  沿程损失 hf = {result['hf']:.3f} m")
print(f"  局部损失 hj = {result['hj']:.3f} m")
print(f"  总水头损失 hw = {result['hw']:.3f} m")

# 示例2：第二类问题
print("\n" + "="*60)
print("示例2：已知hw, d, L，求流量Q")
print("="*60)

hw = 5.0   # m
d = 0.3    # m
L = 150    # m
zeta_sum = 2.0

result = pipe.solve_type2(hw, d, L, zeta_sum)

print(f"输入条件:")
print(f"  水头损失 hw = {hw:.2f} m")
print(f"  管径 d = {d:.3f} m")
print(f"  管长 L = {L:.1f} m")
print(f"  局部阻力系数和 Σζ = {zeta_sum:.2f}")

print(f"\n计算结果:")
print(f"  流量 Q = {result['Q']:.4f} m³/s")
print(f"  流速 v = {result['v']:.3f} m/s")
print(f"  雷诺数 Re = {result['Re']:.0f} ({result['regime']})")
print(f"  沿程阻力系数 λ = {result['lambda']:.4f}")
print(f"  迭代次数 = {result['iterations']}")

# 示例3：第三类问题
print("\n" + "="*60)
print("示例3：已知Q, hw, L，求管径d")
print("="*60)

Q = 0.08   # m³/s
hw = 10.0  # m
L = 200    # m
zeta_sum = 1.5

result = pipe.solve_type3(Q, hw, L, zeta_sum)

print(f"输入条件:")
print(f"  流量 Q = {Q:.3f} m³/s")
print(f"  水头损失 hw = {hw:.2f} m")
print(f"  管长 L = {L:.1f} m")
print(f"  局部阻力系数和 Σζ = {zeta_sum:.2f}")

print(f"\n计算结果:")
print(f"  管径 d = {result['d']:.4f} m = {result['d']*1000:.1f} mm")
print(f"  流速 v = {result['v']:.3f} m/s")
print(f"  雷诺数 Re = {result['Re']:.0f} ({result['regime']})")
print(f"  沿程阻力系数 λ = {result['lambda']:.4f}")
print(f"  迭代次数 = {result['iterations']}")

# 示例4：突扩和突缩
print("\n" + "="*60)
print("示例4：突扩和突缩局部损失系数")
print("="*60)

d1 = 0.2  # m
d2 = 0.4  # m

zeta_expansion = pipe.local_coeff_sudden_expansion(d1, d2)
zeta_contraction = pipe.local_coeff_sudden_contraction(d2, d1)

print(f"管径从 d1={d1:.2f}m 到 d2={d2:.2f}m:")
print(f"  突扩（d1→d2）: ζ = {zeta_expansion:.3f}")
print(f"  突缩（d2→d1）: ζ = {zeta_contraction:.3f}")

# 绘制穆迪图
print("\n绘制穆迪图...")
pipe.plot_moody_diagram()
```

---

## 五、典型考题

### 【例题1】沿程损失计算（10分）

**题目**：管径$d=0.25$m，$L=200$m，$Q=0.1$m³/s，$\lambda=0.03$，求沿程损失$h_f$。

**【解答】**

$$A = \frac{\pi d^2}{4} = \frac{\pi \times 0.25^2}{4} = 0.0491 \text{ m}^2$$

$$v = \frac{Q}{A} = \frac{0.1}{0.0491} = 2.04 \text{ m/s}$$

$$h_f = \lambda \frac{L}{d} \frac{v^2}{2g} = 0.03 \times \frac{200}{0.25} \times \frac{2.04^2}{2 \times 9.81} = 5.10 \text{ m}$$

---

### 【例题2】管径计算（15分）

**题目**：要求$Q=0.05$m³/s，水头损失$h_w \leq 10$m，$L=150$m，$\lambda=0.025$，忽略局部损失，求最小管径。

**【解答】**

$$h_w = \lambda \frac{L}{d} \frac{v^2}{2g} = \lambda \frac{L}{d} \frac{Q^2}{2gA^2} = \frac{8\lambda LQ^2}{\pi^2 g d^5}$$

$$d \geq \left(\frac{8\lambda LQ^2}{\pi^2 g h_w}\right)^{1/5}$$

$$d \geq \left(\frac{8 \times 0.025 \times 150 \times 0.05^2}{\pi^2 \times 9.81 \times 10}\right)^{1/5} = 0.172 \text{ m}$$

取标准管径$d=0.2$m。

---

**本日重点**：
- 达西公式
- 雷诺数与流态
- 沿程阻力系数$\lambda$计算
- 管道三类水力计算

**明日预告**：管网计算
