# 第9章：非恒定流数值方法

**学习时间**: 6小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、Saint-Venant方程组

### 1.1 基本方程

**连续性方程**：
$$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = q$$

**动量方程**：
$$\frac{\partial Q}{\partial t} + \frac{\partial}{\partial x}\left(\frac{Q^2}{A}\right) + gA\frac{\partial h}{\partial x} + gA(S_f - S_0) = 0$$

其中：
- $A$：过水断面积（m²）
- $Q$：流量（m³/s）
- $h$：水深（m）
- $q$：单位河长旁侧入流（m²/s）
- $S_0$：河床坡度
- $S_f$：摩阻坡度

### 1.2 守恒形式

$$\frac{\partial \mathbf{U}}{\partial t} + \frac{\partial \mathbf{F}}{\partial x} = \mathbf{S}$$

**状态向量**：
$$\mathbf{U} = \begin{bmatrix} A \\ Q \end{bmatrix}$$

**通量向量**：
$$\mathbf{F} = \begin{bmatrix} Q \\ \frac{Q^2}{A} + gI_1 \end{bmatrix}$$

（$I_1 = \int_0^h b(z)(h-z)dz$：静水压力矩）

**源项**：
$$\mathbf{S} = \begin{bmatrix} q \\ -gA(S_f - S_0) \end{bmatrix}$$

---

## 二、特征线法（MOC）

### 2.1 特征线推导

**特征方程**：
$$\frac{dx}{dt} = v \pm c$$

其中：
- $v = Q/A$：平均流速（m/s）
- $c = \sqrt{gA/B}$：波速（m/s）
- $B$：水面宽度（m）

**相容性方程**：

沿$C^+$特征线（$dx/dt = v + c$）：
$$\frac{dQ}{dt} + gA\frac{dh}{dt} + gA(S_f - S_0) = 0$$

沿$C^-$特征线（$dx/dt = v - c$）：
$$\frac{dQ}{dt} - gA\frac{dh}{dt} + gA(S_f - S_0) = 0$$

**例题1**：矩形渠道，宽$b = 10$ m，水深$h = 2$ m，流速$v = 1.5$ m/s。
求特征线斜率和波速。

**解**：
断面积：$A = bh = 10 \times 2 = 20$ m²

波速：
$$c = \sqrt{\frac{gA}{B}} = \sqrt{\frac{9.81 \times 20}{10}} = \sqrt{19.62} = 4.43 \text{ m/s}$$

特征线斜率：
$$\frac{dx}{dt}\bigg|_{C^+} = v + c = 1.5 + 4.43 = 5.93 \text{ m/s}$$
$$\frac{dx}{dt}\bigg|_{C^-} = v - c = 1.5 - 4.43 = -2.93 \text{ m/s}$$

（$C^-$向上游传播）

---

### 2.2 MOC数值格式

**时间推进**：

已知$n$时刻$(x_i, h_i, Q_i)$，求$n+1$时刻$(x_P, h_P, Q_P)$

点$P$由两条特征线交于：
- 从$L$点发出的$C^+$线
- 从$R$点发出的$C^-$线

**有限差分近似**：

$$Q_P - Q_L + gA_L(h_P - h_L) + gA_L(S_{f,L} - S_0)\Delta t = 0 \quad (C^+)$$
$$Q_P - Q_R - gA_R(h_P - h_R) + gA_R(S_{f,R} - S_0)\Delta t = 0 \quad (C^-)$$

联立求解$(h_P, Q_P)$

**摩阻坡度**（Manning公式）：
$$S_f = \frac{n^2 Q^2}{A^2 R^{4/3}}$$

---

## 三、有限差分法（FDM）

### 3.1 显式格式

**MacCormack格式**（二阶精度）：

**预测步**：
$$\mathbf{U}_i^* = \mathbf{U}_i^n - \frac{\Delta t}{\Delta x}(\mathbf{F}_{i+1}^n - \mathbf{F}_i^n) + \Delta t \mathbf{S}_i^n$$

**校正步**：
$$\mathbf{U}_i^{n+1} = \frac{1}{2}\left[\mathbf{U}_i^n + \mathbf{U}_i^* - \frac{\Delta t}{\Delta x}(\mathbf{F}_i^* - \mathbf{F}_{i-1}^*) + \Delta t \mathbf{S}_i^*\right]$$

**稳定性条件（CFL条件）**：
$$\frac{\Delta t}{\Delta x}(|v| + c) \leq 1$$

**例题2**：明渠流，$v = 2$ m/s，$c = 5$ m/s，$\Delta x = 50$ m。
求允许的最大时间步长。

**解**：
CFL条件：
$$\Delta t \leq \frac{\Delta x}{|v| + c} = \frac{50}{2 + 5} = 7.14 \text{ s}$$

取$\Delta t = 5$ s（保证稳定）

---

### 3.2 隐式格式

**Preissmann格式**（四点隐式）：

时间：$t^n$和$t^{n+1}$  
空间：$x_i$和$x_{i+1}$

**权重平均**：
$$f^{\theta} = \theta f^{n+1} + (1-\theta)f^n$$

（$\theta = 0.5$~$0.6$）

**离散方程**：
$$\frac{A_{i+1}^{n+1} - A_{i+1}^n + A_i^{n+1} - A_i^n}{2\Delta t} + \frac{Q_{i+1}^{\theta} - Q_i^{\theta}}{\Delta x} = 0$$

**优点**：
- 无条件稳定（$\theta \geq 0.5$）
- 可用大时间步长

**缺点**：
- 需解非线性方程组
- Newton-Raphson迭代

---

## 四、有限体积法（FVM）

### 4.1 基本原理

**积分形式**（控制体）：
$$\int_{x_i}^{x_{i+1}} \frac{\partial \mathbf{U}}{\partial t} dx + \mathbf{F}_{i+1/2} - \mathbf{F}_{i-1/2} = \int_{x_i}^{x_{i+1}} \mathbf{S} \, dx$$

**单元平均**：
$$\bar{\mathbf{U}}_i = \frac{1}{\Delta x}\int_{x_{i-1/2}}^{x_{i+1/2}} \mathbf{U} \, dx$$

**演化方程**：
$$\frac{d\bar{\mathbf{U}}_i}{dt} = -\frac{1}{\Delta x}(\mathbf{F}_{i+1/2} - \mathbf{F}_{i-1/2}) + \bar{\mathbf{S}}_i$$

### 4.2 Godunov格式

**核心思想**：界面通量由Riemann问题精确解或近似解确定

**Riemann问题**：
初值：
$$\mathbf{U}(x, 0) = \begin{cases}
\mathbf{U}_L & x < 0 \\
\mathbf{U}_R & x > 0
\end{cases}$$

**解结构**：
- 激波（Shock）
- 稀疏波（Rarefaction）
- 接触间断（Contact）

**HLL近似Riemann求解器**：
$$\mathbf{F}_{1/2} = \begin{cases}
\mathbf{F}_L & S_L \geq 0 \\
\frac{S_R \mathbf{F}_L - S_L \mathbf{F}_R + S_L S_R(\mathbf{U}_R - \mathbf{U}_L)}{S_R - S_L} & S_L < 0 < S_R \\
\mathbf{F}_R & S_R \leq 0
\end{cases}$$

其中：
$$S_L = \min(v_L - c_L, v_R - c_R)$$
$$S_R = \max(v_L + c_L, v_R + c_R)$$

---

## 五、溃坝波计算

### 5.1 理论解（Ritter解）

**初始条件**：
- 上游水深：$h_0$
- 下游水深：$0$（干河床）

**解析解**（$t > 0$）：

**负波前端**（$x = -c_0 t$）：
$$c_0 = \sqrt{gh_0}$$

**正波前端**（$x = 2c_0 t$）：

**稀疏波区**（$-c_0 t < x < 2c_0 t$）：
$$h = \frac{1}{9g}\left(2c_0 - \frac{x}{t}\right)^2$$
$$v = \frac{2}{3}\left(c_0 + \frac{x}{t}\right)$$

**例题3**：水库溃坝，上游水深$h_0 = 10$ m。
求溃坝后1分钟，波前到达位置和最大流速。

**解**：
波速：$c_0 = \sqrt{9.81 \times 10} = 9.90$ m/s

**1分钟（60 s）后**：

负波前（上游）：
$$x_{-} = -c_0 t = -9.90 \times 60 = -594 \text{ m}$$

正波前（下游）：
$$x_{+} = 2c_0 t = 2 \times 9.90 \times 60 = 1188 \text{ m}$$

最大流速（正波前端）：
$$v_{max} = 2c_0 = 2 \times 9.90 = 19.8 \text{ m/s}$$

---

### 5.2 湿河床溃坝

**下游初始水深**：$h_d > 0$

**波前速度**（激波）：
$$U_s = \frac{Q_2 - Q_1}{A_2 - A_1} = \frac{v_2 A_2 - v_1 A_1}{A_2 - A_1}$$

**Rankine-Hugoniot条件**：
$$U_s(h_2 - h_1) = v_2 h_2 - v_1 h_1$$
$$U_s(v_2 h_2 - v_1 h_1) = v_2^2 h_2 - v_1^2 h_1 + \frac{1}{2}g(h_2^2 - h_1^2)$$

---

## 六、河网水流模拟

### 6.1 河网拓扑

**节点类型**：
1. **外部节点**：边界（入流、出流、水位）
2. **内部节点**：河段连接点

**河段编号**：从上游到下游

**拓扑矩阵**：
- 节点-河段关联矩阵$[N \times M]$（$N$：节点数，$M$：河段数）
- $a_{ij} = +1$：河段$j$流出节点$i$
- $a_{ij} = -1$：河段$j$流入节点$i$

### 6.2 节点连接条件

**汇流节点**（多条河段汇合）：

**水量守恒**：
$$\sum_{j \in J_{in}} Q_j = \sum_{j \in J_{out}} Q_j$$

**能量守恒**（或水位连续）：
$$h_1 = h_2 = h_3 = h_n$$

（忽略局部水头损失）

**考虑局部损失**：
$$h_1 = h_n + \zeta \frac{v_n^2}{2g}$$

（$\zeta$：局部阻力系数）

### 6.3 河网求解

**方法1：逐河段法**

1. 各河段独立求解Saint-Venant方程
2. 节点处应用连接条件
3. 迭代至收敛

**方法2：整体矩阵法**

组装全局刚度矩阵，一次性求解所有河段

---

## 七、水锤方程（有压管流）

### 7.1 基本方程

**连续性**：
$$\frac{\partial H}{\partial t} + \frac{a^2}{g}\frac{\partial v}{\partial x} = 0$$

**动量**：
$$\frac{\partial v}{\partial t} + g\frac{\partial H}{\partial x} + \frac{f}{2D}v|v| = 0$$

其中：
- $H$：测压管水头（m）
- $v$：流速（m/s）
- $a$：水锤波速（m/s）
- $f$：摩阻系数
- $D$：管径（m）

**波速**：
$$a = \sqrt{\frac{K/\rho}{1 + (K/E)(D/e)}}$$

（$K$：水的体积弹性模量，$E$：管壁弹性模量，$e$：管壁厚度）

**例题4**：钢管，$D = 1$ m，$e = 10$ mm，$E = 2 \times 10^{11}$ Pa，
$K = 2.1 \times 10^9$ Pa，$\rho = 1000$ kg/m³。
求水锤波速。

**解**：
$$a = \sqrt{\frac{2.1 \times 10^9 / 1000}{1 + (2.1 \times 10^9 / 2 \times 10^{11}) \times (1 / 0.01)}}$$
$$= \sqrt{\frac{2.1 \times 10^6}{1 + 0.0105 \times 100}}$$
$$= \sqrt{\frac{2.1 \times 10^6}{2.05}} = 1011 \text{ m/s}$$

---

### 7.2 特征线法求解

**特征方程**：
$$\frac{dx}{dt} = \pm a$$

**相容性方程**：

$C^+$线：
$$\frac{dH}{dt} + \frac{a}{g}\frac{dv}{dt} + \frac{af}{2gD}v|v| = 0$$

$C^-$线：
$$\frac{dH}{dt} - \frac{a}{g}\frac{dv}{dt} + \frac{af}{2gD}v|v| = 0$$

**差分格式**：
$$H_P = C_A - B_{AP} Q_P \quad (C^+)$$
$$H_P = C_B + B_{BP} Q_P \quad (C^-)$$

其中：
$$C_A = H_A + B_A Q_A - R Q_A |Q_A|$$
$$C_B = H_B - B_B Q_B + R Q_B |Q_B|$$
$$B = \frac{a}{gA}, \quad R = \frac{af\Delta t}{2gDA^2}$$

---

## 八、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import fsolve

class UnsteadyFlowSolver:
    """非恒定流数值求解器"""
    
    def __init__(self, L, nx, T, CFL=0.8, g=9.81):
        """
        初始化
        
        参数:
            L: 河道长度 (m)
            nx: 空间网格数
            T: 模拟总时长 (s)
            CFL: Courant数
            g: 重力加速度 (m/s²)
        """
        self.L = L
        self.nx = nx
        self.dx = L / (nx - 1)
        self.T = T
        self.CFL = CFL
        self.g = g
        
        # 网格
        self.x = np.linspace(0, L, nx)
        
    def dam_break_ritter(self, h0, t):
        """
        溃坝波Ritter解析解（干河床）
        
        参数:
            h0: 上游初始水深 (m)
            t: 时间 (s)
        
        返回:
            x, h, v: 位置、水深、流速
        """
        c0 = np.sqrt(self.g * h0)
        
        # 波前位置
        x_neg = -c0 * t
        x_pos = 2 * c0 * t
        
        # 解析解
        h = np.zeros_like(self.x)
        v = np.zeros_like(self.x)
        
        for i, xi in enumerate(self.x):
            if xi < x_neg:
                # 上游静水区
                h[i] = h0
                v[i] = 0
            elif x_neg <= xi <= x_pos:
                # 稀疏波区
                h[i] = (1 / (9 * self.g)) * (2 * c0 - xi / t) ** 2
                v[i] = (2 / 3) * (c0 + xi / t)
            else:
                # 下游干河床
                h[i] = 0
                v[i] = 0
        
        return self.x, h, v
    
    def maccormack_scheme(self, h0, v0, b, n, S0, T_sim, boundary_type='open'):
        """
        MacCormack格式求解Saint-Venant方程
        
        参数:
            h0: 初始水深数组 (m)
            v0: 初始流速数组 (m/s)
            b: 渠道宽度 (m)
            n: Manning糙率
            S0: 河床坡度
            T_sim: 模拟时长 (s)
            boundary_type: 边界条件类型
        
        返回:
            h_history: 水深历史 (nt, nx)
            v_history: 流速历史 (nt, nx)
            t_array: 时间数组
        """
        # 初始化
        h = h0.copy()
        v = v0.copy()
        
        A = b * h
        Q = A * v
        
        h_history = [h.copy()]
        v_history = [v.copy()]
        t_array = [0]
        
        t = 0
        
        while t < T_sim:
            # 计算时间步长（CFL条件）
            c = np.sqrt(self.g * h)
            dt = self.CFL * self.dx / np.max(np.abs(v) + c + 1e-6)
            dt = min(dt, T_sim - t)
            
            # 预测步
            h_star = np.zeros_like(h)
            v_star = np.zeros_like(v)
            
            for i in range(1, self.nx - 1):
                # 连续性方程
                dQ_dx = (Q[i+1] - Q[i]) / self.dx
                h_star[i] = h[i] - dt * dQ_dx / b
                
                # 动量方程
                R = A[i] / (b + 2 * h[i])  # 水力半径
                Sf = n**2 * v[i] * abs(v[i]) / R**(4/3)
                
                dv2_dx = (v[i+1]**2 - v[i]**2) / self.dx
                dh_dx = (h[i+1] - h[i]) / self.dx
                
                v_star[i] = v[i] - dt * (v[i] * dv2_dx / 2 + self.g * dh_dx + self.g * (Sf - S0))
            
            # 边界条件（开边界）
            h_star[0] = h[0]
            v_star[0] = v[0]
            h_star[-1] = h_star[-2]
            v_star[-1] = v_star[-2]
            
            # 更新A*和Q*
            A_star = b * h_star
            Q_star = A_star * v_star
            
            # 校正步
            h_new = np.zeros_like(h)
            v_new = np.zeros_like(v)
            
            for i in range(1, self.nx - 1):
                # 连续性方程
                dQ_dx_star = (Q_star[i] - Q_star[i-1]) / self.dx
                h_new[i] = 0.5 * (h[i] + h_star[i] - dt * dQ_dx_star / b)
                
                # 动量方程
                R_star = A_star[i] / (b + 2 * h_star[i] + 1e-6)
                Sf_star = n**2 * v_star[i] * abs(v_star[i]) / (R_star**(4/3) + 1e-6)
                
                dv2_dx_star = (v_star[i]**2 - v_star[i-1]**2) / self.dx
                dh_dx_star = (h_star[i] - h_star[i-1]) / self.dx
                
                v_new[i] = 0.5 * (v[i] + v_star[i] - dt * (
                    v_star[i] * dv2_dx_star / 2 + self.g * dh_dx_star + self.g * (Sf_star - S0)
                ))
            
            # 边界条件
            h_new[0] = h[0]
            v_new[0] = v[0]
            h_new[-1] = h_new[-2]
            v_new[-1] = v_new[-2]
            
            # 保证非负水深
            h_new = np.maximum(h_new, 0.01)
            
            # 更新
            h = h_new
            v = v_new
            A = b * h
            Q = A * v
            
            t += dt
            
            # 保存（每隔一定步数）
            if len(h_history) < 200 or len(h_history) % 10 == 0:
                h_history.append(h.copy())
                v_history.append(v.copy())
                t_array.append(t)
        
        return np.array(h_history), np.array(v_history), np.array(t_array)
    
    @staticmethod
    def plot_unsteady_flow_results():
        """可视化非恒定流结果"""
        fig = plt.figure(figsize=(16, 10))
        
        # 1. Ritter溃坝解（多时刻）
        ax1 = plt.subplot(2, 3, 1)
        
        solver = UnsteadyFlowSolver(L=2000, nx=200, T=300)
        h0 = 10  # m
        
        times = [0, 30, 60, 120]
        for t in times:
            if t == 0:
                h_plot = np.where(solver.x < 0, h0, 0)
                ax1.plot(solver.x, h_plot, linewidth=2, label=f't={t}s')
            else:
                x, h, v = solver.dam_break_ritter(h0, t)
                ax1.plot(x, h, linewidth=2, label=f't={t}s')
        
        ax1.set_xlabel('位置 x (m)', fontsize=11)
        ax1.set_ylabel('水深 h (m)', fontsize=11)
        ax1.set_title('Ritter溃坝波解析解', fontsize=12, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        ax1.set_xlim(-1000, 1500)
        
        # 2. MacCormack数值解
        ax2 = plt.subplot(2, 3, 2)
        
        solver2 = UnsteadyFlowSolver(L=1000, nx=100, T=300, CFL=0.5)
        
        # 初始条件：溃坝
        h0_array = np.where(solver2.x < 500, 8.0, 0.5)
        v0_array = np.zeros_like(solver2.x)
        
        h_history, v_history, t_array = solver2.maccormack_scheme(
            h0_array, v0_array, b=10, n=0.03, S0=0.001, T_sim=100
        )
        
        # 绘制多时刻
        time_indices = [0, len(t_array)//4, len(t_array)//2, len(t_array)-1]
        
        for idx in time_indices:
            t_val = t_array[idx]
            ax2.plot(solver2.x, h_history[idx, :], linewidth=2,
                    label=f't={t_val:.1f}s')
        
        ax2.set_xlabel('位置 x (m)', fontsize=11)
        ax2.set_ylabel('水深 h (m)', fontsize=11)
        ax2.set_title('MacCormack格式数值解', fontsize=12, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. 时空演化图（x-t）
        ax3 = plt.subplot(2, 3, 3)
        
        X, T_grid = np.meshgrid(solver2.x, t_array)
        
        contour = ax3.contourf(X, T_grid, h_history, levels=15, cmap='viridis')
        cbar = plt.colorbar(contour, ax=ax3)
        cbar.set_label('水深 (m)', fontsize=10)
        
        ax3.set_xlabel('位置 x (m)', fontsize=11)
        ax3.set_ylabel('时间 t (s)', fontsize=11)
        ax3.set_title('水深时空演化', fontsize=12, fontweight='bold')
        
        # 4. 特征线（溃坝）
        ax4 = plt.subplot(2, 3, 4)
        
        h0_char = 10
        c0 = np.sqrt(9.81 * h0_char)
        
        t_char = np.linspace(0, 100, 100)
        
        # C+ 特征线（向下游）
        x_plus = 2 * c0 * t_char
        ax4.plot(x_plus, t_char, 'r-', linewidth=2, label='C⁺ (波前)')
        
        # C- 特征线（向上游）
        x_minus = -c0 * t_char
        ax4.plot(x_minus, t_char, 'b-', linewidth=2, label='C⁻ (负波)')
        
        # 稀疏波扇形区
        for frac in np.linspace(0, 1, 11):
            v_wave = frac * 2 * c0
            x_wave = (v_wave - c0) * t_char
            ax4.plot(x_wave, t_char, 'gray', linewidth=0.5, alpha=0.5)
        
        ax4.set_xlabel('位置 x (m)', fontsize=11)
        ax4.set_ylabel('时间 t (s)', fontsize=11)
        ax4.set_title('特征线图', fontsize=12, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        ax4.set_xlim(-1500, 2500)
        
        # 5. 流速演化
        ax5 = plt.subplot(2, 3, 5)
        
        for idx in time_indices:
            t_val = t_array[idx]
            ax5.plot(solver2.x, v_history[idx, :], linewidth=2,
                    label=f't={t_val:.1f}s')
        
        ax5.set_xlabel('位置 x (m)', fontsize=11)
        ax5.set_ylabel('流速 v (m/s)', fontsize=11)
        ax5.set_title('流速演化', fontsize=12, fontweight='bold')
        ax5.legend()
        ax5.grid(True, alpha=0.3)
        
        # 6. Froude数分布
        ax6 = plt.subplot(2, 3, 6)
        
        Fr_final = v_history[-1, :] / np.sqrt(9.81 * h_history[-1, :] + 1e-6)
        
        ax6.plot(solver2.x, Fr_final, linewidth=2, color='darkblue')
        ax6.axhline(1, color='red', linestyle='--', linewidth=2, label='Fr=1 (临界)')
        
        ax6.fill_between(solver2.x, 0, Fr_final, where=(Fr_final > 1),
                        alpha=0.3, color='lightcoral', label='超临界')
        ax6.fill_between(solver2.x, 0, Fr_final, where=(Fr_final <= 1),
                        alpha=0.3, color='lightblue', label='亚临界')
        
        ax6.set_xlabel('位置 x (m)', fontsize=11)
        ax6.set_ylabel('Froude数 Fr', fontsize=11)
        ax6.set_title(f'Froude数分布 (t={t_array[-1]:.1f}s)', fontsize=12, fontweight='bold')
        ax6.legend()
        ax6.grid(True, alpha=0.3)
        ax6.set_ylim(0, 2.5)
        
        plt.tight_layout()
        plt.savefig('unsteady_flow_numerical.png', dpi=300)
        plt.show()

# 示例使用
print("="*60)
print("非恒定流数值方法")
print("="*60)

ufs = UnsteadyFlowSolver(L=2000, nx=200, T=300)

# 1. Ritter溃坝解析解
print("\n1. Ritter溃坝波解析解")

h0 = 10  # m
t = 60  # s

x, h, v = ufs.dam_break_ritter(h0, t)

c0 = np.sqrt(ufs.g * h0)
x_neg = -c0 * t
x_pos = 2 * c0 * t
v_max = 2 * c0

print(f"  上游初始水深: {h0} m")
print(f"  时间: {t} s")
print(f"  波速c₀: {c0:.2f} m/s")
print(f"  负波前（上游）: x = {x_neg:.0f} m")
print(f"  正波前（下游）: x = {x_pos:.0f} m")
print(f"  最大流速: {v_max:.2f} m/s")

# 2. CFL条件
print("\n" + "="*60)
print("2. CFL稳定性条件")

v_typical = 2  # m/s
c_typical = 5  # m/s
dx = 50  # m
CFL = 0.8

dt_max_theory = dx / (v_typical + c_typical)
dt_use = CFL * dt_max_theory

print(f"  典型流速: {v_typical} m/s")
print(f"  典型波速: {c_typical} m/s")
print(f"  空间步长: {dx} m")
print(f"  理论最大时间步长: {dt_max_theory:.2f} s")
print(f"  实际时间步长 (CFL={CFL}): {dt_use:.2f} s")

# 3. 水锤波速
print("\n" + "="*60)
print("3. 水锤波速计算")

K = 2.1e9  # Pa
E = 2e11  # Pa
D = 1.0  # m
e = 0.01  # m
rho = 1000  # kg/m³

a = np.sqrt((K / rho) / (1 + (K / E) * (D / e)))

print(f"  管径D: {D} m")
print(f"  壁厚e: {e*1000} mm")
print(f"  水的体积弹性模量K: {K:.2e} Pa")
print(f"  钢的弹性模量E: {E:.2e} Pa")
print(f"  水锤波速a: {a:.0f} m/s")

# 可视化
print("\n绘制非恒定流数值模拟可视化...")
ufs.plot_unsteady_flow_results()
```

---

## 九、本章要点

### 核心方程

1. **Saint-Venant方程**：
   - 连续性：$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = 0$
   - 动量：$\frac{\partial Q}{\partial t} + \frac{\partial(Q^2/A)}{\partial x} + gA\frac{\partial h}{\partial x} + gAS_f = 0$

2. **特征线**：$\frac{dx}{dt} = v \pm c$，$c = \sqrt{gA/B}$

3. **CFL条件**：$\frac{\Delta t}{\Delta x}(|v| + c) \leq 1$

4. **Ritter溃坝解**：
   - 波前：$x = 2c_0 t$
   - 稀疏波：$h = \frac{1}{9g}(2c_0 - x/t)^2$

5. **水锤波速**：$a = \sqrt{K/\rho / (1 + KD/Ee)}$

### 数值方法对比

| 方法 | 精度 | 稳定性 | 复杂度 | 适用 |
|------|------|--------|--------|------|
| 特征线法 | 高 | 需满足CFL | 中 | 急变流 |
| MacCormack | 二阶 | CFL限制 | 低 | 一般问题 |
| Preissmann | 一阶 | 无条件稳定 | 高（隐式） | 大时间步长 |
| Godunov/FVM | 高 | 好（激波捕捉） | 高 | 间断、激波 |

---

**本章重点**：
- Saint-Venant方程组及守恒形式
- 特征线法（MOC）及相容性方程
- 有限差分法（MacCormack、Preissmann）
- 有限体积法（Godunov、HLL Riemann求解器）
- 溃坝波理论（Ritter解、湿河床激波）
- 河网水流模拟（拓扑、节点条件）
- 水锤方程及特征线求解
- Python数值模拟工具

**下一章**：水力学综合应用案例
