# 第5章：非恒定流

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、非恒定流基本概念

### 1.1 定义与分类

**非恒定流（Unsteady Flow）**：流动参数随时间变化的流动。

**分类**：

**(1) 按空间维度**：
- 一维非恒定流（河道洪水演进）
- 二维非恒定流（湖泊、水库）
- 三维非恒定流（复杂地形）

**(2) 按变化速率**：
- 渐变非恒定流（洪水波）
- 急变非恒定流（溃坝波、水击）

### 1.2 特征参数

**波速$c$**：扰动传播速度

**绝对波速**：$c = \sqrt{gh}$（浅水波）

**相对波速**（相对于水流）：
- 顺流：$v + c$
- 逆流：$v - c$

---

## 二、圣维南方程组

### 2.1 基本方程

**连续性方程**（质量守恒）：
$$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = q$$

**动量方程**（动量守恒）：
$$\frac{\partial Q}{\partial t} + \frac{\partial}{\partial x}\left(\frac{Q^2}{A}\right) + gA\frac{\partial h}{\partial x} = gA(i_0 - i_f)$$

**参数说明**：
- $A$：过水断面面积（m²）
- $Q$：流量（m³/s）
- $h$：水深（m）
- $q$：旁侧入流（m²/s）
- $i_0$：底坡
- $i_f$：摩阻坡度

**简化形式**（忽略旁侧入流）：
$$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = 0$$

$$\frac{\partial Q}{\partial t} + \frac{\partial}{\partial x}\left(\frac{Q^2}{A}\right) + gA\frac{\partial h}{\partial x} = gA(i_0 - i_f)$$

### 2.2 特征线方程

**特征线方向**：
$$\frac{dx}{dt} = v \pm c$$

**沿特征线的相容方程**：
$$\frac{dv}{dt} \pm \frac{c}{A}\frac{dA}{dt} = g(i_0 - i_f)$$

**物理意义**：扰动沿特征线传播

---

## 三、简化模型

### 3.1 运动波模型

**假设**：惯性项和压力项忽略

**简化方程**：
$$\frac{\partial Q}{\partial t} + c\frac{\partial Q}{\partial x} = 0$$

**波速**：
$$c = \frac{dQ}{dA}$$

**适用**：缓变洪水过程，$i_0 \gg i_f$

### 3.2 扩散波模型

**假设**：惯性项忽略，保留扩散项

**方程**：
$$\frac{\partial Q}{\partial t} + c\frac{\partial Q}{\partial x} = D\frac{\partial^2 Q}{\partial x^2}$$

**扩散系数**：
$$D = \frac{Q}{2BSi_0}$$

**适用**：中等变化速率的洪水

### 3.3 动力波模型

**完整圣维南方程组**，不作简化

**适用**：快速变化过程（溃坝波、水击）

---

## 四、数值解法

### 4.1 特征线法

**基本思想**：沿特征线求解偏微分方程

**步骤**：
1. 划分时空网格
2. 确定特征线
3. 沿特征线积分
4. 求解代数方程组

### 4.2 有限差分法

**显式格式**（向前差分）：
$$\frac{\partial Q}{\partial t} \approx \frac{Q_i^{n+1} - Q_i^n}{\Delta t}$$

$$\frac{\partial Q}{\partial x} \approx \frac{Q_{i+1}^n - Q_i^n}{\Delta x}$$

**隐式格式**（Preissmann格式）：
$$\frac{\partial Q}{\partial t} \approx \frac{Q_i^{n+1} - Q_i^n}{\Delta t}$$

$$\frac{\partial Q}{\partial x} \approx \theta\frac{Q_{i+1}^{n+1} - Q_i^{n+1}}{\Delta x} + (1-\theta)\frac{Q_{i+1}^n - Q_i^n}{\Delta x}$$

**稳定性条件（CFL条件）**：
$$\frac{\Delta t}{\Delta x} \leq \frac{1}{|v| + c}$$

### 4.3 有限体积法

**守恒形式**：
$$\frac{\partial U}{\partial t} + \frac{\partial F}{\partial x} = S$$

其中：
$$U = \begin{bmatrix} A \\ Q \end{bmatrix}, \quad F = \begin{bmatrix} Q \\ Q^2/A + gI_1 \end{bmatrix}, \quad S = \begin{bmatrix} 0 \\ gA(i_0 - i_f) \end{bmatrix}$$

---

## 五、洪水演算

### 5.1 马斯京根法（Muskingum Method）

**基本假设**：河段蓄量与流量线性关系

$$S = K[xI + (1-x)Q]$$

**参数说明**：
- $S$：河段蓄量（m³）
- $K$：蓄量常数（s）
- $x$：权重系数（0≤$x$≤0.5）
- $I$：入流流量（m³/s）
- $Q$：出流流量（m³/s）

**演算公式**：
$$Q_{t+\Delta t} = C_0 I_{t+\Delta t} + C_1 I_t + C_2 Q_t$$

**系数**：
$$C_0 = \frac{-Kx + \Delta t/2}{K(1-x) + \Delta t/2}$$

$$C_1 = \frac{Kx + \Delta t/2}{K(1-x) + \Delta t/2}$$

$$C_2 = \frac{K(1-x) - \Delta t/2}{K(1-x) + \Delta t/2}$$

**约束**：$C_0 + C_1 + C_2 = 1$

### 5.2 参数率定

**目标函数**：
$$\min \sum_{i=1}^{n}(Q_{obs,i} - Q_{calc,i})^2$$

**方法**：
- 试算法
- 最小二乘法
- 优化算法（遗传算法、粒子群算法）

---

## 六、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import minimize

class UnsteadyFlow:
    """非恒定流计算"""
    
    def __init__(self):
        self.g = 9.81
    
    def wave_celerity(self, h):
        """浅水波波速"""
        c = np.sqrt(self.g * h)
        return c
    
    def muskingum_coefficients(self, K, x, dt):
        """
        马斯京根法系数
        
        参数:
            K: 蓄量常数 (s)
            x: 权重系数 (0-0.5)
            dt: 时间步长 (s)
        
        返回:
            C0, C1, C2
        """
        denominator = K * (1 - x) + dt / 2
        
        C0 = (-K * x + dt / 2) / denominator
        C1 = (K * x + dt / 2) / denominator
        C2 = (K * (1 - x) - dt / 2) / denominator
        
        return C0, C1, C2
    
    def muskingum_routing(self, I, K, x, dt):
        """
        马斯京根法洪水演算
        
        参数:
            I: 入流过程 (m³/s)，数组
            K: 蓄量常数 (s)
            x: 权重系数
            dt: 时间步长 (s)
        
        返回:
            Q: 出流过程 (m³/s)
        """
        n = len(I)
        Q = np.zeros(n)
        Q[0] = I[0]  # 初始条件
        
        C0, C1, C2 = self.muskingum_coefficients(K, x, dt)
        
        for i in range(1, n):
            Q[i] = C0 * I[i] + C1 * I[i-1] + C2 * Q[i-1]
        
        return Q
    
    def calibrate_muskingum(self, I, Q_obs, dt, bounds=None):
        """
        马斯京根参数率定
        
        参数:
            I: 入流过程
            Q_obs: 观测出流过程
            dt: 时间步长 (s)
            bounds: 参数范围 [(K_min, K_max), (x_min, x_max)]
        
        返回:
            K_opt, x_opt, Q_sim
        """
        if bounds is None:
            bounds = [(3600, 86400), (0, 0.5)]  # K: 1-24小时, x: 0-0.5
        
        def objective(params):
            K, x = params
            Q_sim = self.muskingum_routing(I, K, x, dt)
            error = np.sum((Q_sim - Q_obs)**2)
            return error
        
        # 初始猜测
        x0 = [(bounds[0][0] + bounds[0][1]) / 2, 0.2]
        
        result = minimize(objective, x0, bounds=bounds, method='L-BFGS-B')
        
        K_opt, x_opt = result.x
        Q_sim = self.muskingum_routing(I, K_opt, x_opt, dt)
        
        return K_opt, x_opt, Q_sim
    
    def diffusion_wave_1d(self, Q0, c, D, L, T, dx, dt):
        """
        一维扩散波方程数值求解
        
        dQ/dt + c*dQ/dx = D*d²Q/dx²
        
        参数:
            Q0: 初始流量分布
            c: 波速 (m/s)
            D: 扩散系数 (m²/s)
            L: 河段长度 (m)
            T: 模拟时间 (s)
            dx: 空间步长 (m)
            dt: 时间步长 (s)
        """
        nx = int(L / dx) + 1
        nt = int(T / dt) + 1
        
        Q = np.zeros((nt, nx))
        Q[0, :] = Q0
        
        # 稳定性检查
        courant = c * dt / dx
        diffusion = D * dt / dx**2
        
        if courant > 1:
            print(f"警告：Courant数={courant:.2f} > 1")
        if diffusion > 0.5:
            print(f"警告：扩散数={diffusion:.2f} > 0.5")
        
        # 时间推进（显式格式）
        for n in range(nt - 1):
            for i in range(1, nx - 1):
                # 对流项（上风格式）
                advection = -c * (Q[n, i] - Q[n, i-1]) / dx
                
                # 扩散项（中心差分）
                diffusion_term = D * (Q[n, i+1] - 2*Q[n, i] + Q[n, i-1]) / dx**2
                
                Q[n+1, i] = Q[n, i] + dt * (advection + diffusion_term)
            
            # 边界条件
            Q[n+1, 0] = Q[n, 0]  # 上游固定
            Q[n+1, -1] = Q[n+1, -2]  # 下游零梯度
        
        return Q
    
    def plot_flood_routing(self, t, I, Q, K, x):
        """绘制洪水演算对比图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. 入流vs出流过程线
        ax1 = axes[0, 0]
        
        ax1.plot(t / 3600, I, 'b-', linewidth=2.5, label='入流I')
        ax1.plot(t / 3600, Q, 'r-', linewidth=2.5, label='出流Q')
        
        # 标注峰值
        I_peak = np.max(I)
        Q_peak = np.max(Q)
        t_I_peak = t[np.argmax(I)] / 3600
        t_Q_peak = t[np.argmax(Q)] / 3600
        
        ax1.scatter([t_I_peak], [I_peak], color='b', s=150, zorder=5, marker='^')
        ax1.scatter([t_Q_peak], [Q_peak], color='r', s=150, zorder=5, marker='v')
        
        ax1.text(t_I_peak, I_peak + 20, f'入流峰值\n{I_peak:.0f}m³/s\nt={t_I_peak:.1f}h',
                ha='center', fontsize=10)
        ax1.text(t_Q_peak, Q_peak + 20, f'出流峰值\n{Q_peak:.0f}m³/s\nt={t_Q_peak:.1f}h',
                ha='center', fontsize=10)
        
        ax1.set_xlabel('时间 (小时)', fontsize=11)
        ax1.set_ylabel('流量 (m³/s)', fontsize=11)
        ax1.set_title(f'马斯京根法洪水演算\nK={K/3600:.1f}h, x={x:.2f}',
                     fontsize=13, fontweight='bold')
        ax1.legend(fontsize=11)
        ax1.grid(True, alpha=0.3)
        
        # 2. 削峰与滞时分析
        ax2 = axes[0, 1]
        
        peak_reduction = (I_peak - Q_peak) / I_peak * 100
        lag_time = t_Q_peak - t_I_peak
        
        metrics = ['峰值削减(%)', '滞时(小时)']
        values = [peak_reduction, lag_time]
        colors = ['salmon', 'lightblue']
        
        bars = ax2.barh(metrics, values, color=colors, alpha=0.8, edgecolor='black')
        
        for bar, value in zip(bars, values):
            width = bar.get_width()
            ax2.text(width + max(values)*0.02, bar.get_y() + bar.get_height()/2,
                    f'{value:.2f}', va='center', fontsize=12, fontweight='bold')
        
        ax2.set_xlabel('数值', fontsize=11)
        ax2.set_title('演算效果指标', fontsize=13, fontweight='bold')
        ax2.grid(True, alpha=0.3, axis='x')
        
        # 3. 蓄量过程
        ax3 = axes[1, 0]
        
        S = K * (x * I + (1 - x) * Q)
        
        ax3.fill_between(t / 3600, 0, S / 1e6, alpha=0.5, color='cyan', label='河段蓄量')
        ax3.plot(t / 3600, S / 1e6, 'b-', linewidth=2)
        
        ax3.set_xlabel('时间 (小时)', fontsize=11)
        ax3.set_ylabel('蓄量 (百万m³)', fontsize=11)
        ax3.set_title('河段蓄量过程', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 参数敏感性分析
        ax4 = axes[1, 1]
        
        x_values = [0, 0.1, 0.2, 0.3, 0.4]
        colors_sens = plt.cm.viridis(np.linspace(0.2, 0.9, len(x_values)))
        
        for x_val, color in zip(x_values, colors_sens):
            Q_sens = UnsteadyFlow().muskingum_routing(I, K, x_val, t[1] - t[0])
            ax4.plot(t / 3600, Q_sens, color=color, linewidth=2, label=f'x={x_val:.1f}')
        
        ax4.plot(t / 3600, I, 'k--', linewidth=1.5, alpha=0.5, label='入流I')
        
        ax4.set_xlabel('时间 (小时)', fontsize=11)
        ax4.set_ylabel('流量 (m³/s)', fontsize=11)
        ax4.set_title(f'权重系数x的影响（K={K/3600:.1f}h）', fontsize=13, fontweight='bold')
        ax4.legend(fontsize=9)
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('flood_routing_analysis.png', dpi=300)
        plt.show()

# 示例1：马斯京根法洪水演算
print("="*60)
print("示例1：马斯京根法洪水演算")
print("="*60)

unsteady = UnsteadyFlow()

# 模拟洪水过程（三角形洪水波）
dt = 3600  # 1小时
duration = 72 * 3600  # 72小时
t = np.arange(0, duration + dt, dt)

# 入流过程（三角形）
t_peak = 24 * 3600  # 24小时达到峰值
I = np.zeros(len(t))

for i, time in enumerate(t):
    if time <= t_peak:
        I[i] = 100 + (800 - 100) * (time / t_peak)
    else:
        I[i] = 800 - (800 - 100) * ((time - t_peak) / (duration - t_peak))

# 马斯京根参数
K = 12 * 3600  # 12小时
x = 0.2

print(f"马斯京根参数:")
print(f"  蓄量常数 K = {K/3600:.1f} 小时")
print(f"  权重系数 x = {x}")
print(f"  时间步长 Δt = {dt/3600:.1f} 小时")

# 计算系数
C0, C1, C2 = unsteady.muskingum_coefficients(K, x, dt)

print(f"\n演算系数:")
print(f"  C₀ = {C0:.4f}")
print(f"  C₁ = {C1:.4f}")
print(f"  C₂ = {C2:.4f}")
print(f"  验证：C₀+C₁+C₂ = {C0+C1+C2:.6f}")

# 洪水演算
Q = unsteady.muskingum_routing(I, K, x, dt)

# 分析结果
I_peak = np.max(I)
Q_peak = np.max(Q)
t_I_peak = t[np.argmax(I)]
t_Q_peak = t[np.argmax(Q)]

print(f"\n演算结果:")
print(f"  入流峰值 = {I_peak:.1f} m³/s，出现时间 = {t_I_peak/3600:.1f} 小时")
print(f"  出流峰值 = {Q_peak:.1f} m³/s，出现时间 = {t_Q_peak/3600:.1f} 小时")
print(f"  峰值削减 = {(I_peak - Q_peak)/I_peak*100:.2f}%")
print(f"  洪峰滞时 = {(t_Q_peak - t_I_peak)/3600:.1f} 小时")

# 示例2：参数率定
print("\n" + "="*60)
print("示例2：马斯京根参数率定")
print("="*60)

# 模拟观测数据（在真实出流基础上加噪声）
Q_obs = Q + np.random.normal(0, 10, len(Q))

print(f"已知入流过程和观测出流过程，率定参数K和x...")

K_opt, x_opt, Q_sim = unsteady.calibrate_muskingum(I, Q_obs, dt)

print(f"\n率定结果:")
print(f"  最优K = {K_opt/3600:.2f} 小时")
print(f"  最优x = {x_opt:.3f}")

# 精度评价
RMSE = np.sqrt(np.mean((Q_sim - Q_obs)**2))
NSE = 1 - np.sum((Q_sim - Q_obs)**2) / np.sum((Q_obs - np.mean(Q_obs))**2)

print(f"\n精度评价:")
print(f"  RMSE = {RMSE:.2f} m³/s")
print(f"  NSE = {NSE:.4f}")

# 示例3：波速计算
print("\n" + "="*60)
print("示例3：浅水波波速")
print("="*60)

depths = [1, 2, 3, 5, 10]

print(f"{'水深h(m)':<12s} {'波速c(m/s)':<15s} {'流速v=2m/s时':<20s}")
print(f"{'':12s} {'':15s} {'顺流(v+c)':<10s} {'逆流(v-c)':<10s}")
print("-" * 55)

v_flow = 2.0

for h in depths:
    c = unsteady.wave_celerity(h)
    c_downstream = v_flow + c
    c_upstream = v_flow - c
    
    print(f"{h:<12.1f} {c:<15.2f} {c_downstream:<10.2f} {c_upstream:<10.2f}")

# 绘制洪水演算分析图
print("\n绘制洪水演算分析图...")
unsteady.plot_flood_routing(t, I, Q, K, x)
```

---

## 七、典型考题

### 【例题1】马斯京根法计算（15分）

**题目**：$K=10$h，$x=0.25$，$\Delta t=2$h。已知$I_t=300$m³/s，$I_{t+\Delta t}=450$m³/s，$Q_t=280$m³/s。求$Q_{t+\Delta t}$。

**【解答】**

$$C_0 = \frac{-Kx + \Delta t/2}{K(1-x) + \Delta t/2} = \frac{-10 \times 0.25 + 1}{10 \times 0.75 + 1} = \frac{-1.5}{8.5} = -0.176$$

$$C_1 = \frac{Kx + \Delta t/2}{K(1-x) + \Delta t/2} = \frac{2.5 + 1}{8.5} = 0.412$$

$$C_2 = \frac{K(1-x) - \Delta t/2}{K(1-x) + \Delta t/2} = \frac{7.5 - 1}{8.5} = 0.765$$

验证：$C_0 + C_1 + C_2 = -0.176 + 0.412 + 0.765 = 1.001$ ✓

$$Q_{t+\Delta t} = -0.176 \times 450 + 0.412 \times 300 + 0.765 \times 280$$

$$= -79.2 + 123.6 + 214.2 = 258.6 \text{ m}^3\text{/s}$$

---

**本章重点**：
- 圣维南方程组
- 马斯京根法洪水演算
- 特征线法
- 扩散波模型

**全书完成！**
