# Day 13：水库兴利调节计算

**学习时间**: 4小时  
**难度**: ⭐⭐⭐⭐⭐  
**重要性**: ⭐⭐⭐⭐⭐

---

## 一、兴利调节基本概念

### 1.1 调节目的

**兴利调节**：调蓄天然径流，满足用水需求

**类型**：
- 日调节
- 季调节
- 年调节
- 多年调节

### 1.2 特征库容

```
   ┌─────────────┐ 校核洪水位
   │  校核库容   │
   ├─────────────┤ 设计洪水位
   │  防洪库容   │
   ├─────────────┤ 正常蓄水位(兴利水位)
   │  兴利库容   │
   ├─────────────┤ 死水位
   │  死库容     │
   └─────────────┘
```

**兴利库容**：正常蓄水位与死水位之间的库容

---

## 二、年调节计算

### 2.1 时历法

**水量平衡**：
$$V_{t+1} = V_t + Q_t - D_t - L_t$$

其中：
- $V_t$：t时段初库容
- $Q_t$：入流量
- $D_t$：供水量
- $L_t$：损失（蒸发、渗漏）

**兴利库容**：
$$V_{兴} = V_{max} - V_{min}$$

### 2.2 设计保证率

**保证率**：供水保证程度

$$P = \frac{满足要求的年数}{总年数} \times 100\%$$

常用保证率：
- 工业供水：95-97%
- 城市供水：95-99%
- 灌溉供水：75-85%

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

class ReservoirRegulation:
    """
    水库兴利调节
    """
    
    def __init__(self, storage_curve):
        """
        参数:
            storage_curve: [(Z, V), ...] 水位-库容关系
        """
        from scipy.interpolate import interp1d
        
        Z_vals = [item[0] for item in storage_curve]
        V_vals = [item[1] for item in storage_curve]
        
        self.Z_to_V = interp1d(Z_vals, V_vals, kind='cubic',
                               fill_value='extrapolate')
        self.V_to_Z = interp1d(V_vals, Z_vals, kind='cubic',
                               fill_value='extrapolate')
    
    def annual_regulation(self, inflow, demand, V_dead, V_max, 
                         loss_rate=0.0):
        """
        年调节时历法
        
        参数:
            inflow: 入流序列 (亿m³)
            demand: 需水序列 (亿m³)
            V_dead: 死库容 (亿m³)
            V_max: 最大库容 (亿m³)
            loss_rate: 损失率
        
        返回:
            库容过程, 供水过程, 缺水过程
        """
        n = len(inflow)
        
        V = np.zeros(n + 1)  # 库容
        D_actual = np.zeros(n)  # 实际供水
        D_deficit = np.zeros(n)  # 缺水量
        
        # 初始状态（死库容）
        V[0] = V_dead
        
        for t in range(n):
            # 损失
            loss = V[t] * loss_rate
            
            # 可供水量
            V_available = V[t] + inflow[t] - loss - V_dead
            
            # 供水
            if V_available >= demand[t]:
                # 能满足需求
                D_actual[t] = demand[t]
                V[t+1] = V[t] + inflow[t] - loss - demand[t]
            else:
                # 不能满足
                D_actual[t] = max(V_available, 0)
                V[t+1] = V_dead
                D_deficit[t] = demand[t] - D_actual[t]
            
            # 库容约束
            if V[t+1] > V_max:
                # 弃水
                V[t+1] = V_max
            elif V[t+1] < V_dead:
                V[t+1] = V_dead
        
        return V, D_actual, D_deficit
    
    def calculate_firm_yield(self, inflow, V_dead, V_normal, guarantee_rate=0.95):
        """
        计算保证出力（设计供水量）
        
        采用试算法
        
        参数:
            inflow: 多年入流序列
            V_dead: 死库容
            V_normal: 正常蓄水位对应库容
            guarantee_rate: 保证率
        
        返回:
            保证供水量
        """
        # 初始估计
        Q_avg = np.mean(inflow)
        D_test = Q_avg * 0.8  # 初始试探
        
        # 二分法试算
        D_min = 0
        D_max = Q_avg * 1.5
        
        tolerance = 0.01  # 容差（亿m³）
        
        while D_max - D_min > tolerance:
            D_test = (D_min + D_max) / 2
            
            # 调节计算
            demand = np.full(len(inflow), D_test)
            _, _, deficit = self.annual_regulation(
                inflow, demand, V_dead, V_normal
            )
            
            # 统计保证率
            n_satisfied = np.sum(deficit == 0)
            actual_rate = n_satisfied / len(inflow)
            
            if actual_rate >= guarantee_rate:
                # 满足，增大供水量
                D_min = D_test
            else:
                # 不满足，减小供水量
                D_max = D_test
        
        firm_yield = D_test
        
        return firm_yield
    
    def plot_regulation_process(self, inflow, demand, V, D_actual, D_deficit,
                               V_dead, V_normal):
        """
        绘制调节过程
        """
        n = len(inflow)
        months = np.arange(1, n + 1)
        
        fig, axes = plt.subplots(3, 1, figsize=(14, 12))
        
        # 1. 入流与供水
        axes[0].plot(months, inflow, 'b-', linewidth=2, label='入流')
        axes[0].plot(months, demand, 'r--', linewidth=2, label='需水')
        axes[0].plot(months, D_actual, 'g-', linewidth=2, label='实际供水')
        
        # 标注缺水时段
        deficit_months = np.where(D_deficit > 0)[0] + 1
        if len(deficit_months) > 0:
            axes[0].scatter(deficit_months, 
                           D_actual[D_deficit > 0],
                           s=100, c='red', marker='x', 
                           label='缺水', zorder=5)
        
        axes[0].set_ylabel('水量 (亿m³)', fontsize=12)
        axes[0].set_title('入流与供水过程', fontsize=14)
        axes[0].legend()
        axes[0].grid(True, alpha=0.3)
        
        # 2. 库容变化
        axes[1].plot(months, V[1:], 'purple', linewidth=2, label='库容')
        axes[1].axhline(V_normal, color='blue', linestyle='--',
                       linewidth=2, label='正常蓄水位')
        axes[1].axhline(V_dead, color='orange', linestyle='--',
                       linewidth=2, label='死水位')
        axes[1].fill_between(months, V_dead, V[1:], alpha=0.3, color='blue')
        
        axes[1].set_ylabel('库容 (亿m³)', fontsize=12)
        axes[1].set_title('库容变化过程', fontsize=14)
        axes[1].legend()
        axes[1].grid(True, alpha=0.3)
        
        # 3. 缺水分析
        axes[2].bar(months, D_deficit, color='red', alpha=0.7, label='缺水量')
        axes[2].set_xlabel('时段', fontsize=12)
        axes[2].set_ylabel('缺水量 (亿m³)', fontsize=12)
        axes[2].set_title('缺水分析', fontsize=14)
        axes[2].legend()
        axes[2].grid(True, alpha=0.3, axis='y')
        
        # 统计信息
        total_deficit = np.sum(D_deficit)
        n_deficit = np.sum(D_deficit > 0)
        guarantee = (n - n_deficit) / n * 100
        
        axes[2].text(0.95, 0.95, 
                    f'总缺水: {total_deficit:.2f}亿m³\n缺水时段: {n_deficit}个\n保证率: {guarantee:.1f}%',
                    transform=axes[2].transAxes,
                    fontsize=11,
                    verticalalignment='top',
                    horizontalalignment='right',
                    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))
        
        plt.tight_layout()
        plt.savefig('reservoir_regulation.png', dpi=300, bbox_inches='tight')
        plt.show()


# 使用示例
print("="*60)
print("水库年调节计算")
print("="*60)

# 水位-库容关系
storage_curve = [
    (100, 0.5),   # 死水位
    (110, 5.0),
    (120, 12.0),
    (130, 22.0),  # 正常蓄水位
    (135, 28.0)
]

reservoir = ReservoirRegulation(storage_curve)

# 多年入流（12个月×3年）
np.random.seed(42)

# 模拟入流（带季节性）
months_total = 36
inflow = []

for i in range(months_total):
    month = i % 12 + 1
    
    # 季节系数
    if month in [6, 7, 8, 9]:  # 汛期
        seasonal_factor = 2.5
    elif month in [12, 1, 2]:  # 枯水期
        seasonal_factor = 0.3
    else:
        seasonal_factor = 1.0
    
    # 基础流量 + 季节变化 + 随机波动
    Q = 3.0 * seasonal_factor + np.random.normal(0, 0.5)
    Q = max(Q, 0.1)
    inflow.append(Q)

inflow = np.array(inflow)

# 需水量（相对稳定）
demand = np.full(months_total, 4.0)

# 库容参数
V_dead = 0.5    # 死库容 (亿m³)
V_normal = 22.0  # 正常蓄水位库容 (亿m³)

print(f"水库参数:")
print(f"  死库容: {V_dead} 亿m³")
print(f"  正常蓄水位库容: {V_normal} 亿m³")
print(f"  兴利库容: {V_normal - V_dead} 亿m³")

print(f"\n入流统计:")
print(f"  平均: {np.mean(inflow):.2f} 亿m³/月")
print(f"  最大: {np.max(inflow):.2f} 亿m³/月")
print(f"  最小: {np.min(inflow):.2f} 亿m³/月")
print(f"  年均: {np.sum(inflow[:12]):.2f} 亿m³/年")

print(f"\n需水:")
print(f"  月需水: {demand[0]} 亿m³")
print(f"  年需水: {demand[0] * 12} 亿m³")

# 调节计算
V, D_actual, D_deficit = reservoir.annual_regulation(
    inflow, demand, V_dead, V_normal, loss_rate=0.01
)

# 统计
total_deficit = np.sum(D_deficit)
n_deficit = np.sum(D_deficit > 0)
guarantee_rate = (len(inflow) - n_deficit) / len(inflow) * 100

print(f"\n调节结果:")
print(f"  总缺水量: {total_deficit:.2f} 亿m³")
print(f"  缺水时段数: {n_deficit}")
print(f"  保证率: {guarantee_rate:.1f}%")

if guarantee_rate >= 95:
    print(f"  评价: 满足设计保证率要求 ✓")
else:
    print(f"  评价: 不满足设计保证率要求 ✗")

# 可视化
reservoir.plot_regulation_process(
    inflow, demand, V, D_actual, D_deficit, V_dead, V_normal
)

# 保证出力计算
print("\n" + "="*60)
print("保证出力计算")
print("="*60)

# 多年序列（10年）
inflow_10y = []
for _ in range(10):
    for i in range(12):
        month = i + 1
        if month in [6, 7, 8, 9]:
            seasonal_factor = 2.5
        elif month in [12, 1, 2]:
            seasonal_factor = 0.3
        else:
            seasonal_factor = 1.0
        
        Q = 3.0 * seasonal_factor + np.random.normal(0, 0.5)
        Q = max(Q, 0.1)
        inflow_10y.append(Q)

inflow_10y = np.array(inflow_10y)

# 计算不同保证率下的保证出力
for P in [0.90, 0.95, 0.975]:
    firm_yield = reservoir.calculate_firm_yield(
        inflow_10y, V_dead, V_normal, guarantee_rate=P
    )
    
    print(f"保证率{P*100:.0f}%: 保证供水量 = {firm_yield:.2f} 亿m³/月")
```

---

## 三、调节图法

### 3.1 原理

**累积曲线**：
- 入流累积曲线
- 需水累积曲线

**兴利库容**：两曲线最大竖距

### 3.2 图解步骤

1. 绘制入流累积曲线
2. 从最低点作需水斜线
3. 平移至最高点
4. 竖距即为兴利库容

---

## 四、典型考题

### 考题：兴利库容计算

**【题目】**（35分）

某水库，年入流序列：
- 枯水年：30亿m³
- 平水年：50亿m³
- 丰水年：70亿m³

设计供水：45亿m³/年，保证率75%。

求所需兴利库容。

**【解答】**

**时历法**：

| 年型 | 入流 | 需水 | 盈亏 | 累积 | 库容 |
|------|------|------|------|------|------|
| 枯 | 30 | 45 | -15 | -15 | 0→15 |
| 平 | 50 | 45 | +5 | -10 | 15→10 |
| 枯 | 30 | 45 | -15 | -25 | 10→25 |
| 丰 | 70 | 45 | +25 | 0 | 25→0 |

**兴利库容**：**25亿m³**

**保证率**：3/4 = 75% ✓

---

## 五、高频考点

| 考点 | 方法 | 难度 |
|------|------|------|
| 时历法 | 水量平衡逐时段 | ⭐⭐⭐⭐ |
| 调节图法 | 累积曲线图解 | ⭐⭐⭐ |
| 保证出力 | 试算法 | ⭐⭐⭐⭐⭐ |
| 保证率计算 | 统计分析 | ⭐⭐⭐ |

---

**明日预告**: Day 14 - 水电站调节运行

**本日重点**：
- 时历法（必考）
- 保证率概念
- 兴利库容确定
