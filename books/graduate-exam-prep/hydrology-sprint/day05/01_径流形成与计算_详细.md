# Day 5：径流形成与计算

**学习时间**: 4小时  
**难度**: ⭐⭐⭐⭐  
**重要性**: ⭐⭐⭐⭐⭐（核心考点）

---

## 一、产流模式

### 1.1 超渗产流

**条件**：降雨强度 > 下渗能力

$$i > f_t$$

**适用地区**：干旱半干旱，包气带厚

**特点**：
- 产流快
- 洪峰高
- 历时短

### 1.2 蓄满产流

**条件**：土壤含水量达到田间持水量

$$W \geq W_{fc}$$

**适用地区**：湿润地区

**特点**：
- 产流慢
- 需累积降水
- 前期土壤含水量重要

### 1.3 Python实现

```python
import numpy as np
import matplotlib.pyplot as plt

class RunoffGeneration:
    """
    径流形成计算
    """
    
    def __init__(self, model_type='horton'):
        """
        参数:
            model_type: 'horton' 或 'saturation'
        """
        self.model_type = model_type
    
    def horton_infiltration_excess(self, rainfall, f0, fc, k, dt=1):
        """
        超渗产流（霍顿模型）
        
        参数:
            rainfall: 降雨强度序列 (mm/h)
            f0: 初始下渗率 (mm/h)
            fc: 稳定下渗率 (mm/h)
            k: 衰减系数 (h⁻¹)
            dt: 时间步长 (h)
        
        返回:
            径流序列, 下渗序列
        """
        n = len(rainfall)
        t = np.arange(n) * dt
        
        # 下渗率
        ft = fc + (f0 - fc) * np.exp(-k * t)
        
        # 超渗径流
        runoff = np.maximum(rainfall - ft, 0)
        
        # 实际下渗
        infiltration = np.minimum(rainfall, ft)
        
        return runoff, infiltration, ft
    
    def saturation_excess(self, rainfall, W0, Wfc, Wmax, dt=1):
        """
        蓄满产流模型
        
        参数:
            rainfall: 降雨量序列 (mm)
            W0: 初始土壤含水量 (mm)
            Wfc: 田间持水量 (mm)
            Wmax: 最大持水量 (mm)
            dt: 时间步长 (h)
        
        返回:
            径流序列, 土壤含水量序列
        """
        n = len(rainfall)
        runoff = np.zeros(n)
        W = np.zeros(n + 1)
        W[0] = W0
        
        for i in range(n):
            # 降水增加土壤含水量
            W[i+1] = W[i] + rainfall[i]
            
            # 判断是否产流
            if W[i+1] > Wfc:
                # 超过田间持水量，产流
                runoff[i] = W[i+1] - Wfc
                W[i+1] = Wfc
            
            # 蒸发损失（简化）
            E = 2.0 * dt  # mm
            W[i+1] = max(0, W[i+1] - E)
        
        return runoff, W[:-1]
    
    def plot_runoff_process(self, time, rainfall, runoff, infiltration=None):
        """
        绘制产流过程
        """
        fig, axes = plt.subplots(2, 1, figsize=(12, 8))
        
        # 降雨与径流
        axes[0].bar(time, rainfall, width=0.8, alpha=0.6, 
                   color='blue', label='降雨')
        axes[0].bar(time, runoff, width=0.8, alpha=0.8, 
                   color='red', label='径流')
        
        axes[0].set_xlabel('时间 (h)', fontsize=12)
        axes[0].set_ylabel('强度/量 (mm)', fontsize=12)
        axes[0].set_title('降雨与径流过程', fontsize=14)
        axes[0].legend()
        axes[0].grid(True, alpha=0.3)
        
        # 累积过程
        P_cum = np.cumsum(rainfall)
        R_cum = np.cumsum(runoff)
        
        axes[1].plot(time, P_cum, 'b-', linewidth=2, label='累积降雨', marker='o')
        axes[1].plot(time, R_cum, 'r-', linewidth=2, label='累积径流', marker='s')
        
        if infiltration is not None:
            F_cum = np.cumsum(infiltration)
            axes[1].plot(time, F_cum, 'g-', linewidth=2, label='累积下渗', marker='^')
        
        axes[1].set_xlabel('时间 (h)', fontsize=12)
        axes[1].set_ylabel('累积量 (mm)', fontsize=12)
        axes[1].set_title('累积降雨径流过程', fontsize=14)
        axes[1].legend()
        axes[1].grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('runoff_generation_process.png', dpi=300, bbox_inches='tight')
        plt.show()
    
    def runoff_coefficient(self, rainfall, runoff):
        """
        计算径流系数
        """
        P_total = np.sum(rainfall)
        R_total = np.sum(runoff)
        
        if P_total > 0:
            alpha = R_total / P_total
        else:
            alpha = 0
        
        return alpha, P_total, R_total


# 使用示例
rg = RunoffGeneration()

# 超渗产流
print("="*60)
print("示例1：超渗产流")
print("="*60)

rainfall_horton = np.array([10, 30, 50, 60, 40, 20, 10, 5])  # mm/h
runoff_h, infil_h, ft = rg.horton_infiltration_excess(
    rainfall_horton, f0=50, fc=5, k=0.8
)

alpha_h, P_h, R_h = rg.runoff_coefficient(rainfall_horton, runoff_h)

print(f"时段降雨径流:")
for i, (p, r, f) in enumerate(zip(rainfall_horton, runoff_h, ft)):
    print(f"  t={i}h: i={p}mm/h, f={f:.1f}mm/h, R={r:.1f}mm/h")

print(f"\n汇总:")
print(f"  总降雨: {P_h:.1f} mm")
print(f"  总径流: {R_h:.1f} mm")
print(f"  径流系数: {alpha_h:.3f}")

# 绘图
time = np.arange(len(rainfall_horton))
rg.plot_runoff_process(time, rainfall_horton, runoff_h, infil_h)

# 蓄满产流
print("\n" + "="*60)
print("示例2：蓄满产流")
print("="*60)

rainfall_sat = np.array([5, 10, 15, 20, 25, 15, 10, 5])  # mm
runoff_s, W_s = rg.saturation_excess(
    rainfall_sat, W0=30, Wfc=50, Wmax=60
)

alpha_s, P_s, R_s = rg.runoff_coefficient(rainfall_sat, runoff_s)

print(f"时段降雨径流:")
for i, (p, r, w) in enumerate(zip(rainfall_sat, runoff_s, W_s)):
    print(f"  t={i}h: P={p}mm, W={w:.1f}mm, R={r:.1f}mm")

print(f"\n汇总:")
print(f"  总降雨: {P_s:.1f} mm")
print(f"  总径流: {R_s:.1f} mm")
print(f"  径流系数: {alpha_s:.3f}")
```

---

## 二、汇流计算

### 2.1 单位线理论

**定义**：单位时段内，流域上均匀分布的单位净雨产生的地面径流过程线

**特性**：
1. **等时性**：相同时段的净雨，其单位线形状相同
2. **叠加性**：不同时段的径流可叠加
3. **比例性**：净雨量加倍，径流量加倍

### 2.2 瞬时单位线

**S曲线法**：
$$S(t) = \sum_{i=0}^{\infty}u(t - i\tau)$$

### 2.3 Python实现

```python
class UnitHydrograph:
    """
    单位线计算
    """
    
    def __init__(self, time, unit_hydro):
        """
        参数:
            time: 时间序列 (h)
            unit_hydro: 单位线纵坐标 (m³/s/mm)
        """
        self.time = time
        self.unit_hydro = unit_hydro
        self.dt = time[1] - time[0] if len(time) > 1 else 1
    
    def convolute(self, net_rainfall):
        """
        单位线卷积计算径流
        
        参数:
            net_rainfall: 净雨序列 (mm)
        
        返回:
            径流过程线 (m³/s)
        """
        n_rain = len(net_rainfall)
        n_unit = len(self.unit_hydro)
        n_total = n_rain + n_unit - 1
        
        # 初始化径流过程
        Q = np.zeros(n_total)
        
        # 卷积计算
        for i in range(n_rain):
            for j in range(n_unit):
                Q[i + j] += net_rainfall[i] * self.unit_hydro[j]
        
        return Q
    
    def plot_unit_hydrograph(self):
        """
        绘制单位线
        """
        fig, ax = plt.subplots(figsize=(10, 6))
        
        ax.plot(self.time, self.unit_hydro, 'b-o', linewidth=2, markersize=6)
        ax.fill_between(self.time, self.unit_hydro, alpha=0.3)
        
        ax.set_xlabel('时间 (h)', fontsize=12)
        ax.set_ylabel('流量 (m³/s/mm)', fontsize=12)
        ax.set_title('单位线', fontsize=14)
        ax.grid(True, alpha=0.3)
        
        # 标注峰值
        peak_idx = np.argmax(self.unit_hydro)
        peak_t = self.time[peak_idx]
        peak_q = self.unit_hydro[peak_idx]
        ax.annotate(f'峰值\n{peak_q:.2f} m³/s/mm\nt={peak_t}h',
                   xy=(peak_t, peak_q),
                   xytext=(peak_t+2, peak_q+0.5),
                   arrowprops=dict(arrowstyle='->', color='red'),
                   fontsize=10)
        
        plt.tight_layout()
        plt.savefig('unit_hydrograph.png', dpi=300, bbox_inches='tight')
        plt.show()
    
    def plot_convolution(self, net_rainfall, Q):
        """
        绘制卷积过程
        """
        n = len(Q)
        time_Q = np.arange(n) * self.dt
        
        fig, axes = plt.subplots(2, 1, figsize=(12, 8))
        
        # 净雨
        time_rain = np.arange(len(net_rainfall)) * self.dt
        axes[0].bar(time_rain, net_rainfall, width=self.dt*0.8, 
                   color='blue', alpha=0.6, label='净雨')
        axes[0].set_xlabel('时间 (h)', fontsize=12)
        axes[0].set_ylabel('净雨 (mm)', fontsize=12)
        axes[0].set_title('净雨过程', fontsize=14)
        axes[0].legend()
        axes[0].grid(True, alpha=0.3)
        
        # 径流过程线
        axes[1].plot(time_Q, Q, 'r-', linewidth=2, label='径流过程线')
        axes[1].fill_between(time_Q, Q, alpha=0.3, color='red')
        
        # 标注峰值
        peak_idx = np.argmax(Q)
        peak_t = time_Q[peak_idx]
        peak_Q = Q[peak_idx]
        axes[1].annotate(f'洪峰\n{peak_Q:.1f} m³/s\nt={peak_t}h',
                        xy=(peak_t, peak_Q),
                        xytext=(peak_t+3, peak_Q+20),
                        arrowprops=dict(arrowstyle='->', color='red'),
                        fontsize=10)
        
        axes[1].set_xlabel('时间 (h)', fontsize=12)
        axes[1].set_ylabel('流量 (m³/s)', fontsize=12)
        axes[1].set_title('地面径流过程线', fontsize=14)
        axes[1].legend()
        axes[1].grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('runoff_hydrograph.png', dpi=300, bbox_inches='tight')
        plt.show()


# 单位线示例
print("\n" + "="*60)
print("示例3：单位线法计算径流")
print("="*60)

# 单位线（简化三角形）
time_uh = np.array([0, 2, 4, 6, 8, 10, 12, 14, 16])
unit_hydro = np.array([0, 1.5, 3.0, 4.0, 3.5, 2.5, 1.5, 0.8, 0])

uh = UnitHydrograph(time_uh, unit_hydro)

# 绘制单位线
uh.plot_unit_hydrograph()

# 净雨序列
net_rain = np.array([10, 15, 8])  # mm

# 卷积计算
Q_runoff = uh.convolute(net_rain)

print(f"净雨序列: {net_rain} mm")
print(f"洪峰流量: {np.max(Q_runoff):.1f} m³/s")
print(f"洪峰时间: {np.argmax(Q_runoff)*uh.dt:.0f} h")

# 绘制径流过程
uh.plot_convolution(net_rain, Q_runoff)
```

---

## 三、典型考题

### 考题1：超渗产流计算

**【题目】**（25分）

某流域，霍顿参数：f₀=60 mm/h，fc=6 mm/h，k=1.0 h⁻¹。

降雨过程：0-1h，40mm/h；1-2h，70mm/h；2-3h，30mm/h。

求：
1. 各时段下渗率
2. 各时段径流深
3. 总径流深
4. 径流系数

**【解答】**

#### 1. 下渗率

**t=0.5h（第1时段中点）**：
$$f_{0.5} = 6 + 54e^{-0.5} = 38.7 \text{ mm/h}$$

**t=1.5h**：
$$f_{1.5} = 6 + 54e^{-1.5} = 18.0 \text{ mm/h}$$

**t=2.5h**：
$$f_{2.5} = 6 + 54e^{-2.5} = 10.4 \text{ mm/h}$$

#### 2. 径流深

**0-1h**：i=40 > f̄≈38.7 → R₁ ≈ 40-38.7 = 1.3 mm

**1-2h**：i=70 > f̄≈18.0 → R₂ = 70-18.0 = 52.0 mm

**2-3h**：i=30 > f̄≈10.4 → R₃ = 30-10.4 = 19.6 mm

#### 3. 总径流深

$$R = 1.3 + 52.0 + 19.6 = 72.9 \text{ mm}$$

#### 4. 径流系数

$$\alpha = \frac{R}{P} = \frac{72.9}{40+70+30} = \frac{72.9}{140} = 0.521$$

**答案**：径流系数**0.521**

---

## 四、高频考点总结

| 考点 | 关键公式/概念 | 注意事项 |
|------|-------------|---------|
| 超渗产流 | i > f → 产流 | 干旱区 |
| 蓄满产流 | W > Wfc → 产流 | 湿润区 |
| 霍顿公式 | $f_t = f_c + (f_0-f_c)e^{-kt}$ | 背诵 |
| 径流系数 | α = R/P | 无量纲 |
| 单位线 | 卷积法 | 叠加原理 |

---

## 五、本日练习

### 练习1（25分）
霍顿参数：f₀=50 mm/h，fc=5 mm/h，k=0.8 h⁻¹。
降雨：0-1h，i=35mm/h；1-2h，i=60mm/h。
求各时段径流量和总径流系数。

### 练习2（30分）
已知单位线，净雨序列[12, 18, 10] mm。
用卷积法计算径流过程，求洪峰流量。

---

**明日预告**: Day 6 - 洪水计算与频率分析

**本日重点**：
- 超渗vs蓄满产流（必考）
- 霍顿公式应用（高频）
- 单位线法（重要）
