# Day 12：防洪规划与风险分析

**学习时间**: 4小时  
**难度**: ⭐⭐⭐⭐⭐  
**重要性**: ⭐⭐⭐⭐⭐

---

## 一、防洪标准与设计洪水

### 1.1 防洪标准

**重现期**（T）：某量级洪水平均多少年出现一次

**频率**（P）：年超越概率
$$P = \frac{1}{T}$$

**常用标准**：
- 特大城市：100-200年（P=1%-0.5%）
- 大城市：50-100年（P=2%-1%）
- 中等城市：20-50年（P=5%-2%）
- 一般堤防：10-20年（P=10%-5%）

### 1.2 设计洪水计算

**频率分析法**（Pearson III型）：

$$Q_P = \bar{Q}(1 + C_v \Phi_P)$$

其中：
- $\bar{Q}$：均值
- $C_v$：变差系数
- $\Phi_P$：模比系数（查表或计算）

---

## 二、洪水风险分析

### 2.1 风险率

**n年内至少发生一次的概率**：
$$R_n = 1 - (1-P)^n$$

**工程寿命期风险**：
$$R = 1 - (1-P)^T_{使用}$$

### 2.2 风险决策

**期望损失**：
$$E(L) = \sum_{i} P_i \cdot L_i$$

**最优决策**：使期望损失最小

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from scipy.optimize import minimize_scalar

class FloodRiskAnalysis:
    """
    洪水风险分析
    """
    
    def __init__(self, annual_max_flow):
        """
        参数:
            annual_max_flow: 年最大流量序列 (m³/s)
        """
        self.data = np.array(annual_max_flow)
        self.n = len(self.data)
        
        # 统计特征
        self.mean = np.mean(self.data)
        self.std = np.std(self.data, ddof=1)
        self.cv = self.std / self.mean
        
    def design_flood(self, P, Cs_Cv_ratio=2.0):
        """
        设计洪水计算（Pearson III）
        
        参数:
            P: 设计频率
            Cs_Cv_ratio: Cs/Cv比值
        
        返回:
            设计流量
        """
        Cs = Cs_Cv_ratio * self.cv
        
        # 模比系数（简化计算）
        if Cs != 0:
            z = stats.norm.ppf(1 - P)
            Phi = z + (z**2 - 1) * Cs / 6
        else:
            Phi = stats.norm.ppf(1 - P)
        
        Q_P = self.mean * (1 + self.cv * Phi)
        
        return Q_P
    
    def risk_probability(self, P, n_years):
        """
        n年内至少发生一次的风险率
        
        R = 1 - (1-P)^n
        
        参数:
            P: 年超越概率
            n_years: 年数
        
        返回:
            风险率
        """
        R = 1 - (1 - P)**n_years
        return R
    
    def return_period_for_risk(self, R, n_years):
        """
        给定风险率，反算设计标准
        
        T = 1 / [1 - (1-R)^(1/n)]
        
        参数:
            R: 可接受风险率
            n_years: 使用年限
        
        返回:
            所需重现期
        """
        P = 1 - (1 - R)**(1 / n_years)
        T = 1 / P
        return T
    
    def plot_risk_curves(self, design_periods, life_spans):
        """
        绘制风险曲线
        """
        fig, axes = plt.subplots(1, 2, figsize=(14, 5))
        
        # 1. 不同设计标准下的风险率随使用年限变化
        n_years = np.arange(1, 101)
        
        for T in design_periods:
            P = 1 / T
            R = [self.risk_probability(P, n) for n in n_years]
            axes[0].plot(n_years, np.array(R) * 100, 
                        linewidth=2, label=f'T={T}年')
        
        axes[0].set_xlabel('使用年限 (年)', fontsize=12)
        axes[0].set_ylabel('风险率 (%)', fontsize=12)
        axes[0].set_title('风险率随使用年限变化', fontsize=14)
        axes[0].legend()
        axes[0].grid(True, alpha=0.3)
        
        # 2. 给定使用年限，不同可接受风险下的设计标准
        R_values = np.linspace(0.05, 0.50, 20)
        
        for n in life_spans:
            T_required = [self.return_period_for_risk(R, n) 
                         for R in R_values]
            axes[1].plot(R_values * 100, T_required, 
                        linewidth=2, label=f'寿命={n}年')
        
        axes[1].set_xlabel('可接受风险率 (%)', fontsize=12)
        axes[1].set_ylabel('所需设计标准 (年)', fontsize=12)
        axes[1].set_title('设计标准与风险率关系', fontsize=14)
        axes[1].legend()
        axes[1].grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('flood_risk_curves.png', dpi=300, bbox_inches='tight')
        plt.show()


# 使用示例
print("="*60)
print("洪水风险分析")
print("="*60)

# 年最大流量序列
annual_max_Q = np.array([
    3500, 4200, 3800, 5100, 4600, 3900, 4800, 5500,
    4100, 3700, 4400, 5200, 4700, 3600, 4300, 4900,
    5300, 4000, 4500, 5600, 3800, 4200, 4600, 5000,
    4400, 3900, 4100, 4700, 5100, 4300
])

risk_analysis = FloodRiskAnalysis(annual_max_Q)

print(f"统计特征:")
print(f"  样本数: {risk_analysis.n}")
print(f"  均值: {risk_analysis.mean:.1f} m³/s")
print(f"  标准差: {risk_analysis.std:.1f} m³/s")
print(f"  变差系数: {risk_analysis.cv:.3f}")

# 设计洪水
print(f"\n设计洪水:")
for P in [0.01, 0.02, 0.05, 0.10]:
    T = 1 / P
    Q_P = risk_analysis.design_flood(P)
    print(f"  P={P*100:.0f}% (T={T:.0f}年): {Q_P:.1f} m³/s")

# 风险率计算
print(f"\n风险率分析:")
design_P = 0.01  # 100年一遇
design_T = 1 / design_P

for n_years in [50, 100, 200]:
    R = risk_analysis.risk_probability(design_P, n_years)
    print(f"  设计标准={design_T:.0f}年，使用{n_years}年: "
          f"风险率={R*100:.1f}%")

# 反算设计标准
print(f"\n反算设计标准:")
acceptable_risk = 0.10  # 10%

for life_span in [50, 100]:
    T_required = risk_analysis.return_period_for_risk(
        acceptable_risk, life_span
    )
    print(f"  使用年限={life_span}年，风险率≤{acceptable_risk*100:.0f}%: "
          f"需要T≥{T_required:.0f}年")

# 绘制风险曲线
risk_analysis.plot_risk_curves(
    design_periods=[20, 50, 100, 200],
    life_spans=[50, 100, 200]
)
```

---

## 三、防洪调度

### 3.1 水库防洪调度

**调洪演算**：

入流 - 出流 = 蓄量变化

$$I - Q = \frac{dV}{dt}$$

差分形式：
$$\frac{I_1 + I_2}{2} - \frac{Q_1 + Q_2}{2} = \frac{V_2 - V_1}{\Delta t}$$

### 3.2 防洪库容计算

```python
class FloodControl:
    """
    防洪调度
    """
    
    def __init__(self, flood_control_level, normal_level, 
                 storage_curve):
        """
        参数:
            flood_control_level: 防洪限制水位 (m)
            normal_level: 正常蓄水位 (m)
            storage_curve: 水位-库容关系 [(Z, V), ...]
        """
        self.Z_flood = flood_control_level
        self.Z_normal = normal_level
        
        # 插值水位-库容关系
        Z_vals = [item[0] for item in storage_curve]
        V_vals = [item[1] for item in storage_curve]
        
        from scipy.interpolate import interp1d
        self.Z_to_V = interp1d(Z_vals, V_vals, kind='cubic',
                               fill_value='extrapolate')
        self.V_to_Z = interp1d(V_vals, Z_vals, kind='cubic',
                               fill_value='extrapolate')
    
    def flood_routing(self, inflow, Q_out_max, dt=3600):
        """
        调洪演算
        
        参数:
            inflow: 入流过程 (m³/s)
            Q_out_max: 最大出流 (m³/s)
            dt: 时间步长 (s)
        
        返回:
            水位过程, 出流过程, 库容过程
        """
        n = len(inflow)
        
        # 初始化
        V_flood = float(self.Z_to_V(self.Z_flood))
        V = np.zeros(n)
        Q_out = np.zeros(n)
        Z = np.zeros(n)
        
        V[0] = V_flood
        Z[0] = self.Z_flood
        Q_out[0] = min(inflow[0], Q_out_max)
        
        # 演算
        for i in range(1, n):
            # 水量平衡
            I_avg = (inflow[i-1] + inflow[i]) / 2
            Q_avg = (Q_out[i-1] + Q_out[i-1]) / 2  # 初始估计
            
            V[i] = V[i-1] + (I_avg - Q_avg) * dt
            
            # 约束检查
            Z[i] = float(self.V_to_Z(V[i]))
            
            # 出流规则
            if Z[i] <= self.Z_flood:
                Q_out[i] = min(inflow[i], Q_out_max)
            else:
                # 超过防洪限制水位，加大泄流
                Q_out[i] = Q_out_max
            
            # 修正
            Q_avg_corrected = (Q_out[i-1] + Q_out[i]) / 2
            V[i] = V[i-1] + (I_avg - Q_avg_corrected) * dt
            Z[i] = float(self.V_to_Z(V[i]))
        
        return Z, Q_out, V
    
    def required_flood_capacity(self, design_inflow, Q_out_max):
        """
        所需防洪库容
        
        参数:
            design_inflow: 设计入流过程
            Q_out_max: 允许最大下泄
        
        返回:
            所需防洪库容
        """
        _, _, V_process = self.flood_routing(design_inflow, Q_out_max)
        
        V_flood = float(self.Z_to_V(self.Z_flood))
        V_max = np.max(V_process)
        
        V_required = V_max - V_flood
        
        return V_required


# 防洪调度示例
print("\n" + "="*60)
print("水库防洪调度")
print("="*60)

# 水位-库容关系（示例）
storage_curve = [
    (100, 1.0),
    (110, 5.0),
    (120, 12.0),
    (130, 22.0),
    (140, 35.0)
]

flood_ctrl = FloodControl(
    flood_control_level=120,
    normal_level=130,
    storage_curve=storage_curve
)

# 入流洪水过程（设计洪水）
time_hours = np.arange(0, 48, 2)  # 48小时
inflow_peak = 3000  # m³/s

# 三角形洪水过程
inflow = np.concatenate([
    np.linspace(500, inflow_peak, 12),
    np.linspace(inflow_peak, 800, 12)
])

Q_out_max = 1500  # 最大下泄 (m³/s)

# 调洪演算
Z, Q_out, V = flood_ctrl.flood_routing(inflow, Q_out_max, dt=7200)

print(f"调洪演算结果:")
print(f"  入流洪峰: {np.max(inflow):.0f} m³/s")
print(f"  出流洪峰: {np.max(Q_out):.0f} m³/s")
print(f"  削峰: {(np.max(inflow)-np.max(Q_out))/np.max(inflow)*100:.1f}%")
print(f"  最高水位: {np.max(Z):.2f} m")
print(f"  防洪限制水位: {flood_ctrl.Z_flood} m")

# 可视化
fig, axes = plt.subplots(3, 1, figsize=(12, 10))

# 流量过程
axes[0].plot(time_hours, inflow, 'b-', linewidth=2, label='入流')
axes[0].plot(time_hours, Q_out, 'r-', linewidth=2, label='出流')
axes[0].fill_between(time_hours, 0, inflow, alpha=0.2, color='blue')
axes[0].fill_between(time_hours, 0, Q_out, alpha=0.2, color='red')
axes[0].set_ylabel('流量 (m³/s)', fontsize=12)
axes[0].set_title('调洪演算', fontsize=14)
axes[0].legend()
axes[0].grid(True, alpha=0.3)

# 水位过程
axes[1].plot(time_hours, Z, 'g-', linewidth=2, label='水位')
axes[1].axhline(flood_ctrl.Z_flood, color='orange', linestyle='--',
               linewidth=2, label='防洪限制水位')
axes[1].axhline(flood_ctrl.Z_normal, color='blue', linestyle='--',
               linewidth=2, label='正常蓄水位')
axes[1].fill_between(time_hours, flood_ctrl.Z_flood, Z, 
                     where=(Z >= flood_ctrl.Z_flood),
                     alpha=0.3, color='red', label='超蓄区')
axes[1].set_ylabel('水位 (m)', fontsize=12)
axes[1].set_title('水位过程', fontsize=14)
axes[1].legend()
axes[1].grid(True, alpha=0.3)

# 库容过程
axes[2].plot(time_hours, V, 'purple', linewidth=2)
axes[2].fill_between(time_hours, 0, V, alpha=0.3, color='purple')
axes[2].set_xlabel('时间 (h)', fontsize=12)
axes[2].set_ylabel('库容 (亿m³)', fontsize=12)
axes[2].set_title('库容变化', fontsize=14)
axes[2].grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('flood_control_routing.png', dpi=300, bbox_inches='tight')
plt.show()
```

---

## 四、典型考题

### 考题：风险率计算

**【题目】**（25分）

某工程设计标准50年一遇，使用年限100年。

求：
1. 设计频率
2. 100年内至少发生一次的风险率
3. 若要求风险率≤10%，应提高到多少年

**【解答】**

1. **设计频率**：
   $$P = \frac{1}{T} = \frac{1}{50} = 0.02 = 2\%$$

2. **风险率**：
   $$R = 1 - (1-P)^n = 1 - (1-0.02)^{100}$$
   $$= 1 - 0.98^{100} = 0.867 = 86.7\%$$

3. **反算设计标准**：
   $$P = 1 - (1-R)^{1/n} = 1 - (1-0.10)^{1/100}$$
   $$= 0.00105$$
   
   $$T = \frac{1}{P} = 952 \text{ 年}$$

**答案**：需提高到约**1000年一遇**

---

## 五、高频考点

| 考点 | 公式/方法 | 难度 |
|------|---------|------|
| 风险率 | $R=1-(1-P)^n$ | ⭐⭐⭐ |
| 设计洪水 | Pearson III | ⭐⭐⭐⭐ |
| 调洪演算 | 水量平衡 | ⭐⭐⭐⭐⭐ |
| 防洪库容 | 设计洪水削峰 | ⭐⭐⭐⭐ |

---

**明日预告**: Day 13 - 水库兴利调节

**本日重点**：
- 风险率公式（必考）
- 调洪演算方法
- 防洪库容确定
