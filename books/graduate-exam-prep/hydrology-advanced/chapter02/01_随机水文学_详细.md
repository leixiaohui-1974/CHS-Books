# 第2章：随机水文学

**理论基础**: 随机过程、时间序列分析  
**重要性**: ⭐⭐⭐⭐⭐

---

## 一、水文时间序列

### 1.1 基本概念

**随机过程**：时间的函数族$\{X(t), t \in T\}$

**平稳性**：
- **严平稳**：联合分布不随时间平移改变
- **宽平稳**：均值、方差不变，协方差只依赖时间差

### 1.2 统计特征

**均值函数**：
$$\mu(t) = E[X(t)]$$

**方差函数**：
$$\sigma^2(t) = E[(X(t) - \mu(t))^2]$$

**协方差函数**：
$$C(\tau) = E[(X(t) - \mu)(X(t+\tau) - \mu)]$$

**相关系数**：
$$\rho(\tau) = \frac{C(\tau)}{C(0)} = \frac{C(\tau)}{\sigma^2}$$

---

## 二、自回归模型（AR）

### 2.1 AR(1)模型

$$X_t = \phi_1 X_{t-1} + \varepsilon_t$$

- $\phi_1$：自回归系数
- $\varepsilon_t$：白噪声，$\varepsilon_t \sim N(0, \sigma_{\varepsilon}^2)$

**平稳条件**：$|\phi_1| < 1$

**自相关函数**：
$$\rho(k) = \phi_1^k$$

### 2.2 AR(p)模型

$$X_t = \phi_1 X_{t-1} + \phi_2 X_{t-2} + \cdots + \phi_p X_{t-p} + \varepsilon_t$$

**Yule-Walker方程**求参数。

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.ar_model import AutoReg
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from statsmodels.tsa.stattools import acf, pacf, adfuller

class StochasticHydrology:
    """随机水文学"""
    
    @staticmethod
    def ar1_simulate(phi1, sigma_eps, n=100, X0=0):
        """
        AR(1)模型模拟
        
        X_t = φ₁·X_{t-1} + ε_t
        
        参数:
            phi1: 自回归系数
            sigma_eps: 噪声标准差
            n: 序列长度
            X0: 初值
        
        返回:
            时间序列
        """
        X = np.zeros(n)
        X[0] = X0
        
        eps = np.random.normal(0, sigma_eps, n)
        
        for t in range(1, n):
            X[t] = phi1 * X[t-1] + eps[t]
        
        return X
    
    @staticmethod
    def ar1_properties(phi1, sigma_eps):
        """
        AR(1)模型理论性质
        
        返回:
            均值、方差、自相关函数
        """
        # 均值
        mu = 0
        
        # 方差
        if abs(phi1) < 1:
            var = sigma_eps**2 / (1 - phi1**2)
        else:
            var = np.inf
        
        # 自相关函数
        def rho(k):
            return phi1**k
        
        return mu, var, rho
    
    @staticmethod
    def estimate_ar_parameters(X, max_lag=10):
        """
        估计AR参数
        
        使用Yule-Walker方法
        """
        # 计算自相关系数
        r = acf(X, nlags=max_lag)
        
        # AR(1)估计
        phi1_est = r[1]
        
        # 残差方差估计
        var_X = np.var(X)
        sigma_eps_est = np.sqrt(var_X * (1 - phi1_est**2))
        
        return phi1_est, sigma_eps_est
    
    @staticmethod
    def adf_test(X):
        """
        ADF单位根检验（平稳性检验）
        
        H0: 非平稳（有单位根）
        H1: 平稳
        """
        result = adfuller(X)
        
        adf_stat = result[0]
        p_value = result[1]
        critical_values = result[4]
        
        print("ADF单位根检验:")
        print(f"  ADF统计量: {adf_stat:.4f}")
        print(f"  p值: {p_value:.4f}")
        print(f"  临界值:")
        for key, value in critical_values.items():
            print(f"    {key}: {value:.4f}")
        
        if p_value < 0.05:
            print("  结论: 拒绝原假设，序列平稳 ✓")
        else:
            print("  结论: 不能拒绝原假设，序列可能非平稳")
        
        return adf_stat, p_value
    
    @staticmethod
    def plot_time_series_analysis(X, model_name="时间序列"):
        """时间序列综合分析图"""
        fig, axes = plt.subplots(2, 2, figsize=(14, 10))
        
        # 原序列
        axes[0, 0].plot(X, 'b-', linewidth=1)
        axes[0, 0].set_xlabel('时间', fontsize=12)
        axes[0, 0].set_ylabel('值', fontsize=12)
        axes[0, 0].set_title(f'{model_name}时间序列', fontsize=14)
        axes[0, 0].grid(True, alpha=0.3)
        
        # 直方图
        axes[0, 1].hist(X, bins=30, alpha=0.7, color='green', edgecolor='black')
        axes[0, 1].set_xlabel('值', fontsize=12)
        axes[0, 1].set_ylabel('频数', fontsize=12)
        axes[0, 1].set_title('分布直方图', fontsize=14)
        axes[0, 1].grid(True, alpha=0.3, axis='y')
        
        # 自相关函数
        plot_acf(X, lags=40, ax=axes[1, 0])
        axes[1, 0].set_title('自相关函数(ACF)', fontsize=14)
        
        # 偏自相关函数
        plot_pacf(X, lags=40, ax=axes[1, 1])
        axes[1, 1].set_title('偏自相关函数(PACF)', fontsize=14)
        
        plt.tight_layout()
        plt.savefig('time_series_analysis.png', dpi=300)
        plt.show()

# 示例1：AR(1)模拟
print("="*60)
print("示例1：AR(1)模型模拟与分析")
print("="*60)

# 参数
phi1 = 0.7
sigma_eps = 1.0
n = 500

print(f"模型参数:")
print(f"  φ₁ = {phi1}")
print(f"  σ_ε = {sigma_eps}")

# 理论性质
mu, var, rho = StochasticHydrology.ar1_properties(phi1, sigma_eps)

print(f"\n理论性质:")
print(f"  均值 μ = {mu}")
print(f"  方差 σ² = {var:.4f}")
print(f"  标准差 σ = {np.sqrt(var):.4f}")
print(f"  ρ(1) = {rho(1):.4f}")
print(f"  ρ(5) = {rho(5):.4f}")

# 模拟
X = StochasticHydrology.ar1_simulate(phi1, sigma_eps, n)

print(f"\n模拟序列统计:")
print(f"  样本均值 = {np.mean(X):.4f}")
print(f"  样本方差 = {np.var(X):.4f}")
print(f"  样本标准差 = {np.std(X):.4f}")

# 参数估计
phi1_est, sigma_eps_est = StochasticHydrology.estimate_ar_parameters(X)

print(f"\n参数估计:")
print(f"  φ₁估计值 = {phi1_est:.4f} (真值: {phi1})")
print(f"  σ_ε估计值 = {sigma_eps_est:.4f} (真值: {sigma_eps})")

# 平稳性检验
print(f"\n平稳性检验:")
StochasticHydrology.adf_test(X)

# 可视化
StochasticHydrology.plot_time_series_analysis(X, "AR(1)")

# 示例2：不同φ₁的对比
print("\n" + "="*60)
print("示例2：不同自回归系数的影响")
print("="*60)

phi_values = [0.3, 0.6, 0.9, -0.5]

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

for idx, phi in enumerate(phi_values):
    X_sim = StochasticHydrology.ar1_simulate(phi, 1.0, 300)
    
    ax = axes[idx // 2, idx % 2]
    ax.plot(X_sim, 'b-', linewidth=1)
    ax.set_xlabel('时间', fontsize=11)
    ax.set_ylabel('值', fontsize=11)
    ax.set_title(f'AR(1): φ₁={phi}', fontsize=13)
    ax.grid(True, alpha=0.3)
    
    # 添加统计信息
    mu_sim = np.mean(X_sim)
    std_sim = np.std(X_sim)
    ax.text(0.02, 0.98, f'均值: {mu_sim:.2f}\n标差: {std_sim:.2f}',
           transform=ax.transAxes, va='top', fontsize=10,
           bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

plt.tight_layout()
plt.savefig('ar1_comparison.png', dpi=300)
plt.show()
```

---

## 三、移动平均模型（MA）

### 3.1 MA(1)模型

$$X_t = \varepsilon_t + \theta_1 \varepsilon_{t-1}$$

**自相关函数**：
$$\rho(1) = \frac{\theta_1}{1 + \theta_1^2}, \quad \rho(k) = 0 \, (k > 1)$$

### 3.2 MA(q)模型

$$X_t = \varepsilon_t + \theta_1 \varepsilon_{t-1} + \cdots + \theta_q \varepsilon_{t-q}$$

---

## 四、ARMA模型

### 4.1 ARMA(p,q)

$$X_t = \phi_1 X_{t-1} + \cdots + \phi_p X_{t-p} + \varepsilon_t + \theta_1 \varepsilon_{t-1} + \cdots + \theta_q \varepsilon_{t-q}$$

### 4.2 模型识别

**ACF与PACF**：
- AR(p)：ACF拖尾，PACF截尾（p阶后为0）
- MA(q)：ACF截尾，PACF拖尾
- ARMA(p,q)：ACF、PACF均拖尾

### 4.3 模型选择

**AIC准则**（Akaike）：
$$AIC = -2\ln L + 2k$$

**BIC准则**（Bayesian）：
$$BIC = -2\ln L + k\ln n$$

$k$：参数个数，$n$：样本量，选AIC/BIC最小的模型。

---

## 五、水文预报应用

### 5.1 径流预报

**自回归预报**：
$$\hat{Q}_{t+1} = \phi_1 Q_t + \phi_2 Q_{t-1} + \cdots$$

### 5.2 长期记忆

**Hurst指数**$H$：
- $H > 0.5$：持续性（正相关）
- $H = 0.5$：随机游走
- $H < 0.5$：反持续性

---

## 六、典型考题

### 【例题】AR(1)参数估计

**题目**：年径流序列，样本方差$s^2=100$，滞后1阶自相关系数$r_1=0.6$，估计AR(1)模型参数。

**解**：

$$\hat{\phi}_1 = r_1 = 0.6$$

$$\hat{\sigma}_{\varepsilon}^2 = s^2(1 - r_1^2) = 100 \times (1 - 0.6^2) = 64$$

$$\hat{\sigma}_{\varepsilon} = 8$$

---

**本章重点**：
- 平稳性概念
- AR模型原理
- 参数估计
- ACF/PACF识别
- 水文预报应用
