# 第7章：水文预报方法

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、水文预报概述

### 1.1 基本概念

**水文预报**：根据已知信息预测未来水文要素的时空变化

**预报类型**：
- 水位预报
- 流量预报
- 水量预报（洪量、径流量）

**预见期**：
- 短期预报：1~3天
- 中期预报：3~7天
- 长期预报：>7天

### 1.2 预报方法分类

**(1) 按原理**：
- 成因分析法（降雨径流关系）
- 相关分析法（统计相关）
- 水力学法（水力学方程）

**(2) 按预报对象**：
- 洪水预报
- 枯水预报
- 径流预报

---

## 二、流域汇流

### 2.1 等流时线法

**原理**：流域划分为等流时线圈

**汇流时间**：

$$\tau = \frac{L}{v}$$

**流量过程**：

$$Q(t) = \sum_{i=1}^n R_i(t) \cdot F_i$$

**参数**：
- $R_i(t)$：第$i$圈净雨强
- $F_i$：第$i$圈面积

### 2.2 单位线法

**定义**：单位时段单位净雨在出口断面产生的地表径流过程线

**基本假定**：
1. 线性：$Q_t = \sum P_i \cdot U_{t-i}$
2. 时不变性：单位线形状不变
3. 叠加性：大雨过程可分解叠加

**单位线推求**：

$$U_j = \frac{Q_j}{\sum P_i} \quad (j = 1,2,\ldots,m)$$

### 2.3 瞬时单位线

**S曲线法**：

$$U(t) = \frac{dS(t)}{dt}$$

其中$S(t)$为S曲线（无限个单位线叠加）

**Nash模型**：

$$u(t,\tau) = \frac{1}{K\Gamma(n)}(\frac{t}{K})^{n-1}e^{-t/K}$$

---

## 三、河道汇流

### 3.1 水文学法

**马斯京根法**（Muskingum）：

$$\frac{dS}{dt} = I(t) - Q(t)$$

$$S = K[xI + (1-x)Q]$$

**离散化**：

$$Q_{j+1} = C_0 I_{j+1} + C_1 I_j + C_2 Q_j$$

**系数**：

$$C_0 = \frac{-Kx + 0.5\Delta t}{K(1-x) + 0.5\Delta t}$$

$$C_1 = \frac{Kx + 0.5\Delta t}{K(1-x) + 0.5\Delta t}$$

$$C_2 = \frac{K(1-x) - 0.5\Delta t}{K(1-x) + 0.5\Delta t}$$

约束：$C_0 + C_1 + C_2 = 1$

### 3.2 水力学法

**圣维南方程组**：

**连续方程**：

$$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = 0$$

**动量方程**：

$$\frac{\partial Q}{\partial t} + \frac{\partial}{\partial x}\left(\frac{Q^2}{A}\right) + gA\frac{\partial h}{\partial x} + gAS_f = 0$$

**简化模型**：
- 运动波：$S_0 = S_f$
- 扩散波：忽略惯性项
- 动力波：完整方程

---

## 四、降雨径流相关

### 4.1 产流计算

**蓄满产流**：

$$R = \begin{cases}
0, & P < W_m \\
P - W_m, & P \geq W_m
\end{cases}$$

**超渗产流**：

$$R = \int_0^t [i(\tau) - f(\tau)]d\tau$$

**霍顿下渗公式**：

$$f(t) = f_c + (f_0 - f_c)e^{-kt}$$

### 4.2 损失模型

**初损后损模型**：

$$R = \begin{cases}
0, & P < I_0 \\
\mu(P - I_0), & P \geq I_0
\end{cases}$$

**参数**：
- $I_0$：初损（mm）
- $\mu$：产流系数

---

## 五、相关分析法

### 5.1 水位流量关系

**单值关系**：

$$Q = a(H - H_0)^b$$

**绳套关系**：
- 涨水段
- 落水段

### 5.2 流量相关

**上下游站**：

$$Q_2(t+\tau) = a + b Q_1(t)$$

**参数估计**：最小二乘法

---

## 六、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import minimize
from scipy.interpolate import interp1d

class HydrologicalForecast:
    """水文预报方法"""
    
    def __init__(self):
        pass
    
    def unit_hydrograph_derive(self, P, Q_total, dt):
        """
        单位线推求
        
        参数:
            P: 各时段净雨（mm）
            Q_total: 总流量过程（m³/s）
            dt: 时段（h）
        
        返回: 单位线
        """
        # 基流分割（简化：取最小值）
        Q_base = np.min(Q_total)
        Q_direct = Q_total - Q_base
        
        # 总净雨量
        P_sum = np.sum(P)
        
        # 单位线（单位净雨产生的流量过程）
        U = Q_direct / P_sum
        
        return U
    
    def unit_hydrograph_convolution(self, P, U, dt):
        """
        单位线卷积（计算流量过程）
        
        Q(t) = Σ P_i · U(t-i)
        
        参数:
            P: 净雨过程（mm）
            U: 单位线（m³/s/mm）
            dt: 时段（h）
        """
        n_P = len(P)
        n_U = len(U)
        n_Q = n_P + n_U - 1
        
        Q = np.zeros(n_Q)
        
        for i in range(n_P):
            for j in range(n_U):
                if i + j < n_Q:
                    Q[i + j] += P[i] * U[j]
        
        return Q
    
    def muskingum_routing(self, I, K, x, dt):
        """
        马斯京根法河道汇流
        
        参数:
            I: 入流过程（m³/s）
            K: 滞时参数（h）
            x: 比重系数（0~0.5）
            dt: 时段（h）
        
        返回: 出流过程Q
        """
        n = len(I)
        Q = np.zeros(n)
        Q[0] = I[0]  # 初始条件
        
        # 计算系数
        C0 = (-K * x + 0.5 * dt) / (K * (1 - x) + 0.5 * dt)
        C1 = (K * x + 0.5 * dt) / (K * (1 - x) + 0.5 * dt)
        C2 = (K * (1 - x) - 0.5 * dt) / (K * (1 - x) + 0.5 * dt)
        
        # 递推计算
        for j in range(n - 1):
            Q[j + 1] = C0 * I[j + 1] + C1 * I[j] + C2 * Q[j]
        
        return Q, (C0, C1, C2)
    
    def calibrate_muskingum(self, I, Q_obs, dt, K_init=5, x_init=0.2):
        """
        马斯京根参数率定
        
        目标：最小化 Σ(Q_calc - Q_obs)²
        """
        def objective(params):
            K, x = params
            
            # 约束
            if K <= 0 or x < 0 or x > 0.5:
                return 1e10
            
            Q_calc, _ = self.muskingum_routing(I, K, x, dt)
            
            # 截取有效长度
            n_min = min(len(Q_calc), len(Q_obs))
            
            # 均方误差
            mse = np.sum((Q_calc[:n_min] - Q_obs[:n_min])**2)
            
            return mse
        
        # 优化
        result = minimize(objective, [K_init, x_init],
                         bounds=[(0.1, 50), (0, 0.5)],
                         method='L-BFGS-B')
        
        K_opt, x_opt = result.x
        Q_opt, coefs = self.muskingum_routing(I, K_opt, x_opt, dt)
        
        return K_opt, x_opt, Q_opt
    
    def rating_curve(self, H, a, b, H0):
        """
        水位流量关系（单值）
        
        Q = a(H - H0)^b
        """
        Q = a * (H - H0)**b
        return Q
    
    def rating_curve_fit(self, H_obs, Q_obs):
        """
        水位流量关系拟合
        """
        def objective(params):
            a, b, H0 = params
            Q_calc = self.rating_curve(H_obs, a, b, H0)
            return np.sum((Q_calc - Q_obs)**2)
        
        # 初值
        H0_init = np.min(H_obs) - 0.5
        a_init = 50
        b_init = 2
        
        result = minimize(objective, [a_init, b_init, H0_init],
                         bounds=[(1, 1000), (1, 3), (None, np.min(H_obs))],
                         method='L-BFGS-B')
        
        a_opt, b_opt, H0_opt = result.x
        
        return a_opt, b_opt, H0_opt
    
    def plot_hydrological_forecast(self):
        """绘制水文预报方法图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. 单位线与卷积
        ax1 = axes[0, 0]
        
        # 单位线（三角形）
        t_U = np.arange(0, 25, 1)
        U = np.zeros_like(t_U, dtype=float)
        U[0:8] = np.linspace(0, 50, 8)
        U[8:25] = np.linspace(50, 0, 17)
        
        # 净雨过程
        P = np.array([10, 20, 15, 5, 0])
        dt = 1
        
        # 卷积
        Q_direct = self.unit_hydrograph_convolution(P, U, dt)
        t_Q = np.arange(len(Q_direct)) * dt
        
        # 绘制
        ax1_twin = ax1.twinx()
        
        ax1.plot(t_U, U, 'b-', linewidth=2.5, label='单位线U(t)')
        
        # 净雨柱状图
        for i, p in enumerate(P):
            ax1_twin.bar(i, p, width=0.8, alpha=0.6, color='green',
                        edgecolor='black', linewidth=1.5)
        
        ax1.plot(t_Q, Q_direct, 'r-', linewidth=2.5, label='地表径流Q(t)')
        
        ax1.set_xlabel('时间 t (h)', fontsize=11)
        ax1.set_ylabel('流量 Q (m³/s)', fontsize=11, color='blue')
        ax1_twin.set_ylabel('净雨 P (mm)', fontsize=11, color='green')
        ax1.set_title('单位线法：净雨→流量过程', fontsize=13, fontweight='bold')
        ax1.legend(loc='upper left')
        ax1.grid(True, alpha=0.3)
        
        # 2. 马斯京根河道汇流
        ax2 = axes[0, 1]
        
        # 入流过程（洪水过程）
        t_I = np.arange(0, 48, 1)
        I = 500 + 2000 * np.exp(-((t_I - 12)**2) / 50)
        
        # 不同参数的汇流结果
        K_values = [3, 6, 10]
        x = 0.2
        dt_route = 1
        
        ax2.plot(t_I, I, 'b-', linewidth=3, label='入流I(t)', alpha=0.7)
        
        colors_K = ['orange', 'red', 'purple']
        
        for K, color in zip(K_values, colors_K):
            Q, coefs = self.muskingum_routing(I, K, x, dt_route)
            t_Q = np.arange(len(Q)) * dt_route
            
            ax2.plot(t_Q, Q, color=color, linewidth=2.5,
                    label=f'出流Q(t), K={K}h')
        
        ax2.set_xlabel('时间 t (h)', fontsize=11)
        ax2.set_ylabel('流量 Q (m³/s)', fontsize=11)
        ax2.set_title(f'马斯京根河道汇流（x={x}）', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        # 3. 水位流量关系
        ax3 = axes[1, 0]
        
        # 模拟数据
        H_data = np.array([10.0, 10.5, 11.0, 11.5, 12.0, 12.5, 13.0, 13.5, 14.0])
        Q_data = np.array([100, 180, 280, 400, 550, 730, 950, 1200, 1500])
        
        # 拟合
        a_fit, b_fit, H0_fit = self.rating_curve_fit(H_data, Q_data)
        
        # 绘制
        ax3.scatter(H_data, Q_data, s=100, alpha=0.7, color='blue',
                   edgecolors='black', linewidth=1.5, label='实测点据', zorder=3)
        
        H_curve = np.linspace(H_data.min(), H_data.max(), 100)
        Q_curve = self.rating_curve(H_curve, a_fit, b_fit, H0_fit)
        
        ax3.plot(H_curve, Q_curve, 'r-', linewidth=2.5,
                label=f'拟合曲线\nQ={a_fit:.1f}(H-{H0_fit:.2f})^{b_fit:.2f}')
        
        ax3.set_xlabel('水位 H (m)', fontsize=11)
        ax3.set_ylabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_title('水位流量关系（单值曲线）', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. 参数敏感性分析（马斯京根）
        ax4 = axes[1, 1]
        
        # 固定K，变化x
        K_fixed = 6
        x_values = [0, 0.2, 0.4]
        
        ax4.plot(t_I, I, 'b--', linewidth=2, label='入流I(t)', alpha=0.7)
        
        colors_x = ['green', 'orange', 'red']
        
        for x_val, color in zip(x_values, colors_x):
            Q, _ = self.muskingum_routing(I, K_fixed, x_val, dt_route)
            t_Q = np.arange(len(Q)) * dt_route
            
            # 计算峰现时差
            t_peak_I = t_I[np.argmax(I)]
            t_peak_Q = t_Q[np.argmax(Q)]
            lag = t_peak_Q - t_peak_I
            
            ax4.plot(t_Q, Q, color=color, linewidth=2.5,
                    label=f'x={x_val}, 滞时={lag:.1f}h')
        
        ax4.set_xlabel('时间 t (h)', fontsize=11)
        ax4.set_ylabel('流量 Q (m³/s)', fontsize=11)
        ax4.set_title(f'比重系数x的影响（K={K_fixed}h）', fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('hydrological_forecast.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("水文预报方法")
print("="*60)

hf = HydrologicalForecast()

# 1. 单位线推求
print("1. 单位线推求:")
print("  已知净雨过程和地表径流过程\n")

P_net = np.array([15, 10, 5])  # mm
Q_obs = np.array([0, 50, 120, 150, 130, 100, 70, 40, 20, 10, 5])  # m³/s
dt = 1  # h

U_derived = hf.unit_hydrograph_derive(P_net, Q_obs, dt)

print(f"  净雨: {P_net}")
print(f"  单位线U(t):")
for i, u in enumerate(U_derived):
    if u > 0.1:
        print(f"    t={i}h: {u:.2f} m³/s/mm")

# 2. 单位线卷积预报
print("\n" + "="*60)
print("2. 单位线法流量预报:")

P_forecast = np.array([20, 25, 15, 8])  # mm
Q_forecast = hf.unit_hydrograph_convolution(P_forecast, U_derived, dt)

print(f"  预报净雨: {P_forecast}")
print(f"  预报流量过程:")
for i, q in enumerate(Q_forecast):
    if q > 1:
        print(f"    t={i}h: {q:.1f} m³/s")

# 3. 马斯京根河道汇流
print("\n" + "="*60)
print("3. 马斯京根河道汇流:")

# 入流过程
t_route = np.arange(0, 24, 1)
I_route = 300 + 1500 * np.exp(-((t_route - 8)**2) / 20)

K_route = 5  # h
x_route = 0.25
dt_route = 1  # h

Q_route, coefs = hf.muskingum_routing(I_route, K_route, x_route, dt_route)

print(f"  参数: K={K_route}h, x={x_route}, Δt={dt_route}h")
print(f"  系数: C0={coefs[0]:.3f}, C1={coefs[1]:.3f}, C2={coefs[2]:.3f}")
print(f"  校核: C0+C1+C2={sum(coefs):.3f}")

# 洪峰对比
Qp_I = np.max(I_route)
Qp_Q = np.max(Q_route)
t_peak_I = t_route[np.argmax(I_route)]
t_peak_Q = t_route[np.argmax(Q_route)]

print(f"\n  入流洪峰: {Qp_I:.0f} m³/s，出现时间: {t_peak_I}h")
print(f"  出流洪峰: {Qp_Q:.0f} m³/s，出现时间: {t_peak_Q}h")
print(f"  洪峰削减: {(1 - Qp_Q/Qp_I)*100:.1f}%")
print(f"  峰现时差: {t_peak_Q - t_peak_I:.1f}h")

# 4. 水位流量关系
print("\n" + "="*60)
print("4. 水位流量关系拟合:")

H_obs = np.array([12.0, 12.5, 13.0, 13.5, 14.0, 14.5, 15.0])
Q_obs = np.array([250, 380, 540, 730, 960, 1230, 1550])

a, b, H0 = hf.rating_curve_fit(H_obs, Q_obs)

print(f"  拟合公式: Q = {a:.1f}(H - {H0:.2f})^{b:.2f}")

# 预报示例
H_forecast = 14.8
Q_forecast = hf.rating_curve(H_forecast, a, b, H0)

print(f"\n  水位预报: H = {H_forecast}m")
print(f"  流量预报: Q = {Q_forecast:.0f} m³/s")

# 绘图
print("\n绘制水文预报方法图...")
hf.plot_hydrological_forecast()
```

---

## 七、典型考题

### 【例题1】马斯京根参数计算（12分）

**题目**：马斯京根法，$K=6$h，$x=0.2$，$\Delta t=2$h。计算演算系数。

**【解答】**

$$C_0 = \frac{-Kx + 0.5\Delta t}{K(1-x) + 0.5\Delta t} = \frac{-6 \times 0.2 + 0.5 \times 2}{6 \times 0.8 + 0.5 \times 2}$$

$$= \frac{-1.2 + 1}{4.8 + 1} = \frac{-0.2}{5.8} = -0.034$$

$$C_1 = \frac{Kx + 0.5\Delta t}{K(1-x) + 0.5\Delta t} = \frac{1.2 + 1}{5.8} = 0.379$$

$$C_2 = \frac{K(1-x) - 0.5\Delta t}{K(1-x) + 0.5\Delta t} = \frac{4.8 - 1}{5.8} = 0.655$$

校核：$C_0 + C_1 + C_2 = -0.034 + 0.379 + 0.655 = 1.000$ ✓

---

**本章重点**：
- 单位线法
- 马斯京根河道汇流
- 水位流量关系
- 相关分析法

**下一章**：水文统计分析
