# 第4章：水文预报

**应用**: 洪水预警、水库调度  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、水文预报基本概念

### 1.1 分类

**按预见期**：
- 短期预报：1-3天
- 中期预报：4-10天
- 长期预报：>10天

**按要素**：
- 水位预报
- 流量预报
- 洪峰预报

**按方法**：
- 成因预报：产汇流模型
- 相关预报：经验关系
- 实时校正：卡尔曼滤波

### 1.2 精度指标

**确定性系数**（Nash-Sutcliffe）：
$$NSE = 1 - \frac{\sum(Q_{obs} - Q_{sim})^2}{\sum(Q_{obs} - \bar{Q}_{obs})^2}$$

- NSE > 0.9：优秀
- NSE > 0.7：良好
- NSE > 0.5：合格

**相对误差**：
$$RE = \frac{Q_{sim} - Q_{obs}}{Q_{obs}} \times 100\%$$

**峰现时间误差**：
$$\Delta T = T_{sim} - T_{obs}$$

---

## 二、流域产流预报

### 2.1 蓄满产流模型

**新安江模型三水源划分**：

**包气带蓄水容量**：
$$W_M = W_{UM} + W_{LM} + W_{DM}$$

**产流条件**：
$$PE + A = W_M$$

**径流深**：
$$R = PE + A - W_M + W$$

### 2.2 超渗产流模型

**Horton下渗公式**：
$$f_t = f_c + (f_0 - f_c)e^{-kt}$$

**产流**：$i > f_t$时产流

### Python实现

```python
import numpy as np
import matplotlib.pyplot as plt

class HydrologicForecasting:
    """水文预报"""
    
    def __init__(self):
        pass
    
    def xinanjiang_runoff(self, P, E, W0, WM, B, IM):
        """
        新安江模型产流计算
        
        参数:
            P: 时段降雨 (mm)
            E: 时段蒸发 (mm)
            W0: 初始土壤含水量 (mm)
            WM: 流域平均蓄水容量 (mm)
            B: 蓄水容量曲线指数
            IM: 不透水面积比例
        
        返回:
            R: 径流深 (mm)
            W1: 最终土壤含水量 (mm)
        """
        # 净雨
        PE = max(0, P - E)
        
        # 流域蓄水容量分布
        # f = 1 - (1 - W/WM)^B
        
        # 初始张力水蓄量
        A = WM * (1 - (1 - W0/WM)**(1/(1+B)))
        
        # 产流计算
        if PE + A < WM:
            # 未产流或部分产流
            R = PE - WM + W0 + WM * (1 - (PE + A)/WM)**(1+B)
            W1 = W0 + P - E - R
        else:
            # 蓄满产流
            R = PE - (WM - W0)
            W1 = WM
        
        # 不透水面积产流
        R_total = R + IM * PE
        
        return max(0, R_total), W1
    
    def unit_hydrograph_convolution(self, rainfall, UH):
        """
        单位线卷积
        
        Q(t) = Σ P(i)·UH(t-i)
        
        参数:
            rainfall: 时段净雨序列 (mm)
            UH: 单位线 (m³/s/mm)
        
        返回:
            Q: 流量过程 (m³/s)
        """
        n_rain = len(rainfall)
        n_UH = len(UH)
        n_Q = n_rain + n_UH - 1
        
        Q = np.zeros(n_Q)
        
        for i in range(n_rain):
            for j in range(n_UH):
                Q[i+j] += rainfall[i] * UH[j]
        
        return Q
    
    def muskingum_routing(self, I, K, X, dt):
        """
        马斯京根法河道汇流
        
        S = K[X·I + (1-X)·Q]
        
        参数:
            I: 入流过程 (m³/s)
            K: 蓄量常数 (h)
            X: 流量比重因数 (0-0.5)
            dt: 时段长 (h)
        
        返回:
            Q: 出流过程 (m³/s)
        """
        # 马斯京根系数
        C0 = (-K*X + 0.5*dt) / (K - K*X + 0.5*dt)
        C1 = (K*X + 0.5*dt) / (K - K*X + 0.5*dt)
        C2 = (K - K*X - 0.5*dt) / (K - K*X + 0.5*dt)
        
        # 检查稳定性
        if C0 < 0 or C1 < 0 or C2 < 0:
            print("警告: 马斯京根系数出现负值，计算可能不稳定")
        
        n = len(I)
        Q = np.zeros(n)
        
        # 初值
        Q[0] = I[0]
        
        # 递推
        for i in range(1, n):
            Q[i] = C0*I[i] + C1*I[i-1] + C2*Q[i-1]
        
        return Q
    
    def real_time_correction_kalman(self, Q_forecast, Q_obs, P, Q_variance, R_variance):
        """
        卡尔曼滤波实时校正
        
        参数:
            Q_forecast: 预报流量 (m³/s)
            Q_obs: 实测流量 (m³/s)
            P: 预测误差方差
            Q_variance: 过程噪声方差
            R_variance: 观测噪声方差
        
        返回:
            Q_corrected: 校正后流量 (m³/s)
            P_new: 更新后误差方差
        """
        # 预测更新
        P_pred = P + Q_variance
        
        # 卡尔曼增益
        K = P_pred / (P_pred + R_variance)
        
        # 状态更新
        Q_corrected = Q_forecast + K * (Q_obs - Q_forecast)
        
        # 误差方差更新
        P_new = (1 - K) * P_pred
        
        return Q_corrected, P_new
    
    def forecast_accuracy(self, Q_obs, Q_sim):
        """
        预报精度评估
        
        参数:
            Q_obs: 实测流量序列 (m³/s)
            Q_sim: 预报流量序列 (m³/s)
        
        返回:
            NSE: 确定性系数
            RMSE: 均方根误差
            MAE: 平均绝对误差
            peak_error: 洪峰误差
            time_error: 峰现时间误差
        """
        # Nash-Sutcliffe系数
        numerator = np.sum((Q_obs - Q_sim)**2)
        denominator = np.sum((Q_obs - np.mean(Q_obs))**2)
        NSE = 1 - numerator / denominator
        
        # RMSE
        RMSE = np.sqrt(np.mean((Q_obs - Q_sim)**2))
        
        # MAE
        MAE = np.mean(np.abs(Q_obs - Q_sim))
        
        # 洪峰误差
        peak_obs = np.max(Q_obs)
        peak_sim = np.max(Q_sim)
        peak_error = (peak_sim - peak_obs) / peak_obs * 100
        
        # 峰现时间误差
        idx_obs = np.argmax(Q_obs)
        idx_sim = np.argmax(Q_sim)
        time_error = idx_sim - idx_obs
        
        return {
            'NSE': NSE,
            'RMSE': RMSE,
            'MAE': MAE,
            'peak_error': peak_error,
            'time_error': time_error
        }
    
    def plot_forecast_comparison(self, t, Q_obs, Q_sim, title="洪水预报对比"):
        """绘制预报对比图"""
        fig, axes = plt.subplots(2, 1, figsize=(14, 10))
        
        # (a) 流量过程线对比
        axes[0].plot(t, Q_obs, 'b-', linewidth=2.5, label='实测')
        axes[0].plot(t, Q_sim, 'r--', linewidth=2, label='预报')
        
        # 洪峰标注
        idx_obs = np.argmax(Q_obs)
        idx_sim = np.argmax(Q_sim)
        
        axes[0].plot(t[idx_obs], Q_obs[idx_obs], 'bo', markersize=12)
        axes[0].text(t[idx_obs], Q_obs[idx_obs]+100, 
                    f'实测洪峰\n{Q_obs[idx_obs]:.0f}m³/s\nT={t[idx_obs]:.0f}h',
                    ha='center', fontsize=10)
        
        axes[0].plot(t[idx_sim], Q_sim[idx_sim], 'ro', markersize=12)
        axes[0].text(t[idx_sim], Q_sim[idx_sim]-200,
                    f'预报洪峰\n{Q_sim[idx_sim]:.0f}m³/s\nT={t[idx_sim]:.0f}h',
                    ha='center', fontsize=10)
        
        axes[0].set_xlabel('时间 (h)', fontsize=12)
        axes[0].set_ylabel('流量 (m³/s)', fontsize=12)
        axes[0].set_title(title, fontsize=14)
        axes[0].legend(loc='upper right')
        axes[0].grid(True, alpha=0.3)
        
        # (b) 误差分析
        error = Q_sim - Q_obs
        
        axes[1].plot(t, error, 'g-', linewidth=2)
        axes[1].axhline(0, color='k', linestyle='--', linewidth=1)
        axes[1].fill_between(t, 0, error, alpha=0.3, color='green')
        
        axes[1].set_xlabel('时间 (h)', fontsize=12)
        axes[1].set_ylabel('误差 (m³/s)', fontsize=12)
        axes[1].set_title('预报误差', fontsize=14)
        axes[1].grid(True, alpha=0.3)
        
        # 精度统计
        accuracy = self.forecast_accuracy(Q_obs, Q_sim)
        
        textstr = f"NSE = {accuracy['NSE']:.3f}\n"
        textstr += f"RMSE = {accuracy['RMSE']:.1f} m³/s\n"
        textstr += f"洪峰误差 = {accuracy['peak_error']:.1f}%\n"
        textstr += f"峰现时间误差 = {accuracy['time_error']:.0f}Δt"
        
        axes[1].text(0.02, 0.98, textstr, transform=axes[1].transAxes,
                    fontsize=11, verticalalignment='top',
                    bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8))
        
        plt.tight_layout()
        plt.savefig('hydrologic_forecast_comparison.png', dpi=300)
        plt.show()

# 示例1：新安江模型产流预报
print("="*60)
print("示例1：新安江模型产流计算")
print("="*60)

hf = HydrologicForecasting()

# 模型参数
WM = 120  # 流域平均蓄水容量 (mm)
B = 0.4   # 蓄水容量曲线指数
IM = 0.01  # 不透水面积比例

print(f"模型参数:")
print(f"  蓄水容量 WM = {WM} mm")
print(f"  指数 B = {B}")
print(f"  不透水面积比 IM = {IM}")

# 初始条件
W0 = 80  # 初始土壤含水量 (mm)

print(f"\n初始条件:")
print(f"  初始土壤含水量 W₀ = {W0} mm")

# 暴雨过程（简化为3个时段）
rainfall = [10, 50, 30]  # mm
evaporation = [2, 2, 2]  # mm

print(f"\n降雨蒸发过程:")
print(f"{'时段':>6s} {'降雨P(mm)':>12s} {'蒸发E(mm)':>12s} {'径流R(mm)':>12s} {'土壤水W(mm)':>15s}")
print("-" * 65)

W = W0
R_total_list = []

for i, (P, E) in enumerate(zip(rainfall, evaporation), 1):
    R, W = hf.xinanjiang_runoff(P, E, W, WM, B, IM)
    R_total_list.append(R)
    
    print(f"{i:6d} {P:12.1f} {E:12.1f} {R:12.2f} {W:15.1f}")

print(f"\n累计径流深: {sum(R_total_list):.2f} mm")

# 示例2：单位线卷积
print("\n" + "="*60)
print("示例2：单位线卷积法流量预报")
print("="*60)

# 单位线（1小时单位线，持续6小时）
UH = np.array([10, 40, 80, 60, 30, 15])  # m³/s/mm

print(f"单位线:")
print(f"  {UH}")

# 净雨（转换为mm）
net_rainfall = np.array(R_total_list)

print(f"\n净雨序列:")
print(f"  {net_rainfall}")

# 卷积
Q = hf.unit_hydrograph_convolution(net_rainfall, UH)

print(f"\n流量过程:")
for i, q in enumerate(Q):
    print(f"  时段{i+1}: {q:.1f} m³/s")

print(f"\n洪峰流量: {np.max(Q):.1f} m³/s")
print(f"峰现时间: 第{np.argmax(Q)+1}时段")

# 示例3：马斯京根河道汇流
print("\n" + "="*60)
print("示例3：马斯京根法河道汇流")
print("="*60)

# 上游入流
I = np.array([100, 200, 500, 800, 600, 400, 250, 150, 100])  # m³/s

# 河道参数
K = 2.0  # 蓄量常数 (h)
X = 0.2  # 流量比重
dt = 1.0  # 时段 (h)

print(f"河道参数:")
print(f"  蓄量常数 K = {K} h")
print(f"  流量比重 X = {X}")
print(f"  时段长度 Δt = {dt} h")

# 汇流计算
Q_out = hf.muskingum_routing(I, K, X, dt)

print(f"\n{'时段':>6s} {'入流I(m³/s)':>15s} {'出流Q(m³/s)':>15s}")
print("-" * 40)

for i, (inflow, outflow) in enumerate(zip(I, Q_out), 1):
    print(f"{i:6d} {inflow:15.1f} {outflow:15.1f}")

print(f"\n削峰: {(np.max(I) - np.max(Q_out))/np.max(I)*100:.1f}%")
print(f"滞时: {np.argmax(Q_out) - np.argmax(I)} 时段")

# 示例4：预报精度评估
print("\n" + "="*60)
print("示例4：洪水预报精度评估")
print("="*60)

# 模拟数据
t = np.arange(0, 48, 1)  # 48小时

# 实测流量
Q_obs = 500 + 1500*np.exp(-((t-20)**2)/(2*5**2))

# 预报流量（有误差）
Q_sim = 500 + 1400*np.exp(-((t-21)**2)/(2*5.5**2))

# 精度评估
accuracy = hf.forecast_accuracy(Q_obs, Q_sim)

print(f"预报精度:")
print(f"  确定性系数 NSE = {accuracy['NSE']:.3f}")
print(f"  均方根误差 RMSE = {accuracy['RMSE']:.1f} m³/s")
print(f"  平均绝对误差 MAE = {accuracy['MAE']:.1f} m³/s")
print(f"  洪峰相对误差 = {accuracy['peak_error']:.1f}%")
print(f"  峰现时间误差 = {accuracy['time_error']} 小时")

# 精度等级判定
if accuracy['NSE'] > 0.9:
    grade = '优秀'
elif accuracy['NSE'] > 0.7:
    grade = '良好'
elif accuracy['NSE'] > 0.5:
    grade = '合格'
else:
    grade = '不合格'

print(f"\n预报等级: {grade}")

# 绘制对比图
hf.plot_forecast_comparison(t, Q_obs, Q_sim)
```

---

## 三、实时校正

### 3.1 误差自回归（AR）

$$e_t = \rho_1 e_{t-1} + \rho_2 e_{t-2} + \varepsilon_t$$

### 3.2 卡尔曼滤波

**状态方程**：
$$x_t = Ax_{t-1} + w_t$$

**观测方程**：
$$z_t = Hx_t + v_t$$

---

## 四、典型考题

### 【例题】单位线法预报

**题目**（20分）

已知单位线UH=[5, 15, 25, 15, 5]，净雨R=[10, 20, 15]mm，求流量过程。

**【解答】**（见Python示例，卷积法）

---

**本章重点**：
- 新安江模型产流
- 单位线卷积
- 马斯京根汇流
- 预报精度评估（NSE）

**下一章**：城市雨洪模型
