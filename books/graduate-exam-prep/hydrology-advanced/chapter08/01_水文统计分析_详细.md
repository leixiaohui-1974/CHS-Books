# 第8章：水文统计分析

**学习时间**: 4小时  
**考试频率**: ⭐⭐⭐⭐⭐  
**难度**: ⭐⭐⭐⭐⭐

---

## 一、水文统计基本概念

### 1.1 随机变量与概率分布

**水文随机变量**：
- 年径流量
- 洪峰流量
- 年降水量
- 枯水流量

**统计特征值**：
- 均值$\bar{x}$
- 变差系数$C_v$
- 偏态系数$C_s$

### 1.2 频率与重现期

**频率**（超过概率）：

$$P = \frac{m}{n+1}$$

**重现期**：

$$T = \frac{1}{P}$$

**设计保证率**：

$$p = 1 - P$$

---

## 二、水文频率分布

### 2.1 皮尔逊III型（P-III）

**概率密度函数**：

$$f(x) = \frac{\beta^\alpha}{\Gamma(\alpha)}(x-a_0)^{\alpha-1}e^{-\beta(x-a_0)}$$

**参数关系**：

$$\alpha = \frac{4}{C_s^2}, \quad \beta = \frac{2}{C_v \bar{x} C_s}, \quad a_0 = \bar{x}(1 - \frac{2C_v}{C_s})$$

**频率计算**（实用公式）：

$$x_p = \bar{x}(1 + C_v \Phi_p)$$

其中$\Phi_p$为模比系数，查表或计算得到

### 2.2 对数皮尔逊III型（LP-III）

**变换**：$y = \ln x$

$$y_p = \bar{y}(1 + C_{vy} \Phi_p)$$

$$x_p = e^{y_p}$$

**适用**：偏态较大的序列

### 2.3 极值I型（耿贝尔分布）

**概率分布函数**：

$$F(x) = \exp\{-\exp[-\alpha(x-u)]\}$$

**参数**：

$$\alpha = \frac{\pi}{\sqrt{6}\sigma}, \quad u = \bar{x} - 0.5772/\alpha$$

**设计值**：

$$x_T = u - \frac{1}{\alpha}\ln\left[-\ln\left(1-\frac{1}{T}\right)\right]$$

---

## 三、参数估计

### 3.1 矩法估计

**均值**：

$$\bar{x} = \frac{1}{n}\sum_{i=1}^n x_i$$

**二阶矩**（方差）：

$$\sigma^2 = \frac{1}{n}\sum_{i=1}^n (x_i - \bar{x})^2$$

**变差系数**：

$$C_v = \frac{\sigma}{\bar{x}}$$

**三阶矩**（偏度）：

$$C_s = \frac{\frac{1}{n}\sum(x_i-\bar{x})^3}{\sigma^3}$$

### 3.2 适线法

**步骤**：
1. 初算$\bar{x}$，$C_v$，$C_s$
2. 计算经验频率点据
3. 绘制频率曲线
4. 调整参数使曲线通过点据
5. 读取设计值

### 3.3 最大似然估计（MLE）

**似然函数**：

$$L(\theta) = \prod_{i=1}^n f(x_i; \theta)$$

**对数似然**：

$$\ln L(\theta) = \sum_{i=1}^n \ln f(x_i; \theta)$$

**估计值**：

$$\hat{\theta} = \arg\max_\theta \ln L(\theta)$$

---

## 四、假设检验

### 4.1 独立性检验

**游程检验**：

**游程数**：$r$

**检验统计量**：

$$Z = \frac{r - E(r)}{\sqrt{Var(r)}}$$

其中：

$$E(r) = \frac{2n_1 n_2}{n_1+n_2} + 1$$

$$Var(r) = \frac{2n_1 n_2(2n_1 n_2 - n_1 - n_2)}{(n_1+n_2)^2(n_1+n_2-1)}$$

### 4.2 一致性检验

**Mann-Whitney U检验**：

比较两组样本是否来自同一总体

**t检验**：

$$t = \frac{\bar{x}_1 - \bar{x}_2}{s_p\sqrt{\frac{1}{n_1}+\frac{1}{n_2}}}$$

### 4.3 拟合优度检验

**χ²检验**：

$$\chi^2 = \sum_{i=1}^k \frac{(O_i - E_i)^2}{E_i}$$

**K-S检验**：

$$D_n = \max|F_n(x) - F_0(x)|$$

---

## 五、相关分析

### 5.1 相关系数

**皮尔逊相关系数**：

$$r = \frac{\sum(x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\sum(x_i-\bar{x})^2 \sum(y_i-\bar{y})^2}}$$

**检验**：

$$t = \frac{r\sqrt{n-2}}{\sqrt{1-r^2}} \sim t(n-2)$$

### 5.2 回归分析

**一元线性回归**：

$$y = a + bx$$

$$b = \frac{\sum(x_i-\bar{x})(y_i-\bar{y})}{\sum(x_i-\bar{x})^2}$$

$$a = \bar{y} - b\bar{x}$$

---

## 六、Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats, special, optimize

class HydrologicalStatistics:
    """水文统计分析"""
    
    def __init__(self):
        pass
    
    def basic_statistics(self, data):
        """
        基本统计参数
        
        返回: mean, Cv, Cs
        """
        n = len(data)
        mean = np.mean(data)
        std = np.std(data, ddof=1)
        
        Cv = std / mean
        
        # 偏态系数（矩法）
        m3 = np.mean((data - mean)**3)
        Cs = m3 / std**3
        
        return {
            'mean': mean,
            'std': std,
            'Cv': Cv,
            'Cs': Cs,
            'n': n
        }
    
    def empirical_frequency(self, data):
        """经验频率计算（威布尔公式）"""
        data_sorted = np.sort(data)[::-1]
        n = len(data)
        m = np.arange(1, n + 1)
        P = m / (n + 1) * 100  # 百分数
        
        return data_sorted, P
    
    def pearson3_frequency_factor(self, Cv, Cs, p):
        """
        P-III型频率模比系数 Φp
        
        近似公式（适用于工程计算）
        """
        # 标准正态分位数
        z_p = stats.norm.ppf(1 - p)
        
        # 考虑偏态修正
        Phi_p = z_p + (z_p**2 - 1) * Cs / 6 + \
                (z_p**3 - 3*z_p) * Cs**2 / 72 - \
                (2*z_p**3 - 5*z_p) * Cs**3 / 432
        
        return Phi_p
    
    def pearson3_quantile(self, mean, Cv, Cs, p):
        """P-III型设计值"""
        Phi_p = self.pearson3_frequency_factor(Cv, Cs, p)
        x_p = mean * (1 + Cv * Phi_p)
        return x_p
    
    def gumbel_quantile(self, mean, std, T):
        """
        极值I型（耿贝尔）设计值
        
        x_T = u - (1/α)·ln[-ln(1-1/T)]
        """
        alpha = np.pi / (np.sqrt(6) * std)
        u = mean - 0.5772 / alpha
        
        x_T = u - (1 / alpha) * np.log(-np.log(1 - 1/T))
        
        return x_T
    
    def run_test(self, data):
        """
        游程检验（独立性检验）
        
        检验序列是否随机
        """
        median = np.median(data)
        
        # 编码：大于中位数为1，小于为0
        coded = (data > median).astype(int)
        
        # 计数游程
        runs = 1
        for i in range(1, len(coded)):
            if coded[i] != coded[i-1]:
                runs += 1
        
        # 计数1和0的个数
        n1 = np.sum(coded)
        n0 = len(coded) - n1
        
        # 期望和方差
        E_r = 2 * n0 * n1 / (n0 + n1) + 1
        Var_r = 2 * n0 * n1 * (2*n0*n1 - n0 - n1) / \
                ((n0 + n1)**2 * (n0 + n1 - 1))
        
        # Z统计量
        Z = (runs - E_r) / np.sqrt(Var_r)
        
        # p值（双侧）
        p_value = 2 * (1 - stats.norm.cdf(abs(Z)))
        
        return {
            'runs': runs,
            'E_runs': E_r,
            'Z': Z,
            'p_value': p_value,
            'reject_H0': p_value < 0.05
        }
    
    def mann_whitney_test(self, data1, data2):
        """
        Mann-Whitney U检验（一致性检验）
        """
        statistic, p_value = stats.mannwhitneyu(data1, data2,
                                                alternative='two-sided')
        
        return {
            'U_statistic': statistic,
            'p_value': p_value,
            'reject_H0': p_value < 0.05
        }
    
    def ks_test(self, data, dist='norm'):
        """
        Kolmogorov-Smirnov拟合优度检验
        """
        if dist == 'norm':
            # 标准化
            mean = np.mean(data)
            std = np.std(data, ddof=1)
            data_std = (data - mean) / std
            
            statistic, p_value = stats.kstest(data_std, 'norm')
        
        return {
            'D_statistic': statistic,
            'p_value': p_value,
            'reject_H0': p_value < 0.05
        }
    
    def plot_hydrological_statistics(self, data, T_values=[10, 20, 50, 100]):
        """绘制水文统计分析图"""
        fig, axes = plt.subplots(2, 2, figsize=(16, 12))
        
        # 1. 频率曲线（P-III）
        ax1 = axes[0, 0]
        
        # 经验频率点据
        x_sorted, P_emp = self.empirical_frequency(data)
        
        ax1.scatter(P_emp, x_sorted, s=100, alpha=0.7, color='blue',
                   edgecolors='black', linewidth=1.5, label='经验点据',
                   zorder=3)
        
        # 统计参数
        stats_data = self.basic_statistics(data)
        mean = stats_data['mean']
        Cv = stats_data['Cv']
        Cs = 2 * Cv  # 调整
        
        # P-III理论曲线
        P_theory = np.logspace(-2, 2, 200)  # 0.01%~100%
        x_theory = []
        
        for p in P_theory:
            x_p = self.pearson3_quantile(mean, Cv, Cs, p / 100)
            x_theory.append(x_p)
        
        ax1.plot(P_theory, x_theory, 'r-', linewidth=2.5,
                label=f'P-III理论线\nx̄={mean:.0f}, Cv={Cv:.2f}, Cs={Cs:.2f}')
        
        # 标注设计值
        for T in T_values:
            p = 1 / T
            x_T = self.pearson3_quantile(mean, Cv, Cs, p)
            
            ax1.plot(p * 100, x_T, 'go', markersize=12, zorder=4)
            ax1.text(p * 100, x_T * 1.05,
                    f"T={T}年\n{x_T:.0f}",
                    ha='center', fontsize=9,
                    bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.7))
        
        ax1.set_xscale('log')
        ax1.set_xlabel('频率 P (%)', fontsize=11)
        ax1.set_ylabel('洪峰流量 Q (m³/s)', fontsize=11)
        ax1.set_title('P-III型频率曲线', fontsize=13, fontweight='bold')
        ax1.legend()
        ax1.grid(True, alpha=0.3, which='both')
        ax1.invert_xaxis()
        
        # 2. 频率分布对比（P-III vs Gumbel）
        ax2 = axes[0, 1]
        
        T_range = np.logspace(0, 3, 100)  # 1~1000年
        
        # P-III
        x_P3 = []
        for T in T_range:
            p = 1 / T
            x_p = self.pearson3_quantile(mean, Cv, Cs, p)
            x_P3.append(x_p)
        
        # Gumbel
        std = stats_data['std']
        x_Gumbel = [self.gumbel_quantile(mean, std, T) for T in T_range]
        
        ax2.plot(T_range, x_P3, 'b-', linewidth=2.5, label='P-III型')
        ax2.plot(T_range, x_Gumbel, 'r--', linewidth=2.5, label='极值I型（Gumbel）')
        
        # 标注典型重现期
        for T in [10, 50, 100]:
            p = 1 / T
            x_p3 = self.pearson3_quantile(mean, Cv, Cs, p)
            x_gum = self.gumbel_quantile(mean, std, T)
            
            ax2.plot(T, x_p3, 'bo', markersize=10)
            ax2.plot(T, x_gum, 'ro', markersize=10)
        
        ax2.set_xscale('log')
        ax2.set_xlabel('重现期 T (年)', fontsize=11)
        ax2.set_ylabel('设计值', fontsize=11)
        ax2.set_title('不同频率分布对比', fontsize=13, fontweight='bold')
        ax2.legend()
        ax2.grid(True, alpha=0.3, which='both')
        
        # 3. 游程检验可视化
        ax3 = axes[1, 0]
        
        median = np.median(data)
        x_idx = np.arange(1, len(data) + 1)
        
        ax3.plot(x_idx, data, 'b-', linewidth=2, alpha=0.7, label='观测序列')
        ax3.axhline(median, color='r', linestyle='--', linewidth=2,
                   label=f'中位数={median:.0f}')
        
        # 标注大于/小于中位数
        above = data > median
        below = data <= median
        
        ax3.scatter(x_idx[above], data[above], s=80, color='green',
                   alpha=0.6, label='大于中位数', zorder=3)
        ax3.scatter(x_idx[below], data[below], s=80, color='orange',
                   alpha=0.6, label='小于中位数', zorder=3)
        
        # 游程检验结果
        run_result = self.run_test(data)
        
        ax3.text(0.05, 0.95,
                f"游程检验\n游程数r={run_result['runs']}\n"
                f"期望E(r)={run_result['E_runs']:.1f}\n"
                f"Z={run_result['Z']:.2f}\n"
                f"p值={run_result['p_value']:.3f}\n"
                f"结论:{'拒绝H0(非随机)' if run_result['reject_H0'] else '接受H0(随机)'}",
                transform=ax3.transAxes, fontsize=10,
                verticalalignment='top',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.8))
        
        ax3.set_xlabel('序号', fontsize=11)
        ax3.set_ylabel('流量 Q (m³/s)', fontsize=11)
        ax3.set_title('独立性检验（游程检验）', fontsize=13, fontweight='bold')
        ax3.legend()
        ax3.grid(True, alpha=0.3)
        
        # 4. Q-Q图（正态性检验）
        ax4 = axes[1, 1]
        
        # 标准化数据
        data_std = (data - mean) / std
        data_sorted = np.sort(data_std)
        
        # 理论分位数
        theoretical_quantiles = stats.norm.ppf(
            (np.arange(1, len(data) + 1) - 0.5) / len(data))
        
        ax4.scatter(theoretical_quantiles, data_sorted,
                   s=100, alpha=0.7, color='blue',
                   edgecolors='black', linewidth=1.5)
        
        # 参考线
        ax4.plot(theoretical_quantiles, theoretical_quantiles,
                'r--', linewidth=2.5, label='理论线')
        
        # KS检验
        ks_result = self.ks_test(data)
        
        ax4.text(0.05, 0.95,
                f"K-S检验\nD={ks_result['D_statistic']:.3f}\n"
                f"p值={ks_result['p_value']:.3f}\n"
                f"结论:{'拒绝H0(非正态)' if ks_result['reject_H0'] else '接受H0(正态)'}",
                transform=ax4.transAxes, fontsize=10,
                verticalalignment='top',
                bbox=dict(boxstyle='round', facecolor='lightblue', alpha=0.8))
        
        ax4.set_xlabel('理论分位数', fontsize=11)
        ax4.set_ylabel('样本分位数', fontsize=11)
        ax4.set_title('正态Q-Q图（拟合优度检验）', fontsize=13, fontweight='bold')
        ax4.legend()
        ax4.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig('hydrological_statistics.png', dpi=300)
        plt.show()

# 示例计算
print("="*60)
print("水文统计分析")
print("="*60)

hs = HydrologicalStatistics()

# 1. 基本统计参数
print("1. 基本统计参数:")

Q_annual = np.array([
    3200, 4500, 2800, 5100, 3800, 4200, 3500, 6000, 4800, 3600,
    5500, 4000, 3400, 5800, 4300, 3900, 5200, 3700, 4600, 4100,
    3300, 4700, 5300, 3100, 4400
])

print(f"  样本容量 n = {len(Q_annual)}")

stats_result = hs.basic_statistics(Q_annual)

print(f"  均值 x̄ = {stats_result['mean']:.1f} m³/s")
print(f"  标准差 σ = {stats_result['std']:.1f} m³/s")
print(f"  变差系数 Cv = {stats_result['Cv']:.3f}")
print(f"  偏态系数 Cs = {stats_result['Cs']:.3f}")
print(f"  Cs/Cv = {stats_result['Cs']/stats_result['Cv']:.2f}")

# 2. 频率分析
print("\n" + "="*60)
print("2. 设计洪峰流量（P-III型）:")

mean = stats_result['mean']
Cv = stats_result['Cv']
Cs = 2 * Cv  # 调整

T_design = [5, 10, 20, 50, 100, 1000]

for T in T_design:
    p = 1 / T
    Phi_p = hs.pearson3_frequency_factor(Cv, Cs, p)
    Q_p = hs.pearson3_quantile(mean, Cv, Cs, p)
    
    print(f"  T={T:4d}年（p={p*100:6.2f}%）: Φp={Phi_p:6.3f}, Qp={Q_p:6.0f} m³/s")

# 3. Gumbel分布对比
print("\n" + "="*60)
print("3. 极值I型（Gumbel）分布:")

std = stats_result['std']

for T in [10, 50, 100]:
    Q_gumbel = hs.gumbel_quantile(mean, std, T)
    p = 1 / T
    Q_p3 = hs.pearson3_quantile(mean, Cv, Cs, p)
    
    print(f"  T={T}年: Gumbel={Q_gumbel:.0f} m³/s, P-III={Q_p3:.0f} m³/s, 差异={abs(Q_gumbel-Q_p3)/Q_p3*100:.1f}%")

# 4. 独立性检验
print("\n" + "="*60)
print("4. 独立性检验（游程检验）:")

run_result = hs.run_test(Q_annual)

print(f"  游程数 r = {run_result['runs']}")
print(f"  期望游程数 E(r) = {run_result['E_runs']:.2f}")
print(f"  Z统计量 = {run_result['Z']:.3f}")
print(f"  p值 = {run_result['p_value']:.4f}")
print(f"  结论: {'序列非随机（拒绝H0）' if run_result['reject_H0'] else '序列随机（接受H0）'}")

# 5. 一致性检验（分组）
print("\n" + "="*60)
print("5. 一致性检验（Mann-Whitney）:")

# 假设前后两组
group1 = Q_annual[:12]
group2 = Q_annual[12:]

mw_result = hs.mann_whitney_test(group1, group2)

print(f"  第1组均值 = {np.mean(group1):.1f} m³/s")
print(f"  第2组均值 = {np.mean(group2):.1f} m³/s")
print(f"  U统计量 = {mw_result['U_statistic']:.1f}")
print(f"  p值 = {mw_result['p_value']:.4f}")
print(f"  结论: {'两组有显著差异（拒绝H0）' if mw_result['reject_H0'] else '两组一致（接受H0）'}")

# 6. 拟合优度检验
print("\n" + "="*60)
print("6. 拟合优度检验（K-S）:")

ks_result = hs.ks_test(Q_annual)

print(f"  D统计量 = {ks_result['D_statistic']:.4f}")
print(f"  p值 = {ks_result['p_value']:.4f}")
print(f"  结论: {'数据非正态分布（拒绝H0）' if ks_result['reject_H0'] else '数据服从正态分布（接受H0）'}")

# 绘图
print("\n绘制水文统计分析图...")
hs.plot_hydrological_statistics(Q_annual, T_values=[10, 20, 50, 100])
```

---

## 七、典型考题

### 【例题1】统计参数计算（12分）

**题目**：10年洪峰资料（m³/s）：
$$3500, 4200, 3000, 5100, 3800, 4500, 3200, 6000, 4800, 3600$$

求$\bar{x}$，$C_v$，$C_s$。

**【解答】**

$$\bar{x} = \frac{3500+4200+\cdots+3600}{10} = 4170 \text{ m}^3\text{/s}$$

$$\sigma^2 = \frac{1}{10}\sum(x_i-\bar{x})^2 = 869000$$

$$\sigma = 932 \text{ m}^3\text{/s}$$

$$C_v = \frac{932}{4170} = 0.223$$

$$m_3 = \frac{1}{10}\sum(x_i-\bar{x})^3 = 4.27 \times 10^8$$

$$C_s = \frac{m_3}{\sigma^3} = \frac{4.27 \times 10^8}{(932)^3} = 0.527$$

---

**本章重点**：
- P-III型频率分析
- 统计参数估计
- 假设检验（独立性、一致性、拟合优度）
- 相关分析

**全书完成！**
