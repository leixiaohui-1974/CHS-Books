# 第4章：常微分方程速解技巧

**学习时间**: 4小时  
**难度**: ⭐⭐⭐⭐  
**考试权重**: 15%

---

## 一、一阶微分方程

### 1.1 可分离变量

$$\frac{dy}{dx} = f(x)g(y)$$

**解法**：
$$\frac{dy}{g(y)} = f(x)dx$$

两边积分即可

### 1.2 齐次方程

$$\frac{dy}{dx} = f\left(\frac{y}{x}\right)$$

**解法**：令 $u = \frac{y}{x}$，则 $y = ux$

$$\frac{dy}{dx} = u + x\frac{du}{dx}$$

转化为可分离变量方程

### 1.3 一阶线性

$$\frac{dy}{dx} + P(x)y = Q(x)$$

**通解公式**：
$$y = e^{-\int P(x)dx}\left[\int Q(x)e^{\int P(x)dx}dx + C\right]$$

**简记**：先求齐次解，再用常数变易法

### 1.4 Python实现

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import odeint
import sympy as sp

class ODESolver:
    """
    常微分方程求解器
    """
    
    @staticmethod
    def separable_symbolic(dy_dx, x_var, y_var):
        """
        可分离变量（符号解）
        
        参数:
            dy_dx: dy/dx表达式（sympy）
            x_var, y_var: 符号变量
        """
        # 通用求解
        solution = sp.dsolve(sp.Eq(sp.diff(y_var, x_var), dy_dx), y_var)
        return solution
    
    @staticmethod
    def first_order_linear(P, Q, x0, y0, x_range):
        """
        一阶线性方程数值解
        
        dy/dx + P(x)y = Q(x)
        
        参数:
            P, Q: 系数函数
            x0, y0: 初值
            x_range: x范围
        """
        def f(y, x):
            return Q(x) - P(x) * y
        
        x = np.linspace(x_range[0], x_range[1], 100)
        y = odeint(f, y0, x)
        
        return x, y.flatten()
    
    @staticmethod
    def plot_direction_field(f, x_range, y_range, ax=None):
        """
        绘制方向场
        
        参数:
            f: dy/dx = f(x, y)
            x_range, y_range: 范围
        """
        if ax is None:
            fig, ax = plt.subplots(figsize=(8, 6))
        
        x = np.linspace(x_range[0], x_range[1], 20)
        y = np.linspace(y_range[0], y_range[1], 20)
        X, Y = np.meshgrid(x, y)
        
        # 计算斜率
        U = np.ones_like(X)
        V = f(X, Y)
        
        # 归一化
        N = np.sqrt(U**2 + V**2)
        U, V = U/N, V/N
        
        # 绘制方向场
        ax.quiver(X, Y, U, V, alpha=0.6)
        ax.set_xlabel('x')
        ax.set_ylabel('y')
        ax.set_title('方向场')
        ax.grid(True, alpha=0.3)
        
        return ax


# 示例1：可分离变量
print("="*60)
print("示例1：可分离变量方程")
print("="*60)

x, y = sp.symbols('x y')
C = sp.Symbol('C')

# dy/dx = x*y
dy_dx = x * y
solution = ODESolver.separable_symbolic(dy_dx, x, y)
print(f"方程: dy/dx = x*y")
print(f"通解: {solution}")

# 示例2：一阶线性
print("\n" + "="*60)
print("示例2：一阶线性方程")
print("="*60)

# dy/dx + 2y = e^(-x), y(0) = 1
def P(x):
    return 2

def Q(x):
    return np.exp(-x)

x_vals, y_vals = ODESolver.first_order_linear(P, Q, 0, 1, (0, 3))

print(f"方程: dy/dx + 2y = e^(-x)")
print(f"初值: y(0) = 1")
print(f"数值解: y(3) ≈ {y_vals[-1]:.4f}")

# 绘图
plt.figure(figsize=(10, 6))
plt.plot(x_vals, y_vals, 'b-', linewidth=2, label='数值解')
plt.xlabel('x', fontsize=12)
plt.ylabel('y', fontsize=12)
plt.title('一阶线性方程数值解', fontsize=14)
plt.legend()
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.savefig('first_order_linear.png', dpi=300, bbox_inches='tight')
plt.show()

# 示例3：方向场
print("\n" + "="*60)
print("示例3：方向场可视化")
print("="*60)

def f_direction(x, y):
    return x - y

fig, ax = plt.subplots(figsize=(8, 6))
ODESolver.plot_direction_field(f_direction, (-2, 2), (-2, 2), ax)

# 叠加几条积分曲线
for y0 in [-1.5, -0.5, 0.5, 1.5]:
    def ode_func(y, x):
        return x - y
    x_curve = np.linspace(-2, 2, 100)
    y_curve = odeint(ode_func, y0, x_curve)
    ax.plot(x_curve, y_curve, 'r-', linewidth=1.5, alpha=0.8)

plt.title('方向场与积分曲线: dy/dx = x - y')
plt.savefig('direction_field.png', dpi=300, bbox_inches='tight')
plt.show()
```

---

## 二、二阶常系数线性

### 2.1 齐次方程

$$y'' + py' + qy = 0$$

**特征方程**：
$$\lambda^2 + p\lambda + q = 0$$

**通解**（三种情况）：

1. **两不等实根** $\lambda_1 \neq \lambda_2$：
   $$y = C_1 e^{\lambda_1 x} + C_2 e^{\lambda_2 x}$$

2. **两相等实根** $\lambda_1 = \lambda_2 = \lambda$：
   $$y = (C_1 + C_2 x)e^{\lambda x}$$

3. **共轭复根** $\lambda = \alpha \pm i\beta$：
   $$y = e^{\alpha x}(C_1\cos\beta x + C_2\sin\beta x)$$

### 2.2 非齐次方程

$$y'' + py' + qy = f(x)$$

**通解** = 齐次通解 + 特解

**特解设法**（常用）：

| $f(x)$ | 特解形式 $y^*$ |
|--------|---------------|
| $P_n(x)e^{kx}$ | $x^m Q_n(x)e^{kx}$ |
| $e^{\alpha x}\cos\beta x$ | $x^m e^{\alpha x}(A\cos\beta x + B\sin\beta x)$ |

$m$：k（或α±iβ）是特征根的重数

### 2.3 Python实现

```python
class SecondOrderODE:
    """
    二阶常系数线性ODE
    """
    
    @staticmethod
    def characteristic_roots(p, q):
        """
        特征方程求根
        
        λ² + pλ + q = 0
        """
        discriminant = p**2 - 4*q
        
        if discriminant > 0:
            # 两不等实根
            lambda1 = (-p + np.sqrt(discriminant)) / 2
            lambda2 = (-p - np.sqrt(discriminant)) / 2
            root_type = "两不等实根"
            return root_type, (lambda1, lambda2)
        
        elif discriminant == 0:
            # 重根
            lambda_ = -p / 2
            root_type = "重根"
            return root_type, (lambda_, lambda_)
        
        else:
            # 复根
            alpha = -p / 2
            beta = np.sqrt(-discriminant) / 2
            root_type = "共轭复根"
            return root_type, (alpha, beta)
    
    @staticmethod
    def general_solution(p, q, x_range=(0, 5), C1=1, C2=1):
        """
        齐次方程通解
        """
        x = np.linspace(x_range[0], x_range[1], 200)
        
        root_type, roots = SecondOrderODE.characteristic_roots(p, q)
        
        if root_type == "两不等实根":
            lambda1, lambda2 = roots
            y = C1 * np.exp(lambda1 * x) + C2 * np.exp(lambda2 * x)
            formula = f"y = C₁e^({lambda1:.2f}x) + C₂e^({lambda2:.2f}x)"
        
        elif root_type == "重根":
            lambda_, _ = roots
            y = (C1 + C2 * x) * np.exp(lambda_ * x)
            formula = f"y = (C₁ + C₂x)e^({lambda_:.2f}x)"
        
        else:  # 复根
            alpha, beta = roots
            y = np.exp(alpha * x) * (C1 * np.cos(beta * x) + 
                                     C2 * np.sin(beta * x))
            formula = f"y = e^({alpha:.2f}x)(C₁cos({beta:.2f}x) + C₂sin({beta:.2f}x))"
        
        return x, y, formula, root_type


# 示例：二阶ODE
print("\n" + "="*60)
print("示例：二阶常系数线性ODE")
print("="*60)

# y'' - 3y' + 2y = 0
p, q = -3, 2
root_type, roots = SecondOrderODE.characteristic_roots(p, q)

print(f"方程: y'' - 3y' + 2y = 0")
print(f"特征方程: λ² - 3λ + 2 = 0")
print(f"根的类型: {root_type}")
print(f"根: λ₁={roots[0]:.2f}, λ₂={roots[1]:.2f}")

x, y, formula, _ = SecondOrderODE.general_solution(p, q, C1=1, C2=1)
print(f"通解: {formula}")

# 绘制三种情况
fig, axes = plt.subplots(1, 3, figsize=(15, 4))

# 情况1：两不等实根
x1, y1, f1, _ = SecondOrderODE.general_solution(-3, 2)
axes[0].plot(x1, y1, 'b-', linewidth=2)
axes[0].set_title('两不等实根\ny\'\' - 3y\' + 2y = 0')
axes[0].set_xlabel('x')
axes[0].set_ylabel('y')
axes[0].grid(True, alpha=0.3)

# 情况2：重根
x2, y2, f2, _ = SecondOrderODE.general_solution(-4, 4)
axes[1].plot(x2, y2, 'g-', linewidth=2)
axes[1].set_title('重根\ny\'\' - 4y\' + 4y = 0')
axes[1].set_xlabel('x')
axes[1].grid(True, alpha=0.3)

# 情况3：复根
x3, y3, f3, _ = SecondOrderODE.general_solution(0, 4)
axes[2].plot(x3, y3, 'r-', linewidth=2)
axes[2].set_title('共轭复根\ny\'\' + 4y = 0')
axes[2].set_xlabel('x')
axes[2].grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('second_order_ode.png', dpi=300, bbox_inches='tight')
plt.show()
```

---

## 三、典型考题

### 考题1：求通解

**【题目】**求 $y'' - 4y' + 4y = 0$ 的通解

**【解答】**

特征方程：$\lambda^2 - 4\lambda + 4 = 0$

$(\lambda - 2)^2 = 0$

**重根**：$\lambda_1 = \lambda_2 = 2$

**通解**：$y = (C_1 + C_2 x)e^{2x}$

---

## 四、速记口诀

> 特征方程定乾坤  
> 实根复根要分清  
> 重根记得乘个x  
> 复根三角别忘记

---

**本章习题**: 见配套练习册  
**下一章**: 级数与傅里叶
