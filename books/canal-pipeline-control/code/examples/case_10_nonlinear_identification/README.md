# 案例10：非线性系统辨识

## 问题描述

在案例8和9中，我们使用N4SID和频域方法辨识**线性模型**。但实际水利系统往往具有显著的**非线性特性**：

```
渠道系统的非线性来源：

Manning公式：Q = (1/n) A R^(2/3) √i₀
             ↓
          非线性！(R依赖于h)

闸门公式：Q = Cd B a √(2gh)
          ↓
       非线性！(√h)

摩阻：Sf = (nQ/A)² / R^(4/3)
      ↓
   非线性！(Q², h的复杂函数)
```

**线性辨识的局限**：
- 只在工作点附近有效
- 大范围操作时误差大
- 无法捕捉非线性现象（饱和、死区、迟滞）

**非线性辨识的必要性**：
1. **宽范围建模**：覆盖从低水位到高水位
2. **精确预测**：捕捉非线性动态
3. **控制器设计**：非线性MPC、反馈线性化
4. **异常检测**：识别非正常运行模式

**非线性辨识方法分类**：

```
非线性辨识方法
├── 块结构模型
│   ├── Hammerstein模型 (N→L)
│   ├── Wiener模型 (L→N)
│   └── Hammerstein-Wiener模型 (N→L→N)
├── 泛函展开
│   ├── Volterra级数
│   └── 核函数方法
├── 参数化非线性
│   ├── 多项式NARX
│   └── 有理函数模型
└── 黑盒方法
    ├── 神经网络
    └── 支持向量机
```

**本案例重点**：
- Hammerstein-Wiener模型（物理意义清晰）
- 多项式NARX模型（易于实现）
- 神经网络辨识（强大表达能力）

## 理论基础

### 1. Hammerstein-Wiener模型

**Hammerstein-Wiener (HW)模型**是最常用的块结构非线性模型。

```
输入 u → [非线性块 f] → w → [线性块 G] → z → [非线性块 h] → 输出 y

  u ─────→ f(u) ─────→ G(z) ─────→ h(z) ─────→ y
         (静态)      (动态)       (静态)
```

**数学表达**：

1. **输入非线性**（Hammerstein部分）：
$$w(k) = f(u(k); \boldsymbol{\theta}_f)$$

2. **线性动态**（中间部分）：
$$z(k) = G(q^{-1}) w(k)$$

其中$G(q^{-1})$是线性传递函数：
$$G(q^{-1}) = \frac{B(q^{-1})}{A(q^{-1})} = \frac{b_1 q^{-1} + b_2 q^{-2} + \cdots}{1 + a_1 q^{-1} + a_2 q^{-2} + \cdots}$$

3. **输出非线性**（Wiener部分）：
$$y(k) = h(z(k); \boldsymbol{\theta}_h)$$

**特例**：

- **Hammerstein模型**：$h(z) = z$（只有输入非线性）
- **Wiener模型**：$f(u) = u$（只有输出非线性）
- **线性模型**：$f(u) = u, h(z) = z$

**非线性函数的选择**：

常用的非线性函数形式：

1. **多项式**：
$$f(u) = c_0 + c_1 u + c_2 u^2 + \cdots + c_p u^p$$

2. **分段线性**：
$$f(u) = \begin{cases}
k_1 u, & u < u_1 \\
k_2 u + b, & u_1 \leq u < u_2 \\
k_3 u + c, & u \geq u_2
\end{cases}$$

3. **饱和函数**：
$$f(u) = \begin{cases}
u_{min}, & u < u_{min} \\
u, & u_{min} \leq u \leq u_{max} \\
u_{max}, & u > u_{max}
\end{cases}$$

4. **S型函数**（Sigmoid、tanh）：
$$f(u) = \frac{A}{1 + e^{-k(u - u_0)}}$$

**辨识方法**：

HW模型的辨识是非凸优化问题，通常采用**迭代算法**：

**方法1：交替优化**

1. **固定线性部分，估计非线性**：
   - 给定$G$，用最小二乘估计$f$和$h$

2. **固定非线性部分，估计线性**：
   - 给定$f$和$h$，用线性辨识方法（如N4SID）估计$G$

3. **迭代直至收敛**

**方法2：分离变量法**

利用非线性函数的可分离性：
- 多项式非线性：线性于系数
- 查找表：线性于节点值

**方法3：直接优化**

使用非线性优化算法（如Levenberg-Marquardt）：
$$\min_{\boldsymbol{\theta}} \sum_{k=1}^{N} (y(k) - \hat{y}(k; \boldsymbol{\theta}))^2$$

### 2. NARX模型

**NARX（Nonlinear AutoRegressive with eXogenous inputs）**模型是最灵活的非线性模型之一。

**模型结构**：
$$y(k) = F(y(k-1), \ldots, y(k-n_y), u(k-1), \ldots, u(k-n_u)) + e(k)$$

其中$F$是非线性函数。

**多项式NARX**（最常用）：

线性组合所有交叉项：
$$y(k) = \sum_{i} \theta_i \phi_i(k)$$

其中$\phi_i(k)$是回归项，例如：
- $\phi_1(k) = y(k-1)$
- $\phi_2(k) = y(k-2)$
- $\phi_3(k) = u(k-1)$
- $\phi_4(k) = y(k-1)^2$
- $\phi_5(k) = y(k-1) u(k-1)$
- ...

**优点**：
- 灵活，可以逼近任意非线性系统
- 参数估计是线性问题（最小二乘）

**缺点**：
- 参数数量爆炸（$n_y=3, n_u=3$，二阶多项式已有几十个项）
- 容易过拟合
- 需要正则化或项选择

**项选择方法**：

1. **前向选择**：逐步添加最显著的项
2. **后向消除**：从全模型逐步删除不显著的项
3. **正则化**：Lasso、岭回归
4. **信息准则**：AIC、BIC

### 3. Volterra级数

**Volterra级数**是线性系统脉冲响应的非线性推广。

**二阶Volterra级数**：
$$y(k) = \sum_{i=0}^{\infty} h_1(i) u(k-i) + \sum_{i=0}^{\infty}\sum_{j=0}^{\infty} h_2(i,j) u(k-i) u(k-j)$$

其中：
- $h_1(i)$：一阶核（线性脉冲响应）
- $h_2(i,j)$：二阶核（捕捉二次非线性）

**截断Volterra级数**（实际应用）：
$$y(k) = \sum_{i=0}^{M} h_1(i) u(k-i) + \sum_{i=0}^{M}\sum_{j=0}^{M} h_2(i,j) u(k-i) u(k-j)$$

**参数估计**：

Volterra核可以通过最小二乘估计（线性于参数）：
$$\mathbf{y} = \mathbf{\Phi} \boldsymbol{\theta} + \mathbf{e}$$

其中$\boldsymbol{\theta} = [h_1(0), h_1(1), \ldots, h_2(0,0), h_2(0,1), \ldots]^T$

**问题**：
- 参数数量巨大：二阶核有$M^2$个参数
- 需要特殊激励信号（如高斯白噪声）

**应用**：
- 弱非线性系统
- 通信系统失真分析
- 非线性频率响应

### 4. 神经网络辨识

**神经网络**是万能逼近器，可以表示任意非线性映射。

**前馈神经网络**（用于NARX）：

```
输入层         隐藏层         输出层
y(k-1) ───┐
y(k-2) ───┤
  ...     ├─→ [神经元] ─→ ... ─→ [神经元] ─→ y(k)
u(k-1) ───┤
u(k-2) ───┘
```

**数学形式**：
$$y(k) = g_2\left(\sum_{j} w_j^{(2)} g_1\left(\sum_{i} w_{ij}^{(1)} \phi_i(k) + b_j^{(1)}\right) + b^{(2)}\right)$$

其中：
- $\phi_i(k)$：输入向量$[y(k-1), \ldots, u(k-1), \ldots]$
- $w$：权重
- $b$：偏置
- $g$：激活函数（ReLU、tanh、sigmoid）

**训练方法**：

1. **反向传播**：梯度下降
2. **Levenberg-Marquardt**：二阶优化（小规模）
3. **早停**：防止过拟合

**循环神经网络（RNN）**：

具有内部状态，自然适合动态系统：
$$\mathbf{h}(k) = \tanh(\mathbf{W}_h \mathbf{h}(k-1) + \mathbf{W}_u u(k))$$
$$y(k) = \mathbf{W}_y \mathbf{h}(k)$$

**LSTM/GRU**：解决长期依赖问题。

**优点**：
- 强大的非线性建模能力
- 自动特征提取
- 适合复杂系统

**缺点**：
- 需要大量数据
- 训练时间长
- 黑盒模型（可解释性差）
- 容易过拟合

### 5. 非线性系统的辨识流程

**Step 1: 非线性检测**

在辨识前，先判断系统是否需要非线性模型：

1. **残差分析**：
   - 线性模型拟合后，检查残差
   - 如果残差与输入相关→非线性

2. **相干函数**：
   - 频域方法中，低相干度→非线性

3. **幅值依赖性**：
   - 不同幅值激励下，频率响应不同→非线性

**Step 2: 模型结构选择**

根据先验知识选择模型类型：

| 系统特性 | 推荐模型 |
|---------|---------|
| 已知物理非线性位置 | Hammerstein-Wiener |
| 弱非线性 | 多项式NARX、Volterra |
| 强非线性，充足数据 | 神经网络 |
| 需要可解释性 | Hammerstein-Wiener、多项式 |

**Step 3: 激励信号设计**

非线性辨识对激励信号要求更高：

1. **持续激励**：覆盖整个工作范围
2. **幅值变化**：不同幅值以捕捉非线性
3. **多频率**：PRBS、多正弦
4. **避免周期性**（NARX）：防止自相关问题

**Step 4: 参数估计**

根据模型类型选择优化方法：
- 线性于参数：最小二乘
- 非线性于参数：Levenberg-Marquardt、梯度下降

**Step 5: 模型验证**

1. **独立数据集**：不同于训练数据的工况
2. **不同幅值测试**：验证非线性捕捉
3. **长时预测**：多步预测能力
4. **残差分析**：白噪声检验

### 6. 渠道系统的非线性辨识

**渠道系统的主要非线性**：

1. **Manning公式**：
$$Q = \frac{1}{n} A R^{2/3} \sqrt{i_0} \approx \alpha h^{\beta}$$
其中$\beta \approx 5/3$

2. **闸门公式**：
$$Q = C_d B a \sqrt{2gh} \approx \gamma a \sqrt{h}$$

3. **组合非线性**：
输入（闸门开度）→ 流量 → 水位
存在连续的非线性映射

**简化模型**：

对于单个闸门控制的渠段，可以建立简化的Hammerstein-Wiener模型：

```
闸门开度 u → [√h 非线性] → 流量 w → [水位动态 G(s)] → 水位 z → [线性] → 测量 y
```

或者使用多项式NARX：
$$h(k) = f(h(k-1), h(k-2), u(k-1), u(k-2), h(k-1)^2, u(k-1)^2, \ldots)$$

**辨识策略**：

1. **小信号线性化**：在多个工作点线性化
2. **全局非线性模型**：Hammerstein-Wiener或神经网络
3. **混合方法**：物理模型+数据驱动修正

## 实验设计

### Part 1: Hammerstein-Wiener模型辨识

**实验目的**：实现HW模型辨识算法

**步骤**：
1. 生成非线性测试系统（已知HW结构）
2. 添加噪声
3. 交替优化算法辨识
4. 对比辨识模型与真实模型

### Part 2: 多项式NARX模型

**实验目的**：使用多项式NARX建模非线性系统

**步骤**：
1. 生成非线性系统数据
2. 构造多项式回归项
3. 最小二乘估计
4. 项选择（Lasso正则化）
5. 模型验证

### Part 3: 渠道系统非线性辨识

**实验目的**：在渠道系统上应用非线性辨识

**步骤**：
1. Saint-Venant仿真（不同水位范围）
2. PRBS激励
3. 对比线性模型vs非线性模型
4. 验证宽范围预测能力

### Part 4: 神经网络辨识

**实验目的**：使用神经网络辨识渠道系统

**步骤**：
1. 收集训练数据（多工况）
2. 构造NARX型神经网络
3. 训练和验证
4. 对比其他方法

## 工程意义

### 1. 非线性建模的必要性

**案例：水位控制失效**

某灌区渠道使用线性MPC控制器，在设计工况（水深1.5m）运行良好，但当水深降至0.8m时，控制性能急剧下降。

**原因分析**：
- 线性模型在1.5m附近辨识
- Manning公式的非线性：$Q \propto h^{5/3}$
- 低水位时，增益变化显著
- 线性模型无法捕捉

**解决方案**：
- 非线性辨识，建立全局模型
- 或者：增益调度（多个工作点的线性模型）

### 2. Hammerstein-Wiener的物理意义

对于渠道系统，HW模型的各部分有明确物理意义：

```
闸门开度 → [闸门流量公式] → 流量 → [水位动态] → 水位测量
   u           f(u) ∝ √h        w        G(s)         y
```

这种物理驱动的结构有助于：
- 参数初值选择
- 外推到未测试工况
- 故障诊断（哪个环节异常）

### 3. 模型选择指南

| 情况 | 推荐方法 | 理由 |
|------|---------|------|
| 数据少（<500点） | Hammerstein-Wiener | 参数少，物理约束 |
| 数据多，弱非线性 | 多项式NARX | 易于实现，可解释 |
| 数据多，强非线性 | 神经网络 | 强大表达能力 |
| 需要在线更新 | 简单多项式 | 计算快 |
| 需要可解释性 | Hammerstein-Wiener | 物理意义明确 |

### 4. 实际应用技巧

**数据采集**：
- 覆盖工作范围：从最低到最高水位
- 多工况激励：不同流量、不同开度
- 足够长度：至少覆盖10倍最慢时间常数

**过拟合防止**：
- 训练集/验证集/测试集分离
- 正则化（L1、L2）
- 早停策略
- 交叉验证

**模型简化**：
- 从简单模型开始
- 逐步增加复杂度
- 复杂度vs性能权衡

**在线更新**：
- 递推最小二乘（RLS）
- 扩展Kalman滤波（参数估计）
- 滑动窗口

## 参数说明

### 渠道参数
| 参数 | 数值 | 单位 |
|------|------|------|
| 长度 L | 1000 | m |
| 宽度 B | 5 | m |
| 坡度 i₀ | 0.001 | - |
| 糙率 n | 0.025 | s/m^(1/3) |

### Hammerstein-Wiener参数
| 参数 | 数值 | 说明 |
|------|------|------|
| 输入非线性阶数 | 2-3 | 多项式阶数 |
| 线性部分阶数 | 2-4 | 状态空间维数 |
| 输出非线性阶数 | 1-2 | 多项式阶数 |
| 迭代次数 | 10-20 | 交替优化 |

### NARX参数
| 参数 | 数值 | 说明 |
|------|------|------|
| 输出延迟 ny | 2-4 | 历史输出项数 |
| 输入延迟 nu | 2-4 | 历史输入项数 |
| 多项式阶数 | 2-3 | 交叉项最高次数 |
| 正则化系数 λ | 0.01-0.1 | Lasso/Ridge |

### 神经网络参数
| 参数 | 数值 | 说明 |
|------|------|------|
| 隐藏层节点数 | 10-20 | 单隐层 |
| 学习率 | 0.001-0.01 | Adam优化器 |
| Epoch数 | 100-500 | 早停 |
| Batch大小 | 32-64 | 小批量 |

## 运行说明

```bash
python main.py
```

输出：
- `part1_hammerstein_wiener.png`: HW模型辨识
- `part2_narx_model.png`: 多项式NARX
- `part3_canal_nonlinear.png`: 渠道系统非线性辨识
- `part4_neural_network.png`: 神经网络辨识

## 总结

案例10展示了非线性系统辨识方法。关键要点：

1. **实际系统往往是非线性的**，线性模型只在小范围有效
2. **Hammerstein-Wiener模型**结合物理直观和辨识灵活性
3. **多项式NARX**是最实用的非线性模型之一
4. **神经网络**表达能力强，但需要大量数据
5. **非线性辨识需要充分激励**，覆盖整个工作范围
6. **权衡复杂度与性能**，避免过拟合
7. **模型验证至关重要**，独立数据集测试

非线性辨识是从线性到实用的重要一步，特别适合：
- 宽范围操作的系统
- 强非线性过程（化工、生物）
- 需要精确预测的场合
- 非线性控制器设计（反馈线性化、非线性MPC）

## 参考文献

1. Ljung, L. (1999). *System identification: theory for the user* (2nd ed.). Prentice Hall.

2. Nelles, O. (2020). *Nonlinear system identification: from classical approaches to neural networks, fuzzy models, and Gaussian processes* (2nd ed.). Springer.

3. Haber, R., & Keviczky, L. (1999). *Nonlinear system identification: input-output modeling approach*. Springer.

4. Schoukens, J., & Ljung, L. (2019). Nonlinear system identification: A user-oriented road map. *IEEE Control Systems Magazine*, 39(6), 28-99.

5. Sjöberg, J., Zhang, Q., Ljung, L., Benveniste, A., Delyon, B., Glorennec, P. Y., ... & Juditsky, A. (1995). Nonlinear black-box modeling in system identification: a unified overview. *Automatica*, 31(12), 1691-1724.

6. Billings, S. A. (2013). *Nonlinear system identification: NARMAX methods in the time, frequency, and spatio-temporal domains*. John Wiley & Sons.
