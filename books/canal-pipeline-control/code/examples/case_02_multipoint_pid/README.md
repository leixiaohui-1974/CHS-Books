# 案例2：多点反馈分布式PID控制

## 继承关系

**本案例基于**：
- 案例1：单渠段PID水位控制（单点反馈）
- 扩展：多个传感器分布式反馈

**技术创新**：
- 从单点测量 → 多点测量
- 从集中反馈 → 分布式反馈
- 加权融合策略

---

## 1. 问题描述

### 1.1 单点反馈的局限性

在案例1中，我们仅使用**下游单点水位**进行反馈控制。这存在以下问题：

**问题1：局部信息不足**
- 只知道下游水位，不了解沿程水位分布
- 中游可能出现问题（如局部壅水）无法及时发现

**问题2：时滞大**
- 闸门调节后，影响传播到下游需要较长时间
- 控制响应慢

**问题3：鲁棒性差**
- 下游传感器故障时，系统失控
- 对局部扰动不敏感

### 1.2 多点反馈方案

```
上游水源
   ↓
┌──┴──┐
│闸门 │ ← 控制执行器
└──┬──┘
   ↓
╔══════════════╗
║  [S1]        ║ ← 传感器1 (x = 250m)
║              ║
║      [S2]    ║ ← 传感器2 (x = 500m)
║              ║
║          [S3]║ ← 传感器3 (x = 750m)
║              ║
║              ║ ← 传感器4 (x = 1000m, 下游)
╚══════════════╝
   ↓
灌溉区域
```

**多点反馈控制律**：
```
e_weighted = Σ w_i × e_i
u = PID(e_weighted)
```

其中：
- e_i：第i个传感器的误差
- w_i：权重系数
- Σw_i = 1（归一化）

---

## 2. 加权策略设计

### 2.1 均匀权重（Uniform Weighting）

最简单的策略：所有传感器权重相等

```
w_1 = w_2 = w_3 = w_4 = 0.25
```

**优点**：简单、公平
**缺点**：未考虑位置重要性

### 2.2 距离加权（Distance Weighting）

根据传感器到下游的距离分配权重

```
w_i = d_i / Σd_i
```

其中 d_i 是传感器i到下游的距离。

**原理**：下游更重要（直接影响用户）

**示例**（L=1000m）：
- S1 (250m): w1 = 750/2500 = 0.30
- S2 (500m): w2 = 500/2500 = 0.20
- S3 (750m): w3 = 250/2500 = 0.10
- S4 (1000m, 下游): w4 = 0/2500 → 特殊处理，设为0.40

### 2.3 指数加权（Exponential Weighting）

```
w_i = exp(-α × (L - x_i)) / Z
```

其中：
- α：衰减系数
- Z：归一化常数
- 下游权重呈指数增长

### 2.4 自适应权重（Adaptive Weighting）

根据误差动态调整权重：

```
w_i(t) = |e_i(t)| / Σ|e_j(t)|
```

**原理**：偏差大的传感器获得更高权重

---

## 3. 传感器位置优化

### 3.1 可观测性分析

对于渠道系统，不同位置传感器提供的信息量不同。

**可观测性矩阵**（线性化后）：
```
O = [C; CA; CA²; ...]
```

**优化目标**：
```
max rank(O)  # 最大化可观测性
```

### 3.2 信息熵最大化

```
H = -Σ p_i log p_i
```

选择传感器位置使得信息熵最大。

### 3.3 经验规则

**等间距布置**：
- 简单有效
- 本案例采用：x = {250, 500, 750, 1000}m

**关键断面布置**：
- 控制断面（闸门下游）
- 中点断面
- 出口断面

---

## 4. 控制器设计

### 4.1 分布式PID控制器

```python
class DistributedPIDController:
    def __init__(self, Kp, Ki, Kd, n_sensors, weighting_method):
        self.pid = PIDController(Kp, Ki, Kd)
        self.n_sensors = n_sensors
        self.weighting_method = weighting_method

    def compute(self, target, measurements):
        # 计算各传感器误差
        errors = [target - m for m in measurements]

        # 计算权重
        weights = self.compute_weights(errors)

        # 加权误差
        e_weighted = sum(w * e for w, e in zip(weights, errors))

        # PID控制
        u = self.pid.compute_single(e_weighted)

        return u
```

### 4.2 权重计算

```python
def compute_weights(self, errors):
    if self.method == 'uniform':
        return [1/n for _ in range(n)]

    elif self.method == 'distance':
        # 基于位置的静态权重
        return self.distance_weights

    elif self.method == 'adaptive':
        # 基于误差的动态权重
        abs_errors = [abs(e) for e in errors]
        total = sum(abs_errors) + 1e-6
        return [e/total for e in abs_errors]
```

---

## 5. 实验设计

### 实验1：加权策略对比

测试4种加权方法：
1. 单点反馈（基线）
2. 均匀权重
3. 距离权重
4. 自适应权重

**评价指标**：
- 调节时间
- 超调量
- IAE/ISE/ITAE

### 实验2：传感器数量影响

对比不同传感器数量：
- N=1（单点）
- N=2（上下游）
- N=3（上中下）
- N=4（均匀分布）

### 实验3：传感器故障处理

模拟传感器故障：
- 单个传感器失效
- 多个传感器失效
- 故障检测与容错

### 实验4：测点位置优化

对比不同布置方案：
- 均匀分布
- 下游密集
- 上游密集

---

## 6. 性能分析

### 6.1 理论分析

**多点反馈的优势**：

1. **更快的响应速度**
   - 中游传感器可提前检测到变化
   - 减少等效时滞

2. **更好的鲁棒性**
   - 冗余测量
   - 故障容错

3. **更全面的状态信息**
   - 了解沿程分布
   - 检测局部异常

### 6.2 实际效果预期

相比单点反馈：
- 调节时间 ↓ 20-30%
- 稳态误差 ↓ 10-20%
- 抗扰动能力 ↑ 30-50%

---

## 7. 工程实施

### 7.1 传感器网络

**硬件选型**：
- 水位传感器：雷达式/超声波
- 通信方式：LoRa/4G/光纤
- 采样率：1次/分钟

**成本分析**：
```
单点方案：1个传感器 × 5000元 = 5,000元
多点方案：4个传感器 × 5000元 = 20,000元
增加成本：15,000元

性能提升：调节时间减少30%
投资回报：节约用水 + 提高供水可靠性
```

### 7.2 数据融合

**卡尔曼滤波**：
```python
# 状态估计
x_est = KF.update(measurements)

# 融合多传感器数据
h_fused = C @ x_est
```

**异常值剔除**：
- 3σ准则
- 中位数滤波
- RANSAC

### 7.3 故障检测

**残差分析**：
```python
residual = h_measured - h_predicted

if abs(residual) > threshold:
    # 传感器可能故障
    exclude_sensor(i)
```

**冗余容错**：
- N=4传感器，允许1-2个失效
- 自动切换到剩余传感器

---

## 8. 与案例1对比

| 特性 | 案例1（单点） | 案例2（多点） |
|-----|-------------|-------------|
| 传感器数量 | 1 | 4 |
| 反馈信息 | 局部 | 全局 |
| 响应速度 | 较慢 | 较快 |
| 鲁棒性 | 一般 | 较好 |
| 成本 | 低 | 中等 |
| 复杂度 | 简单 | 中等 |
| 适用场景 | 短渠道 | 长渠道 |

---

## 9. 关键公式总结

**加权误差**：
```
e_weighted = Σ w_i × (h_target - h_i)
```

**均匀权重**：
```
w_i = 1/N
```

**距离权重**：
```
w_i = (L - x_i) / Σ(L - x_j)
```

**自适应权重**：
```
w_i(t) = |e_i(t)| / Σ|e_j(t)|
```

**性能指标**：
```
IAE = ∫|e_weighted(t)|dt
ISE = ∫e_weighted²(t)dt
```

---

## 10. 参考文献

1. Litrico, X. & Fromion, V. (2009). *Modeling and Control of Hydrosystems*
2. Schuurmans, J. (1997). *Control of Water Levels in Open Channels*
3. Malaterre, P.O. (1998). *PILOTE: Linear Quadratic Optimal Control*
4. 张洪武. (2015). 《多传感器信息融合技术》

---

**案例难度**: ⭐⭐⭐ (中等)
**预计学习时间**: 5-7小时
**编程难度**: 中等
**数学要求**: 线性代数、概率论

---

**最后更新**: 2025-10-30
**作者**: Claude
**版本**: v1.0
