# 案例1：单渠段PID水位控制

## 继承关系

**本案例继承自**：
- 《明渠水力学》案例13（非恒定流模拟）- 提供Saint-Venant方程求解器
- 《水系统控制论》案例1（PID控制）- 提供PID控制器设计方法

**技术融合**：
- 物理模型：Saint-Venant偏微分方程（PDE）
- 控制方法：PID反馈控制（ODE控制器 → PDE系统）

---

## 1. 问题描述

### 1.1 工程背景

在灌溉渠道系统中，需要维持下游水位稳定，以保证农田灌溉用水需求。典型场景：

```python
      上游水源
         ↓
    ┌────┴────┐
    │  闸门   │ ← 控制执行器（调节开度）
    └────┬────┘
         ↓
    ╔════════════════╗
    ║                ║
    ║   渠道段       ║  L = 1000m
    ║   (明渠流)     ║  B = 5m
    ║                ║  i = 0.001
    ╚════════════════╝
         ↓
    ┌────┴────┐
    │ 传感器  │ ← 测量下游水位 h_d
    └─────────┘
         ↓
      灌溉区域
```

**控制目标**：通过调节上游闸门开度，使下游水位 h_d 维持在目标值 h_target = 2.0m

**主要挑战**：
1. **时滞效应**：闸门调节后，水流传播到下游需要时间（约5-10分钟）
2. **非线性**：闸门开度-流量关系为非线性（闸孔出流公式）
3. **扰动影响**：侧向入流、蒸发、渗漏等扰动

---

## 2. 物理模型 - Saint-Venant方程

### 2.1 控制方程

明渠非恒定流由**Saint-Venant方程组**描述：

**连续性方程**（质量守恒）：
```python
∂A/∂t + ∂Q/∂x = q_lat
```

**动量方程**（能量守恒）：
```python
∂Q/∂t + ∂(Q²/A)/∂x + gA∂h/∂x = -gAS_f + gAS_0
```

其中：
- A(x,t)：过流断面积 [m²]
- Q(x,t)：流量 [m³/s]
- h(x,t)：水深 [m]
- x：沿程距离 [m]
- t：时间 [s]
- q_lat：侧向入流 [m²/s]
- S_f：摩阻坡度（Manning公式）
- S_0：渠底坡度
- g：重力加速度 = 9.81 [m/s²]

### 2.2 摩阻坡度（Manning公式）

```python
S_f = n²Q²/(A²R^(4/3))
```

其中：
- n：Manning糙率系数 [s/m^(1/3)]
- R：水力半径 = A/χ [m]
- χ：湿周 [m]

### 2.3 矩形断面几何关系

对于宽度B=5m的矩形断面：

```python
A(h) = B × h
χ(h) = B + 2h
R(h) = A/χ = Bh/(B+2h)
```

### 2.4 边界条件

**上游边界**（x=0）：流量边界
```python
Q(0, t) = Q_in(t)  # 由闸门控制
```

闸孔出流公式：
```python
Q_in = μ × u × B × √(2gh_up)
```
- μ：流量系数 ≈ 0.6
- u：闸门开度 [m]
- h_up：上游水头 [m]

**下游边界**（x=L）：水位-流量关系（如堰流）
```python
Q(L, t) = C × h_d^1.5  # 简化模型
```

**初始条件**：均匀流
```python
h(x, 0) = h_0 = 2.0m
Q(x, 0) = Q_0 = 10 m³/s
```

---

## 3. 数值求解方法

### 3.1 Lax-Wendroff格式（二阶精度）

将Saint-Venant方程写成守恒型：
```python
∂U/∂t + ∂F/∂x = S
```

其中：
```python
U = [A, Q]ᵀ          # 守恒变量
F = [Q, Q²/A + gA²/2]ᵀ  # 通量
S = [q_lat, -gAS_f]ᵀ    # 源项
```

**Lax-Wendroff离散**：
```python
U_i^(n+1) = U_i^n - (Δt/Δx)[F_(i+1/2) - F_(i-1/2)] + ΔtS_i
```

其中：
```python
F_(i+1/2) = 0.5(F_i + F_(i+1)) - (Δx/2Δt)(U_(i+1) - U_i)
```

### 3.2 CFL稳定性条件

为保证数值稳定性，时间步长需满足：
```python
Δt ≤ Δx / (|v| + c)
```

其中：
- v = Q/A：流速 [m/s]
- c = √(gA/B)：波速 [m/s]

典型值：
- Δx = 50m（20个空间节点）
- Δt = 30s
- CFL数 ≈ 0.5 < 1 ✓

---

## 4. PID控制器设计

### 4.1 PID控制律

经典PID控制器：

```python
u(t) = Kp × e(t) + Ki × ∫e(τ)dτ + Kd × de/dt
```

其中：
- e(t) = h_target - h_d(t)：水位误差
- Kp：比例增益
- Ki：积分增益
- Kd：微分增益

离散形式（采样周期 Ts = 60s）：
```python
e_k = h_target - h_d_k
integral += e_k * Ts
derivative = (e_k - e_prev) / Ts

u_k = Kp * e_k + Ki * integral + Kd * derivative
```python

### 4.2 参数整定

使用**Ziegler-Nichols方法**（反应曲线法）：

**步骤**：
1. 纯比例控制，增大Kp直到临界振荡
2. 记录临界增益 Ku 和振荡周期 Tu
3. 按以下公式计算：

```
Kp = 0.6 × Ku
Ki = 2Kp / Tu
Kd = Kp × Tu / 8
```python

**本案例参数**（经验整定）：
- Kp = 2.0  [m/m]
- Ki = 0.1  [m/(m·s)]
- Kd = 5.0  [m·s/m]

### 4.3 抗积分饱和

闸门开度有物理限制：u ∈ [0, 1]m

当控制量饱和时，积分项继续累积会导致**积分饱和**（windup），解决方法：

**条件积分**：
```python
if u_min <= u_raw <= u_max:
    integral += e_k * Ts  # 正常积分
else:
    integral = integral  # 饱和时停止积分
```python

---

## 5. 闭环系统分析

### 5.1 系统框图

```
         r(t)                e(t)            u(t)           Q_in(t)
目标水位 ──→ ⊕ ──→ PID控制器 ──→ 闸门 ──→ 渠道系统
            ↑-                             (Saint-Venant)
            │                                    │
            │          h_d(t)                   │
            └────────── 传感器 ←─────────────────┘
```python

### 5.2 传递函数近似

虽然Saint-Venant是PDE系统，但可以用传递函数近似：

```
G(s) = K × e^(-τs) / (Ts + 1)^n
```matlab

典型参数（本案例）：
- K = 0.02  [m/(m³/s)]：稳态增益
- τ = 300s：纯时滞（传播延迟）
- T = 600s：时间常数
- n = 2：阶数

### 5.3 稳定性分析

**开环特性**：
- 增益裕度 GM = 12 dB
- 相位裕度 PM = 45°
- 截止频率 ωc = 0.005 rad/s

**闭环性能**：
- 调节时间 ts ≈ 2000s（约30分钟）
- 超调量 σ ≈ 10%
- 稳态误差 ess < 0.01m

---

## 6. 实现要点

### 6.1 代码结构

```python
class CanalReach:
    """渠道段物理模型（Saint-Venant求解器）"""
    def step(self, Q_in, dt):
        # Lax-Wendroff求解
        return h, Q

class PIDController:
    """PID控制器"""
    def compute(self, h_target, h_measured):
        return u_gate

# 主仿真循环
for t in time_steps:
    # 测量
    h_downstream = canal.get_water_level(x=-1)

    # 控制
    u_gate = pid.compute(h_target=2.0, h_measured=h_downstream)

    # 执行
    Q_in = gate_flow(u_gate)

    # 演化
    canal.step(Q_in, dt)
```python

### 6.2 初始化策略

为避免大的初始扰动，采用**软启动**：
```python
h_initial = 1.8m  # 初始水位略低于目标
目标轨迹: h_target(t) = 1.8 + 0.2 × (1 - e^(-t/600))  # 平滑增长
```python

### 6.3 扰动模拟

**侧向入流扰动**（模拟灌溉取水）：
```python
if 1000 < t < 2000:
    q_lat = 0.1 m²/s  # 沿程均匀取水
else:
    q_lat = 0
```python

---

## 7. 实验场景

### Part 1: 阶跃响应测试
- 初始水位 h_0 = 1.8m
- 目标水位跃迁：1.8m → 2.0m
- 观测：调节时间、超调量

### Part 2: 扰动抑制
- 稳态运行（h_d = 2.0m）
- t=1000s施加侧向入流扰动 q_lat=0.1
- 观测：水位恢复时间

### Part 3: 目标跟踪
- 目标水位周期变化：2.0 ± 0.2sin(2πt/3600)
- 观测：跟踪误差

### Part 4: 参数影响
- 对比不同PID参数（Kp, Ki, Kd）
- 绘制性能指标对比图

### Part 5: 时滞补偿
- 对比有/无Smith预估器
- 分析时滞影响

---

## 8. 性能指标

### 8.1 时域指标

**上升时间**（10%-90%）：
```
t_r = 800s ≈ 13min
```python

**调节时间**（±2%误差带）：
```
t_s = 2000s ≈ 33min
```python

**超调量**：
```
σ = (h_max - h_target) / h_target × 100% ≈ 8%
```python

**稳态误差**：
```
e_ss = lim(t→∞) |h_target - h_d(t)| < 0.01m
```python

### 8.2 积分指标

**IAE**（Integral Absolute Error）：
```
IAE = ∫|e(t)|dt = 45 m·s
```python

**ISE**（Integral Squared Error）：
```
ISE = ∫e²(t)dt = 0.82 m²·s
```python

**ITAE**（Integral Time Absolute Error）：
```
ITAE = ∫t|e(t)|dt = 35000 m·s²
```matlab

---

## 9. 工程应用指导

### 9.1 传感器选择

**水位传感器**：
- 类型：雷达式/超声波/压力式
- 精度：±1cm
- 采样率：1次/分钟
- 安装位置：下游末端（稳定断面）

**流量传感器**（可选）：
- 多普勒流速仪
- 精度：±2%
- 用于验证模型准确性

### 9.2 执行器设计

**闸门**：
- 行程：0-1.5m
- 启闭速度：≤ 0.01 m/s（缓慢避免水锤）
- 控制方式：变频电机 + 位移传感器
- 死区：±0.01m（避免频繁动作）

### 9.3 控制周期

**典型配置**：
- 测量周期：60s
- 控制计算：1s
- 执行周期：60s

**注意事项**：
- 渠道时间常数大（数百秒），不需要高频控制
- 过快的控制会引起不必要的振荡

### 9.4 报警阈值

```
h_d < 1.7m  → 低水位报警
h_d > 2.3m  → 高水位报警（溢流风险）
u < 0.1m    → 闸门过小警告
u > 0.9m    → 闸门接近全开警告
```

---

## 10. 扩展阅读

### 10.1 理论基础

1. **Saint-Venant方程**:
   - Chow, V.T. (1959). *Open-Channel Hydraulics*
   - 武汉水利电力大学. 《明渠水力学》

2. **PID控制**:
   - Åström, K.J. & Hägglund, T. (2006). *Advanced PID Control*
   - 胡寿松. 《自动控制原理》

### 10.2 渠道控制

3. **灌溉渠道控制**:
   - Litrico, X. & Fromion, V. (2009). *Modeling and Control of Hydrosystems*
   - Schuurmans, J. (1997). *Control of Water Levels in Open Channels* (PhD thesis)

4. **时滞补偿**:
   - Smith Predictor
   - Internal Model Control (IMC)

### 10.3 工程规范

5. 《灌溉与排水工程设计标准》GB 50288-2018
6. 《渠系建筑物设计规范》SL 482-2011

---

## 11. 常见问题（FAQ）

**Q1: 为什么控制周期是60s，不是1s？**
A: 渠道系统时间常数大（数百秒），水流传播慢。过快的控制不仅无效，还会引起振荡。

**Q2: 如何处理传感器故障？**
A:
- 使用模型预测值作为备份
- 相邻渠段传感器冗余
- 故障检测算法（残差分析）

**Q3: 闸门机械故障怎么办？**
A:
- 检测闸门位置反馈与指令偏差
- 超过阈值切换到手动模式
- 报警通知运维人员

**Q4: 下游用水需求突然增大，如何快速响应？**
A:
- 前馈控制：根据需求预测提前调节
- 增大比例增益Kp（但会降低稳定裕度）
- 多级泵站协同（上游提前增加供水）

**Q5: 冬季冰冻期如何控制？**
A:
- 降低控制频率（减少闸门动作）
- 水位略高运行（防止结冰堵塞）
- 避免大流量变化（防止冰块冲击）

---

## 12. 下一步学习

完成本案例后，建议继续学习：

- **案例2**：多点反馈分布式PID控制
- **案例3**：前馈-反馈复合控制
- **案例5**：串级池系统控制

---

**案例难度**: ⭐⭐ (入门级)
**预计学习时间**: 4-6小时
**编程难度**: 中等
**数学要求**: 偏微分方程基础、控制理论基础

---

**最后更新**: 2025-10-30
**作者**: Claude
**版本**: v1.0
