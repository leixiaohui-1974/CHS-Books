# 案例12：MODFLOW River包实现

**难度**: ⭐⭐⭐⭐  
**前置案例**: 案例11  
**预计学习时间**: 5-7小时

---

## 📚 学习目标

通过本案例，你将学会：

1. ✅ 掌握MODFLOW River包的完整功能
2. ✅ 建立二维河流网络模型
3. ✅ 管理多河段和多河流
4. ✅ 统计和分析河流通量
5. ✅ 评估河流参数敏感性
6. ✅ 应用于实际工程问题

---

## 🎯 物理背景

### MODFLOW River包

MODFLOW River包（RIV Package）是最常用的地表水-地下水交互边界条件之一，广泛应用于：

1. **水资源评估**：
   - 河流对地下水的补给量
   - 地下水开采对河流的影响
   - 基流分析

2. **生态保护**：
   - 维持河流最小生态流量
   - 湿地水源分析
   - 河岸带生态需水

3. **污染控制**：
   - 河流-地下水污染传输
   - 污染物迁移模拟
   - 修复方案设计

### 与案例11的区别

| 特征 | 案例11 | 案例12 |
|------|--------|--------|
| 维度 | 一维 | 二维 |
| 河流数量 | 单条 | 多条（网络） |
| 河段管理 | 单点 | 多河段 |
| 通量统计 | 简单 | 分河段统计 |
| 应用场景 | 理论学习 | 工程实践 |

---

## 📐 理论基础

### 1. MODFLOW River包公式

**对于每个河流单元**：

```
当 h_gw > RBOT:
    Q_river = CRIV * (HRIV - h_gw)

当 h_gw ≤ RBOT:
    Q_river = CRIV * (HRIV - RBOT)
```

**参数定义**：
- `HRIV` (Stage): 河流水位 (m)
- `CRIV` (Conductance): 水力传导度 (m²/day)
- `RBOT` (Bottom): 河底高程 (m)
- `h_gw`: 地下水水头 (m)
- `Q_river`: 交换通量 (m³/day)

### 2. 水力传导度计算

**基本公式**：

```
CRIV = K_bed * L * W / b_bed
```

其中：
- `K_bed`: 河床渗透系数 (m/day)
- `L`: 河段长度 (m)
- `W`: 河宽 (m)
- `b_bed`: 河床厚度 (m)

**实际估算**：

对于模型单元：
```
CRIV = K_bed * (dx或dy) * W / b_bed
```

**典型值范围**：

| 河床类型 | K_bed (m/day) | b_bed (m) | CRIV (m²/day) |
|---------|---------------|-----------|---------------|
| 砂砾 | 10-100 | 0.5-2 | 500-10,000 |
| 砂质 | 1-10 | 1-3 | 50-1,000 |
| 淤泥 | 0.01-1 | 2-5 | 1-100 |

### 3. 河流网络表示

**河段（Segment）**：
- 一条河流或河流的一部分
- 具有相似的水力特性
- 便于分组统计和管理

**河道段（Reach）**：
- 河段中的单个模型单元
- 最小的计算单位
- 水位沿河段线性插值

**数据结构**：

```
河流网络
├── 河段1（主河流）
│   ├── Reach 1
│   ├── Reach 2
│   └── ...
├── 河段2（支流1）
│   ├── Reach 1
│   └── ...
└── 河段3（支流2）
    └── ...
```

### 4. 断开机制的重要性

**问题场景**：

假设：
- 河流水位：30m
- 河底高程：25m
- 地下水水头：20m（低于河底！）

**标准公式问题**：
```
Q = CRIV * (30 - 20) = 10 * CRIV
```
通量过大，不符合物理实际！

**断开机制修正**：
```
Q = CRIV * (30 - 25) = 5 * CRIV
```
通量被限制在河流深度范围内。

**物理意义**：
- 地下水位降到河底以下，河流与含水层"断开"
- 河流不能无限制地向下渗漏
- 最大渗漏量受河流深度限制

### 5. 河流水位的确定

**实测数据**：
- 水文站观测
- 遥感反演
- 野外测量

**模型推算**：
- 一维河流水力学模型
- Manning公式
- 流量-水位关系曲线

**简化方法**（本案例）：
- 线性插值：上游→下游
- 考虑河床坡降
- 假设稳定流动

---

## 💻 代码实现

### RiverPackage类

**核心功能**：

1. **添加河流单元**：
```python
riv = RiverPackage(name='RiverNetwork')

riv.add_river_cell(
    layer=0, row=5, col=10,
    stage=30.0,
    conductance=1000.0,
    bottom=20.0,
    segment_id=1
)
```

2. **添加河流河段**：
```python
# 定义河段路径
cells = [(row, col) for ... ]

riv.add_river_segment(
    cells=cells,
    stage_start=33.0,    # 上游水位
    stage_end=31.0,      # 下游水位
    conductance=1000.0,
    bottom=25.0,
    segment_id=1
)
```

3. **计算通量**：
```python
# 所有单元通量
fluxes = riv.compute_flux(head=h_gw, use_disconnection=True)

# 总通量
total_flux = riv.get_total_flux(h_gw)

# 分河段通量
seg_flux = riv.get_segment_flux(segment_id=1, head=h_gw)
```

4. **统计分析**：
```python
stats = riv.get_segment_statistics(h_gw)

for seg_id, info in stats.items():
    print(f"河段 {seg_id}:")
    print(f"  总通量: {info['total_flux']:.2f} m³/day")
    print(f"  平均通量: {info['avg_flux']:.2f} m³/day/cell")
```

5. **应用为源汇项**：
```python
# 将河流通量转换为源汇项
source = riv.apply_flux_to_source(
    head=h_gw,
    cell_volume=cell_volumes,
    use_disconnection=True
)

# source 的shape与head相同
# 可以直接用于地下水求解器
```

### 河流网络设计

**本案例的河流系统**：

```
        北支流 (Segment 2)
            ↓
            ↓
西 → 主河流 (Segment 1) → 东
            ↑
            ↑
        南支流 (Segment 3)
```

**代码实现**：

```python
# 主河流：沿 y = ny//2, 从西到东
main_cells = [(ny//2, col) for col in range(nx)]
riv.add_river_segment(
    cells=main_cells,
    stage_start=33.0,  # 西边（上游）
    stage_end=31.0,    # 东边（下游）
    conductance=1000.0,
    bottom=25.0,
    segment_id=1  # 主河流
)

# 北支流：沿 x = nx//3, 从北到主河流
north_cells = [(row, nx//3) for row in range(ny//2, ny)]
riv.add_river_segment(
    cells=north_cells,
    stage_start=32.0,   # 汇流点
    stage_end=33.5,     # 北边（上游）
    conductance=500.0,
    bottom=26.0,
    segment_id=2  # 北支流
)

# 南支流：类似
```

### 弱耦合求解

**算法流程**：

```python
for iteration in range(max_iter):
    # 1. 计算河流源汇项
    river_source = riv.apply_flux_to_source(h, cell_volume)
    
    # 2. 总源汇项
    total_source = recharge + river_source
    
    # 3. 求解地下水
    h_new = solve_groundwater(h, total_source)
    
    # 4. 检查收敛
    if converged(h_new, h):
        break
    
    h = h_new
```

---

## 📊 运行案例

### 执行命令

```bash
cd code/examples/case_12
python3 case_12_river_package.py
```

### 预期输出

```
============================================================
案例12：MODFLOW River包实现
============================================================

模型设置：
  区域: 2000m × 1500m
  网格: 41 × 31
  渗透系数: 15 m/day
  含水层厚度: 25 m

创建河流网络...
============================================================

主河流（Segment 1）：
  位置: 沿着 row = 15
  水位: 33.0 → 31.0 m
  传导度: 6.25e+03 m²/day

北支流（Segment 2）：
  位置: 沿着 col = 13
  水位: 33.5 → 32.0 m
  传导度: 7.50e+02 m²/day

南支流（Segment 3）：
  位置: 沿着 col = 27
  水位: 33.5 → 32.0 m
  传导度: 7.50e+02 m²/day

河流网络摘要：
  总单元数: 88
  河段数: 3
  水位范围: 31.0 - 33.5 m

求解地下水流动（含河流边界）
============================================================

开始弱耦合迭代...
  迭代 0: 误差 = 2.35e-01
  迭代 10: 误差 = 1.82e-03
  迭代 20: 误差 = 1.45e-04

✓ 收敛! 迭代次数: 28
  最终误差: 9.87e-06

地下水结果：
  最大水头: 33.45 m
  最小水头: 30.12 m
  平均水头: 32.18 m

河流交换：
  总交换通量: 12,458.32 m³/day

河流通量分析
============================================================

分河段统计：

主河流（Segment 1）：
  单元数: 41
  总通量: 9,234.56 m³/day
  平均通量: 225.23 m³/day/cell
  最大通量: 285.47 m³/day/cell
  最小通量: 168.92 m³/day/cell
  类型: 河流补给地下水

北支流（Segment 2）：
  单元数: 24
  总通量: 1,847.23 m³/day
  平均通量: 76.97 m³/day/cell
  最大通量: 95.32 m³/day/cell
  最小通量: 58.14 m³/day/cell
  类型: 河流补给地下水

南支流（Segment 3）：
  单元数: 23
  总通量: 1,376.53 m³/day
  平均通量: 59.85 m³/day/cell
  最大通量: 78.26 m³/day/cell
  最小通量: 42.19 m³/day/cell
  类型: 河流补给地下水

✅ 案例12执行完成！
```

### 生成图片

程序会生成 `case_12_river_package_results.png`，包含8个子图：

1. **水头等值线 + 河流网络**
2. **河流单元交换通量分布**
3. **分河段总通量柱状图**
4. **分河段平均单元通量**
5. **通量范围（最大/最小/平均）**
6. **敏感性：传导度 vs 总通量**
7. **敏感性：分河段通量**
8. **敏感性：传导度 vs 水头**

---

## 📈 结果分析

### 1. 河流网络效应

**观察**：
- 主河流：最大补给源，~9,200 m³/day
- 两条支流：各补给~1,400-1,850 m³/day
- 河流网络总补给：~12,500 m³/day

**水头分布特征**：
- 河流附近：水头隆起
- 主河流影响最显著
- 支流影响局部
- 交汇处：相互作用

### 2. 通量空间变异

**主河流沿程变化**：
- 上游（西侧）：通量较大（~285 m³/day/cell）
- 下游（东侧）：通量较小（~169 m³/day/cell）

**原因分析**：
1. **水位差变化**：
   - 上游河流水位高，水头差大
   - 下游河流水位低，水头差小

2. **地下水流动**：
   - 西边界水头高（35m）
   - 东边界水头低（30m）
   - 地下水总体向东流动

### 3. 支流对比

**北支流 vs 南支流**：
- 北支流：总通量更大（1,847 vs 1,377 m³/day）
- 北支流：单元通量更大（77 vs 60 m³/day/cell）

**可能原因**：
- 北边界水头略高（33 vs 32m）
- 北部区域地下水位相对较低
- 地形或参数差异

### 4. 敏感性分析结果

**传导度-通量关系**：
```
C = 0.5×原值 → Q ≈ 0.5×原值
C = 2.0×原值 → Q ≈ 2.0×原值
C = 5.0×原值 → Q ≈ 5.0×原值
```

**线性关系**：
- 通量正比于传导度
- 斜率接近1
- 符合理论预期：Q = C × Δh

**水头响应**：
- 传导度增加 → 河流补给增加 → 水头升高
- 但水头变化相对较小
- 因为边界条件限制了总体水头分布

---

## 🔬 实验探索

### 实验1：改变河流水位

**目标**：评估河流水位对地下水的影响

```python
# 修改主河流水位
for stage in [31.0, 33.0, 35.0, 37.0]:
    riv.update_stage(stage, segment_id=1)
    # 重新求解并分析
```

**预期**：
- 水位越高，补给越多
- 地下水水头相应升高
- 影响范围扩大

### 实验2：河流断开情景

**目标**：模拟地下水过度开采导致河流断开

```python
# 降低地下水水头
h_pumping = h - 10.0  # 模拟大量抽水

# 对比断开前后
flux_normal = riv.compute_flux(h, use_disconnection=False)
flux_disconnected = riv.compute_flux(h_pumping, use_disconnection=True)
```

**预期**：
- 无断开机制：通量继续线性增大（不合理）
- 有断开机制：通量被限制（合理）

### 实验3：支流移除

**目标**：评估支流的贡献

```python
# 只保留主河流
riv_main_only = RiverPackage()
# 只添加主河流河段
riv_main_only.add_river_segment(...)

# 对比全网络 vs 仅主河流
```

**预期**：
- 总通量减少~25-30%
- 局部区域水头显著降低
- 支流影响区域明显

### 实验4：河床淤积模拟

**目标**：模拟河床淤积降低渗透性

```python
# 模拟淤积：降低河床K
for cell in riv.river_cells:
    if cell.segment_id == 1:  # 主河流
        # 传导度减半（模拟淤积）
        cell.conductance *= 0.5
```

**预期**：
- 主河流通量减少
- 支流相对重要性增加
- 总体水头略有降低

---

## 🤔 常见问题

### Q1: 如何确定河流参数？

**A**: 分层次确定：

1. **河流水位（HRIV）**：
   - 最理想：实测数据
   - 次优：水文模型推算
   - 简化：经验公式

2. **河底高程（RBOT）**：
   - 实测：断面测量
   - 估算：水位 - 典型河深
   - 通常比河流水位低5-10m

3. **传导度（CRIV）**：
   - 计算：CRIV = K_bed * L * W / b_bed
   - 经验值：参考文献
   - 率定：反演优化（最推荐）

### Q2: 河段如何划分？

**A**: 划分原则：

1. **水力特性相似**：
   - 河宽、河深相近
   - 河床类型一致

2. **管理需求**：
   - 按行政区划
   - 按功能区（如取水口上下游）

3. **模型需求**：
   - 分别统计通量
   - 不同参数设置

**实际操作**：
- 主河流：1-3个河段
- 支流：各1个河段
- 总计：5-10个河段（典型）

### Q3: 为什么需要迭代？

**A**: 因为耦合的非线性：

1. **河流通量依赖地下水水头**
2. **地下水水头受河流通量影响**
3. **两者相互依赖，需要迭代求解**

类比：
- 鸡和蛋的问题
- 需要迭代找到一致解
- 类似牛顿迭代求根

### Q4: 收敛困难怎么办？

**A**: 诊断和解决：

1. **检查参数合理性**：
   - 传导度是否过大？
   - 水位是否合理？

2. **调整数值参数**：
   - 减小时间步（瞬态）
   - 使用松弛因子
   - 增加最大迭代次数

3. **改进初值**：
   - 先求解无河流情况
   - 逐步增加河流影响

4. **检查网格**：
   - 河流单元附近加密
   - 避免网格突变

### Q5: 如何处理季节性河流？

**A**: 动态调整：

**枯水期**：
```python
# 河流水位降低，可能断流
for cell in riv.river_cells:
    cell.stage = low_stage
    # 或者直接移除部分河流单元
```

**丰水期**：
```python
# 河流水位升高，淹没范围扩大
for cell in riv.river_cells:
    cell.stage = high_stage
    # 可能需要添加额外单元
```

**实用建议**：
- 建立多个River包对象
- 根据季节切换
- 或动态更新参数

---

## 📚 扩展阅读

### MODFLOW文档

1. **Prudic (1989)**. "Documentation of a computer program to simulate stream-aquifer relations using a modular, finite-difference, ground-water flow model"
   - River包的原始文档
   - 详细算法说明

2. **Harbaugh (2005)**. "MODFLOW-2005 Manual"
   - 现代版本参考
   - 输入文件格式

3. **Langevin et al. (2017)**. "MODFLOW 6 Documentation"
   - 最新版本
   - 高级功能

### 应用案例

1. **美国地质调查局（USGS）案例研究**
   - 各流域应用实例
   - 参数率定经验

2. **FloPy示例**
   - Python MODFLOW接口
   - 自动化建模

### 进阶主题

1. **案例13**：渗漏与越流 - 多层系统
2. **案例14**：耦合模型率定 - 参数优化
3. **案例15**：耦合系统不确定性 - 风险评估

---

## ✅ 学习检查

完成本案例后，你应该能够：

- [ ] 理解MODFLOW River包的原理和公式
- [ ] 创建和管理河流网络
- [ ] 添加多个河段和支流
- [ ] 计算和统计河流通量
- [ ] 分析河流对地下水的影响
- [ ] 进行参数敏感性分析
- [ ] 处理河流断开机制
- [ ] 应用于实际工程问题

---

## 🚀 下一步

- **案例13**: 渗漏与越流模拟 - 三维多层系统
- **案例14**: 耦合模型率定 - 河流参数优化
- **案例15**: 耦合系统不确定性 - 预测可靠性

---

**完成本案例？恭喜！你已掌握MODFLOW River包的完整功能！** 🎉

现在你可以：
1. 建立复杂河流网络模型
2. 定量分析河流-地下水交互
3. 评估河流参数影响
4. 应用于水资源管理

**Happy Modeling! 💧🌊**
