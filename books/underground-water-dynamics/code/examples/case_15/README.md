# 案例15：耦合系统不确定性分析

**难度**: ⭐⭐⭐⭐⭐  
**前置案例**: 案例10, 案例14  
**预计学习时间**: 6-8小时

---

## 📚 学习目标

通过本案例，你将学会：

1. ✅ 识别耦合系统的不确定性来源
2. ✅ 应用Monte Carlo方法量化不确定性
3. ✅ 使用GLUE方法识别行为参数集
4. ✅ 估计预测区间和置信区间
5. ✅ 分解不确定性贡献
6. ✅ 对比不同不确定性方法
7. ✅ 评估预测可靠性

---

## 🎯 物理背景

### 为什么需要不确定性分析？

**现实问题**：
- 参数测量有误差
- 观测数据不充分
- 模型简化假设
- 未来情景不确定

**风险决策**：
- 水资源规划需要置信区间
- 生态保护需要风险评估
- 工程设计需要安全裕度

**科学诚实**：
- 报告预测不确定性
- 避免过度自信
- 提供决策支持

### 耦合系统的特殊性

**不确定性来源更多**：
1. **含水层参数**（K, S, ...）
2. **河流参数**（传导度, 河床K, ...）
3. **耦合参数**（越流系数, ...）
4. **边界条件**
5. **模型结构**（耦合方式选择）

**传播更复杂**：
- 地下水不确定性 ↔ 河流不确定性
- 层间越流放大/抑制不确定性
- 非线性耦合效应

---

## 📐 理论基础

### 1. 不确定性分类

**参数不确定性**：
```
θ ~ P(θ)  (参数分布)
  ↓
y = f(θ)  (模型)
  ↓
y ~ P(y)  (预测分布)
```

**观测不确定性**：
```
y_obs = y_true + ε
ε ~ N(0, σ²)
```

**模型不确定性**：
```
y_true = f(θ) + δ
δ: 模型误差
```

**总不确定性**：
```
Var(y) = Var_param(y) + Var_obs + Var_model
```

### 2. Monte Carlo方法

**基本原理**：
```
1. 定义参数分布：θ ~ P(θ)
2. 采样：θ₁, θ₂, ..., θₙ
3. 运行模型：yᵢ = f(θᵢ), i=1,...,n
4. 统计分析：均值、方差、百分位数
```

**优点**：
- 简单直观
- 适用任何模型
- 无模型假设

**缺点**：
- 计算量大
- 需要定义参数分布
- 可能忽略极端情况

### 3. GLUE方法

**核心思想**：
并非所有参数组合都"可接受"，只有那些能合理拟合观测数据的参数集才是"行为的"。

**算法**：
```
1. Monte Carlo采样：θ₁, ..., θₙ
2. 计算似然：L(θᵢ) = f(y_obs, y_sim(θᵢ))
3. 定义阈值：L_threshold
4. 识别行为集：{θᵢ : L(θᵢ) > L_threshold}
5. 仅用行为集进行预测
```

**似然函数示例**：
```
L(θ) = exp(-0.5 * Σ((y_obs - y_sim(θ))/σ)²)
```

**优点**：
- 考虑观测约束
- 拒绝不合理参数
- 更现实的不确定性估计

**缺点**：
- 似然函数选择主观
- 阈值选择影响结果
- 计算量仍然大

### 4. 预测区间

**定义**：
包含未来观测值的概率区间。

**估计方法**：

1. **百分位数法**：
   ```
   95%预测区间 = [P₂.₅, P₉₇.₅]
   ```

2. **正态近似**（如果适用）：
   ```
   95%PI = ȳ ± 1.96 * σ_y
   ```

**置信水平**：
- 50%: 中位数区间
- 68%: 1σ区间（正态）
- 95%: 常用区间
- 99%: 高置信区间

### 5. 不确定性分解

**目标**：识别主要不确定性来源

**方差分解**：
```
Var(y) = Var_θ₁(E[y|θ₂,...]) + Var_θ₂(E[y|θ₁,...]) + ...
```

**简化方法**（本案例）：
```
1. 仅变化K → Var_K
2. 仅变化C → Var_C
3. 总方差 = Var_total
4. 交互 = Var_total - Var_K - Var_C
```

**应用**：
- 识别关键参数
- 指导数据收集
- 优先减小主要来源

---

## 💻 代码实现

### Monte Carlo实现

```python
# 1. 定义参数分布
K_mean, K_std = 20.0, 3.0
C_mean, C_std = 1200.0, 200.0

# 2. 采样
np.random.seed(42)
K_samples = np.random.normal(K_mean, K_std, 1000)
C_samples = np.random.normal(C_mean, C_std, 1000)

# 参数约束
K_samples = np.clip(K_samples, 5.0, 50.0)
C_samples = np.clip(C_samples, 300.0, 3000.0)

# 3. 运行模型
predictions = []
for K, C in zip(K_samples, C_samples):
    h, flux = solve_coupled_model(params, K, C)
    predictions.append(flux)

predictions = np.array(predictions)

# 4. 统计分析
mean = np.mean(predictions)
std = np.std(predictions)
ci_95 = [np.percentile(predictions, 2.5),
         np.percentile(predictions, 97.5)]
```

### GLUE实现

```python
# 1. 计算似然
flux_obs = 8500.0
sigma = 100.0
residuals = predictions - flux_obs
likelihoods = np.exp(-0.5 * (residuals / sigma)**2)

# 归一化
likelihoods = likelihoods / np.sum(likelihoods)

# 2. 定义阈值（如前10%）
threshold = np.percentile(likelihoods, 90)

# 3. 识别行为参数集
behavioral = likelihoods >= threshold

# 4. 行为集统计
K_behavioral = K_samples[behavioral]
predictions_behavioral = predictions[behavioral]

# 5. GLUE预测区间
glue_ci_95 = [
    np.percentile(predictions_behavioral, 5),
    np.percentile(predictions_behavioral, 95)
]
```

### 不确定性分解

```python
# 1. 仅K变化（C固定在均值）
flux_K_only = []
for K in K_samples_subset:
    _, flux = solve_coupled_model(params, K, C_mean)
    flux_K_only.append(flux)

var_K = np.var(flux_K_only)

# 2. 仅C变化（K固定在均值）
flux_C_only = []
for C in C_samples_subset:
    _, flux = solve_coupled_model(params, K_mean, C)
    flux_C_only.append(flux)

var_C = np.var(flux_C_only)

# 3. 总方差
var_total = np.var(predictions)

# 4. 交互方差
var_interaction = var_total - var_K - var_C

# 5. 贡献率
contribution_K = var_K / var_total * 100
contribution_C = var_C / var_total * 100
```

---

## 📊 运行案例

### 执行命令

```bash
cd code/examples/case_15
python3 case_15_coupled_uncertainty.py
```

### 预期输出

```
============================================================
案例15：耦合系统不确定性分析
============================================================

设置耦合模型
============================================================
模型设置：
  区域: 2000m × 1500m
  网格: 41 × 31

Monte Carlo不确定性分析
============================================================

采样数: 1000

参数分布：
  K ~ N(20.0, 3.0²) m/day
  河流传导度 ~ N(1200.0, 200.0²) m²/day

开始Monte Carlo模拟...
  进度: 0/1000
  进度: 200/1000
  进度: 400/1000
  进度: 600/1000
  进度: 800/1000

完成! 成功模拟: 998/1000

预测统计：

点A (15, 20):
  均值: 32.45 m
  标准差: 0.35 m
  95%CI: [31.78, 33.12] m

点B (20, 15):
  均值: 32.18 m
  标准差: 0.42 m
  95%CI: [31.38, 32.98] m

点C (10, 25):
  均值: 32.67 m
  标准差: 0.38 m
  95%CI: [31.95, 33.39] m

河流通量:
  均值: 8523.45 m³/day
  标准差: 324.56 m³/day
  95%CI: [7905.23, 9141.67] m³/day

GLUE方法分析
============================================================

观测河流通量: 8500.00 m³/day

定义似然函数...

似然阈值: 0.000985
行为参数集数量: 100/998
行为参数集比例: 10.0%

行为参数集范围：
  K: [17.23, 22.87] m/day
  河流传导度: [1015.34, 1384.92] m²/day

GLUE预测区间（河流通量）：
  5%-95%: [8102.34, 8897.56] m³/day

预测区间分析
============================================================

河流通量预测区间：
置信水平    下界            上界            区间宽度       
------------------------------------------------------------
50%        8345.23         8701.34         356.11         
68%        8198.89         8847.91         649.02         
90%        8011.45         9035.45         1024.00        
95%        7905.23         9141.67         1236.44        
99%        7702.11         9344.79         1642.68        

不确定性分解
============================================================

计算仅K参数不确定性...
计算仅河流参数不确定性...

方差分解：
  K贡献: 68234.56 (65.2%)
  河流传导度贡献: 28456.23 (27.2%)
  交互作用: 7945.67 (7.6%)
  总方差: 104636.46

✅ 案例15执行完成！

🎉🎉🎉 第三篇全部完成！🎉🎉🎉
```

### 生成图片

程序会生成 `case_15_coupled_uncertainty_results.png`，包含9个子图：

1. **参数空间采样**（全部+行为参数集）
2. **河流通量预测分布**（MC vs GLUE）
3. **预测区间宽度 vs 置信水平**
4. **地下水水头预测分布（点A）**
5. **不同预测点的不确定性对比**
6. **GLUE似然分布**
7. **不确定性来源分解（饼图）**
8. **单参数不确定性贡献对比**
9. **累积分布函数（CDF）**

---

## 📈 结果分析

### 1. Monte Carlo结果

**河流通量**：
- 均值：~8,523 m³/day
- 标准差：~325 m³/day
- 95%CI: [7,905, 9,142] m³/day
- 相对不确定性：±7.5%

**地下水水头**：
- 不确定性：0.35-0.42 m
- 相对较小
- 不同位置略有差异

**解释**：
- 参数不确定性传播到预测
- 河流通量不确定性适中
- 可接受的预测精度

### 2. GLUE结果

**行为参数集**：
- 数量：~100个（10%）
- K范围：[17.2, 22.9] m/day
- C范围：[1015, 1385] m²/day

**对比Monte Carlo**：
- GLUE区间更窄
- 因为只用了行为参数集
- 更符合观测约束

**预测区间**：
- 5%-95%: [8,102, 8,898] m³/day
- 比MC的95%CI窄
- 观测信息的价值

### 3. 预测区间分析

**区间宽度随置信水平增加**：
- 50%: 356 m³/day
- 95%: 1,236 m³/day
- 99%: 1,643 m³/day

**选择建议**：
- 95%: 常用，平衡置信和宽度
- 99%: 高风险项目
- 50%: 最可能范围

### 4. 不确定性分解

**发现**：
- K贡献：65%
- 河流传导度贡献：27%
- 交互作用：8%

**含义**：
1. **K是主导因素**：
   - 改善K的估计最有效
   - 优先收集含水层数据

2. **河流参数次要**：
   - 但仍显著（27%）
   - 不能忽略

3. **交互作用小**：
   - 参数相对独立
   - 线性近似合理

**决策**：
- 如需减小不确定性，优先提高K的精度
- 河流参数也需要关注
- 两者都重要

### 5. 方法对比

| 特征 | Monte Carlo | GLUE |
|------|-------------|------|
| 原理 | 参数分布采样 | 行为参数集 |
| 约束 | 仅先验 | 先验+观测 |
| 区间宽度 | 较宽 | 较窄 |
| 计算量 | 大 | 大 |
| 主观性 | 中（分布选择） | 高（似然+阈值） |

**使用建议**：
- Monte Carlo: 仅有先验信息
- GLUE: 有观测数据
- 两者结合: 最全面

---

## 🔬 实验探索

### 实验1: 采样数量影响

**目标**：评估所需的Monte Carlo采样数

```python
sample_sizes = [100, 500, 1000, 2000, 5000]

for n in sample_sizes:
    # 运行Monte Carlo
    predictions = monte_carlo_analysis(n_samples=n)
    
    # 计算统计量
    mean = np.mean(predictions)
    ci_95 = np.percentile(predictions, [2.5, 97.5])
    
    # 对比收敛性
```

**预期**：
- n小（<500）：统计量不稳定
- n适中（1000-2000）：合理精度
- n大（>5000）：边际收益递减

### 实验2: 参数分布影响

**目标**：对比不同参数分布假设

```python
distributions = {
    'normal': stats.norm(20, 3),
    'lognormal': stats.lognorm(s=0.15, scale=20),
    'uniform': stats.uniform(15, 10)  # [15, 25]
}

for dist_name, dist in distributions.items():
    K_samples = dist.rvs(1000)
    # 分析差异
```

**预期**：
- 正态：对称，常用
- 对数正态：右偏，适合K（必须正）
- 均匀：保守，最大不确定性

### 实验3: GLUE阈值影响

**目标**：评估阈值选择的影响

```python
percentiles = [70, 80, 90, 95]  # 对应阈值

for p in percentiles:
    threshold = np.percentile(likelihoods, p)
    behavioral = likelihoods >= threshold
    
    # 分析行为集数量和预测区间
```

**预期**：
- 阈值高（p大）→ 行为集小 → 区间窄
- 阈值低（p小）→ 行为集大 → 区间宽
- 需要平衡

### 实验4: 不同预测目标

**目标**：对比不同预测目标的不确定性

```python
targets = {
    'head_point': 某点水头,
    'head_average': 区域平均水头,
    'river_flux': 河流通量,
    'water_balance': 水量平衡
}

for target in targets:
    # 计算不确定性
    # 对比相对不确定性
```

**预期**：
- 局部预测：不确定性大
- 平均/积分：不确定性小（平滑效应）
- 河流通量：中等不确定性

---

## 🤔 常见问题

### Q1: 如何选择参数分布？

**A**: 分层次：

1. **有充分数据**：
   - 拟合分布（正态、对数正态等）
   - 统计检验

2. **有部分数据**：
   - 正态分布（最常用）
   - 均值=最佳估计，标准差=不确定性

3. **仅有范围**：
   - 均匀分布（保守）
   - 或三角分布（中心值可能性大）

4. **参数物理性质**：
   - K: 对数正态（必须正，右偏）
   - 水位: 正态（对称）

### Q2: Monte Carlo需要多少样本？

**A**: 取决于目标：

**粗略估计**：
- 100-500个：初步探索
- 结果可能不稳定

**常规分析**：
- 1000-2000个：推荐
- 95%CI相对稳定

**高精度**：
- 5000-10000个：精细分析
- 计算量大，边际收益小

**判断收敛**：
- 重复多次，结果相似→收敛
- 绘制统计量vs样本数曲线

### Q3: GLUE阈值如何选？

**A**: 多种策略：

1. **百分位数**：
   - 前10%（常用）
   - 前5%（严格）
   - 前20%（宽松）

2. **绝对阈值**：
   - 基于似然值
   - 需要领域知识

3. **交叉验证**：
   - 留一法
   - 选择最佳预测性能的阈值

4. **实用建议**：
   - 10%是良好起点
   - 分析阈值敏感性
   - 报告多个阈值结果

### Q4: 如何减小预测不确定性？

**A**: 系统方法：

1. **改善参数估计**：
   - 增加观测数据
   - 提高测量精度
   - 参数率定

2. **约简参数**：
   - 固定次要参数
   - 分区均质化
   - 减少自由度

3. **改进模型**：
   - 更精细网格
   - 更真实物理过程
   - 减少模型误差

4. **贝叶斯方法**：
   - 利用先验信息
   - 观测数据更新
   - 综合多源信息

5. **集合方法**：
   - 多模型集合
   - 减小模型不确定性

### Q5: 不确定性分析的局限？

**A**: 需要认识到：

1. **计算成本**：
   - Monte Carlo需要大量模型运行
   - 复杂模型可能不可行

2. **假设依赖**：
   - 参数分布假设
   - 独立性假设
   - 模型正确性假设

3. **不完整性**：
   - 仅量化已知不确定性
   - 未知的未知（unknowns）
   - 结构不确定性难以量化

4. **主观性**：
   - GLUE的似然函数和阈值
   - 分布选择
   - 权重选择

**应对**：
- 敏感性分析
- 多方法对比
- 保守估计
- 诚实报告局限

---

## 📚 扩展阅读

### 不确定性分析经典文献

1. **Beven & Binley (1992)**. "The future of distributed models: Model calibration and uncertainty prediction"
   - GLUE方法的原始文献
   - 奠基性工作

2. **Refsgaard et al. (2007)**. "Uncertainty in the environmental modelling process"
   - 不确定性系统综述
   - 分类框架

3. **Beven (2016)**. "Facets of uncertainty"
   - 不确定性哲学思考
   - 深刻见解

### 高级方法

1. **贝叶斯方法**（见案例8）：
   - MCMC采样
   - 后验分布
   - 更严格的概率框架

2. **全局敏感性**（见案例9）：
   - Sobol分析
   - 方差分解
   - 参数交互

3. **集合方法**：
   - 多模型集合
   - 权重平均
   - 减小模型不确定性

### 软件工具

1. **PyMC3 / PyMC**：
   - 贝叶斯建模
   - MCMC采样
   - 强大的不确定性工具

2. **SALib**：
   - 敏感性分析库
   - Sobol, Morris等
   - Python实现

3. **SPOTPY**：
   - 校准和不确定性
   - 多种算法
   - 易于使用

---

## ✅ 学习检查

完成本案例后，你应该能够：

- [ ] 识别耦合系统的不确定性来源
- [ ] 实现Monte Carlo不确定性分析
- [ ] 应用GLUE方法
- [ ] 估计预测区间
- [ ] 分解不确定性贡献
- [ ] 对比不同方法的优缺点
- [ ] 评估预测的可靠性
- [ ] 为决策提供不确定性信息
- [ ] 设计减小不确定性的策略

---

## 🎊 第三篇完成总结

**恭喜！完成案例15，第三篇全部完成！**

你已经掌握了：
- ✅ 地表地下水耦合理论
- ✅ MODFLOW River包
- ✅ 多层系统越流
- ✅ 耦合模型率定
- ✅ 不确定性量化

**完整的耦合建模能力**！

---

## 🚀 下一步

**第四篇：人类活动影响评估**（案例16-18）

将学习：
- 抽水井模拟
- 地下水开采评估
- 管理策略优化

**继续前进！** 🎉💧

---

**Happy Modeling! 💧📊**
