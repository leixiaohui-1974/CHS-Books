# 案例14：耦合模型率定

**难度**: ⭐⭐⭐⭐⭐  
**前置案例**: 案例6-10, 案例11-13  
**预计学习时间**: 6-8小时

---

## 📚 学习目标

通过本案例，你将学会：

1. ✅ 率定地表地下水耦合模型参数
2. ✅ 联合使用多类型观测数据
3. ✅ 分析参数可识别性
4. ✅ 评估参数敏感性
5. ✅ 量化参数不确定性
6. ✅ 验证率定结果质量

---

## 🎯 物理背景

### 为什么要率定耦合模型？

**挑战**：
1. **参数更多**：
   - 含水层参数（K, S）
   - 河流参数（传导度, 河床K）
   - 多层系统（越流系数）

2. **观测类型多样**：
   - 地下水水位
   - 河流流量/水位
   - 地表地下水交换通量

3. **参数相关性**：
   - 含水层K ↔ 河流传导度
   - 不同参数可能产生相似响应
   - 可识别性问题

### 实际应用

**水资源管理**：
- 评估河流对地下水补给
- 预测抽水对河流的影响
- 优化取水方案

**生态保护**：
- 维持河流生态流量
- 评估地下水开采影响
- 设计生态补水方案

**污染控制**：
- 分析污染物迁移路径
- 评估修复方案效果
- 风险评估

---

## 📐 理论基础

### 1. 耦合模型率定框架

**目标函数**：

```
minimize J(θ) = Σ w_i (h_obs,i - h_sim,i)² + w_r (Q_obs - Q_sim)²
```

其中：
- `θ = [K, C_river, ...]`: 参数向量
- `h_obs, h_sim`: 观测和模拟地下水水头
- `Q_obs, Q_sim`: 观测和模拟河流通量
- `w_i, w_r`: 权重

**关键**：
1. **多类型观测**：地下水+河流数据
2. **权重选择**：平衡不同数据类型
3. **参数约束**：物理合理范围

### 2. 参数可识别性

**定义**：
参数是否能从观测数据中唯一确定。

**分类**：

1. **结构可识别性**：
   - 理论上能否确定
   - 与模型结构有关

2. **实践可识别性**：
   - 实际观测能否确定
   - 与数据质量、数量有关

**判断方法**：

1. **敏感性分析**：
   - 敏感性高 → 可识别性好
   - 敏感性低 → 难以识别

2. **相关性分析**：
   - 参数相关性高 → 难以分离
   - 相关性低 → 可独立识别

3. **后验分布**：
   - 分布窄 → 约束好
   - 分布宽 → 不确定性大

### 3. 观测权重选择

**原则**：

1. **单位一致性**：
   ```
   w_i ∝ 1 / (观测误差标准差)²
   ```

2. **数量平衡**：
   - 避免某类观测主导
   - 考虑样本数量

3. **置信度**：
   - 高精度观测 → 高权重
   - 不确定观测 → 低权重

**实例**：
```python
# 地下水水位（误差~0.1m）
w_head = 1 / 0.1**2 = 100

# 河流通量（误差~50 m³/day）
w_flux = 1 / 50**2 = 0.0004

# 单位不同，需要归一化
```

### 4. 敏感性分析

**局部敏感性**（Jacobian）：

```
J_ij = ∂y_i / ∂θ_j
```

**物理意义**：
- `J_ij`大：参数`θ_j`对观测`y_i`影响显著
- `J_ij`小：参数影响弱

**应用**：
1. **参数排序**：识别重要参数
2. **观测设计**：选择敏感位置
3. **可识别性**：评估参数区分度

### 5. 不确定性量化

**线性近似**：

参数协方差矩阵：
```
Cov(θ) = σ² (J^T W J)^(-1)
```

其中：
- `σ²`: 观测误差方差
- `J`: Jacobian矩阵
- `W`: 权重矩阵

**置信区间**（95%）：
```
θ ± 1.96 * sqrt(diag(Cov(θ)))
```

**限制**：
- 假设线性
- 假设正态分布
- 仅近似估计

---

## 💻 代码实现

### 主要步骤

**1. 生成"观测"数据**：

```python
# 用真实参数求解
K_true = 20.0
C_true = 1200.0
h_true = solve_coupled_model(params, K_true, C_true)

# 提取观测点
obs_points = [(10, 10), (20, 20), ...]
h_obs = [h_true[row, col] for row, col in obs_points]

# 添加噪声
h_obs += np.random.normal(0, 0.1, len(h_obs))
```

**2. 定义前向模型**：

```python
def forward_model(parameters, params, riv, observations):
    """
    给定参数，运行模型，返回模拟值
    """
    K, river_cond = parameters
    
    # 求解耦合模型
    h = solve_coupled_model(params, riv, K, river_cond)
    
    # 提取观测点
    h_sim = [h[row, col] for row, col in obs_points]
    
    # 计算河流通量
    Q_sim = riv.get_total_flux(h)
    
    return np.array(h_sim + [Q_sim])
```

**3. 定义目标函数**：

```python
def objective(parameters):
    simulated = forward_model(parameters, ...)
    residuals = observed - simulated
    return np.sum((weights * residuals)**2)
```

**4. 优化**：

```python
from scipy.optimize import minimize

result = minimize(
    objective,
    initial_params=[15.0, 800.0],
    method='L-BFGS-B',
    bounds=[(1.0, 100.0), (100.0, 5000.0)]
)

optimized_params = result.x
```

**5. 敏感性分析**：

```python
from gwflow.calibration import compute_jacobian

J = compute_jacobian(forward_model, optimized_params)

# 平均敏感性
sensitivity = np.mean(np.abs(J), axis=0)
```

**6. 不确定性分析**：

```python
# 参数协方差
JtWJ = J.T @ W @ J
param_cov = sigma_squared * np.linalg.inv(JtWJ)

# 标准差
param_std = np.sqrt(np.diag(param_cov))

# 95%置信区间
ci_95 = 1.96 * param_std
```

---

## 📊 运行案例

### 执行命令

```bash
cd code/examples/case_14
python3 case_14_coupled_calibration.py
```

### 预期输出

```
============================================================
案例14：耦合模型率定
============================================================

设置模型和生成观测数据
============================================================

真实参数：
  含水层K: 20.0 m/day
  河流传导度: 1200.0 m²/day

观测数据：
  地下水观测点: 9 个
  地下水水位范围: 31.85 - 33.42 m
  河流通量观测: 8562.34 m³/day

开始参数率定
============================================================

观测数据：
  地下水观测: 9 个
  河流通量观测: 1 个
  总观测数: 10

初始参数：
  K: 15.0 m/day
  河流传导度: 800.0 m²/day

真实参数：
  K: 20.0 m/day
  河流传导度: 1200.0 m²/day

开始优化（L-BFGS-B）...
Iteration 1: f = 125.34
Iteration 5: f = 23.45
Iteration 10: f = 2.87
Iteration 15: f = 0.15
Converged!

率定结果：
  K: 19.87 m/day （真实: 20.00）
  河流传导度: 1195.23 m²/day （真实: 1200.00）

相对误差：
  K: 0.7%
  河流传导度: 0.4%

拟合统计：
  加权RMSE: 0.1234
  目标函数值: 0.1523

敏感性分析
============================================================

Jacobian矩阵 shape: (10, 2)
  行数（观测）: 10
  列数（参数）: 2

平均敏感性：
  K: 0.0856
  河流传导度: 0.0234

参数相关系数矩阵：
[[ 1.     -0.234]
 [-0.234   1.   ]]

K与河流传导度相关性: -0.234

参数不确定性分析
============================================================

残差方差估计: 0.0152

参数标准差估计：
  K: 0.85 m/day
  河流传导度: 45.23 m²/day

95%置信区间：
  K: [18.20, 21.54] m/day
  河流传导度: [1106.54, 1283.92] m²/day

✅ 案例14执行完成！
```

### 生成图片

程序会生成 `case_14_coupled_calibration_results.png`，包含9个子图：

1. **参数率定结果对比**（初始/率定/真实）
2. **地下水水头拟合散点图**（观测vs模拟）
3. **河流通量对比柱状图**
4. **地下水残差分布直方图**
5. **观测点位置和残差分布图**
6. **Jacobian矩阵热图**
7. **参数敏感性对比**
8. **敏感性分布箱线图**
9. **参数相关性矩阵**

---

## 📈 结果分析

### 1. 率定精度

**参数恢复**：
- K: 19.87 vs 20.00 m/day（误差0.7%）
- 河流传导度: 1195 vs 1200 m²/day（误差0.4%）

**结论**：
- 参数恢复精度很高
- 表明参数可识别性好
- 观测信息充足

### 2. 拟合质量

**地下水水头**：
- R² ≈ 0.95+
- 残差均值 ≈ 0
- 残差标准差 < 0.2m

**河流通量**：
- 相对误差 < 1%
- 拟合良好

**结论**：
模型能很好地拟合观测数据

### 3. 参数敏感性

**发现**：
- K的敏感性 > 河流传导度
- 这符合物理直觉（K影响全局，河流仅影响局部）

**含义**：
- K更容易从观测数据中识别
- 河流传导度需要更精确的河流观测

### 4. 参数相关性

**相关系数**：
- K ↔ 河流传导度: -0.234（弱负相关）

**解释**：
- 两参数相对独立
- 可以较好地分离
- 不存在严重的补偿效应

**如果高相关**（如0.9）：
- 参数补偿，难以唯一确定
- 需要更多观测或先验信息
- 可能需要固定某些参数

### 5. 不确定性评估

**置信区间**：
- K: [18.20, 21.54] m/day（±8%）
- 河流传导度: [1107, 1284] m²/day（±7.5%）

**含义**：
- 参数不确定性适中
- 可以接受用于预测
- 如需更精确，增加观测

---

## 🔬 实验探索

### 实验1：观测点数量影响

**目标**：评估观测点数量对率定精度的影响

```python
n_obs_cases = [4, 9, 16, 25]

for n_obs in n_obs_cases:
    # 选择n_obs个观测点
    obs_points = select_observation_points(n_obs)
    
    # 率定
    result = calibrate_model(obs_points)
    
    # 分析精度
```

**预期**：
- 观测点越多，率定精度越高
- 但边际收益递减
- 存在最优观测数量

### 实验2：观测点位置影响

**目标**：分析不同观测点布局的效果

```python
layouts = ['uniform', 'river_focused', 'boundary_focused']

for layout in layouts:
    obs_points = generate_layout(layout)
    # 率定并比较
```

**预期**：
- 河流附近观测更有助于识别河流参数
- 均匀分布有助于识别含水层参数
- 混合布局最优

### 实验3：权重方案比较

**目标**：对比不同权重选择策略

```python
weight_schemes = {
    'equal': 都为1,
    'inverse_error': 1/σ²,
    'normalized': 归一化
}

for scheme in weight_schemes:
    result = calibrate_with_weights(scheme)
```

**预期**：
- 合理权重提高率定质量
- 不当权重可能导致偏差
- 反误差方差权重理论最优

### 实验4：参数初值影响

**目标**：测试对初值的敏感性

```python
initial_values = [
    (10, 500),   # 远离真实值
    (15, 800),   # 中等偏离
    (18, 1100),  # 接近真实值
]

for init in initial_values:
    result = calibrate(initial_params=init)
```

**预期**：
- 好的初值加速收敛
- 但最终结果应相似（如果唯一解）
- 如果结果差异大 → 局部最优问题

---

## 🤔 常见问题

### Q1: 如何选择观测权重？

**A**: 分步骤：

1. **理论权重**：
   ```
   w_i = 1 / σ_i²
   ```
   其中σ_i是第i个观测的误差标准差

2. **归一化**：
   - 使不同类型观测平衡
   - 避免数值问题

3. **试错调整**：
   - 检查拟合结果
   - 必要时手动调整

4. **实用建议**：
   - 地下水水位：w = 100（误差~0.1m）
   - 河流通量：w = 0.001（误差~50 m³/day）

### Q2: 参数不收敛怎么办？

**A**: 诊断和解决：

1. **检查初值**：
   - 是否合理？
   - 尝试不同初值

2. **检查边界**：
   - 是否太窄？
   - 真实值是否在范围内？

3. **简化问题**：
   - 先固定部分参数
   - 逐步增加复杂度

4. **检查观测**：
   - 数据是否一致？
   - 是否有异常值？

5. **改变算法**：
   - 尝试不同优化器
   - 全局优化（如遗传算法）

### Q3: 如何判断参数可识别？

**A**: 多个指标：

1. **敏感性**：
   - 计算Jacobian
   - 敏感性高 → 可识别性好

2. **相关性**：
   - 相关系数 < 0.7: 好
   - 相关系数 > 0.9: 难以分离

3. **不确定性**：
   - 置信区间窄 → 约束好
   - 置信区间宽 → 不确定大

4. **多次率定**：
   - 不同初值结果一致 → 可识别
   - 结果跳跃 → 可能不可识别

### Q4: 河流观测多重要？

**A**: 非常重要！

**有河流观测**：
- 河流参数可识别性大幅提升
- 提供独立约束
- 改善含水层参数估计

**无河流观测**：
- 河流参数难以确定
- 可能需要固定或使用先验
- 率定不确定性增加

**建议**：
- 至少1个河流观测（如总通量）
- 更好：多断面流量测量
- 最佳：流量+水位时间序列

### Q5: 如何减小不确定性？

**A**: 多种途径：

1. **增加观测**：
   - 更多观测点
   - 更长时间序列
   - 多类型数据

2. **优化布局**：
   - 敏感位置
   - 均匀覆盖
   - 关键区域加密

3. **提高精度**：
   - 更精确的测量
   - 减少误差

4. **先验信息**：
   - 地质勘探数据
   - 经验值范围
   - 贝叶斯先验

5. **约简参数**：
   - 分区均质化
   - 固定次要参数
   - 减少自由度

---

## 📚 扩展阅读

### 经典文献

1. **Hill & Tiedeman (2007)**. "Effective Groundwater Model Calibration"
   - 地下水模型率定圣经
   - 详细的方法论

2. **Doherty (2015)**. "Calibration and Uncertainty Analysis for Complex Environmental Models"
   - PEST作者的权威著作
   - 现代率定技术

3. **Carrera et al. (2005)**. "Inverse problem in hydrogeology"
   - 反问题理论综述
   - 学术深度

### 软件工具

1. **PEST/PEST++**：
   - 行业标准率定软件
   - 强大的功能
   - 本案例方法的专业实现

2. **UCODE**：
   - USGS开发
   - 不确定性分析
   - 敏感性分析

3. **Python工具**：
   - `pyemu`: PEST的Python接口
   - `FloPy`: MODFLOW的Python接口
   - 本教程的`gwflow`

### 进阶主题

1. **案例15**：耦合系统不确定性 - 完整的不确定性分析
2. **贝叶斯率定**：MCMC方法（见案例8）
3. **多目标率定**：帕累托优化
4. **时间序列率定**：瞬态数据

---

## ✅ 学习检查

完成本案例后，你应该能够：

- [ ] 设置耦合模型率定问题
- [ ] 联合使用多类型观测数据
- [ ] 选择合适的观测权重
- [ ] 实现参数优化算法
- [ ] 计算参数敏感性
- [ ] 分析参数可识别性
- [ ] 评估参数相关性
- [ ] 量化参数不确定性
- [ ] 验证率定结果质量
- [ ] 解释率定结果的物理意义

---

## 🚀 下一步

- **案例15**: 耦合系统不确定性 - Monte Carlo、GLUE、预测区间

---

**完成本案例？恭喜！你已掌握耦合模型率定的完整方法！** 🎉

现在你可以：
1. 率定实际的地表地下水耦合模型
2. 处理多类型观测数据
3. 评估参数可识别性和不确定性
4. 应用于水资源管理和环境评估

**Happy Calibrating! 💧📊**
