# 案例11：地表地下水耦合基础

**难度**: ⭐⭐⭐  
**前置案例**: 案例1, 案例2, 案例4  
**预计学习时间**: 4-6小时

---

## 📚 学习目标

通过本案例，你将学会：

1. ✅ 理解地表水-地下水相互作用机制
2. ✅ 掌握河流边界条件的数学描述
3. ✅ 实现弱耦合迭代求解方法
4. ✅ 分析河流渗漏通量
5. ✅ 评估耦合参数的影响
6. ✅ 理解河流断开机制

---

## 🎯 物理背景

### 地表地下水交互

地表水（河流、湖泊）和地下水之间存在密切的水力联系：

```
地表水
  ↕ 交换通量
河床/湖底（弱透水层）
  ↕
地下水
```

**交换方向**：
- 当地表水位 > 地下水位：地表水**补给**地下水（正通量）
- 当地下水位 > 地表水位：地下水**排泄**到地表水（负通量）
- 当两者相等：无交换（零通量）

### 实际意义

1. **水资源管理**：
   - 评估河流对地下水的补给量
   - 分析地下水开采对河流的影响

2. **生态保护**：
   - 维持河流基流
   - 保护湿地生态系统

3. **污染控制**：
   - 河流污染向地下水传播
   - 地下水污染物向河流排泄

---

## 📐 理论基础

### 1. 水量交换公式

**基本公式**（第三类边界条件）：

```
Q = C * (H_river - h_gw)
```

其中：
- `Q`: 交换通量 (m³/day)，正值表示地表水补给地下水
- `C`: 水力传导度 (m²/day)
- `H_river`: 河流水位 (m)
- `h_gw`: 地下水水头 (m)

**物理意义**：
- 交换通量正比于水头差
- 传导度`C`表示交换能力

### 2. 水力传导度

**定义**：

```
C = K_bed * A / b_bed
```

其中：
- `K_bed`: 河床渗透系数 (m/day)
- `A`: 交换面积 (m²) = 河长 × 河宽
- `b_bed`: 河床厚度 (m)

**渗漏系数**（Leakance）：

```
L = K_bed / b_bed  (1/day)
```

关系：`C = L * A`

**影响因素**：
1. **河床渗透性** (`K_bed`)：
   - 砂砾河床：高渗透性，强交互
   - 淤泥河床：低渗透性，弱交互

2. **河床厚度** (`b_bed`)：
   - 薄河床：强交互
   - 厚河床：弱交互

3. **河流几何** (`A`)：
   - 宽河流：大交换面积
   - 窄河流：小交换面积

### 3. 河流断开机制

**问题**：
当地下水位降到河底以下时会发生什么？

**标准公式的问题**：
```
如果 h_gw = 15m, river_bottom = 20m, river_stage = 30m
Q = C * (30 - 15) = 15C  

但物理上不合理！地下水已低于河底，
河流不能继续向下"拉"水。
```

**断开机制**（Disconnected Mechanism）：

```
当 h_gw > river_bottom:
    Q = C * (river_stage - h_gw)  # 正常连接

当 h_gw ≤ river_bottom:
    Q = C * (river_stage - river_bottom)  # 断开，限制通量
```

**物理意义**：
- 地下水降到河底以下，河流与含水层"断开"
- 此时渗漏量被限制为河流深度允许的最大值
- 防止出现非物理的过大通量

**MODFLOW River包**：
MODFLOW的River包使用此机制，是工业标准。

### 4. 耦合求解方法

地表水和地下水的控制方程相互耦合：

**地下水方程**：
```
∂h/∂t = ∇·(K∇h) + Q_exchange
```

**地表水方程**（简化）：
```
∂H/∂t = ... - Q_exchange
```

**耦合类型**：

| 方法 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **弱耦合**（本案例） | 交替求解，迭代至收敛 | 实现简单，计算高效 | 可能不稳定 |
| **强耦合** | 同时求解联合方程 | 稳定性好 | 计算量大 |
| **顺序耦合** | 按顺序求解，不迭代 | 最快 | 精度低 |

### 5. 弱耦合算法

**算法流程**（每个时间步）：

```
1. 初始化：h_gw^(0), h_sw^(0)

2. 迭代 k = 1, 2, ...:
   a. 计算交换通量：
      Q^(k) = C * (h_sw^(k-1) - h_gw^(k-1))
   
   b. 求解地下水：
      h_gw^(k) = GW_Solver(h_gw^(k-1), Q^(k))
   
   c. 更新交换通量：
      Q^(k) = C * (h_sw^(k-1) - h_gw^(k))
   
   d. 求解地表水：
      h_sw^(k) = SW_Solver(h_sw^(k-1), -Q^(k))
   
   e. 检查收敛：
      if |h^(k) - h^(k-1)| < tol:
          收敛，进入下一时间步
      else:
          继续迭代

3. 若达到最大迭代次数仍未收敛：
   警告并继续
```

**收敛性**：
- 强交互：需要更多迭代
- 弱交互：快速收敛
- 可使用松弛因子提高稳定性

**稳定性技巧**：
- 使用松弛因子：`h^(k) = α*h_new + (1-α)*h^(k-1)`, 0 < α ≤ 1
- 减小时间步长
- 调整初值猜测

---

## 💻 代码实现

### 模型设置

```python
# 含水层参数
L = 1000.0     # 长度 (m)
nx = 101       # 网格数
K = 10.0       # 渗透系数 (m/day)
b = 20.0       # 厚度 (m)

# 河流参数
river_stage = 30.0        # 水位 (m)
river_bottom = 20.0       # 河底 (m)
river_bed_K = 1.0         # 河床K (m/day)
river_bed_thickness = 2.0 # 河床厚度 (m)
river_width = 50.0        # 河宽 (m)
```

### 创建河流边界

```python
from gwflow.coupling import RiverBoundary

river = RiverBoundary(
    river_stage=30.0,
    river_bottom=20.0,
    river_bed_K=1.0,
    river_bed_thickness=2.0,
    river_width=50.0,
    river_length=dx  # 单元长度
)

print(f"传导度: {river.conductance:.2e} m²/day")
print(f"渗漏系数: {river.leakance:.3f} 1/day")
```

### 弱耦合迭代

```python
h = h_initial.copy()
Q_river = np.zeros(nx)

for iter_num in range(max_iter):
    h_old = h.copy()
    
    # 1. 计算河流渗漏
    flux = river.compute_flux(h[river_pos_idx])
    
    # 2. 转换为源汇项
    cell_volume = dx * river_width * b
    Q_river[river_pos_idx] = flux / cell_volume
    
    # 3. 求解地下水
    result = solve_1d_steady_gw(
        K=K, b=b, L=L, nx=nx,
        bc_left=('dirichlet', h_left),
        bc_right=('dirichlet', h_right),
        source=Q_river
    )
    h = result['head']
    
    # 4. 检查收敛
    error = np.max(np.abs(h - h_old))
    if error < tol:
        print(f"收敛! 迭代{iter_num+1}次")
        break
```

### 断开机制

```python
# 标准方法
flux_standard = river.compute_flux(h_gw, method='standard')

# 断开机制
flux_disconnected = river.compute_flux(h_gw, method='disconnected')

# 当 h_gw < river_bottom 时，两者不同
```

---

## 📊 运行案例

### 执行命令

```bash
cd code/examples/case_11
python3 case_11_coupling_basic.py
```

### 预期输出

```
============================================================
案例11：地表地下水耦合基础
============================================================

场景1：无河流补给（基准情况）
============================================================
最大水头: 25.00 m
最小水头: 25.00 m
平均水头: 25.00 m

场景2：河流补给（标准边界）
============================================================

河流参数:
  水位: 30.00 m
  河底: 20.00 m
  传导度: 1.25e+03 m²/day
  渗漏系数: 0.500 1/day

开始弱耦合迭代...
收敛! 迭代次数: 8

最终结果:
  河流渗漏量: 4523.25 m³/day
  河流处水头: 26.38 m
  最大水头: 26.38 m
  水头增幅: 1.38 m

场景3：河流断开机制
============================================================
...

场景4：水力传导度敏感性分析
============================================================
K_bed = 0.1 m/day: Q = 815.23 m³/day
K_bed = 0.5 m/day: Q = 3562.41 m³/day
K_bed = 1.0 m/day: Q = 4523.25 m³/day
K_bed = 2.0 m/day: Q = 5892.37 m³/day
K_bed = 5.0 m/day: Q = 7845.12 m³/day

案例11完成总结
============================================================

核心发现:
1. 河流补给使水头增加 1.38 m
2. 标准渗漏量: 4523.25 m³/day
3. 渗漏量随河床渗透系数线性增加
4. 弱耦合方法8次迭代达到收敛

✅ 案例11执行完成！
```

### 生成图片

程序会生成 `case_11_coupling_basic_results.png`，包含6个子图：

1. **水头分布对比**：无河流 vs 有河流 vs 断开机制
2. **河流影响范围**：水头增量分布
3. **收敛历史**：弱耦合迭代收敛曲线
4. **敏感性（水头）**：不同河床K下的水头分布
5. **敏感性（通量）**：渗漏量 vs 河床K
6. **敏感性（最大水头）**：最大水头 vs 河床K

---

## 📈 结果分析

### 1. 河流补给效应

**观察**：
- 无河流时：水头均匀分布在 25m
- 有河流时：河流处水头隆起，达到约 26.4m
- 影响范围：河流两侧各约 200-300m

**解释**：
河流作为补给源，向含水层注入水量，导致局部水头升高。

### 2. 断开机制影响

**对比**：
- 标准方法：渗漏量随水头差线性变化
- 断开机制：当地下水降到河底以下，渗漏量被限制

**物理意义**：
断开机制更符合实际物理过程，防止非物理通量。

### 3. 传导度敏感性

**发现**：
```
C ∝ K_bed  ⇒  Q ∝ K_bed
```

**通量-渗透系数关系**：
- 线性正相关
- 高渗透性河床：强交互
- 低渗透性河床：弱交互

**实际应用**：
- 砂砾河床：Q 大，河流补给显著
- 淤泥河床：Q 小，交互较弱

### 4. 收敛特性

**迭代次数**：
- 典型：5-10次迭代
- 强交互：可能需要更多迭代
- 弱交互：快速收敛（2-3次）

**影响因素**：
1. 传导度大小
2. 水头差
3. 网格分辨率
4. 收敛容差

---

## 🔬 实验探索

### 实验1：改变河流水位

**目标**：分析河流水位对渗漏的影响

```python
# 修改 river_stage
river_stages = [28.0, 30.0, 32.0, 35.0]

for stage in river_stages:
    river.update_stage(stage)
    # 重新求解并比较
```

**预期**：
- 水位越高，渗漏量越大
- 水位差加倍，渗漏量加倍（线性关系）

### 实验2：不同河床厚度

**目标**：评估河床厚度的影响

```python
bed_thicknesses = [0.5, 1.0, 2.0, 5.0]

# C = K * A / b_bed
# b_bed 越大，C 越小，Q 越小
```

**预期**：
- 薄河床：强交互
- 厚河床：弱交互
- 反比关系：`C ∝ 1/b_bed`

### 实验3：河流位置影响

**目标**：将河流放在不同位置

```python
river_positions = [0.25, 0.5, 0.75]  # 相对位置

for pos in river_positions:
    river_pos_idx = int(pos * nx)
    # 重新求解
```

**预期**：
- 中央位置：对称影响
- 边界附近：不对称，受边界影响

### 实验4：多条河流

**目标**：模拟多条河流

```python
# 在 x=300m 和 x=700m 处各有一条河流
river_positions = [30, 70]  # 索引

for pos in river_positions:
    # 分别计算通量
    Q_river[pos] = ...
```

**预期**：
- 每条河流独立补给
- 影响范围可能重叠
- 总通量增加

---

## 🤔 常见问题

### Q1: 为什么需要迭代？

**A**: 因为地表水和地下水方程相互耦合：
- 交换通量依赖于两者的水头差
- 两者的水头又受交换通量影响
- 需要迭代直到一致

### Q2: 什么情况下会不收敛？

**A**: 可能原因：
1. **强交互**：传导度很大
2. **数值问题**：网格太粗
3. **参数不合理**：物理上不现实
4. **初值不当**：初值猜测太差

**解决方法**：
- 使用松弛因子
- 减小时间步
- 检查参数合理性
- 改进初值猜测

### Q3: 断开机制必须使用吗？

**A**: 取决于应用：
- **必须**：地下水可能降到河底以下
- **可选**：地下水始终高于河底
- **推荐**：为了更真实的物理行为

### Q4: 如何选择河床参数？

**A**: 参考值：
- **砂砾河床**：`K_bed = 1-10 m/day`, `b_bed = 0.5-2 m`
- **砂质河床**：`K_bed = 0.1-1 m/day`, `b_bed = 1-3 m`
- **淤泥河床**：`K_bed = 0.01-0.1 m/day`, `b_bed = 2-5 m`

**现场测定**：
- 渗透试验
- 示踪试验
- 反演率定（推荐）

### Q5: 源汇项单位转换？

**A**: 关键步骤：
```python
# 通量 Q (m³/day) → 源汇项 q (1/day)
Q_flux = river.compute_flux(h_gw)  # m³/day
cell_volume = dx * dy * b           # m³
q_source = Q_flux / cell_volume     # 1/day
```

**物理意义**：
- `Q`: 体积流量 (m³/day)
- `q`: 单位体积的补给/消耗率 (1/day)

---

## 📚 扩展阅读

### 经典文献

1. **Prudic (1989)**. "Documentation of a computer program to simulate stream-aquifer relations using a modular, finite-difference, ground-water flow model"
   - MODFLOW River包的原始文献

2. **Sophocleous (2002)**. "Interactions between groundwater and surface water: the state of the science"
   - 地表地下水交互综述

3. **Brunner et al. (2010)**. "HydroGeoSphere: A fully integrated model"
   - 完全耦合模型

### 软件文档

1. **MODFLOW-2005 Manual** - River Package章节
2. **MODFLOW-6 Manual** - Advanced Package Features
3. **FloPy Documentation** - River Package教程

### 进阶主题

1. **案例12**：MODFLOW River包完整实现
2. **案例13**：多层系统越流
3. **案例14**：耦合模型参数率定

---

## ✅ 学习检查

完成本案例后，你应该能够：

- [ ] 解释地表地下水交互的物理机制
- [ ] 计算水力传导度和渗漏系数
- [ ] 实现河流边界条件
- [ ] 编写弱耦合迭代求解器
- [ ] 分析河流断开机制
- [ ] 评估参数敏感性
- [ ] 解释收敛行为
- [ ] 将方法应用于实际问题

---

## 🚀 下一步

- **案例12**: MODFLOW River包 - 完整实现与高级功能
- **案例13**: 渗漏与越流 - 多层含水层系统
- **案例14**: 耦合模型率定 - 参数优化与不确定性

---

**完成本案例？恭喜！你已经掌握了地表地下水耦合建模的基础！** 🎉

现在你可以：
1. 运行案例代码
2. 尝试实验探索
3. 修改参数观察变化
4. 思考实际应用场景

**Happy Modeling! 💧🚀**
