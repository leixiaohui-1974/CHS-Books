# 案例6：参数率定基础（优化方法）

## 学习目标

1. ✅ 理解参数率定的基本概念
2. ✅ 掌握目标函数的定义
3. ✅ 学习三种经典优化算法
4. ✅ 理解敏感性分析
5. ✅ 掌握参数相关性分析

## 问题描述

给定一维稳态地下水流动系统的观测数据，率定模型参数：
- 水力传导度 K
- 左边界水头 h_left
- 右边界水头 h_right

使用三种优化方法进行比较：
- 梯度下降法（Gradient Descent）
- Gauss-Newton法
- Levenberg-Marquardt法

## 理论基础

### 参数率定问题

参数率定是反问题：给定观测数据，估计模型参数。

**正演问题**：
```
参数 p → 模型 → 模拟值 h_sim
```

**反演问题**：
```
观测值 h_obs → 优化 → 参数 p
```

### 目标函数

**加权最小二乘目标函数**：
```
Φ(p) = Σ w_i [h_obs,i - h_sim,i(p)]²
```

其中：
- h_obs,i: 第i个观测值
- h_sim,i(p): 第i个模拟值（参数p的函数）
- w_i: 第i个观测的权重

**目标**：找到使Φ(p)最小的参数p*

### 敏感性矩阵（Jacobian矩阵）

**定义**：
```
J_ij = ∂h_i / ∂p_j
```

表示第i个观测对第j个参数的敏感性。

**计算方法**：
```
J_ij ≈ [h_i(p + Δp_j) - h_i(p)] / Δp_j
```

## 优化算法

### 1. 梯度下降法

**更新公式**：
```
p_{k+1} = p_k - α ∇Φ(p_k)
```

其中：
- α: 学习率（步长）
- ∇Φ = -2J^T W r: 梯度

**特点**：
- ✅ 简单稳定
- ✅ 总是下降
- ❌ 收敛慢
- ❌ 需要调节学习率

**适用**：
- 初始猜测较差
- 非线性强的问题
- 需要稳定性

### 2. Gauss-Newton法

**更新公式**：
```
p_{k+1} = p_k + (J^T W J)^{-1} J^T W r
```

其中：
- J: Jacobian矩阵
- W: 权重矩阵
- r: 残差向量

**推导**：
将目标函数在当前点线性化，求解最优更新。

**特点**：
- ✅ 收敛快（二次收敛）
- ❌ 可能不稳定
- ❌ J^T W J 可能奇异

**适用**：
- 初始猜测较好
- 线性或弱非线性问题

### 3. Levenberg-Marquardt法

**更新公式**：
```
p_{k+1} = p_k + (J^T W J + λI)^{-1} J^T W r
```

其中：
- λ: 阻尼因子（动态调整）

**自适应策略**：
```
如果 Φ(p_{k+1}) < Φ(p_k):
    接受更新，λ ← λ/10
否则:
    拒绝更新，λ ← λ*10
```

**特点**：
- ✅ 结合梯度下降和Gauss-Newton优点
- ✅ 稳定且快速
- ✅ 自适应调整
- ⭐ **推荐使用**

**算法行为**：
- λ大时：类似梯度下降（稳定）
- λ小时：类似Gauss-Newton（快速）

## 敏感性分析

### 复合敏感性

**定义**：
```
CSS_j = sqrt(Σ w_i (∂h_i/∂p_j)²)
```

**意义**：
- 衡量参数对所有观测的总体影响
- CSS越大，参数越重要
- CSS过小表示参数不可识别

### 参数相关性

**相关性矩阵**：
```
ρ_ij = (J^T W J)_ij / sqrt((J^T W J)_ii * (J^T W J)_jj)
```

**意义**：
- |ρ_ij| ≈ 1: 参数i和j高度相关，难以独立率定
- |ρ_ij| ≈ 0: 参数独立
- 高相关性是率定困难的重要原因

## 运行代码

```bash
cd code/examples/case_06
python3 case_06_calibration.py
```

## 输出结果

程序将生成：

1. **case_06_convergence_comparison.png**: 三种方法收敛对比
2. **case_06_fitted_results.png**: 观测值与拟合结果
3. **case_06_residuals_and_sensitivity.png**: 残差和敏感性分析
4. **case_06_parameter_correlation.png**: 参数相关性矩阵

## 预期结果

### 率定精度

三种方法均能成功率定参数：
- K误差: < 5%
- h_left误差: < 1%
- h_right误差: < 1%

### 收敛性能

| 方法 | 迭代次数 | 收敛速度 | 稳定性 |
|------|---------|---------|--------|
| 梯度下降 | ~150 | 慢 | 高 |
| Gauss-Newton | ~10 | 快 | 中 |
| L-M | ~15 | 快 | 高 |

### 敏感性

典型的敏感性排序：
1. K（水力传导度）- 最敏感
2. h_left（左边界）- 中等
3. h_right（右边界）- 中等

## 实验探索

### 实验1：噪声影响

修改噪声水平：
```python
noise_level = 0.1  # 10%噪声（原为5%）
```

**观察**：
- 噪声增大，率定误差增大
- L-M法对噪声最鲁棒

### 实验2：初始猜测

尝试不同的初始值：
```python
K_init = 2.0  # 更差的初始猜测
```

**观察**：
- 梯度下降可能需要更多迭代
- Gauss-Newton可能不收敛
- L-M法仍然稳定

### 实验3：观测点数量

改变观测点数量：
```python
obs_indices = np.linspace(10, 90, 20, dtype=int)  # 20个点
```

**观察**：
- 观测点越多，率定越准确
- 但计算成本增加

### 实验4：参数边界

修改参数边界约束：
```python
bounds = [
    (5.0, 20.0),   # 更严格的K范围
    (18.0, 22.0),  # 更严格的h_left范围
    (8.0, 12.0)    # 更严格的h_right范围
]
```

**观察**：
- 合理的边界约束有助于收敛
- 过严约束可能导致次优解

### 实验5：学习率调节

对梯度下降法：
```python
learning_rate = 0.001  # 减小学习率
```

**观察**：
- 学习率过小：收敛慢
- 学习率过大：可能振荡甚至发散

### 实验6：多参数问题

扩展到更多参数（非均质）：
```python
# 分区K值
params = [K1, K2, K3, h_left, h_right]
```

**观察**：
- 参数越多，相关性越强
- L-M法优势更明显

## 常见问题

### Q1: 为什么参数率定是病态问题？

**A**: 
1. **不唯一性**：多组参数可能产生相似的观测值
2. **参数相关性**：参数之间高度相关
3. **观测误差**：噪声影响参数估计
4. **非线性**：目标函数可能有多个局部极小值

**解决方法**：
- 增加观测数据
- 使用先验信息（正则化）
- 多点初值测试
- 约束参数范围

### Q2: 如何选择优化算法？

**A**:
```
初始猜测差 → 梯度下降
初始猜测好 → Gauss-Newton
一般情况 → Levenberg-Marquardt（推荐）
```

### Q3: 什么是目标函数的"良好"值？

**A**:
没有绝对标准，但可以参考：
- 残差标准差 ≈ 观测误差
- 如果σ_noise = 0.5m，则期望残差 ≈ 0.5m
- 目标函数 Φ ≈ n * σ²（n为观测点数）

### Q4: 参数相关性高怎么办？

**A**:
1. 增加不同类型的观测（如流量）
2. 固定部分参数
3. 使用正则化
4. 改进观测点布局

### Q5: 如何判断率定成功？

**A**:
检查以下指标：
1. ✅ 目标函数显著减小
2. ✅ 残差无系统偏差
3. ✅ 参数物理合理
4. ✅ 验证数据拟合良好
5. ✅ 敏感性分析合理

## 数学推导补充

### 梯度推导

目标函数：
```
Φ(p) = (h_obs - h_sim(p))^T W (h_obs - h_sim(p))
```

梯度：
```
∇Φ = ∂Φ/∂p = -2 J^T W (h_obs - h_sim) = -2 J^T W r
```

### Gauss-Newton推导

**泰勒展开**：
```
h_sim(p + Δp) ≈ h_sim(p) + J Δp
```

**线性化目标函数**：
```
Φ(p + Δp) ≈ (h_obs - h_sim - J Δp)^T W (h_obs - h_sim - J Δp)
```

**求最优Δp**：
```
∂Φ/∂(Δp) = 0
⇒ (J^T W J) Δp = J^T W r
```

### L-M算法的信赖域解释

L-M算法可理解为信赖域方法：
```
min Φ(p + Δp)
s.t. ||Δp|| ≤ Δ
```

阻尼因子λ控制信赖域半径Δ。

## 延伸阅读

1. Doherty, J. (2015). *Calibration and Uncertainty Analysis for Complex Environmental Models*. Watermark Numerical Computing.

2. Hill, M. C., & Tiedeman, C. R. (2006). *Effective Groundwater Model Calibration*. Wiley.

3. Nocedal, J., & Wright, S. (2006). *Numerical Optimization* (2nd ed.). Springer.

## 下一步

完成本案例后，继续学习：
- **案例7**：PEST自动率定（专业工具）
- **案例8**：贝叶斯推断与MCMC（不确定性量化）
- **案例9**：敏感性分析（深入）

或者：
- 扩展到二维问题
- 多种观测类型
- 时间序列率定
