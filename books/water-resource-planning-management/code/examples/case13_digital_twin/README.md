# 案例5.1：水库数字孪生系统

## 工程背景

数字孪生是物理实体在数字空间的精确映射，实现物理世界与数字世界的实时交互。本案例针对水库系统，构建包括物理模型、实时数据采集、状态估计、虚拟传感器和预测仿真的完整数字孪生系统。

## 案例目标

1. 理解数字孪生的基本概念和架构
2. 掌握卡尔曼滤波在状态估计中的应用
3. 学习虚拟传感器的设计与校准
4. 能够构建完整的数字孪生系统

## 主要内容

### 1. 数字孪生架构

**五维模型**：
```python
物理实体 ←→ 虚拟模型
    ↓           ↓
  传感器 ←→ 数据融合
    ↓           ↓
  数据 ←→ 孪生数据
```

**核心组件**：
- 物理模型：水库水量平衡、水位-库容关系
- 传感器：水位、流量、闸门开度
- 状态估计：卡尔曼滤波融合
- 虚拟传感器：软测量难测变量
- 预测仿真：未来状态预测

### 2. 水库数字孪生功能

**状态监测**：
- 实时水位、库容、流量
- 测量噪声滤波
- 数据质量控制

**状态估计**：
- 融合多传感器数据
- 消除测量误差
- 提高估计精度

**虚拟传感器**：
- 库容软测量
- 闸门流量估算
- 下游水位预测

**预测仿真**：
- 短期状态预测
- 调度方案评估
- 风险预警

## 技术路线

```python
物理水库系统
  ├─ 水位传感器（含噪声）
  ├─ 流量传感器（含噪声）
  └─ 闸门开度
         ↓
数字孪生系统
  ├─ 物理模型
  │   ├─ 水量平衡
  │   └─ 水位-库容
  ├─ 状态估计
  │   ├─ 卡尔曼滤波
  │   └─ 数据融合
  └─ 虚拟传感器
      ├─ 库容估算
      └─ 流量估算
         ↓
方法1：无滤波（基准）
  ├─ 直接使用测量值
  └─ 噪声影响大
         ↓
方法2：卡尔曼滤波
  ├─ KF状态估计
  ├─ 噪声抑制
  └─ 精度提升
         ↓
方法3：虚拟传感器
  ├─ 物理模型
  ├─ 数据融合
  └─ 软测量
         ↓
性能评估
  ├─ 估计精度（RMSE）
  ├─ 滤波效果
  └─ 实时性
```

## 核心算法

### 1. 水库物理模型

**水量平衡**：
```python
V(t+1) = V(t) + (I(t) - Q(t)) * Δt
```

**水位-库容关系**：
```python
h = f(V)  # 非线性关系
```

### 2. 卡尔曼滤波状态估计

**状态方程**：
```python
x_k = [V_k, I_k]^T
x_k = F*x_{k-1} + B*u_k + w_k
```

**观测方程**：
```python
z_k = [h_k, Q_k]^T
z_k = H*x_k + v_k
```

**滤波过程**：
```python
预测：x_k|k-1 = F*x_{k-1}
     P_k|k-1 = F*P_{k-1}*F^T + Q

更新：K_k = P_k|k-1*H^T*(H*P_k|k-1*H^T + R)^{-1}
     x_k = x_k|k-1 + K_k*(z_k - H*x_k|k-1)
     P_k = (I - K_k*H)*P_k|k-1
```

### 3. 虚拟传感器

**库容虚拟传感器**：
```python
V_virtual = f^{-1}(h_measured)
```

**流量虚拟传感器**：
```python
Q_virtual = C * A * sqrt(2*g*h)
```

## 运行方法

```bash
cd code/examples/case13_digital_twin
python main.py
```

## 预期结果

**无滤波（基准）**：
- RMSE：高
- 受噪声影响严重
- 波动大

**卡尔曼滤波**：
- RMSE：降低60-70%
- 平滑曲线
- 精度提升明显

**虚拟传感器**：
- 软测量精度：±2-3%
- 成本低
- 可靠性高

## 思考题

1. 数字孪生与传统仿真的区别是什么？
2. 卡尔曼滤波如何选择噪声协方差矩阵？
3. 虚拟传感器如何校准？
4. 数字孪生系统的实时性如何保证？
5. 如何处理传感器故障？

## 扩展方向

1. **三维可视化**：BIM+GIS+实时数据
2. **深度融合**：多源异构数据融合
3. **智能预测**：机器学习+物理模型
4. **自适应滤波**：参数在线调整
5. **分布式孪生**：多水库协同

## 参考文献

1. Grieves M. Digital Twin: Manufacturing Excellence through Virtual Factory Replication[J]. 2014.
2. Tao F, et al. Digital Twin in Industry: State-of-the-Art[J]. IEEE Transactions on Industrial Informatics, 2019, 15(4): 2405-2415.
3. Welch G, Bishop G. An Introduction to the Kalman Filter[R]. UNC-Chapel Hill, 2006.

## 作者信息

- 案例编号：Case 5.1
- 难度等级：⭐⭐⭐⭐⭐ (高级)
- 所需时间：8-10小时
- 更新日期：2025-11-02
