# 案例2.2：流域梯级水库群联合调度

## 工程背景

某流域有3座梯级水库（上游、中游、下游），需要在汛期（6-9月）进行联合优化调度，实现发电效益最大化的同时保证防洪安全。这是典型的多阶段决策问题，需要考虑水库间的水力联系和时间耦合。

## 案例目标

1. 掌握梯级水库优化调度建模方法
2. 理解动态规划（DP）基本原理
3. 学习逐次逼近法（POA）求解技术
4. 能够进行水库群联合优化

## 主要内容

### 1. 问题描述

**决策变量**：各水库各时段的出库流量

**目标函数**：
```python
max Σ_t Σ_i P_i(Q_i,t, H_i,t) × Δt
```
其中：
- P_i,t：水库i在时段t的发电功率
- Q_i,t：出库流量
- H_i,t：水头

**约束条件**：
- 水量平衡：V_t+1 = V_t + (I_t - Q_t) × Δt
- 库容约束：V_min ≤ V_t ≤ V_max
- 出库流量约束：Q_min ≤ Q_t ≤ Q_max
- 下游流量约束（防洪）
- 水力联系：下游入流 = 上游出流 + 区间入流

### 2. 梯级水库参数

| 水库 | 位置 | 正常蓄水位(m) | 死水位(m) | 总库容(亿m³) | 装机容量(MW) |
|------|------|--------------|----------|-------------|-------------|
| 水库1 | 上游 | 850 | 820 | 15.0 | 600 |
| 水库2 | 中游 | 750 | 720 | 12.0 | 500 |
| 水库3 | 下游 | 650 | 620 | 10.0 | 400 |

### 3. 水库特性

**库容曲线**：V = f(Z)（水位-库容关系）
**出力计算**：P = k × Q × H × η
- k = 9.81（重力加速度）
- Q：流量（m³/s）
- H：净水头（m）
- η：效率（通常0.85-0.90）

## 技术路线

```python
问题建模
  ├─ 状态变量：库容
  ├─ 决策变量：出库流量
  ├─ 状态转移方程：水量平衡
  └─ 目标函数：发电量最大
         ↓
方法1：动态规划（DP）
  ├─ 离散化状态和决策空间
  ├─ 逆序递推
  ├─ Bellman方程
  └─ 最优策略提取
         ↓
方法2：逐次逼近（POA）
  ├─ 分解为单库优化
  ├─ 迭代求解
  ├─ 收敛判定
  └─ 全局协调
         ↓
方法3：遗传算法（对比）
  ├─ 编码方案
  ├─ 约束处理
  └─ 优化求解
         ↓
结果分析
  ├─ 调度过程曲线
  ├─ 发电效益分析
  ├─ 方法对比
  └─ 灵敏度分析
```

## 数据说明

### 输入数据

**reservoir_config.yaml** - 水库配置
- reservoirs: 水库参数（库容、水位、装机等）
- cascade_relation: 梯级关系
- efficiency: 水轮机效率

**inflow_data.csv** - 入流数据
- 各水库各时段的入流过程
- 时段：汛期4个月，逐旬划分（12个时段）

### 输出结果

- `dp_results.csv` - 动态规划结果
- `poa_results.csv` - 逐次逼近结果
- `ga_results.csv` - 遗传算法结果
- `operation_curves.png` - 调度过程曲线
- `power_output.png` - 发电过程

## 运行方法

```bash
cd code/examples/case05_cascade_reservoir
python main.py
```python

## 核心算法

### 1. 动态规划（DP）

**Bellman方程**：
```
f_t(V_t) = max{P_t(V_t, Q_t) + f_t+1(V_t+1)}
         Q_t
```python

**算法步骤**：
1. 离散化状态空间（水库库容）
2. 离散化决策空间（出库流量）
3. 从最后时段向前递推
4. 记录最优决策
5. 从初始状态向后追溯最优路径

**优点**：
- 保证全局最优
- 适合中小规模问题

**缺点**：
- 维数灾难（多库时状态空间爆炸）
- 计算量随水库数指数增长

### 2. 逐次逼近法（POA）

**基本思想**：
- 将多库问题分解为多个单库问题
- 每次固定其他水库，优化一个水库
- 迭代直到收敛

**算法流程**：
```python
初始化: 给定各水库初始调度方案
repeat:
    for each reservoir i:
        固定其他水库调度
        用DP优化水库i
        更新水库i的调度方案
    计算目标函数
until 收敛或达到最大迭代次数
```python

**收敛判定**：
```
|obj_k - obj_k-1| / obj_k-1 < ε
```python

**优点**：
- 避免维数灾难
- 适合大规模梯级系统

**缺点**：
- 不保证全局最优
- 收敛速度依赖初值

### 3. 发电量计算

**出力公式**：
```
P = 9.81 × Q × H × η / 1000  (MW)
```python

**净水头**：
```
H = (Z_up + Z_down) / 2 - Z_tailwater
```python

**电量**：
```
E = P × Δt  (MWh)
```

## 预期结果

### 优化调度方案

**总发电量**：
- 初始方案：约15,000 MWh
- DP优化后：约18,500 MWh（提升23%）
- POA优化后：约18,200 MWh（提升21%）
- GA优化后：约17,800 MWh（提升19%）

### 各水库贡献

| 水库 | 发电量(MWh) | 占比 |
|------|------------|------|
| 水库1 | 7,200 | 39% |
| 水库2 | 6,500 | 35% |
| 水库3 | 4,800 | 26% |

### 调度特征

- 汛期初期：适当蓄水
- 汛期中期：加大发电
- 汛期末期：降低水位

## 思考题

1. 为什么梯级水库联合调度比单库调度效益高？
2. 动态规划的"维数灾难"如何解决？
3. POA算法的收敛性如何保证？
4. 考虑防洪约束时，如何调整模型？
5. 实际工程中还需要考虑哪些因素？

## 扩展方向

1. **多目标优化**：发电+防洪+航运+生态
2. **不确定性**：径流预报不确定性
3. **实时调度**：滚动优化策略
4. **长期调度**：年调度与日调度衔接
5. **智能算法**：强化学习、深度Q网络

## 参考文献

1. 纪昌明. 水库优化调度理论与实践[M]. 北京: 中国水利水电出版社, 2014.
2. 刘攀. 梯级水库群优化调度方法研究[D]. 大连理工大学, 2008.
3. 水利部. 水库调度规程编制导则 (SL 706-2015).
4. Labadie JW. Optimal Operation of Multireservoir Systems[J]. 2004.

## 作者信息

- 案例编号：Case 2.2
- 难度等级：⭐⭐⭐⭐ (高级)
- 所需时间：8-10小时
- 更新日期：2025-11-02
