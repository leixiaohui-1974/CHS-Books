# 案例4.1：需水量深度学习预测

## 工程背景

某城市供水系统需要准确预测未来7天的需水量，以优化水源调配和管网调度。传统的时间序列方法（如ARIMA、灰色预测）在处理非线性、多因素影响时效果有限。本案例采用深度学习方法，利用历史需水数据、气象数据等，建立高精度的需水量预测模型。

## 案例目标

1. 理解深度学习在时间序列预测中的应用
2. 掌握LSTM神经网络原理与实现
3. 学习特征工程与数据预处理
4. 能够进行多步预测与模型评估

## 主要内容

### 1. 问题定义

**预测任务**：
- 输入：过去30天的需水量及相关特征
- 输出：未来7天的日需水量
- 数据频率：日数据

**影响因素**：
- 历史需水量（时间序列）
- 气温（正相关）
- 降雨量（负相关）
- 星期类型（工作日/周末）
- 节假日标志

### 2. 数据特征

**基础特征**：
- 历史需水量
- 滑动平均（7天、14天、30天）
- 趋势特征
- 周期特征

**外部特征**：
- 气温（最高、最低、平均）
- 降雨量
- 日期特征（星期、月份、季节）

## 技术路线

```
数据准备
  ├─ 数据收集
  ├─ 缺失值处理
  └─ 异常值检测
         ↓
特征工程
  ├─ 时间特征
  ├─ 统计特征
  ├─ 滞后特征
  └─ 外部特征
         ↓
方法1：传统时间序列
  ├─ 移动平均
  ├─ 指数平滑
  └─ ARIMA
         ↓
方法2：机器学习
  ├─ 随机森林
  ├─ XGBoost
  └─ 特征重要性
         ↓
方法3：深度学习（LSTM）
  ├─ 数据归一化
  ├─ 序列构建
  ├─ LSTM模型
  └─ 多步预测
         ↓
模型评估与对比
  ├─ MAE、RMSE、MAPE
  ├─ 预测曲线对比
  ├─ 残差分析
  └─ 模型选择
```

## 核心算法

### 1. LSTM神经网络

**结构**：
```
Input Layer (window_size, n_features)
    ↓
LSTM Layer 1 (64 units)
    ↓
LSTM Layer 2 (32 units)
    ↓
Dense Layer (16 units)
    ↓
Output Layer (1 unit)
```

**优势**：
- 捕捉长期依赖
- 处理序列数据
- 避免梯度消失

### 2. 特征工程

**时间特征**：
```python
- day_of_week: 星期几 (0-6)
- is_weekend: 是否周末 (0/1)
- month: 月份 (1-12)
- season: 季节 (1-4)
```

**统计特征**：
```python
- rolling_mean_7: 7天滑动平均
- rolling_std_7: 7天滑动标准差
- lag_1, lag_7: 滞后1天、7天
```

### 3. 多步预测策略

**递归策略**：
- 预测t+1
- 用预测值作为输入预测t+2
- 逐步递归

**直接策略**：
- 训练7个模型
- 分别预测t+1到t+7

**序列到序列**：
- Encoder-Decoder结构
- 一次输出7个值

## 运行方法

```bash
cd code/examples/case10_deep_learning_forecast
python main.py
```

## 预期结果

**传统方法**：
- 移动平均：MAPE ≈ 8-10%
- ARIMA：MAPE ≈ 6-8%

**机器学习**：
- 随机森林：MAPE ≈ 5-6%
- XGBoost：MAPE ≈ 4-5%

**深度学习（LSTM）**：
- MAPE ≈ 3-4%
- 更好的泛化能力
- 捕捉复杂模式

## 思考题

1. LSTM相比传统方法的优势是什么？
2. 如何选择时间窗口大小？
3. 特征工程如何影响预测性能？
4. 如何处理预测的累积误差？
5. 实际应用中还需考虑哪些因素？

## 扩展方向

1. **注意力机制**：Transformer、Temporal Attention
2. **多变量预测**：同时预测流量、压力
3. **概率预测**：预测区间、置信度
4. **在线学习**：增量更新模型
5. **集成学习**：多模型融合

## 参考文献

1. Hochreiter S, Schmidhuber J. Long Short-Term Memory[J]. Neural Computation, 1997, 9(8): 1735-1780.
2. Goodfellow I, et al. Deep Learning[M]. MIT Press, 2016.
3. Zhang GP. Time Series Forecasting Using a Hybrid ARIMA and Neural Network Model[J]. Neurocomputing, 2003, 50: 159-175.

## 作者信息

- 案例编号：Case 4.1
- 难度等级：⭐⭐⭐⭐ (高级)
- 所需时间：6-8小时
- 更新日期：2025-11-02
