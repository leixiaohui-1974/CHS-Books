# 案例5.3：实时数据同化与预测

## 工程背景

在水文预报、洪水预警等场景中，需要融合物理模型预测和实时观测数据，通过数据同化技术不断修正模型状态，提高预测精度。数据同化是数字孪生的核心技术之一，也是数值天气预报等领域的关键方法。

## 案例目标

1. 理解数据同化的基本概念
2. 掌握集合卡尔曼滤波（EnKF）原理
3. 学习预测-校正循环
4. 能够构建实时预测系统

## 主要内容

### 1. 数据同化问题

**核心思想**：
- 模型预测（First Guess）
- 观测数据（Observation）
- 最优融合（Best Estimate）

**权衡**：
```python
x_best = w_model * x_model + w_obs * x_obs
```

权重取决于各自的不确定性

### 2. 应用场景

**洪水预报**：
- 水文模型预测
- 水位站实测
- 实时修正

**水库调度**：
- 入流预测
- 实测数据
- 滚动修正

**水质预测**：
- 扩散模型
- 监测数据
- 浓度估计

## 技术路线

```python
物理模型预测
  ├─ 径流模型
  ├─ 水位预测
  └─ 不确定性
         ↓
观测数据
  ├─ 传感器测量
  ├─ 测量误差
  └─ 数据质控
         ↓
方法1：仅模型预测
  ├─ 物理模型
  ├─ 无修正
  └─ 误差累积
         ↓
方法2：仅观测外推
  ├─ 历史数据
  ├─ 趋势外推
  └─ 无物理约束
         ↓
方法3：数据同化
  ├─ 卡尔曼滤波
  ├─ 模型+观测融合
  ├─ 最优估计
  └─ 滚动修正
         ↓
性能评估
  ├─ 预测精度
  ├─ 提前时间
  └─ 可靠性
```

## 核心算法

### 1. 数据同化基本方程

**背景误差**：
```python
P_b = E[(x - x_b)(x - x_b)^T]
```

**观测误差**：
```python
P_o = E[(y - y_o)(y - y_o)^T]
```

**最优分析**：
```python
x_a = x_b + K(y_o - H*x_b)
K = P_b*H^T*(H*P_b*H^T + P_o)^{-1}
```

### 2. 卡尔曼滤波同化

**预测**（模型）：
```python
x_f = M(x_a^{t-1})  # 模型预测
P_f = M*P_a*M^T + Q  # 预测误差
```

**同化**（观测）：
```python
K = P_f*H^T*(H*P_f*H^T + R)^{-1}
x_a = x_f + K(y - H*x_f)
P_a = (I - K*H)*P_f
```

### 3. 预测-校正循环

```python
t=0: 初始化
  ↓
t=t+1:
  ├─ 模型预测（forecast）
  ├─ 获取观测（observe）
  ├─ 数据同化（assimilate）
  └─ 更新状态（update）
  ↓
重复
```

## 运行方法

```bash
cd code/examples/case15_data_assimilation
python main.py
```

## 预期结果

**仅模型预测**：
- 预测RMSE：~3.0 m
- 误差随时间累积
- 偏离真实值

**仅观测外推**：
- 预测RMSE：~4.0 m
- 无物理约束
- 不稳定

**数据同化**：
- 预测RMSE：~1.2 m（降低60%）
- 兼顾模型和观测
- 持续修正

## 思考题

1. 数据同化与状态估计的区别？
2. 如何确定模型误差和观测误差？
3. 集合方法相比确定性方法的优势？
4. 观测频率如何影响同化效果？
5. 如何处理系统性模型偏差？

## 扩展方向

1. **3D-Var/4D-Var**：变分数据同化
2. **集合卡尔曼滤波（EnKF）**：非线性系统
3. **粒子滤波（PF）**：强非线性
4. **混合方法**：EnKF-Var
5. **自适应同化**：误差协方差在线估计

## 参考文献

1. Evensen G. The Ensemble Kalman Filter: Theoretical Formulation and Practical Implementation[J]. Ocean Dynamics, 2003, 53(4): 343-367.
2. Kalnay E. Atmospheric Modeling, Data Assimilation and Predictability[M]. Cambridge University Press, 2003.

## 作者信息

- 案例编号：Case 5.3
- 难度等级：⭐⭐⭐⭐⭐ (高级)
- 所需时间：8-10小时
- 更新日期：2025-11-02
