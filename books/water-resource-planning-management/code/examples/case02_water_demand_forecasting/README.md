# 案例1.2：城市需水预测

## 工程背景

某城市（现状人口300万）正在编制2025-2050年水资源规划，需要对未来25年的需水量进行科学预测。城市包含生活、工业、服务业和生态用水等多种需水类型。本案例将综合运用多种预测方法，给出不同情景下的需水量预测结果。

## 案例目标

1. 掌握多种需水预测方法
2. 理解情景分析的思想
3. 学习组合预测技术
4. 能够进行不确定性分析

## 主要内容

### 1. 定额法预测
- 生活需水（人口×人均用水定额）
- 工业需水（工业增加值×万元产值用水量）
- 服务业需水（服务业增加值×万元产值用水量）
- 生态需水（绿地面积×单位面积用水定额）

### 2. 趋势外推法
- 线性趋势
- 指数趋势
- 对数趋势
- 多项式趋势

### 3. 灰色预测（GM(1,1)）
- 灰色模型建立
- 预测与检验
- 精度评估

### 4. 神经网络预测
- BP神经网络
- 特征工程（人口、GDP、气温、降水等）
- 模型训练与验证

### 5. 组合预测
- 加权平均法
- 最优权重确定
- 预测区间估计

### 6. 情景分析
- 高增长情景
- 中等增长情景
- 低增长情景

## 技术路线

```python
历史数据准备
  ├─ 需水量历史数据（20年）
  ├─ 社会经济指标（人口、GDP等）
  └─ 气象数据（降水、气温）
         ↓
单一方法预测
  ├─ 定额法
  ├─ 趋势外推法
  ├─ 灰色预测GM(1,1)
  └─ 神经网络
         ↓
组合预测
  ├─ 计算各方法权重
  ├─ 加权平均
  └─ 预测区间
         ↓
情景分析
  ├─ 设置不同增长情景
  ├─ 各情景下预测
  └─ 敏感性分析
         ↓
结果输出
  ├─ 预测结果表
  ├─ 对比图
  ├─ 情景分析图
  └─ 预测报告
```

## 数据说明

### 输入数据

**historical_data.csv** - 历史需水量数据（2000-2020）
- year: 年份
- population: 人口（万人）
- gdp: GDP（亿元）
- industrial_output: 工业增加值（亿元）
- water_demand: 总需水量（万m³/d）
- domestic: 生活需水（万m³/d）
- industrial: 工业需水（万m³/d）
- service: 服务业需水（万m³/d）

**forecast_parameters.yaml** - 预测参数
- 人均综合用水定额
- 万元GDP用水量
- 节水技术进步系数
- 不同情景参数

### 输出结果

- `forecast_results.csv` - 各方法预测结果
- `scenario_analysis.csv` - 情景分析结果
- `figures/` - 图表文件夹
  - `historical_trend.png` - 历史趋势图
  - `methods_comparison.png` - 方法对比图
  - `scenario_forecast.png` - 情景预测图
  - `ensemble_forecast.png` - 组合预测图

## 运行方法

### 方法1：直接运行
```bash
cd code/examples/case02_water_demand_forecasting
python main.py
```python

### 方法2：使用配置
```bash
python main.py --config config.yaml
```python

### 方法3：训练神经网络模型
```bash
python src/train_nn.py
```

## 核心技术

### 1. 定额法

$$
Q_{\text{生活}} = P \times q
$$

其中：
- $Q_{\text{生活}}$: 生活需水量
- $P$: 人口
- $q$: 人均综合用水定额

### 2. 灰色预测GM(1,1)

灰色系统理论用于少数据、不确定性系统的预测。

**建模步骤**：
1. 累加生成序列：$x^{(1)}(k) = \sum_{i=1}^{k} x^{(0)}(i)$
2. 建立微分方程：$\frac{dx^{(1)}}{dt} + ax^{(1)} = u$
3. 求解参数：$\hat{a} = [a, u]^T = (B^TB)^{-1}B^TY$
4. 预测：$\hat{x}^{(1)}(k+1) = (x^{(0)}(1) - \frac{u}{a})e^{-ak} + \frac{u}{a}$
5. 还原：$\hat{x}^{(0)}(k+1) = \hat{x}^{(1)}(k+1) - \hat{x}^{(1)}(k)$

### 3. BP神经网络

三层神经网络：
- 输入层：人口、GDP、气温、降水等
- 隐藏层：神经元数量根据经验确定
- 输出层：需水量

训练算法：反向传播（Backpropagation）

### 4. 组合预测

$$
\hat{Y}_{\text{组合}} = \sum_{i=1}^{n} w_i \hat{Y}_i
$$

其中：
- $\hat{Y}_i$: 第i种方法的预测值
- $w_i$: 第i种方法的权重
- $\sum w_i = 1$

权重确定方法：
- 等权重法
- 误差倒数法
- 最小方差法

## 预期结果

### 1. 不同方法预测结果对比（2025年）

| 方法 | 预测值（万m³/d） | 相对误差 |
|------|-----------------|---------|
| 定额法 | 156.2 | - |
| 线性趋势 | 158.5 | +1.5% |
| 灰色GM(1,1) | 154.8 | -0.9% |
| 神经网络 | 157.3 | +0.7% |
| **组合预测** | **156.7** | **基准** |

### 2. 情景分析结果（2035年）

| 情景 | 需水量（万m³/d） | 说明 |
|------|-----------------|------|
| 高增长 | 185.2 | 人口增长快、经济高速发展 |
| 中等增长 | 168.5 | 基准情景 |
| 低增长 | 152.3 | 节水型社会建设成效显著 |

### 3. 预测区间（95%置信度）

2030年预测：168.5 万m³/d，区间 [162.3, 174.7]

## 思考题

1. 为什么需要使用多种预测方法？各方法的优缺点是什么？
2. 如何确定组合预测中各方法的权重？
3. 情景分析的意义是什么？如何设置合理的情景？
4. 神经网络预测需要哪些输入特征？如何选择？
5. 如何评估预测结果的可靠性？

## 扩展方向

1. **时间序列深度学习**：LSTM、GRU等
2. **多变量预测**：同时预测生活、工业、服务业需水
3. **考虑气候变化**：引入降水、气温变化趋势
4. **政策情景模拟**：不同节水政策的影响
5. **不确定性量化**：贝叶斯方法、蒙特卡洛模拟

## 参考文献

1. GB/T 50331-2002 城市居民生活用水量标准
2. CJJ 21-2020 城市节水评价标准
3. 邓聚龙. 灰色系统理论教程[M]. 武汉: 华中科技大学出版社, 2010.
4. 冯尚友, 芮孝芳. 水文预报[M]. 北京: 中国水利水电出版社, 2010.

## 作者信息

- 案例编号：Case 1.2
- 难度等级：⭐⭐ (基础级)
- 所需时间：3-5小时
- 更新日期：2025-11-02
