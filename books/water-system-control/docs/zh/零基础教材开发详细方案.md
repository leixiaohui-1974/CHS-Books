# 水系统控制论教材开发详细方案
## 面向高中基础学生的零门槛教学体系

**制定日期：** 2025-10-28  
**目标受众：** 具备高中数学、物理基础的学生  
**教学理念：** 从生活中来，到工程中去

---

## 📋 项目调整说明

### 关键变化

1. **删除复杂的水力学模型** ❌
   - 删除：`src/simulation/hydraulic_models.py` （Saint-Venant方程求解器）
   - 删除：`src/simulation/fvm_hydraulic_models.py` （有限体积法）
   - 原因：过于复杂，不适合教学，且存在问题
   
2. **采用简单的水箱模型** ✅
   - 使用最基础的质量守恒方程
   - 只需要高中物理知识即可理解
   - 逐步从简单到复杂

3. **建立标准测试体系** ✅
   - 收集经典控制教材中的标准案例
   - 每个功能都有可验证的测试
   - 确保代码正确性

4. **重新设计教材结构** ✅
   - 假设学生只有高中基础
   - 大量图示和直观解释
   - 避免复杂数学推导
   - 提供详细的步骤说明

---

## 🎯 教材定位与目标

### 学生背景假设

**已掌握的知识：**
- ✅ 高中数学：函数、导数、简单微分方程
- ✅ 高中物理：力学、热学基础
- ✅ 基础编程：Python基础语法（if/for/函数）

**不要求的知识：**
- ❌ 大学数学（拉普拉斯变换、矩阵理论等）
- ❌ 自动控制原理
- ❌ 复杂的数学工具

**教学策略：**
- 📖 **从物理直觉出发**：先理解物理现象，再用数学描述
- 🔢 **数学工具现用现学**：需要什么工具就讲什么，不预设前提
- 💻 **代码即理论**：用Python代码直观展示数学公式
- 📊 **可视化优先**：每个概念都配图表

---

## 📚 案例编写模板

### 标准案例结构（7个部分）

每个案例必须包含以下7个部分，确保学生能完全理解：

---

#### 【第1部分：生活场景引入】（10%篇幅）

**目的：** 让学生觉得"这个我见过！"

**内容要求：**
- ✅ 用生活中常见的例子引入
- ✅ 配实物照片或示意图
- ✅ 提出学生能理解的问题

**模板示例：**

```markdown
## 从生活中的水塔说起

你是否注意过，农村的屋顶上常常有一个大水塔？

![家庭水塔照片]

**生活观察：**
- 🏠 为什么要把水塔建在屋顶？（利用重力，产生水压）
- 🚰 为什么水龙头打开时，水会自动流出？（位置越高，压力越大）
- ⚠️ 如果水塔里没水了会怎样？（水龙头就没水了）

**问题来了：**
如何让水塔的水位自动保持在合适的高度？
- 太低了：楼上水龙头没水
- 太高了：可能溢出，浪费水
- 需要：自动控制系统！

这就是我们今天要学习的**水位自动控制**。
```

---

#### 【第2部分：问题提炼与分析】（10%篇幅）

**目的：** 把实际问题转化为控制问题

**内容要求：**
- ✅ 明确控制目标
- ✅ 分析影响因素
- ✅ 画出系统框图（简单版）

**模板示例：**

```markdown
## 问题分析：我们要解决什么？

### 控制目标
让水塔的水位保持在 **3米** （目标值，也叫"设定值"）

### 为什么水位会变化？

**水位上升的原因：**
- ⬆️ 水泵抽水进入水塔
- 输入量：Q_in（单位：升/分钟）

**水位下降的原因：**
- ⬇️ 家里用水，水从水塔流出
- 输出量：Q_out（单位：升/分钟）

### 系统框图（第一版：最简单）

```
    控制器决策        水泵执行         水塔状态
       ┌─┐           ┌─┐            ┌─┐
设定值→│?│→控制信号→│泵│→流量Q_in→│塔│→实际水位
       └─┘           └─┘            └┬┘
                                     │流量Q_out
                                     ↓
                                  用户用水
```

**核心问题：**
控制器应该如何决策，才能让水位稳定在3米？
```

---

#### 【第3部分：物理原理】（15%篇幅）

**目的：** 用高中物理知识建立数学模型

**内容要求：**
- ✅ 从物理定律出发（如质量守恒）
- ✅ 一步步推导，不跳步
- ✅ 每个符号都解释清楚
- ✅ 配示意图

**模板示例：**

```markdown
## 物理原理：水位是如何变化的？

### 第一步：从常识开始

**常识1：** 进的水多，水位上升  
**常识2：** 出的水多，水位下降  
**常识3：** 进出相等，水位不变

### 第二步：用数学描述常识

#### 质量守恒定律
> 水塔里的水 = 流入的水 - 流出的水

用符号表示：
- V = 水塔里的水量（体积，单位：升）
- Q_in = 流入速度（单位：升/分钟）
- Q_out = 流出速度（单位：升/分钟）

**1分钟后，水量的变化：**
```
ΔV = Q_in × 1分钟 - Q_out × 1分钟
```

**推广到任意时间 Δt：**
```
ΔV = (Q_in - Q_out) × Δt
```

### 第三步：从水量到水位

![水塔横截面图]

**关键关系：**
```
水量 V = 横截面积 A × 水位高度 h
```

例如：
- 水塔横截面积 A = 2 平方米
- 水位 h = 3 米
- 则水量 V = 2 × 3 = 6 立方米 = 6000 升

### 第四步：推导水位变化公式

因为 V = A × h，所以：
```
ΔV = A × Δh
```

代入前面的公式：
```
A × Δh = (Q_in - Q_out) × Δt
```

两边同时除以 A × Δt：
```
Δh / Δt = (Q_in - Q_out) / A
```

**这就是水位变化的速度！**

用微积分符号（高中选修学过）：
```
dh/dt = (Q_in - Q_out) / A
```

> **物理意义：** 水位变化速度 = （流入 - 流出）/ 横截面积

### 第五步：出水速度的规律

家里用水的速度 Q_out 和水位 h 有关系吗？

**实验观察：**
- 水位高 → 水压大 → 出水快
- 水位低 → 水压小 → 出水慢

**近似公式（来自流体力学，但我们简化一下）：**
```
Q_out = h / R
```

其中：
- R 叫做"阻力系数"（单位：分钟/米）
- R 越大，管道阻力越大，出水越慢

**例子：**
- R = 2 分钟/米
- h = 4 米
- 则 Q_out = 4 / 2 = 2 升/分钟

### 完整的数学模型

综合以上，得到：

```python
# 水位变化方程（我们的第一个模型！）
dh/dt = (Q_in - h/R) / A
```

**用Python代码表示：**
```python
def water_level_change(h, Q_in, A=2.0, R=2.0):
    """
    计算水位变化速度
    
    参数:
        h: 当前水位（米）
        Q_in: 泵的流入速度（立方米/分钟）
        A: 水塔横截面积（平方米）
        R: 阻力系数（分钟/平方米）
    
    返回:
        dh_dt: 水位变化速度（米/分钟）
    """
    Q_out = h / R  # 出水速度
    dh_dt = (Q_in - Q_out) / A
    return dh_dt

# 示例
h_current = 3.0  # 当前水位3米
Q_in = 1.0       # 泵抽水速度1立方米/分钟

speed = water_level_change(h_current, Q_in)
print(f"水位变化速度: {speed:.3f} 米/分钟")
```
```

---

#### 【第4部分：控制方法】（20%篇幅）

**目的：** 讲解控制策略，从最简单开始

**内容要求：**
- ✅ 从直觉的控制方法开始
- ✅ 逐步引入更好的方法
- ✅ 每种方法都要说明优缺点
- ✅ 配对比图表

**模板示例：**

```markdown
## 控制方法：如何让水位保持在3米？

### 方法1：手动控制（不推荐）

**做法：**
- 😴 每小时去看一次水位
- 👀 如果低于2.5米，开泵加水
- 🛑 如果高于3.5米，关泵停水

**优点：**
- ✅ 简单，容易理解

**缺点：**
- ❌ 需要人一直盯着
- ❌ 反应慢，可能已经缺水了
- ❌ 水位波动大

### 方法2：开关控制（简单但有用）

**做法：**
- 设定两个阈值：下限2.5米，上限3.5米
- 水位 < 2.5米 → 开泵
- 水位 > 3.5米 → 关泵
- 在2.5-3.5米之间 → 保持上次状态

**用代码表示：**
```python
class OnOffController:
    """开关控制器"""
    
    def __init__(self, low=2.5, high=3.5):
        self.low = low      # 下限
        self.high = high    # 上限
        self.pump_on = False  # 泵的状态
    
    def control(self, h):
        """
        根据水位决定泵的开关
        
        参数:
            h: 当前水位（米）
        
        返回:
            pump_on: True表示开泵，False表示关泵
        """
        if h < self.low:
            self.pump_on = True   # 水位太低，开泵
        elif h > self.high:
            self.pump_on = False  # 水位太高，关泵
        # 在中间区域，保持原状态（这叫"滞环"）
        
        return self.pump_on

# 测试
controller = OnOffController(low=2.5, high=3.5)

# 模拟水位变化
water_levels = [2.3, 2.8, 3.2, 3.6, 3.4, 2.9]
for h in water_levels:
    pump_state = controller.control(h)
    print(f"水位 {h} 米 → 泵状态: {'开' if pump_state else '关'}")
```

**运行结果：**
```
水位 2.3 米 → 泵状态: 开  （低于2.5，开泵）
水位 2.8 米 → 泵状态: 开  （在中间，保持开）
水位 3.2 米 → 泵状态: 开  （还在中间，保持开）
水位 3.6 米 → 泵状态: 关  （高于3.5，关泵）
水位 3.4 米 → 泵状态: 关  （在中间，保持关）
水位 2.9 米 → 泵状态: 关  （还在中间，保持关）
```

**优点：**
- ✅ 全自动，不需要人管
- ✅ 实现简单
- ✅ 成本低（只需要一个水位传感器+开关）

**缺点：**
- ❌ 水位波动还是比较大（在2.5-3.5米之间来回）
- ❌ 泵频繁启停，可能减少寿命
- ❌ 不能精确控制在3米

**适用场景：**
对精度要求不高的场合，如农村水塔

### 方法3：比例控制（更精确）

**核心思想：**
- 不是简单的"开/关"
- 根据"误差"的大小，调整泵的速度
- 误差大 → 泵速快
- 误差小 → 泵速慢

**什么是误差？**
```
误差 e = 目标值 - 实际值
例如：目标3米，实际2.5米，则 e = 3 - 2.5 = 0.5米
```

**比例控制公式：**
```
泵速 Q_in = Kp × 误差
```

其中 Kp 叫做"比例系数"（需要调试）

**用代码表示：**
```python
class ProportionalController:
    """比例控制器（P控制）"""
    
    def __init__(self, Kp=2.0, setpoint=3.0):
        self.Kp = Kp           # 比例系数
        self.setpoint = setpoint  # 目标水位
    
    def control(self, h):
        """
        根据水位计算泵的流量
        
        参数:
            h: 当前水位（米）
        
        返回:
            Q_in: 泵的流量（立方米/分钟）
        """
        error = self.setpoint - h  # 计算误差
        Q_in = self.Kp * error      # 比例控制
        
        # 限制泵的流量范围（泵不能倒转，也有最大值）
        Q_in = max(0, min(Q_in, 5.0))
        
        return Q_in

# 测试
controller = ProportionalController(Kp=2.0, setpoint=3.0)

# 不同水位下的控制输出
water_levels = [1.0, 2.0, 2.5, 2.9, 3.0, 3.1, 3.5, 4.0]
for h in water_levels:
    Q_in = controller.control(h)
    error = 3.0 - h
    print(f"水位 {h} 米, 误差 {error:+.1f} 米 → 泵流量 {Q_in:.2f}")
```

**运行结果：**
```
水位 1.0 米, 误差 +2.0 米 → 泵流量 4.00  （误差大，全速抽水）
水位 2.0 米, 误差 +1.0 米 → 泵流量 2.00  （误差中等，中速）
水位 2.5 米, 误差 +0.5 米 → 泵流量 1.00  （接近目标，低速）
水位 2.9 米, 误差 +0.1 米 → 泵流量 0.20  （很接近，微调）
水位 3.0 米, 误差 +0.0 米 → 泵流量 0.00  （刚好，停泵）
水位 3.1 米, 误差 -0.1 米 → 泵流量 0.00  （过高，停泵，等自然下降）
水位 3.5 米, 误差 -0.5 米 → 泵流量 0.00
水位 4.0 米, 误差 -1.0 米 → 泵流量 0.00
```

**优点：**
- ✅ 水位更稳定
- ✅ 可以调节控制强度（通过Kp）
- ✅ 泵不会频繁启停

**缺点：**
- ❌ 可能有稳态误差（不能完全到达3米）
- ❌ 需要可调速的泵（成本高一些）

**适用场景：**
对精度要求较高的场合，如工厂冷却系统

### 方法对比总结

| 控制方法 | 精度 | 成本 | 复杂度 | 适用场景 |
|---------|------|------|--------|----------|
| 手动控制 | ⭐ | ⭐ | ⭐ | 临时方案 |
| 开关控制 | ⭐⭐ | ⭐⭐ | ⭐⭐ | 家庭/农村 |
| 比例控制 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 工业应用 |

**下一步：** 我们将在后面的章节学习更高级的PID控制，可以完全消除误差！
```

---

#### 【第5部分：建模与仿真】（25%篇幅）

**目的：** 在计算机上模拟整个系统

**内容要求：**
- ✅ 完整的Python代码
- ✅ 详细的代码注释
- ✅ 每一步都解释清楚
- ✅ 提供可运行的示例

**模板示例：**

```markdown
## 仿真：在电脑上模拟水塔系统

### 为什么要仿真？

**真实实验的困难：**
- ❌ 需要真的水塔（贵！）
- ❌ 改参数很麻烦（重新搭建）
- ❌ 危险（水漫出来了怎么办？）

**计算机仿真的好处：**
- ✅ 免费，随时可以做
- ✅ 改参数很方便
- ✅ 安全，不会出事故
- ✅ 可以看到内部变化过程

### 仿真的基本思路

**核心思想：** 把时间切成很多小段，逐步计算

```
时刻0 → 时刻0.1 → 时刻0.2 → 时刻0.3 → ...
```

每一小步：
1. 测量当前水位 h
2. 控制器决策，得到 Q_in
3. 计算水位变化 dh
4. 更新水位 h = h + dh

### 完整代码（带详细注释）

```python
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import rcParams

# 设置中文显示
rcParams['font.sans-serif'] = ['SimHei']  # 用黑体显示中文
rcParams['axes.unicode_minus'] = False     # 正常显示负号

# ========== 第1步：定义水塔模型 ==========
class WaterTank:
    """水塔模型（简化版）"""
    
    def __init__(self, A=2.0, R=2.0):
        """
        初始化水塔
        
        参数:
            A: 横截面积（平方米）
            R: 阻力系数（分钟/平方米）
        """
        self.A = A
        self.R = R
        self.h = 2.0  # 初始水位2米
    
    def step(self, Q_in, dt=0.1):
        """
        模拟一小步（dt分钟）
        
        参数:
            Q_in: 泵的流入量（立方米/分钟）
            dt: 时间步长（分钟）
        
        返回:
            h: 更新后的水位（米）
        """
        # 计算出水速度
        Q_out = self.h / self.R if self.h > 0 else 0
        
        # 计算水位变化速度
        dh_dt = (Q_in - Q_out) / self.A
        
        # 更新水位（欧拉法）
        self.h = self.h + dh_dt * dt
        
        # 水位不能为负
        self.h = max(0, self.h)
        
        return self.h


# ========== 第2步：定义控制器 ==========
class ProportionalController:
    """比例控制器"""
    
    def __init__(self, Kp=2.0, setpoint=3.0):
        self.Kp = Kp
        self.setpoint = setpoint
    
    def control(self, h):
        """计算控制输出"""
        error = self.setpoint - h
        Q_in = self.Kp * error
        
        # 限幅（泵的流量范围是0-5）
        Q_in = np.clip(Q_in, 0, 5.0)
        
        return Q_in


# ========== 第3步：运行仿真 ==========
def simulate(duration=60, dt=0.1):
    """
    运行仿真
    
    参数:
        duration: 仿真时长（分钟）
        dt: 时间步长（分钟）
    
    返回:
        t: 时间序列
        h: 水位序列
        Q_in: 泵流量序列
    """
    # 创建水塔和控制器
    tank = WaterTank(A=2.0, R=2.0)
    controller = ProportionalController(Kp=2.0, setpoint=3.0)
    
    # 准备记录数据的列表
    time_list = []
    h_list = []
    Q_in_list = []
    
    # 初始水位
    tank.h = 2.0  # 从2米开始
    
    # 时间循环
    t = 0
    while t <= duration:
        # 记录当前状态
        time_list.append(t)
        h_list.append(tank.h)
        
        # 控制器计算输出
        Q_in = controller.control(tank.h)
        Q_in_list.append(Q_in)
        
        # 水塔状态更新
        tank.step(Q_in, dt)
        
        # 时间前进
        t += dt
    
    return np.array(time_list), np.array(h_list), np.array(Q_in_list)


# ========== 第4步：绘图显示结果 ==========
def plot_results(t, h, Q_in, setpoint=3.0):
    """绘制仿真结果"""
    
    fig, axes = plt.subplots(2, 1, figsize=(10, 8))
    
    # 子图1：水位变化
    axes[0].plot(t, h, 'b-', linewidth=2, label='实际水位')
    axes[0].axhline(setpoint, color='r', linestyle='--', 
                    linewidth=2, label='目标水位')
    axes[0].fill_between(t, 0, h, alpha=0.3)
    axes[0].set_ylabel('水位 (米)', fontsize=12)
    axes[0].set_title('水塔水位控制仿真', fontsize=14, fontweight='bold')
    axes[0].legend(fontsize=10)
    axes[0].grid(True, alpha=0.3)
    axes[0].set_xlim([0, t[-1]])
    
    # 子图2：泵流量
    axes[1].plot(t, Q_in, 'g-', linewidth=2, label='泵流量')
    axes[1].fill_between(t, 0, Q_in, alpha=0.3, color='g')
    axes[1].set_xlabel('时间 (分钟)', fontsize=12)
    axes[1].set_ylabel('流量 (m³/min)', fontsize=12)
    axes[1].set_title('泵的控制输出', fontsize=14, fontweight='bold')
    axes[1].legend(fontsize=10)
    axes[1].grid(True, alpha=0.3)
    axes[1].set_xlim([0, t[-1]])
    
    plt.tight_layout()
    plt.show()


# ========== 第5步：运行！ ==========
if __name__ == "__main__":
    print("开始仿真...")
    print("初始水位: 2.0 米")
    print("目标水位: 3.0 米")
    print("控制方法: 比例控制 (Kp=2.0)")
    print("-" * 50)
    
    # 运行仿真
    t, h, Q_in = simulate(duration=60, dt=0.1)
    
    # 显示最终结果
    print(f"最终水位: {h[-1]:.3f} 米")
    print(f"稳态误差: {abs(3.0 - h[-1]):.3f} 米")
    
    # 绘图
    plot_results(t, h, Q_in, setpoint=3.0)
```

### 运行结果分析

**控制台输出：**
```
开始仿真...
初始水位: 2.0 米
目标水位: 3.0 米
控制方法: 比例控制 (Kp=2.0)
--------------------------------------------------
最终水位: 2.857 米
稳态误差: 0.143 米
```

**图表分析：**

![仿真结果图]

**观察到的现象：**

1. **水位曲线（上图）：**
   - 0-10分钟：快速上升（误差大，泵速快）
   - 10-20分钟：上升变慢（误差小，泵速慢）
   - 20分钟后：稳定在2.857米左右

2. **泵流量曲线（下图）：**
   - 初始：2.0 m³/min（全速）
   - 逐渐降低
   - 最终：约0.3 m³/min（微调）

3. **存在的问题：**
   - ⚠️ 没有达到准确的3.0米
   - ⚠️ 有0.143米的稳态误差
   - ❓ 为什么会有误差？

### 稳态误差的原因

**为什么不能到达3.0米？**

在稳态时（不再变化），必须满足：
```
流入 Q_in = 流出 Q_out
```

因为：
- Q_out = h / R = 2.857 / 2 = 1.4285
- Q_in = Kp × (3.0 - h) = 2.0 × (3.0 - 2.857) = 0.286

**不相等！** 所以系统找到了一个平衡点2.857米。

**如何消除误差？**
→ 需要在后续章节学习 **PI控制**（加入积分作用）
```

---

#### 【第6部分：结果分析与讨论】（15%篇幅）

**目的：** 深入理解结果，培养工程思维

**内容要求：**
- ✅ 对比不同方案
- ✅ 分析影响因素
- ✅ 讨论实际应用中的问题
- ✅ 引导学生思考

**模板示例：**

```markdown
## 结果分析与讨论

### 对比实验：不同Kp的影响

让我们改变比例系数Kp，看看会怎样：

```python
# 对比3种Kp
Kp_values = [0.5, 2.0, 5.0]
colors = ['blue', 'green', 'red']

plt.figure(figsize=(10, 6))

for Kp, color in zip(Kp_values, colors):
    controller = ProportionalController(Kp=Kp, setpoint=3.0)
    # ... 运行仿真 ...
    plt.plot(t, h, color=color, label=f'Kp={Kp}', linewidth=2)

plt.axhline(3.0, color='black', linestyle='--', label='目标')
plt.xlabel('时间 (分钟)')
plt.ylabel('水位 (米)')
plt.title('不同Kp的对比')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```

**结果分析：**

| Kp | 上升时间 | 稳态误差 | 振荡情况 | 综合评价 |
|----|---------|---------|---------|----------|
| 0.5 | 很慢 | 大(0.4米) | 无振荡 | ❌ 太慢，误差大 |
| 2.0 | 适中 | 中(0.14米) | 无振荡 | ✅ 较好 |
| 5.0 | 很快 | 小(0.06米) | 轻微振荡 | ⚠️ 快但可能不稳定 |

**结论：**
- Kp太小 → 响应慢，误差大
- Kp太大 → 可能振荡，不稳定
- 需要折中选择

### 实际应用中的考虑

#### 1. 传感器误差
**问题：** 现实中，水位传感器有误差（±5cm）

**影响：**
- 测量值 = 真实值 ± 误差
- 会导致控制不准确

**解决方法：**
- 使用更好的传感器
- 多次测量取平均
- 后续章节会学习卡尔曼滤波

#### 2. 水泵响应延迟
**问题：** 水泵不能瞬间加速

**影响：**
- 控制器说"开到50%"
- 但泵需要几秒钟才能达到

**解决方法：**
- 在模型中考虑延迟
- 使用预测控制（MPC）

#### 3. 用户用水的随机性
**问题：** 家里用水是随机的

**影响：**
- Q_out 不是固定的
- 会被当作"扰动"

**解决方法：**
- 控制器需要能抗扰动
- PI/PID控制更好

### 思考题

**问题1：** 如果水塔更大（横截面积A变大），对控制有什么影响？

<details>
<summary>点击查看答案</summary>

**答案：**
- A变大 → dh/dt = (Q_in - Q_out) / A 变小
- 意味着：水位变化更慢
- 好处：系统更稳定，不容易波动
- 坏处：响应更慢，调节时间变长
- 需要：相应调整Kp（可以用更大的Kp）

</details>

**问题2：** 能否用开关控制达到完全一样的效果？

<details>
<summary>点击查看答案</summary>

**答案：**
不能。原因：
- 开关控制只有"全开/全关"两种状态
- 比例控制可以"部分开"（如30%流量）
- 比例控制更精细，能逼近目标值
- 但开关控制成本更低，适合精度要求不高的场合

</details>

**问题3：** 如果目标水位突然从3米改为4米，系统会怎样？

<details>
<summary>点击查看答案</summary>

**答案：**
- 突然改变目标 → 误差突然变大
- 控制器会全速开泵（Q_in最大）
- 水位快速上升
- 接近4米后，泵速降低
- 最终稳定在接近4米的位置（仍有稳态误差）

可以运行代码试试：
```python
# 在仿真中改变设定值
if t > 30:
    controller.setpoint = 4.0
```

</details>
```

---

#### 【第7部分：总结与展望】（5%篇幅）

**目的：** 总结本章，预告下一章

**内容要求：**
- ✅ 回顾本章要点
- ✅ 强调关键概念
- ✅ 引出下一步的问题
- ✅ 激发学习兴趣

**模板示例：**

```markdown
## 本章总结

### 你学到了什么？

**✅ 核心概念：**
1. **质量守恒** → 水位变化方程
2. **控制目标** → 让水位保持在设定值
3. **控制方法** → 从开关到比例控制
4. **仿真技巧** → 用Python模拟系统

**✅ 关键公式：**
```
dh/dt = (Q_in - Q_out) / A
Q_out = h / R
Q_in = Kp × (setpoint - h)
```

**✅ 编程技能：**
- 用类(class)组织代码
- 写仿真循环
- 用matplotlib绘图

### 遗留的问题

**❓ 问题1：稳态误差怎么办？**
- 比例控制不能完全消除误差
- → 下一章学习 **PI控制**（加入积分项）

**❓ 问题2：如果有多个水箱怎么办？**
- 目前只考虑了单个水箱
- → 第5章学习 **多水箱系统**

**❓ 问题3：如何在真实硬件上实现？**
- 目前只有仿真
- → 第10章学习 **在环测试**

### 下一章预告

**第2章：工业冷却塔的精确控制**

在下一章，我们将：
- 学习如何消除稳态误差
- 引入 **积分作用**（PI控制）
- 解决控制器 **积分饱和** 问题
- 在更高要求的工业场景中应用

**案例背景：**
化工厂的冷却塔要求水位精确控制在3.00±0.05米，
否则会影响生产。让我们看看如何做到...

→ **开始第2章的学习** ➡️
```

---

## 📊 标准测试案例库

### 为什么需要标准案例？

1. **验证代码正确性** - 与教材中的结果对比
2. **建立基准** - 新算法需要与经典方法对比
3. **学习参考** - 学生可以看到标准答案

### 经典控制教材中的标准案例

#### 案例库清单

| 编号 | 案例名称 | 来源 | 验证内容 | 参考数据 |
|------|---------|------|---------|---------|
| TC-01 | 一阶系统阶跃响应 | Ogata教材 | 时间常数、稳态值 | τ=5s, K=2 |
| TC-02 | 二阶系统阻尼响应 | Franklin教材 | 超调量、调节时间 | ζ=0.5, ωn=2 |
| TC-03 | PID参数整定（ZN法） | Åström教材 | Ku, Tu测量 | Ku=6.3, Tu=12.6 |
| TC-04 | 状态空间双水箱 | Ogata第7章 | A,B,C矩阵 | 已知参数 |
| TC-05 | LQR最优控制 | Anderson教材 | 最优增益K | Q, R给定 |
| TC-06 | 卡尔曼滤波器 | Kalman原始论文 | 估计误差 | 已知协方差 |

### 测试案例示例

```python
# tests/test_standard_cases.py

import pytest
import numpy as np
from src.models.water_tank.single_tank import SingleTank
from src.control.pid import PIDController

class TestStandardCases:
    """标准测试案例"""
    
    def test_TC01_first_order_step_response(self):
        """
        测试案例TC-01：一阶系统阶跃响应
        
        参考：Ogata "Modern Control Engineering" Example 5-1
        系统：G(s) = 2/(5s+1)
        输入：单位阶跃
        预期：τ=5秒，最终值=2.0
        """
        # 创建一阶系统
        tank = SingleTank(A=5.0, R=5.0, K=2.0)
        
        # 阶跃输入
        t = np.arange(0, 30, 0.1)
        u = np.ones_like(t)  # 单位阶跃
        
        # 仿真
        y = []
        tank.h = 0  # 初始状态为0
        for u_k in u:
            tank.step(u_k, dt=0.1)
            y.append(tank.h)
        
        y = np.array(y)
        
        # 验证时间常数（t=τ时，输出达到最终值的63.2%）
        idx_tau = np.argmin(np.abs(t - 5.0))
        assert abs(y[idx_tau] - 2.0 * 0.632) < 0.05, \
            f"一阶系统时间常数不正确：期望{2.0*0.632:.3f}，实际{y[idx_tau]:.3f}"
        
        # 验证最终值
        assert abs(y[-1] - 2.0) < 0.01, \
            f"稳态值不正确：期望2.0，实际{y[-1]:.3f}"
    
    def test_TC02_second_order_overshoot(self):
        """
        测试案例TC-02：二阶系统超调量
        
        参考：Franklin "Feedback Control of Dynamic Systems" Example 3.8
        系统：ζ=0.5, ωn=2 rad/s
        预期超调量：16.3%
        """
        # 使用双水箱构造二阶系统
        # ... (详细实现)
        pass
    
    def test_TC03_PID_ziegler_nichols(self):
        """
        测试案例TC-03：PID参数Ziegler-Nichols整定法
        
        参考：Åström "PID Controllers" Chapter 6
        """
        pass
```

---

## 🚀 详细实施计划

### Phase 1：清理与测试（第1-2周）

#### Week 1：代码清理
- [x] 删除复杂的水力学模型
- [ ] 备份重要代码（以防需要参考）
- [ ] 更新import语句
- [ ] 运行现有测试，修复破损部分

**具体操作：**
```bash
# 1. 备份
mkdir /workspace/backup
cp -r /workspace/src/simulation/hydraulic_models.py /workspace/backup/
cp -r /workspace/src/simulation/fvm_hydraulic_models.py /workspace/backup/

# 2. 删除（或注释掉复杂部分）
# 保留简单的LevelPool模型，删除FVM和MOC模型

# 3. 检查依赖
grep -r "hydraulic_models" /workspace/src/
grep -r "fvm_hydraulic" /workspace/src/

# 4. 运行测试
cd /workspace
python -m pytest tests/ -v
```

#### Week 2：建立测试基础设施
- [ ] 创建标准测试案例库
- [ ] 为每个模块编写单元测试
- [ ] 建立CI/CD流程（GitHub Actions）
- [ ] 编写测试文档

### Phase 2：开发简化模型（第3-4周）

#### Week 3：单水箱模型
```python
# src/models/water_tank/single_tank.py
```
- [ ] 实现基础SingleTank类
- [ ] 验证TC-01案例
- [ ] 编写详细docstring
- [ ] 单元测试覆盖率>90%

#### Week 4：控制器库
```python
# src/control/basic_controllers.py
```
- [ ] OnOffController（开关控制）
- [ ] ProportionalController（P控制）
- [ ] PIController（PI控制）
- [ ] PIDController（已有，需验证）

### Phase 3：编写第一个案例（第5-6周）

#### Week 5：案例1代码开发
- [ ] 完整的Python代码
- [ ] 所有仿真脚本
- [ ] Jupyter Notebook初稿

#### Week 6：案例1文档编写
- [ ] 按照7部分模板编写
- [ ] 绘制所有插图
- [ ] 邀请1-2名学生试读
- [ ] 根据反馈修改

### Phase 4：快速迭代（第7-16周）
- 每周完成1个新案例
- 边开发边测试
- 持续收集反馈

---

## 📝 写作规范

### 语言风格

#### ✅ 推荐的写法：
- "让我们一起来看看..."
- "你可能会想..."
- "这就像..."（用类比）
- "试试看！"（鼓励动手）

#### ❌ 避免的写法：
- "显然..."（对学生不显然）
- "容易证明..."（不要跳步）
- "根据XXX定理..."（学生可能不知道）
- 大段公式推导（分步骤，配图）

### 数学表达

#### 原则：
1. **先物理后数学** - 先解释物理意义，再给公式
2. **符号即时定义** - 每个符号第一次出现就解释
3. **单位清楚** - 每个量都标注单位
4. **数值示例** - 抽象公式后跟具体数字例子

#### 示例：

**❌ 不好的写法：**
```
根据连续性方程，有：
∂h/∂t = (Q_in - Q_out)/A
其中各符号含义如前所述。
```

**✅ 好的写法：**
```
**物理原理：** 水位变化速度 = (流入速度 - 流出速度) / 横截面积

**数学表达：**
```
∂h/∂t = (Q_in - Q_out) / A
```

**符号说明：**
- h = 水位高度（单位：米，m）
- t = 时间（单位：分钟，min）
- Q_in = 流入水的速度（单位：立方米每分钟，m³/min）
- Q_out = 流出水的速度（单位：立方米每分钟，m³/min）
- A = 水塔的横截面积（单位：平方米，m²）

**具体例子：**
如果：
- 流入速度 Q_in = 2 m³/min（泵在抽水）
- 流出速度 Q_out = 1 m³/min（家里在用水）
- 横截面积 A = 2 m²

那么：
```
∂h/∂t = (2 - 1) / 2 = 0.5 m/min
```

**物理意义：** 水位每分钟上升0.5米
```

---

## 📐 插图规范

### 插图类型

1. **实物照片**
   - 引入部分用
   - 让学生有直观感受

2. **示意图**
   - 简化的结构图
   - 用PPT/draw.io绘制

3. **框图**
   - 控制系统框图
   - 用专业工具（如Visio）

4. **仿真结果**
   - matplotlib生成
   - 统一风格

### 绘图要求

**✅ 好的图：**
- 清晰的标题
- 坐标轴标签+单位
- 图例说明
- 关键点标注
- 颜色友好（色盲友好）

**示例代码：**
```python
def plot_with_good_style(t, y):
    """按照教材规范绘图"""
    plt.figure(figsize=(10, 6))
    
    plt.plot(t, y, 'b-', linewidth=2.5, label='水位')
    plt.axhline(3.0, color='r', linestyle='--', 
                linewidth=2, label='目标值')
    
    # 标注重要点
    idx_final = -1
    plt.plot(t[idx_final], y[idx_final], 'go', 
             markersize=10, label=f'最终值={y[idx_final]:.2f}m')
    
    plt.xlabel('时间 (分钟)', fontsize=14, fontweight='bold')
    plt.ylabel('水位 (米)', fontsize=14, fontweight='bold')
    plt.title('水箱水位控制仿真结果', fontsize=16, fontweight='bold')
    plt.legend(fontsize=12, loc='best')
    plt.grid(True, alpha=0.3, linestyle='--')
    plt.xlim([0, t[-1]])
    plt.ylim([0, max(y)*1.1])
    
    # 添加注释
    plt.annotate('快速上升阶段', 
                xy=(5, 2.5), xytext=(10, 1.5),
                arrowprops=dict(arrowstyle='->', color='black'),
                fontsize=11)
    
    plt.tight_layout()
    plt.savefig('water_level_control.png', dpi=300, bbox_inches='tight')
    plt.show()
```

---

## ✅ 下一步行动

### 立即开始（本周）

1. **清理代码**
   ```bash
   # 执行清理脚本
   python /workspace/scripts/cleanup_complex_models.py
   ```

2. **创建测试框架**
   ```bash
   mkdir -p /workspace/tests/standard_cases
   # 编写第一个测试用例
   ```

3. **编写案例1**
   ```bash
   mkdir -p /workspace/examples/textbook_cases/case_01
   mkdir -p /workspace/notebooks/textbook/case_01
   ```

### 本月目标

- ✅ 完成代码清理和测试
- ✅ 完成案例1（家庭水塔）
- ✅ 建立标准化流程
- ✅ 验证教学效果（找2-3名学生试用）

---

## 📞 需要的支持

如果您决定按此方案执行，我可以协助：

1. **代码清理**
   - 识别需要删除的部分
   - 保留有用的功能
   - 确保不破坏现有功能

2. **测试用例开发**
   - 编写标准测试用例
   - 建立测试框架
   - CI/CD配置

3. **教材撰写**
   - 按模板编写第一个案例
   - 审阅和改进
   - 建立统一风格指南

4. **学生试用**
   - 设计问卷
   - 收集反馈
   - 快速迭代

**准备好开始了吗？** 🚀
