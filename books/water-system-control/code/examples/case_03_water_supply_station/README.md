# 案例3：供水泵站无静差控制

**难度等级：** ⭐⭐ 基础
**学习时间：** 6学时（3学时理论 + 3学时实验）
**前置知识：** 案例1、案例2、微积分

---

## 📖 案例背景

### 应用场景

城市供水泵站是城市生命线工程的核心：

**供水泵站的工作原理：**
- 🏢 泵站将水抽到高位水箱
- 💧 水箱水位产生供水压力
- 🏠 压力驱动水流到千家万户
- ⚖️ 1米水位 ≈ 0.1 MPa压力

**压力稳定的重要性：**
- 压力过低：高层住户无水使用
- 压力过高：浪费能源，管道承压
- 压力波动：影响用户体验，设备损耗

**用水需求的特点：**
- ⏰ 早晚高峰：需水量激增
- 🌙 夜间低谷：需水量很小
- 📅 周末变化：用水规律不同
- 🎯 实时变化：扰动频繁

**案例2的问题：**
- 比例控制存在稳态误差（0.33米 = 0.033 MPa）
- 无法满足供水压力精度要求（±0.02 MPa）
- 扰动后恢复慢

**解决方案：**
引入积分控制（PI控制），实现无静差跟踪！

---

## 🎯 问题描述

**控制目标：**
维持水位在3.0米，精度±0.2米（±0.02 MPa）

**系统参数：**
- 横截面积：A = 2.0 m²
- 阻力系数：R = 2.0 min/m²
- 泵增益：K = 1.0 m³/min
- 时间常数：τ = 4.0 分钟

**技术要求：**
- 稳态误差：≈0（<0.05米）
- 超调量：<10%
- 调节时间：<30分钟
- 抗扰动能力：强

---

## 🔬 涉及理论

### 核心概念

1. **PI控制（Proportional-Integral Control）**
   - 比例作用：快速响应
   - 积分作用：消除稳态误差
   - 两者协同工作

2. **积分作用的原理**
   - 累积历史误差
   - 只要有误差就持续积累
   - 直到误差为零才停止

3. **稳态误差消除机制**
   - P控制：需要误差维持控制量
   - I控制：累积作用可在零误差下维持控制量
   - 结果：稳态时误差可以为零

4. **抗积分饱和（Anti-windup）**
   - 控制量有上下限（0-100%）
   - 饱和时积分继续累积 → 积分饱和
   - 导致超调大、恢复慢
   - 需要限制积分项

### 数学模型

**PI控制律：**
```
u(t) = Kp × e(t) + Ki × ∫₀ᵗ e(τ) dτ

离散形式：
u[k] = Kp × e[k] + Ki × Σe[i] × dt

其中：
- e: 控制误差 (setpoint - measurement)
- Kp: 比例增益
- Ki: 积分增益
- dt: 采样周期
```

**闭环传递函数：**
```
G(s) = (Kp + Ki/s) / (τs + 1)

零点：-Ki/Kp
极点：由闭环特征方程确定
```

**稳态分析：**
```
稳态时，s → 0：
lim(s→0) e(s) = lim(s→0) 1 / [1 + G(s)H(s)] × r(s)

由于G(s)包含1/s项（积分），当s→0时G(s)→∞
所以 e_ss = 0 （无静差）
```

### 参数整定

**Kp和Ki的影响：**

| 参数增大 | 响应速度 | 超调量 | 稳态误差 | 稳定性 |
|---------|---------|--------|---------|--------|
| Kp↑ | 快 | 增加 | 减小 | 降低 |
| Ki↑ | 快 | 增加 | 消除快 | 降低 |

**整定原则：**
1. 先整定Kp（忽略Ki）
2. 使系统达到较好的动态性能
3. 再引入Ki消除稳态误差
4. 调整Ki直到平衡速度和超调

**推荐值（本系统）：**
- Kp = 1.5
- Ki = 0.3
- Ti = Kp/Ki = 5（积分时间常数）

---

## 💻 代码实现

### 快速开始

```bash
cd books/water-system-control/code/examples/case_03_water_supply_station
python main.py
```

### 核心代码

```python
# 1. 创建供水系统
from models.water_tank.single_tank import SingleTank
tank = SingleTank(A=2.0, R=2.0, K=1.0)
tank.reset(h0=1.5)

# 2. 创建PI控制器
from control.basic_controllers import PIController
Kp = 1.5
Ki = 0.3
setpoint = 3.0

controller = PIController(
    Kp=Kp,
    Ki=Ki,
    setpoint=setpoint,
    u_min=0.0,  # 最小控制量
    u_max=1.0,  # 最大控制量
    anti_windup=True  # 启用抗积分饱和
)

# 3. 仿真运行
dt = 0.1
T_sim = 60
N_steps = int(T_sim / dt)

for step in range(N_steps):
    # PI控制
    u = controller.control(tank.h, dt=dt)

    # 系统更新
    tank.step(u, dt=dt)

    # 记录数据
    print(f"t={tank.t:.1f}, h={tank.h:.3f}, u={u:.2f}")
```

### 抗积分饱和实现

```python
class PIController:
    def control(self, measurement, dt):
        # 计算误差
        error = self.setpoint - measurement

        # 比例项
        p_term = self.Kp * error

        # 积分项（条件积分）
        if self.anti_windup:
            # 只在未饱和时积分
            if self.u_min < self.u_last < self.u_max:
                self.integral += error * dt
        else:
            # 无条件积分
            self.integral += error * dt

        i_term = self.Ki * self.integral

        # 控制量
        u = p_term + i_term
        u = np.clip(u, self.u_min, self.u_max)

        self.u_last = u
        return u
```

---

## 📊 实验结果

### 演示1：P控制 vs PI控制对比

**测试条件：**
- 初始水位：1.5米
- 目标水位：3.0米

**P控制（Kp=2.0）：**
- 上升时间：6.1分钟
- 超调量：3.2%
- **稳态误差：0.33米（11%）** ❌
- 稳态值：2.67米

**PI控制（Kp=1.5, Ki=0.3）：**
- 上升时间：8.5分钟
- 超调量：5.8%
- **稳态误差：<0.01米（<0.3%）** ✅
- 稳态值：3.00米

**结论：**
PI控制成功消除稳态误差！

### 演示2：Ki对性能的影响

**测试Ki：**[0.1, 0.3, 0.5, 1.0]

| Ki | 上升时间 | 超调量 | 调节时间 | 稳态误差消除时间 |
|----|---------|--------|---------|----------------|
| 0.1 | 9.2分钟 | 2.1% | 16.5分钟 | 35分钟 |
| 0.3 | 8.5分钟 | 5.8% | 14.2分钟 | 18分钟 |
| 0.5 | 8.1分钟 | 9.5% | 16.8分钟 | 12分钟 |
| 1.0 | 7.5分钟 | 18.2% | 28.5分钟 | 8分钟 |

**结论：**
- Ki=0.3 最佳（平衡性能）
- Ki过大导致超调严重

### 演示3：抗积分饱和的重要性

**场景：**
大幅阶跃（1.0米 → 4.0米），控制量饱和

**无抗积分饱和：**
- 超调量：35%（达到4.7米！）
- 调节时间：42分钟
- 原因：饱和期间积分持续累积

**有抗积分饱和：**
- 超调量：8%（达到4.32米）
- 调节时间：22分钟
- 改善：显著减少超调

**结论：**
抗积分饱和是PI控制器的必要组成！

### 演示4：扰动抑制

**扰动：**
稳态时突然增加出水流量（模拟用水高峰）

**P控制：**
- 水位跌至2.68米
- 恢复到2.67米（有静差）

**PI控制：**
- 水位跌至2.75米
- 完全恢复到3.00米（无静差）

**结论：**
PI控制抗扰动能力强且能完全恢复！

---

## 💡 讨论与思考

### 优点
- ✅ 完全消除稳态误差
- ✅ 抗扰动能力强
- ✅ 满足工业精度要求
- ✅ 实现相对简单

### 缺点
- ❌ 参数整定比P控制复杂
- ❌ 可能超调较大
- ❌ 需要抗积分饱和
- ❌ 对测量噪声敏感（积分累积噪声）

### 改进方向

**1. 微分作用（PID）**
   - 增加D项提前预测
   - 减小超调，加快响应
   - 案例5-6学习

**2. 参数自适应**
   - 根据工况自动调整Kp、Ki
   - 案例15学习

**3. 前馈控制**
   - 测量扰动（用水量）
   - 提前补偿
   - 案例8学习

### 思考题

**Q1: 为什么积分作用可以消除稳态误差？**

<details>
<summary>点击查看答案</summary>

**物理意义：**

想象积分器是一个"记忆器"：
- 比例控制：只关心"现在"的误差
- 积分控制：记住"过去所有"的误差

稳态分析：
- 稳态时，如果e≠0，积分项会一直累积
- 积分项增大 → 控制量增大 → 误差减小
- 直到e=0，积分才停止增长
- 此时积分项维持控制量，不需要误差了！

**数学证明：**
```
稳态：dh/dt = 0, de/dt = 0
所以：u_ss = Ki × ∫e dt （比例项为0因为e_ss=0）
由于u_ss必须维持系统，所以积分项自动调整到合适值
结论：e_ss = 0
```
</details>

**Q2: 什么情况下会发生积分饱和？如何避免？**

<details>
<summary>点击查看答案</summary>

**发生条件：**
1. 大幅阶跃或强扰动
2. 控制量达到限幅
3. 饱和期间误差持续存在
4. 积分项持续累积到很大值
5. 退出饱和后产生大超调

**避免方法：**

**方法1：条件积分（最常用）**
```python
if u_min < u_last < u_max:  # 未饱和
    integral += error * dt
# 否则不累积
```

**方法2：积分限幅**
```python
integral = np.clip(integral, i_min, i_max)
```

**方法3：反馈控制**
```python
# 根据饱和程度减小积分
if u_saturated:
    integral -= Kb * (u_desired - u_actual) * dt
```

**推荐：** 条件积分（简单有效）
</details>

**Q3: 如何快速整定PI参数？**

<details>
<summary>点击查看答案</summary>

**步骤1：整定Kp（关闭积分）**
- 设置Ki=0
- 参考案例2方法整定Kp
- 目标：快速响应，适当超调

**步骤2：引入Ki**
- 从小值开始（如Ki=0.1）
- 逐渐增大
- 观察稳态误差消除速度

**步骤3：平衡调整**
- 如果超调太大：减小Ki或Kp
- 如果响应太慢：增大Ki
- 如果振荡：减小Kp

**经验公式（Ziegler-Nichols）：**
```
对于一阶系统：
Kp = 0.9 × τ / (K × td)
Ti = 3.33 × td
Ki = Kp / Ti
```

**本系统推荐：**
- Kp = 1.5
- Ki = 0.3
- Ti = 5
</details>

---

## 🔗 相关资源

### 代码文件
- **模型：** `code/models/water_tank/single_tank.py`
- **控制器：** `code/control/basic_controllers.py`
- **演示：** `code/examples/case_03_water_supply_station/main.py`

### 理论文档
- **PI控制理论：** 见教材第3章
- **抗积分饱和：** 见教材第3.4节
- **参数整定：** 见案例4

---

## ⏭️ 下一步学习

**案例4：PID参数整定方法**
- Ziegler-Nichols法
- Cohen-Coon法
- 经验整定法
- 软件工具整定

**案例5：PID微分作用**
- 理解微分预测作用
- 减小超调
- 处理微分噪声放大

---

**完成案例3后，你将掌握：**
- ✅ PI控制的原理和实现
- ✅ 积分作用的物理意义
- ✅ 稳态误差消除机制
- ✅ 抗积分饱和技术
- ✅ PI参数整定方法
- ✅ 工业无静差控制应用

**继续前进 → 案例4** ➡️
