# 案例1：家庭水塔自动供水系统

**难度等级：** ⭐ 入门  
**学习时间：** 4学时（2学时理论 + 2学时实验）  
**前置知识：** 高中数学、高中物理

---

## 📖 案例背景

### 生活场景

在很多农村地区，家家户户的屋顶上都有一个水塔：

![水塔示意图]

**为什么需要水塔？**
- 自来水压力不够，楼上水龙头出水小
- 水塔在屋顶，利用重力产生水压
- 水位越高，水压越大

**遇到的问题：**
- 💧 水用完了，需要手动开泵加水
- ⏰ 忘记关泵，水溢出浪费
- 😫 夜里起来开关泵，太麻烦

**解决方案：**
需要一个自动控制系统！

---

## 🎯 问题描述

**控制目标：**
让水塔的水位自动保持在合适的高度（如3米）

**约束条件：**
- 水位不能太低：否则楼上没水
- 水位不能太高：否则可能溢出
- 泵不能频繁启停：影响寿命

**技术要求：**
- 全自动运行
- 成本低廉（适合家庭）
- 可靠性高（长期无人值守）

---

## 🔬 涉及理论

### 核心概念
1. **质量守恒定律**
2. **一阶系统**
3. **开关控制（On-Off Control）**
4. **滞环（Hysteresis）**

### 数学模型
```
dh/dt = (Q_in - Q_out) / A

其中：
- h: 水位（米）
- Q_in: 流入速度（立方米/分钟）
- Q_out: 流出速度（立方米/分钟）
- A: 横截面积（平方米）
```

### 控制策略
```
if 水位 < 2.5米:
    开泵（全速）
elif 水位 > 3.5米:
    关泵
else:
    保持当前状态（滞环）
```

---

## 💻 代码实现

### 快速开始

```bash
cd /workspace/examples/textbook_cases/case_01_home_water_tower
python3 demo_on_off_control.py
```

### 核心代码

```python
# 1. 创建水箱
from src.models.water_tank.single_tank import SingleTank
tank = SingleTank(A=2.0, R=2.0, K=1.0)

# 2. 创建控制器
from src.control.basic_controllers import OnOffController
controller = OnOffController(low_threshold=2.5, high_threshold=3.5)

# 3. 运行仿真
for t in range(1200):  # 仿真2小时
    u = controller.control(tank.h)  # 控制决策
    tank.step(u, dt=0.1)            # 系统更新
    print(f"t={tank.t:.1f}, h={tank.h:.2f}, 泵={'开' if u>0 else '关'}")
```

---

## 📊 实验结果

### 预期现象
1. 水位低于2.5米时，泵自动启动
2. 水位上升到3.5米时，泵自动关闭
3. 水位在2.5-3.5米之间循环
4. 平均水位约为3.0米

### 性能指标
| 指标 | 数值 | 说明 |
|------|------|------|
| 平均水位 | 3.0米 | 在目标范围内 |
| 水位波动 | ±0.5米 | 滞环宽度 |
| 开关次数 | 约30次/天 | 可接受 |
| 控制精度 | ±16% | 适合家庭使用 |

---

## 💡 讨论与思考

### 优点
- ✅ 实现简单，成本低
- ✅ 可靠性高
- ✅ 适合家庭应用

### 缺点
- ❌ 水位波动较大
- ❌ 精度不高
- ❌ 泵频繁启停

### 改进方向
1. **调整滞环宽度**
   - 变窄 → 精度高，但开关频繁
   - 变宽 → 开关少，但波动大
   
2. **改用比例控制**
   - 可以更精确控制
   - 需要可调速的泵（成本稍高）
   
3. **加入时间控制**
   - 设置最小开启/关闭时间
   - 减少启停次数

### 思考题

**Q1: 如果水塔更大（横截面积A增加），对控制有什么影响？**

<details>
<summary>点击查看答案</summary>

A增大 → 时间常数τ=A×R增大 → 水位变化变慢

**影响：**
- 优点：系统更稳定，不容易快速波动
- 缺点：响应变慢，从2.5米升到3.5米需要更长时间
- 建议：可以适当增大滞环宽度
</details>

**Q2: 滞环宽度应该设置多大？**

<details>
<summary>点击查看答案</summary>

**考虑因素：**
1. 精度要求：要求越高，滞环越窄
2. 泵寿命：希望减少开关，滞环应宽一些
3. 水箱容量：容量大，可以用较宽的滞环

**推荐值：**
- 小水箱（<1m³）：0.2-0.5米
- 中等水箱（1-5m³）：0.5-1.0米
- 大水箱（>5m³）：1.0-2.0米
</details>

**Q3: 如何避免溢出？**

<details>
<summary>点击查看答案</summary>

**多重保护：**
1. 控制上限（如3.5米）
2. 硬件上限传感器（如3.8米，紧急停泵）
3. 溢流管（物理保护，如4.0米处）
4. 定期检查传感器和控制器

**代码实现：**
```python
if h > 3.8:  # 紧急上限
    u = 0  # 强制关泵
    trigger_alarm()  # 触发报警
```
</details>

---

## 🔗 相关资源

### 代码文件
- **模型：** `/workspace/src/models/water_tank/single_tank.py`
- **控制器：** `/workspace/src/control/basic_controllers.py`
- **演示：** `/workspace/examples/textbook_cases/case_01_home_water_tower/demo_on_off_control.py`

### 测试文件
- **单元测试：** `/workspace/tests/models/water_tank/test_single_tank.py`
- **标准测试：** `/workspace/tests/standard_cases/test_TC01_first_order_system.py`

### 文档
- **详细方案：** `/workspace/docs/zh/零基础教材开发详细方案.md`
- **案例体系：** `/workspace/docs/zh/水箱案例驱动教学体系.md`

---

## ⏭️ 下一步学习

**案例2：工业冷却塔精确水位控制**
- 学习比例控制（P控制）
- 理解性能指标（超调量、调节时间等）
- 掌握根轨迹法初步

**案例3：供水泵站无静差控制**
- 学习PI控制
- 理解积分作用
- 掌握抗积分饱和技术

---

**完成案例1后，你将掌握：**
- ✅ 水箱系统的物理建模
- ✅ 开关控制的原理和应用
- ✅ Python仿真编程
- ✅ 控制性能分析方法

**继续前进 → 案例2** ➡️
