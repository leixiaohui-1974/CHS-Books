# 案例2：工业冷却塔精确水位控制

**难度等级：** ⭐⭐ 基础
**学习时间：** 6学时（3学时理论 + 3学时实验）
**前置知识：** 案例1、微积分基础

---

## 📖 案例背景

### 工业场景

化工厂的冷却塔是工业生产的核心设备：

**冷却塔的作用：**
- 循环冷却工艺设备
- 维持生产温度稳定
- 保证设备安全运行

**水位控制的重要性：**
- 💧 水位过低：循环泵吸空，设备损坏，停产损失巨大
- 💦 水位过高：冷却效率下降，可能溢出造成浪费
- 🎯 精度要求：±0.1米（±3.3%）

**案例1的局限：**
- 开关控制精度低（±16%）
- 泵频繁启停，寿命短
- 无法满足工业精度要求

**解决方案：**
采用比例控制（P控制），实现连续精确调节！

---

## 🎯 问题描述

**控制目标：**
精确维持水位在3.0米，精度±0.1米

**系统参数：**
- 横截面积：A = 2.0 m²
- 阻力系数：R = 2.0 min/m²
- 泵增益：K = 1.0 m³/min
- 时间常数：τ = A × R = 4.0 分钟

**技术要求：**
- 精度：±3.3%（工业标准）
- 超调量：<15%
- 调节时间：<20分钟
- 稳定性：避免振荡

---

## 🔬 涉及理论

### 核心概念

1. **比例控制（P控制）**
   - 控制输出与误差成正比
   - 误差越大，控制作用越强
   - 实现连续平滑调节

2. **比例增益Kp**
   - 决定控制强度
   - Kp过大：响应快但可能振荡
   - Kp过小：响应慢且稳态误差大

3. **稳态误差**
   - P控制的固有缺陷
   - 必须有误差才能产生控制量
   - 可通过增大Kp减小（但不能消除）

### 数学模型

**一阶系统：**
```
τ dh/dt + h = K × u

其中：
- τ = A × R = 4.0 分钟（时间常数）
- K = 1.0（系统增益）
```

**比例控制律：**
```
u = Kp × e = Kp × (h_setpoint - h)

其中：
- e: 控制误差
- Kp: 比例增益
- u: 控制输出（0-100%）
```

**闭环传递函数：**
```
H(s) = (K × Kp) / (τs + 1 + K × Kp)

稳态增益 = (K × Kp) / (1 + K × Kp)
时间常数 = τ / (1 + K × Kp)
```

### 性能分析

**Kp对性能的影响：**

| Kp | 响应速度 | 超调量 | 稳态误差 | 稳定性 |
|----|---------|--------|---------|--------|
| 0.5 | 慢 | 无 | 大(33%) | 好 |
| 1.0 | 中等 | 小 | 中等(20%) | 好 |
| 2.0 | 快 | 中等 | 小(13%) | 好 |
| 5.0 | 很快 | 大 | 很小(5%) | 边缘 |
| 10.0 | 极快 | 振荡 | 极小 | 差 |

**推荐值：**
- Kp = 2.0（平衡性能）

---

## 💻 代码实现

### 快速开始

```bash
cd books/water-system-control/code/examples/case_02_cooling_tower
python main.py
```

### 核心代码

```python
# 1. 创建冷却塔系统
from models.water_tank.single_tank import SingleTank
tank = SingleTank(A=2.0, R=2.0, K=1.0)
tank.reset(h0=1.0)  # 初始水位1.0米

# 2. 创建比例控制器
from control.basic_controllers import ProportionalController
Kp = 2.0
setpoint = 3.0  # 目标水位
controller = ProportionalController(Kp=Kp, setpoint=setpoint)

# 3. 仿真运行
dt = 0.1  # 时间步长
T_sim = 60  # 仿真60分钟
N_steps = int(T_sim / dt)

for step in range(N_steps):
    # 计算控制量
    u = controller.control(tank.h)

    # 更新系统状态
    tank.step(u, dt=dt)

    # 记录数据
    print(f"t={tank.t:.1f}, h={tank.h:.3f}, u={u:.2f}, e={setpoint-tank.h:.3f}")
```

---

## 📊 实验结果

### 演示1：Kp对阶跃响应的影响

**测试条件：**
- 初始水位：1.0米
- 目标水位：3.0米
- 测试Kp：[0.5, 1.0, 2.0, 5.0]

**性能指标：**

| Kp | 上升时间 | 超调量 | 调节时间 | 稳态误差 | 稳态值 |
|----|---------|--------|---------|---------|---------|
| 0.5 | 16.2分钟 | 0% | 22.4分钟 | 0.67米(22%) | 2.33米 |
| 1.0 | 9.8分钟 | 0% | 13.5分钟 | 0.50米(17%) | 2.50米 |
| 2.0 | 6.1分钟 | 3.2% | 8.8分钟 | 0.33米(11%) | 2.67米 |
| 5.0 | 3.2分钟 | 18.5% | 6.1分钟 | 0.14米(4.7%) | 2.86米 |

**结论：**
- Kp = 2.0 是最佳选择（快速且超调小）
- 稳态误差无法消除（需要PI控制）

### 演示2：扰动抑制能力

**扰动场景：**
- 稳态运行时，突然增大出水流量
- 测试控制器的扰动抑制能力

**结果：**
- Kp越大，抗扰动能力越强
- 但过大的Kp会导致振荡

### 演示3：测量噪声的影响

**噪声特性：**
- 标准差：0.01米（传感器精度）
- 高斯白噪声

**现象：**
- Kp较大时，控制输出波动明显
- 实际工程中需要滤波

---

## 💡 讨论与思考

### 优点
- ✅ 控制精度高（可达±3.3%）
- ✅ 响应速度快
- ✅ 实现简单，计算量小
- ✅ 避免频繁启停

### 缺点
- ❌ 存在稳态误差
- ❌ Kp不易整定
- ❌ 对测量噪声敏感

### 改进方向

**1. 消除稳态误差**
   - 引入积分控制 → PI控制器
   - 下一案例学习

**2. Kp整定方法**
   - 临界比例度法
   - Ziegler-Nichols法
   - 案例4详细讲解

**3. 噪声处理**
   - 增加低通滤波器
   - 使用滑动平均

### 思考题

**Q1: 为什么比例控制一定有稳态误差？**

<details>
<summary>点击查看答案</summary>

**原理分析：**

稳态时，dh/dt = 0，所以：
```
h_ss = K × u_ss

而 u_ss = Kp × e_ss = Kp × (h_setpoint - h_ss)

代入得：
h_ss = K × Kp × (h_setpoint - h_ss)
h_ss × (1 + K × Kp) = K × Kp × h_setpoint
h_ss = (K × Kp) / (1 + K × Kp) × h_setpoint

稳态误差：
e_ss = h_setpoint - h_ss = h_setpoint / (1 + K × Kp)
```

**结论：**
- 只要K×Kp是有限值，必然存在稳态误差
- 要完全消除误差，需要Kp → ∞（不现实）
- 或者引入积分作用（PI控制）
</details>

**Q2: 如何快速整定Kp？**

<details>
<summary>点击查看答案</summary>

**经验法（适合现场快速调试）：**

1. 从Kp = 0开始，逐渐增大
2. 观察阶跃响应曲线
3. 当出现10-15%超调时，停止增大
4. 适当减小Kp，留有余量

**临界比例度法：**

1. 从小Kp开始，逐渐增大
2. 直到系统出现等幅振荡
3. 记录临界增益Kc和振荡周期Tc
4. Kp = 0.5 × Kc（保守）

**理论计算法：**

对于一阶系统：
```
Kp = τ / (K × T_d)

其中 T_d 是期望的响应时间
```

推荐：Kp = 2.0（对于本系统）
</details>

**Q3: 实际工程中如何应对测量噪声？**

<details>
<summary>点击查看答案</summary>

**方法1：滤波**
```python
# 一阶低通滤波器
alpha = 0.9  # 滤波系数
h_filtered = alpha * h_filtered_prev + (1 - alpha) * h_measured
```

**方法2：死区**
```python
# 小误差时不动作
if abs(error) < deadband:
    u = u_prev  # 保持上次控制量
else:
    u = Kp * error
```

**方法3：限幅**
```python
# 限制控制量变化率
du_max = 0.1  # 每步最大变化
u = np.clip(u_new, u_prev - du_max, u_prev + du_max)
```

**推荐组合：**
- 测量滤波 + 控制限幅
- 平衡响应速度和稳定性
</details>

---

## 🔗 相关资源

### 代码文件
- **模型：** `code/models/water_tank/single_tank.py`
- **控制器：** `code/control/basic_controllers.py`
- **演示：** `code/examples/case_02_cooling_tower/main.py`

### 理论文档
- **比例控制理论：** 见教材第2章
- **性能指标定义：** 见教材附录A
- **Kp整定方法：** 见案例4

---

## ⏭️ 下一步学习

**案例3：供水泵站无静差控制（PI控制）**
- 学习积分控制原理
- 掌握PI参数整定
- 实现零稳态误差

**案例4：PID参数整定方法**
- Ziegler-Nichols法
- Cohen-Coon法
- 经验整定法

---

**完成案例2后，你将掌握：**
- ✅ 比例控制的原理和实现
- ✅ Kp对系统性能的影响规律
- ✅ 稳态误差的产生机理
- ✅ 动态性能指标的计算方法
- ✅ 工业控制器的实际应用

**继续前进 → 案例3** ➡️
