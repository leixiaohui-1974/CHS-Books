# 案例11：状态空间方法 - 现代控制理论入门

## 场景描述

工程师需要使用现代控制理论方法来分析和设计水箱控制系统。传统的传递函数方法在处理多输入多输出（MIMO）系统时存在局限性，而状态空间方法提供了更强大的工具。本案例将单水箱系统转换为状态空间表示，分析系统的能控性和能观性，设计状态反馈控制器，并通过极点配置实现期望的动态性能。

## 教学目标

通过本案例，您将学习：

1. **状态空间建模**：将传递函数转换为状态空间表示
2. **能控性分析**：判断系统是否可以通过控制输入任意改变状态
3. **能观性分析**：判断系统状态是否可以从输出推断
4. **状态反馈控制**：设计状态反馈增益矩阵
5. **极点配置**：通过状态反馈实现期望的闭环极点
6. **现代控制vs经典控制**：理解两种方法的区别和联系

## 核心概念

### 1. 状态空间表示

状态空间模型用一组一阶微分方程描述系统：

```
状态方程：dx/dt = Ax + Bu
输出方程：y = Cx + Du
```

其中：
- **x**: 状态向量（n×1）
- **u**: 输入向量（m×1）
- **y**: 输出向量（p×1）
- **A**: 状态矩阵（n×n）
- **B**: 输入矩阵（n×m）
- **C**: 输出矩阵（p×n）
- **D**: 直接传递矩阵（p×m）

### 2. 单水箱系统的状态空间模型

对于单水箱系统，我们选择水位h作为状态变量：

**原始微分方程**：
```
A·dh/dt = K·u - h/R
```

**状态空间形式**：
```
dx/dt = -1/(AR)·x + K/A·u
y = x
```

因此：
- A = -1/(AR) = -1/τ（标量，实际上是1×1矩阵）
- B = K/A（标量）
- C = 1
- D = 0

### 3. 能控性（Controllability）

**定义**：如果系统可以在有限时间内从任意初始状态转移到任意期望状态，则系统是能控的。

**数学判据**：系统(A,B)能控 ⟺ 能控性矩阵满秩

```
Mc = [B  AB  A²B  ...  A^(n-1)B]
```

对于n维系统，Mc应该是n×n满秩矩阵（rank = n）。

**物理意义**：
- 能控 → 控制输入可以影响所有状态
- 不能控 → 某些状态无法通过输入改变
- 单水箱系统：直觉上是能控的，因为泵流量可以控制水位

### 4. 能观性（Observability）

**定义**：如果可以从输出y(t)和输入u(t)的历史推断出初始状态x(0)，则系统是能观的。

**数学判据**：系统(A,C)能观 ⟺ 能观性矩阵满秩

```
Mo = [C; CA; CA²; ...; CA^(n-1)]
```

**物理意义**：
- 能观 → 所有状态都可以从输出推断
- 不能观 → 某些状态"隐藏"在系统内部
- 单水箱系统：是能观的，因为我们直接测量水位

### 5. 状态反馈控制

**控制律**：
```
u = -Kx + r
```

其中：
- **K**: 状态反馈增益矩阵（m×n）
- **r**: 参考输入

**闭环系统**：
```
dx/dt = (A - BK)x + Br
```

闭环系统矩阵：Acl = A - BK

**关键性质**：
- 如果系统能控，则可以通过选择K任意配置闭环极点
- 状态反馈不改变系统的能观性

### 6. 极点配置（Pole Placement）

**目标**：选择K使得闭环系统矩阵Acl的特征值为期望极点p₁, p₂, ..., pₙ

**设计步骤**：
1. 选择期望极点（基于性能要求）
2. 计算状态反馈增益K
3. 验证闭环系统性能

**极点选择指南**：
- 实部：决定衰减速度（越负越快）
- 虚部：决定振荡频率
- 二阶系统标准极点：-ζωₙ ± jωₙ√(1-ζ²)
- 常用选择：过阻尼（无超调）或临界阻尼

### 7. 状态空间 vs 传递函数

| 特性 | 传递函数 | 状态空间 |
|------|---------|---------|
| 表示形式 | 输入-输出关系 | 内部状态描述 |
| 适用系统 | SISO | SISO和MIMO |
| 初始条件 | 不便处理 | 自然包含 |
| 非线性系统 | 不适用 | 可扩展 |
| 计算机实现 | 较困难 | 容易 |
| 物理洞察 | 频域特性 | 时域状态演化 |
| 控制设计 | 经典方法（PID等） | 现代方法（极点配置、LQR等） |

## 任务列表

本案例包含以下分析和设计任务：

### 任务1：状态空间建模
- 从传递函数推导状态空间模型
- 验证两种表示的等价性
- 可视化系统框图

### 任务2：能控性和能观性分析
- 计算能控性矩阵
- 计算能观性矩阵
- 判断系统是否能控和能观

### 任务3：状态反馈控制器设计
- 设计状态反馈增益K
- 分析闭环系统性能
- 对比有无状态反馈的响应

### 任务4：极点配置
- 选择期望闭环极点
- 计算所需的反馈增益
- 验证实际闭环极点

### 任务5：参考输入跟踪
- 设计前馈增益实现稳态跟踪
- 分析跟踪性能
- 对比PID控制方法

## 使用方法

### 运行主程序

```bash
cd books/water-system-control/code/examples/case_11_state_space
python main.py
```

### 运行扩展实验

```bash
python experiments.py
```

## 预期结果

运行主程序后，您将看到：

1. **状态空间模型**：
   - 系统矩阵A, B, C, D
   - 与传递函数的对应关系
   - 系统的开环极点

2. **能控性和能观性分析**：
   - 能控性矩阵的秩
   - 能观性矩阵的秩
   - 判定结果（能控/能观）

3. **状态反馈控制**：
   - 设计的反馈增益K
   - 闭环极点位置
   - 阶跃响应曲线

4. **极点配置结果**：
   - 期望极点 vs 实际极点
   - 时域性能指标（上升时间、超调量等）
   - 频域特性（带宽、相位裕度等）

5. **对比分析**：
   - 开环 vs 闭环响应
   - 状态反馈 vs PID控制
   - 不同极点配置的性能差异

## 关键输出

### 1. 系统矩阵

```
状态空间模型：
  A = -0.2222  (极点在s = -0.2222)
  B = 0.4800
  C = 1
  D = 0

传递函数（验证）：
       0.48
G(s) = -------
       s + 0.2222
```

### 2. 能控性和能观性

```
能控性分析：
  能控性矩阵 Mc = [0.48]
  秩 = 1
  结论：系统完全能控 ✓

能观性分析：
  能观性矩阵 Mo = [1]
  秩 = 1
  结论：系统完全能观 ✓
```

### 3. 状态反馈设计

```
设计目标：极点从 -0.222 移至 -0.5（加快响应）

计算结果：
  反馈增益 K = 0.5787
  闭环极点 = -0.5

性能改善：
  时间常数：4.5 min → 2.0 min
  稳态时间：≈20 min → ≈9 min
```

## 工程意义

### 1. 多变量系统扩展

状态空间方法的真正优势在于多变量系统：

**双水箱系统**：
- 状态：[h₁, h₂]ᵀ（两个水箱的水位）
- 输入：u（泵流量）
- 输出：y（下游水箱水位）

状态空间表示自然地处理内部耦合，而传递函数方法较困难。

### 2. 最优控制基础

状态空间是最优控制（如LQR）的基础：
- 定义性能指标：J = ∫(xᵀQx + uᵀRu)dt
- 求解最优反馈增益K
- 在性能和控制代价间权衡

### 3. 观测器设计

在实际系统中，不是所有状态都可以直接测量：
- 状态空间方法可以设计状态观测器
- 从可测输出估计不可测状态
- 实现输出反馈控制

### 4. 非线性系统处理

状态空间方法可以扩展到非线性系统：
- 非线性状态方程：dx/dt = f(x, u)
- 线性化分析
- 非线性控制设计（滑模控制、反馈线性化等）

## 扩展学习

### experiments.py 包含的扩展实验

1. **实验1：不同极点配置的性能对比**
   - 慢极点 vs 快极点
   - 实极点 vs 复数极点
   - 性能指标量化

2. **实验2：双水箱系统的状态空间模型**
   - 2阶系统建模
   - 2×2矩阵的能控性和能观性
   - 多极点配置

3. **实验3：状态反馈 vs PID控制**
   - 两种方法的性能对比
   - 鲁棒性分析
   - 实现复杂度对比

4. **实验4：参考输入跟踪**
   - 前馈-反馈结构
   - 积分增广方法
   - 消除稳态误差

## 理论深化

### Ackermann公式（单输入系统）

对于单输入系统，极点配置的显式公式：

```
K = [0 0 ... 0 1] · Mc⁻¹ · αd(A)
```

其中：
- Mc：能控性矩阵
- αd(s)：期望特征多项式
- αd(A)：将A代入αd(s)

### 对偶性原理

能控性和能观性是对偶的：
- (A, B)能控 ⟺ (Aᵀ, Cᵀ)能观（其中C=Bᵀ）
- 状态反馈和观测器设计是对偶的

### 能控规范型

任何能控系统都可以转换为能控规范型：

```
     ⎡ 0   1   0  ...  0 ⎤       ⎡0⎤
     ⎢ 0   0   1  ...  0 ⎥       ⎢0⎥
Ac = ⎢ ⋮   ⋮   ⋮   ⋱   ⋮ ⎥,  Bc = ⎢⋮⎥
     ⎢ 0   0   0  ...  1 ⎥       ⎢0⎥
     ⎣-a₀ -a₁ -a₂ ... -aₙ₋₁⎦      ⎣1⎦
```

这种形式便于分析和控制器设计。

## 文献参考

1. **经典教材**：
   - Kailath, T. "Linear Systems" (1980)
   - Chen, C.T. "Linear System Theory and Design" (1999)
   - Ogata, K. "Modern Control Engineering" (2010)

2. **应用文献**：
   - Franklin, G.F. et al. "Feedback Control of Dynamic Systems" (2015)
   - Dorf, R.C. & Bishop, R.H. "Modern Control Systems" (2017)

## 常见问题

### Q1: 状态空间和传递函数哪个更好？

**A**: 各有优势，取决于应用：
- **SISO系统 + 频域分析** → 传递函数更直观
- **MIMO系统 + 时域设计** → 状态空间更强大
- 实际工程中常结合使用

### Q2: 状态变量如何选择？

**A**: 常用原则：
- 物理意义明确的变量（如位置、速度、温度等）
- 能量存储元件的变量（电容电压、电感电流等）
- 最小数量（等于系统阶数）
- 单水箱：水位h是自然选择

### Q3: 状态反馈需要测量所有状态吗？

**A**: 理论上需要，实际中：
- **全状态可测** → 直接状态反馈
- **部分状态可测** → 设计状态观测器
- 观测器可以从输出估计不可测状态

### Q4: 极点应该配置在哪里？

**A**: 考虑因素：
- **响应速度**：极点实部越负，响应越快
- **控制能量**：极点太快需要很大的控制输入
- **测量噪声**：极点太快对噪声敏感
- **建模误差**：保留一定裕度
- 经验：闭环极点约为开环极点的2-5倍

### Q5: 状态空间方法的主要限制？

**A**:
- 需要系统的数学模型
- 需要知道或估计所有状态
- 对模型误差敏感（但可设计鲁棒控制器）
- 单输入系统时，传递函数可能更简单

## 下一步

完成本案例后，建议学习：

1. **案例12：状态观测器与LQR控制** - 最优控制方法
2. **案例13：鲁棒控制** - H∞控制和μ综合
3. **案例14：模型预测控制（MPC）** - 约束优化控制

## 实践建议

1. **对比验证**：始终验证状态空间模型与传递函数的一致性
2. **物理直觉**：理解状态变量的物理意义
3. **性能权衡**：极点配置需要在多个目标间权衡
4. **仿真验证**：在实际应用前充分仿真测试
5. **参数鲁棒性**：测试控制器对参数变化的鲁棒性

---

**作者**: CHS-Books项目
**日期**: 2025-10-30
**版本**: 1.0
**关键词**: 状态空间、能控性、能观性、状态反馈、极点配置、现代控制理论
