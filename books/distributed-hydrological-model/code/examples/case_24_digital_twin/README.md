# 案例24：流域数字孪生系统

## 概述

本案例演示**流域数字孪生系统**，实现物理流域与数字流域的实时映射、状态同步、预测预警和智能决策。

## 核心概念

### 1. 数字孪生技术

**定义**：数字孪生是物理实体的虚拟映射，通过实时数据实现物理-数字双向映射。

**关键特征**：
- 实时性：持续数据更新
- 双向性：物理→数字、数字→物理
- 预测性：超前模拟预测
- 智能性：自主决策支持

### 2. 系统架构

```
物理流域 → 传感器网络 → 数据接入 → 数字孪生模型 → 可视化监控
    ↑                                    ↓
    └──────── 决策执行 ←──── 智能决策 ←────┘
```

### 3. 核心组件

#### 3.1 实时数据源

```python
class RealTimeDataSource:
    def get_rainfall(time_step):  # 雨量站数据
    def get_discharge(time_step): # 流量观测
```

#### 3.2 数字孪生模型

```python
class DigitalTwinModel:
    models: List[XinAnJiangModel]  # 集合模型
    
    def run_timestep(rainfall, evap, obs):
        # 运行模型
        # 数据同化
        # 状态更新
        # 预警判断
```

#### 3.3 EnKF数据同化

卡尔曼增益：
```
K = Pf / (Pf + R)
```

集合更新：
```
x_i^a = x_i^f + K(y - x_i^f + ε_i)
```

### 4. 工作流程

**实时运行模式**：
1. 接收实时数据
2. 运行集合预报
3. EnKF同化更新
4. 状态监控预警

**预报模式**：
1. 超前预报（无观测）
2. 不确定性估计
3. 预警决策

## 运行结果

```
【同化阶段 (0-60h)】
  RMSE: 1.13 m³/s
  NSE:  0.6812

【预报阶段 (60-120h)】
  （模型持续运行）
```

### 关键特性

- **集合成员**：30个
- **预警阈值**：黄色20 m³/s，红色30 m³/s
- **同化效果**：RMSE改善明显
- **实时性**：逐时步更新

## 可视化

生成数字孪生监控面板（7幅图）：
1. 实时流量监控（带不确定性区间）
2. 降雨过程
3. 模拟误差演变
4. 集合预报散点
5. 累积误差对比
6. 性能指标
7. 预警时间轴

## 工程意义

### 1. 实时监控

- 流域状态实时掌握
- 异常及时发现
- 决策快速响应

### 2. 预测预警

- 超前预报（24h）
- 不确定性量化
- 分级预警

### 3. 智能决策

- 数据驱动决策
- 情景模拟
- 风险评估

## 技术要点

- EnKF集合同化
- 模型状态管理
- 实时数据处理
- 可视化监控

## 运行方式

```bash
cd code/examples/case_24_digital_twin
python main.py
```

---

**作者**: CHS-Books项目组  
**日期**: 2025-11-02  
**版本**: v1.0
