# æ¡ˆä¾‹17: åŠŸç‡å› æ•°æ§åˆ¶

## ğŸ“– æ•™å­¦ç›®æ ‡

æŒæ¡å¹¶ç½‘é€†å˜å™¨çš„åŠŸç‡æ§åˆ¶æŠ€æœ¯ï¼Œç†è§£æœ‰åŠŸåŠŸç‡å’Œæ— åŠŸåŠŸç‡çš„è§£è€¦æ§åˆ¶ï¼Œå®ç°åŠŸç‡å› æ•°è°ƒèŠ‚ã€‚

**æ ¸å¿ƒå†…å®¹**:
1. åŠŸç‡è®¡ç®—ä¸PQè§£è€¦åŸç†
2. æœ‰åŠŸåŠŸç‡æ§åˆ¶
3. æ— åŠŸåŠŸç‡æ§åˆ¶
4. åŠŸç‡å› æ•°è°ƒèŠ‚

---

## ğŸ¯ æ ¸å¿ƒç†è®º

### 1. ä¸‰ç›¸åŠŸç‡ç†è®º

#### ç¬æ—¶åŠŸç‡ (dqåæ ‡ç³»)

åœ¨åŒæ­¥æ—‹è½¬dqåæ ‡ç³»ä¸‹ï¼š
\[
\begin{cases}
P = \frac{3}{2} (v_d i_d + v_q i_q) \\
Q = \frac{3}{2} (v_q i_d - v_d i_q)
\end{cases}
\]

#### ç”µç½‘ç”µå‹å®šå‘

å½“ç”µç½‘ç”µå‹å®šå‘äºdè½´æ—¶ (\( v_q \approx 0 \))ï¼š
\[
\begin{cases}
P \approx \frac{3}{2} v_d i_d \\
Q \approx -\frac{3}{2} v_d i_q
\end{cases}
\]

**å…³é”®ç»“è®º**:
- \( i_d \) æ§åˆ¶æœ‰åŠŸåŠŸç‡ P
- \( i_q \) æ§åˆ¶æ— åŠŸåŠŸç‡ Q
- På’ŒQå®Œå…¨è§£è€¦ï¼Œå¯ç‹¬ç«‹æ§åˆ¶

### 2. åŠŸç‡å› æ•°

#### å®šä¹‰
\[
PF = \frac{P}{S} = \frac{P}{\sqrt{P^2 + Q^2}} = \cos\varphi
\]

å…¶ä¸­ï¼š
- P: æœ‰åŠŸåŠŸç‡ (W)
- Q: æ— åŠŸåŠŸç‡ (Var)
- S: è§†åœ¨åŠŸç‡ (VA)
- Ï†: åŠŸç‡å› æ•°è§’

#### ç±»å‹

| Qå€¼ | åŠŸç‡å› æ•° | è´Ÿè½½ç±»å‹ | ç›¸ä½å…³ç³» |
|-----|----------|----------|----------|
| Q = 0 | PF = 1.0 | çº¯é˜»æ€§ | ç”µå‹ç”µæµåŒç›¸ |
| Q > 0 | 0 < PF < 1 | æ„Ÿæ€§ | ç”µæµæ»åç”µå‹ |
| Q < 0 | 0 < PF < 1 | å®¹æ€§ | ç”µæµè¶…å‰ç”µå‹ |

### 3. PQè§£è€¦æ§åˆ¶

#### æ§åˆ¶ç»“æ„
```
På‚è€ƒ â”€â”€â†’ [åŠŸç‡è®¡ç®—] â”€â”€â†’ i_då‚è€ƒ â”€â”€â”
                                  â”œâ”€â”€â†’ [dqç”µæµæ§åˆ¶] â”€â”€â†’ ä¸‰ç›¸ç”µå‹è¾“å‡º
Qå‚è€ƒ â”€â”€â†’ [åŠŸç‡è®¡ç®—] â”€â”€â†’ i_qå‚è€ƒ â”€â”€â”˜
```

#### åŠŸç‡åˆ°ç”µæµè½¬æ¢

å½“ \( v_q = 0 \) æ—¶ï¼š
\[
\begin{cases}
i_d^{ref} = \frac{P^{ref}}{1.5 v_d} \\
i_q^{ref} = -\frac{Q^{ref}}{1.5 v_d}
\end{cases}
\]

---

## ğŸ’» ä»£ç å®ç°

### 1. åŠŸç‡è®¡ç®—

```python
from models.inverter_control import PowerController

# åˆ›å»ºåŠŸç‡è®¡ç®—å™¨
power_calc = PowerController(V_grid=311.0)

# è®¡ç®—åŠŸç‡
v_d, v_q = 311.0, 0.0  # ç”µç½‘ç”µå‹å®šå‘
i_d, i_q = 10.0, 5.0   # dqç”µæµ

P, Q, S, PF = power_calc.calculate_power(v_d, v_q, i_d, i_q)

print(f"æœ‰åŠŸåŠŸç‡: {P:.0f} W")
print(f"æ— åŠŸåŠŸç‡: {Q:.0f} Var")
print(f"è§†åœ¨åŠŸç‡: {S:.0f} VA")
print(f"åŠŸç‡å› æ•°: {PF:.3f}")
```

### 2. åŠŸç‡åˆ°ç”µæµè½¬æ¢

```python
# åŠŸç‡å‚è€ƒ
P_ref = 2000.0  # 2kW
Q_ref = 1000.0  # 1kVar

# è½¬æ¢ä¸ºç”µæµå‚è€ƒ
i_d_ref, i_q_ref = power_calc.power_to_current(P_ref, Q_ref, v_d=311.0)

print(f"i_då‚è€ƒ: {i_d_ref:.2f} A")
print(f"i_qå‚è€ƒ: {i_q_ref:.2f} A")
```

### 3. åŠŸç‡å› æ•°åˆ°æ— åŠŸåŠŸç‡

```python
# æ ¹æ®åŠŸç‡å› æ•°è®¡ç®—æ— åŠŸåŠŸç‡
P_ref = 2000.0
PF_ref = 0.95  # åŠŸç‡å› æ•°0.95

Q_ref = power_calc.pf_to_power(P_ref, PF_ref)
print(f"æ‰€éœ€æ— åŠŸåŠŸç‡: {Q_ref:.0f} Var")
```

### 4. PQæ§åˆ¶å™¨

```python
from models.inverter_control import PQController, SRFPLL

# åˆ›å»ºPLL (ç”¨äºç”µç½‘åŒæ­¥)
pll = SRFPLL(Kp=50.0, Ki=1000.0)

# åˆ›å»ºPQæ§åˆ¶å™¨
pq_ctrl = PQController(
    V_grid=311.0,      # ç”µç½‘ç”µå‹å¹…å€¼
    Kp_i=0.5,          # ç”µæµç¯Kp
    Ki_i=100.0,        # ç”µæµç¯Ki
    L=5e-3,            # æ»¤æ³¢ç”µæ„Ÿ
    omega=2*np.pi*50,  # ç”µç½‘è§’é¢‘ç‡
    P_limit=5000.0,    # æœ‰åŠŸåŠŸç‡é™å¹…
    Q_limit=2000.0     # æ— åŠŸåŠŸç‡é™å¹…
)

# æ§åˆ¶å¾ªç¯
dt = 1e-4
for _ in range(N):
    # PLLåŒæ­¥
    theta, omega, freq = pll.update(va, vb, vc, dt)
    
    # PQæ§åˆ¶
    v_a_out, v_b_out, v_c_out = pq_ctrl.update(
        P_ref, Q_ref,           # åŠŸç‡å‚è€ƒ
        va, vb, vc,             # ç”µç½‘ç”µå‹
        i_a, i_b, i_c,          # ç”µæµåé¦ˆ
        theta, dt               # PLLè§’åº¦å’Œæ—¶é—´æ­¥é•¿
    )
    
    # è·å–åŠŸç‡çŠ¶æ€
    status = pq_ctrl.get_status()
    P_actual = status['power']['P']
    Q_actual = status['power']['Q']
    PF_actual = status['power']['PF']
```

---

## ğŸ§ª å®éªŒå†…å®¹

### å®éªŒ1: åŠŸç‡è®¡ç®—ä¸PQè§£è€¦

**å®éªŒç›®çš„**: éªŒè¯dqåæ ‡ç³»ä¸‹çš„PQè§£è€¦ç‰¹æ€§

**å®éªŒæ­¥éª¤**:
1. è®¾ç½®ç”µç½‘ç”µå‹ v_d=311V, v_q=0V
2. æµ‹è¯•ä¸åŒi_då’Œi_qç»„åˆ
3. è®¡ç®—Pã€Qã€Så’ŒPF
4. éªŒè¯è§£è€¦å…³ç³»

**æµ‹è¯•ç”¨ä¾‹**:
| å·¥å†µ | i_d(A) | i_q(A) | é¢„æœŸP(W) | é¢„æœŸQ(Var) | é¢„æœŸPF |
|------|--------|--------|----------|------------|--------|
| çº¯æœ‰åŠŸ | 10.0 | 0.0 | 4665 | 0 | 1.0 |
| çº¯æ— åŠŸ | 0.0 | 10.0 | 0 | Â±4665 | 0.0 |
| æ··åˆ | 10.0 | 5.0 | 4665 | Â±2333 | 0.894 |

### å®éªŒ2: æœ‰åŠŸåŠŸç‡æ§åˆ¶

**å®éªŒç›®çš„**: æµ‹è¯•æœ‰åŠŸåŠŸç‡é˜¶è·ƒå“åº”

**å®éªŒæ­¥éª¤**:
1. è®¾ç½®Q_ref=0 (åŠŸç‡å› æ•°=1)
2. æœ‰åŠŸåŠŸç‡é˜¶è·ƒ: 1kW â†’ 3kW â†’ 2kW
3. è§‚å¯ŸåŠŸç‡è·Ÿè¸ªè¿‡ç¨‹
4. éªŒè¯Qä¿æŒä¸º0

**é¢„æœŸç»“æœ**:
- På¿«é€Ÿè·Ÿè¸ªå‚è€ƒå€¼
- Qä¿æŒæ¥è¿‘0
- åŠŸç‡å› æ•°ä¿æŒåœ¨1.0é™„è¿‘

### å®éªŒ3: æ— åŠŸåŠŸç‡ä¸åŠŸç‡å› æ•°

**å®éªŒç›®çš„**: åˆ†æåŠŸç‡å› æ•°ä¸æ— åŠŸåŠŸç‡çš„å…³ç³»

**å®éªŒå†…å®¹**:
1. å›ºå®šP=2kW
2. æ”¹å˜Qå€¼: 0, Â±500, Â±1000 Var
3. è®¡ç®—è§†åœ¨åŠŸç‡Så’ŒåŠŸç‡å› æ•°PF
4. ç»˜åˆ¶PFéšQå˜åŒ–æ›²çº¿

**è§‚å¯Ÿè¦ç‚¹**:
- Q=0æ—¶PFæœ€å¤§
- |Q|å¢å¤§ï¼ŒPFé™ä½
- æ„Ÿæ€§è´Ÿè½½ Q>0
- å®¹æ€§è´Ÿè½½ Q<0

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### 1. æ§åˆ¶ç²¾åº¦

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| æœ‰åŠŸåŠŸç‡è¯¯å·® | < 2% | ç¨³æ€ç²¾åº¦ |
| æ— åŠŸåŠŸç‡è¯¯å·® | < 5% | ç¨³æ€ç²¾åº¦ |
| åŠŸç‡å› æ•° | > 0.95 | å¹¶ç½‘è¦æ±‚ |

### 2. åŠ¨æ€æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| åŠŸç‡é˜¶è·ƒå“åº” | < 100ms | è°ƒèŠ‚æ—¶é—´ |
| è¶…è°ƒé‡ | < 10% | åŠ¨æ€å“åº” |
| PQè€¦åˆåº¦ | < 5% | è§£è€¦æ€§èƒ½ |

### 3. å¹¶ç½‘æ ‡å‡† (IEEE 1547)

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| åŠŸç‡å› æ•°èŒƒå›´ | 0.95è¶…å‰ ~ 0.95æ»å |
| æœ‰åŠŸåŠŸç‡å˜åŒ–ç‡ | < 10%/åˆ†é’Ÿ |
| æ— åŠŸåŠŸç‡è°ƒèŠ‚èƒ½åŠ› | Â±0.44 Ã— P_rated |

---

## âš™ï¸ å·¥ç¨‹åº”ç”¨

### 1. å¹¶ç½‘æ¨¡å¼é€‰æ‹©

**æ’åŠŸç‡å› æ•°æ¨¡å¼**:
```python
P_ref = P_mppt  # ä»MPPTè·å–
Q_ref = 0       # åŠŸç‡å› æ•°=1
```

**æ’æ— åŠŸåŠŸç‡æ¨¡å¼**:
```python
P_ref = P_mppt
Q_ref = Q_grid  # ç”µç½‘è¦æ±‚çš„æ— åŠŸåŠŸç‡
```

**ç”µå‹æ”¯æ’‘æ¨¡å¼**:
```python
# æ ¹æ®ç”µç½‘ç”µå‹è°ƒèŠ‚Q
V_grid_measure = measure_voltage()
if V_grid_measure < V_nominal * 0.95:
    Q_ref = Q_max  # å‘å‡ºæ— åŠŸï¼Œæ”¯æ’‘ç”µå‹
elif V_grid_measure > V_nominal * 1.05:
    Q_ref = -Q_max  # å¸æ”¶æ— åŠŸï¼Œé™ä½ç”µå‹
else:
    Q_ref = 0
```

### 2. åŠŸç‡é™å¹…ç­–ç•¥

**è§†åœ¨åŠŸç‡é™åˆ¶**:
```python
S_rated = 5000.0  # VA

# é™åˆ¶På’ŒQä½¿å¾— sqrt(P^2 + Q^2) <= S_rated
if np.sqrt(P_ref**2 + Q_ref**2) > S_rated:
    # æŒ‰æ¯”ä¾‹ç¼©å‡
    ratio = S_rated / np.sqrt(P_ref**2 + Q_ref**2)
    P_ref *= ratio
    Q_ref *= ratio
```

**ä¼˜å…ˆçº§ç­–ç•¥**:
```python
# æœ‰åŠŸä¼˜å…ˆ
P_ref = min(P_ref, P_limit)
Q_max_available = np.sqrt(S_rated**2 - P_ref**2)
Q_ref = np.clip(Q_ref, -Q_max_available, Q_max_available)
```

### 3. ä½ç”µå‹ç©¿è¶Š(LVRT)

```python
if V_grid < V_nominal * 0.9:
    # è¿›å…¥LVRTæ¨¡å¼
    P_ref = P_ref * (V_grid / V_nominal)  # é™ä½æœ‰åŠŸ
    Q_ref = Q_max  # æœ€å¤§æ— åŠŸæ”¯æ’‘
```

---

## ğŸ“ ä½œä¸šç»ƒä¹ 

### ç»ƒä¹ 1: åŠŸç‡è®¡ç®—éªŒè¯
å·²çŸ¥ä¸‰ç›¸ç³»ç»Ÿï¼šv_d=220V, v_q=0V, i_d=15A, i_q=-8A
1. è®¡ç®—Pã€Qã€S
2. è®¡ç®—åŠŸç‡å› æ•°
3. åˆ¤æ–­è´Ÿè½½ç±»å‹(æ„Ÿæ€§/å®¹æ€§)

### ç»ƒä¹ 2: åŠŸç‡å› æ•°è®¾è®¡
è¦æ±‚å…‰ä¼ç³»ç»Ÿè¾“å‡ºP=3kWï¼ŒåŠŸç‡å› æ•°PF=0.98(æ»å)ï¼š
1. è®¡ç®—æ‰€éœ€æ— åŠŸåŠŸç‡Q
2. è®¡ç®—i_då’Œi_q (v_d=311V)
3. è®¾è®¡æ§åˆ¶ç­–ç•¥

### ç»ƒä¹ 3: æ€§èƒ½å¯¹æ¯”
å¯¹æ¯”ä¸‰ç§å·¥å†µçš„æ€§èƒ½ï¼š
- å·¥å†µ1: PF=1.0 (Q=0)
- å·¥å†µ2: PF=0.95 (æ„Ÿæ€§)
- å·¥å†µ3: PF=0.95 (å®¹æ€§)

åˆ†æï¼š
1. è§†åœ¨åŠŸç‡Sçš„å·®å¼‚
2. ç”µæµå¹…å€¼çš„å·®å¼‚
3. é€†å˜å™¨æŸè€—çš„å½±å“

### ç»ƒä¹ 4: ä¼˜å…ˆçº§ç­–ç•¥
é€†å˜å™¨é¢å®šå®¹é‡S=5kVAï¼Œå½“å‰MPPTè¾“å‡ºP=4.5kWï¼š
1. è®¡ç®—å¯ç”¨æ— åŠŸåŠŸç‡èŒƒå›´
2. å¦‚æœç”µç½‘è¦æ±‚Q=2kVarï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ
3. è®¾è®¡åŠŸç‡åˆ†é…ç­–ç•¥

---

## ğŸ“š æ‰©å±•é˜…è¯»

### è¿›é˜¶æ§åˆ¶
- è™šæ‹ŸåŒæ­¥æœº(VSG)æ§åˆ¶
- ä¸‹å‚æ§åˆ¶
- è‡ªé€‚åº”åŠŸç‡å› æ•°æ§åˆ¶

### å¹¶ç½‘æ ‡å‡†
- IEEE 1547-2018
- IEC 61727
- GB/T 19964

### å·¥ç¨‹å®è·µ
- é˜²å­¤å²›ä¿æŠ¤ä¸åŠŸç‡æ§åˆ¶åè°ƒ
- å¤šæœºå¹¶è”åŠŸç‡å‡åˆ†
- æ™ºèƒ½ç”µç½‘Q(V)ç‰¹æ€§

---

## â“ å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆdqåæ ‡ç³»èƒ½å®ç°PQè§£è€¦ï¼Ÿ**
A: dqåæ ‡ç³»å°†ACé‡è½¬ä¸ºDCé‡ï¼Œåœ¨ç”µç½‘ç”µå‹å®šå‘ä¸‹ï¼Œi_då’Œi_qåˆ†åˆ«ç‹¬ç«‹æ§åˆ¶På’ŒQï¼Œæ²¡æœ‰äº¤å‰è€¦åˆé¡¹ã€‚

**Q2: åŠŸç‡å› æ•°è°ƒèŠ‚æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ**
A: 
- æé«˜ç”µç½‘ç”µå‹è´¨é‡
- å‡å°çº¿è·¯æŸè€—
- æ»¡è¶³å¹¶ç½‘æ ‡å‡†
- æ”¯æ’‘ç”µç½‘ç¨³å®š

**Q3: æ„Ÿæ€§å’Œå®¹æ€§åŠŸç‡å› æ•°çš„åŒºåˆ«ï¼Ÿ**
A:
- æ„Ÿæ€§(Q>0): ç”µæµæ»åç”µå‹ï¼Œå¸æ”¶æ— åŠŸ
- å®¹æ€§(Q<0): ç”µæµè¶…å‰ç”µå‹ï¼Œå‘å‡ºæ— åŠŸ
- å¯¹ç”µç½‘å½±å“ä¸åŒ

**Q4: å¦‚ä½•é€‰æ‹©åŠŸç‡å› æ•°ï¼Ÿ**
A:
- ç™½å¤©è´Ÿè½½é‡: PF=1.0æœ€ä½³(å‡å°‘æŸè€—)
- ç”µç½‘ç”µå‹ä½: å‘å‡ºæ— åŠŸ(Q>0)æ”¯æ’‘ç”µå‹
- ç”µç½‘ç”µå‹é«˜: å¸æ”¶æ— åŠŸ(Q<0)é™ä½ç”µå‹

**Q5: åŠŸç‡é™å¹…å¦‚ä½•å¤„ç†ï¼Ÿ**
A: è§†åœ¨åŠŸç‡ \( S = \sqrt{P^2 + Q^2} \) ä¸èƒ½è¶…è¿‡é€†å˜å™¨é¢å®šå®¹é‡ï¼Œéœ€æŒ‰ä¼˜å…ˆçº§åˆ†é…ï¼š
1. æœ‰åŠŸä¼˜å…ˆï¼ˆä¿è¯å‘ç”µï¼‰
2. å‰©ä½™å®¹é‡åˆ†é…ç»™æ— åŠŸ
3. å¿…è¦æ—¶é™ä½æœ‰åŠŸè¾“å‡º

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

1. Teodorescu, R., et al. "Grid Converters for Photovoltaic and Wind Power Systems"
2. IEEE Std 1547-2018 "Standard for Interconnection"
3. Blaabjerg, F., et al. "Control of Power Converters in AC Microgrids"
4. Akagi, H., et al. "Instantaneous Power Theory and Applications"

---

**å®éªŒæ—¶é—´**: 1.5-2å°æ—¶  
**éš¾åº¦ç­‰çº§**: â­â­â­â­  
**å‰ç½®çŸ¥è¯†**: æ¡ˆä¾‹14(ç”µæµæ§åˆ¶), æ¡ˆä¾‹16(PLLåŒæ­¥)
