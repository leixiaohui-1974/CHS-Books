# 智能水网工程设计指南

本指南总结智能水网设计的通用流程、方法和最佳实践。

---

## 📐 设计流程（7个步骤）

### 步骤1：工程调研

**目标**：明确设计需求和约束条件

**任务清单**：
- [ ] 收集工程基础资料（地形、水文、现状）
- [ ] 明确设计目标（节水、节能、安全等）
- [ ] 确定智能化等级目标（L1-L5）
- [ ] 调研类似工程案例
- [ ] 编写设计任务书

**工具**：
- 现场踏勘表格
- 数据采集清单
- 案例库查询

---

### 步骤2：水力设计（复用第2本书）

**目标**：完成水利工程的物理设计

**任务清单**：
- [ ] 渠道/管道断面设计
- [ ] 水工建筑物设计（闸、堰、泵等）
- [ ] 水力计算与校核
- [ ] 绘制工程图纸

**复用资源**：
```python
# 从第2本书导入模型
from books.open_channel_hydraulics.code.models.channel import (
    TrapezoidalChannel,  # 梯形渠道
    RectangularChannel,  # 矩形渠道
    CircularChannel      # 圆形管道
)

# 从第2本书导入求解器
from books.open_channel_hydraulics.code.solvers.steady.uniform_flow import (
    compute_normal_depth,
    compute_critical_depth
)
```

**输出成果**：
- 水力计算书
- 工程图纸（CAD）
- 设备选型清单

---

### 步骤3：智能体架构设计

**目标**：设计分层分布式智能体系统

**架构层次**：
```
管理层（L5）：数字孪生、预测性维护
    ↓
调度层（L3-L4）：多目标优化、全局协调
    ↓
控制层（L2-L3）：PID/MPC控制器
    ↓
感知层（L1）：传感器网络
    ↓
物理层：水利工程
```

**任务清单**：
- [ ] 确定监测点位置和类型
- [ ] 设计控制回路（单点/多点/协调）
- [ ] 配置通信网络（有线/无线）
- [ ] 规划数据流向和处理逻辑

---

### 步骤4：控制器设计（复用第1、3本书）

**目标**：设计具体的控制算法

**控制器类型选择**：
| 智能化等级 | 推荐控制器 | 复用资源 |
|-----------|-----------|---------|
| L2 | PID、PI、On-Off | 第1本书案例1-4 |
| L3 | MPC、串级、前馈-反馈 | 第1本书案例7-8、第3本书案例1-3 |
| L4 | 自适应、鲁棒、优化调度 | 第3本书案例14-16 |
| L5 | 数字孪生、AI控制 | 第3本书案例13、17 |

**任务清单**：
- [ ] 选择控制算法类型
- [ ] 设计控制器参数
- [ ] 整定控制器（仿真或经验公式）
- [ ] 设计抗饱和、限幅等保护措施

**复用资源**：
```python
# 从第1本书导入控制器
from books.water_system_control.code.control.pid import PIDController
from books.water_system_control.code.control.on_off import OnOffController

# 从第3本书导入高级控制
# （根据第3本书的实际结构调整路径）
```

---

### 步骤5：数字孪生建模（复用第3本书+本书新增）

**目标**：构建系统的数字孪生模型

**任务清单**：
- [ ] 建立物理层模型（水力模型）
- [ ] 添加控制层模型（控制器）
- [ ] 配置传感器和执行器
- [ ] 设置仿真参数（时间步长、求解器等）

**示例代码**：
```python
from books.intelligent_water_network_design.code.simulator.digital_twin import (
    DigitalTwinSimulator
)

# 创建数字孪生
twin = DigitalTwinSimulator()

# 添加组件（复用第2本书的模型）
twin.add_component('canal_main', type='canal', model=canal_model)
twin.add_component('gate_1', type='gate', model=gate_model)

# 添加智能体（复用第1本书的控制器）
twin.add_agent('controller_1', type='PID', controller=pid_controller)

# 配置连接
twin.add_connection('canal_main', 'gate_1')
```

---

### 步骤6：在环测试（本书核心创新）

**目标**：通过大量工况测试验证设计

**测试类型**：
1. **正常工况测试**（30-50个）
   - 不同季节、时段
   - 不同流量、水位组合

2. **扰动测试**（20-30个）
   - 流量阶跃变化
   - 需求波动
   - 参数漂移

3. **故障测试**（10-20个）
   - 传感器失效
   - 执行器卡死
   - 通信中断

4. **极端工况测试**（10个）
   - 暴雨、干旱
   - 设备老化
   - 突发污染

**任务清单**：
- [ ] 生成测试工况（使用工况生成器）
- [ ] 批量运行仿真（并行计算）
- [ ] 收集性能数据
- [ ] 统计分析和可视化

**使用工具**：
```bash
# 生成100种测试工况
python code/tools/scenario_generator.py --type irrigation --n 100

# 批量运行测试
python run_batch_test.py --config config.json --scenarios scenarios.json

# 分析测试结果
python analyze_results.py --results test_results/
```

---

### 步骤7：性能评估与文档生成（本书新增）

**目标**：评估智能化等级，生成设计交付物

**性能评估指标**：
1. **水力性能**：
   - 配水均匀度
   - 水量利用系数
   - 输水效率

2. **控制性能**：
   - 响应时间
   - 超调量
   - 稳态误差
   - 鲁棒性

3. **智能化等级**（使用评估工具）：
   - 自动化程度
   - 控制精度
   - 响应速度
   - 鲁棒性
   - 可维护性

**任务清单**：
- [ ] 运行智能化等级评估工具
- [ ] 生成性能评估报告
- [ ] 编写设计说明书
- [ ] 编制投资概算
- [ ] 整理代码和配置文件

**使用工具**：
```bash
# 智能化等级评估
python code/tools/intelligence_grader.py --sensors 30 --controllers 10 --target L2

# 生成设计文档
python code/tools/report_generator.py --template 设计说明书模板.docx \\
    --output 设计说明书.pdf

# 投资概算
python code/tools/cost_estimator.py --config config.json --output 概算表.xlsx
```

**交付物清单**：
- [ ] 设计说明书（PDF）
- [ ] 水力计算书
- [ ] 工程图纸（CAD）
- [ ] 仿真代码包（Python + 配置文件）
- [ ] 在环测试报告
- [ ] 智能化等级证书
- [ ] 投资概算表（Excel）
- [ ] 使用说明书

---

## 🎯 智能化等级选择指南

### 如何选择目标等级？

**考虑因素**：
1. 工程规模（投资额）
2. 运维能力（技术人员水平）
3. 业主需求（自动化程度要求）
4. 投资回收期（经济效益分析）

**等级推荐**：

| 工程类型 | 推荐等级 | 理由 |
|---------|---------|------|
| 小型灌区（<5000亩） | L2 | 成本低，易维护 |
| 中型灌区（5000-5万亩） | L2-L3 | 协调控制，提高效率 |
| 大型灌区（>5万亩） | L3-L4 | 需要优化调度 |
| 城市供水管网 | L3-L4 | 需求多变，要求高 |
| 跨流域调水 | L4-L5 | 系统复杂，重要性高 |
| 智慧水务 | L4-L5 | 技术先进，示范工程 |

### 各等级增量投资

| 等级 | 相对传统设计增量 | 典型投资额（万元/km²） |
|------|----------------|---------------------|
| L1 | +5% | 5-10 |
| L2 | +15% | 15-25 |
| L3 | +25% | 25-40 |
| L4 | +40% | 40-60 |
| L5 | +60% | 60-100 |

---

## 💡 设计最佳实践

### 1. 模块化设计

**原则**：将系统分解为独立模块，便于开发、测试和维护

**示例**：
```
灌区系统
├── 干渠模块（独立）
├── 支渠1模块（独立）
├── 支渠2模块（独立）
...
└── 监控中心模块（协调）
```

### 2. 逐步升级

**原则**：先从L2开始，根据运行效果逐步升级

**路径**：
```
Phase 1：L1（监测）→ Phase 2：L2（局部控制）
    ↓
Phase 3：L3（协调控制）→ Phase 4：L4（优化调度）
```

### 3. 冗余备份

**原则**：关键节点设置冗余，提高可靠性

**措施**：
- 双传感器互为备份
- 手动/自动双模式
- 本地/远程双控制
- 有线/无线双通信

### 4. 人机协同

**原则**：不要完全排除人工，而是人机协同

**设计**：
- 自动为主，人工为辅
- 异常情况人工接管
- 保留人工调节接口
- 提供决策支持（而非替代决策）

### 5. 在环测试驱动

**原则**：设计阶段就要考虑测试，测试驱动设计优化

**流程**：
```
初步设计 → 在环测试 → 发现问题 → 优化设计 → 再测试 → 验收
```

---

## 🔧 常用设计模式

### 模式1：串级控制

**适用场景**：多级系统，下游影响上游

**示例**：干渠-支渠串联系统

**设计要点**：
- 主控制器（上游）
- 副控制器（下游）
- 前馈补偿（提前响应）

### 模式2：前馈-反馈复合

**适用场景**：存在可测扰动

**示例**：已知上游流量变化，控制下游水位

**设计要点**：
- 前馈通道（快速响应）
- 反馈通道（消除误差）
- 两通道权重分配

### 模式3：解耦控制

**适用场景**：多输入多输出（MIMO），耦合严重

**示例**：多闸门系统，相互影响

**设计要点**：
- 分析耦合关系
- 设计解耦器
- 独立控制各回路

### 模式4：分层递阶

**适用场景**：大规模复杂系统

**示例**：流域水资源管理

**设计要点**：
- 分层决策（管理层、调度层、控制层）
- 层间协调（目标分解、信息反馈）
- 自治+协同

---

## 📊 设计案例库

本书提供5个完整案例，覆盖典型应用场景：

| 案例 | 应用领域 | 智能化等级 | 关键技术 | 适用范围 |
|------|---------|-----------|---------|---------|
| 案例1 | 灌区 | L2 | PID控制 | 5000亩灌区 |
| 案例2 | 供水 | L3 | 多点协调 | 县城供水 |
| 案例3 | 防洪 | L4 | 优化调度 | 水库群 |
| 案例4 | 调水 | L4 | MPC | 长距离输水 |
| 案例5 | 流域 | L5 | 数字孪生 | 流域管理 |

**使用建议**：
1. 查找与你项目最相似的案例
2. 学习该案例的设计方法
3. 修改配置文件适配你的项目
4. 运行在环测试验证
5. 根据测试结果调整设计

---

## 🆘 常见问题

### Q1: 如何确定传感器数量和位置？

**A**: 
1. **原则**：关键点必测，次要点选测
2. **关键点**：
   - 渠首（总入口）
   - 各支渠进口
   - 控制断面（闸门附近）
   - 末端（监测供水效果）
3. **密度**：
   - L2：每500-1000m一个监测点
   - L3：每200-500m一个监测点
   - L4-L5：每50-200m一个监测点

### Q2: PID参数如何整定？

**A**:
1. **方法1**：Ziegler-Nichols法（经验公式）
2. **方法2**：数字孪生仿真优化（推荐）
3. **方法3**：现场试凑法
4. **方法4**：自整定算法（L4-L5）

**推荐流程**：
- 方法1获得初值 → 方法2仿真优化 → 方法3现场微调

### Q3: 如何降低成本？

**A**:
1. 选择合适的智能化等级（不要盲目追求高等级）
2. 采用无线通信（省布线成本）
3. 模块化设计，分期建设
4. 优先智能化关键节点
5. 复用现有传感器和设备

### Q4: 如何保证系统可靠性？

**A**:
1. 冗余备份（传感器、控制器、通信）
2. 故障安全设计（fail-safe）
3. 手动接管模式
4. 定期维护巡检
5. 在环测试充分验证

---

## 📚 进一步学习

### 推荐阅读

**基础**：
- 本书案例1-2（必读）
- 第1本书（水系统控制论）案例1-8
- 第2本书（明渠水力学）案例1-12

**进阶**：
- 本书案例3-5
- 第3本书（渠道管道控制）案例13-20
- 相关领域论文和专著

### 实践项目

**入门项目**：
1. 小型灌渠自动化（L2）
2. 水池水位控制（L2）

**进阶项目**：
3. 灌区智能配水（L3）
4. 供水管网优化调度（L3-L4）

**高级项目**：
5. 流域水资源管理系统（L5）

---

**最后更新**：2025-10-31  
**版本**：v1.0.0
