# 案例5：排涝闸站智能调度设计

**难度等级**：⭐⭐⭐ 中高级  
**学习时间**：14学时（4学时水力设计 + 6学时调度设计 + 4学时在环测试）  
**智能化等级**：L3（预报-调度-反馈闭环）  
**工程类型**：低洼区排涝泵闸站

---

## 📖 工程背景

### 项目概况

某市低洼区排涝闸站：
- **功能**：暴雨期快速排水，保护1万亩农田和2000户居民
- **设计排涝流量**：20 m³/s（20年一遇暴雨）
- **闸门**：5孔×3m×2m（宽×高），电动平板闸门
- **排涝河道**：下游感潮河段，受潮位影响
- **受益面积**：10000亩农田 + 2000户居民
- **防护标准**：20年一遇暴雨24小时不淹

### 现状问题

- ❌ **人工开闸**：暴雨期需人工值守，开闸时机难把握
- ❌ **错失排水时机**：低潮位时未及时开闸，错过最佳排水窗口
- ❌ **倒灌风险**：高潮位时未及时关闸，导致外水倒灌
- ❌ **排水效率低**：闸门开度固定，未根据内外水位差优化
- ❌ **无预报调度**：不考虑降雨预报，被动应急

### 改造目标

- ✅ 自动开闸，根据内外水位差智能控制
- ✅ 预报-调度闭环：结合降雨预报，提前预泄
- ✅ 防倒灌保护：外水位高于内水位时自动关闭
- ✅ 优化排水效率：动态调整闸门开度，最大化排水量
- ✅ 智能化等级达到L3

---

## 📐 设计依据（中国标准）

### 主要标准

1. **GB 50265-2016** 《泵闸设计规范》⭐⭐⭐
   - §4.2 排涝标准与设计流量
   - §6.3 闸门型式与尺寸
   - §8.2 排涝调度

2. **SL 13-2015** 《水闸设计规范》⭐⭐
   - §5.2 闸门水力计算
   - §7.3 启闭机选型

3. **GB 50201-2014** 《防洪标准》
   - 农田防护标准（20年一遇）
   - 城镇防护标准（50年一遇）

4. **SL 723-2016** 《排涝泵站工程技术规范》
   - 排涝计算方法

### 参考标准
- GB 50286-2013 《堤防工程设计规范》
- SL 252-2000 《水利水电工程等级划分及洪水标准》

---

## 🔧 复用前序教材成果

### 从案例1复用（灌溉闸站）

```python
# ✅ 直接复用案例1的核心模块

# 1. 闸门模型（完全复用）
from case_01_irrigation_gate.main import (
    TrapezoidalChannel,   # 梯形渠道
    SimplePIDController,  # PID控制器
    IrrigationDigitalTwin  # 数字孪生（需改造为排涝）
)

# 2. 闸门水力计算（完全复用）
# - 堰流公式
# - 孔流公式
# - 闸门流量计算

# 3. PID控制器（复用）
# - 下游水位控制 → 改为上游水位控制
# - 开大闸门放水 → 目标一致（降低水位）
```

**复用率**：约70%代码可直接复用

### 从案例2复用（泵站）

```python
# 复用在环测试方法
# 复用性能评估方法
```

### 本案例创新

```python
# 1. 降雨预报模块（新增）
class RainfallForecast:
    """降雨预报（简化模型）"""
    pass

# 2. 预报-调度闭环（新增）
class ForecastBasedScheduling:
    """基于预报的预泄调度"""
    pass

# 3. 潮位影响（新增）
class TidalEffect:
    """感潮河段潮位变化"""
    pass

# 4. 防倒灌保护（新增）
def anti_backflow_protection(h_inner, h_outer):
    """防倒灌逻辑"""
    if h_outer > h_inner:
        return 0  # 关闭闸门
    else:
        return gate_opening  # 正常开度
```

---

## 📋 设计任务

### 第一部分：水力设计（基于GB 50265-2016）

#### 1.1 设计排涝流量计算

**排涝模数法**：
```python
# 1. 确定排涝模数
q = 1.5  # mm/d （农田，20年一遇）

# 2. 排涝面积
A = 10000  # 亩 = 10000 × 666.7 m² = 6.67 km²

# 3. 设计排涝流量
Q_design = q * A / 86.4  # m³/s
Q_design = 1.5 * 6.67 / 86.4 = 0.116 m³/s

# 4. 考虑暴雨期（24小时排出）
# 降雨量：P = 150 mm（20年一遇）
# 产流系数：α = 0.8
# 径流量：W = P * α * A = 150 * 0.8 * 6.67 = 800,400 m³
# 排水时间：T = 24 h
Q_design = W / (T * 3600) = 800400 / 86400 = 9.26 m³/s

# 5. 考虑安全系数1.2
Q_design = 9.26 * 1.2 ≈ 11 m³/s

# 6. 加上下游顶托，放大到20 m³/s
```

**最终设计流量**：Q = 20 m³/s

#### 1.2 闸门设计

**闸门型式**：电动平板闸门（5孔）

**单孔尺寸**：
- 宽度：b = 3.0 m
- 高度：h_max = 2.0 m
- 总过流宽度：B = 5 × 3.0 = 15.0 m

**闸门流量计算**（堰流）：
```python
# 自由出流（下游水位较低）
Q = m * B * sqrt(2g) * h^(3/2)

# 流量系数
m = 0.385  # 平板闸门

# 验证（h = 1.5m）
Q = 0.385 * 15.0 * sqrt(19.6) * 1.5^(3/2)
Q = 0.385 * 15.0 * 4.43 * 1.84 = 47 m³/s > 20 m³/s ✓
```

**闸门开度**：
- 最大开度：2.0 m（全开）
- 最小开度：0.1 m（涓流）
- 控制方式：PID自动控制

#### 1.3 上游蓄排水区设计

**蓄水区参数**：
- 面积：A = 2 km²
- 正常水位：Z = 2.0 m
- 警戒水位：Z = 2.5 m
- 超警水位：Z = 3.0 m
- 设计最高水位：Z = 3.5 m（防洪墙高度）

**下游感潮河段**：
- 平均潮位：1.5 m
- 高潮位：2.5 m（每日2次）
- 低潮位：0.5 m（每日2次）
- 潮汐周期：12.4小时

---

### 第二部分：智能调度系统设计

#### 2.1 系统架构

```
┌─────────────────────────────────────────┐
│  排涝调度中心（云端）                    │
│  - 降雨预报接入（气象局）                │
│  - 潮汐预报接入（海事局）                │
│  - 优化调度计算                         │
│  - 远程监控与控制                       │
└───────────────┬─────────────────────────┘
                │ 4G/光纤
┌───────────────┴─────────────────────────┐
│  闸站PLC控制系统（边缘）                 │
│  - 实时PID控制                          │
│  - 防倒灌保护                           │
│  - 本地应急控制                         │
│  - 数据采集与上传                       │
└───────────────┬─────────────────────────┘
                │ 4-20mA / RS485
┌───────────────┴─────────────────────────┐
│  传感器与执行器                         │
│  - 上游水位计（2个冗余）                │
│  - 下游水位计（2个冗余）                │
│  - 雨量计                               │
│  - 闸门开度传感器（5个）                │
│  - 闸门启闭机（5台）                    │
│  - 流量计                               │
└─────────────────────────────────────────┘
```

#### 2.2 传感器配置

| 测点 | 类型 | 规格 | 数量 | 精度 |
|------|------|------|------|------|
| 上游水位 | 超声波/雷达 | 0-5m | 2 | ±5mm |
| 下游水位 | 超声波 | 0-3m | 2 | ±5mm |
| 雨量 | 翻斗式雨量计 | 0-200mm/h | 1 | ±2% |
| 闸门开度 | 行程开关 | 0-2m | 5 | ±5mm |
| 流量 | 超声波流量计 | 0-30 m³/s | 1 | ±1% |

**总计**：11个传感器

#### 2.3 控制器设计（L3）

**传统控制**（案例1，L2）：
- 单纯根据当前水位控制闸门开度
- 被动响应，无预见性

**智能调度**（案例5，L3）：
- 结合降雨预报，提前预泄腾库容
- 结合潮位预报，抓住低潮位排水窗口
- 预报-调度-反馈闭环

```python
class DrainageSchedulingController:
    """
    排涝调度控制器（L3智能化等级）
    
    功能：
    1. 实时PID控制（短期，分钟级）
    2. 预报调度（中期，小时级）
    3. 防倒灌保护（实时）
    4. 优化排水时机选择
    """
    
    def __init__(self, target_level=2.0):
        self.target_level = target_level
        
        # 实时PID控制器
        self.pid = SimplePIDController(
            Kp=0.5, Ki=0.1, Kd=0.05,
            setpoint=target_level,
            output_limits=(0, 2.0)  # 闸门开度0-2.0m
        )
        
        # 预报模块
        self.rainfall_forecast = RainfallForecast()
        self.tidal_forecast = TidalForecast()
        
        # 调度参数
        self.warning_level = 2.5  # 警戒水位
        self.emergency_level = 3.0  # 紧急水位
    
    def update(self, h_inner, h_outer, rainfall, dt):
        """
        控制器更新
        
        Parameters:
        -----------
        h_inner : float
            上游内河水位 [m]
        h_outer : float
            下游外河水位 [m]
        rainfall : float
            当前降雨强度 [mm/h]
        dt : float
            时间步长 [s]
        
        Returns:
        --------
        gate_opening : float
            闸门开度 [m]
        """
        # 1. 防倒灌保护（最高优先级）
        if h_outer >= h_inner:
            return 0  # 立即关闭闸门
        
        # 2. 紧急排水（水位超警）
        if h_inner >= self.emergency_level:
            return 2.0  # 全开
        
        # 3. 预报调度决策
        # 获取未来降雨预报
        rainfall_6h = self.rainfall_forecast.get_6h_forecast()
        
        # 获取潮位预报（找到下一个低潮时刻）
        next_low_tide_time = self.tidal_forecast.get_next_low_tide()
        
        # 预泄策略：如果预报有强降雨，提前加大排水
        if rainfall_6h > 50:  # 未来6小时降雨>50mm
            # 提前预泄，目标水位下调0.5m
            self.pid.setpoint = self.target_level - 0.5
        else:
            self.pid.setpoint = self.target_level
        
        # 4. PID计算开度
        opening = self.pid.update(h_inner, dt)
        
        # 5. 根据内外水位差调整（水位差大时可以开大）
        delta_h = h_inner - h_outer
        if delta_h > 1.5:
            opening = min(opening * 1.2, 2.0)  # 加大20%
        elif delta_h < 0.5:
            opening = opening * 0.8  # 减小20%
        
        return opening


class RainfallForecast:
    """
    降雨预报（简化模型）
    
    实际工程中接入气象局数值预报
    """
    def __init__(self):
        self.forecast_data = []
    
    def get_6h_forecast(self):
        """获取未来6小时累计降雨量 [mm]"""
        # 简化：返回随机预报
        return np.random.uniform(0, 100)


class TidalForecast:
    """
    潮位预报（简化模型）
    
    实际工程中接入海事局潮汐表
    """
    def __init__(self):
        self.tidal_period = 12.4 * 3600  # 12.4小时周期
    
    def get_current_tide(self, t):
        """
        获取当前潮位
        
        简化正弦模型：
        h = h_mean + A * sin(2π * t / T)
        """
        h_mean = 1.5  # 平均潮位
        A = 1.0       # 振幅
        h_tide = h_mean + A * np.sin(2 * np.pi * t / self.tidal_period)
        return h_tide
    
    def get_next_low_tide(self):
        """获取下一个低潮时刻 [s]"""
        # 简化：返回固定值
        return 6.2 * 3600  # 6.2小时后
```

---

### 第三部分：动态设计特点（本书创新）

#### 3.1 预报-调度-反馈闭环

传统设计：只看当前水位，被动响应  
**动态设计**：预报驱动，主动预泄

```
降雨预报 ────┐
            ├──→ 预泄决策 ──→ 闸门开度 ──→ 水位变化
潮位预报 ────┘                              │
                                            │
                                            └─→ 反馈
```

**价值**：
- 提前6小时预泄，可腾出库容30%
- 抓住低潮位窗口，排水效率提升40%

#### 3.2 多时间尺度调度

| 时间尺度 | 调度方式 | 更新频率 |
|---------|---------|---------|
| 实时（秒级） | PID反馈控制 | 每10秒 |
| 短期（分钟级） | 水位差优化 | 每分钟 |
| 中期（小时级） | 预报调度 | 每小时 |
| 长期（天级） | 汛前腾库 | 每日 |

#### 3.3 典型暴雨排涝过程模拟

```
时间轴：0h ────6h────12h────18h────24h────30h
        │     │     │     │     │     │
降雨：   无    开始   高峰   减弱   停止   无
        │     │     │     │     │     │
预泄：   ──────▲─────────────────────
        │     │提前预泄（6h前）
        │     │
水位：   2.0m  2.3m  2.8m  2.5m  2.2m  2.0m
        │     │     │     │     │     │
开度：   0.5m  1.2m  2.0m  1.5m  0.8m  0.5m
        │     │     │     │     │     │
说明：   平时  预泄  全开  减弱  恢复  正常
```

---

### 第四部分：在环测试（本书核心）

#### 4.1 测试工况设计

**测试矩阵**（30种工况）:

| 工况类型 | 数量 | 描述 |
|---------|------|------|
| **正常排涝** | 10 | |
| - 小雨排涝 | 3 | 降雨<20 mm/h |
| - 中雨排涝 | 4 | 降雨20-50 mm/h |
| - 大雨排涝 | 3 | 降雨>50 mm/h |
| **潮汐影响** | 10 | |
| - 低潮排水 | 5 | 最佳排水窗口 |
| - 高潮关闸 | 5 | 防倒灌 |
| **预报调度** | 5 | |
| - 预报准确 | 3 | 预泄成功 |
| - 预报偏差 | 2 | 适应调整 |
| **极端工况** | 5 | |
| - 超标准暴雨 | 2 | 50年一遇 |
| - 长历时降雨 | 2 | 持续48小时 |
| - 台风暴雨 | 1 | 100年一遇 |

#### 4.2 性能评估指标

**排涝效果**：
- 最高水位：<3.0m（不超警戒线）
- 退水时间：<24h（回到正常水位）
- 排水总量：满足设计要求

**调度性能**：
- 预泄及时性：提前6小时启动
- 排水时机选择：抓住低潮位窗口
- 倒灌防护：100%成功

**安全性**：
- 防倒灌成功率：100%
- 闸门启闭次数：合理（不过于频繁）

---

## 💡 关键设计参数表

| 参数类别 | 参数名 | 数值 | 单位 | 依据 |
|---------|--------|------|------|------|
| **排涝设计** | | | | GB 50265 |
| 设计排涝流量 | Q | 20 | m³/s | 计算 |
| 防护标准 | P | 20年一遇 | - | GB 50201 |
| 受益面积 | A | 10000 | 亩 | 实测 |
| **闸门参数** | | | | SL 13 |
| 闸门孔数 | n | 5 | 孔 | 设计 |
| 单孔宽度 | b | 3.0 | m | |
| 单孔高度 | h | 2.0 | m | |
| 流量系数 | m | 0.385 | - | 规范 |
| **水位控制** | | | | 运行 |
| 正常水位 | Z | 2.0 | m | 设计 |
| 警戒水位 | Z | 2.5 | m | |
| 紧急水位 | Z | 3.0 | m | |
| 设计最高水位 | Z | 3.5 | m | |
| **控制参数** | | | | 整定 |
| PID_Kp | Kp | 0.5 | - | |
| PID_Ki | Ki | 0.1 | - | |
| PID_Kd | Kd | 0.05 | - | |
| 目标水位 | setpoint | 2.0 | m | |

---

## 🎯 与案例1的对比

| 对比项 | 案例1（灌溉闸站） | 案例5（排涝闸站） | 升级点 |
|-------|----------------|----------------|-------|
| **控制目标** | 下游水位 | 上游水位 | 反向 |
| **控制模式** | 反馈控制 | **预报-调度-反馈** | ⬆️⬆️ |
| **外部输入** | 无 | 降雨预报+潮位预报 | ⬆️⬆️ |
| **时间尺度** | 单一（实时） | **多尺度（实时+小时+日）** | ⬆️⬆️ |
| **优化目标** | 水位稳定 | **最大化排水+抓窗口期** | ⬆️ |
| **复杂度** | ⭐⭐ | ⭐⭐⭐ | ⬆️ |
| **智能化等级** | L2-L3 | **L3（协调调度）** | ⬆️ |
| **代码复用** | - | **70%复用案例1** | ✅ |

**案例5创新**：
- ✅ 预报驱动的主动调度
- ✅ 多时间尺度协调
- ✅ 感潮河段特殊处理

---

## 💻 运行方式

```bash
cd /workspace/books/intelligent-water-network-design/code/examples/case_05_drainage_gate

# 运行主程序
python main.py

# 运行暴雨排涝模拟
python simulate_storm_drainage.py
```

---

## 🔗 与其他案例的关系

**前序案例**:
- 案例1：闸门模型、PID控制（70%复用）

**后续案例**:
- 案例7：串级渠道（复用案例1+5）
- 案例11：城市雨水系统（复用案例5×10）

---

## ⏭️ 下一个案例

**案例6：多功能水闸设计（L3）**
- 灌溉+排涝+通航+生态多目标
- 冲突协调与优先级管理

---

**案例5开发状态**: 🔄 开发中  
**预计完成时间**: 1周后  
**最后更新**: 2025-10-31
