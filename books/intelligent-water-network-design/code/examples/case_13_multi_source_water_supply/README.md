# 案例13：多水源供水系统设计

**难度等级**：⭐⭐⭐⭐⭐⭐ 高级（Level 3首案例）  
**学习时间**：30学时（10学时建模 + 14学时控制 + 6学时测试）  
**智能化等级**：L3-L4（协调控制到优化调度）  
**工程类型**：区域多水源联合供水系统

---

## 📖 工程背景

### 项目概况

某市区域供水系统：
- **供水规模**：100万m³/日（50万人口）
- **水源数**：4个（地表水×2 + 地下水×1 +再生水×1）
- **水厂数**：3座（常规+深度+再生）
- **供水分区**：8个
- **调蓄设施**：2座大型水库（各100万m³）
- **供水范围**：城市+工业+农业

### Level 3特点：从局部→区域

| 对比项 | Level 2（案例9） | Level 3（案例13） | 升级 |
|-------|-----------------|------------------|------|
| **规模** | 5压力分区 | 4水源+3水厂+8分区 | ⬆️⬆️⬆️ |
| **尺度** | 市区（10km²） | 区域（100km²） | ×10 |
| **水源** | 单一 | 多水源优化配置 | ⬆️⬆️⬆️ |
| **优化** | 压力平衡 | 成本+水质+供需 | ⬆️⬆️⬆️ |
| **智能化** | L3 | L3-L4 | ⬆️ |

### 现状问题

传统供水（单一水源为主）：
- ❌ **水源不稳定**：枯水期地表水不足
- ❌ **成本高**：全部使用高成本水源
- ❌ **水质不优**：无分质供水
- ❌ **应急差**：单一水源故障，全城停水
- ❌ **浪费严重**：工业用优质水，浪费

### 改造目标

- ✅ 多水源联合调度（4水源优化配置）
- ✅ 分质供水（生活+工业+农业）
- ✅ 成本最优（降低制水成本20%）
- ✅ 应急保障（任意1水源故障，保证70%供水）
- ✅ 智能化等级L3-L4

---

## 📐 设计依据（中国标准）

### 主要标准

1. **GB 50282-2016** 《城市给水工程规划规范》⭐⭐⭐
   - §4 水源
   - §5 给水系统

2. **GB 50013-2018** 《室外给水设计标准》⭐⭐⭐
   - 多水源

3. **CJJ 92-2016** 《城镇供水管网运行、维护及安全技术规程》⭐⭐

---

## 🔧 复用案例2+9

### 高度复用（70%）

```python
# ✅ 复用案例2（泵站）
from case_02_pump_station import Pump, MultiPumpController

# ✅ 复用案例9（压力分区）
from case_09_water_network_pressure import PressureZoneCoordinator

# 扩展：4水源+3水厂+8分区
```

**复用率**：70%（案例2 30% + 案例9 40%）

### 本案例创新

```python
# 1. 多水源优化调度器（新增）⭐⭐⭐⭐
class MultiSourceOptimizer:
    """
    多水源优化调度器（本案例最大创新）
    
    功能：
    - 4个水源优化配置
    - 成本最优（制水成本+输水成本）
    - 分质供水（生活/工业/农业）
    - 应急保障（水源故障切换）
    
    优化目标：
    - 最小化总成本
    - 满足水质要求
    - 保证供水安全
    """
    pass

# 2. 分质供水策略（新增）⭐⭐
class WaterQualityBasedAllocation:
    """
    分质供水策略
    
    功能：
    - 生活用水：高质水（地表水处理）
    - 工业用水：中质水（地下水/再生水）
    - 农业用水：低质水（再生水）
    """
    pass

# 3. 应急调度模块（新增）⭐⭐
class EmergencyDispatch:
    """
    应急调度模块
    
    功能：
    - 水源故障检测
    - 应急切换（<10min）
    - 保证70%供水
    """
    pass
```

---

## 📋 设计任务

### 第一部分：多水源系统建模

#### 1.1 系统拓扑

```
水源层（4个）
├─ 水源1：水库A（地表水，80万m³/日，成本1.5元/m³）
├─ 水源2：水库B（地表水，60万m³/日，成本1.8元/m³）
├─ 水源3：水井群（地下水，30万m³/日，成本2.0元/m³）
└─ 水源4：再生水厂（再生水，20万m³/日，成本1.0元/m³）
    │
    ▼ 输水管线
水厂层（3个）
├─ 水厂1：常规处理（50万m³/日）←水源1/2
├─ 水厂2：深度处理（30万m³/日）←水源1/2/3
└─ 水厂3：再生水处理（20万m³/日）←水源4
    │
    ▼ 配水管网
供水分区（8个）
├─ 分区1-4：居民区（生活用水，高质）
├─ 分区5-6：工业区（工业用水，中质）
└─ 分区7-8：农业区（农业用水，低质）
```

#### 1.2 水源参数

| 水源 | 类型 | 能力 [万m³/日] | 成本 [元/m³] | 水质 | 可靠性 |
|------|------|---------------|-------------|------|--------|
| 水源1 | 地表水 | 80 | 1.5 | 优 | 85% |
| 水源2 | 地表水 | 60 | 1.8 | 优 | 80% |
| 水源3 | 地下水 | 30 | 2.0 | 良 | 95% |
| 水源4 | 再生水 | 20 | 1.0 | 中 | 90% |

#### 1.3 需水分类

| 用户类型 | 日需水 [万m³] | 水质要求 | 可接受水源 |
|---------|--------------|---------|-----------|
| 生活用水 | 50 | 优质 | 水源1/2 |
| 工业用水 | 30 | 中质 | 水源1/2/3/4 |
| 农业用水 | 20 | 低质 | 水源4 |
| **总计** | **100** | - | - |

---

### 第二部分：多水源优化调度控制设计（L3-L4核心）

#### 2.1 优化调度策略

```python
class MultiSourceCoordinator:
    """
    多水源供水系统协调控制器（L3-L4）
    
    功能：
    1. 多水源优化配置（成本最优）⭐⭐⭐
    2. 分质供水（生活/工业/农业）⭐⭐
    3. 应急调度（水源故障）⭐
    4. 水库调蓄优化
    
    优化目标：
    - 最小化总成本 = 制水成本 + 输水成本
    - 约束条件：
      * 满足总需水量
      * 满足水质要求
      * 不超过水源能力
    
    创新：多水源成本优化+分质供水
    """
    
    def __init__(self):
        # 水源参数
        self.sources = [
            {'name': '水库A', 'capacity': 80, 'cost': 1.5, 'quality': 'high'},
            {'name': '水库B', 'capacity': 60, 'cost': 1.8, 'quality': 'high'},
            {'name': '水井群', 'capacity': 30, 'cost': 2.0, 'quality': 'medium'},
            {'name': '再生水', 'capacity': 20, 'cost': 1.0, 'quality': 'low'}
        ]
        
        # 需水类型
        self.demands = {
            'residential': 50,  # 生活
            'industrial': 30,   # 工业
            'agricultural': 20  # 农业
        }
        
        # 优化器
        self.optimizer = MultiSourceOptimizer()
        
        # 应急调度
        self.emergency = EmergencyDispatch()
    
    def optimize_allocation(self, demands: dict, source_status: list) -> dict:
        """
        优化水源配置
        
        Parameters:
        -----------
        demands : dict
            各类用水需求 {'residential': 50, 'industrial': 30, 'agricultural': 20}
        source_status : list
            各水源状态 [1, 1, 1, 1] (1=正常, 0=故障)
        
        Returns:
        --------
        allocation : dict
            水源分配方案
            {
                'source1_to_residential': 30,
                'source2_to_residential': 20,
                'source3_to_industrial': 20,
                'source4_to_industrial': 10,
                'source4_to_agricultural': 20,
                'total_cost': 150
            }
        """
        # 简化的线性规划求解
        # 目标函数：min Σ(cost_i × Q_i)
        # 约束：
        #   1. Σ Q_i = Total_demand
        #   2. Q_i <= capacity_i
        #   3. 水质匹配
        
        allocation = {}
        total_cost = 0
        
        # 分质供水策略
        # 1. 生活用水：优先水源1（成本低，水质好）
        if source_status[0]:
            allocation['source1_to_residential'] = min(50, 80)
            total_cost += 50 * 1.5
        
        # 2. 工业用水：优先再生水（成本低）
        if source_status[3]:
            allocation['source4_to_industrial'] = min(30, 20)
            total_cost += 20 * 1.0
            # 剩余10万m³用水源3
            if source_status[2]:
                allocation['source3_to_industrial'] = 10
                total_cost += 10 * 2.0
        
        # 3. 农业用水：全部再生水
        if source_status[3]:
            allocation['source4_to_agricultural'] = 20
            # 再生水已全部用于工业20+农业20=40万m³（超出能力20万m³）
            # 修正：农业用水改用剩余再生水
            allocation['source4_to_agricultural'] = 0
            # 用水源1剩余
            allocation['source1_to_agricultural'] = 20
            total_cost += 20 * 1.5
        
        allocation['total_cost'] = total_cost
        
        return allocation
```

---

### 第三部分：动态设计特点（本书创新）

#### 3.1 Level 3 vs Level 2

| 对比项 | Level 2（案例9） | Level 3（案例13） |
|-------|-----------------|------------------|
| **水源** | 1个（城市供水） | 4个（多水源） ⭐ |
| **优化** | 压力平衡 | 成本+水质+供需 ⭐⭐ |
| **规模** | 5分区 | 4水源+3水厂+8分区 ⭐ |
| **应急** | 无 | 水源故障切换 ⭐ |
| **分质** | 无 | 生活/工业/农业 ⭐⭐ |

#### 3.2 多水源优化价值

**单一水源 vs 多水源**：

| 对比项 | 单一水源（传统） | 多水源优化（本案例） |
|-------|----------------|-------------------|
| **制水成本** | 全部高质水，1.8元/m³ | 分质供水，1.4元/m³ | 
| **年成本** | 180万元/天×365 = 6.57亿元 | 140万元/天×365 = 5.11亿元 |
| **节约** | - | **1.46亿元/年**（22%） ⭐ |
| **应急能力** | 水源故障→停水 | 任意1水源故障，保证70% |
| **水资源利用** | 单一 | 多元化，可持续 ⭐ |

---

## 💡 关键设计参数

| 参数 | 水源1 | 水源2 | 水源3 | 水源4 | 单位 |
|------|------|------|------|------|------|
| **能力** | 80 | 60 | 30 | 20 | 万m³/日 |
| **成本** | 1.5 | 1.8 | 2.0 | 1.0 | 元/m³ |
| **水质** | 优 | 优 | 良 | 中 | - |

---

## 🎯 与案例2/9的对比

| 对比项 | 案例2 | 案例9 | 案例13 |
|-------|------|------|--------|
| **泵站数** | 1 | 0 | 3水厂 |
| **压力分区** | 0 | 5 | 8 |
| **水源** | 1 | 1 | **4** ⭐ |
| **优化目标** | 水位 | 压力 | **成本+水质** ⭐ |
| **复用** | - | 85%案例4 | 70%案例2+9 |

---

## 💻 运行方式

```bash
cd code/examples/case_13_multi_source_water_supply
python main.py
```

---

**案例13开发状态**: 🔄 开发中  
**预计完成时间**: 2小时  
**最后更新**: 2025-10-31
