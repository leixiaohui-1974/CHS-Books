# 案例1：灌溉闸门优化设计

## 一、案例简介

本案例展示了灌区智能化升级工程的完整设计流程，是智能水网工程设计的入门级综合案例（L2智能化等级）。案例涉及1条主干渠和10条支渠的智能闸门控制系统，通过PID控制器实现闸门开度的自动调节，保持各支渠水位稳定在目标值1.8米。系统采用数字孪生仿真技术进行24小时运行测试，验证控制精度和系统鲁棒性。本案例充分展示了如何复用前序教材的成果（明渠水力学模型、PID控制器），同时引入智能化等级评估体系，为后续更复杂的水网设计奠定基础。

## 二、系统架构与技术背景

### 2.1 水力设计基础

系统采用经典梯形渠道模型，基于Manning公式计算正常水深和水力要素。主干渠设计流量为5.0 m³/s，渠底宽度3.0米，边坡系数1.5，糙率0.020。10条支渠采用统一设计参数，每条设计流量0.5 m³/s，渠底宽度1.0米。水力计算采用牛顿迭代法求解正常水深，确保所有渠道均为缓流状态（Froude数<1），保证运行安全。

### 2.2 智能控制架构

控制系统采用分布式多闸门PID控制架构，每条支渠配备独立的水位传感器和闸门控制器。PID参数经过调优设置为Kp=2.0、Ki=0.3、Kd=0.05，输出限幅在[0, 1]范围内对应闸门开度。系统采用60秒采样周期，响应时间约4分钟，满足灌区实时调度需求。控制器采用抗积分饱和设计，避免长时间大误差导致的超调。

### 2.3 数字孪生仿真技术

数字孪生模型采用简化的一阶惯性环节描述渠道水位动态，时间常数设置为10分钟，反映实际灌区的延迟特性。仿真器集成了水力模型、控制算法和传感器数据，能够实时推演系统状态，预测未来趋势。通过24小时连续仿真，系统记录所有支渠的水位、闸门开度等关键变量，为性能评估提供数据支持。

## 三、代码说明

### 3.1 核心模块

1. **TrapezoidalChannel类**：梯形渠道水力计算模型
   - `compute_normal_depth(Q)`：计算给定流量的正常水深
   - `get_hydraulic_elements(h)`：获取完整水力要素
   - `froude_number(h)`：计算Froude数判断流态

2. **SimplePIDController类**：PID控制器
   - `update(current_value, dt)`：计算控制输出
   - `reset()`：重置积分和微分状态

3. **IrrigationDigitalTwin类**：数字孪生仿真器
   - `step()`：推进一个仿真时间步
   - `run_simulation(duration)`：运行指定时长的仿真
   - 状态变量：`h_branches`（支渠水位）、`gate_openings`（闸门开度）

4. **IntelligenceGrader类**：智能化等级评估器
   - `evaluate(twin, simulation_results)`：综合评估系统性能
   - 评估维度：自动化程度、控制精度、响应速度、鲁棒性、可维护性

### 3.2 程序结构

```python
# 步骤1：导入前序教材的模块（明渠模型、PID控制器）
# 步骤2：水力设计（干渠+10条支渠）
# 步骤3：控制器设计（10个PID闸门控制器）
# 步骤4：数字孪生仿真（24小时运行）
# 步骤5：性能评估与可视化
# 步骤6：智能化等级评估
```

## 四、运行方法

### 4.1 环境要求

```bash
# 安装依赖
pip install numpy matplotlib

# 确保Python版本 >= 3.7
python --version
```

### 4.2 执行仿真

```bash
# 运行主程序
cd /home/user/CHS-Books/books/intelligent-water-network-design/code/examples/case_01
python main.py

# 运行单元测试
cd /home/user/CHS-Books/books/intelligent-water-network-design/code/examples/case_01_irrigation_gate
python test_case_01.py
```

### 4.3 输出结果

程序将生成：
- 终端输出：水力计算结果、仿真进度、性能指标、智能化等级评估
- 图表文件：`case_01_simulation_results.png`（包含水位变化、闸门开度、统计指标三个子图）

## 五、参数说明

### 5.1 水力参数

| 参数 | 符号 | 数值 | 单位 | 说明 |
|------|------|------|------|------|
| 设计流量 | Q_design | 5.0 | m³/s | 干渠设计流量 |
| 渠底宽度 | b_main | 3.0 | m | 干渠渠底宽度 |
| 边坡系数 | m_slope | 1.5 | - | 边坡坡度1:1.5 |
| 渠底坡度 | S0_main | 0.0003 | - | 干渠纵坡 |
| Manning糙率 | n_manning | 0.020 | - | 混凝土衬砌 |
| 支渠流量 | Q_branches | 0.5 | m³/s | 每条支渠流量 |

### 5.2 控制参数

| 参数 | 数值 | 说明 |
|------|------|------|
| Kp | 2.0 | 比例增益 |
| Ki | 0.3 | 积分增益 |
| Kd | 0.05 | 微分增益 |
| setpoint | 1.8 m | 目标水位 |
| 采样周期 | 60 s | 控制器更新周期 |
| 输出限幅 | [0, 1] | 闸门开度范围 |

### 5.3 仿真参数

| 参数 | 数值 | 说明 |
|------|------|------|
| 仿真时长 | 24小时 | 完整日调度周期 |
| 时间步长 | 60秒 | 仿真精度 |
| 渠道面积 | 10 m² | 简化水量平衡计算 |
| 时间常数 | 600秒 | 一阶惯性环节 |

## 六、预期结果

### 6.1 水力计算

- 干渠正常水深：约2.2米
- 干渠流速：约0.8 m/s
- Froude数：约0.3（缓流）
- 支渠正常水深：约0.8-1.0米

### 6.2 控制性能

- 平均水位偏差：< 0.05米
- 超调量：< 10%
- 响应时间：约4分钟
- 稳态误差：< 2%
- 配水均匀度：> 90%

### 6.3 智能化等级评估

| 评估维度 | 目标分数 | 预期结果 | 状态 |
|----------|----------|----------|------|
| 自动化程度 | ≥80 | ~95 | ✓ 通过 |
| 控制精度 | ≥85 | ~90 | ✓ 通过 |
| 响应速度 | ≥80 | ~95 | ✓ 通过 |
| 鲁棒性 | ≥75 | ~85 | ✓ 通过 |
| 可维护性 | ≥80 | 85 | ✓ 通过 |

**综合评定：L2智能化等级（条件自动化）**

## 七、应用场景

1. **大中型灌区现代化改造**：适用于5-10万亩灌区，实现闸门自动控制，减少人工巡查
2. **精准农业灌溉**：配合土壤墒情监测，实现按需灌溉，节水20-30%
3. **灌区信息化示范工程**：作为智慧水利建设的典型案例，展示控制技术应用
4. **水利工程教学实验**：适合水利、农业工程专业本科生和研究生实践教学
5. **在环测试平台**：为新型控制算法提供仿真测试环境，降低实地试验风险

## 八、技术特点

1. **模块化设计**：水力、控制、仿真模块独立，便于扩展和维护
2. **代码复用**：充分利用前序教材的明渠模型和PID控制器，避免重复开发
3. **性能可视化**：自动生成多维度图表，直观展示系统运行状态
4. **智能化评估**：引入五维度评估体系，量化系统智能化水平
5. **单元测试完备**：包含12个测试用例，覆盖核心功能和边界条件

## 九、扩展方向

1. **多级渠道系统**：扩展到三级渠道（干渠-支渠-斗渠），增加层级控制
2. **水量分配优化**：引入优化算法，实现多目标配水（效率、公平、节能）
3. **故障诊断**：添加传感器故障检测和容错控制
4. **预测性调度**：结合气象预报和作物需水预测，实现前馈控制
5. **物联网集成**：对接SCADA系统，实现远程监控和移动端操作

## 十、参考文献

1. 茆智, 等. 《明渠非恒定流》. 清华大学出版社, 2013
2. 陈守煜. 《灌溉排水系统工程学》. 中国水利水电出版社, 2007
3. 王福军. 《计算流体动力学分析》. 清华大学出版社, 2004
4. Åström K J, Hägglund T. *PID Controllers: Theory, Design, and Tuning*. ISA, 1995
5. Litrico X, Fromion V. *Modeling and Control of Hydrosystems*. Springer, 2009
6. GB/T 50085-2007. 《灌溉与排水工程设计规范》
7. SL 677-2014. 《灌区信息化建设技术导则》
8. Maestre J M, et al. "Distributed model predictive control based on agent negotiation". *Journal of Process Control*, 2011, 21(5): 685-697

---

**作者**：CHS-Books项目组
**日期**：2025-10-31
**版本**：v1.0
**许可**：本代码仅供学习和研究使用
