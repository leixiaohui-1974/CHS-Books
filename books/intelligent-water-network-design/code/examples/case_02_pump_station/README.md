# æ¡ˆä¾‹2ï¼šææ°´æ³µç«™æ™ºèƒ½åŒ–è®¾è®¡

**éš¾åº¦ç­‰çº§**ï¼šâ­â­ ä¸­çº§  
**å­¦ä¹ æ—¶é—´**ï¼š12å­¦æ—¶ï¼ˆ4å­¦æ—¶æ°´åŠ›è®¾è®¡ + 4å­¦æ—¶æ§åˆ¶è®¾è®¡ + 4å­¦æ—¶åœ¨ç¯æµ‹è¯•ï¼‰  
**æ™ºèƒ½åŒ–ç­‰çº§**ï¼šL2ï¼ˆå•æ³µï¼‰â†’ L3ï¼ˆå¤šæ³µåè°ƒï¼‰  
**å·¥ç¨‹ç±»å‹**ï¼šçŒåŒºé¦–éƒ¨ææ°´æ³µç«™

---

## ğŸ“– å·¥ç¨‹èƒŒæ™¯

### é¡¹ç›®æ¦‚å†µ

æŸå¿çº§çŒåŒºé¦–éƒ¨ææ°´æ³µç«™ï¼š
- **åŠŸèƒ½**ï¼šä»æ²³é“ææ°´è‡³æ€»å¹²æ¸ ï¼Œä¾›åº”5000äº©çŒåŒº
- **è®¾è®¡æ‰¬ç¨‹**ï¼š15mï¼ˆä»æ²³é“Î”Z=50mè‡³æ¸ é¦–Î”Z=65mï¼‰
- **è®¾è®¡æµé‡**ï¼š3.6 mÂ³/sï¼ˆçŒæº‰é«˜å³°æœŸï¼‰
- **è£…æœºæ–¹æ¡ˆ**ï¼š3å°ç«‹å¼è½´æµæ³µï¼Œå•æ³µæµé‡1.2 mÂ³/s
- **æ€»è£…æœºåŠŸç‡**ï¼š250kWï¼ˆå•æ³µ80-85kWï¼‰
- **å¹´è¿è¡Œæ—¶é—´**ï¼š2000å°æ—¶ï¼ˆçŒæº‰å­£ï¼‰
- **å¹´ç”µè´¹**ï¼šçº¦35ä¸‡å…ƒï¼ˆæŒ‰0.7å…ƒ/kWhï¼‰

### ç°çŠ¶é—®é¢˜

- âŒ **äººå·¥å¯åœ**ï¼šéœ€è¦1äºº24å°æ—¶å€¼å®ˆï¼ŒåŠ³åŠ¨å¼ºåº¦å¤§
- âŒ **èƒ½è€—é«˜**ï¼šå¯åœä¸åˆç†ï¼Œä½æ•ˆåŒºè¿è¡Œå¤š
- âŒ **æ°´é”¤é£é™©**ï¼šæ‰‹åŠ¨å…³é—­å¤ªå¿«ï¼Œç®¡é“æ˜“æŸå
- âŒ **åº”æ€¥èƒ½åŠ›å¼±**ï¼šå¤œé—´æ•…éšœæ— æ³•åŠæ—¶å“åº”

### æ”¹é€ ç›®æ ‡

- âœ… è‡ªåŠ¨å¯åœï¼Œæ— äººå€¼å®ˆ
- âœ… èƒ½è€—ä¼˜åŒ–ï¼ŒèŠ‚ç”µ15%ä»¥ä¸Š
- âœ… æ°´é”¤ä¿æŠ¤ï¼Œå»¶é•¿ç®¡é“å¯¿å‘½
- âœ… è¿œç¨‹ç›‘æ§ï¼Œæ•…éšœåŠæ—¶æŠ¥è­¦
- âœ… æ™ºèƒ½åŒ–ç­‰çº§è¾¾åˆ°L2-L3

---

## ğŸ“ è®¾è®¡ä¾æ®ï¼ˆä¸­å›½æ ‡å‡†ï¼‰

### ä¸»è¦æ ‡å‡†

1. **GB 50265-2022** ã€Šæ³µç«™è®¾è®¡æ ‡å‡†ã€‹â­â­â­
   - Â§4.2.3 æ³µç«™è®¾è®¡æµé‡è®¡ç®—
   - Â§5.3.1 æ°´æ³µé€‰å‹åŸåˆ™
   - Â§6.2.4 è¿›å‡ºæ°´æ± è®¾è®¡
   - Â§8.1 æ³µç«™è‡ªåŠ¨åŒ–ä¸ä¿¡æ¯åŒ–

2. **SL 285-2003** ã€Šæ³µç«™å®‰å…¨é‰´å®šè§„ç¨‹ã€‹
   - æ³µç«™å®‰å…¨ç­‰çº§åˆ’åˆ†
   - è®¾å¤‡å®‰å…¨è¯„ä»·æ ‡å‡†

3. **GB/T 29529-2013** ã€Šæ³µé€ç³»ç»Ÿèƒ½æ•ˆè¯„ä¼°å¯¼åˆ™ã€‹
   - æ³µé€ç³»ç»Ÿèƒ½æ•ˆè¯„ä»·æ–¹æ³•
   - èŠ‚èƒ½æ½œåŠ›åˆ†æ

### å‚è€ƒæ ‡å‡†
- GB 50289-2016 ã€ŠåŸå¸‚å·¥ç¨‹ç®¡çº¿ç»¼åˆè§„åˆ’è§„èŒƒã€‹
- DL/T 5151-2014 ã€Šæ³µç«™æŠ€æœ¯æ”¹é€ è§„èŒƒã€‹

---

## ğŸ”§ å¤ç”¨å‰åºæ•™ææˆæœ

### ä»ç¬¬2æœ¬ä¹¦å¤ç”¨ï¼ˆæ˜æ¸ æ°´åŠ›å­¦ï¼‰

```python
# 1. å¤ç”¨ç¬¬2æœ¬ä¹¦æ¡ˆä¾‹10ï¼šæ³µç«™è®¾è®¡è®¡ç®—
from books.open_channel_hydraulics.code.models.pump import (
    Pump,                    # æ³µæ¨¡å‹
    compute_system_curve,    # ç³»ç»Ÿç‰¹æ€§æ›²çº¿
    find_operating_point     # å·¥å†µç‚¹è®¡ç®—
)

# 2. å¤ç”¨ç¬¬2æœ¬ä¹¦æ¡ˆä¾‹25-27ï¼šæ°´é”¤åˆ†æ
from books.open_channel_hydraulics.code.solvers.unsteady.water_hammer import (
    WaterHammerAnalyzer,     # æ°´é”¤åˆ†æå™¨
    compute_hammer_pressure  # æ°´é”¤å‹åŠ›è®¡ç®—
)

# ä½¿ç”¨ç¤ºä¾‹
pump = Pump(
    Q_rated=1.2,   # é¢å®šæµé‡1.2 mÂ³/s
    H_rated=15.0,  # é¢å®šæ‰¬ç¨‹15m
    P_rated=80.0,  # é¢å®šåŠŸç‡80kW
    speed=1450     # è½¬é€Ÿrpm
)

# è®¡ç®—å·¥å†µç‚¹
H, eta, P = pump.compute_operating_point(Q=1.0)
print(f"æµé‡1.0mÂ³/sæ—¶ï¼šæ‰¬ç¨‹{H:.2f}m, æ•ˆç‡{eta:.2%}, åŠŸç‡{P:.2f}kW")
```

### ä»ç¬¬1æœ¬ä¹¦å¤ç”¨ï¼ˆæ°´ç³»ç»Ÿæ§åˆ¶ï¼‰

```python
# å¤ç”¨ç¬¬1æœ¬ä¹¦æ¡ˆä¾‹4ï¼šPIDæ§åˆ¶å™¨
from books.water_system_control.code.control.pid import PIDController

# è¿›æ°´æ± æ°´ä½æ§åˆ¶å™¨
level_controller = PIDController(
    Kp=1.5,           # æ¯”ä¾‹ç³»æ•°
    Ki=0.3,           # ç§¯åˆ†ç³»æ•°
    Kd=0.05,          # å¾®åˆ†ç³»æ•°
    setpoint=3.5,     # ç›®æ ‡æ°´ä½3.5m
    output_limits=(0, 3),  # è¾“å‡º0-3å°æ³µ
    windup_limit=2.0  # æŠ—ç§¯åˆ†é¥±å’Œ
)

# å¤ç”¨ç¬¬1æœ¬ä¹¦æ¡ˆä¾‹6ï¼šé˜¶è·ƒå“åº”åˆ†æ
from books.water_system_control.code.examples.case_06_step_response import (
    calculate_step_response_metrics
)
```

### ä»ç¬¬3æœ¬ä¹¦å¤ç”¨ï¼ˆæ¸ é“ç®¡é“æ§åˆ¶ï¼‰

```python
# å¤ç”¨ç¬¬3æœ¬ä¹¦çš„æ•°å­—å­ªç”Ÿæ€æƒ³ï¼ˆæ¡ˆä¾‹13ï¼‰
# å¤ç”¨å¤šæ™ºèƒ½ä½“åè°ƒæ§åˆ¶æ–¹æ³•
```

---

## ğŸ“‹ è®¾è®¡ä»»åŠ¡

### ç¬¬ä¸€éƒ¨åˆ†ï¼šæ°´åŠ›è®¾è®¡ï¼ˆåŸºäºGB 50265-2022ï¼‰

#### 1.1 è®¾è®¡å‚æ•°ç¡®å®š

**è®¾è®¡æµé‡è®¡ç®—**ï¼ˆGB 50265-2022 Â§4.2.3ï¼‰:
```python
# çŒæº‰è®¾è®¡æµé‡
Q_design = irrigation_area * unit_flow_rate
Q_design = 5000äº© Ã— (1.67/666.7äº©) mÂ³/s = 12.5 mÂ³/s

# è€ƒè™‘æ¸ ç³»åˆ©ç”¨ç³»æ•°
eta_canal = 0.85  # æ¸ é“æ°´åˆ©ç”¨ç³»æ•°
Q_pump_station = Q_design / eta_canal = 14.7 mÂ³/s

# è€ƒè™‘è½®çŒåˆ¶åº¦ï¼ˆ3ä¸ªè½®çŒç»„ï¼‰
Q_actual = Q_pump_station / 3 = 4.9 mÂ³/s

# å–æ•´åï¼šè®¾è®¡æµé‡ Q = 5.0 mÂ³/s
# è£…æœºæ–¹æ¡ˆï¼š3Ã—1.2 = 3.6 mÂ³/sï¼ˆ2å¼€1å¤‡ï¼‰
```

**è®¾è®¡æ‰¬ç¨‹è®¡ç®—**:
```python
# å¤ç”¨ç¬¬2æœ¬ä¹¦çš„æ°´åŠ›è®¡ç®—
from books.open_channel_hydraulics.code.solvers.steady.pipe_flow import (
    compute_friction_loss,  # æ²¿ç¨‹æŸå¤±
    compute_local_loss      # å±€éƒ¨æŸå¤±
)

# æ€»æ‰¬ç¨‹ = å‡€æ‰¬ç¨‹ + ç®¡é“æŸå¤±
H_static = 15.0  # é™æ‰¬ç¨‹ï¼ˆé«˜å·®ï¼‰
h_f = compute_friction_loss(L=500, D=0.8, Q=2.4, roughness=0.0002)
h_m = compute_local_loss(v=3.0, loss_coef=[0.5, 1.0, 0.2])  # è¿›å£ã€å¼¯å¤´ã€é˜€é—¨

H_design = H_static + h_f + h_m + margin
print(f"è®¾è®¡æ‰¬ç¨‹ H = {H_design:.2f} m")
```

#### 1.2 æ°´æ³µé€‰å‹

**å‹å·é€‰æ‹©**ï¼ˆæŸ¥æ°´æ³µå‹è°±ï¼‰:
```
åˆé€‰ï¼šZLBç«‹å¼è½´æµæ³µ
- æµé‡èŒƒå›´ï¼š0.6-1.5 mÂ³/s
- æ‰¬ç¨‹èŒƒå›´ï¼š12-18 m
- æ¯”è½¬é€Ÿï¼šns = 500-700
- æ•ˆç‡ï¼š>75%

æœ€ç»ˆé€‰å‹ï¼šZLB-1200å‹
- é¢å®šæµé‡ï¼š1.2 mÂ³/s
- é¢å®šæ‰¬ç¨‹ï¼š15 m
- é¢å®šæ•ˆç‡ï¼š78%
- é¢å®šåŠŸç‡ï¼š80 kW
- è½¬é€Ÿï¼š1450 rpm
```

**ç‰¹æ€§æ›²çº¿æ•°æ®**:
```python
# æ³µç‰¹æ€§æ›²çº¿ï¼ˆå‚å®¶æä¾›ï¼‰
pump_curve_data = {
    'Q': [0.6, 0.8, 1.0, 1.2, 1.4, 1.6],  # æµé‡ mÂ³/s
    'H': [17.5, 16.8, 16.0, 15.0, 13.8, 12.2],  # æ‰¬ç¨‹ m
    'eta': [0.65, 0.72, 0.76, 0.78, 0.75, 0.68],  # æ•ˆç‡
    'P': [65, 70, 75, 80, 85, 90]  # åŠŸç‡ kW
}
```

#### 1.3 è¿›å‡ºæ°´æ± è®¾è®¡

**è¿›æ°´æ± è®¾è®¡**ï¼ˆGB 50265 Â§6.2.4ï¼‰:
```python
# æœ‰æ•ˆå®¹ç§¯è®¡ç®—
V_inlet = Q_max * T_switch
V_inlet = 3.6 mÂ³/s Ã— 5åˆ†é’Ÿ = 1080 mÂ³

# æ± ä½“å°ºå¯¸
# å¹³é¢ï¼š15m Ã— 15m = 225 mÂ²
# æ·±åº¦ï¼š5.0mï¼ˆæœ‰æ•ˆæ°´æ·±3.0-4.5mï¼‰
# æœ‰æ•ˆå®¹ç§¯ï¼š225 Ã— 1.5 = 337.5 mÂ³ï¼ˆè°ƒæ•´ä¸º500 mÂ³ï¼‰
```

**å‡ºæ°´æ± è®¾è®¡**:
```python
# å‡ºæ°´æ± å®¹ç§¯
V_outlet = Q_pump * T_stabilize
V_outlet = 2.4 mÂ³/s Ã— 3åˆ†é’Ÿ = 432 mÂ³

# æ± ä½“å°ºå¯¸ï¼š12m Ã— 12m Ã— 4m
```

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šæ™ºèƒ½ä½“ç³»ç»Ÿè®¾è®¡

#### 2.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§ä¸­å¿ƒï¼ˆäº‘ç«¯/æœ¬åœ°æœºæˆ¿ï¼‰               â”‚
â”‚  - å®æ—¶ç›‘æ§ç•Œé¢                         â”‚
â”‚  - å†å²æ•°æ®åˆ†æ                         â”‚
â”‚  - è¿œç¨‹å¯åœæ§åˆ¶                         â”‚
â”‚  - æŠ¥è­¦ç®¡ç†                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ 4G/ä»¥å¤ªç½‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ³µç«™PLCæ§åˆ¶æŸœï¼ˆè¾¹ç¼˜è®¡ç®—ï¼‰               â”‚
â”‚  - PIDæ§åˆ¶ç®—æ³•                          â”‚
â”‚  - å¯åœé€»è¾‘                             â”‚
â”‚  - ä¿æŠ¤é€»è¾‘                             â”‚
â”‚  - æ•°æ®é‡‡é›†                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ 4-20mA / RS485
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼ æ„Ÿå™¨ä¸æ‰§è¡Œå™¨                         â”‚
â”‚  - è¿›æ°´æ± æ°´ä½ï¼ˆ2ä¸ªå†—ä½™ï¼‰                â”‚
â”‚  - å‡ºæ°´æ± æ°´ä½                           â”‚
â”‚  - å‡ºå£æµé‡è®¡                           â”‚
â”‚  - å‡ºå£å‹åŠ›è¡¨                           â”‚
â”‚  - 3å°æ³µç”µæœºï¼ˆå˜é¢‘å™¨/è½¯å¯åŠ¨å™¨ï¼‰         â”‚
â”‚  - ç”µæµã€ç”µå‹ã€åŠŸç‡æ£€æµ‹                 â”‚
â”‚  - æŒ¯åŠ¨ã€æ¸©åº¦ç›‘æµ‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 ä¼ æ„Ÿå™¨é…ç½®

| æµ‹ç‚¹ | ç±»å‹ | è§„æ ¼ | æ•°é‡ | ç²¾åº¦ |
|------|------|------|------|------|
| è¿›æ°´æ± æ°´ä½ | è¶…å£°æ³¢/å‹åŠ›å¼ | 0-5m | 2 | Â±5mm |
| å‡ºæ°´æ± æ°´ä½ | è¶…å£°æ³¢ | 0-5m | 1 | Â±5mm |
| å‡ºå£æµé‡ | ç”µç£æµé‡è®¡ | DN800 | 1 | Â±0.5% |
| å‡ºå£å‹åŠ› | å‹åŠ›å˜é€å™¨ | 0-1.0MPa | 1 | Â±0.2% |
| æ³µç”µæµ | ç”µæµäº’æ„Ÿå™¨ | 0-200A | 3 | Â±0.5% |
| æ³µæŒ¯åŠ¨ | æŒ¯åŠ¨ä¼ æ„Ÿå™¨ | - | 3 | - |
| æ³µæ¸©åº¦ | æ¸©åº¦ä¼ æ„Ÿå™¨ | 0-100Â°C | 3 | Â±1Â°C |

**æ€»è®¡**ï¼š14ä¸ªä¼ æ„Ÿå™¨

#### 2.3 æ§åˆ¶å™¨è®¾è®¡

**2.3.1 å•æ³µæ§åˆ¶ï¼ˆL2ï¼‰**

```python
# å•å°æ³µçš„PIDæ°´ä½æ§åˆ¶
from books.water_system_control.code.control.pid import PIDController

single_pump_controller = PIDController(
    Kp=0.8,           # æ¯”ä¾‹ç³»æ•°ï¼ˆè°ƒè¯•è·å¾—ï¼‰
    Ki=0.2,           # ç§¯åˆ†ç³»æ•°
    Kd=0.05,          # å¾®åˆ†ç³»æ•°
    setpoint=3.5,     # è¿›æ°´æ± ç›®æ ‡æ°´ä½3.5m
    output_limits=(0, 1),  # å¼€/åœ
    windup_limit=0.5
)

# æ§åˆ¶é€»è¾‘
def control_single_pump(water_level, dt):
    """å•æ³µæ§åˆ¶"""
    u = single_pump_controller.update(water_level, dt)
    
    if u > 0.5:
        pump_command = 'ON'
    else:
        pump_command = 'OFF'
    
    return pump_command
```

**2.3.2 å¤šæ³µåè°ƒæ§åˆ¶ï¼ˆL3ï¼‰**

```python
class MultiPumpController:
    """
    å¤šæ³µåè°ƒæ§åˆ¶å™¨ï¼ˆL3ï¼‰
    
    åŠŸèƒ½ï¼š
    1. æ ¹æ®æ°´ä½å†³å®šå¼€æ³µå°æ•°ï¼ˆ0-3å°ï¼‰
    2. è½®æ¢è¿è¡Œï¼ˆå‡è¡¡ç£¨æŸï¼‰
    3. é¿å…é¢‘ç¹å¯åœï¼ˆæœ€å°è¿è¡Œ/åœæœºæ—¶é—´ï¼‰
    4. è€ƒè™‘å³°è°·ç”µä»·ï¼ˆå¦‚æœ‰è°ƒè“„èƒ½åŠ›ï¼‰
    """
    
    def __init__(self, n_pumps=3):
        self.n_pumps = n_pumps
        
        # æ°´ä½æ§åˆ¶å™¨ï¼ˆè¾“å‡º0-3ï¼‰
        self.level_pid = PIDController(
            Kp=1.5, Ki=0.3, Kd=0.05,
            setpoint=3.5,
            output_limits=(0, n_pumps)
        )
        
        # æ³µçŠ¶æ€è®°å½•
        self.pump_status = [0] * n_pumps  # 0=åœ, 1=è¿è¡Œ
        self.run_time = [0] * n_pumps     # ç´¯è®¡è¿è¡Œæ—¶é—´ï¼ˆå°æ—¶ï¼‰
        self.last_switch_time = [0] * n_pumps  # ä¸Šæ¬¡å¯åœæ—¶é—´
        
        # ä¿æŠ¤å‚æ•°
        self.min_run_time = 5 * 60    # æœ€å°è¿è¡Œæ—¶é—´5åˆ†é’Ÿ
        self.min_stop_time = 10 * 60  # æœ€å°åœæœºæ—¶é—´10åˆ†é’Ÿ
        
        self.current_time = 0
    
    def update(self, water_level, dt):
        """
        æ§åˆ¶æ›´æ–°
        
        Parameters:
        -----------
        water_level : float
            è¿›æ°´æ± å½“å‰æ°´ä½ [m]
        dt : float
            æ—¶é—´æ­¥é•¿ [s]
        
        Returns:
        --------
        pump_status : list
            å„æ³µè¿è¡ŒçŠ¶æ€ [0/1, 0/1, 0/1]
        """
        self.current_time += dt
        
        # PIDè®¡ç®—éœ€è¦å¼€å‡ å°æ³µ
        control_signal = self.level_pid.update(water_level, dt)
        n_target = round(control_signal)
        n_target = max(0, min(self.n_pumps, n_target))
        
        # å½“å‰è¿è¡Œå°æ•°
        n_current = sum(self.pump_status)
        
        # éœ€è¦å¯åŠ¨
        if n_target > n_current:
            self._start_pumps(n_target - n_current)
        # éœ€è¦åœæ­¢
        elif n_target < n_current:
            self._stop_pumps(n_current - n_target)
        
        # æ›´æ–°è¿è¡Œæ—¶é—´
        for i in range(self.n_pumps):
            if self.pump_status[i] == 1:
                self.run_time[i] += dt / 3600  # è½¬æ¢ä¸ºå°æ—¶
        
        return self.pump_status.copy()
    
    def _start_pumps(self, n):
        """
        å¯åŠ¨nå°æ³µï¼ˆè½®æ¢è¿è¡Œç­–ç•¥ï¼‰
        ä¼˜å…ˆå¯åŠ¨è¿è¡Œæ—¶é—´æœ€çŸ­çš„æ³µ
        """
        # æ‰¾å‡ºåœæœºçš„æ³µ
        stopped_pumps = [i for i in range(self.n_pumps) if self.pump_status[i] == 0]
        
        # æŒ‰è¿è¡Œæ—¶é—´æ’åºï¼ˆè¿è¡Œæ—¶é—´çŸ­çš„ä¼˜å…ˆï¼‰
        stopped_pumps.sort(key=lambda i: self.run_time[i])
        
        # å¯åŠ¨å‰nå°ï¼ˆæ£€æŸ¥æœ€å°åœæœºæ—¶é—´ï¼‰
        started = 0
        for i in stopped_pumps:
            if started >= n:
                break
            
            # æ£€æŸ¥æœ€å°åœæœºæ—¶é—´
            time_since_stop = self.current_time - self.last_switch_time[i]
            if time_since_stop >= self.min_stop_time:
                self.pump_status[i] = 1
                self.last_switch_time[i] = self.current_time
                started += 1
                print(f"  âœ“ å¯åŠ¨æ³µ#{i+1}ï¼ˆç´¯è®¡è¿è¡Œ{self.run_time[i]:.1f}hï¼‰")
    
    def _stop_pumps(self, n):
        """
        åœæ­¢nå°æ³µ
        ä¼˜å…ˆåœæ­¢è¿è¡Œæ—¶é—´æœ€é•¿çš„æ³µ
        """
        # æ‰¾å‡ºè¿è¡Œçš„æ³µ
        running_pumps = [i for i in range(self.n_pumps) if self.pump_status[i] == 1]
        
        # æŒ‰è¿è¡Œæ—¶é—´æ’åºï¼ˆè¿è¡Œæ—¶é—´é•¿çš„ä¼˜å…ˆåœï¼‰
        running_pumps.sort(key=lambda i: self.run_time[i], reverse=True)
        
        # åœæ­¢å‰nå°ï¼ˆæ£€æŸ¥æœ€å°è¿è¡Œæ—¶é—´ï¼‰
        stopped = 0
        for i in running_pumps:
            if stopped >= n:
                break
            
            # æ£€æŸ¥æœ€å°è¿è¡Œæ—¶é—´
            time_since_start = self.current_time - self.last_switch_time[i]
            if time_since_start >= self.min_run_time:
                self.pump_status[i] = 0
                self.last_switch_time[i] = self.current_time
                stopped += 1
                print(f"  âœ“ åœæ­¢æ³µ#{i+1}ï¼ˆç´¯è®¡è¿è¡Œ{self.run_time[i]:.1f}hï¼‰")
```

---

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šåŠ¨æ€è®¾è®¡ç‰¹ç‚¹ï¼ˆæœ¬ä¹¦åˆ›æ–°ï¼‰

#### 3.1 æ°´é”¤é˜²æŠ¤è®¾è®¡

**ä¼ ç»Ÿè®¾è®¡**ï¼š
- ç®€å•è®¡ç®—æ°´é”¤å‹åŠ›
- è®¾ç½®æ­¢å›é˜€ã€å®‰å…¨é˜€

**åŠ¨æ€è®¾è®¡**ï¼š
```python
# å®æ—¶æ°´é”¤åˆ†æä¸æ§åˆ¶
class WaterHammerProtection:
    """æ°´é”¤ä¿æŠ¤ç³»ç»Ÿ"""
    
    def safe_shutdown(self, pump, valve, current_flow):
        """
        å®‰å…¨å…³é—­ç­–ç•¥ï¼ˆé¿å…æ°´é”¤ï¼‰
        """
        # è®¡ç®—å®‰å…¨å…³é—­æ—¶é—´
        c = 1000  # æ°´é”¤æ³¢é€Ÿ m/s
        L = 500   # ç®¡é“é•¿åº¦ m
        T_critical = 2 * L / c  # ä¸´ç•Œæ—¶é—´
        
        # ç¼“æ…¢å…³é—­ï¼ˆ3å€ä¸´ç•Œæ—¶é—´ï¼‰
        T_close = 3 * T_critical  # çº¦3ç§’
        
        # ç”Ÿæˆå…³é—­æ›²çº¿ï¼ˆçº¿æ€§ï¼‰
        n_steps = int(T_close / 0.1)
        closure_curve = np.linspace(current_flow, 0, n_steps)
        
        return closure_curve
```

#### 3.2 èƒ½è€—ä¼˜åŒ–è°ƒåº¦

**è€ƒè™‘å³°è°·ç”µä»·**ï¼ˆå¦‚æœè¿›æ°´æ± æœ‰è°ƒè“„èƒ½åŠ›ï¼‰:
```python
def optimize_pump_schedule(water_level, electricity_price, storage_capacity):
    """
    èƒ½è€—ä¼˜åŒ–è°ƒåº¦
    
    ç­–ç•¥ï¼š
    - å³°ç”µï¼ˆ07:00-11:00, 18:00-23:00ï¼‰ï¼šå°‘å¼€æ³µæˆ–ä¸å¼€
    - å¹³ç”µï¼šæ­£å¸¸å¼€æ³µ
    - è°·ç”µï¼ˆ23:00-07:00ï¼‰ï¼šå¤šå¼€æ³µï¼Œå……æ»¡è¿›æ°´æ± 
    
    çº¦æŸï¼š
    - è¿›æ°´æ± æ°´ä½ 2.5-4.5m
    - æ»¡è¶³çŒæº‰éœ€æ±‚
    """
    hour = get_current_hour()
    
    if electricity_price == 'peak' and water_level > 3.0:
        # å³°ç”µä¸”æ°´ä½å¤Ÿï¼Œå°‘å¼€æˆ–ä¸å¼€
        return 0  # åœæœº
    elif electricity_price == 'valley':
        # è°·ç”µï¼Œå°½é‡å¤šå¼€æ³µè“„æ°´
        if water_level < 4.0:
            return 3  # å¼€3å°
        else:
            return 2
    else:
        # å¹³ç”µï¼Œæ­£å¸¸æ§åˆ¶
        return normal_control(water_level)
```

#### 3.3 é¢„æµ‹æ€§ç»´æŠ¤

```python
# è®¾å¤‡å¥åº·ç›‘æµ‹
class PredictiveMaintenance:
    """é¢„æµ‹æ€§ç»´æŠ¤"""
    
    def monitor_pump_health(self, pump_id):
        """
        æ³µå¥åº·çŠ¶æ€ç›‘æµ‹
        
        ç›‘æµ‹æŒ‡æ ‡ï¼š
        - æŒ¯åŠ¨è¶‹åŠ¿ï¼ˆæ¸å˜æ•…éšœé¢„è­¦ï¼‰
        - æ¸©åº¦å¼‚å¸¸ï¼ˆè½´æ‰¿ç£¨æŸï¼‰
        - ç”µæµæ³¢åŠ¨ï¼ˆå¶è½®ç£¨æŸï¼‰
        - æ•ˆç‡ä¸‹é™ï¼ˆéœ€æ£€ä¿®ï¼‰
        """
        vibration = get_sensor_data(f'pump_{pump_id}_vibration')
        temperature = get_sensor_data(f'pump_{pump_id}_temperature')
        current = get_sensor_data(f'pump_{pump_id}_current')
        
        # å¼‚å¸¸æ£€æµ‹
        if vibration > THRESHOLD_VIBRATION:
            trigger_alarm('æŒ¯åŠ¨è¿‡å¤§ï¼Œå»ºè®®æ£€ä¿®')
        
        if temperature > THRESHOLD_TEMP:
            trigger_alarm('æ¸©åº¦è¿‡é«˜ï¼Œç«‹å³åœæœº')
        
        # æ•ˆç‡è®¡ç®—
        eta_current = compute_efficiency(current, flow, head)
        eta_rated = 0.78
        
        if eta_current < 0.9 * eta_rated:
            trigger_warning('æ•ˆç‡ä¸‹é™>10%ï¼Œå»ºè®®æ£€ä¿®')
```

---

### ç¬¬å››éƒ¨åˆ†ï¼šåœ¨ç¯æµ‹è¯•ï¼ˆæœ¬ä¹¦æ ¸å¿ƒï¼‰

#### 4.1 æµ‹è¯•å·¥å†µè®¾è®¡

**æµ‹è¯•çŸ©é˜µ**ï¼ˆ100ç§å·¥å†µï¼‰:

| å·¥å†µç±»å‹ | æ•°é‡ | æè¿° |
|---------|------|------|
| **æ­£å¸¸å·¥å†µ** | 30 | |
| - æ’å®šæµé‡ | 10 | Q = 1.2, 2.4, 3.6 mÂ³/s |
| - æµé‡æ¸å˜ | 10 | çº¿æ€§å¢å‡ |
| - æµé‡æ³¢åŠ¨ | 10 | æ­£å¼¦æ³¢åŠ¨ |
| **æ‰°åŠ¨å·¥å†µ** | 30 | |
| - ä¸Šæ¸¸æ¥æ°´å˜åŒ– | 10 | ä¸°æ°´æœŸ/æ¯æ°´æœŸ |
| - ä¸‹æ¸¸éœ€æ±‚æ³¢åŠ¨ | 10 | é«˜å³°æœŸ/ä½è°·æœŸ |
| - ç®¡é“é˜»åŠ›å˜åŒ– | 10 | æ·¤ç§¯ã€ç£¨æŸ |
| **æ•…éšœå·¥å†µ** | 20 | |
| - å•æ³µæ•…éšœ | 10 | å„ç§æ—¶åˆ» |
| - ä¼ æ„Ÿå™¨å¤±æ•ˆ | 5 | æ°´ä½è®¡æ•…éšœ |
| - é€šä¿¡ä¸­æ–­ | 5 | é™çº§è¿è¡Œ |
| **æç«¯å·¥å†µ** | 20 | |
| - åœç”µæ¢å¤ | 5 | è‡ªå¯åŠ¨æµ‹è¯• |
| - ç´§æ€¥åœæœº | 5 | å¿«é€Ÿå…³é—­ |
| - è¶…è´Ÿè·è¿è¡Œ | 10 | 3å°å…¨å¼€ |

#### 4.2 æ€§èƒ½è¯„ä¼°æŒ‡æ ‡

**æ°´åŠ›æ€§èƒ½**:
- æ‰¬ç¨‹æ»¡è¶³ç‡ï¼š>95%
- æµé‡ç¨³å®šæ€§ï¼šæ³¢åŠ¨<Â±5%
- æ°´æ± ä¸æº¢å‡º/ä¸å¹²æ¶¸ï¼š100%ä¿è¯

**æ§åˆ¶æ€§èƒ½**:
- æ°´ä½æ§åˆ¶ç²¾åº¦ï¼šÂ±10cm
- å“åº”æ—¶é—´ï¼š<10åˆ†é’Ÿ
- è¶…è°ƒé‡ï¼š<20%

**èƒ½è€—æ€§èƒ½**:
- å¹³å‡æ•ˆç‡ï¼š>75%
- å¹´èƒ½è€—ï¼š<50ä¸‡kWh
- å•ä½æ°´é‡èƒ½è€—ï¼š<0.14 kWh/mÂ³

**å¯é æ€§**:
- æ•…éšœå¤„ç†æˆåŠŸç‡ï¼š>95%
- è®¾å¤‡åˆ©ç”¨ç‡ï¼š>90%
- å‡è¡¡è¿è¡Œï¼šå„æ³µè¿è¡Œæ—¶é—´å·®<10%

#### 4.3 åœ¨ç¯æµ‹è¯•è„šæœ¬

```python
# run_hil_test.py
def run_all_scenarios():
    """è¿è¡Œå…¨éƒ¨100ç§æµ‹è¯•å·¥å†µ"""
    
    # åˆ›å»ºæ³µç«™æ•°å­—å­ªç”Ÿ
    twin = create_pump_station_twin()
    
    # ç”Ÿæˆæµ‹è¯•å·¥å†µ
    scenarios = generate_test_scenarios(n=100)
    
    # æ‰¹é‡è¿è¡Œ
    results = []
    for i, scenario in enumerate(scenarios):
        print(f"[{i+1}/100] è¿è¡Œå·¥å†µï¼š{scenario['name']}")
        result = twin.simulate(scenario)
        results.append(result)
    
    # æ€§èƒ½è¯„ä¼°
    performance = evaluate_performance(results)
    
    # æ™ºèƒ½åŒ–ç­‰çº§è¯„ä¼°
    from books.intelligent_water_network_design.code.tools.intelligence_grader import IntelligenceGrader
    
    grader = IntelligenceGrader()
    grade = grader.evaluate(
        n_sensors=14,
        n_controllers=3,
        steady_state_errors=[0.08, 0.06, 0.09],  # 3ä¸ªæ³µçš„æ§åˆ¶è¯¯å·®
        setpoints=[3.5, 3.5, 3.5],
        rise_times=[8, 7, 9],  # å“åº”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        target_level='L3'
    )
    
    # ç”ŸæˆæŠ¥å‘Š
    generate_report(performance, grade)
```

---

## ğŸ“Š è®¾è®¡æˆæœ

### è®¾è®¡æ–‡ä»¶æ¸…å•

1. **è®¾è®¡è¯´æ˜ä¹¦.pdf**ï¼ˆ40é¡µï¼‰
   - ç¬¬1ç« ï¼šå·¥ç¨‹æ¦‚å†µä¸è®¾è®¡ä¾æ®
   - ç¬¬2ç« ï¼šæ³µç«™æ°´åŠ›è®¾è®¡ï¼ˆç¬¦åˆGB 50265ï¼‰
   - ç¬¬3ç« ï¼šæ™ºèƒ½æ§åˆ¶ç³»ç»Ÿè®¾è®¡
   - ç¬¬4ç« ï¼šåŠ¨æ€è®¾è®¡åˆ›æ–°ç‚¹
   - ç¬¬5ç« ï¼šåœ¨ç¯æµ‹è¯•æŠ¥å‘Š
   - ç¬¬6ç« ï¼šæŠ•èµ„æ¦‚ç®—ä¸ç»æµåˆ†æ
   - é™„å½•Aï¼šæ³µç‰¹æ€§æ›²çº¿
   - é™„å½•Bï¼šæ§åˆ¶é€»è¾‘å›¾
   - é™„å½•Cï¼šè®¾å¤‡æ¸…å•

2. **ä»£ç åŒ…**
   - main.py - ä¸»ä»¿çœŸç¨‹åº
   - models/ - æ³µã€æ°´æ± æ¨¡å‹
   - controllers/ - æ§åˆ¶å™¨
   - simulator/ - æ•°å­—å­ªç”Ÿ
   - tests/ - æµ‹è¯•è„šæœ¬
   - config.json - é…ç½®æ–‡ä»¶

3. **åœ¨ç¯æµ‹è¯•æŠ¥å‘Š.pdf**ï¼ˆ20é¡µï¼‰
   - 100ç§å·¥å†µæµ‹è¯•ç»“æœ
   - æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
   - æ™ºèƒ½åŒ–ç­‰çº§L3è®¤è¯

4. **æŠ•èµ„æ¦‚ç®—è¡¨.xlsx**
   - åœŸå»ºå·¥ç¨‹ï¼š180ä¸‡å…ƒ
   - æœºç”µè®¾å¤‡ï¼š120ä¸‡å…ƒï¼ˆæ³µã€ç”µæœºã€å˜é¢‘å™¨ç­‰ï¼‰
   - æ™ºèƒ½åŒ–ç³»ç»Ÿï¼š50ä¸‡å…ƒï¼ˆ+17%ï¼‰
   - æ€»æŠ•èµ„ï¼š350ä¸‡å…ƒ

---

## ğŸ’¡ å…³é”®è®¾è®¡å‚æ•°è¡¨

| å‚æ•°ç±»åˆ« | å‚æ•°å | æ•°å€¼ | å•ä½ | ä¾æ® |
|---------|--------|------|------|------|
| **æ°´åŠ›å‚æ•°** | | | | GB 50265 |
| è®¾è®¡æµé‡ï¼ˆ2å¼€ï¼‰ | Q | 2.4 | mÂ³/s | Â§4.2.3 |
| è®¾è®¡æ‰¬ç¨‹ | H | 15.0 | m | Â§5.2.1 |
| å‡€æ‰¬ç¨‹ | H_static | 15.0 | m | å®æµ‹ |
| ç®¡é“æŸå¤± | h_f + h_m | 2.5 | m | è®¡ç®— |
| **æ³µå‚æ•°** | | | | å‚å®¶èµ„æ–™ |
| é¢å®šæµé‡ | Q_rated | 1.2 | mÂ³/s | ZLB-1200 |
| é¢å®šæ‰¬ç¨‹ | H_rated | 15.0 | m | |
| é¢å®šæ•ˆç‡ | eta_rated | 78 | % | |
| é¢å®šåŠŸç‡ | P_rated | 80 | kW | |
| **æ°´æ± å‚æ•°** | | | | GB 50265 Â§6.2 |
| è¿›æ°´æ± é¢ç§¯ | A_inlet | 225 | mÂ² | |
| è¿›æ°´æ± æ·±åº¦ | D_inlet | 5.0 | m | |
| æœ‰æ•ˆæ°´æ·± | 3.0-4.5 | m | |
| å‡ºæ°´æ± å®¹ç§¯ | V_outlet | 500 | mÂ³ | |
| **æ§åˆ¶å‚æ•°** | | | | ä»¿çœŸæ•´å®š |
| PIDæ¯”ä¾‹ç³»æ•° | Kp | 1.5 | - | |
| PIDç§¯åˆ†ç³»æ•° | Ki | 0.3 | - | |
| PIDå¾®åˆ†ç³»æ•° | Kd | 0.05 | - | |
| ç›®æ ‡æ°´ä½ | setpoint | 3.5 | m | |
| **ä¿æŠ¤å‚æ•°** | | | | ç»éªŒå€¼ |
| æœ€å°è¿è¡Œæ—¶é—´ | T_min_run | 5 | åˆ†é’Ÿ | ä¿æŠ¤ç”µæœº |
| æœ€å°åœæœºæ—¶é—´ | T_min_stop | 10 | åˆ†é’Ÿ | é¿å…é¢‘ç¹å¯åœ |

---

## ğŸ¯ ä¸æ¡ˆä¾‹1çš„å¯¹æ¯”

| å¯¹æ¯”é¡¹ | æ¡ˆä¾‹1ï¼ˆé—¸ç«™ï¼‰ | æ¡ˆä¾‹2ï¼ˆæ³µç«™ï¼‰ | å¤æ‚åº¦æå‡ |
|-------|-------------|-------------|----------|
| **ç‰©ç†å¯¹è±¡** | é—¸é—¨ï¼ˆè¢«åŠ¨ï¼‰ | æ°´æ³µï¼ˆä¸»åŠ¨ï¼‰ | â¬†ï¸ |
| **æ§åˆ¶ç›®æ ‡** | ä¸‹æ¸¸æ°´ä½ | è¿›æ°´æ± æ°´ä½ | â†’ |
| **æ§åˆ¶éš¾åº¦** | ç®€å•ï¼ˆè¿ç»­è°ƒèŠ‚ï¼‰ | ä¸­ç­‰ï¼ˆç¦»æ•£å¯åœï¼‰ | â¬†ï¸ |
| **èƒ½è€—** | æ— ï¼ˆé‡åŠ›ï¼‰ | é«˜ï¼ˆ250kWï¼‰ | â¬†ï¸â¬†ï¸ |
| **ä¿æŠ¤è¦æ±‚** | å¯é—­é™ä½ | æ°´é”¤ã€æ°”èš€ã€æœ€å°å¯åœæ—¶é—´ | â¬†ï¸â¬†ï¸ |
| **ä¸­å›½æ ‡å‡†** | SL 13 | GB 50265ï¼ˆæ›´å¤æ‚ï¼‰ | â¬†ï¸ |
| **ä»£ç é‡** | 500è¡Œ | 1200è¡Œï¼ˆé¢„è®¡ï¼‰ | â¬†ï¸â¬†ï¸ |

---

## ğŸ’» è¿è¡Œæ–¹å¼

```bash
cd /workspace/books/intelligent-water-network-design/code/examples/case_02_pump_station

# è¿è¡Œä¸»ç¨‹åº
python main.py

# è¿è¡Œåœ¨ç¯æµ‹è¯•
python run_hil_test.py

# ç”Ÿæˆè®¾è®¡æ–‡æ¡£
python generate_design_doc.py
```

---

## ğŸ”— ä¸å…¶ä»–æ¡ˆä¾‹çš„å…³ç³»

**å‰åºæ¡ˆä¾‹**:
- æ¡ˆä¾‹1ï¼šå­¦ä¹ äº†PIDæ§åˆ¶å’Œæ•°å­—å­ªç”ŸåŸºç¡€

**åç»­æ¡ˆä¾‹**:
- æ¡ˆä¾‹8ï¼šå¤šçº§æ³µç«™ä¸²è”ï¼ˆå¤ç”¨æ¡ˆä¾‹2Ã—4ï¼‰
- æ¡ˆä¾‹14ï¼šä¾›æ°´ç®¡ç½‘ï¼ˆå¤ç”¨æ¡ˆä¾‹2ä½œä¸ºåŠ å‹æ³µç«™ï¼‰
- æ¡ˆä¾‹19ï¼šè·¨æµåŸŸè°ƒæ°´ï¼ˆå¤ç”¨æ¡ˆä¾‹2Ã—30ï¼‰

**å¤ç”¨ä»·å€¼**:
- æ¡ˆä¾‹2çš„æ³µæ¨¡å‹å’Œæ§åˆ¶å™¨å°†è¢«å¤§é‡å¤ç”¨
- è¿™æ˜¯Level 1æœ€é‡è¦çš„æ¡ˆä¾‹ä¹‹ä¸€

---

## â­ï¸ ä¸‹ä¸€ä¸ªæ¡ˆä¾‹

**æ¡ˆä¾‹4ï¼šè°ƒå‹é˜€ç«™æ™ºèƒ½æ§åˆ¶è®¾è®¡ï¼ˆL2ï¼‰**
- å­¦ä¹ å‹åŠ›æ§åˆ¶ï¼ˆè€Œéæ°´ä½æ§åˆ¶ï¼‰
- å¼•å…¥ç®¡ç½‘æ°´åŠ›å­¦
- ä¸ºæ¡ˆä¾‹14ï¼ˆä¾›æ°´ç®¡ç½‘ï¼‰åšå‡†å¤‡

---

**æ¡ˆä¾‹2å¼€å‘çŠ¶æ€**: ğŸ”„ å¼€å‘ä¸­  
**é¢„è®¡å®Œæˆæ—¶é—´**: 3å‘¨å  
**æœ€åæ›´æ–°**: 2025-10-31
