# 案例10：灌区渠系优化配水设计

**难度等级**：⭐⭐⭐⭐⭐ 高级（Level 2）  
**学习时间**：26学时（8学时建模 + 12学时控制 + 6学时测试）  
**智能化等级**：L3-L4（协调控制到优化调度）  
**工程类型**：大型灌区渠系优化配水系统

---

## 📖 工程背景

### 项目概况

某大型灌区渠系优化配水系统：
- **灌溉面积**：20000亩
- **干渠**：1条（总长10km）
- **支渠**：5条（分别5km）
- **节制闸**：6座（1干渠闸+5支渠闸）
- **作物类型**：水稻、小麦、玉米
- **灌溉制度**：轮灌（5区轮流）

### Level 2特点：从单闸→渠系

| 对比项 | Level 1（案例1） | Level 2（案例10） | 升级 |
|-------|-----------------|------------------|------|
| **闸站数** | 1个 | 6个（1+5） | ×6 |
| **控制目标** | 单点水位 | 多点水位+流量分配 | ⬆️⬆️⬆️ |
| **优化目标** | 水位稳定 | 配水公平+节水 | ⬆️⬆️ |
| **决策** | 实时反馈 | 轮灌计划+实时调整 | ⬆️⬆️ |
| **智能化** | L3 | L3-L4 | ⬆️ |

### 现状问题

传统配水（人工调度）：
- ❌ **配水不公**：上游多，下游少
- ❌ **水资源浪费**：无优化调度，浪费20%
- ❌ **灌溉效率低**：无轮灌计划，田间利用率60%
- ❌ **响应慢**：人工决策，延迟2小时

### 改造目标

- ✅ 配水公平（各支渠水量偏差<10%）
- ✅ 节水15%（优化调度）
- ✅ 自动轮灌（5天一轮）
- ✅ 智能化等级L3-L4

---

## 📐 设计依据（中国标准）

### 主要标准

1. **GB 50288-2018** 《灌溉与排水工程设计标准》⭐⭐⭐
   - §8 灌溉系统
   - §9 渠系配水

2. **GB/T 50363-2018** 《节水灌溉工程技术规范》⭐⭐
   - 节水措施

---

## 🔧 复用案例1+7

### 高度复用（85%）

```python
# ✅ 复用案例1（单闸）
from case_01_irrigation_gate import TrapezoidalChannel, SimplePIDController

# ✅ 复用案例7（串级）
from case_07_cascade_canals import CascadeController

# 扩展：1条干渠+5条支渠（树形拓扑）
```

**复用率**：85%（案例1 70% + 案例7 15%）

### 本案例创新

```python
# 1. 轮灌调度器（新增）⭐⭐⭐
class RotationScheduler:
    """
    轮灌调度器
    
    功能：
    - 5个支渠轮流灌溉
    - 每个支渠灌溉1天
    - 5天一轮
    """
    pass

# 2. 配水公平优化（新增）⭐⭐⭐
class WaterAllocationOptimizer:
    """
    配水公平优化器
    
    功能：
    - 各支渠水量均衡
    - 最小化方差
    """
    pass

# 3. 需水预测（新增）⭐⭐
class WaterDemandForecast:
    """
    需水预测
    
    功能：
    - 根据作物类型预测需水量
    - 根据天气预报调整
    """
    pass
```

---

## 📋 设计任务

### 第一部分：灌区渠系系统建模

#### 1.1 系统拓扑

```
渠首（Q=5 m³/s）
    │
    ▼
┌───────────────┐
│  干渠（10km）  │
└───────────────┘
    │
    ├──→ 支渠1（4000亩，Q=1.0 m³/s）
    ├──→ 支渠2（4000亩，Q=1.0 m³/s）
    ├──→ 支渠3（4000亩，Q=1.0 m³/s）
    ├──→ 支渠4（4000亩，Q=1.0 m³/s）
    └──→ 支渠5（4000亩，Q=1.0 m³/s）

轮灌制度（5天一轮）：
Day 1: 支渠1灌溉，其他关闭
Day 2: 支渠2灌溉，其他关闭
Day 3: 支渠3灌溉，其他关闭
Day 4: 支渠4灌溉，其他关闭
Day 5: 支渠5灌溉，其他关闭
```

#### 1.2 灌区参数

| 参数 | 支渠1 | 支渠2 | 支渠3 | 支渠4 | 支渠5 | 单位 |
|------|------|------|------|------|------|------|
| 灌溉面积 | 4000 | 4000 | 4000 | 4000 | 4000 | 亩 |
| 设计流量 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | m³/s |
| 作物类型 | 水稻 | 水稻 | 小麦 | 玉米 | 玉米 | - |
| 灌溉定额 | 600 | 600 | 400 | 350 | 350 | m³/亩 |

#### 1.3 轮灌调度模型

```python
class RotationScheduler:
    """
    轮灌调度器
    
    5天一轮，每天灌溉一个支渠
    """
    
    def __init__(self):
        self.rotation_period = 5  # 5天一轮
        self.current_day = 0
    
    def get_active_canal(self, t: float) -> int:
        """
        获取当前应该灌溉的支渠
        
        Parameters:
        -----------
        t : float
            当前时间 [s]
        
        Returns:
        --------
        canal_id : int
            支渠编号（0-4）
        """
        day = int(t / 86400) % self.rotation_period
        return day  # 0-4对应支渠1-5
    
    def get_canal_status(self, t: float) -> list:
        """
        获取各支渠状态
        
        Returns:
        --------
        status : list
            [1, 0, 0, 0, 0] 表示支渠1开启，其他关闭
        """
        active = self.get_active_canal(t)
        status = [0] * 5
        status[active] = 1
        return status
```

---

### 第二部分：渠系优化配水控制设计（L3-L4核心）

#### 2.1 配水公平优化

```python
class IrrigationSystemCoordinator:
    """
    灌区渠系协调控制器（L3-L4）
    
    功能：
    1. 轮灌调度（5天一轮）
    2. 配水公平优化
    3. 干渠-支渠协调控制
    4. 需水预测与调整
    
    创新：轮灌+配水公平+节水优化
    """
    
    def __init__(self):
        # 轮灌调度器
        self.scheduler = RotationScheduler()
        
        # 干渠闸门PID
        self.main_canal_pid = SimplePIDController(
            Kp=0.8, Ki=0.15, Kd=0.08,
            setpoint=3.0,  # 干渠目标水位
            output_limits=(0.2, 2.0)
        )
        
        # 各支渠闸门PID（5个）
        self.branch_pids = [
            SimplePIDController(Kp=0.8, Ki=0.15, Kd=0.08,
                               setpoint=2.5, output_limits=(0.2, 2.0))
            for _ in range(5)
        ]
        
        # 配水统计
        self.water_allocated = [0.0] * 5  # 各支渠累计配水量
        
        # 节水统计
        self.water_saved = 0.0
    
    def update(self, h_main: float, h_branches: list, t: float, dt: float):
        """
        渠系协调控制
        
        Parameters:
        -----------
        h_main : float
            干渠水位 [m]
        h_branches : list
            5个支渠水位 [m]
        t : float
            当前时间 [s]
        dt : float
            时间步长 [s]
        
        Returns:
        --------
        opening_main : float
            干渠闸门开度 [m]
        openings_branch : list
            5个支渠闸门开度 [m]
        """
        # 1. 轮灌调度（决定哪个支渠开启）
        canal_status = self.scheduler.get_canal_status(t)
        active_canal = canal_status.index(1)
        
        # 2. 干渠控制（保证干渠水位）
        opening_main = self.main_canal_pid.update(h_main, dt)
        
        # 3. 支渠控制
        openings_branch = []
        for i in range(5):
            if canal_status[i] == 1:  # 当前支渠开启
                # 正常PID控制
                opening = self.branch_pids[i].update(h_branches[i], dt)
                
                # 配水统计
                Q_i = self._compute_flow(opening)
                self.water_allocated[i] += Q_i * dt
            else:  # 当前支渠关闭
                opening = 0.1  # 最小开度（防止淤积）
            
            openings_branch.append(opening)
        
        # 4. 配水公平检查
        # 如果某支渠配水过少，下次轮灌时延长时间
        # （简化：在实际中会调整轮灌计划）
        
        return opening_main, openings_branch
```

---

### 第三部分：动态设计特点（本书创新）

#### 3.1 Level 1 vs Level 2

| 对比项 | Level 1（案例1） | Level 2（案例10） |
|-------|-----------------|------------------|
| **系统规模** | 1闸1渠 | 6闸6渠（树形） |
| **控制策略** | 单PID | 轮灌+协调 |
| **调度** | 无 | 5天轮灌 |
| **优化目标** | 水位稳定 | 配水公平+节水 |
| **智能化** | L3 | L3-L4 |
| **代码复用** | - | 85%复用案例1+7 |

#### 3.2 轮灌价值

**传统灌溉 vs 轮灌**：

| 对比项 | 传统灌溉 | 轮灌（本案例） |
|-------|---------|---------------|
| **方式** | 同时灌溉 | 轮流灌溉 |
| **流量** | 5×1=5 m³/s | 1×1=1 m³/s |
| **渠道尺寸** | 大（5 m³/s） | 小（1 m³/s） |
| **工程投资** | 100% | 60%（减少40%） |
| **水资源利用** | 60% | 85%（提升25%） |
| **灌溉均匀度** | 70% | 90%（提升20%） |

**经济价值**：
- 节省工程投资40%
- 节水15%→每年节水300万m³
- 提高产量10%→增收500万元

---

### 第四部分：在环测试（本书核心）

#### 4.1 测试场景设计

**测试场景**（6种）：

| 场景 | 描述 | 测试目标 |
|------|------|---------|
| 场景1 | 完整轮灌周期（5天） | 基本功能 |
| 场景2 | 上游来水波动 | 抗干扰 |
| 场景3 | 某支渠闸门故障 | 容错能力 |
| 场景4 | 降雨影响（减少需水） | 自适应 |

---

## 💡 关键设计参数

| 参数 | 干渠 | 支渠1-5 | 单位 |
|------|------|---------|------|
| **渠道参数** | | | |
| 长度 | 10000 | 5000 | m |
| 底宽 | 5.0 | 2.0 | m |
| 边坡 | 1.5 | 1.5 | - |
| 糙率 | 0.022 | 0.022 | - |
| **控制参数** | | | |
| 目标水位 | 3.0 | 2.5 | m |
| PID_Kp | 0.8 | 0.8 | - |
| PID_Ki | 0.15 | 0.15 | - |
| PID_Kd | 0.08 | 0.08 | - |

---

## 🎯 与案例1/7的对比

| 对比项 | 案例1 | 案例7 | 案例10 |
|-------|------|------|--------|
| **拓扑** | 单闸 | 串联 | 树形 |
| **闸门数** | 1 | 3 | 6 |
| **控制** | PID | 前馈+解耦 | 轮灌+协调 |
| **调度** | 无 | 无 | 5天轮灌 ⭐ |
| **优化** | 单目标 | 串级 | 配水公平+节水 |
| **复用** | - | 90%案例1 | 85%案例1+7 |

**案例10特点**：
- ✅ 树形拓扑（1干+5支）
- ✅ 轮灌调度（5天一轮）⭐
- ✅ 配水公平优化
- ✅ 节水15%

---

## 💻 运行方式

```bash
cd code/examples/case_10_irrigation_system

# 运行完整轮灌周期（5天）
python main.py
```

---

**案例10开发状态**: 🔄 开发中  
**预计完成时间**: 2小时  
**最后更新**: 2025-10-31
