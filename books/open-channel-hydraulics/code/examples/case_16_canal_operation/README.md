# 案例16：渠道非恒定流调度

## 案例背景

某灌溉渠道系统需要根据下游用水需求调整闸门开度，实现精确供水。上游水库保持恒定水位，渠道首部设有控制闸门。

工程参数：
- 渠道长度 L = 5000 m
- 渠道宽度 b = 10.0 m
- 渠道坡度 S₀ = 0.0002
- 糙率系数 n = 0.025（混凝土衬砌）
- 初始流量 Q₀ = 20 m³/s
- 调度时长 = 4小时

调度场景：
1. **增加供水**：闸门开度从50%增至80%
2. **减少供水**：闸门开度从80%降至30%
3. **脉冲供水**：间歇性开闭闸门
4. **多目标调度**：满足下游水位和流量要求

计算要求：
1. 模拟闸门调度过程
2. 分析渠道水位响应
3. 计算到达时间和调整时间
4. 优化调度策略

## 学习目标

1. 理解渠道非恒定流特性
2. 掌握闸门调度方法
3. 学会水位控制策略
4. 了解调度延迟效应
5. 掌握供水优化技术

## 核心理论

### 1. 渠道非恒定流方程

**Saint-Venant方程：**
```
∂A/∂t + ∂Q/∂x = 0              (连续方程)
∂Q/∂t + ∂(Q²/A)/∂x + gA·∂h/∂x = gA(S₀ - Sf)  (动量方程)

其中：
  Sf = n²Q²/(A²R^(4/3))  - 摩阻坡度
```

**适用条件：**
- 渐变流
- 水深远小于波长
- 缓坡渠道
- 一维流动

### 2. 闸门流量方程

**自由出流（淹没度σ<0.67）：**
```
Q = Cd · b · a · √(2gh₁)

其中：
  Cd = 流量系数（约0.6）
  a = 闸门开度（m）
  h₁ = 上游水深（m）
```

**淹没出流（σ≥0.67）：**
```
Q = Cd · b · a · √(2g(h₁ - h₂))

其中：
  h₂ = 下游水深（m）
  σ = h₂/h₁ - 淹没度
```

**开度调节：**
```
a(t) = a₀ + (af - a₀) · f(t)

常用调节函数：
- 线性调节：f(t) = t/T
- 指数调节：f(t) = 1 - exp(-t/τ)
- S曲线调节：f(t) = 0.5(1 + tanh((t-T/2)/τ))
```

### 3. 边界条件

**上游边界（闸门）：**
```
给定流量过程：
  Q(0,t) = Q_gate(a(t), h₁(t))

或给定水位：
  h(0,t) = h_upstream(t)
```

**下游边界：**
```
选项1 - 自由出流：
  外推边界或临界流条件
  Fr = v/√(gh) = 1

选项2 - 水位控制：
  h(L,t) = h_target(t)

选项3 - 堰控制：
  Q = C_weir · b · h^(3/2)
```

### 4. 波传播特性

**小扰动波速：**
```
c = √(gh)  - 重力波速

正向特征线：dx/dt = v + c
负向特征线：dx/dt = v - c
```

**调度延迟时间：**
```
上游调整传播到下游的时间：
  t_lag ≈ L / (v + c)

典型值：
  v = 1 m/s, c = 3 m/s
  → t_lag = L / 4 m/s
```

**水位调整时间：**
```
渠道达到新平衡状态的时间：
  t_adjust ≈ 2~3 × t_lag

取决于：
- 渠道长度
- 流速和波速
- 调度幅度
```

### 5. 控制策略

**开环控制：**
```
根据预定程序调节闸门
优点：简单可靠
缺点：无法应对扰动
```

**反馈控制：**
```
根据实时水位调节闸门
控制律（PID）：
  Δa = Kp·e + Ki·∫e dt + Kd·de/dt

其中：
  e = h_target - h_measured
  Kp, Ki, Kd = 比例、积分、微分系数
```

**前馈控制：**
```
根据已知扰动提前调节
适用于可预测的用水变化
```

**预测控制（MPC）：**
```
基于模型预测未来状态
优化未来控制序列
考虑约束条件
```

### 6. 优化目标

**单目标优化：**

目标1 - 最小水位偏差：
```
min J₁ = ∫∫ (h - h_target)² dx dt
```

目标2 - 最小流量偏差：
```
min J₂ = ∫ (Q - Q_target)² dt
```

目标3 - 最小调节幅度：
```
min J₃ = ∫ (da/dt)² dt
```

**多目标优化：**
```
min J = w₁·J₁ + w₂·J₂ + w₃·J₃

约束条件：
  a_min ≤ a(t) ≤ a_max
  |da/dt| ≤ da_max
  h_min ≤ h(x,t) ≤ h_max
```

### 7. 调度模式

**恒定流量模式：**
```
目标：下游流量Q = Q_target
方法：上游闸门保持Q(0,t) = Q_target
适用：稳定供水需求
```

**恒定水位模式：**
```
目标：下游水位h = h_target
方法：反馈控制闸门开度
适用：渠道水位控制
```

**轮灌模式：**
```
目标：按时段分配供水
方法：周期性调节流量
适用：轮灌调度
```

**应急调度：**
```
目标：快速响应突发需求
方法：最大开度/最小开度
适用：事故处理
```

### 8. 性能评价指标

**响应速度：**
```
上升时间：从10%到90%目标值的时间
延迟时间：开始响应的时间
调整时间：稳定在±5%范围的时间
```

**稳定性：**
```
超调量：最大偏差与目标值之比
振荡次数：达到稳态前的振荡次数
稳态误差：最终值与目标值的偏差
```

**效率：**
```
水量利用率：有效供水量/总供水量
能量消耗：闸门调节能耗
调节频率：单位时间调节次数
```

### 9. 实际工程考虑

**闸门限制：**
- 最小开度 a_min（防止堵塞）
- 最大开度 a_max（结构限制）
- 最大调节速度 da/dt_max（机械限制）
- 最小调节间隔（避免频繁调节）

**水位限制：**
- 最低水位（保证供水）
- 最高水位（防止漫堤）
- 安全余量

**流量限制：**
- 最小流量（维持流态）
- 最大流量（渠道容量）
- 流速限制（防止冲刷）

**测量与通信：**
- 水位计精度
- 流量计精度
- 数据传输延迟
- 控制指令延迟

### 10. 数值模拟方法

**网格设置：**
```
空间步长：Δx = 50-100 m
时间步长：自动CFL条件
模拟时长：根据调度周期
```

**初始条件：**
```
稳态初始条件：
  求解恒定流方程获得初始分布

或给定分布：
  h(x,0) = h₀(x)
  Q(x,0) = Q₀(x)
```

**边界条件实现：**
```python
def bc_upstream(t):
    """上游闸门边界"""
    a = gate_opening(t)  # 闸门开度时程
    Q = gate_discharge(a, h1)  # 闸门流量
    h = compute_upstream_depth(Q)  # 上游水深
    return h, Q

def bc_downstream(t):
    """下游边界"""
    # 选项1：外推
    return None
    # 选项2：给定水位
    return h_target, None
    # 选项3：临界流
    return compute_critical_depth(Q), Q
```

## 计算任务

### 任务1：增加供水调度

模拟闸门开度从50%增至80%的过程。

### 任务2：减少供水调度

模拟闸门开度从80%降至30%的过程。

### 任务3：水位响应分析

分析不同调度速度下的水位响应。

### 任务4：多点控制

多个闸门协同调度。

### 任务5：优化调度策略

寻找最优调度曲线。

## 使用方法

```python
# 运行主程序
python main.py

# 运行实验
python experiments.py
```

## 预期结果

**增加供水（50%→80%）：**
- 上游流量立即增加
- 波传播时间约20-30分钟
- 下游流量逐渐增加
- 水位抬升1-2m

**减少供水（80%→30%）：**
- 上游流量立即减少
- 下游水位先降后升（补偿效应）
- 调整时间较长
- 可能出现局部壅水

**脉冲供水：**
- 周期性波动
- 幅值沿程衰减
- 存在相位延迟

## 工程意义

本案例展示了：
1. 渠道非恒定流调度原理
2. 闸门控制策略
3. 波传播延迟效应
4. 水位响应特性
5. 实时调度技术

## 设计要点

1. **调度策略**：
   - 渐进调节vs突变调节
   - 前馈vs反馈控制
   - 单点vs多点控制

2. **边界条件**：
   - 上游闸门流量
   - 下游出口条件
   - 侧向取水

3. **性能指标**：
   - 响应时间
   - 水位偏差
   - 超调量
   - 能耗

4. **约束条件**：
   - 闸门开度范围
   - 水位安全范围
   - 流量容量
   - 调节速度

## 注意事项

1. **物理限制**：
   - 闸门调节速度有限
   - 水位不能瞬变
   - 流量连续性

2. **数值稳定性**：
   - 边界条件处理
   - 快速变化的捕捉
   - CFL条件

3. **工程实际**：
   - 测量误差
   - 通信延迟
   - 执行偏差
   - 扰动因素

4. **优化目标**：
   - 多目标权衡
   - 约束满足
   - 鲁棒性
   - 可实施性

## 进阶主题

1. **高级控制**：
   - 模型预测控制（MPC）
   - 自适应控制
   - 智能控制
   - 分布式控制

2. **多渠道系统**：
   - 渠系联合调度
   - 水量平衡
   - 优先级分配
   - 冲突解决

3. **实时调度**：
   - 在线优化
   - 滚动时域
   - 不确定性处理
   - 应急响应

4. **决策支持**：
   - 场景分析
   - 风险评估
   - 可视化
   - 专家系统
