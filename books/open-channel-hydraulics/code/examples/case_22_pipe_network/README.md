# 案例22：管网平衡计算

## 案例背景

某住宅小区供水管网由多条管道组成环状网络。已知各节点用水流量和管道参数，需要计算管网中各管道的流量分配和节点水头，确保供水压力满足要求。

管网参数：
- 水源点：A点，水头H_A = 50 m
- 用水节点：B、C、D、E
- 管道：AB、AC、BC、BD、CD、DE
- 用水量：Q_B = 20 L/s, Q_C = 15 L/s, Q_D = 10 L/s, Q_E = 5 L/s

分析目标：
1. 计算各管道的流量分配
2. 计算各节点的水头
3. 验证节点流量平衡
4. 验证环路能量平衡
5. 确保最不利点压力满足要求（≥28 m）

## 学习目标

1. 理解管网平衡的基本原理
2. 掌握Hardy-Cross法（环路校正法）
3. 学习Newton-Raphson法求解管网
4. 了解节点法和环路法的区别
5. 掌握管网计算的工程应用

## 核心理论

### 1. 管网平衡基本方程

**节点流量平衡（连续性方程）：**
```python
Σ Q_in = Σ Q_out + Q_demand
```

对于任意节点，流入流量 = 流出流量 + 节点用水量

**环路能量平衡（能量守恒）：**
```python
Σ h_f = 0  （沿闭合环路）
```

沿任意闭合环路，水头损失的代数和为零。

### 2. 管道水头损失公式

**简化公式（指数形式）：**
```python
h_f = K * Q^n
```

其中：
- K：管道阻力系数（与管长、管径、粗糙度有关）
- Q：管道流量 (m³/s)
- n：指数（通常取1.85或2.0）

**阻力系数K的计算：**
```python
K = (8*λ*L) / (π²*g*D⁵)
```

对于紊流（n=2）：
```python
h_f = K * Q²
```

**符号约定：**
- 顺时针流动：Q为正，h_f为正
- 逆时针流动：Q为负，h_f为负

### 3. Hardy-Cross法（环路校正法）

**基本思想：**
假设初始流量分配，迭代校正直到满足环路平衡。

**校正公式：**
```python
ΔQ = -Σh_f / (n * Σ|h_f|/Q)
```

**迭代步骤：**
1. 假设初始流量分配（满足节点平衡）
2. 计算各环路的水头损失和
3. 计算流量校正量ΔQ
4. 更新流量：Q_new = Q_old + ΔQ
5. 重复2-4直到收敛

**收敛判据：**
```python
|ΔQ| < ε  或  |Σh_f| < ε
```

### 4. Newton-Raphson法（节点法）

**基本方程组：**

对于每个节点j：
```python
f_j = Σ Q_ij - Q_j = 0
```

其中Q_ij是管道流量，可表示为：
```python
Q_ij = sign(H_i - H_j) * √(|H_i - H_j| / K_ij)
```

**雅可比矩阵：**
```python
∂f_j/∂H_k = ∂Q_ij/∂H_k
```

**迭代公式：**
```python
H^(k+1) = H^(k) - J^(-1) * f(H^(k))
```

### 5. 管网分类

**树状管网：**
- 无环路，计算简单
- 从末端向源头逐段计算
- 可靠性低（任一管道断裂即断水）

**环状管网：**
- 有环路，计算复杂
- 需要迭代求解
- 可靠性高（有备用供水路径）

**枝状环状混合管网：**
- 最常见形式
- 主干为环状，支线为树状

## 计算任务

### 任务1：简单双环管网计算

计算如下管网（两个环）：
```python
    A (H=50m)
    |
    B --- C
    |  ×  |
    D --- E
```

节点用水：Q_B=20 L/s, Q_C=15 L/s, Q_D=10 L/s, Q_E=5 L/s

### 任务2：Hardy-Cross法迭代

使用Hardy-Cross法求解：
1. 假设初始流量
2. 计算环路不平衡量
3. 迭代校正
4. 验证收敛

### 任务3：节点水头计算

计算各节点水头H_B, H_C, H_D, H_E，确保最小压力满足要求。

### 任务4：管道流向判断

判断各管道的实际流向，绘制流量分布图。

## 使用方法

```python
# 运行主程序
python main.py

# 运行实验
python experiments.py
```python

## 预期结果

- 掌握管网平衡基本原理
- 学会使用Hardy-Cross法
- 理解迭代收敛过程
- 能够进行实际管网计算

## 工程意义

本案例展示了：
1. 城市供水管网的计算方法
2. Hardy-Cross法的实际应用
3. 管网优化设计的基础
4. 压力控制和水力分析
5. 为复杂管网计算打基础

## Hardy-Cross法详细步骤

### 步骤1：绘制管网拓扑

标注节点编号、管道编号、环路编号。

### 步骤2：假设初始流量

满足节点平衡条件：
- 对每个节点：Σ Q_in = Σ Q_out + Q_demand
- 可以任意假设，只要满足连续性

### 步骤3：计算环路不平衡

对每个环路：
```
Σh_f = Σ(K * Q^n)
```python

### 步骤4：计算流量校正量

```
ΔQ_loop = -Σh_f / (n * Σ(K * |Q|^(n-1)))
```python

### 步骤5：更新流量

对环路内每条管道：
```
Q_new = Q_old + ΔQ_loop
```python

注意：公共管道需要叠加相邻环路的校正量。

### 步骤6：检查收敛

若所有环路的ΔQ都小于容差，则收敛。

## 常见问题

### 1. 初始流量如何假设？

**方法1：简单假设法**
- 水从源点均匀分配到各分支
- 粗略满足节点平衡即可

**方法2：比例分配法**
- 根据管道阻力比例分配流量
- R_i较小的管道分配较多流量

**方法3：经验法**
- 根据工程经验直接假设
- 通常假设环路中流量顺时针分布

### 2. 收敛速度如何提高？

- 选择较好的初值
- 使用松弛因子
- 采用Newton-Raphson法（收敛更快）

### 3. 公共管道如何处理？

公共管道属于多个环路，需要累加所有相关环路的校正量：
```
Q_new = Q_old + Σ ΔQ_adjacent_loops
```

## 工程应用要点

1. **压力要求**: 住宅用水最低压力28 m（0.28 MPa）
2. **流速限制**: 0.5~3.0 m/s，推荐1.0~2.0 m/s
3. **管径选择**: 考虑经济管径和水力条件
4. **可靠性**: 环状管网提供备用供水路径
5. **消防要求**: 消防时流量和压力需要验算

## 扩展阅读

- 《给水排水管网系统》
- 《城市给水工程》第四版
- Hardy Cross, "Analysis of Flow in Networks of Conduits or Conductors" (1936)
- 《建筑给水排水设计规范》GB 50015
- 《室外给水设计规范》GB 50013
