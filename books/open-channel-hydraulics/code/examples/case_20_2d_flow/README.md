# 案例20：二维明渠水流模拟

## 案例背景

某河道在洪水期发生漫滩，水流从主槽溢出到两侧滩地。由于滩地地形复杂、糙率不同，水流呈现明显的二维特征，一维模型无法准确描述。需要建立二维浅水波方程模型，模拟水位和流速的空间分布。

工程参数：
- 计算域：长度 L = 500 m，宽度 W = 200 m
- 主槽：宽度 50 m，位于中央，底高程 z = 0 m
- 滩地：两侧各 75 m，底高程 z = 2 m
- 初始条件：主槽水深 3 m，滩地干地
- 边界条件：上游流量 Q = 500 m³/s，下游自由出流
- 糙率：主槽 n = 0.03，滩地 n = 0.05
- 网格：Δx = 10 m，Δy = 10 m（结构化网格）

计算要求：
1. 建立二维浅水波方程模型
2. 实现二维有限体积法求解器
3. 处理干湿边界问题
4. 模拟洪水漫滩过程
5. 可视化二维流场（水深、流速矢量）

## 学习目标

1. 理解二维水流的复杂性
2. 掌握二维浅水波方程
3. 学会二维有限体积法
4. 了解干湿处理技术
5. 掌握二维流场可视化方法

## 核心理论

### 1. 二维浅水波方程

**1.1 基本假设**

```python
1. 浅水假设：水深 << 波长
2. 垂线平均：流速沿水深均匀分布
3. 静水压强：压强服从静水分布
4. 小底坡：tanθ ≈ sinθ ≈ θ
```

**1.2 守恒形式方程组**

```python
守恒变量：
U = [h, hu, hv]ᵀ

其中：
  h = 水深 (m)
  u = x方向流速 (m/s)
  v = y方向流速 (m/s)
  hu, hv = 单宽流量 (m²/s)
```

**1.3 连续性方程**

```python
∂h/∂t + ∂(hu)/∂x + ∂(hv)/∂y = 0

物理意义：
  ∂h/∂t = 水深随时间的变化率
  ∂(hu)/∂x = x方向流量的变化
  ∂(hv)/∂y = y方向流量的变化

总和为零表示质量守恒
```

**1.4 x方向动量方程**

```python
∂(hu)/∂t + ∂(hu²+gh²/2)/∂x + ∂(huv)/∂y = -gh·∂z_b/∂x - ghn²u√(u²+v²)/h^(4/3)

各项物理意义：
  ∂(hu)/∂t         = 动量随时间变化
  ∂(hu²)/∂x        = 对流项（动量输运）
  ∂(gh²/2)/∂x      = 压力项
  ∂(huv)/∂y        = y方向对流
  -gh·∂z_b/∂x      = 底坡源项
  -ghn²u√(u²+v²)/h^(4/3) = 摩阻源项（曼宁公式）
```

**1.5 y方向动量方程**

```python
∂(hv)/∂t + ∂(huv)/∂x + ∂(hv²+gh²/2)/∂y = -gh·∂z_b/∂y - ghn²v√(u²+v²)/h^(4/3)

结构与x方向类似
```

**1.6 矩阵形式**

```python
∂U/∂t + ∂F/∂x + ∂G/∂y = S

其中：

状态向量：
U = [h, hu, hv]ᵀ

x方向通量：
F = [hu, hu²+gh²/2, huv]ᵀ

y方向通量：
G = [hv, huv, hv²+gh²/2]ᵀ

源项：
S = [0, -gh·∂z_b/∂x - S_fx, -gh·∂z_b/∂y - S_fy]ᵀ

摩阻项：
S_fx = ghn²u√(u²+v²)/h^(4/3)
S_fy = ghn²v√(u²+v²)/h^(4/3)
```

### 2. 二维有限体积法

**2.1 控制体积离散**

```python
将计算域划分为矩形网格单元：

     j+1  ┌─────┬─────┬─────┐
          │     │     │     │
      j   ├─────┼─────┼─────┤
          │     │(i,j)│     │
     j-1  ├─────┼─────┼─────┤
          │     │     │     │
      j-2 └─────┴─────┴─────┘
          i-1    i    i+1   i+2

单元(i,j)：
  中心坐标：(x_i, y_j)
  面积：ΔxΔy
  四个界面：东(E)、西(W)、北(N)、南(S)
```

**2.2 积分形式**

```python
对单元(i,j)进行面积分：

∫∫_Ω (∂U/∂t) dA + ∫∫_Ω (∂F/∂x) dA + ∫∫_Ω (∂G/∂y) dA = ∫∫_Ω S dA

应用格林公式：

ΔxΔy · dU_{i,j}/dt + ∮_∂Ω (F·n_x + G·n_y) dl = ΔxΔy · S_{i,j}

其中∮_∂Ω是沿单元边界的线积分
```

**2.3 离散方程**

```python
dU_{i,j}/dt = -(F_{i+1/2,j}^n - F_{i-1/2,j}^n)/Δx
              -(G_{i,j+1/2}^n - G_{i,j-1/2}^n)/Δy + S_{i,j}

其中：
  F_{i+1/2,j}^n = 东界面数值通量
  F_{i-1/2,j}^n = 西界面数值通量
  G_{i,j+1/2}^n = 北界面数值通量
  G_{i,j-1/2}^n = 南界面数值通量
```

**2.4 数值通量计算**

界面通量使用数值通量函数：

```python
F_{i+1/2,j} = F_numerical(U_L, U_R)

其中：
  U_L = 左侧状态（单元i,j）
  U_R = 右侧状态（单元i+1,j）
```

**常用数值通量格式：**

**Lax-Friedrichs通量（简单但耗散大）：**
```python
F_LF = (F(U_L) + F(U_R))/2 - α/2 · (U_R - U_L)

其中：
  α = max(|u_L + c_L|, |u_R + c_R|)
  c = √(gh) = 浅水波波速
```

**HLL通量（Harten-Lax-van Leer）：**
```python
         ⎧ F(U_L)                     if S_L ≥ 0
F_HLL = ⎨ (S_R·F(U_L) - S_L·F(U_R) + S_L·S_R·(U_R - U_L))/(S_R - S_L)  if S_L < 0 < S_R
         ⎩ F(U_R)                     if S_R ≤ 0

波速估计：
S_L = min(u_L - c_L, u_R - c_R)
S_R = max(u_L + c_L, u_R + c_R)
```

**2.5 时间积分**

**显式欧拉（一阶）：**
```python
U_{i,j}^{n+1} = U_{i,j}^n + Δt · RHS(U^n)
```

**Runge-Kutta 2阶（RK2）：**
```python
U^* = U^n + Δt · RHS(U^n)
U^{n+1} = U^n + Δt/2 · (RHS(U^n) + RHS(U^*))
```

**2.6 CFL条件**

```python
Δt ≤ CFL · min(Δx, Δy) / max(|u| + c, |v| + c)

其中：
  CFL = Courant数，通常取0.3-0.5
  c = √(gh) = 浅水波速
```

### 3. 干湿处理

**3.1 干湿判定**

```python
定义临界水深 h_dry（通常0.001-0.01 m）：

湿单元：h ≥ h_dry
干单元：h < h_dry
```

**3.2 界面通量修正**

```python
如果界面两侧有干单元，特殊处理：

Case 1: 两侧都是干单元
  F = 0（无流量）

Case 2: 左湿右干
  if u_L > 0:  # 流向干地
    F = F(U_L)  # 使用左侧通量
  else:
    F = 0

Case 3: 左干右湿
  if u_R < 0:  # 流向干地
    F = F(U_R)
  else:
    F = 0
```

**3.3 水深非负保证**

```python
After time update:
  if h_{i,j}^{n+1} < 0:
    h_{i,j}^{n+1} = 0
    u_{i,j}^{n+1} = 0
    v_{i,j}^{n+1} = 0
```

### 4. 源项处理

**4.1 底坡源项**

```python
S_b,x = -gh · ∂z_b/∂x
S_b,y = -gh · ∂z_b/∂y

离散：
(∂z_b/∂x)_{i,j} ≈ (z_{b,i+1,j} - z_{b,i-1,j})/(2Δx)
(∂z_b/∂y)_{i,j} ≈ (z_{b,i,j+1} - z_{b,i,j-1})/(2Δy)
```

**平衡性（Well-balanced）：**

静水状态下，压力项与底坡项应平衡：
```python
∂(gh²/2)/∂x + gh·∂z_b/∂x = 0

即：
∂η/∂x = 0，其中η = h + z_b (水位)

数值格式需要保持这种平衡，否则会产生虚假流动
```

**4.2 摩阻源项**

```python
S_f,x = -gn²u√(u²+v²)/h^(4/3)
S_f,y = -gn²v√(u²+v²)/h^(4/3)

半隐式处理（避免刚性）：
hu^{n+1} = (hu^* + Δt·S_{b,x})/(1 + Δt·C_f)
hv^{n+1} = (hv^* + Δt·S_{b,y})/(1 + Δt·C_f)

其中：
C_f = gn²√(u²+v²)/h^(4/3)
```

### 5. 边界条件

**5.1 入流边界（上游）**

```python
固定流量：
  Q_total = ∑ (hu)_{i,j} · Δy

方法1 - 均匀分配：
  (hu)_{i,j} = Q_total / W

方法2 - 根据水深分配：
  (hu)_{i,j} = Q_total · h_{i,j} / ∑h_{i,j}
```

**5.2 出流边界（下游）**

```python
自由出流（外推）：
  U_{boundary} = U_{interior}

或零梯度：
  ∂U/∂x = 0
  → U_{i,j} = U_{i-1,j}
```

**5.3 固壁边界（侧边）**

```python
无渗透条件：
  法向流速 = 0

对于南北边界（y方向）：
  v = 0

对于东西边界（x方向）：
  u = 0
```

### 6. 二维流场特性

**6.1 流线与迹线**

```python
流线：某一时刻的流速矢量切线
  dx/ds = u
  dy/ds = v

迹线：质点运动轨迹
  dx/dt = u(x,y,t)
  dy/dt = v(x,y,t)

恒定流时，流线=迹线
```

**6.2 涡度**

```python
ω = ∂v/∂x - ∂u/∂y

涡度表示流体微团的旋转
正值：逆时针旋转
负值：顺时针旋转
```

**6.3 环流**

```python
Γ = ∮_C (u·dx + v·dy)

沿闭合曲线的速度环量
```

### 7. 一维与二维对比

| 特性 | 一维模型 | 二维模型 |
|------|---------|---------|
| 方程数 | 2个（h, Q） | 3个（h, hu, hv） |
| 空间维度 | 1个（x） | 2个（x, y） |
| 适用场景 | 河道、渠道 | 河口、湖泊、漫滩 |
| 计算量 | 小 | 大（N_x × N_y） |
| 网格 | 一维数组 | 二维数组 |
| 通量方向 | 1个 | 2个（东西、南北） |
| 流动模式 | 单向 | 多向、回流、涡旋 |
| 边界条件 | 2个（上下游） | 4个（上下左右） |

### 8. 河道漫滩过程

**8.1 主槽-滩地相互作用**

```python
漫滩阶段：
1. 水位上涨，主槽水深增加
2. 水位超过滩地高程
3. 水流从主槽溢向滩地
4. 滩地逐渐被淹没
5. 主槽与滩地形成复合断面

退水阶段：
1. 洪峰过后，水位下降
2. 滩地水流向主槽
3. 部分低洼处积水
4. 最终回到主槽
```

**8.2 动量交换**

```python
主槽与滩地流速差异：
- 主槽：流速快，水深大
- 滩地：流速慢，水深小，糙率大

界面处：
- 流速梯度大
- 涡旋产生
- 能量损失
```

**8.3 复合断面流量**

```python
Q_total = Q_main + Q_floodplain

Q_main = ∫∫_{main} hu dA
Q_floodplain = ∫∫_{flood} hu dA

分流比：
α = Q_floodplain / Q_total

漫滩严重时，α可达0.3-0.5
```

### 9. 数值实施要点

**9.1 算法流程**

```python
1. 初始化：
   - 网格生成
   - 地形赋值
   - 初始条件

2. 时间循环：
   For n = 0 to N_steps:

     a. 计算时间步长（CFL条件）

     b. 边界条件处理

     c. 计算数值通量：
        For i, j:
          F_{i+1/2,j} = flux(U_{i,j}, U_{i+1,j})
          F_{i-1/2,j} = flux(U_{i-1,j}, U_{i,j})
          G_{i,j+1/2} = flux(U_{i,j}, U_{i,j+1})
          G_{i,j-1/2} = flux(U_{i,j-1}, U_{i,j})

     d. 计算源项

     e. 时间积分
        U^{n+1} = U^n + Δt·RHS

     f. 干湿处理

     g. 输出/可视化

3. 后处理
```

**9.2 数据结构**

```python
# 二维数组
h = np.zeros((Nx, Ny))      # 水深
u = np.zeros((Nx, Ny))      # x方向流速
v = np.zeros((Nx, Ny))      # y方向流速
z_b = np.zeros((Nx, Ny))    # 地形高程
n_manning = np.zeros((Nx, Ny))  # 糙率

# 通量数组
F_x = np.zeros((Nx+1, Ny, 3))  # x方向通量
F_y = np.zeros((Nx, Ny+1, 3))  # y方向通量
```python

### 10. 可视化方法

**10.1 等值线图（Contour）**

```python
plt.contourf(X, Y, h, levels=20, cmap='Blues')
plt.colorbar(label='水深 (m)')
```python

**10.2 矢量场（Quiver）**

```python
plt.quiver(X[::skip, ::skip], Y[::skip, ::skip],
          u[::skip, ::skip], v[::skip, ::skip])
```python

**10.3 流线图（Streamplot）**

```python
plt.streamplot(X, Y, u, v, density=1.5, color=速度大小)
```python

**10.4 三维曲面（Surface）**

```python
from mpl_toolkits.mplot3d import Axes3D
ax.plot_surface(X, Y, h+z_b, cmap='viridis')
```python

**10.5 动画（Animation）**

```python
from matplotlib.animation import FuncAnimation

def update(frame):
    plt.contourf(X, Y, h_history[frame])

ani = FuncAnimation(fig, update, frames=N_frames)
```python

## 计算任务

### 任务1：河道漫滩模拟

模拟洪水从主槽漫入滩地的过程。

### 任务2：流场分析

分析二维流速分布、流线图、涡度分布。

### 任务3：一维二维对比

对比一维和二维模型的差异。

## 使用方法

```python
# 运行主程序
python main.py

# 运行实验
python experiments.py
```

## 预期结果

**漫滩过程：**
- t = 0 s：主槽水深3m，滩地干地
- t = 100 s：水位上涨，开始漫滩
- t = 300 s：滩地部分淹没
- t = 600 s：滩地大范围淹没

**流速分布：**
- 主槽中心：u ≈ 1.5-2.0 m/s
- 主槽边缘：u ≈ 1.0 m/s
- 滩地：u ≈ 0.3-0.5 m/s（糙率大）

**淹没范围：**
- 最大淹没宽度：≈ 150 m
- 淹没面积：≈ 60000 m²

## 工程意义

本案例展示了：
1. 二维水流模拟的完整流程
2. 有限体积法的实际应用
3. 复杂地形的处理方法
4. 洪水风险评估技术
5. 为河道整治、防洪规划提供依据

## 设计要点

1. **网格选择**：
   - 结构网格：编程简单，适合规则地形
   - 非结构网格：适应复杂边界，编程复杂
   - 网格密度：平衡精度与效率

2. **数值通量**：
   - Lax-Friedrichs：简单但耗散
   - HLL：准确性好，应用广泛
   - HLLC：更精确但更复杂

3. **干湿处理**：
   - 关键技术，影响稳定性
   - 临界水深选择重要
   - 需要特殊界面通量

4. **源项平衡**：
   - Well-balanced格式
   - 防止静水虚假流动
   - 半隐式处理摩阻

## 注意事项

1. **计算量**：
   - 二维计算量远大于一维
   - N_x × N_y个单元
   - 需要优化和并行化

2. **稳定性**：
   - CFL条件更严格
   - 干湿边界容易不稳定
   - 源项刚性问题

3. **内存**：
   - 大网格需要大内存
   - 时间历史存储
   - 可视化数据量大

4. **边界条件**：
   - 四个边界需要协调
   - 入流分配要合理
   - 出流边界影响上游

## 进阶主题

1. **非结构网格**：
   - 三角形/四边形混合
   - 边界拟合
   - 局部加密

2. **高阶精度**：
   - MUSCL重构
   - WENO格式
   - DG方法

3. **湍流模型**：
   - 雷诺应力
   - 涡粘模型
   - LES/DNS

4. **多相流**：
   - 泥沙输运
   - 污染物扩散
   - 水质模拟

5. **GPU加速**：
   - CUDA编程
   - 并行化
   - 大规模计算
