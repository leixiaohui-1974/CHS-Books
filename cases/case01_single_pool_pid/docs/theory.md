# 理论推导：单池明渠PID控制

## 1. 系统建模

### 1.1 水量平衡方程

对于矩形单池明渠，水量守恒方程为：

```
dV/dt = Q_in - Q_out
```

其中：
- V：池内水体积 (m³)
- Q_in：流入流量 (m³/s)
- Q_out：流出流量 (m³/s)

由于水面面积 A = L × W 恒定（假设侧壁垂直），有：

```
V = A × h
dV/dt = A × dh/dt
```

因此：

```
A × dh/dt = Q_in - Q_out  ... (1)
```

### 1.2 闸门流量方程

下游闸门的流出流量遵循堰流公式（自由出流条件）：

```
Q_out = C_d × W × a × sqrt(2gh)  ... (2)
```

其中：
- C_d：流量系数 (通常为0.6-0.7)
- W：闸门宽度 (m)
- a：闸门开度 (m)
- g：重力加速度 (9.81 m/s²)
- h：上游水深 (m)

### 1.3 非线性状态空间模型

将 (2) 代入 (1)，得到非线性微分方程：

```
dh/dt = (Q_in - C_d × W × a × sqrt(2gh)) / A  ... (3)
```

这是一个**非线性系统**，其中：
- 状态变量：h
- 控制输入：a
- 扰动输入：Q_in

## 2. 线性化

### 2.1 工作点

选择工作点 (h₀, Q₀, a₀)，满足平衡条件：

```
Q_in0 = Q_out0 = C_d × W × a₀ × sqrt(2g h₀)
```

### 2.2 泰勒展开

在工作点附近对 (3) 进行一阶泰勒展开。定义偏差变量：

```
Δh = h - h₀
ΔQ_in = Q_in - Q_in0
Δa = a - a₀
```

对Q_out进行偏导数计算：

```
∂Q_out/∂h |_(h₀,a₀) = C_d × W × a₀ × sqrt(2g) × (1/2) × h₀^(-1/2)
                      = Q_out0 / (2h₀)
                      = K_h

∂Q_out/∂a |_(h₀,a₀) = C_d × W × sqrt(2g h₀)
                      = K_a
```

线性化后的方程：

```
A × d(Δh)/dt = ΔQ_in - K_h × Δh - K_a × Δa
```

整理得：

```
d(Δh)/dt = -(K_h/A) × Δh + (1/A) × ΔQ_in - (K_a/A) × Δa  ... (4)
```

### 2.3 传递函数

取拉普拉斯变换（忽略扰动ΔQ_in）：

```
s × H(s) = -(K_h/A) × H(s) - (K_a/A) × A(s)
```

整理得闸门到水深的传递函数：

```
G(s) = H(s)/A(s) = -K_a / (A×s + K_h)  ... (5)
```

这是一个**一阶惯性系统**。

**特殊情况**：如果K_h很小（水深变化对流量影响小），可近似为：

```
G(s) ≈ -K_a / (A×s)  ... (6)
```

这是一个**积分系统**。

### 2.4 系统特性

- **类型**：I型系统（含一个积分环节）
- **稳态增益**：K = -K_a / K_h
- **时间常数**：τ = A / K_h

对于典型参数：
- A = 10000 m²
- K_a ≈ 62 m²/s
- K_h ≈ 5 m²/s
- τ ≈ 2000 s（大时间常数系统）

## 3. PID控制器设计

### 3.1 控制律

标准PID控制律：

```
u(t) = K_p × e(t) + K_i × ∫e(τ)dτ + K_d × de(t)/dt  ... (7)
```

其中误差 e(t) = h_ref(t) - h(t)。

传递函数形式：

```
C(s) = K_p + K_i/s + K_d×s  ... (8)
```

### 3.2 闭环系统

闭环传递函数：

```
T(s) = G(s)×C(s) / (1 + G(s)×C(s))

     = (-K_a/A) × (K_p×s + K_i + K_d×s²) / (s² + (K_h/A + K_a×K_d/A)×s + K_a×K_p/A×s + K_a×K_i/A)
```

简化为标准二阶系统形式：

```
T(s) = ω_n² / (s² + 2ζω_n×s + ω_n²)
```

其中：
- 自然频率：ω_n = sqrt(K_a×K_i/A)
- 阻尼比：ζ = ...（复杂表达式）

### 3.3 参数整定原则

#### (1) 比例增益 K_p
- 增大K_p可以加快响应速度
- 但会增加超调和振荡
- 建议范围：0.3 ~ 1.0

#### (2) 积分增益 K_i
- 消除稳态误差（对I型系统尤为重要）
- 增大K_i加快误差消除，但可能导致振荡
- 建议范围：0.005 ~ 0.02

#### (3) 微分增益 K_d
- 抑制超调，提高稳定性
- 对噪声敏感，需配合滤波
- 建议范围：2 ~ 10

#### (4) 经验公式

**Ziegler-Nichols临界比例度法**：
1. 设K_i = 0, K_d = 0
2. 增大K_p直到系统临界振荡，记录K_u和T_u
3. 计算：
   - K_p = 0.6 × K_u
   - K_i = 2×K_p / T_u
   - K_d = K_p×T_u / 8

### 3.4 性能指标

#### 时域指标
- **超调量** σ% = (h_max - h_ref) / (h_ref - h_init) × 100%
  - 目标：< 10%

- **上升时间** t_r：从10%到90%的时间
  - 目标：< 500 s

- **调节时间** t_s：进入±2%误差带的时间
  - 目标：< 1000 s

- **稳态误差** e_ss = lim(t→∞) |h_ref - h(t)|
  - 目标：< 0.01 m

#### 积分性能指标
- **IAE**: ∫|e(t)|dt（适合综合评价）
- **ISE**: ∫e²(t)dt（惩罚大误差）
- **ITAE**: ∫t|e(t)|dt（更快响应）

## 4. 实际考虑

### 4.1 执行机构限制
- 闸门开度限制：0 ≤ a ≤ a_max
- 闸门速度限制：|da/dt| ≤ v_max
- 解决方法：输出限幅 + 抗积分饱和

### 4.2 测量噪声
- 水位传感器有波动
- 解决方法：
  - 对测量值滤波
  - 微分项采用一阶滤波

### 4.3 时间延迟
- 传感器延迟
- 通信延迟
- 执行延迟
- 解决方法：Smith预估器

### 4.4 参数不确定性
- 流量系数C_d变化
- 水面面积不完全恒定
- 解决方法：自适应控制、鲁棒控制

## 5. 稳定性分析

### 5.1 Routh判据

闭环特征方程：

```
D(s) = s² + a₁s + a₀ = 0
```

Routh表：
```
s²:  1    a₀
s¹:  a₁   0
s⁰:  a₀   0
```

稳定条件：a₁ > 0 且 a₀ > 0

即：
```
K_h/A + K_a×K_d/A > 0  (通常满足)
K_a×K_i/A > 0          (通常满足)
```

### 5.2 相位裕度

建议相位裕度 PM > 45° 以保证良好的鲁棒性。

## 6. 仿真验证

通过数值仿真验证：
1. 理论模型与实际系统的吻合度
2. PID参数的合理性
3. 各种扰动下的性能

见simulation.py的实现。

---

## 参考文献

1. Litrico, X., & Fromion, V. (2009). *Modeling and Control of Hydrosystems*. Springer.
2. Åström, K. J., & Murray, R. M. (2008). *Feedback Systems: An Introduction for Scientists and Engineers*. Princeton University Press.
3. Schuurmans, J., et al. (1999). Modeling of Irrigation and Drainage Canals for Controller Design. *Journal of Irrigation and Drainage Engineering*.
